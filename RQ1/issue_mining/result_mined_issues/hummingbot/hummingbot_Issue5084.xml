<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5084</ISSUENO>
  <ISSUEURL>https://github.com/hummingbot/hummingbot/issues/5084</ISSUEURL>
  <TITLE>Perpetual Market Making - Unexpected error while processing event 202 during funding payment period</TITLE>
  <DESCRIPTION>**Describe the bug** Getting an `Unexpected error while processing event 202` during funding payment period when running a perpetual market making strategy with a position currently open. This also results to funding payment not getting recorded on the sqlite file. ```python 2022-02-03 00:00:30,313 - 949 - hummingbot.connector.derivative.binance_perpetual.binance_perpetual_derivative - ERROR - Unexpected error while processing event 202. Traceback (most recent call last): File &quot;hummingbot/core/pubsub.pyx&quot;, line 165, in hummingbot.core.pubsub.PubSub.c_trigger_event typed_listener.c_call(arg) File &quot;hummingbot/core/event/event_listener.pyx&quot;, line 25, in hummingbot.core.event.event_listener.EventListener.c_call self(arg) File &quot;/home/ubuntu/hummingbot/hummingbot/core/event/event_forwarder.py&quot;, line 24, in __call__ self._to_function(self.current_event_tag, self.current_event_caller, arg) File &quot;/home/ubuntu/hummingbot/hummingbot/connector/markets_recorder.py&quot;, line 286, in _did_complete_funding_payment session: Session = self.session AttributeError: 'MarketsRecorder' object has no attribute 'session' ``` **Steps To Reproduce** 1. Create and run a perpetual market making strategy 2. Set a tight spread, wait for an order to get filled to open a position 3. Once a position is open wait for the funding payment period **Screenshots** &lt;img width=&quot;1422&quot; alt=&quot;Screen Shot 2022-02-02 at 4 00 45 PM&quot; src=&quot;https://user-images.githubusercontent.com/64377055/152269348-2dcb096f-fb29-47f1-ad15-c29665e71209.png&quot;&gt; **Release version** 1.0.0 **Attachments** Logs/config: [perp_mm_funding.zip](https://github.com/hummingbot/hummingbot/files/7991270/perp_mm_funding.zip)</DESCRIPTION>
  <REPONAME>hummingbot</REPONAME>
  <TIMEDIFFERENCEDAYS>113</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #5159 from CoinAlpha/fix/cli-handler-format-string fix / cli handler format string</MESSAGE>
    <SHA>b30a23ba7c6be512afbe7353254964e6eda34bb3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>(fix) MarketsRecorder error for perpetual funding payments The session is meant to be instantiated by line 287. The deleted line 284 should not have been here at all, and was likely a bit of obsolete code. The fix resolves #5084 This issue seems to apply to all perpetual exchanges and all strategies using them, and will cause a strategy to stall in a state of error.</MESSAGE>
      <SHA>73cc74437b86957da2137417494570e0b973d247</SHA>
      <PATCHEDFILES>
        <FILE>hummingbot/connector/markets_recorder.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Update markets_recorder.py fix #5084 pr #5182</MESSAGE>
      <SHA>147ebd377b225d933b8df010a8b98772a6f95b4e</SHA>
      <PATCHEDFILES>
        <FILE>hummingbot/connector/markets_recorder.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
