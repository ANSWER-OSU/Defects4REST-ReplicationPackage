<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>31570</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/31570</ISSUEURL>
  <TITLE>errors uploading iPhone HEIC images</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Attempt to upload an HEIC photo taken on an iPhone 2. See &quot;500 Error processing thumbnail for uploaded media&quot; in the web UI ### Expected behaviour The image should upload and post ### Actual behaviour The image fails to upload ### Detailed description I initially thought this might be from using libvips but upon further testing, it occurs whether or not I have `MASTODON_USE_LIBVIPS=true` in .env.production, so it seems to be something else. I have attached two sample images that reproduce the issue (as a zip; GitHub doesn't support HEIF): [HEIF-images.zip](https://github.com/user-attachments/files/16734152/HEIF-images.zip) I also see this in my /var/log/syslog when the issue occurs ``` 2024-08-23T12:32:35.879625-07:00 koi bundle[47993]: E, [2024-08-23T12:32:35.878990 #47993] ERROR -- : [2295fbc3-5619-4ccf-a574-e19fc5116ece] Paperclip::Error: Error while optimizing 799cd6bfc52d5baa8ba87191e42bdc0820240823-47993-10b16y: /tmp/799cd6bfc52d5baa8ba87191e42bdc0820240823-47993-10b16y.heif: bad seek to 3413051 2024-08-23T12:32:35.880347-07:00 koi bundle[47993]: heif: Invalid input: Unspecified: Metadata not correctly assigned to image (2.0) ``` ### Mastodon instance puddle.town ### Mastodon version v4.3.0-beta.1 ### Technical details ``` $ ruby --version ruby 3.3.4 (2024-07-09 revision be1089c8ec) [x86_64-linux] ``` ``` $ node --version v20.17.0 ``` ``` $ cat /etc/lsb-release DISTRIB_ID=Ubuntu DISTRIB_RELEASE=24.04 DISTRIB_CODENAME=noble DISTRIB_DESCRIPTION=&quot;Ubuntu 24.04 LTS&quot; ``` ``` $ vips -v vips-8.15.1 ``` ``` $ vips --vips-config enable debug: false enable deprecated: true enable modules: true enable cplusplus: true enable RAD load/save: true enable Analyze7 load/save: true enable PPM load/save: true enable GIF load: true use fftw for FFTs: true SIMD support with highway: true accelerate loops with ORC: false ICC profile support with lcms: true zlib: true text rendering with pangocairo: true font file support with fontconfig: true EXIF metadata support with libexif: true JPEG load/save with libjpeg: true JXL load/save with libjxl: true (dynamic module: true) JPEG2000 load/save with OpenJPEG: true PNG load/save with libspng: true PNG load/save with libpng: false selected quantisation package: imagequant TIFF load/save with libtiff: true image pyramid save with libarchive: true HEIC/AVIF load/save with libheif: true (dynamic module: true) WebP load/save with libwebp: true PDF load with PDFium: false PDF load with poppler-glib: true (dynamic module: true) SVG load with librsvg: true EXR load with OpenEXR: true OpenSlide load: true (dynamic module: true) Matlab load with libmatio: true NIfTI load/save with niftiio: false FITS load/save with cfitsio: true GIF save with cgif: true selected Magick package: MagickCore (dynamic module: true) Magick API version: magick6 Magick load: true Magick save: true ```</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>194</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Convert `settings/sessions` spec controller-&gt;system (#34072)</MESSAGE>
    <SHA>b021cfc91e1d8addf335a13aa64a057381df7ebb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix processing errors for some HEIF images from iOS 18 when using `vips` Old versions of `libheif` have a bug with those images (related to HDR metadata). The easiest solution for us is to use `libheif` from Debian backports, which is a recent version (1.19, vs 1.15 in mainline). See https://github.com/libvips/libvips/issues/4169 Fixes #31570</MESSAGE>
      <SHA>436ecb6a39cce19b063907519bc9df09ae3a2274</SHA>
      <PATCHEDFILES>
        <FILE>Dockerfile</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
