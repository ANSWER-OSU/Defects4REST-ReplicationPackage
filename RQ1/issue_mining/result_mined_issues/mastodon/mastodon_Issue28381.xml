<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>28381</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/28381</ISSUEURL>
  <TITLE>/api/v1/directory returning 500 on Mastodon 4.1.11</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem On a Mastodon 4.1.11 instance: 1. Go to `your-domain.tld/directory` on a browser. A `GET` request is made to `/api/v1/directory?order=active&amp;local=false&amp;limit=20` 2. Check the mastodon-web logs and the database logs ### Expected behaviour The `/directory` page shows some profiles ### Actual behaviour The `/directory` page loads, but doesn't show any profile ### Detailed description The API call to `/api/v1/directory?order=active&amp;local=false&amp;limit=20` gives a `500` error mastodon-web logs: ``` [3f261ece-7921-40e8-83a1-15a7577819f0] ActiveRecord::StatementInvalid (PG::AmbiguousColumn: ERROR: column reference &quot;last_status_at&quot; is ambiguous LINE 1: ... NULL AND &quot;accounts&quot;.&quot;discoverable&quot; = $2 ORDER BY last_statu... ^ ): [3f261ece-7921-40e8-83a1-15a7577819f0] [3f261ece-7921-40e8-83a1-15a7577819f0] app/controllers/api/v1/directories_controller.rb:8:in `show' [3f261ece-7921-40e8-83a1-15a7577819f0] app/controllers/concerns/localized.rb:11:in `set_locale' [3f261ece-7921-40e8-83a1-15a7577819f0] lib/mastodon/rack_middleware.rb:9:in `call' [3f261ece-7921-40e8-83a1-15a7577819f0] lib/public_file_server_middleware.rb:18:in `call' ``` Postgres logs: ``` 2023-12-15T12:11:50.926973550+01:00 2023-12-15 11:11:50.926 UTC [789030] ERROR: column reference &quot;last_status_at&quot; is ambiguous at character 2689 2023-12-15T12:11:50.927009728+01:00 2023-12-15 11:11:50.926 UTC [789030] STATEMENT: SELECT &quot;accounts&quot;.&quot;username&quot; AS t0_r0, &quot;accounts&quot;.&quot;domain&quot; AS t0_r1, &quot;accounts&quot;.&quot;private_key&quot; AS t0_r2, &quot;accounts&quot;.&quot;public_key&quot; AS t0_r3, &quot;accounts&quot;.&quot;created_at&quot; AS t0_r4, &quot;accounts&quot;.&quot;updated_at&quot; AS t0_r5, &quot;accounts&quot;.&quot;note&quot; AS t0_r6, &quot;accounts&quot;.&quot;display_name&quot; AS t0_r7, &quot;accounts&quot;.&quot;uri&quot; AS t0_r8, &quot;accounts&quot;.&quot;url&quot; AS t0_r9, &quot;accounts&quot;.&quot;avatar_file_name&quot; AS t0_r10, &quot;accounts&quot;.&quot;avatar_content_type&quot; AS t0_r11, &quot;accounts&quot;.&quot;avatar_file_size&quot; AS t0_r12, &quot;accounts&quot;.&quot;avatar_updated_at&quot; AS t0_r13, &quot;accounts&quot;.&quot;header_file_name&quot; AS t0_r14, &quot;accounts&quot;.&quot;header_content_type&quot; AS t0_r15, &quot;accounts&quot;.&quot;header_file_size&quot; AS t0_r16, &quot;accounts&quot;.&quot;header_updated_at&quot; AS t0_r17, &quot;accounts&quot;.&quot;avatar_remote_url&quot; AS t0_r18, &quot;accounts&quot;.&quot;locked&quot; AS t0_r19, &quot;accounts&quot;.&quot;header_remote_url&quot; AS t0_r20, &quot;accounts&quot;.&quot;last_webfingered_at&quot; AS t0_r21, &quot;accounts&quot;.&quot;inbox_url&quot; AS t0_r22, &quot;accounts&quot;.&quot;outbox_url&quot; AS t0_r23, &quot;accounts&quot;.&quot;shared_inbox_url&quot; AS t0_r24, &quot;accounts&quot;.&quot;followers_url&quot; AS t0_r25, &quot;accounts&quot;.&quot;protocol&quot; AS t0_r26, &quot;accounts&quot;.&quot;id&quot; AS t0_r27, &quot;accounts&quot;.&quot;memorial&quot; AS t0_r28, &quot;accounts&quot;.&quot;moved_to_account_id&quot; AS t0_r29, &quot;accounts&quot;.&quot;featured_collection_url&quot; AS t0_r30, &quot;accounts&quot;.&quot;fields&quot; AS t0_r31, &quot;accounts&quot;.&quot;actor_type&quot; AS t0_r32, &quot;accounts&quot;.&quot;discoverable&quot; AS t0_r33, &quot;accounts&quot;.&quot;also_known_as&quot; AS t0_r34, &quot;accounts&quot;.&quot;silenced_at&quot; AS t0_r35, &quot;accounts&quot;.&quot;suspended_at&quot; AS t0_r36, &quot;accounts&quot;.&quot;hide_collections&quot; AS t0_r37, &quot;accounts&quot;.&quot;avatar_storage_schema_version&quot; AS t0_r38, &quot;accounts&quot;.&quot;header_storage_schema_version&quot; AS t0_r39, &quot;accounts&quot;.&quot;devices_url&quot; AS t0_r40, &quot;accounts&quot;.&quot;sensitized_at&quot; AS t0_r41, &quot;accounts&quot;.&quot;suspension_origin&quot; AS t0_r42, &quot;accounts&quot;.&quot;trendable&quot; AS t0_r43, &quot;accounts&quot;.&quot;reviewed_at&quot; AS t0_r44, &quot;accounts&quot;.&quot;requested_review_at&quot; AS t0_r45, &quot;account_stats_accounts&quot;.&quot;id&quot; AS t1_r0, &quot;account_stats_accounts&quot;.&quot;account_id&quot; AS t1_r1, &quot;account_stats_accounts&quot;.&quot;statuses_count&quot; AS t1_r2, &quot;account_stats_accounts&quot;.&quot;following_count&quot; AS t1_r3, &quot;account_stats_accounts&quot;.&quot;followers_count&quot; AS t1_r4, &quot;account_stats_accounts&quot;.&quot;created_at&quot; AS t1_r5, &quot;account_stats_accounts&quot;.&quot;updated_at&quot; AS t1_r6, &quot;account_stats_accounts&quot;.&quot;last_status_at&quot; AS t1_r7 FROM &quot;accounts&quot; LEFT OUTER JOIN &quot;users&quot; ON &quot;users&quot;.&quot;account_id&quot; = &quot;accounts&quot;.&quot;id&quot; LEFT OUTER JOIN &quot;account_stats&quot; ON &quot;account_stats&quot;.&quot;account_id&quot; = &quot;accounts&quot;.&quot;id&quot; LEFT OUTER JOIN &quot;account_stats&quot; &quot;account_stats_accounts&quot; ON &quot;account_stats_accounts&quot;.&quot;account_id&quot; = &quot;accounts&quot;.&quot;id&quot; WHERE (&quot;accounts&quot;.&quot;domain&quot; IS NOT NULL OR &quot;users&quot;.&quot;approved&quot; = $1 AND &quot;users&quot;.&quot;confirmed_at&quot; IS NOT NULL) AND &quot;accounts&quot;.&quot;suspended_at&quot; IS NULL AND &quot;accounts&quot;.&quot;moved_to_account_id&quot; IS NULL AND &quot;accounts&quot;.&quot;silenced_at&quot; IS NULL AND &quot;accounts&quot;.&quot;discoverable&quot; = $2 ORDER BY last_status_at DESC NULLS LAST LIMIT $3 ``` In the generated query, the `LEFT OUTER JOIN &quot;account_stats&quot; ON &quot;account_stats&quot;.&quot;account_id&quot; = &quot;accounts&quot;.&quot;id&quot; LEFT OUTER JOIN &quot;account_stats&quot; &quot;account_stats_accounts&quot; ON &quot;account_stats_accounts&quot;.&quot;account_id&quot; = &quot;accounts&quot;.&quot;id&quot;` seems weird. ### Mastodon instance https://mastodon.libre-entreprise.com ### Mastodon version v4.1.11 ### Technical details Mastodon running with Docker, using official image</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Bump version to v4.1.11</MESSAGE>
    <SHA>363bedd0504a29d444a585cd914e7f741915eb8f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix SQL query in `/api/v1/directory` Fixes #28381</MESSAGE>
      <SHA>e964cdcec3fb17351b4b5c93e96662da2b2d249b</SHA>
      <PATCHEDFILES>
        <FILE>app/models/account.rb</FILE>
        <FILE>spec/requests/api/v1/directories_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
