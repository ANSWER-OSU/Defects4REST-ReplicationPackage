<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>27230</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/27230</ISSUEURL>
  <TITLE>LinkCrawlWorker does not handle non-UTF8 charsets</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Post or receive a status with https://www.worldconcerthall.com/en/schedule/herrmann_korngold_with_lamsma_wagner_and_kodaly_from_rotterdam/77834/ in it ### Expected behaviour The `LinkCrawlWorker` will fetch the URL properly ### Actual behaviour The `LinkCrawlWorker` crashes with &quot;ArgumentError: invalid byte sequence in UTF-8&quot; ### Detailed description When looking at the above URL, the headers indicate `content-type: text/html; charset=ISO-8859-1`, a non-UTF8 charset. We have around hundreds of these dead workers littering the dead worker queue, and nearly every one of them failed in this similar fashion. I think it's a fixable problem, so i'm reporting it here. ### Mastodon instance tech.lgbt ### Mastodon version v4.2.0-rc2+glitch ### Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux-gnu] - Node.js version: v18.12.1</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>264</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Convert `disconnectTimeline` and `timelineDelete` actions to Typescript (#30777)</MESSAGE>
    <SHA>1c6593277696c6f4698684860f7c6d6189f9b371</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Improve encoding detection for link cards Fixes the issue reported in #27230 by trying different approaches to detect encoding in this order: * `charlock_holmes` gem (which was the only existing approach) * `nokogiri`, which does it's own &quot;detection&quot; using meta tags * The server supplied encoding from HTTP headers * Default to UTF-8 Code has been restructured a bit to prevent nokogiri from parsing the HTML twice.</MESSAGE>
      <SHA>0d54a8e7212e6cb3eefecfb40b9eb475e27a89fd</SHA>
      <PATCHEDFILES>
        <FILE>app/lib/link_details_extractor.rb</FILE>
        <FILE>spec/fixtures/requests/low_confidence_latin1.txt</FILE>
        <FILE>spec/services/fetch_link_card_service_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
