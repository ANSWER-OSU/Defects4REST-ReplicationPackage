<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>28821</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/28821</ISSUEURL>
  <TITLE>LinkCrawlWorker fails with Errno::ENAMETOOLONG</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Let LinkCrawlWorker in Sidekiq process a link that is affected, the following post seems to trigger this issue: https://very.tastytea.de/notes/9o0dw2kljs ### Expected behaviour LinkCrawler should've given the temporary file a correct name ### Actual behaviour LinkCrawler ended up with the filename containing all headers, making it too long. The operation fails and ends up in the dead queue ### Detailed description _No response_ ### Mastodon instance woof.tech ### Mastodon version v4.1.11-3-woof ### Technical details - Ruby 3.0.4p208 - Node.js v16.20.2 Using some backported changes from main onto v4.1.11 (Like #28788), but this issue seems to happen on mainline mastodon as well Logs: ``` Jan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.065Z pid=4091868 tid=1yb5g class=LinkCrawlWorker jid=9febc4943b665a5240d5540a INFO: start Jan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.345Z pid=4091868 tid=1yb5g class=LinkCrawlWorker jid=9febc4943b665a5240d5540a INFO: Adding dead LinkCrawlWorker job 9febc4943b665a5240d5540a Jan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.347Z pid=4091868 tid=1yb5g class=LinkCrawlWorker jid=9febc4943b665a5240d5540a elapsed=0.281 INFO: fail Jan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.347Z pid=4091868 tid=1yb5g WARN: {&quot;context&quot;:&quot;Job raised exception&quot;,&quot;job&quot;:{&quot;retry&quot;:0,&quot;queue&quot;:&quot;pull&quot;,&quot;class&quot;:&quot;LinkCrawlWorker&quot;,&quot;args&quot;:[111688311417973189],&quot;jid&quot;:&quot;9febc4943b665a5240d5540a&quot;,&quot;created_at&quot;:1704228394.274077,&quot;enqueued_at&quot;:1705677347.065164,&quot;error_message&quot;:&quot;File name too long @ rb_sysopen - /tmp/d603ba193612fc3ba84766851f3938c920240119-4091868-wwu875.png22response-content-typeimage2FpngExpires1704866743SignatureTOuki&lt;part of sig&gt;qDdV2LRe0kMjCZLAVHMmzdGSeMjRjSlPMnd1S-dRLeCjI62qA__Key-Pair-IdAP&lt;part of key pair&gt;5A&quot;,&quot;error_class&quot;:&quot;Errno::ENAMETOOLONG&quot;,&quot;failed_at&quot;:1704228412.275545,&quot;retry_count&quot;:-1,&quot;retried_at&quot;:1705677240.856181}} Jan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.347Z pid=4091868 tid=1yb5g WARN: Errno::ENAMETOOLONG: File name too long @ rb_sysopen - /tmp/d603ba193612fc3ba84766851f3938c920240119-4091868-4gdtvo.png22response-content-typeimage2FpngExpires1704866743SignatureTOuki&lt;part of sig&gt;qDdV2LRe0kMjCZLAVHMmzdGSeMjRjSlPMnd1S-dRLeCjI62qA__Key-Pair-IdAP&lt;part of key pair&gt;5A Jan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.347Z pid=4091868 tid=1yb5g WARN: /home/mastodon/.rbenv/versions/3.0.6/lib/ruby/3.0.0/tempfile.rb:141:in `initialize' Jan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: /home/mastodon/.rbenv/versions/3.0.6/lib/ruby/3.0.0/tempfile.rb:141:in `open' Jan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: /home/mastodon/.rbenv/versions/3.0.6/lib/ruby/3.0.0/tempfile.rb:141:in `block in initialize' ``` Sidekiq: ``` Errno::ENAMETOOLONG: File name too long @ rb_sysopen - /tmp/d603ba193612fc3ba84766851f3938c920240119-4091868-4gdtvo.png22response-content-typeimage2FpngExpires1704866743SignatureTOukiuVPhRnvSiQFunalnM3[...] ```</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add rate-limit of TOTP authentication attempts at controller level (#28801)</MESSAGE>
    <SHA>3593ee2e36284de71be8dc74c1772de7a7e1a7e3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix error when processing remote files with unusually long names Fixes #28821</MESSAGE>
      <SHA>bfc3d574229dfe1053dcb376fc0b76732c9d4805</SHA>
      <PATCHEDFILES>
        <FILE>lib/paperclip/response_with_limit_adapter.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix error when processing remote files with unusually long names Fixes #28821</MESSAGE>
      <SHA>3d607a919e2221f8d45227771db0e484a08cabd5</SHA>
      <PATCHEDFILES>
        <FILE>lib/paperclip/response_with_limit_adapter.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix error when processing remote files with unusually long names Fixes #28821</MESSAGE>
      <SHA>4523714d4151ff39eb817dd6bae821380e774422</SHA>
      <PATCHEDFILES>
        <FILE>lib/paperclip/response_with_limit_adapter.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
