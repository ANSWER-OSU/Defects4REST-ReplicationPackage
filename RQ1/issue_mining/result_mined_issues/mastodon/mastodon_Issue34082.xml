<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>34082</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/34082</ISSUEURL>
  <TITLE>NoMethodError: undefined method `evalsha' for nil</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Inspect logs or sidekiq retry/dead queues ### Expected behaviour No warnings about NoMethodError ### Actual behaviour Warnings about NoMethodError ### Detailed description Since v4.3 I've seen a noticeable number of sidekiq jobs failing with the warning: ``` NoMethodError: undefined method `evalsha' for nil ``` It's unclear to me whether this is a bug, a deployment issue on my server, or the expected behaviour of some failure case. ### Mastodon instance sunny.garden ### Mastodon version v4.3.4 ### Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: ruby 3.3.5 (2024-09-03 revision ef084cc8f4) [x86_64-linux] - Node.js version: v20.17.0 In the majority of cases, the remote server is running Akkoma or Pleroma, however it also results from Mastodon servers less frequently as well. ``` Mar 05 05:53:36 radish-1 bundle[1908833]: 2025-03-05T05:53:36.195Z pid=1908833 tid=5zbdd WARN: {&quot;context&quot;:&quot;Job raised exception&quot;,&quot;job&quot;:{&quot;retry&quot;:16,&quot;queue&quot;:&quot;push&quot;,&quot;dead&quot;:false,&quot;class&quot;:&quot;ActivityPub::DeliveryWorker&quot;,&quot;args&quot;:[&quot;{\&quot;@context\&quot;:[\&quot;https://www.w3.org/ns/activitystreams\&quot;,\&quot;https://w3id.org/security/v1\&quot;,{\&quot;manuallyApprovesFollowers\&quot;:\&quot;as:manuallyApprovesFollowers\&quot;,\&quot;sensitive\&quot;:\&quot;as:sensitive\&quot;,\&quot;Hashtag\&quot;:\&quot;as:Hashtag\&quot;,\&quot;movedTo\&quot;:{\&quot;@id\&quot;:\&quot;as:movedTo\&quot;,\&quot;@type\&quot;:\&quot;@id\&quot;},\&quot;alsoKnownAs\&quot;:{\&quot;@id\&quot;:\&quot;as:alsoKnownAs\&quot;,\&quot;@type\&quot;:\&quot;@id\&quot;},\&quot;toot\&quot;:\&quot;http://joinmastodon.org/ns#\&quot;,\&quot;Emoji\&quot;:\&quot;toot:Emoji\&quot;,\&quot;featured\&quot;:{\&quot;@id\&quot;:\&quot;toot:featured\&quot;,\&quot;@type\&quot;:\&quot;@id\&quot;},\&quot;featuredTags\&quot;:{\&quot;@id\&quot;:\&quot;toot:featuredTags\&quot;,\&quot;@type\&quot;:\&quot;@id\&quot;},\&quot;schema\&quot;:\&quot;http://schema.org#\&quot;,\&quot;PropertyValue\&quot;:\&quot;schema:PropertyValue\&quot;,\&quot;value\&quot;:\&quot;schema:value\&quot;,\&quot;ostatus\&quot;:\&quot;http://ostatus.org#\&quot;,\&quot;atomUri\&quot;:\&quot;ostatus:atomUri\&quot;,\&quot;inReplyToAtomUri\&quot;:\&quot;ostatus:inReplyToAtomUri\&quot;,\&quot;conversation\&quot;:\&quot;ostatus:conversation\&quot;,\&quot;focalPoint\&quot;:{\&quot;@container\&quot;:\&quot;@list\&quot;,\&quot;@id\&quot;:\&quot;toot:focalPoint\&quot;},\&quot;blurhash\&quot;:\&quot;toot:blurhash\&quot;,\&quot;discoverable\&quot;:\&quot;toot:discoverable\&quot;,\&quot;indexable\&quot;:\&quot;toot:indexable\&quot;,\&quot;memorial\&quot;:\&quot;toot:memorial\&quot;,\&quot;votersCount\&quot;:\&quot;toot:votersCount\&quot;,\&quot;suspended\&quot;:\&quot;toot:suspended\&quot;,\&quot;attributionDomains\&quot;:{\&quot;@id\&quot;:\&quot;toot:attributionDomains\&quot;,\&quot;@type\&quot;:\&quot;@id\&quot;}}],\&quot;id\&quot;:\&quot;https://pie.gd/users/faerye/statuses/114108252734374063/activity\&quot;,\&quot;type\&quot;:\&quot;Create\&quot;,\&quot;actor\&quot;:\&quot;https://pie.gd/users/faerye\&quot;,\&quot;published\&quot;:\&quot;2025-03-05T05:49:18Z\&quot;,\&quot;to\&quot;:[\&quot;https://www.w3.org/ns/activitystreams#Public\&quot;],\&quot;cc\&quot;:[\&quot;https://pie.gd/users/faerye/followers\&quot;,\&quot;https://sunny.garden/users/handmade_ghost\&quot;],\&quot;object\&quot;:{\&quot;id\&quot;:\&quot;https://pie.gd/users/faerye/statuses/114108252734374063\&quot;,\&quot;type\&quot;:\&quot;Note\&quot;,\&quot;inReplyTo\&quot;:\&quot;https://sunny.garden/users/handmade_ghost/statuses/114107038088241764\&quot;,\&quot;published\&quot;:\&quot;2025-03-05T05:49:18Z\&quot;,\&quot;url\&quot;:\&quot;https://pie.gd/@faerye/114108252734374063\&quot;,\&quot;attributedTo\&quot;:\&quot;https://pie.gd/users/faerye\&quot;,\&quot;to\&quot;:[\&quot;https://www.w3.org/ns/activitystreams#Public\&quot;],\&quot;cc\&quot;:[\&quot;https://pie.gd/users/faerye/followers\&quot;,\&quot;https://sunny.garden/users/handmade_ghost\&quot;],\&quot;sensitive\&quot;:false,\&quot;atomUri\&quot;:\&quot;https://pie.gd/users/faerye/statuses/114108252734374063\&quot;,\&quot;inReplyToAtomUri\&quot;:\&quot;https://sunny.garden/users/handmade_ghost/statuses/114107038088241764\&quot;,\&quot;conversation\&quot;:\&quot;tag:pie.gd,2025-02-28:objectId=1386706:objectType=Conversation\&quot;,\&quot;content\&quot;:\&quot;&lt;p&gt;&lt;span class=\\\&quot;h-card\\\&quot; translate=\\\&quot;no\\\&quot;&gt;&lt;a href=\\\&quot;https://sunny.garden/@handmade_ghost\\\&quot; class=\\\&quot;u-url mention\\\&quot;&gt;@&lt;span&gt;handmade_ghost&lt;/span&gt;&lt;/a&gt;&lt;/span&gt; Yesssss! I most often hear creepers in a mature second growth conifer forest I go to, but never see ‘em. Basically every decent or good photo I have is from deciduous wooded parkland (a sort of botanical garden in this case!) Not just the bark match factor: they were far lower! I’ll see what I can do about getting their advice creeper-peeping its way south :)&lt;/p&gt;\&quot;,\&quot;contentMap\&quot;:{\&quot;en\&quot;:\&quot;&lt;p&gt;&lt;span class=\\\&quot;h-card\\\&quot; translate=\\\&quot;no\\\&quot;&gt;&lt;a href=\\\&quot;https://sunny.garden/@handmade_ghost\\\&quot; class=\\\&quot;u-url mention\\\&quot;&gt;@&lt;span&gt;handmade_ghost&lt;/span&gt;&lt;/a&gt;&lt;/span&gt; Yesssss! I most often hear creepers in a mature second growth conifer forest I go to, but never see ‘em. Basically every decent or good photo I have is from deciduous wooded parkland (a sort of botanical garden in this case!) Not just the bark match factor: they were far lower! I’ll see what I can do about getting their advice creeper-peeping its way south :)&lt;/p&gt;\&quot;},\&quot;attachment\&quot;:[],\&quot;tag\&quot;:[{\&quot;type\&quot;:\&quot;Mention\&quot;,\&quot;href\&quot;:\&quot;https://sunny.garden/users/handmade_ghost\&quot;,\&quot;name\&quot;:\&quot;@handmade_ghost@sunny.garden\&quot;}],\&quot;replies\&quot;:{\&quot;id\&quot;:\&quot;https://pie.gd/users/faerye/statuses/114108252734374063/replies\&quot;,\&quot;type\&quot;:\&quot;Collection\&quot;,\&quot;first\&quot;:{\&quot;type\&quot;:\&quot;CollectionPage\&quot;,\&quot;next\&quot;:\&quot;https://pie.gd/users/faerye/statuses/114108252734374063/replies?only_other_accounts=true&amp;page=true\&quot;,\&quot;partOf\&quot;:\&quot;https://pie.gd/users/faerye/statuses/114108252734374063/replies\&quot;,\&quot;items\&quot;:[]}},\&quot;likes\&quot;:{\&quot;id\&quot;:\&quot;https://pie.gd/users/faerye/statuses/114108252734374063/likes\&quot;,\&quot;type\&quot;:\&quot;Collection\&quot;,\&quot;totalItems\&quot;:0},\&quot;shares\&quot;:{\&quot;id\&quot;:\&quot;https://pie.gd/users/faerye/statuses/114108252734374063/shares\&quot;,\&quot;type\&quot;:\&quot;Collection\&quot;,\&quot;totalItems\&quot;:0}},\&quot;signature\&quot;:{\&quot;type\&quot;:\&quot;RsaSignature2017\&quot;,\&quot;creator\&quot;:\&quot;https://pie.gd/users/faerye#main-key\&quot;,\&quot;created\&quot;:\&quot;2025-03-05T05:49:18Z\&quot;,\&quot;signatureValue\&quot;:\&quot;YlN++XTAnBRn8ediYHUDeZOFznlI0kHg5CR5sz9WQlB5XgMj9FXMoRNmVciOglT0tRENebRCXSHDtaruYNSHyaGOgoXDkvQs67upp/1CbSXVtGRRxZ3RtVxVNROI3rKqMwUY3X7Iak5AJg6aXdcxJh65imCXINHXY1g+1f8vcyZsEH8u4zAeEV/eq9Im5znoShozaLLiChkDog+WZgkQZYGjLPYffze5AqNlrx/vO07j9Jv50/m8SvK/Ttc3WLNvTnO+2+wiezOjDWwRYMvVqOj0SLHjaxIpYGccH5u1e49Rs6HK7BvMdu26v/ipDE95zEs8Ei1QkRT+jmfVKgh7uQ==\&quot;}}&quot;,112151750992567142,&quot;https://outerheaven.club/inbox&quot;,{}],&quot;jid&quot;:&quot;96048db846354f6fac304e82&quot;,&quot;created_at&quot;:1741153759.255959,&quot;enqueued_at&quot;:1741154015.807546,&quot;error_message&quot;:&quot;https://outerheaven.club/inbox returned code 401&quot;,&quot;error_class&quot;:&quot;Mastodon::UnexpectedResponseError&quot;,&quot;failed_at&quot;:1741153765.253845,&quot;retry_count&quot;:3,&quot;retried_at&quot;:1741153876.4350216}} Mar 05 05:53:36 radish-1 bundle[1908833]: 2025-03-05T05:53:36.196Z pid=1908833 tid=5zbdd WARN: NoMethodError: undefined method `evalsha' for nil Mar 05 05:53:36 radish-1 bundle[1908833]: 2025-03-05T05:53:36.196Z pid=1908833 tid=5zbdd WARN: /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/redlock-1.3.2/lib/redlock/client.rb:171:in `block (2 levels) in lock' Mar 05 05:53:36 radish-1 bundle[1908833]: /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/activesupport-7.1.5.1/lib/active_support/core_ext/object/with.rb:31:in `with' Mar 05 05:53:36 radish-1 bundle[1908833]: /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/redlock-1.3.2/lib/redlock/client.rb:171:in `block in lock' ```</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>chore(deps): update dependency i18n-tasks to v1.0.15 (#34112) Co-authored-by: renovate[bot] &lt;29139614+renovate[bot]@users.noreply.github.com&gt;</MESSAGE>
    <SHA>8fedd9b19a67f476114dc6106a0b08ebf663f4cf</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix Stoplight errors when using `REDIS_NAMESPACE` Fixes #34082</MESSAGE>
      <SHA>9705e375f7fed34ca74a83ac15cf17b9006e4038</SHA>
      <PATCHEDFILES>
        <FILE>lib/redis/namespace_extensions.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
