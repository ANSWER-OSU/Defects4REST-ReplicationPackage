<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>27568</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/27568</ISSUEURL>
  <TITLE>Ignore not found media files in AttachmentBatch deletion with OpenStack Swift</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Manually delete a media file/directory from the OpenStack Swift object storage (to simulate a missing file) 2. Run AttachmentBatch deletion that would attempt to delete that file ### Expected behaviour Log error and continue ### Actual behaviour Stops AttachmentBatch deletion ### Detailed description With the fix introduced in #27554 AttachmentBatch deletion is working but it introduces a couple of problems. If OpenStack Swift object storage stops fails to respond either due to a server error (500 or similar) or in my case because it hit the maximum requests per minute (429 Too Many Requests), the object may be deleted in the object storage but the database not updated to reflect that. The next time you attempt to run AttachmentBatch deletion where that media is again marked for deletion, the process exits because the file is missing &quot;Expected(204) &lt;=&gt; Actual(404 Not Found)&quot;. Note that a file may also be missing for other reasons, like failing to properly upload or some other error. So, it would be good to just ignore files that were missing but continue to fail if other errors from the object storage (500, 429, etc). Possibly something similar to what we see on the filesystem storage https://github.com/mastodon/mastodon/blob/863ba46b00ea8b736e7473264e54b73029cafb60/app/lib/attachment_batch.rb#L72-L74 ### Mastodon instance Several ### Mastodon version v4.2.1 + #27554 ### Technical details OpenStack Swift Object Storage with #27554</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Run `bin/rails app:update` with Rails 7.1 (#27522)</MESSAGE>
    <SHA>9a3d047f3e604e581e18346424569e28fc9c5b96</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix error when trying to delete already-deleted file with OpenStack Swift Fixes #27568</MESSAGE>
      <SHA>e785c4b882ef9424175e6767ee00bcd53df3925a</SHA>
      <PATCHEDFILES>
        <FILE>app/lib/attachment_batch.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
