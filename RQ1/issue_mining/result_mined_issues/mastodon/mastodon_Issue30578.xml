<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>30578</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/30578</ISSUEURL>
  <TITLE>Without ImageMagick, uploading emoji files is not possible</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Set an emoji name and select the emoji file 2. Clicking Upload immediately throws an error ### Expected behaviour Successful upload and emoji added ### Actual behaviour Imediate error, failed upload ### Detailed description After #30090, when uploading an emoji file, an error is immediately thrown. ``` INFO -- : [747998e2-f015-4df6-9828-21284dd45a61] [paperclip] Trying to link /tmp/RackMultipart20240606-4122054-jvtb5n.gif to /tmp/727f3ea9cd9c5f222fec438bb341a8a020240606-4122054-79d0xi.gif INFO -- : [747998e2-f015-4df6-9828-21284dd45a61] Command :: identify -format '%wx%h,%[exif:orientation]' '/tmp/727f3ea9cd9c5f222fec438bb341a8a020240606-4122054-79d0xi.gif[0]' 2&gt;/dev/null INFO -- : [747998e2-f015-4df6-9828-21284dd45a61] method=POST path=/admin/custom_emojis format=html controller=Admin::CustomEmojisController action=create status=500 allocations=3481 duration=45.68 view=0.00 db=11.68 FATAL -- : [747998e2-f015-4df6-9828-21284dd45a61] [747998e2-f015-4df6-9828-21284dd45a61] Paperclip::Errors::CommandNotFoundError (Could not run the `identify` command. Please install ImageMagick.): [747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:21:in `block in post_process_style' [747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `each' [747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `inject' [747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `post_process_style' [747998e2-f015-4df6-9828-21284dd45a61] app/controllers/admin/custom_emojis_controller.rb:21:in `create' [747998e2-f015-4df6-9828-21284dd45a61] app/controllers/concerns/localized.rb:11:in `set_locale' [747998e2-f015-4df6-9828-21284dd45a61] lib/mastodon/rack_middleware.rb:9:in `call' ``` I enabled `libvips` and uninstalled `ImageMagick`. If emojis are meant to be processed by IM instead, I'll reinstall it again. ### Mastodon instance bolha.one ### Mastodon version v4.3.0-alpha.4-4655be0 ### Technical details _No response_</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Enable paperclip processing for custom emoji specs</MESSAGE>
    <SHA>50169ad862608daf68307421bc6b63341d3c2b5e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix ImageMagick use for custom emojis Fixes #30578</MESSAGE>
      <SHA>d1057aa3a7a10264fff9b3250a51617265f22717</SHA>
      <PATCHEDFILES>
        <FILE>app/models/custom_emoji.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix ImageMagick use for custom emojis Fixes #30578</MESSAGE>
      <SHA>d41aa34eebd9b9da98e67f43f26018fd35e44db0</SHA>
      <PATCHEDFILES>
        <FILE>app/models/custom_emoji.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
