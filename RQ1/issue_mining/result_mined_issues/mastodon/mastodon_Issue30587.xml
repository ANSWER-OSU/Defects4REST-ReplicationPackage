<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>30587</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/30587</ISSUEURL>
  <TITLE>Extra '@context' in 'outbox.jon' when archive export is generated, fails validation</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Request data archive 2. Download archive 3. Extract archive, open 'outbox.json' 4. Validate JSON, which fails ### Expected behaviour A single `@context` key ### Actual behaviour A second `@context` key is present ### Detailed description As far as I have been able to determine, this was introduced between December 31st and February 14th, which are the dates of the two exports we can test against; the former opens and validates just fine, while the latter throws an error. If the second `@context`, which as far as I can tell contains no actual data, is removed, the file validates. This happens both in larger exports, with over 17.000 items, as well as a small one, with just 111 'orderedItems', exported right before creating this ticket. See attached screenshot from the VDT Labs JSON Editor. Comparing the dates with available releases, this may have been introduced in 4.2.4, 4.2.5, or 4.2.6? ![Screenshot 2024-06-07 at 08 17 15-optimised](https://github.com/mastodon/mastodon/assets/91268/65d42d5e-dfc3-4c90-b088-8500f82c4e30) ### Mastodon instance ngmx.com ### Mastodon version v4.2.9 ### Technical details ``` $ ruby --version ruby 3.0.4p208 (2022-04-12 revision 3fa771dded) [x86_64-linux] $ node --version v16.20.2 ```</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Opt in to remaining Rails 7.1 defaults (#30332) Co-authored-by: Claire &lt;claire.github-309c@sitedethib.com&gt;</MESSAGE>
    <SHA>0cf91213c93e87ce775453ae20a3d9a7f9b4e8d0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix duplicate `@context` attribute in user export Fixes #30587</MESSAGE>
      <SHA>c0db3318ccf783a74b310c3da3fe749d923c0270</SHA>
      <PATCHEDFILES>
        <FILE>app/services/backup_service.rb</FILE>
        <FILE>spec/services/backup_service_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
