<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>30281</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/30281</ISSUEURL>
  <TITLE>Favicon is considered orphaned media</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Upload a favicon in **Branding** settings 2. Run `tootctl media remove-orphans` 3. Favicon `.png` is now gone, but `.ico` remains. ... ### Expected behaviour Favicon not to be considered orphaned media ### Actual behaviour Favicon is considered orphaned media and deleted ### Detailed description After #30040, admins can now upload favicons to their instances. But the `tootctl media remove-orphans` command considers them as orphaned media, so the `.png` files are deleted. The `.ico` version is preserved, but the favicon used by browsers is the `.png` one, so they fail to show a favicon at all. Akkoma instances also fails to present the favicon. ``` I, [2024-05-13T10:04:45.895906 #421984] INFO -- : [dotenv] Loaded .env.production (...) Found and removed orphan: site_uploads/files/000/000/019/16/724461bd9f815f15.png Found and removed orphan: site_uploads/files/000/000/019/32/724461bd9f815f15.png Found and removed orphan: site_uploads/files/000/000/019/48/724461bd9f815f15.png (...) ``` ### Mastodon instance bolha.one ### Mastodon version v4.3.0-alpha.3-1959365 ### Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: `3.3.1 (2024-04-23 revision c56cd86388)` - Node.js version: `v20.13.0`</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix repetitive database queries from #30040 (#30259)</MESSAGE>
    <SHA>85c625d31974e411666812468ddfd7760ab67d4a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix off-by-one in `tootctl media` commands Fixes #30281</MESSAGE>
      <SHA>5c15c0f3b4923c13511fe69817cefb05e3f80dae</SHA>
      <PATCHEDFILES>
        <FILE>lib/mastodon/cli/media.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
