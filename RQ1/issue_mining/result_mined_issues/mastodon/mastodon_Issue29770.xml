<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>29770</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/29770</ISSUEURL>
  <TITLE>Inconsistent handling of REDIS environment variables across streaming and puma images</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem It seems that the redis configuration is being parsed differently in `streaming/index.js` to the rest of Mastodon. Specifically in `redisConfigFromEnv`: ``` const redisConfigFromEnv = (env) =&gt; { ... let redisPort = parseIntFromEnv(env.REDIS_PORT, 6379, 'REDIS_PORT'); let redisDatabase = parseIntFromEnv(env.REDIS_DB, 0, 'REDIS_DB'); /** @type {import('ioredis').RedisOptions} */ const redisParams = { host: env.REDIS_HOST || '127.0.0.1', port: redisPort, db: redisDatabase, password: env.REDIS_PASSWORD || undefined, }; return { redisParams, redisPrefix, redisUrl: typeof env.REDIS_URL === 'string' ? env.REDIS_URL : undefined, }; ``` This code will cause an exception when `REDIS_PORT` contains any `NaN` string other than `&quot;&quot;`, even when `REDIS_URL` is used to overwrite this very setting. This is inconsistent with how the rest of mastodon handles the redis configuration, where all other `REDIS_` env variables are ignored as long as a `REDIS_URL` is provided. ### Expected behaviour Both streaming, sidekiq and puma should interpret the config the same ### Actual behaviour streaming processes `REDIS_PORT` and `REDIS_DB` even when `REDIS_URL` is set. ### Detailed description _No response_ ### Mastodon instance _No response_ ### Mastodon version _No response_ ### Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: (from `ruby --version`, eg. v3.1.2) - Node.js version: (from `node --version`, eg. v18.16.0)</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>161</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>New Crowdin Translations (automated) (#29888) Co-authored-by: GitHub Actions &lt;noreply@github.com&gt;</MESSAGE>
    <SHA>db5a5636d97aa754ac7cc1fb4cd974ff9d953335</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #29770 by only parsing REDIS_PORT and REDIS_DB variable if REDIS_URL is not used.</MESSAGE>
      <SHA>6af2106be43a28158da03120cdfa94c0d0463920</SHA>
      <PATCHEDFILES>
        <FILE>streaming/index.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #29770 by only parsing REDIS_PORT and REDIS_DB variable if REDIS_URL is not used.</MESSAGE>
      <SHA>30540d4fb6faac5cef2dd653cbdb9c52bbd7395d</SHA>
      <PATCHEDFILES>
        <FILE>streaming/index.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #29770 by only parsing REDIS_PORT and REDIS_DB variable if REDIS_URL is not used.</MESSAGE>
      <SHA>0f522b77a2428126695077169bbec2b534ddb88c</SHA>
      <PATCHEDFILES>
        <FILE>streaming/index.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
