<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3557</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3557</ISSUEURL>
  <TITLE>[filer] DATA RACE on uploadReaderToChunks.fileChunks</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` s3_1 | ================== s3_1 | WARNING: DATA RACE s3_1 | Write at 0x00c00b104288 by goroutine 11089: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func1() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:120 +0x391 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func3() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:124 +0x47 s3_1 | s3_1 | Previous read at 0x00c00b104288 by goroutine 11092: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func1() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:122 +0x3f9 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func3() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:124 +0x47 s3_1 | s3_1 | Goroutine 11089 (running) created at: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:102 +0xfeb s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:108 +0x224 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() s3_1 | &lt;autogenerated&gt;:1 +0x57 s3_1 | net/http.HandlerFunc.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d s3_1 | net/http.(*ServeMux).ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 s3_1 | net/http.serverHandler.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 s3_1 | net/http.(*conn).serve() s3_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 s3_1 | net/http.(*Server).Serve.func3() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 s3_1 | s3_1 | Goroutine 11092 (finished) created at: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:102 +0xfeb s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:108 +0x224 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() s3_1 | &lt;autogenerated&gt;:1 +0x57 s3_1 | net/http.HandlerFunc.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d s3_1 | net/http.(*ServeMux).ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 s3_1 | net/http.serverHandler.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 s3_1 | net/http.(*conn).serve() s3_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 s3_1 | net/http.(*Server).Serve.func3() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 s3_1 | ================== ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>upload_content: upload close response.Body</MESSAGE>
    <SHA>4a4ef3cc3c24d0c86defe82445448a567316cc36</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid data race read fileChunksSize https://github.com/seaweedfs/seaweedfs/issues/3557</MESSAGE>
      <SHA>cc3442c54828fb02698a1d1af26a1cdf52b2c574</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>avoid data race read fileChunksSize (#3570) https://github.com/seaweedfs/seaweedfs/issues/3557</MESSAGE>
      <SHA>90d55cd179732a375f112c72893e2cca1b41afd1</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
