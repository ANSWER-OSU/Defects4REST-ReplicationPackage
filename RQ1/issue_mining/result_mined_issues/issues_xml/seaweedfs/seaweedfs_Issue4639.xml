<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4639</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/4639</ISSUEURL>
  <TITLE>Second Filer first start bootstrap stuck</TITLE>
  <DESCRIPTION>**Describe the bug** When running the filer services on a 3-node cluster, the first filer server starts perfectly (port 8888 and 8889 are reachable in read-only mode). However, when I try to start an additional filer service, it gets stuck during startup, and the required ports (8888, 18888, etc.) are not being listened to, and nothing happens. The live filer server continuously throws the following error messages: `7300884 Jul 4 15:57:36 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:36.908767 meta_aggregator.go:103 subscribing remote 192.168.40.45:8888 meta change: connecting to peer filer 192.168.40.45:8888: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp 192.168.40.45:18888: connect: connection refused&quot; Jul 4 15:57:38 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:38.641958 meta_aggregator.go:92 loopSubscribeToOneFiler read 192.168.40.45:8888 start from 2023-07-04 15:44:57.107300884 +0200 CEST 1688478297107300884 Jul 4 15:57:38 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:38.642976 meta_aggregator.go:103 subscribing remote 192.168.40.45:8888 meta change: connecting to peer filer 192.168.40.45:8888: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp 192.168.40.45:18888: connect: connection refused&quot; Jul 4 15:57:40 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:40.376985 meta_aggregator.go:92 loopSubscribeToOneFiler read 192.168.40.45:8888 start from 2023-07-04 15:44:57.107300884 +0200 CEST 1688478297107300884 Jul 4 15:57:40 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:40.377856 meta_aggregator.go:103 subscribing remote 192.168.40.45:8888 meta change: connecting to peer filer 192.168.40.45:8888: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp 192.168.40.45:18888: connect: connection refused&quot; Jul 4 15:57:42 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:42.111475 meta_aggregator.go:92 loopSubscribeToOneFiler read 192.168.40.45:8888 start from 2023-07-04 15:44:57.107300884 +0200 CEST 1688478297107300884 Jul 4 15:57:42 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:42.112280 meta_aggregator.go:103 subscribing remote 192.168.40.45:8888 meta change: connecting to peer filer 192.168.40.45:8888: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp 192.168.40.45:18888: connect: connection refused&quot; Jul 4 15:57:43 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:43.846429 meta_aggregator.go:92 loopSubscribeToOneFiler read 192.168.40.45:8888 start from 2023-07-04 15:44:57.107300884 +0200 CEST 1688478297107300884 Jul 4 15:57:43 sofalvin-seaweedfs-a seaweedfs-volume[30449]: I0704 15:57:43.847666 meta_aggregator.go:103 subscribing remote 192.168.40.45:8888 meta change: connecting to peer filer 192.168.40.45:8888: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp 192.168.40.45:18888: connect: connection refused&quot;` The second filer, which I'm trying to start, gets stuck at this point: `root@sofalvin-seaweedfs-b:~# /usr/local/bin/weed filer -debug -port=8888 -port.readonly=8899 -master=192.168.40.44:9333,192.168.40.45:9333,192.168.40.62:9333 -dataCenter=datacenter-01 -defaultStoreDir=/opt/filer_store I0704 15:44:57.043401 filer_server.go:141 default to create filer store dir in /opt/filer_store/filerldb2 I0704 15:44:57.046496 leveldb2_store.go:42 filer store leveldb2 dir: /opt/filer_store/filerldb2 I0704 15:44:57.046624 file_util.go:23 Folder /opt/filer_store/filerldb2 Permission: -rwxr-xr-x I0704 15:44:57.111770 filer.go:163 create filer.store.id to 1700974077 I0704 15:44:57.111850 configuration.go:28 configured filer store to leveldb2 I0704 15:44:57.112903 master_client.go:20 the cluster has 2 filer I0704 15:44:57.112932 filer_server.go:169 192.168.40.45:8888 bootstrap from peers [node_type:&quot;filer&quot; address:&quot;192.168.40.44:8888&quot; is_add:true created_at_ns:1688478167862760066 node_type:&quot;filer&quot; address:&quot;192.168.40.45:8888&quot; is_add:true created_at_ns:1688478297106983724] I0704 15:44:57.113000 filer.go:91 bootstrap from 192.168.40.44:8888 clientId:501074952` Restarting or restarting the second filer server resolves the issue and everything runs smoothly. What could be causing this? **System Setup** - List the command line to start &quot;weed master&quot;, &quot;weed volume&quot;, &quot;weed filer&quot;, &quot;weed s3&quot;, &quot;weed mount&quot;. /usr/local/bin/weed master -ip=192.168.40.44 -port=9333 -mdir=/opt/seaweedfs -peers=192.168.40.44:9333,192.168.40.45:9333,192.168.40.62:9333 -defaultReplication=001 /usr/local/bin/weed volume -dir=/mnt/vol1 -port=8080 -mserver=192.168.40.44:9333,192.168.40.45:9333,192.168.40.62:9333 -dataCenter datacenter-01 -rack rack-01 -fileSizeLimitMB 1000 /usr/local/bin/weed filer -debug -port=8888 -port.readonly=8899 -master=192.168.40.44:9333,192.168.40.45:9333,192.168.40.62:9333 -dataCenter=datacenter-01 -defaultStoreDir=/opt/filer_store - OS version Debian 11 - output of `weed version` version 30GB 3.53 linux amd64 - if using filer, show the content of `filer.toml` /usr/local/bin/weed filer -debug -port=8888 -port.readonly=8899 -master=192.168.40.44:9333,192.168.40.45:9333,192.168.40.62:9333 -dataCenter=datacenter-01 -defaultStoreDir=/opt/filer_store</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>12</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Concurrency works better (#4663) Co-authored-by: mervyn.zhang &lt;mervyn.zhang@sap.com&gt;</MESSAGE>
    <SHA>5f42cf1c34f59b48e73452ee7111d3d8d516491e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix refactoring mistake fix https://github.com/seaweedfs/seaweedfs/issues/4639</MESSAGE>
      <SHA>7243f0b2224b17271469abb481294592a0e97202</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/filer.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix refactoring mistake fix https://github.com/seaweedfs/seaweedfs/issues/4639</MESSAGE>
      <SHA>6f588b5b182b1b5ac5e81b49b81ab4e3a2b8187f</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/filer.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
