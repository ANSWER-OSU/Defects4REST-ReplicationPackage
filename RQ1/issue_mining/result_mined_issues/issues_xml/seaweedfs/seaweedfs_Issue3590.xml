<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3590</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3590</ISSUEURL>
  <TITLE>[master] DATA RACE on reaches full capacity</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` | Sep 3, 2022 @ 14:50:12.709 | I0903 09:50:12.708915 volume_layout.go:447 Volume 1837 reaches full capacity. | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/pkg/mod/google.golang.org/grpc@v1.48.0/internal/transport/http2_server.go:603 +0x3329 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:1640 +0xfae | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/command.startMaster() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/topology/topology_event_handling.go:35 +0x28e | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:930 +0x4dd | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/server.NewMasterServer() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | google.golang.org/grpc/internal/transport.(*http2Server).HandleStreams() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:1558 +0x1c01 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | WARNING: DATA RACE | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:196 +0x187 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/pb/master_pb/master_grpc.pb.go:351 +0xc5 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/weed.go:81 +0x943 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | ================== | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/server.(*MasterServer).SendHeartbeat() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | Goroutine 3737364 (running) created at: | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | google.golang.org/grpc.(*Server).serveStreams() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | main.main() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:932 +0xec | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | google.golang.org/grpc.(*Server).handleRawConn.func1() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/topology.(*DataNode).AdjustMaxVolumeCounts() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).UpAdjustDiskUsageDelta() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/command/master.go:146 +0x44c | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | sync/atomic.AddInt64() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | google.golang.org/grpc.(*Server).handleStream() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/master_server.go:151 +0x1b24 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | sync/atomic.AddInt64() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | Goroutine 50 (running) created at: | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/topology/topology_event_handling.go:68 +0x394 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | Previous read at 0x00c000afe830 by goroutine 3737364: | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /usr/local/go/src/runtime/race_amd64.s:289 +0xb | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/command.runMaster() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:916 +0x275 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/topology/data_node.go:144 +0x1f6 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/topology.(*Topology).StartRefreshWritableVolumes() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).UpAdjustDiskUsageDelta() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/pb/master_pb._Seaweed_SendHeartbeat_Handler() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:858 +0x64 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | google.golang.org/grpc.(*Server).serveStreams.func1() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | - | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | &lt;autogenerated&gt;:1 +0x1b | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | - | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:193 +0x118 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | google.golang.org/grpc.(*Server).serveStreams.func1.2() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/pkg/mod/google.golang.org/grpc@v1.48.0/internal/transport/http2_server.go:648 +0x378 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/topology.(*Topology).SetVolumeCapacityFull() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | google.golang.org/grpc.(*Server).processStreamingRPC() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | - | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | Write at 0x00c000afe830 by goroutine 50: | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | ================== | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/topology/topology_event_handling.go:39 +0x224 | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | google.golang.org/grpc/internal/transport.(*http2Server).operateHeaders() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | github.com/seaweedfs/seaweedfs/weed/topology.(*Topology).StartRefreshWritableVolumes.func3() | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/master_grpc_server.go:136 +0x92b | fast-master-2 | Sep 3, 2022 @ 14:50:12.712 | /go/src/github.com/seaweedfs/seaweedfs/weed/command/master.go:122 +0x4af | fast-master-2 | Sep 3, 2022 @ 14:50:20.465 | I0903 09:50:20.465211 volume_layout.go:447 Volume 1804 reaches full capacity. | fast-master-2 ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>3.25</MESSAGE>
    <SHA>5b38f22e6ea2a27681d77b42c0d09620ae8d6966</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid data race on currentDiskUsage.maxVolumeCount https://github.com/seaweedfs/seaweedfs/issues/3590</MESSAGE>
      <SHA>dfe88dbb7a8ffebd9e2fd254c53d35656094c7e2</SHA>
      <PATCHEDFILES>
        <FILE>weed/topology/data_node.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>avoid data race on currentDiskUsage.maxVolumeCount (#3592) https://github.com/seaweedfs/seaweedfs/issues/3590</MESSAGE>
      <SHA>695e3a909c43be623228a4b5a9c9c7cd371f6752</SHA>
      <PATCHEDFILES>
        <FILE>weed/topology/data_node.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
