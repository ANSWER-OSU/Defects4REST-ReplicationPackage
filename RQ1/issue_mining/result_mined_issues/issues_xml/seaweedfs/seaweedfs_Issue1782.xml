<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1782</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/1782</ISSUEURL>
  <TITLE>Error&quot; upload to filer error: rpc error&quot; occured when writing billions small files via s3 gateway</TITLE>
  <DESCRIPTION>**update: The third error occured yesterday.I found a interesting thing. This error seems to happed on certain amount of files.** **The first error：** [2021-02-03 09:26:55 070][INFO] Process: 11.96%(**1196347130**/10000000000), Ops: 6305/1s, Bandwidth: 23.25MB/1s(3.75TB), Error: 0.00%(34/10000000000) **The second error：**[2021-02-05 03:53:51 071][INFO] Process: 22.70%(**2270023401**/10000000000), Ops: 1969/1s, Bandwidth: 8.13MB/1s(7.50TB), Error: 0.00%(113/10000000000) **The third error：**[2021-02-07 01:40:36 070][INFO] Process: 33.44%(**3343713356**/10000000000), Ops: 5915/1s, Bandwidth: 21.70MB/1s(11.25TB), Error: 0.00%(200/10000000000) Sponsors SeaweedFS via Patreon https://www.patreon.com/seaweedfs Report issues here. Ask questions here https://stackoverflow.com/questions/tagged/seaweedfs Please ask questions in https://github.com/chrislusf/seaweedfs/discussions example of a good issue report: https://github.com/chrislusf/seaweedfs/issues/1005 example of a bad issue report: https://github.com/chrislusf/seaweedfs/issues/1008 **Describe the bug** I am trying to test the performance of s3 gateway when uploading small files(filesize:1k,2k,4k.) Error&quot; upload to filer error: rpc error&quot; occured when writing billions small files via s3 gateway. The first error happend when 1196340762 files were uploaded. The second error happed when 2270023401 files were uploaded. Here are the logs of test tool: [2021-02-03 09:26:53 070][INFO] Process: 11.96%(1196340762/10000000000), Ops: 6248/1s, Bandwidth: 22.88MB/1s(3.75TB), Error: 0.00%(0/10000000000) [2021-02-03 09:26:54 070][INFO] Process: 11.96%(1196340825/10000000000), Ops: 63/1s, Bandwidth: 782.00KB/1s(3.75TB), Error: 0.00%(24/10000000000) [2021-02-03 09:26:55 070][INFO] Process: 11.96%(1196347130/10000000000), Ops: 6305/1s, Bandwidth: 23.25MB/1s(3.75TB), Error: 0.00%(34/10000000000) [2021-02-05 03:53:49 070][INFO] Process: 22.70%(2270016831/10000000000), Ops: 6841/1s, Bandwidth: 25.04MB/1s(7.50TB), Error: 0.00%(34/10000000000) [2021-02-05 03:53:50 072][INFO] Process: 22.70%(2270021432/10000000000), Ops: 4601/1s, Bandwidth: 17.51MB/1s(7.50TB), Error: 0.00%(37/10000000000) [2021-02-05 03:53:51 071][INFO] Process: 22.70%(2270023401/10000000000), Ops: 1969/1s, Bandwidth: 8.13MB/1s(7.50TB), Error: 0.00%(113/10000000000) [2021-02-05 03:53:52 070][INFO] Process: 22.70%(2270030654/10000000000), Ops: 7253/1s, Bandwidth: 26.68MB/1s(7.50TB), Error: 0.00%(113/10000000000 **System Setup** - List the command line to start &quot;weed master&quot;, &quot;weed volume&quot;, &quot;weed filer&quot;, &quot;weed s3&quot;, &quot;weed mount&quot;. - OS version :centos7.2 - output of `weed version` version 2.21 - if using filer, show the content of `filer.toml` **Expected behavior** A clear and concise description of what you expected to happen. **Screenshots** If applicable, add screenshots to help explain your problem. **Additional context** E0203 09:26:53 59074 s3api_object_handlers.go:330] upload to filer error: rpc error: code = Unavailable desc = transport is closing E0203 09:26:53 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0203 09:26:53 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0203 09:26:53 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0203 09:26:53 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0203 09:26:53 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: -------------------------------------------------------- E0205 03:53:49 59074 s3api_object_handlers.go:330] upload to filer error: rpc error: code = Unavailable desc = transport is closing E0205 03:53:49 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0205 03:53:49 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0205 03:53:49 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0205 03:53:49 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0205 03:53:49 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: E0205 03:53:49 59074 s3api_object_handlers.go:330] upload to filer error: failed to parse master : server should have hostname:port format: ---------------------------------------------------------- 2021-02-07 01:40:32 071][INFO] Process: 33.44%(3343695440/10000000000), Ops: 6098/1s, Bandwidth: 22.09MB/1s(11.25TB), Error: 0.00%(113/10000000000) [2021-02-07 01:40:33 070][INFO] Process: 33.44%(3343701204/10000000000), Ops: 5764/1s, Bandwidth: 21.19MB/1s(11.25TB), Error: 0.00%(113/10000000000) [2021-02-07 01:40:34 070][INFO] Process: 33.44%(3343701323/10000000000), Ops: 119/1s, Bandwidth: 1.69MB/1s(11.25TB), Error: 0.00%(196/10000000000) [2021-02-07 01:40:35 070][INFO] Process: 33.44%(3343707441/10000000000), Ops: 6118/1s, Bandwidth: 22.61MB/1s(11.25TB), Error: 0.00%(200/10000000000) [2021-02-07 01:40:36 070][INFO] Process: 33.44%(3343713356/10000000000), Ops: 5915/1s, Bandwidth: 21.70MB/1s(11.25TB), Error: 0.00%(200/10000000000)</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>11</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #1785 from bingoohuang/master</MESSAGE>
    <SHA>928efc642cf33c5b41278449d85397f2662bfcfd</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>close the grpc connection after 10 hours related to https://github.com/chrislusf/seaweedfs/issues/1782</MESSAGE>
      <SHA>15c60cbb2660d60d2714d3386731044fcfeac473</SHA>
      <PATCHEDFILES>
        <FILE>weed/pb/grpc_client_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
