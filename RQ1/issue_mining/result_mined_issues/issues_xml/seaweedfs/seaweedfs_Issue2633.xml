<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2633</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2633</ISSUEURL>
  <TITLE>[volume_info] load volume 16.vif file: unmarshal error: unexpected EOF</TITLE>
  <DESCRIPTION>weed version ``` 2.87 ``` I got a lot of errors after restarting volumes logs ``` | Jan 29, 2022 @ 15:09:18.884 | W0129 10:09:17 1 volume_tier.go:31] load volume 286.vif file: unmarshal error: unexpected EOF | fast-volume-0 | Jan 29, 2022 @ 15:09:18.884 | W0129 10:09:17 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-0 | Jan 29, 2022 @ 20:03:42.946 | W0129 15:03:36 1 volume_tier.go:31] load volume 94.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.946 | W0129 15:03:36 1 volume_tier.go:31] load volume 255.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.946 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.946 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.946 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.946 | W0129 15:03:36 1 volume_tier.go:31] load volume 253.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_tier.go:31] load volume 173.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_tier.go:31] load volume 172.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_tier.go:31] load volume 227.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_tier.go:31] load volume 263.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.947 | W0129 15:03:36 1 volume_tier.go:31] load volume 185.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.948 | W0129 15:03:36 1 volume_tier.go:31] load volume 52.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.948 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.948 | W0129 15:03:36 1 volume_tier.go:31] load volume 248.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.948 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_tier.go:31] load volume 223.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_tier.go:31] load volume 237.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_tier.go:31] load volume 35.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_tier.go:31] load volume 36.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_tier.go:31] load volume 40.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.949 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_tier.go:31] load volume 97.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_tier.go:31] load volume 18.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_tier.go:31] load volume 71.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_tier.go:31] load volume 16.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_tier.go:31] load volume 133.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.950 | W0129 15:03:36 1 volume_tier.go:31] load volume 178.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.951 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.951 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.951 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.951 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.951 | W0129 15:03:36 1 volume_tier.go:31] load volume 109.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.951 | W0129 15:03:36 1 volume_tier.go:31] load volume 199.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.951 | W0129 15:03:36 1 volume_tier.go:31] load volume 200.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.951 | W0129 15:03:36 1 volume_tier.go:31] load volume 267.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.953 | W0129 15:03:36 1 volume_tier.go:31] load volume 141.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.953 | W0129 15:03:36 1 volume_tier.go:31] load volume 13.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.953 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.953 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.953 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.953 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.953 | W0129 15:03:36 1 volume_tier.go:31] load volume 14.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.953 | W0129 15:03:36 1 volume_tier.go:31] load volume 48.vif file: unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.954 | W0129 15:03:36 1 volume_info.go:48] unmarshal error: unexpected EOF | fast-volume-1 | Jan 29, 2022 @ 20:03:42.954 | W0129 15:03:36 1 volume_tier.go:31] load volume 163.vif file: unmarshal error: unexpected EOF | fast-volume-1 ``` ``` for f in $(ls *.vif); do fc=$(cat $f); if [[ &quot;${fc: -1}&quot; != &quot;}&quot; ]];then ls -lu $f;cat $f; echo;fi; done -rw-r--r-- 1 root 99 8 Feb 4 07:50 254.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 95.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 172.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 185.vif { &quot;fil -rw-rw-r-- 1 root 99 8 Feb 4 07:50 65.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 52.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 50.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 232.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 190.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 40.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 36.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 237.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 223.vif { &quot;fil -rw-rw-r-- 1 root 99 8 Feb 4 07:50 16.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 133.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 199.vif { &quot;fil -rw-rw-r-- 1 root 99 8 Feb 4 07:49 259.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 109.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 81.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 141.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 44.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 13.vif { &quot;fil -rw-r--r-- 1 root 99 8 Feb 4 07:50 274.vif { &quot;fil -rw-rw-r-- 1 root 99 8 Feb 4 07:49 163.vif { &quot;fil ``` It seems that somewhere there is not enough fsync for vif files</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>weed/s3api: rearrange s3 methods handlers to ensure correct methods requesting Otherwise current calls for some methods (i.e. GetObjectAcl) ends up with wrong method selection (i.e. GetObject). Added generic comment rule of traversing methods</MESSAGE>
    <SHA>78d300d9eee37100b27098848cc36e10d182eff1</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>sync call to write file, avoid vif loading error fix https://github.com/chrislusf/seaweedfs/issues/2633</MESSAGE>
      <SHA>ce969826bd2359f357e5aa40d0ce8ae64ab5359c</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/volume_info/volume_info.go</FILE>
        <FILE>weed/util/file_util.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix copying .vif file in VolumeCopy closes #4934 fixes #2633 might fix #3528</MESSAGE>
      <SHA>ef5503198a47f2ec7564da50aa76570048f0b6fa</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/volume_grpc_copy.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix copying .vif file in VolumeCopy (#4943) closes #4934 fixes #2633 might fix #3528</MESSAGE>
      <SHA>8b39bbbe2fa34704ad46cb717471220e8002c360</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/volume_grpc_copy.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix copying .vif file in VolumeCopy (#4943) closes #4934 fixes #2633 might fix #3528</MESSAGE>
      <SHA>9f8e1f44506a188998483a51bee002b5782318c1</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/volume_grpc_copy.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
