<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3404</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3404</ISSUEURL>
  <TITLE>[filler] prefers for upload and download volume servers url from his datacentre</TITLE>
  <DESCRIPTION>**Describe the bug** **System Setup** ``` 3.19 /usr/bin/weed -logtostderr=true -v=1 filer -port=9090 -dataCenter=predcix ``` **Additional context** ``` I0804 11:01:20.898073 filer_server_handlers_write_upload.go:192 doUpload fileId: 630,12846e28e51581 to urlLocation http://fast-volume-0.predc:8080/630,12846e28e51581?fsync=true I0804 11:02:44.408780 http_util.go:291 ReadUrlAsStream(): http://fast-volume-0.predc:8080/848,1275fba60c9ac6?readDeleted=true I0804 11:02:45.985648 http_util.go:291 ReadUrlAsStream(): http://fast-volume-1.predcix:8080/564,1266e0b73aa183?readDeleted=true ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>refactor FilerRequest metrics (#3402) * refactor FilerRequest metrics * avoid double count proxy * defer to</MESSAGE>
    <SHA>22181dd01895d5c993979678ae13c601548c20f8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>initial prefer same data center https://github.com/seaweedfs/seaweedfs/issues/3404</MESSAGE>
      <SHA>62d2556900c00fce4e98042224e1863b451218bf</SHA>
      <PATCHEDFILES>
        <FILE>weed/operation/assign_file_id.go</FILE>
        <FILE>weed/operation/lookup.go</FILE>
        <FILE>weed/pb/master.proto</FILE>
        <FILE>weed/pb/master_pb/master.pb.go</FILE>
        <FILE>weed/server/filer_server_handlers_write.go</FILE>
        <FILE>weed/server/master_grpc_server_volume.go</FILE>
        <FILE>weed/util/http_util.go</FILE>
        <FILE>weed/wdclient/masterclient.go</FILE>
        <FILE>weed/wdclient/vid_map.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>filer prefer volume server in same data center (#3405) * initial prefer same data center https://github.com/seaweedfs/seaweedfs/issues/3404 * GetDataCenter * prefer same data center for ReplicationSource * GetDataCenterId * remove glog</MESSAGE>
      <SHA>4d08393b7ca8b1a34ed65532955de76cf8843ec2</SHA>
      <PATCHEDFILES>
        <FILE>other/java/client/src/main/proto/filer.proto</FILE>
        <FILE>weed/command/filer.go</FILE>
        <FILE>weed/command/filer_meta_backup.go</FILE>
        <FILE>weed/command/filer_remote_gateway.go</FILE>
        <FILE>weed/command/filer_remote_sync.go</FILE>
        <FILE>weed/command/s3.go</FILE>
        <FILE>weed/command/server.go</FILE>
        <FILE>weed/filer/reader_at.go</FILE>
        <FILE>weed/mount/wfs_filer_client.go</FILE>
        <FILE>weed/mq/broker/broker_server.go</FILE>
        <FILE>weed/operation/assign_file_id.go</FILE>
        <FILE>weed/operation/lookup.go</FILE>
        <FILE>weed/pb/filer.proto</FILE>
        <FILE>weed/pb/filer_pb/filer.pb.go</FILE>
        <FILE>weed/pb/filer_pb/filer_client.go</FILE>
        <FILE>weed/pb/master.proto</FILE>
        <FILE>weed/pb/master_pb/master.pb.go</FILE>
        <FILE>weed/replication/sink/filersink/fetch_write.go</FILE>
        <FILE>weed/replication/sink/filersink/filer_sink.go</FILE>
        <FILE>weed/replication/source/filer_source.go</FILE>
        <FILE>weed/s3api/s3api_handlers.go</FILE>
        <FILE>weed/s3api/s3api_server.go</FILE>
        <FILE>weed/server/filer_grpc_server.go</FILE>
        <FILE>weed/server/filer_server_handlers_write.go</FILE>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
        <FILE>weed/server/master_grpc_server.go</FILE>
        <FILE>weed/server/master_grpc_server_volume.go</FILE>
        <FILE>weed/server/master_server_handlers.go</FILE>
        <FILE>weed/server/webdav_server.go</FILE>
        <FILE>weed/shell/commands.go</FILE>
        <FILE>weed/topology/data_node.go</FILE>
        <FILE>weed/topology/topology_info.go</FILE>
        <FILE>weed/topology/volume_growth.go</FILE>
        <FILE>weed/util/http_util.go</FILE>
        <FILE>weed/wdclient/masterclient.go</FILE>
        <FILE>weed/wdclient/vid_map.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>filer prefer volume server in same data center (#3405) * initial prefer same data center https://github.com/seaweedfs/seaweedfs/issues/3404 * GetDataCenter * prefer same data center for ReplicationSource * GetDataCenterId * remove glog</MESSAGE>
      <SHA>f9fbe1ce930652270b562dc9c9289635dba6f8aa</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer.go</FILE>
        <FILE>weed/command/filer_meta_backup.go</FILE>
        <FILE>weed/command/filer_remote_gateway.go</FILE>
        <FILE>weed/command/filer_remote_sync.go</FILE>
        <FILE>weed/command/s3.go</FILE>
        <FILE>weed/command/server.go</FILE>
        <FILE>weed/filer/reader_at.go</FILE>
        <FILE>weed/mount/wfs_filer_client.go</FILE>
        <FILE>weed/operation/assign_file_id.go</FILE>
        <FILE>weed/operation/lookup.go</FILE>
        <FILE>weed/pb/filer.proto</FILE>
        <FILE>weed/pb/filer_pb/filer.pb.go</FILE>
        <FILE>weed/pb/filer_pb/filer_client.go</FILE>
        <FILE>weed/pb/master.proto</FILE>
        <FILE>weed/pb/master_pb/master.pb.go</FILE>
        <FILE>weed/replication/sink/filersink/fetch_write.go</FILE>
        <FILE>weed/replication/sink/filersink/filer_sink.go</FILE>
        <FILE>weed/replication/source/filer_source.go</FILE>
        <FILE>weed/s3api/s3api_handlers.go</FILE>
        <FILE>weed/s3api/s3api_server.go</FILE>
        <FILE>weed/server/filer_grpc_server.go</FILE>
        <FILE>weed/server/filer_server_handlers_write.go</FILE>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
        <FILE>weed/server/master_grpc_server.go</FILE>
        <FILE>weed/server/master_grpc_server_volume.go</FILE>
        <FILE>weed/server/master_server_handlers.go</FILE>
        <FILE>weed/server/webdav_server.go</FILE>
        <FILE>weed/shell/commands.go</FILE>
        <FILE>weed/topology/data_node.go</FILE>
        <FILE>weed/topology/topology_info.go</FILE>
        <FILE>weed/topology/volume_growth.go</FILE>
        <FILE>weed/util/http_util.go</FILE>
        <FILE>weed/wdclient/masterclient.go</FILE>
        <FILE>weed/wdclient/vid_map.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>filer prefer volume server in same data center (#3405) * initial prefer same data center https://github.com/seaweedfs/seaweedfs/issues/3404 * GetDataCenter * prefer same data center for ReplicationSource * GetDataCenterId * remove glog</MESSAGE>
      <SHA>d4a101e7397ddb97389c07851aa5e955d2043600</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer.go</FILE>
        <FILE>weed/command/filer_meta_backup.go</FILE>
        <FILE>weed/command/filer_remote_gateway.go</FILE>
        <FILE>weed/command/filer_remote_sync.go</FILE>
        <FILE>weed/command/s3.go</FILE>
        <FILE>weed/command/server.go</FILE>
        <FILE>weed/filer/reader_at.go</FILE>
        <FILE>weed/mount/wfs_filer_client.go</FILE>
        <FILE>weed/operation/assign_file_id.go</FILE>
        <FILE>weed/operation/lookup.go</FILE>
        <FILE>weed/pb/filer.proto</FILE>
        <FILE>weed/pb/filer_pb/filer.pb.go</FILE>
        <FILE>weed/pb/filer_pb/filer_client.go</FILE>
        <FILE>weed/pb/master.proto</FILE>
        <FILE>weed/pb/master_pb/master.pb.go</FILE>
        <FILE>weed/replication/sink/filersink/fetch_write.go</FILE>
        <FILE>weed/replication/sink/filersink/filer_sink.go</FILE>
        <FILE>weed/replication/source/filer_source.go</FILE>
        <FILE>weed/s3api/s3api_handlers.go</FILE>
        <FILE>weed/s3api/s3api_server.go</FILE>
        <FILE>weed/server/filer_grpc_server.go</FILE>
        <FILE>weed/server/filer_server_handlers_write.go</FILE>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
        <FILE>weed/server/master_grpc_server.go</FILE>
        <FILE>weed/server/master_grpc_server_volume.go</FILE>
        <FILE>weed/server/master_server_handlers.go</FILE>
        <FILE>weed/server/webdav_server.go</FILE>
        <FILE>weed/shell/commands.go</FILE>
        <FILE>weed/topology/data_node.go</FILE>
        <FILE>weed/topology/topology_info.go</FILE>
        <FILE>weed/topology/volume_growth.go</FILE>
        <FILE>weed/util/http_util.go</FILE>
        <FILE>weed/wdclient/masterclient.go</FILE>
        <FILE>weed/wdclient/vid_map.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
