<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4530</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/4530</ISSUEURL>
  <TITLE>Failed to commit new volume file when running vacuum on Windows</TITLE>
  <DESCRIPTION>**Describe the bug** When the server is committing new volume file, the old one is still opening and can't be deleted, so the vacuum will fail. **System Setup** - Windows 11 - version 30GB 3.51 4310e1fac4e59a4391159e6c349f45a8e1cd0601 windows amd64 - Start with `weed server` - Upload a file and delete - Trigger the vacuum **Expected behavior** Vacuum completes with no errors. **Additional context** ``` I0603 03:12:21.420840 volume_vacuum.go:106 Committing volume 5 vacuuming... E0603 03:12:21.421865 volume_grpc_vacuum.go:87 failed commit volume 5: remove C:\Users\***\AppData\Local\Temp/5.dat: The process cannot access the file because it is being used by another process. ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>305</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>shell meta load add concurrency</MESSAGE>
    <SHA>6acd7d6759043746f04a7c4b542ddf24cd23b0aa</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>set df.File to nil after it is closed possibly fix https://github.com/seaweedfs/seaweedfs/issues/4530</MESSAGE>
      <SHA>f228f0c240de0c715e9c0432ca71e87331aaf4b8</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/backend/disk_file.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>set df.File to nil after it is closed possibly fix https://github.com/seaweedfs/seaweedfs/issues/4530</MESSAGE>
      <SHA>e23f3d6eca906208be36c15f867add71d487645f</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/backend/disk_file.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: always close volume file (#4530) If sync fails then close is never called. We should always be calling close on the file.</MESSAGE>
      <SHA>56be49fcfbcf81664efba4806699b19939f9c918</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/backend/disk_file.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: always close volume file (#4530) (#5459) If sync fails then close is never called. We should always be calling close on the file. Co-authored-by: Hendrik Appel &lt;happel@europe.altair.com&gt;</MESSAGE>
      <SHA>2a88da4de757630a7d35779867f24c66c71ae7a9</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/backend/disk_file.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
