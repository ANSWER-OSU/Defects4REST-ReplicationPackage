<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2325</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2325</ISSUEURL>
  <TITLE>large directory with uuid as filename, `CompactionTableSizeMultiplier: 10,` at `leveldb_store.go` make, leveldb.Get operation slow and high cpu usage.</TITLE>
  <DESCRIPTION>`weed mount`, single directory, millions of files with uuid as name. when copy files into this directory, `weed/filer/leveldb.(*LevelDBStore).FindEntry` cause leveldb slow at `github.com/syndtr/goleveldb/leveldb/table.(*Reader).find`. I have made a issue at upstream, with some codes simulate seaweedfs as benchmark. see https://github.com/syndtr/goleveldb/issues/370 . And finally, I found If I remove `CompactionTableSizeMultiplier: 10` from `leveldb_store.go`, It's as fast as flying. Then I build weed for test: - #2321 I mentiond, After add bloom filter, 3Mbps-&gt;30Mbps - After remove `CompactionTableSizeMultiplier: 10,`, copy 30Mbps -&gt; 60Mbps , and weed cpu rate: 100% -&gt; 90.7% I wonder why there is such config? If it is ok, I will make a pull request to increase efficiency for my use case. ============== bench codes ================ db dir: `/home/zbcuda9/seaweed_mount_point/cache_dir/leveldb` fs type : `sudo mount -t tmpfs tmpfs ./cache_dir/ -o size=6g` program to make db files before benchmark: `make_leveldb/main.go` ``` package main import ( &quot;fmt&quot; &quot;github.com/go-basic/uuid&quot; &quot;github.com/syndtr/goleveldb/leveldb&quot; leveldb_errors &quot;github.com/syndtr/goleveldb/leveldb/errors&quot; &quot;github.com/syndtr/goleveldb/leveldb/filter&quot; &quot;github.com/syndtr/goleveldb/leveldb/opt&quot; &quot;time&quot; ) func main() { opts := &amp;opt.Options{ BlockCacheCapacity: 32 * 1024 * 1024, // default value is 8MiB WriteBuffer: 16 * 1024 * 1024, // default value is 4MiB CompactionTableSizeMultiplier: 10, Compression: opt.NoCompression, Filter: filter.NewBloomFilter(8), // false positive rate 0.02 } dir:= &quot;/home/zbcuda9/seaweed_mount_point/cache_dir/leveldb&quot; var db *leveldb.DB var err error if db, err = leveldb.OpenFile(dir, opts); err != nil { if leveldb_errors.IsCorrupted(err) { db, err = leveldb.RecoverFile(dir, opts) } if err != nil { fmt.Printf(&quot;filer store open dir %s: %v&quot;, dir, err) return } } defer db.Close() // Add 10,000,000 files first fmt.Print(&quot;prepare leveldb data start.&quot;) for i := 0; i &lt;= 10; i++ { tb := time.Now() for j := 0; j&lt; 1000000; j++ { key := &quot;/what/ever/pre/files/dir/what/ever/pre/files/dir/what/ever/pre/files/dir/&quot; + uuid.New() + &quot;.jpg&quot; file_meta := &quot;what_ever_file_meta_data_what_ever_file_meta_data_what_ever_file_meta_data_what_ever_file_meta_data&quot; err := db.Put([]byte(key), []byte(file_meta), nil) if err != nil { fmt.Printf(&quot;Insert Failed!&quot;) return } } te := time.Now() ts := float32(te.UnixNano() - tb.UnixNano()) / 1000000000.0 fmt.Println(fmt.Sprintf(&quot;%d: cost %f, %f key per second!&quot;, i, ts, 1000000.0 / ts)) } fmt.Print(&quot;prepare leveldb data finish.&quot;) } ``` program to benchmark: `bench_leveldb/main.go` ``` package main import ( &quot;fmt&quot; &quot;github.com/go-basic/uuid&quot; &quot;github.com/syndtr/goleveldb/leveldb&quot; leveldb_errors &quot;github.com/syndtr/goleveldb/leveldb/errors&quot; &quot;github.com/syndtr/goleveldb/leveldb/filter&quot; &quot;github.com/syndtr/goleveldb/leveldb/opt&quot; &quot;time&quot; ) func main() { opts := &amp;opt.Options{ BlockCacheCapacity: 32 * 1024 * 1024, // default value is 8MiB WriteBuffer: 16 * 1024 * 1024, // default value is 4MiB CompactionTableSizeMultiplier: 10, Compression: opt.NoCompression, Filter: filter.NewBloomFilter(8), // false positive rate 0.02 } dir:= &quot;/home/zbcuda9/seaweed_mount_point/cache_dir/leveldb&quot; var db *leveldb.DB var err error if db, err = leveldb.OpenFile(dir, opts); err != nil { if leveldb_errors.IsCorrupted(err) { db, err = leveldb.RecoverFile(dir, opts) } if err != nil { fmt.Printf(&quot;filer store open dir %s: %v&quot;, dir, err) return } } defer db.Close() // Test Speed For 5000 files, 10 times // Follow Business Codes Work Slow! for i := 0; i &lt;= 10; i++ { tb := time.Now() for j := 0; j &lt;= 5000; j++ { key := &quot;/what/ever/pre/files/dir/what/ever/pre/files/dir/what/ever/pre/files/dir/&quot; + uuid.New() + &quot;.jpg&quot; file_meta := &quot;what_ever_file_meta_data_what_ever_file_meta_data_what_ever_file_meta_data_what_ever_file_meta_data&quot; // other module need check if meta exists! _, err := db.Get([]byte(key), nil) if err == nil { // call other module } // insert or update meta for file err = db.Put([]byte(key), []byte(file_meta), nil) if err != nil { fmt.Printf(&quot;Insert Failed!&quot;) return } } te := time.Now() ts := float32(te.UnixNano() - tb.UnixNano()) / 1000000000.0 fmt.Println(fmt.Sprintf(&quot;cost: %f, %f key per second!&quot;, ts, 5000.0 / ts)) } } ``` bench command: `perf record -g ./bench_leveldb` console outputs: ``` cost: 8.144604, 613.903381 key per second! cost: 8.771235, 570.045105 key per second! cost: 8.518530, 586.955750 key per second! cost: 8.361781, 597.958740 key per second! cost: 8.355777, 598.388428 key per second! cost: 8.296440, 602.668152 key per second! cost: 8.431696, 593.000488 key per second! cost: 8.482813, 589.427124 key per second! cost: 7.859915, 636.139160 key per second! cost: 10.497884, 476.286469 key per second! cost: 10.802630, 462.850220 key per second! ``` perf result: ``` - 99.85% 0.00% bench_leveldb bench_leveldb [.] runtime.goexit ▒ - runtime.goexit ▒ - 74.15% runtime.main ▒ - 74.14% main.main ▒ - 72.76% github.com/syndtr/goleveldb/leveldb.(*DB).Get ▒ - 72.70% github.com/syndtr/goleveldb/leveldb.(*DB).get ▒ - 72.27% github.com/syndtr/goleveldb/leveldb.(*version).get ▒ - 72.26% github.com/syndtr/goleveldb/leveldb.(*version).walkOverlapping ▒ - 72.15% github.com/syndtr/goleveldb/leveldb.(*version).get.func1 ▒ - 72.13% github.com/syndtr/goleveldb/leveldb.(*tOps).find ▒ - 72.02% github.com/syndtr/goleveldb/leveldb/table.(*Reader).find ▒ - 56.02% github.com/syndtr/goleveldb/leveldb/table.(*Reader).getIndexBlock ▒ - github.com/syndtr/goleveldb/leveldb/table.(*Reader).readBlockCached ▒ - 56.01% github.com/syndtr/goleveldb/leveldb/cache.(*Cache).Get ▒ - 55.82% github.com/syndtr/goleveldb/leveldb/table.(*Reader).readBlockCached.func1 ▒ - 55.82% github.com/syndtr/goleveldb/leveldb/table.(*Reader).readBlock ▒ - 55.75% github.com/syndtr/goleveldb/leveldb/table.(*Reader).readRawBlock ▒ + 30.04% hash/crc32.Update ▒ + 25.61% github.com/syndtr/goleveldb/leveldb/util.(*BufferPool).Get ▒ + 15.49% github.com/syndtr/goleveldb/leveldb/table.(*Reader).getFilterBlock ▒ + 0.73% github.com/syndtr/goleveldb/leveldb.(*DB).putRec ▒ + 22.44% github.com/syndtr/goleveldb/leveldb.(*DB).tCompaction ▒ + 1.74% runtime.systemstack ▒ + 0.66% runtime.bgscavenge ▒ ``` ================ after remove `CompactionTableSizeMultiplier: 10,` output : ``` cost: 0.300306, 16649.691406 key per second! cost: 0.186012, 26879.968750 key per second! cost: 0.184360, 27120.880859 key per second! cost: 0.187674, 26642.000000 key per second! cost: 0.187991, 26596.996094 key per second! cost: 0.187910, 26608.505859 key per second! cost: 0.180480, 27703.882812 key per second! cost: 0.179909, 27791.902344 key per second! cost: 0.186478, 26812.777344 key per second! cost: 0.179908, 27792.000000 key per second! cost: 0.179869, 27797.998047 key per second! ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>remember commands even if failed</MESSAGE>
    <SHA>0b4269b6a86b882247f7a3ca5c7339fcb4397e43</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>CompactionTableSizeMultiplier of leveldb use default value. #2325 To improve performance of leveldb find key in condition of large directory(millions of files) which use uuid as filename.</MESSAGE>
      <SHA>951983c5a0e07d2b107410ad2bba253c14bdc3c6</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/leveldb/leveldb_store.go</FILE>
        <FILE>weed/filer/leveldb2/leveldb2_store.go</FILE>
        <FILE>weed/filer/leveldb3/leveldb3_store.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>CompactionTableSizeMultiplier of leveldb use default value. #2325 To improve performance of leveldb find key in condition of large directory(millions of files) which use uuid as filename.</MESSAGE>
      <SHA>5654d0d60d2bfffcc428fd50461abc965a8a4400</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/leveldb/leveldb_store.go</FILE>
        <FILE>weed/filer/leveldb2/leveldb2_store.go</FILE>
        <FILE>weed/filer/leveldb3/leveldb3_store.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
