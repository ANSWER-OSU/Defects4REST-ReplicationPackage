<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6262</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/6262</ISSUEURL>
  <TITLE>Multipart upload without S3 authentication fails with the wrong message</TITLE>
  <DESCRIPTION>**Describe the bug** If S3 authentication is not setup, attempting to upload multipart will fail with the error message: ```Expected hash not equal to calculated hash``` While trying to make a minimal reproduction of this behavior to report the bug, I noticed that when using the amazon SDK `TransferUtility`, I get a different error message: ```Signed request requires setting up SeaweedFS S3 authentication``` This led me to find the otherwise completely opaque issue at hand. **System Setup** `podman run --name seaweed-12312 --rm -p 12312:12312 docker.io/chrislusf/seaweedfs server -s3 -s3.port 12312` To run seaweed. Then in C#: ```cs var s3Client = new AmazonS3Client( new AmazonS3Config { ServiceURL = &quot;http://localhost:12312&quot;, ForcePathStyle = true, } ); var bucketName = &quot;my-test-bucket&quot;; var keyName = &quot;dir/file.txt&quot;; var fakeFileData = new StringBuilder(); fakeFileData.AppendLine(&quot;a,b,c,d,e&quot;); for (var i = 0; i &lt; 10000; i++) { fakeFileData.AppendLine($&quot;a{i},b{i},c{i},d{i},e{i}&quot;); } var cancellationToken = CancellationToken.None; var initiateRequest = new InitiateMultipartUploadRequest { BucketName = bucketName, Key = keyName, }; var initiateResponse = await s3Client.InitiateMultipartUploadAsync(initiateRequest, cancellationToken); var partETags = new List&lt;PartETag&gt;(); using (var fakeFileStream = new MemoryStream(Encoding.UTF8.GetBytes(fakeFileData.ToString()))) { var uploadRequest = new UploadPartRequest { BucketName = bucketName, Key = keyName, UploadId = initiateResponse.UploadId, PartNumber = 1, PartSize = fakeFileStream.Length, InputStream = fakeFileStream }; var uploadResponse = await s3Client.UploadPartAsync(uploadRequest, cancellationToken); partETags.Add(new PartETag(uploadResponse.PartNumber, uploadResponse.ETag)); } var completeRequest = new CompleteMultipartUploadRequest { BucketName = bucketName, Key = keyName, UploadId = initiateResponse.UploadId, PartETags = partETags }; await s3Client.CompleteMultipartUploadAsync(completeRequest, cancellationToken); ``` The above fails with `Expected hash not equal to calculated hash`. However, running the code below: ```cs var s3Client = new AmazonS3Client( new AmazonS3Config { ServiceURL = &quot;http://localhost:12312&quot;, ForcePathStyle = true, } ); var bucketName = &quot;my-test-bucket&quot;; var keyName = &quot;dir/file.txt&quot;; var fakeFileData = new StringBuilder(); fakeFileData.AppendLine(&quot;a,b,c,d,e&quot;); for (var i = 0; i &lt; 10000; i++) { fakeFileData.AppendLine($&quot;a{i},b{i},c{i},d{i},e{i}&quot;); } var fileTransferUtility = new TransferUtility(s3Client); using (var fakeFileStream = new MemoryStream(Encoding.UTF8.GetBytes(fakeFileData.ToString()))) { var fileTransferUtilityRequest = new TransferUtilityUploadRequest { BucketName = bucketName, InputStream = fakeFileStream, PartSize = 6*1024*1024, // 6 MB. Key = keyName, // DisablePayloadSigning = true, }; await fileTransferUtility.UploadAsync(fileTransferUtilityRequest); } ``` This fails with the much more useful `Signed request requires setting up SeaweedFS S3 authentication`. It's important to note, that if I setup seaweed using: `podman run --name seaweed-12312 -v /home/$USER/s3_config.json:/app/:Z --rm -p 12312:12312 docker.io/chrislusf/seaweedfs server -s3 -s3.port 12312 -s3.config &quot;/app/s3_config.json&quot;` While filling `~/s3_config.json` with: ``` { &quot;identities&quot;: [ { &quot;name&quot;: &quot;me&quot;, &quot;credentials&quot;: [ { &quot;accessKey&quot;: &quot;seaweed&quot;, &quot;secretKey&quot;: &quot;seaweed&quot; } ], &quot;actions&quot;: [ &quot;Read&quot;, &quot;Write&quot;, &quot;List&quot;, &quot;Tagging&quot;, &quot;Admin&quot; ] } ] } ``` And then setting up the client accordingly: ```cs var s3Client = new AmazonS3Client( new BasicAWSCredentials(&quot;seaweed&quot;, &quot;seaweed&quot;), new AmazonS3Config { ServiceURL = &quot;http://localhost:12312&quot;, ForcePathStyle = true, } ); ``` Both examples work. **Expected behavior** I'd like for the simple case to fail with an informative error message, instead of giving a hash equality message which implies some usage bug. I'm glad I could find the issue eventually, but I could've saved a lot of time with the right error message!</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[shell] add noLock param for volume.move (#6261)</MESSAGE>
    <SHA>254ed8897e17b359cbdfb8e5da2922e35c4e0f2d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>consistent error message if auth is not setup fix https://github.com/seaweedfs/seaweedfs/issues/6262</MESSAGE>
      <SHA>6b2612690bb3e80d767029b9f6a8ab9b34977811</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/s3api_object_handlers_multipart.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
