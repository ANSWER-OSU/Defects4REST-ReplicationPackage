<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2802</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2802</ISSUEURL>
  <TITLE>[bug:volume] SendHeartbeat to sw-master-direct.query.consul:9333: rpc error: code = Unavailable desc = connection closed (Critical)</TITLE>
  <DESCRIPTION>At the time of the update by the master server from 2.88 to 2.90 with a restart after the change of leader, all volumes of the server stopped sending heartbeats restarts or rollback statefulsets sw-master did not help After restarting all volume servers, sending heartbeats started working ``` volume_grpc_client_to_master.go:129] Volume Server found a new master newLeader: master-0.sw-master-direct.service.consul:9333 instead of sw-master-direct.query.consul volume_grpc_client_to_master.go:107] Heartbeat to: master-0.sw-master-direct.service.consul:9333 ``` weed version ``` 2.88 ``` weed volume cmd with TLS grpc ``` weed -logtostderr=true -v=1 volume -port=8080 -dir=/data -max=900 -rack=node14 -dataCenter=dcix -ip.bind=0.0.0.0 -preStopSeconds=15 -index=memory -minFreeSpacePercent=11 -compactionMBps=2000 -concurrentDownloadLimitMB=2048 -concurrentUploadLimitMB=2048 -metricsPort=9327 -ip=sw-volume-15.service.consul -mserver=sw-master-direct.query.consul ``` nslookup sw-master-direct.query.consul ``` Name: sw-master-direct.query.consul Address: 10.103.3.14 Name: sw-master-direct.query.consul Address: 10.103.5.212 Name: sw-master-direct.query.consul Address: 10.103.3.245 ``` env: ``` WEED_GRPC_ALLOWED_WILDCARD_DOMAIN=.s3.stage ``` tls files secret sw-cert ``` kind: Secret metadata: annotations: cert-manager.io/certificate-name: sw-cert cert-manager.io/common-name: sw-master.s3.stage cert-manager.io/ip-sans: &quot;&quot; cert-manager.io/issuer-group: &quot;&quot; cert-manager.io/issuer-kind: ClusterIssuer cert-manager.io/issuer-name: vault-issuer cert-manager.io/uri-sans: &quot;&quot; creationTimestamp: &quot;2020-12-18T21:16:57Z&quot; name: sw-cert namespace: s3 resourceVersion: &quot;876598070&quot; uid: 7274a063-7c73-431c-a22e-e1bbc481229f type: kubernetes.io/tls ``` security.toml: ``` # this file is read by master, volume server, and filer # the jwt signing key is read by master and volume server # a jwt expires in 10 seconds [jwt.signing] # key = &quot;&quot; expires_after_seconds = 10 # seconds [jwt.signing.read] key = &quot;&quot; expires_after_seconds = 10 # seconds # all grpc tls authentications are mutual # the values for the following ca, cert, and key are paths to the PERM files. [grpc] ca = &quot;/usr/local/share/ca-certificates/ca.crt&quot; [grpc.volume] cert = &quot;/usr/local/share/ca-certificates/tls.crt&quot; key = &quot;/usr/local/share/ca-certificates/tls.key&quot; ca = &quot;/usr/local/share/ca-certificates/ca.crt&quot; [grpc.master] cert = &quot;/usr/local/share/ca-certificates/tls.crt&quot; key = &quot;/usr/local/share/ca-certificates/tls.key&quot; ca = &quot;/usr/local/share/ca-certificates/ca.crt&quot; [grpc.filer] cert = &quot;/usr/local/share/ca-certificates/tls.crt&quot; key = &quot;/usr/local/share/ca-certificates/tls.key&quot; ca = &quot;/usr/local/share/ca-certificates/ca.crt&quot; [grpc.msg_broker] cert = &quot;/usr/local/share/ca-certificates/tls.crt&quot; key = &quot;/usr/local/share/ca-certificates/tls.key&quot; ca = &quot;/usr/local/share/ca-certificates/ca.crt&quot; # use this for any place needs a grpc client # i.e., &quot;weed backup|benchmark|filer.copy|filer.replicate|mount|s3|upload&quot; [grpc.client] cert = &quot;/usr/local/share/ca-certificates/tls.crt&quot; key = &quot;/usr/local/share/ca-certificates/tls.key&quot; ca = &quot;/usr/local/share/ca-certificates/ca.crt&quot; # volume server https options # Note: work in progress! # this does not work with other clients, e.g., &quot;weed filer|mount&quot; etc, yet. [https.client] enabled = false [https.volume] cert = &quot;&quot; ``` volume logs ``` Mar 22, 2022 @ 02:07:34.979 | I0321 21:07:34 1 volume_grpc_client_to_master.go:104] SendHeartbeat to sw-master-direct.query.consul: rpc error: code = Unavailable desc = connection closed Mar 22, 2022 @ 02:07:29.978 | I0321 21:07:29 1 volume_grpc_client_to_master.go:104] SendHeartbeat to sw-master-direct.query.consul: rpc error: code = Unavailable desc = connection closed Mar 22, 2022 @ 02:07:29.978 | I0321 21:07:29 1 volume_grpc_client_to_master.go:69] heartbeat error: rpc error: code = Unavailable desc = connection closed Mar 22, 2022 @ 02:07:24.978 | I0321 21:07:24 1 volume_grpc_client_to_master.go:69] heartbeat error: rpc error: code = Unavailable desc = connection closed Mar 22, 2022 @ 02:07:24.978 | I0321 21:07:24 1 volume_grpc_client_to_master.go:104] SendHeartbeat to sw-master-direct.query.consul: rpc error: code = Unavailable desc = connection closed Mar 22, 2022 @ 02:07:19.978 | I0321 21:07:19 1 volume_grpc_client_to_master.go:104] SendHeartbeat to sw-master-direct.query.consul: rpc error: code = Unavailable desc = connection closed Mar 22, 2022 @ 02:07:19.978 | I0321 21:07:19 1 volume_grpc_client_to_master.go:69] heartbeat error: rpc error: code = Unavailable desc = connection closed Mar 22, 2022 @ 02:07:14.978 | I0321 21:07:14 1 volume_grpc_client_to_master.go:69] heartbeat error: rpc error: code = Unavailable desc = connection closed ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>88</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix collectionIsMismatch charset</MESSAGE>
    <SHA>44f53ceda6ba9add568e9a8c4e69561bc8b9654a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>log grpc conn state https://github.com/chrislusf/seaweedfs/issues/2802</MESSAGE>
      <SHA>3b35eec17b067b01785cbfac2d0c6f8e682d0bc5</SHA>
      <PATCHEDFILES>
        <FILE>weed/pb/grpc_client_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>force close gRPC client closed connections https://github.com/chrislusf/seaweedfs/issues/2802</MESSAGE>
      <SHA>7c68bcec820a12137246cb90b287d1ecc778e71b</SHA>
      <PATCHEDFILES>
        <FILE>weed/pb/grpc_client_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Revert &quot;remove max connection age&quot; This reverts commit b9b684194f8269325ec9c1666c7202a6f4dabe15.</MESSAGE>
      <SHA>41dfe27102b16ae1fd9cc6f17243d2599295f297</SHA>
      <PATCHEDFILES>
        <FILE>weed/pb/grpc_client_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
