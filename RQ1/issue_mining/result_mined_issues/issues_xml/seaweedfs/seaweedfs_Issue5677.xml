<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5677</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/5677</ISSUEURL>
  <TITLE>file.remote.sync doesn't push objects after network issue</TITLE>
  <DESCRIPTION>Hi there, I'm testing seaweedfs 3.67 on a cloud drive with cache configuration. I simulated a network issue (iptables -A OUTPUT -p tcp --dport 443 -m statistic --mode random --probability 1 -j DROP) to check the sync back to S3. After removing the iptables rule, I noticed that when restarting the filer.remote.sync run by ./weed filer.remote.sync -dir=/buckets/bm-factorfx generates an error in the weed server log : ``` I0617 12:28:01.273906 filer_grpc_server_sub_meta.go:299 + listener filer.remote.sync@127.0.0.1:56244 clientId 1966601686 clientEpoch 1 I0617 12:28:01.273936 filer_grpc_server_sub_meta.go:37 filer.remote.sync@127.0.0.1:56244 starts to subscribe /buckets/bm-factorfx from 2024-06-17 12:19:59.459700712 +0000 UTC I0617 12:28:02.295922 filer_grpc_server_sub_meta.go:271 =&gt; client filer.remote.sync@127.0.0.1:33928: rpc error: code = Unavailable desc = transport is closing E0617 12:28:02.296089 log_read.go:122 LoopProcessLogData: aggMeta:filer.remote.sync@127.0.0.1:33928 process log entry 1 ts_ns:1718627282295650113 partition_key_hash:371534054 data:&quot;\n\x14/buckets/bm-factorfx\x12\xc2\x03\n\xd8\x01\n(c16f76b595c41c6135ad1ddd8c8efe669e63671f\x1aF\n\x108,1cfd83b53631b2\x18\x8f\&quot; \x89\x92\xf2\xec\x17*\x18f++v6teE2RGu0ueBoJGZ7w==:\x0b\x08\x08\x10\x83\xfbs\x1d\xb216\xb5\&quot;$\x08\x8f\&quot;\x10\xf0\xd3\xc0\xb3\x06\x18\xb0\x030\xf0\xd3\xc0\xb3\x06r\x10\x7f\xef\xaf\xeaׄ\xd9\x11\xae\xd2灠\x91\x99\xefR&gt;\n\x05s3ovh\x10\xf9Քф\xc4\xf2\xec\x17\x1a\&quot;\&quot;7fefafead784d911aed2e781a09199ef\&quot; \x9c\xd5\xc0\xb3\x06(\x8f\&quot;\x12\xc6\x01\n(c16f76b595c41c6135ad1ddd8c8efe669e63671f\x1a4\x18\x8f\&quot; \x89\x92\xf2\xec\x17*\x18f++v6teE2RGu0ueBoJGZ7w==:\x0b\x08\x08\x10\x83\xfbs\x1d\xb216\xb5\&quot;$\x08\x8f\&quot;\x10\xf0\xd3\xc0\xb3\x06\x18\xb0\x030\xf0\xd3\xc0\xb3\x06r\x10\x7f\xef\xaf\xeaׄ\xd9\x11\xae\xd2灠\x91\x99\xefR&gt;\n\x05s3ovh\x10\x80\xb0\xfb\xb3\x85\xcd\xf2\xec\x17\x1a\&quot;\&quot;7fefafead784d911aed2e781a09199ef\&quot; \xd2\xd7\xc0\xb3\x06(\x8f\&quot;\x18\x01\&quot;\x14/buckets/bm-factorfx2\x04\xb9\xc2\xd8.\x18\xc1\x85\xcd\xf2\xec\x17&quot; key:&quot;/buckets/bm-factorfx&quot;: rpc error: code = Unavailable desc = transport is closing E0617 12:28:02.296204 filer_grpc_server_sub_meta.go:79 processed to 2024-06-17 12:28:02.295650113 +0000 UTC: rpc error: code = Unavailable desc = transport is closing ``` The new writes to the remote S3 were still working. So it looks like all the writings that happened during the network issue where only in seaweed. I managed to get the sync process to put the missing object by adding '-timeAgo 1h' . The issue looks a bit like : https://github.com/seaweedfs/seaweedfs/commit/3d3fa43542dabab77a2c1ade868fcd8dc0e68cd9, maybe the same ? In the filer.remote.sync process, I can see that the last sync timestamp was moving du to the sync of the new objects : I can reproduce the scenario if you need more logs. Thanks a lot,</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>chore(deps): bump github.com/aws/aws-sdk-go from 1.53.5 to 1.54.2 (#5685)</MESSAGE>
    <SHA>e9cee59c8c1e9efabb114911d1f37bad12c57be9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>adjust error handling fix https://github.com/seaweedfs/seaweedfs/issues/5677</MESSAGE>
      <SHA>a829f36d17cedfe12a1c4a58e58ee464a958cd4e</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer_backup.go</FILE>
        <FILE>weed/command/filer_meta_backup.go</FILE>
        <FILE>weed/command/filer_remote_gateway_buckets.go</FILE>
        <FILE>weed/command/filer_remote_sync_dir.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
