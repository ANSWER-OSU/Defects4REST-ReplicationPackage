<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>629</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/629</ISSUEURL>
  <TITLE>Raft master election issues when failover occurs</TITLE>
  <DESCRIPTION>There seems to be two or possibly more things wrong the the raft implementation: - if a elected master gets isolated it will remain leader after it gets reconnected to the network, resulting in inability to assign uploads to volumes until a new election takes place. - if a non-elected isolated master get reconnected to the network, it will imidiately become elected master, resulting in the former master “loosing connection” to the volumes. Details --- We are currently testing with a three master setup, running each master like this: ``` weed master -ip 10.1.1.103 -port=9333 -mdir=./master -peers=10.1.1.103:9333,10.1.1.105:9333,10.1.1.105:9334 ``` The inital cluster gets booted, with the first master to start becoming leader. Then we tried to drop all traffic in and out of the first master, which is currently the leader. This results in the isolated master remaining leader: ``` $ curl localhost:9333/cluster/status {&quot;IsLeader&quot;:true,&quot;Leader&quot;:&quot;10.1.1.103:9333&quot;,&quot;Peers&quot;:[&quot;10.1.1.105:9333&quot;,&quot;10.1.1.105:9334&quot;]} ``` And the two other masters electing a new leader: ``` master_server.go:91] [ 10.1.1.105:9334 ] 10.1.1.105:9334 becomes leader. ``` (Btw, this message only gets logged on the elected leader, even with `v=3`) ``` $ curl localhost:9334/cluster/status {&quot;IsLeader&quot;:true,&quot;Leader&quot;:&quot;10.1.1.105:9334&quot;,&quot;Peers&quot;:[&quot;10.1.1.103:9333&quot;,&quot;10.1.1.105:9333&quot;]} ``` After opening up all traffic again, both leaders remain leaders until next election. Doing `weed upload` at this moment result in these messages: ``` [{&quot;fileName&quot;:&quot;file.tar.gz&quot;,&quot;error&quot;:&quot;/dir/assign result JSON unmarshal error:unexpected end of JSON input, json:&quot;}] [{&quot;fileName&quot;:&quot;file.tar.gz&quot;,&quot;error&quot;:&quot;http://weed-002.site-001.jotta.no:9334/dir/assign : 404 Not Found&quot;}] ``` After a while, 10-20 seconds, all masters again agree and all continues to work. --- If we then try to isolate a master which is not the current leader, nothing happens. But when we introduce it to the network again, that master immediately becomes leader: ``` master_server.go:91] [ 10.1.1.103:9333 ] 10.1.1.103:9333 becomes leader. node.go:223] topo:DefaultDataCenter:test-105 adds child 10.1.1.105:8080 master_grpc_server.go:36] added volume server 10.1.1.105:8080 ``` The “former” master logging lost volumes resulting in `{&quot;error&quot;:&quot;No free volumes left!&quot;}` error messages: ``` master_grpc_server.go:63] lost volume server 10.1.1.105:8080 topology_event_handling.go:52] Removing Volume 54 from the dead volume server 10.1.1.105:8080 volume_layout.go:227] Volume 54 has 1 replica, less than required 2 volume_layout.go:203] Volume 54 becomes unwritable ``` edit: some typos/clarifications</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>124</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix compilation for go tip</MESSAGE>
    <SHA>69b4f9383086f71a04a28d358d1ccca1cc149ff2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>simplifying the leader election by raft fixing https://github.com/chrislusf/seaweedfs/issues/629</MESSAGE>
      <SHA>03f50180f3f6bfca5ae61fab0fa1c3b1db939e05</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/master_server.go</FILE>
        <FILE>weed/server/raft_server.go</FILE>
        <FILE>weed/server/raft_server_handlers.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>simplifying the leader election by raft fixing https://github.com/chrislusf/seaweedfs/issues/629</MESSAGE>
      <SHA>80bcf75579f86201fd204411d3adb665c9829ec4</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/master_server.go</FILE>
        <FILE>weed/server/raft_server.go</FILE>
        <FILE>weed/server/raft_server_handlers.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
