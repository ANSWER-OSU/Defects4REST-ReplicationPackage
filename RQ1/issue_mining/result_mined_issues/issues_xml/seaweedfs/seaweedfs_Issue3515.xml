<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3515</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3515</ISSUEURL>
  <TITLE>[volume] DATA RACE on Created Volume id</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` volume_1 | I0825 10:41:53.044853 store.go:143 In dir /data adds volume:74 collection:yournamehere-ndnlnnt6gnh6x06j-123 replicaPlacement:000 ttl: volume_1 | I0825 10:41:53.045166 volume_loading.go:140 loading memory index /data/yournamehere-ndnlnnt6gnh6x06j-123_74.idx to memory volume_1 | I0825 10:41:53.048117 store.go:147 add volume 74 volume_1 | I0825 10:41:53.048595 volume_grpc_client_to_master.go:172 volume server volume:8080 adds volume 74 master_1 | I0825 10:41:53.049780 volume_layout.go:391 Volume 74 becomes writable master_1 | I0825 10:41:53.050830 volume_growth.go:245 Created Volume 74 on topo:DefaultDataCenter:DefaultRack:volume:8080 volume_1 | ================== volume_1 | WARNING: DATA RACE volume_1 | Write at 0x00c000890e58 by goroutine 172: volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Volume).Version() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/volume.go:101 +0x14a volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Volume).syncWrite() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/volume_write.go:96 +0x69 volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Volume).writeNeedle2() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/volume_write.go:117 +0x5a4 volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Store).WriteVolumeNeedle() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/store.go:363 +0xd5 volume_1 | github.com/seaweedfs/seaweedfs/weed/topology.ReplicatedWrite() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/topology/store_replicate.go:48 +0x272 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).PostHandler() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_server_handlers_write.go:48 +0x544 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).PostHandler-fm() volume_1 | &lt;autogenerated&gt;:1 +0x57 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).privateStoreHandler() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_server_handlers.go:97 +0x14c7 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).privateStoreHandler-fm() volume_1 | &lt;autogenerated&gt;:1 +0x57 volume_1 | net/http.HandlerFunc.ServeHTTP() volume_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d volume_1 | net/http.(*ServeMux).ServeHTTP() volume_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 volume_1 | net/http.serverHandler.ServeHTTP() volume_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 volume_1 | net/http.(*conn).serve() volume_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 volume_1 | net/http.(*Server).Serve.func3() volume_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 volume_1 | volume_1 | Previous write at 0x00c000890e58 by goroutine 3584: volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Volume).Version() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/volume.go:101 +0x5aa volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Volume).doWriteRequest() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/volume_write.go:161 +0x5cc volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Volume).syncWrite() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/volume_write.go:106 +0x34c volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Volume).writeNeedle2() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/volume_write.go:117 +0x5a4 volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Store).WriteVolumeNeedle() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/store.go:363 +0xd5 volume_1 | github.com/seaweedfs/seaweedfs/weed/topology.ReplicatedWrite() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/topology/store_replicate.go:48 +0x272 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).PostHandler() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_server_handlers_write.go:48 +0x544 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).PostHandler-fm() volume_1 | &lt;autogenerated&gt;:1 +0x57 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).privateStoreHandler() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_server_handlers.go:97 +0x14c7 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).privateStoreHandler-fm() volume_1 | &lt;autogenerated&gt;:1 +0x57 volume_1 | net/http.HandlerFunc.ServeHTTP() volume_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d volume_1 | net/http.(*ServeMux).ServeHTTP() volume_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 volume_1 | net/http.serverHandler.ServeHTTP() volume_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 volume_1 | net/http.(*conn).serve() volume_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 volume_1 | net/http.(*Server).Serve.func3() volume_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 volume_1 | volume_1 | Goroutine 172 (running) created at: volume_1 | net/http.(*Server).Serve() volume_1 | /usr/local/go/src/net/http/server.go:3102 +0x837 volume_1 | github.com/seaweedfs/seaweedfs/weed/util/httpdown.(*server).serve() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/util/httpdown/http_down.go:293 +0x217 volume_1 | github.com/seaweedfs/seaweedfs/weed/util/httpdown.HTTP.Serve.func2() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/util/httpdown/http_down.go:110 +0x39 volume_1 | volume_1 | Goroutine 3584 (running) created at: volume_1 | net/http.(*Server).Serve() volume_1 | /usr/local/go/src/net/http/server.go:3102 +0x837 volume_1 | github.com/seaweedfs/seaweedfs/weed/util/httpdown.(*server).serve() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/util/httpdown/http_down.go:293 +0x217 volume_1 | github.com/seaweedfs/seaweedfs/weed/util/httpdown.HTTP.Serve.func2() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/util/httpdown/http_down.go:110 +0x39 volume_1 | ================== ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>192</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>3.24</MESSAGE>
    <SHA>b7a887fea16ecef7832a60818bf9b30e6600a258</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid race conditions access to SuperBlock.Version https://github.com/seaweedfs/seaweedfs/issues/3515</MESSAGE>
      <SHA>f4f227650a686928fdfb8894a16f36aefd9f6a4e</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/volume.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>avoid race conditions access to SuperBlock.Version (#3539) * avoid race conditions access to SuperBlock.Version https://github.com/seaweedfs/seaweedfs/issues/3515 * superBlockAccessLock replace to sync.Mutex</MESSAGE>
      <SHA>ade94b0d0a71db7db117454c075dc93f839e1c9c</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/volume.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
