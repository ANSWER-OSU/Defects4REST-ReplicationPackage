<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>913</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/913</ISSUEURL>
  <TITLE>allocating all available volumes fails</TITLE>
  <DESCRIPTION>Sponsors SeaweedFS via Patreon https://www.patreon.com/seaweedfs **Describe the bug** I tried to allocate all available volumes (which was 6,400 volumes) and it allocated all but 42 of the volumes and then threw an error (then I was able to allocate the last 42 volumes successfully) ``` $ curl &quot;http://seaweed-master:9333/vol/grow?collection=test&amp;count=6400&quot; {&quot;error&quot;:&quot;Failed to assign 6625: rpc error: code = Unknown desc = No more free space left&quot;} $ curl &quot;http://seaweed-master:9333/vol/grow?collection=test&amp;count=6400&quot; {&quot;error&quot;:&quot;Only 42 volumes left! Not enough for 6400&quot;} $ curl &quot;http://seaweed-master:9333/vol/grow?collection=test&amp;count=42&quot; {&quot;count&quot;:42} ``` (sorry, didn't get screen shots) after deleting all volumes and running again, I got got a different error and strangely I see 6,400 volumes allocated but it says 397 volumes free (which should be 0 volumes free) ``` $ curl &quot;http://seaweed-master:9333/vol/grow?collection=test&amp;count=6400&quot; {&quot;error&quot;:&quot;Failed to assign 6669: rpc error: code = Unavailable desc = all SubConns are in TransientFailure, latest connection error: connection error: desc = \&quot;transport: Error while dialing dial tcp 192.168.X.XXX:18080: connect: connection refused\&quot;&quot;} ``` and strangely it say 397 volumes are free ![image](https://user-images.githubusercontent.com/4112046/55459751-1b730b80-55a5-11e9-9bd8-7121623f067b.png) even though the volume servers show a total of 6400 volumes ![image](https://user-images.githubusercontent.com/4112046/55459802-3c3b6100-55a5-11e9-9249-359442fc9d19.png) **System Setup** `master` `filer` and `s3` on one machine and `volume` on 4 separate machines **Expected behavior** allocating all available volumes should succeed and counts should make sense **Screenshots** n/a **Additional context** n/a</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>32</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>weed shell: add fs.cd, fs.pwd to change to a directory and print current directory</MESSAGE>
    <SHA>715a38da1e4fce05631f230ccf09ce92c99a4fd4</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>weed master: atomic volume counting possible fix for https://github.com/chrislusf/seaweedfs/issues/913</MESSAGE>
      <SHA>766396d249652c1b29771fa1fce65250f9707d1d</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/master_grpc_server.go</FILE>
        <FILE>weed/server/master_server_handlers_admin.go</FILE>
        <FILE>weed/topology/node.go</FILE>
        <FILE>weed/topology/rack.go</FILE>
        <FILE>weed/topology/volume_growth.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
