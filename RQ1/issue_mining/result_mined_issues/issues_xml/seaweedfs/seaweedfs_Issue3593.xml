<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3593</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3593</ISSUEURL>
  <TITLE>[master] data race on AvailableSpaceFor</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot;Write at 0x00c000730930 by goroutine 4862045:&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).UpAdjustDiskUsageDelta()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc.(*Server).handleStream()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/pb/master_pb._Seaweed_Assign_Handler()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; sync/atomic.AddInt64()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:193 +0x118&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).UpAdjustDiskUsageDelta()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:1640 +0xfae&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /usr/local/go/src/runtime/race_amd64.s:289 +0xb&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/topology.(*Rack).GetOrCreateDataNode()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:142 +0xc4&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc/internal/transport.(*http2Server).operateHeaders()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; sync/atomic.AddInt64()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:1295 +0x11c9&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/server.(*MasterServer).SendHeartbeat()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot;-&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc.(*Server).handleStream()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:196 +0x187&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/server/master_grpc_server.go:113 +0x530&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:1636 +0xff8&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:214 +0xa8&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/pb/master_pb/master_grpc.pb.go:426 +0x25a&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:930 +0x4dd&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).UpAdjustDiskUsageDelta()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:196 +0x187&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc.(*Server).serveStreams.func1.2()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc.(*Server).processUnaryRPC()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:932 +0xec&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot;==================&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:196 +0x187&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:932 +0xec&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/server.(*MasterServer).Assign()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot;WARNING: DATA RACE&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; &lt;autogenerated&gt;:1 +0x1b&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).UpAdjustDiskUsageDelta()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/topology/node.go:220 +0x16b&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot;Goroutine 4862045 (running) created at:&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc/internal/transport.(*http2Server).HandleStreams()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).LinkChildNode()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot;Previous read at 0x00c000730930 by goroutine 4862047:&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc.(*Server).serveStreams.func1()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/internal/transport/http2_server.go:648 +0x378&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/pb/master_pb._Seaweed_SendHeartbeat_Handler()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).AvailableSpaceFor()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc.(*Server).serveStreams.func1.2()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc.(*Server).serveStreams()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot;I0903 16:34:16.184525 node.go:223 topo:stagedc:stage-paas-k8s-node48-dcix adds child fast-volume-2.s3-fast-volume.service.stagedc.consul:8080&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/pb/master_pb/master_grpc.pb.go:351 +0xc5&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:916 +0x275&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/topology.(*NodeImpl).doLinkChildNode()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/topology/rack.go:52 +0x592&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; google.golang.org/grpc.(*Server).processStreamingRPC()&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot;-&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/internal/transport/http2_server.go:603 +0x3329&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/pkg/mod/google.golang.org/grpc@v1.48.0/server.go:1558 +0x1c01&quot; &quot;Sep 3, 2022 @ 21:34:16.197&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/server/master_grpc_server_volume.go:146 +0xa24&quot; ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>3.25</MESSAGE>
    <SHA>5b38f22e6ea2a27681d77b42c0d09620ae8d6966</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid data race on calc freeVolumeSlotCount https://github.com/seaweedfs/seaweedfs/issues/3593</MESSAGE>
      <SHA>1fa456f87f5a0ac08557471ddca157a4f9d3a0e0</SHA>
      <PATCHEDFILES>
        <FILE>weed/topology/node.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>avoid data race on calc freeVolumeSlotCount (#3594) https://github.com/seaweedfs/seaweedfs/issues/3593</MESSAGE>
      <SHA>cca45b02a25efd17c99cb656103d9f0140d6a248</SHA>
      <PATCHEDFILES>
        <FILE>weed/topology/node.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
