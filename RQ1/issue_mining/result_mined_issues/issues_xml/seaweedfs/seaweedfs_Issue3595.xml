<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3595</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3595</ISSUEURL>
  <TITLE>[filer] data race on GoCDKPubSub.topic</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/pkg/mod/gocloud.dev@v0.26.0/pubsub/pubsub.go:237 +0x74&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:114 +0x352&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;Previous write at 0x00c001b4c0d8 by goroutine 4234712:&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:248 +0x15a4&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;Goroutine 6329068 (running) created at:&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;-&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/notification/gocdk_pub_sub/gocdk_pub_sub.go:72 +0x472&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/pkg/mod/gocloud.dev/pubsub/rabbitpubsub@v0.26.0/rabbit.go:162 +0x41c&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;Goroutine 4234712 (finished) created at:&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;==================&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/filer/filer.go:203 +0x716&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/notification/gocdk_pub_sub/gocdk_pub_sub.go:99 +0x1a4&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).saveMetaData()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/command/filer.go:308 +0x1b1&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/filer.(*Filer).CreateEntry()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /usr/local/go/src/net/http/server.go:2109 +0x4d&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;Read at 0x00c001b4c0d8 by goroutine 6329068:&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; &lt;autogenerated&gt;:1 +0x57&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /usr/local/go/src/net/http/server.go:3102 +0x58&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/filer/filer_notify.go:59 +0x5c1&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;==================&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; gocloud.dev/pubsub.newTopic()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/notification/gocdk_pub_sub/gocdk_pub_sub.go:71 +0x27e&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/notification/gocdk_pub_sub/gocdk_pub_sub.go:63 +0x15e&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;WARNING: DATA RACE&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; net/http.(*Server).Serve.func3()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; net/http.(*conn).serve()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/notification/gocdk_pub_sub.(*GoCDKPubSub).doReconnect.func1()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /usr/local/go/src/net/http/server.go:3102 +0x837&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/notification/gocdk_pub_sub.(*GoCDKPubSub).doReconnect()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/filer.(*Filer).NotifyUpdateEvent()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; net/http.serverHandler.ServeHTTP()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; gocloud.dev/pubsub/rabbitpubsub.OpenTopic()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; gocloud.dev/pubsub.(*Topic).Send()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; net/http.HandlerFunc.ServeHTTP()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /usr/local/go/src/net/http/server.go:2947 +0x641&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;-&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; net/http.(*Server).Serve()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/notification/gocdk_pub_sub.(*GoCDKPubSub).SendMessage()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; net/http.(*ServeMux).ServeHTTP()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /usr/local/go/src/net/http/server.go:1991 +0xbe4&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/command.(*FilerOptions).startFiler.func3()&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /usr/local/go/src/net/http/server.go:2487 +0xc5&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; /go/pkg/mod/gocloud.dev@v0.26.0/pubsub/pubsub.go:343 +0x1d8&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot;-&quot; &quot;Sep 4, 2022 @ 05:00:43.544&quot;,&quot; github.com/seaweedfs/seaweedfs/weed/notification/gocdk_pub_sub.(*GoCDKPubSub).doReconnect.func1()&quot; ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>3.25</MESSAGE>
    <SHA>5b38f22e6ea2a27681d77b42c0d09620ae8d6966</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid data race on GoCDKPubSub.topic https://github.com/seaweedfs/seaweedfs/issues/3595</MESSAGE>
      <SHA>db5a9d4d39954c966f91c514db55b03a54d37cbe</SHA>
      <PATCHEDFILES>
        <FILE>weed/notification/gocdk_pub_sub/gocdk_pub_sub.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
