<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2098</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2098</ISSUEURL>
  <TITLE>seaweedfs 2.49 - weed server started with IPv4 address only listens on IPv6</TITLE>
  <DESCRIPTION>version 8000GB 2.49 42fb03a linux amd64 I invoke weed server like this (via a systemd service that runs it under a &quot;seaweedfs&quot; user): `weed server -rack=aaa -ip=192.168.1.130 -master.defaultReplication=010 -master.peers=192.168.1.130:9333 -filer=true -filer.port=8515 -filer.defaultReplicaPlacement=010 -volume.port=8526 -volume.max=56 -dir=/mnt/seaweedfs ` 192.168.1.130 is also that same machine's IPv4. But this happens: ``` Log file created at: 2021/05/29 00:29:31 Running on machine: redacted Binary: Built with gc go1.16.4 for linux/amd64 Log line format: [IWEF]mmdd hh:mm:ss threadid file:line] msg I0529 00:29:31 50479 master.go:165] current: 192.168.1.130:9333 peers:192.168.1.130:9333 I0529 00:29:31 50479 file_util.go:23] Folder /mnt/seaweedfs Permission: -rwxr-xr-x I0529 00:29:31 50479 master.go:165] current: 192.168.1.130:9333 peers:192.168.1.130:9333 I0529 00:29:31 50479 file_util.go:23] Folder /mnt/seaweedfs Permission: -rwxr-xr-x I0529 00:29:31 50479 master_server.go:114] Volume Size Limit is 30000 MB I0529 00:29:31 50479 master_server.go:206] adminScripts: lock ec.encode -fullPercent=96 -quietFor=3h ec.rebuild -force ec.balance -force volume.balance -force volume.fix.replication unlock I0529 00:29:31 50479 volume_grpc_client_to_master.go:42] checkWithMaster 192.168.1.130:9333: get master 192.168.1.130:9333 configuration: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.1.130:19333: connect: connection refused&quot; I0529 00:29:31 50479 master.go:120] Start Seaweed Master 8000GB 2.49 42fb03a at :9333 I0529 00:29:31 50479 raft_server.go:70] Starting RaftServer with 192.168.1.130:9333 I0529 00:29:32 50479 raft_server.go:129] current cluster leader: I0529 00:29:32 50479 master.go:143] Start Seaweed Master 8000GB 2.49 42fb03a grpc server at :19333 I0529 00:29:33 50479 masterclient.go:79] No existing leader found! I0529 00:29:33 50479 raft_server.go:154] Initializing new cluster I0529 00:29:33 50479 master_server.go:155] leader change event: =&gt; 192.168.1.130:9333 I0529 00:29:33 50479 master_server.go:157] [ 192.168.1.130:9333 ] 192.168.1.130:9333 becomes leader. I0529 00:29:33 50479 volume_grpc_client_to_master.go:42] checkWithMaster 192.168.1.130:9333: get master 192.168.1.130:9333 configuration: rpc error: code = Unavailable desc = connection closed I0529 00:29:35 50479 volume_grpc_client_to_master.go:42] checkWithMaster 192.168.1.130:9333: get master 192.168.1.130:9333 configuration: rpc error: code = Unavailable desc = connection closed I0529 00:29:37 50479 volume_grpc_client_to_master.go:42] checkWithMaster 192.168.1.130:9333: get master 192.168.1.130:9333 configuration: rpc error: code = Unavailable desc = connection closed [Omitted: Many repeats of that last line with newer timestamp] ``` I observe on &quot;lsof -i -P -n | grep LISTEN&quot; that weed seems to have started gRPC on port + 10000, but only listening on IPv6. No mention of IPv4: ``` [Omitted: Many unrelated ports] weed 49099 seaweedfs 9u IPv6 356380 0t0 TCP *:9333 (LISTEN) weed 49099 seaweedfs 11u IPv6 350869 0t0 TCP *:19333 (LISTEN) ``` I imagine this is the problem, but I can't figure out what made seaweedfs use IPv6 when an IPv4 address was specified. Nothing was using 9333 or 19333 on IPv4. Perhaps it is a bug?</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>s3: save metadata during put-object fix https://github.com/chrislusf/seaweedfs/issues/2092</MESSAGE>
    <SHA>fb8036385ab71c8277a554aff06f937f2e5ab6d6</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>recreate grpc connections if too many errors address https://github.com/chrislusf/seaweedfs/issues/2098</MESSAGE>
      <SHA>1456616a77c8fdb2e3a087645922da9bea388aa1</SHA>
      <PATCHEDFILES>
        <FILE>weed/pb/grpc_client_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
