<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2945</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2945</ISSUEURL>
  <TITLE>[fix] scan .dat File: cannot read needle header at offset</TITLE>
  <DESCRIPTION>**Describe the bug** fix return panic **System Setup** ``` 2.99 ``` **Expected behavior** fix re-create the index .idx file **Additional context** volume.lits ``` volume id:256 size:257705512 collection:&quot;documents&quot; file_count:188 delete_count:168 deleted_byte_count:6034807 read_only:true replica_placement:10 version:3 modified_at_second:1642471870 ``` panic logs ``` I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset 256960240 I0420 14:10:36 82 volume_read.go:131] new entry needle size:98 rest:112 I0420 14:10:36 82 fix.go:51] key 3060820471888067997 offset 256960240 size 98 disk_size 128 compressed false I0420 14:10:36 82 fix.go:54] saved 98 with error &lt;nil&gt; I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset 256960368 I0420 14:10:36 82 volume_read.go:131] new entry needle size:0 rest:16 I0420 14:10:36 82 fix.go:51] key 3060820471888067993 offset 256960368 size 0 disk_size 32 compressed false I0420 14:10:36 82 fix.go:56] skipping deleted file ... I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset 256960400 I0420 14:10:36 82 volume_read.go:131] new entry needle size:0 rest:16 I0420 14:10:36 82 fix.go:51] key 3060820471888067994 offset 256960400 size 0 disk_size 32 compressed false I0420 14:10:36 82 fix.go:56] skipping deleted file ... I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset 256960432 I0420 14:10:36 82 volume_read.go:131] new entry needle size:0 rest:16 I0420 14:10:36 82 fix.go:51] key 3060820471888067995 offset 256960432 size 0 disk_size 32 compressed false I0420 14:10:36 82 fix.go:56] skipping deleted file ... I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset 256960464 I0420 14:10:36 82 volume_read.go:131] new entry needle size:0 rest:16 I0420 14:10:36 82 fix.go:51] key 3060820471888067996 offset 256960464 size 0 disk_size 32 compressed false I0420 14:10:36 82 fix.go:56] skipping deleted file ... I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset 256960496 I0420 14:10:36 82 volume_read.go:131] new entry needle size:0 rest:16 I0420 14:10:36 82 fix.go:51] key 3060820471888067997 offset 256960496 size 0 disk_size 32 compressed false I0420 14:10:36 82 fix.go:56] skipping deleted file ... I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset 256960528 I0420 14:10:36 82 volume_read.go:131] new entry needle size:228 rest:248 I0420 14:10:36 82 fix.go:51] key 3060820471888067984 offset 256960528 size 228 disk_size 264 compressed false I0420 14:10:36 82 fix.go:54] saved 228 with error &lt;nil&gt; I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset 256960792 I0420 14:10:36 82 volume_read.go:131] new entry needle size:-1754292226 rest:-1754292200 I0420 14:10:36 82 fix.go:51] key 18340839113111895790 offset 256960792 size -1754292226 disk_size -1754292184 compressed false I0420 14:10:36 82 fix.go:56] skipping deleted file ... I0420 14:10:36 82 volume_read.go:124] ==&gt; new entry offset -1497331392 F0420 14:10:36 82 fix.go:125] scan .dat File: cannot read needle header at offset -1497331392: readat /data/documents_256.dat: negative offset goroutine 1 [running]: github.com/chrislusf/seaweedfs/weed/glog.stacks(0x0) /Users/tochka/GolandProjects/seaweedfs/weed/glog/glog.go:767 +0x8a github.com/chrislusf/seaweedfs/weed/glog.(*loggingT).output(0x457b640, 0x3, 0xc0005ba000, {0x36f7b94?, 0xc000921d18?}, 0x1?, 0x0) /Users/tochka/GolandProjects/seaweedfs/weed/glog/glog.go:718 +0x3ab github.com/chrislusf/seaweedfs/weed/glog.(*loggingT).printf(0x7fff30538499?, 0x2?, {0x29c1b66, 0x12}, {0xc000921d18, 0x1, 0x1}) /Users/tochka/GolandProjects/seaweedfs/weed/glog/glog.go:656 +0x110 github.com/chrislusf/seaweedfs/weed/glog.Fatalf(...) /Users/tochka/GolandProjects/seaweedfs/weed/glog/glog.go:1149 github.com/chrislusf/seaweedfs/weed/command.doFixOneVolume({0x7fff30538499, 0x6}, {0xc00013fac0?, 0x40?}, {0xc00013fac0, 0x12}, 0x100) /Users/tochka/GolandProjects/seaweedfs/weed/command/fix.go:125 +0x1d7 github.com/chrislusf/seaweedfs/weed/command.runFix(0x455a898?, {0xc00004c0d0?, 0x1, 0x3?}) /Users/tochka/GolandProjects/seaweedfs/weed/command/fix.go:106 +0x48d main.main() /Users/tochka/GolandProjects/seaweedfs/weed/weed.go:81 +0x383 ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>198</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>master: delete partially created replicated volumes during volume growth fix https://github.com/seaweedfs/seaweedfs/discussions/3792#discussioncomment-3973120</MESSAGE>
    <SHA>1e0d64c04883a8d7b09677e9721f9e189743e2f3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix add param for ignore error https://github.com/seaweedfs/seaweedfs/issues/2945</MESSAGE>
      <SHA>a9079871352c6ffbefae1e1757b1394e64482c0f</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/fix.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
