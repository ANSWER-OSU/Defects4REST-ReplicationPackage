<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5153</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/5153</ISSUEURL>
  <TITLE>Filer v3.60: panic: runtime error: invalid memory address or nil pointer dereference</TITLE>
  <DESCRIPTION>**Describe the bug** I upgraded the platform from 3.59 to 3.60, everything seems to work fine, only the filers will not start. I get the error: ``` panic: runtime error: invalid memory address or nil pointer dereference [signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x2747a75] ``` I've no issues when I do a rollback to 3.59 **System Setup** * weed masters: - version 8000GB 3.60 d4e91b6ad9cda07c9ad790e82593caba975cc8e8 linux amd64 - /usr/local/bin/weed -v=4 -logdir=/data/logs/master master -mdir=/data/seaweedfs/master -ip=10.0.9.17 -port=9333 -peers=10.0.9.17:9333,10.0.9.17:9334,10.0.9.17:9335 -metrics.address=192.168.2.17:9091 -defaultReplication=002 -volumePreallocate - /usr/local/bin/weed -v=3 -logdir=/data/logs/master2 master -mdir=/data/seaweedfs/master2 -ip=10.0.9.17 -port=9334 -peers=10.0.9.17:9333,10.0.9.17:9334,10.0.9.17:9335 -metrics.address=10.0.9.17:9091 -defaultReplication=002 -volumePreallocate - /usr/local/bin/weed -v=3 -logdir=/data/logs/master3 master -mdir=/data/seaweedfs/master3 -ip=10.0.9.17 -port=9335 -peers=10.0.9.17:9333,10.0.9.17:9334,10.0.9.17:9335 -metrics.address=10.0.9.17:9091 -defaultReplication=002 -volumePreallocate * weed volumes ( 7 servers ): - version 8000GB 3.60 d4e91b6ad9cda07c9ad790e82593caba975cc8e8 linux amd64 - /usr/local/bin/weed -v=4 -logdir=/data/logs volume -index=leveldb -mserver=10.0.9.17:9333,,10.0.9.17:9334,10.0.9.17:9335 -dir=/data/volumes/b31a481e9f10,/data/volumes/b58e1eeceb47,/data/volumes/db1fe9e78843,/data/volumes/095ed4389bae,/data/volumes/5efb87c6c49a,/data/volumes/3a0cf7f47b2c,/data/volumes/31f3abfafbfe,/data/volumes/b1a03d59f5af,/data/volumes/94abb1a088a6,/data/volumes/bdcb41df6f4e,/data/volumes/2fec28eff631,/data/volumes/8767ac0c4ef5,/data/volumes/db5243c4ff56,/data/volumes/cea31e3f1f7c,/data/volumes/7e524df6cc6e,/data/volumes/483c153731ed,/data/volumes/65aeae444f8a,/data/volumes/cd4a26bfd638,/data/volumes/d2c55ab877e5,/data/volumes/1e49b8543ba6,/data/volumes/68e9f111d0be,/data/volumes/7f43f61f3e29,/data/volumes/a1de5bfdc104,/data/volumes/eaadda777b85,/data/volumes/2653fead368a,/data/volumes/268b8d365eca,/data/volumes/f66ce8dc1c89,/data/volumes/221eca264652,/data/volumes/0dcc7bc3e8cf,/data/volumes/f500845c7c10,/data/volumes/ff8b2a740a99,/data/volumes/65ccfe3439c3,/data/volumes/4046c9008a57,/data/volumes/4e952b1360c0,/data/volumes/be44b201038b,/data/volumes/47ff61529c59,/data/volumes/101cefa28717,/data/volumes/441e19fddd26,/data/volumes/3e825a5f09b5,/data/volumes/6e609c3c3b11,/data/volumes/bb8ea974e2f8,/data/volumes/3b9bf86dc069,/data/volumes/4c947e27c295,/data/volumes/ec5273d113eb,/data/volumes/3c79dd433faa,/data/volumes/ab00a1f9af77,/data/volumes/ba59f13eac18,/data/volumes/f80513da9ce2,/data/volumes/d2ef6dc2aca6,/data/volumes/f2671a03ebae,/data/volumes/8b314b6694b0,/data/volumes/72cc4054836d,/data/volumes/73ab2c752dcb,/data/volumes/7948242749c0,/data/volumes/a55accfcf3cb,/data/volumes/d8d0b4f55a77,/data/volumes/6bedb541df1a,/data/volumes/4993a9c7eaea,/data/volumes/164e2943aabe,/data/volumes/159c9c5d6665,/data/volumes/4f619c60c18c,/data/volumes/d6562d823d51,/data/volumes/1e174630b4e8,/data/volumes/f34e1e9b5854,/data/volumes/ad0b8ab46dcf,/data/volumes/758fab37bc7c,/data/volumes/79286864603b,/data/volumes/810d48b78c5f,/data/volumes/2de4da264c67,/data/volumes/ba981f1d4fc4,/data/volumes/6bcf6998cb9c,/data/volumes/f7624ded9880,/data/volumes/b0a6b3997448,/data/volumes/679665018276,/data/volumes/8800e6bfe5f6,/data/volumes/63361210035b,/data/volumes/7776dadcabf9,/data/volumes/e1ec38933a0b,/data/volumes/489209d183e4,/data/volumes/c3a76626c40d,/data/volumes/8758c57b0fcd,/data/volumes/81f18074dd47,/data/volumes/8ce731230e6f,/data/volumes/9946f0de1fb4,/data/volumes/a854cf4bb686,/data/volumes/fe273af5bcff,/data/volumes/4784d55dbe64,/data/volumes/add9fce8011a,/data/volumes/9d757ab0dd18,/data/volumes/2d269829b67c,/data/volumes/b56f2c990bbe,/data/volumes/4fead3377ee6,/data/volumes/40865ee79135,/data/volumes/1eecbde0ca92,/data/volumes/81879145f7ef,/data/volumes/e74266795999,/data/volumes/24e7391a3059,/data/volumes/b04afa283b69,/data/volumes/7db00666fab5,/data/volumes/ce420ed08e92,/data/volumes/4b280ce7fd2d,/data/volumes/9b9d483f6b36,/data/volumes/e53405e1d819,/data/volumes/584ae3fb50cb,/data/volumes/8956416d95d9,/data/volumes/a065387d42d1,/data/volumes/200892ba9a67,/data/volumes/a7ebaee1c3b5 -max=0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 -concurrentDownloadLimitMB=16384 -concurrentUploadLimitMB=16384 -hasSlowRead=true * weed filers (4 servers): - version 8000GB 3.60 d4e91b6ad9cda07c9ad790e82593caba975cc8e8 linux amd64 - /usr/local/bin/weed -v=4 -logdir=/data/logs filer -master=10.0.9.17:9333,10.0.9.17:9334,10.0.9.17:9335 -s3 - filer.toml ``` #################################################### # Customizable filer server options #################################################### [filer.options] # with http DELETE, by default the filer would check whether a folder is empty. # recursive_delete will delete all sub folders and files, similar to &quot;rm -Rf&quot; recursive_delete = false #max_file_name_length = 255 [cassandra] # CREATE TABLE filemeta ( # directory varchar, # name varchar, # meta blob, # PRIMARY KEY (directory, name) # ) WITH CLUSTERING ORDER BY (name ASC); enabled = true keyspace = &quot;seaweedfs&quot; hosts = [ &quot;192.168.2.21:9042&quot;, &quot;192.168.2.22:9042&quot;, &quot;192.168.2.23:9042&quot;, ] username = &quot;&quot; password = &quot;&quot; # This changes the data layout. Only add new directories. Removing/Updating will cause data loss. superLargeDirectories = [] # Name of the datacenter local to this filer, used as host selection fallback. localDC = &quot;&quot; # Gocql connection timeout, default: 600ms connection_timeout_millisecond = 600 ``` * OS Version (all servers): - Debian GNU/Linux 10 (buster) - Linux node02 4.19.0-25-amd64 #1 SMP Debian 4.19.289-2 (2023-08-08) x86_64 GNU/Linux **Expected behavior** After the upgrade I start weed filer application, it only crashes on startup (on all 4 filer servers). I don't have this issue with the previous version. **Additional context** logging of version: version 8000GB 3.60 d4e91b6ad9cda07c9ad790e82593caba975cc8e8 linux amd64 ``` ... ... Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849438 masterclient.go:279 .filer: 10.0.9.1:8080 masterClient adds volume 2572 Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849447 masterclient.go:279 .filer: 10.0.9.1:8080 masterClient adds volume 4235 Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849456 masterclient.go:279 .filer: 10.0.9.1:8080 masterClient adds volume 560 Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849464 masterclient.go:279 .filer: 10.0.9.1:8080 masterClient adds volume 1127 Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849472 masterclient.go:279 .filer: 10.0.9.1:8080 masterClient adds volume 721 Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849480 masterclient.go:279 .filer: 10.0.9.1:8080 masterClient adds volume 2 Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849487 masterclient.go:279 .filer: 10.0.9.1:8080 masterClient adds volume 3615 Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849498 masterclient.go:294 updateVidMap(DefaultDataCenter) .filer: 10.0.9.1:8080 volume add: 5616, del: 0, add ec: 0 del ec: 0 Jan 2 14:29:58 node02 seaweedfs-filer[18835]: I0102 14:29:58.849585 masterclient.go:247 + filer@192.168.2.12:8888 noticed .filer 192.168.2.12:8888 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.046867 meta_aggregator.go:92 loopSubscribeToOneFiler read 192.168.2.12:8888 start from 2024-01-02 14:28:57.306787028 +0100 CET 1704202137306787028 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.048901 meta_aggregator.go:189 subscribing remote 192.168.2.12:8888 meta change: 2024-01-02 14:28:57.306787028 +0100 CET, clientId:150394752 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.049627 filer_grpc_server_sub_meta.go:296 + local listener filer:192.168.2.12:8888@192.168.2.12:42514 clientId -150394752 clientEpoch 1 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.049654 filer_grpc_server_sub_meta.go:117 + filer:192.168.2.12:8888@192.168.2.12:42514 local subscribe / from 2024-01-02 14:28:57.306787028 +0100 CET clientId:-150394752 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.049673 filer_grpc_server_sub_meta.go:130 read on disk filer:192.168.2.12:8888@192.168.2.12:42514 local subscribe / from 2024-01-02 14:28:57.306787028 +0100 CET Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.072442 filer_grpc_server_sub_meta.go:149 read in memory filer:192.168.2.12:8888@192.168.2.12:42514 local subscribe / from 2024-01-02 14:28:57.306787028 +0100 CET Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.096790 s3.go:202 S3 read filer buckets dir: /buckets Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.096822 s3.go:209 connected to filer 192.168.2.12:8888 grpc address 192.168.2.12:18888 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: I0102 14:29:59.096925 metrics.go:277 s3 server sends metrics to 10.0.9.17:9091 every 15 seconds Jan 2 14:29:59 node02 seaweedfs-filer[18835]: panic: runtime error: invalid memory address or nil pointer dereference Jan 2 14:29:59 node02 seaweedfs-filer[18835]: [signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x2747a75] Jan 2 14:29:59 node02 seaweedfs-filer[18835]: goroutine 99 [running]: Jan 2 14:29:59 node02 seaweedfs-filer[18835]: github.com/seaweedfs/seaweedfs/weed/command.(*S3Options).startS3Server(0x5343500) Jan 2 14:29:59 node02 seaweedfs-filer[18835]: #011/github/workspace/weed/command/s3.go:226 +0x495 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: github.com/seaweedfs/seaweedfs/weed/command.runFiler.func1(0x0?) Jan 2 14:29:59 node02 seaweedfs-filer[18835]: #011/github/workspace/weed/command/filer.go:185 +0x26 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: created by github.com/seaweedfs/seaweedfs/weed/command.runFiler in goroutine 1 Jan 2 14:29:59 node02 seaweedfs-filer[18835]: #011/github/workspace/weed/command/filer.go:183 +0x2aa Jan 2 14:29:59 node02 systemd[1]: seaweedfiler.service: Main process exited, code=exited, status=2/INVALIDARGUMENT Jan 2 14:29:59 node02 systemd[1]: seaweedfiler.service: Failed with result 'exit-code'. root@node02:/data/logs# ``` Logging of version: version 8000GB 3.59 27b34f37935fb3eddb9c7759acf397dbae20eb03 linux amd64 ``` ... ... Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993826 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 2664 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993833 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 1255 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993841 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 6596 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993848 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 1491 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993856 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 4393 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993864 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 3797 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993876 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 721 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993884 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 2 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993891 masterclient.go:279 .filer: 10.0.9.7:8080 masterClient adds volume 3615 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993901 masterclient.go:294 updateVidMap(DefaultDataCenter) .filer: 10.0.9.7:8080 volume add: 3425, del: 0, add ec: 0 del ec: 0 Jan 2 14:32:56 node02 seaweedfs-filer[4463]: I0102 14:32:56.993989 masterclient.go:247 + filer@192.168.2.12:8888 noticed .filer 192.168.2.12:8888 Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.354939 s3.go:199 S3 read filer buckets dir: /buckets Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.354962 s3.go:206 connected to filer 192.168.2.12:8888 grpc address 192.168.2.12:18888 Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.355096 metrics.go:278 s3 server sends metrics to 10.0.9.17:9091 every 15 seconds Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.358030 s3api_circuit_breaker.go:35 s3 circuit breaker not configured Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.361678 s3.go:350 Start Seaweed S3 API Server 8000GB 3.59 27b34f37935fb3eddb9c7759acf397dbae20eb03 at http port 8333 Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.362375 filer_grpc_server_sub_meta.go:296 + listener s3@192.168.2.12:38064 clientId -586500568 clientEpoch 2 Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.362399 filer_grpc_server_sub_meta.go:36 s3@192.168.2.12:38064 starts to subscribe /etc/ from 2024-01-02 14:32:57.361181409 +0100 CET Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.373332 meta_aggregator.go:92 loopSubscribeToOneFiler read 192.168.2.12:8888 start from 2024-01-02 14:31:55.596143708 +0100 CET 1704202315596143708 Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.374653 meta_aggregator.go:189 subscribing remote 192.168.2.12:8888 meta change: 2024-01-02 14:31:55.596143708 +0100 CET, clientId:771085792 Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.375750 filer_grpc_server_sub_meta.go:296 + local listener filer:192.168.2.12:8888@192.168.2.12:38078 clientId -771085792 clientEpoch 1 Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.375770 filer_grpc_server_sub_meta.go:117 + filer:192.168.2.12:8888@192.168.2.12:38078 local subscribe / from 2024-01-02 14:31:55.596143708 +0100 CET clientId:-771085792 Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.375790 filer_grpc_server_sub_meta.go:130 read on disk filer:192.168.2.12:8888@192.168.2.12:38078 local subscribe / from 2024-01-02 14:31:55.596143708 +0100 CET Jan 2 14:32:57 node02 seaweedfs-filer[4463]: I0102 14:32:57.394722 filer_grpc_server_sub_meta.go:149 read in memory filer:192.168.2.12:8888@192.168.2.12:38078 local subscribe / from 2024-01-02 14:31:55.596143708 +0100 CET Jan 2 14:33:19 node02 seaweedfs-filer[4463]: I0102 14:33:19.014458 http_util.go:439 request leftover 1 bytes root@node02:/data/logs# ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix rocksdb build</MESSAGE>
    <SHA>53188a119163d7e6987cef5014aac36c1396be9b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid nil fix https://github.com/seaweedfs/seaweedfs/issues/5153 introduced from #5109</MESSAGE>
      <SHA>d3688938d9e3cd050f2fb2f9943988dd2529c87e</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
