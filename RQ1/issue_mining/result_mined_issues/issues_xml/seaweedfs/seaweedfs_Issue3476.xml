<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3476</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3476</ISSUEURL>
  <TITLE>HTTP Filer truncates uploads which begin with /etc</TITLE>
  <DESCRIPTION>The built-in http server in `filer` cannot handle uploads where the root of the path begins with `/etc`. The file is always truncated to `4MB`. Tested using `Docker version 20.10.12-ce, build 459d0dfbbb51` on `openSUSE Leap 15.3`. There is a `Makefile` and attached server log at the end of this post. Uploading files with `curl` ``` dd if=/dev/urandom of=rands bs=1k count=100k curl -F file=@rands http://10.1.0.8:8889/petc33333/etc3 {&quot;name&quot;:&quot;rands&quot;,&quot;size&quot;:104857600} curl -F file=@rands http://10.1.0.8:8889/etc33333/etc3 {&quot;name&quot;:&quot;rands&quot;,&quot;size&quot;:4194304} curl -F file=@rands http://10.1.0.8:8889/petc932 {&quot;name&quot;:&quot;rands&quot;,&quot;size&quot;:104857600} curl -F file=@rands http://10.1.0.8:8889/etc932 {&quot;name&quot;:&quot;rands&quot;,&quot;size&quot;:4194304} ``` Running a `HEAD` request against each uploaded file. ``` curl -I http://10.1.0.8:8889/petc33333/etc3 HTTP/1.1 200 OK Accept-Ranges: bytes Access-Control-Expose-Headers: Content-Disposition Content-Disposition: inline; filename=&quot;etc3&quot; Content-Length: 104857600 Etag: &quot;3b3a28a324f125fb2423f4aa627c1e74&quot; Last-Modified: Sun, 21 Aug 2022 19:32:01 GMT Server: SeaweedFS Filer 30GB 3.22 Date: Sun, 21 Aug 2022 19:32:04 GMT curl -I http://10.1.0.8:8889/etc33333/etc3 HTTP/1.1 200 OK Accept-Ranges: bytes Access-Control-Expose-Headers: Content-Disposition Content-Disposition: inline; filename=&quot;etc3&quot; Content-Length: 4194304 Etag: &quot;1d65cef5475887ca24f320e9d7cb5d9f&quot; Last-Modified: Sun, 21 Aug 2022 19:32:02 GMT Server: SeaweedFS Filer 30GB 3.22 Date: Sun, 21 Aug 2022 19:32:04 GMT curl -I http://10.1.0.8:8889/petc932 HTTP/1.1 200 OK Accept-Ranges: bytes Access-Control-Expose-Headers: Content-Disposition Content-Disposition: inline; filename=&quot;petc932&quot; Content-Length: 104857600 Etag: &quot;3b3a28a324f125fb2423f4aa627c1e74&quot; Last-Modified: Sun, 21 Aug 2022 19:32:03 GMT Server: SeaweedFS Filer 30GB 3.22 Date: Sun, 21 Aug 2022 19:32:04 GMT curl -I http://10.1.0.8:8889/etc932 HTTP/1.1 200 OK Accept-Ranges: bytes Access-Control-Expose-Headers: Content-Disposition Content-Disposition: inline; filename=&quot;etc932&quot; Content-Length: 4194304 Etag: &quot;1d65cef5475887ca24f320e9d7cb5d9f&quot; Last-Modified: Sun, 21 Aug 2022 19:32:03 GMT Server: SeaweedFS Filer 30GB 3.22 Date: Sun, 21 Aug 2022 19:32:04 GMT ``` Makefile to replicate the behavior ```makefile .PHONY: example upload heads dev-filer HOST:=http://10.1.0.8:8889 dev-filer: docker run -it --rm --name $@ --entrypoint /usr/bin/weed \ -p 8889:8889 -p 6062:6062 \ chrislusf/seaweedfs:3.22 \ -v 2 server -volume.max=5000 -dir=&quot;/data&quot; -master.volumeSizeLimitMB=2048 -master.electionTimeout 1s -master.port=9444 -volume.port=9445 \ -filer -ip.bind 0.0.0.0 -filer.port=8889 -debug -debug.port 6062 rands: dd if=/dev/urandom of=rands bs=1k count=100k example: upload heads upload: rands curl -F file=@rands ${HOST}/petc33333/etc3 @echo curl -F file=@rands ${HOST}/etc33333/etc3 @echo curl -F file=@rands ${HOST}/petc932 @echo curl -F file=@rands ${HOST}/etc932 @echo @echo heads: curl -I ${HOST}/petc33333/etc3 curl -I ${HOST}/etc33333/etc3 curl -I ${HOST}/petc932 curl -I ${HOST}/etc932 ``` [log.txt](https://github.com/seaweedfs/seaweedfs/files/9389838/log.txt)</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix compilation</MESSAGE>
    <SHA>47fb863b5d0f8b9e6cc47db3c0e47b861cd9287b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>filer: do not always save files in &quot;/etc&quot; folder to filer store fix https://github.com/seaweedfs/seaweedfs/issues/3476</MESSAGE>
      <SHA>de0981d774957c61b68410df896b02830672a39d</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/filer_conf.go</FILE>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
