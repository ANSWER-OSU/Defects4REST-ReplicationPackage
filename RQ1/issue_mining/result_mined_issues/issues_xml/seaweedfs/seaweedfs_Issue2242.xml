<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2242</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2242</ISSUEURL>
  <TITLE>[iam] error get update identity</TITLE>
  <DESCRIPTION>IAM identity is not updating on one instance version `2.53` before ``` I0811 03:40:22 1 meta_aggregator.go:152] subscribing remote 172.18.232.217:9090 meta change: rpc error: code = Unavailable desc = transport is closing E0811 03:40:22 1 auth_credentials_subscribe.go:66] subscribing filer meta change: rpc error: code = Unavailable desc = transport is closing I0811 03:40:23 1 filer_grpc_server_sub_meta.go:196] + listener s3@172.18.232.217:37708 I0811 03:40:23 1 filer_grpc_server_sub_meta.go:26] s3@172.18.232.217:37708 starts to subscribe /etc/iam/identity.json from 2021-08-09 06:57:45.508029017 +0000 UTC I0811 03:40:23 1 filer_grpc_server_sub_meta.go:196] + listener filer:172.18.232.217:9090@172.18.232.217:37708 I0811 03:40:23 1 filer_grpc_server_sub_meta.go:77] filer:172.18.232.217:9090@172.18.232.217:37708 local subscribe / from 2021-08-11 03:38:52.254300709 +0000 UTC I0811 03:40:35 1 filer_grpc_server_sub_meta.go:187] =&gt; client filer:172.18.232.217:9090@172.18.232.217:60564: rpc error: code = Unavailable desc = transport is closing E0811 03:40:35 1 filer_grpc_server_sub_meta.go:110] processed to 2021-08-11 03:40:35.126790442 +0000 UTC: rpc error: code = Unavailable desc = transport is closing I0811 03:40:38 1 filer_grpc_server_sub_meta.go:201] - listener filer:172.18.232.217:9090@172.18.232.217:60564 ``` on update ``` I0811 05:26:11 1 filer_grpc_server_sub_meta.go:187] =&gt; client s3@172.18.232.217:45910: rpc error: code = Unavailable desc = transport is closing E0811 05:26:11 1 filer_grpc_server_sub_meta.go:56] processed to 2021-08-11 05:26:11.442961129 +0000 UTC: rpc error: code = Unavailable desc = transport is closing I0811 05:26:11 1 filer_grpc_server_sub_meta.go:187] =&gt; client s3@172.18.232.217:60564: rpc error: code = Unavailable desc = transport is closing E0811 05:26:11 1 filer_grpc_server_sub_meta.go:56] processed to 2021-08-11 05:26:11.442961129 +0000 UTC: rpc error: code = Unavailable desc = transport is closing I0811 05:26:11 1 filer_grpc_server_sub_meta.go:187] =&gt; client s3@172.18.232.217:41886: rpc error: code = Unavailable desc = transport is closing E0811 05:26:11 1 filer_grpc_server_sub_meta.go:56] processed to 2021-08-11 05:26:11.442961129 +0000 UTC: rpc error: code = Unavailable desc = transport is closing I0811 05:26:11 1 filer_grpc_server_sub_meta.go:187] =&gt; client s3@172.18.232.217:44356: rpc error: code = Unavailable desc = transport is closing E0811 05:26:11 1 filer_grpc_server_sub_meta.go:56] processed to 2021-08-11 05:26:11.442961129 +0000 UTC: rpc error: code = Unavailable desc = transport is closing I0811 05:26:11 1 auth_credentials_subscribe.go:31] updated /etc/iam/identity.json I0811 05:26:14 1 filer_grpc_server_sub_meta.go:201] - listener s3@172.18.232.217:45910 I0811 05:26:14 1 filer_grpc_server_sub_meta.go:201] - listener s3@172.18.232.217:60564 I0811 05:26:14 1 filer_grpc_server_sub_meta.go:201] - listener s3@172.18.232.217:41886 I0811 05:26:14 1 filer_grpc_server_sub_meta.go:201] - listener s3@172.18.232.217:44356 ``` run weed shell s3.configure ``` 0809 04:33:25 1 filer_grpc_server_sub_meta.go:56] processed to 2021-08-09 04:33:25.15237125 +0000 UTC: rpc error: code = Unavailable desc = transport is closing I0809 04:33:25 1 filer_grpc_server_sub_meta.go:187] =&gt; client s3@172.18.156.171:32922: rpc error: code = Unavailable desc = transport is closing E0809 04:33:25 1 filer_grpc_server_sub_meta.go:56] processed to 2021-08-09 04:33:25.15237125 +0000 UTC: rpc error: code = Unavailable desc = transport is closing I0809 04:33:25 1 filer_grpc_server_sub_meta.go:187] =&gt; client s3@172.18.156.171:51282: rpc error: code = Unavailable desc = transport is closing E0809 04:33:25 1 filer_grpc_server_sub_meta.go:56] processed to 2021-08-09 04:33:25.15237125 +0000 UTC: rpc error: code = Unavailable desc = transport is closing I0809 04:33:25 1 auth_credentials_subscribe.go:31] updated /etc/iam/identity.json ``` IP 172.18.232.217 is local address restart didn't help ``` I0809 06:57:42 1 meta_aggregator.go:67] connecting to peer filer 172.18.232.217:9090: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 172.18.232.217:19090: connect: connection refused&quot; ``` diagnostic ``` nc -vz 172.18.232.217 19090 172.18.232.217 (172.18.232.217:19090) open ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update README.md</MESSAGE>
    <SHA>5df38d610dc8ba2081088320e546f8a824d232cd</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Retry save and update IAM identity https://github.com/chrislusf/seaweedfs/issues/2242</MESSAGE>
      <SHA>ec09966fd3955b466cfa8f3a3945133226f6a3fd</SHA>
      <PATCHEDFILES>
        <FILE>weed/iamapi/iamapi_server.go</FILE>
        <FILE>weed/s3api/auth_credentials_subscribe.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Retry save and update IAM identity https://github.com/chrislusf/seaweedfs/issues/2242</MESSAGE>
      <SHA>f0afd35eec3d0a860b9b205709574f55e321a385</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/auth_credentials_subscribe.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
