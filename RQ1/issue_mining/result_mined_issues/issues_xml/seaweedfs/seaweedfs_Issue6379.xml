<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6379</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/6379</ISSUEURL>
  <TITLE>S3 DeleteMultipleObjectsHandler does not honour AllowEmptyFolder setting</TITLE>
  <DESCRIPTION>Sponsors SeaweedFS via Patreon https://www.patreon.com/seaweedfs **Describe the bug** When running the S3 DeleteMultipleObjectsHandler function, the setting &quot;AllowEmptyFolder&quot; is not honoured. In circumstances where the filer folders are mistakenly identified as being empty, this causes the entire bucket contents to be deleted. **System Setup** - We setup an integrated Filer + S3 handler, using &quot;leveldb2&quot; driver - Photon Linux 5 - Weed version 3.79 **Expected behavior** When AllowEmptyFolder setting is set to true, only the items specified in the DeleteMultipleObjectsHandler call should have been deleted. **Additional context** The environment on which this runs is suspected to have very slow disk access, which we believe to be the cause for the folders being identified as empty.</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Allow configuring the maximum number of concurrent tasks for EC parallelization. (#6376) Follow-up to b0210df0.</MESSAGE>
    <SHA>ba0707af641e41ba3cbed2b533ed2432d21295ba</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>What problem are we solving? Fix: #6379 How are we solving the problem? We check for the AllowEmptyFolders option prior to cascade deleting parent folders in S3 DeleteMultipleObjectsHandler. How is the PR tested? We ran SeaweedFS in a Kubernetes Cluster with a joint Filer and S3 server in one container, with leveldb2 as the filer storage, and AllowEmptyFolders set to true. When using the Distribution Registry as the S3 client, it calls the DeleteMultipleObjectsHandler as part of the artifact upload process (uploads to a temp location, then performs a copy and delete). Without this fix, the deletion cascade deleted parent folder until the entire contents of the bucket were gone. With this fix, the existing content of the bucket remained, and the newly uploaded content was added. Checks [ ] I have added unit tests if possible. [ ] I will add related wiki document changes and link to this PR after merging.</MESSAGE>
      <SHA>2b07216bc08479fe3f8ae56be0db7a4a0c144458</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/s3api_object_handlers_delete.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix for DeleteMultipleObjectsHandler wrongly deleting parent folders (#6380) What problem are we solving? Fix: #6379 How are we solving the problem? We check for the AllowEmptyFolders option prior to cascade deleting parent folders in S3 DeleteMultipleObjectsHandler. How is the PR tested? We ran SeaweedFS in a Kubernetes Cluster with a joint Filer and S3 server in one container, with leveldb2 as the filer storage, and AllowEmptyFolders set to true. When using the Distribution Registry as the S3 client, it calls the DeleteMultipleObjectsHandler as part of the artifact upload process (uploads to a temp location, then performs a copy and delete). Without this fix, the deletion cascade deleted parent folder until the entire contents of the bucket were gone. With this fix, the existing content of the bucket remained, and the newly uploaded content was added. Checks [ ] I have added unit tests if possible. [ ] I will add related wiki document changes and link to this PR after merging. Co-authored-by: Chris Lu &lt;chrislusf@users.noreply.github.com&gt;</MESSAGE>
      <SHA>a1a76ccb8c3316baf269aa856ba268d53e0943ba</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/s3api_object_handlers_delete.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
