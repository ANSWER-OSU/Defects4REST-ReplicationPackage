<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3479</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3479</ISSUEURL>
  <TITLE>sometimes weed mount crashed while copying files</TITLE>
  <DESCRIPTION>**Describe the bug** Seaweedfs server cluster work well all the time, and I used weed mount to mount filer to local directory, but sometimes weed mount crash while copying files continuously. **System Setup** - OS version Ubuntu 20.04.3 LTS - output of `weed version` version 8000GB 3.22 fa4d0093e17f710c3da00545022646cb96a6fd98 linux amd64 **Additional context** - my weed mount docker-compose.yml: ![image](https://user-images.githubusercontent.com/35862733/185836721-1d1dbb60-b898-4556-8248-e2c5d555fb9d.png) - weed mount logs: ``` seaweedfs-fuse-3.22 | I0822 11:17:06.204712 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 263: 2304,014813df79413fb4 [300,301) seaweedfs-fuse-3.22 | I0822 11:17:06.204722 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 264: 2361,014813e1f0b51c6f [301,302) seaweedfs-fuse-3.22 | I0822 11:17:06.204734 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 265: 2334,014813e668bccfa7 [304,305) seaweedfs-fuse-3.22 | I0822 11:17:06.204748 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 266: 2288,014813e734d407c3 [302,304) seaweedfs-fuse-3.22 | I0822 11:17:06.204759 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 267: 2297,014813ea88319f00 [305,306) seaweedfs-fuse-3.22 | I0822 11:17:06.204769 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 268: 2332,014813eb6a2a19b4 [306,307) seaweedfs-fuse-3.22 | I0822 11:17:06.204782 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 269: 2315,014813ed0aae3825 [307,308) seaweedfs-fuse-3.22 | I0822 11:17:06.204792 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 270: 2319,014813f1bc271cb1 [308,309) seaweedfs-fuse-3.22 | I0822 11:17:06.204802 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 271: 2316,014813f2b76da602 [310,311) seaweedfs-fuse-3.22 | I0822 11:17:06.204813 weedfs_file_sync.go:153 /data/sectionUploadVerify/983fe2e7c3d845369db6432c52b77e98/4d7ff4d592b48ca87ec79726f2be24a7/4d7ff4d592b48ca87ec79726f2be24a7.conf chunks 272: 2313,014813f30df0d8af [309,310) seaweedfs-fuse-3.22 | panic: runtime error: invalid memory address or nil pointer dereference seaweedfs-fuse-3.22 | [signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x1cd0b8a] seaweedfs-fuse-3.22 | seaweedfs-fuse-3.22 | goroutine 218 [running]: seaweedfs-fuse-3.22 | github.com/seaweedfs/seaweedfs/weed/mount/page_writer.(*SwapFileChunk).ReadDataAt(0xc0006a1220, {0xc001b82000, 0x1000, 0x1000}, 0x0) seaweedfs-fuse-3.22 | /github/workspace/weed/mount/page_writer/page_chunk_swapfile.go:101 +0x8a seaweedfs-fuse-3.22 | github.com/seaweedfs/seaweedfs/weed/mount/page_writer.(*UploadPipeline).MaybeReadDataAt(0xc00073a100, {0xc001b82000, 0x1000, 0x1000}, 0x0) seaweedfs-fuse-3.22 | /github/workspace/weed/mount/page_writer/upload_pipeline.go:106 +0x175 seaweedfs-fuse-3.22 | github.com/seaweedfs/seaweedfs/weed/mount.(*ChunkedDirtyPages).ReadDirtyDataAt(0x1000?, {0xc001b82000?, 0x235cb9b?, 0x1b?}, 0xc00186bd28?) seaweedfs-fuse-3.22 | /github/workspace/weed/mount/dirty_pages_chunked.go:65 +0x28 seaweedfs-fuse-3.22 | github.com/seaweedfs/seaweedfs/weed/mount.(*PageWriter).ReadDirtyDataAt(0xc00cfed1d0, {0xc001b82000, 0x1000, 0x1000}, 0x0) seaweedfs-fuse-3.22 | /github/workspace/weed/mount/page_writer.go:60 +0x202 seaweedfs-fuse-3.22 | github.com/seaweedfs/seaweedfs/weed/mount.(*FileHandle).readFromDirtyPages(...) seaweedfs-fuse-3.22 | /github/workspace/weed/mount/filehandle_read.go:20 seaweedfs-fuse-3.22 | github.com/seaweedfs/seaweedfs/weed/mount.(*WFS).Read(0x47958e?, 0xc000320480?, 0xc000320618, {0xc001b82000, 0x1000, 0x1000}) seaweedfs-fuse-3.22 | /github/workspace/weed/mount/weedfs_file_read.go:46 +0x1b0 seaweedfs-fuse-3.22 | github.com/hanwen/go-fuse/v2/fuse.doRead(0xc0002491e0, 0xc000320480) seaweedfs-fuse-3.22 | /go/pkg/mod/github.com/hanwen/go-fuse/v2@v2.1.1-0.20220627082937-d01fda7edf17/fuse/opcode.go:374 +0x83 seaweedfs-fuse-3.22 | github.com/hanwen/go-fuse/v2/fuse.(*Server).handleRequest(0xc0002491e0, 0xc000320480) seaweedfs-fuse-3.22 | /go/pkg/mod/github.com/hanwen/go-fuse/v2@v2.1.1-0.20220627082937-d01fda7edf17/fuse/server.go:514 +0x1f3 seaweedfs-fuse-3.22 | github.com/hanwen/go-fuse/v2/fuse.(*Server).loop(0xc0002491e0, 0x0?) seaweedfs-fuse-3.22 | /go/pkg/mod/github.com/hanwen/go-fuse/v2@v2.1.1-0.20220627082937-d01fda7edf17/fuse/server.go:487 +0x108 seaweedfs-fuse-3.22 | created by github.com/hanwen/go-fuse/v2/fuse.(*Server).readRequest seaweedfs-fuse-3.22 | /go/pkg/mod/github.com/hanwen/go-fuse/v2@v2.1.1-0.20220627082937-d01fda7edf17/fuse/server.go:354 +0x53e seaweedfs-fuse-3.22 exited with code 2 ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>minor</MESSAGE>
    <SHA>3c99050e8a0f095f5773371221fc71cefa12a442</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>mount: add locking to prevent nil pointer fix https://github.com/seaweedfs/seaweedfs/issues/3479</MESSAGE>
      <SHA>536f7f47932e37be27b903f8170475bdbbfedb79</SHA>
      <PATCHEDFILES>
        <FILE>weed/mount/page_writer/page_chunk_mem.go</FILE>
        <FILE>weed/mount/page_writer/page_chunk_swapfile.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
