<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3512</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3512</ISSUEURL>
  <TITLE>[s3] DATA RACE on upload error</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` s3_1 | ================== s3_1 | WARNING: DATA RACE s3_1 | Write at 0x00c00f7b1318 by goroutine 11274: s3_1 | sync/atomic.AddInt64() s3_1 | /usr/local/go/src/runtime/race_amd64.s:289 +0xb s3_1 | sync/atomic.AddInt64() s3_1 | &lt;autogenerated&gt;:1 +0x1b s3_1 | runtime.deferreturn() s3_1 | /usr/local/go/src/runtime/panic.go:476 +0x32 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func3() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:117 +0x47 s3_1 | s3_1 | Previous read at 0x00c00f7b1318 by goroutine 11219: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:67 +0x894 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:108 +0x224 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() s3_1 | &lt;autogenerated&gt;:1 +0x57 s3_1 | net/http.HandlerFunc.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d s3_1 | net/http.(*ServeMux).ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 s3_1 | net/http.serverHandler.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 s3_1 | net/http.(*conn).serve() s3_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 s3_1 | net/http.(*Server).Serve.func3() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 s3_1 | s3_1 | Goroutine 11274 (running) created at: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:99 +0xf9d s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:108 +0x224 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() s3_1 | &lt;autogenerated&gt;:1 +0x57 s3_1 | net/http.HandlerFunc.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d s3_1 | net/http.(*ServeMux).ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 s3_1 | net/http.serverHandler.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 s3_1 | net/http.(*conn).serve() s3_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 s3_1 | net/http.(*Server).Serve.func3() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 s3_1 | s3_1 | Goroutine 11219 (running) created at: s3_1 | net/http.(*Server).Serve() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x837 s3_1 | github.com/seaweedfs/seaweedfs/weed/command.(*FilerOptions).startFiler.func3() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/command/filer.go:308 +0x1b1 s3_1 | ================== s3_1 | E0825 10:10:38.293265 filer_server_handlers_write.go:47 failing to assign a file id: rpc error: code = Unknown desc = no free volumes left for {&quot;collection&quot;:&quot;yournamehere-s76ig1ydq6z9vg3z-123&quot;,&quot;replication&quot;:{},&quot;ttl&quot;:{&quot;Count&quot;:0,&quot;Unit&quot;:0},&quot;preallocate&quot;:16777216} s3_1 | E0825 10:10:38.293416 filer_server_handlers_write_upload.go:191 upload error: rpc error: code = Unknown desc = no free volumes left for {&quot;collection&quot;:&quot;yournamehere-s76ig1ydq6z9vg3z-123&quot;,&quot;replication&quot;:{},&quot;ttl&quot;:{&quot;Count&quot;:0,&quot;Unit&quot;:0},&quot;preallocate&quot;:16777216} s3_1 | ================== s3_1 | WARNING: DATA RACE s3_1 | Write at 0x00c00f5ff540 by goroutine 11277: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func1() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:109 +0x230 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func3() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:117 +0x47 s3_1 | s3_1 | Previous write at 0x00c00f5ff540 by goroutine 11274: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func1() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:109 +0x230 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func3() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:117 +0x47 s3_1 | s3_1 | Goroutine 11277 (running) created at: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:99 +0xf9d s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:108 +0x224 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() s3_1 | &lt;autogenerated&gt;:1 +0x57 s3_1 | net/http.HandlerFunc.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d s3_1 | net/http.(*ServeMux).ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 s3_1 | net/http.serverHandler.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 s3_1 | net/http.(*conn).serve() s3_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 s3_1 | net/http.(*Server).Serve.func3() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 s3_1 | s3_1 | Goroutine 11274 (finished) created at: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:99 +0xf9d s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:108 +0x224 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() s3_1 | &lt;autogenerated&gt;:1 +0x57 s3_1 | net/http.HandlerFunc.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d s3_1 | net/http.(*ServeMux).ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 s3_1 | net/http.serverHandler.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 s3_1 | net/http.(*conn).serve() s3_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 s3_1 | net/http.(*Server).Serve.func3() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 s3_1 | ================== s3_1 | I0825 10:10:38.294075 common.go:70 response method:PUT URL:/buckets/yournamehere-s76ig1ydq6z9vg3z-123/.uploads/4c29144909cf70f256bc53fae09a4aea53877e22/0001.part with httpStatus:500 and JSON:{&quot;error&quot;:&quot;rpc error: code = Unknown desc = no free volumes left for {\&quot;collection\&quot;:\&quot;yournamehere-s76ig1ydq6z9vg3z-123\&quot;,\&quot;replication\&quot;:{},\&quot;ttl\&quot;:{\&quot;Count\&quot;:0,\&quot;Unit\&quot;:0},\&quot;preallocate\&quot;:16777216}&quot;} s ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>clean up</MESSAGE>
    <SHA>a4487725ed6cad2bf4c99cedc121c507d0db4f6d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>adjust for data race fix https://github.com/seaweedfs/seaweedfs/issues/3512</MESSAGE>
      <SHA>fc9040e5f122ea6f5c7d009b600112dee30039ad</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
