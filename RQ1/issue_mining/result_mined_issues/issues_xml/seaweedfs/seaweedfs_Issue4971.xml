<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4971</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/4971</ISSUEURL>
  <TITLE>S3 gateway fails to connect to Filer on non-standard port when running together</TITLE>
  <DESCRIPTION>**Describe the bug** When Filer runs together with S3 and Filer has non-standard gRPC port, managed by third-party system (Nomad in my case), S3 cannot connect to Filer, assuming default gRPC port being 10000+port: ``` port &quot;filer&quot; { static = 8280 to = 8280 host_network = &quot;internal&quot; } // Static port for gRPC is set for illustrative purposes, usually it is allocated dynamically. port &quot;grpc&quot; { static = 18380 to = 18380 host_network = &quot;internal&quot; } I1101 15:47:51.437282 s3.go:203 wait to connect to filer 172.30.18.200:8280 grpc address 172.30.18.200:18280 I1101 15:47:52.439709 s3.go:203 wait to connect to filer 172.30.18.200:8280 grpc address 172.30.18.200:18280 I1101 15:47:53.442039 s3.go:203 wait to connect to filer 172.30.18.200:8280 grpc address 172.30.18.200:18280 ``` **System Setup** - List the command line to start &quot;weed master&quot;, &quot;weed volume&quot;, &quot;weed filer&quot;, &quot;weed s3&quot;, &quot;weed mount&quot;. ``` # weed filer \ -master=seaweedfs-master.service.consul:9333 \ -ip=${NOMAD_IP_filer} \ -port=${NOMAD_PORT_filer} \ -port.grpc=${NOMAD_PORT_grpc} \ -ip.bind=0.0.0.0 \ -dataCenter=dc1 \ -rack=rack0 \ -metricsPort=${NOMAD_PORT_metrics} \ -s3=true \ -s3.port=${NOMAD_PORT_s3} \ -s3.port.grpc=${NOMAD_PORT_s3grpc} \ -s3.config=${NOMAD_ALLOC_DIR}/s3.conf \ -s3.dataCenter=dc1 ``` - OS version ``` # uname -a Linux b94fda572829 5.15.0-86-generic #96-Ubuntu SMP Wed Sep 20 08:23:49 UTC 2023 x86_64 Linux ``` - output of `weed version` ``` # weed version version 30GB 3.58 d1e83a3b4 linux amd64 ``` - if using filer, show the content of `filer.toml` ``` [leveldb2] enabled = true dir = &quot;.&quot; # directory to store level db files ``` **Expected behavior** S3 gateway server connects to Filer's correct gRPC port.</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add podLabels &amp; podAnnotations to all pods (#4959) The pods of all statefulsets/deployments can now have customizable labels and annotations</MESSAGE>
    <SHA>d401e374f7aef02f5fd367c79c0be6778aca2042</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Pass correct Filer's gRPC port to S3 server. Fixes seaweedfs/seaweedfs#4971</MESSAGE>
      <SHA>3496c53576f342602e45056917224722c8419cd2</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Pass correct Filer's gRPC port to S3 server. (#4972) Fixes seaweedfs/seaweedfs#4971</MESSAGE>
      <SHA>4ed06e9ba535b8197feca1825f2a703e18fbc466</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Pass correct Filer's gRPC port to S3 server. (#4972) Fixes seaweedfs/seaweedfs#4971</MESSAGE>
      <SHA>2bba35e9b2b91dc12703e89762171d8244db224f</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Pass correct Filer's gRPC port to S3 server. (#4972) Fixes seaweedfs/seaweedfs#4971</MESSAGE>
      <SHA>e968c8575c17ad0dcca83b73925353c3e53ff55d</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
