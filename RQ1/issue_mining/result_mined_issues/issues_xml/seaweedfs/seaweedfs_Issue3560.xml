<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3560</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3560</ISSUEURL>
  <TITLE>[filer] DATA RACE isSameDataCenter</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` ================== WARNING: DATA RACE Read at 0x00c0005f2dc8 by goroutine 5275902: github.com/seaweedfs/seaweedfs/weed/wdclient.(*vidMap).isSameDataCenter() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/vid_map.go:66 +0x47b github.com/seaweedfs/seaweedfs/weed/wdclient.(*vidMap).LookupVolumeServerUrl() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/vid_map.go:85 +0x467 github.com/seaweedfs/seaweedfs/weed/wdclient.(*vidMap).LookupFileId() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/vid_map.go:107 +0x15a github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).LookupFileIdWithFallback() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:60 +0x84 github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).LookupFileIdWithFallback-fm() &lt;autogenerated&gt;:1 +0x59 github.com/seaweedfs/seaweedfs/weed/filer.StreamContentWithThrottler() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/stream.go:85 +0xdcf github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).GetOrHeadHandler.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_read.go:246 +0x80c github.com/seaweedfs/seaweedfs/weed/server.processRangeRequest() /go/src/github.com/seaweedfs/seaweedfs/weed/server/common.go:286 +0x3f9 github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).GetOrHeadHandler() /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_read.go:222 +0x1f0a github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:54 +0x947 github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() &lt;autogenerated&gt;:1 +0x57 net/http.HandlerFunc.ServeHTTP() /usr/local/go/src/net/http/server.go:2109 +0x4d net/http.(*ServeMux).ServeHTTP() /usr/local/go/src/net/http/server.go:2487 +0xc5 net/http.serverHandler.ServeHTTP() /usr/local/go/src/net/http/server.go:2947 +0x641 net/http.(*conn).serve() /usr/local/go/src/net/http/server.go:1991 +0xbe4 net/http.(*Server).Serve.func3() /usr/local/go/src/net/http/server.go:3102 +0x58 Previous write at 0x00c0005f2dc8 by goroutine 126: github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).resetVidMap() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:309 +0x1546 github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryConnectToMaster.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:216 +0x11f5 github.com/seaweedfs/seaweedfs/weed/pb.WithMasterClient.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:209 +0x88 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:149 +0x248 github.com/seaweedfs/seaweedfs/weed/pb.WithMasterClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:207 +0xd1 github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryConnectToMaster() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:173 +0x27e github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryAllMasters() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:162 +0xe4 github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).KeepConnectedToMaster() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:128 +0x129 github.com/seaweedfs/seaweedfs/weed/filer.(*Filer).KeepMasterClientConnected() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/filer.go:146 +0x45 github.com/seaweedfs/seaweedfs/weed/server.NewFilerServer.func4() /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server.go:131 +0x39 Goroutine 5275902 (running) created at: net/http.(*Server).Serve() /usr/local/go/src/net/http/server.go:3102 +0x837 github.com/seaweedfs/seaweedfs/weed/command.(*FilerOptions).startFiler.func3() /go/src/github.com/seaweedfs/seaweedfs/weed/command/filer.go:308 +0x1b1 Goroutine 126 (running) created at: github.com/seaweedfs/seaweedfs/weed/server.NewFilerServer() /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server.go:131 +0xee4 github.com/seaweedfs/seaweedfs/weed/command.(*FilerOptions).startFiler() /go/src/github.com/seaweedfs/seaweedfs/weed/command/filer.go:227 +0xcf7 github.com/seaweedfs/seaweedfs/weed/command.runFiler() /go/src/github.com/seaweedfs/seaweedfs/weed/command/filer.go:203 +0x892 main.main() /go/src/github.com/seaweedfs/seaweedfs/weed/weed.go:81 +0x943 ================== ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>upload_content: upload close response.Body</MESSAGE>
    <SHA>4a4ef3cc3c24d0c86defe82445448a567316cc36</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid data race on vidMap https://github.com/seaweedfs/seaweedfs/issues/3560</MESSAGE>
      <SHA>bfb70262c1c5ed9c4cba51e56133abfd5e9ce9b9</SHA>
      <PATCHEDFILES>
        <FILE>weed/wdclient/masterclient.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
