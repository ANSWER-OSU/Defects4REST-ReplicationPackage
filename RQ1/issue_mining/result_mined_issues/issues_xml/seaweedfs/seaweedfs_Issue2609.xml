<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2609</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2609</ISSUEURL>
  <TITLE>IO corruption on 2.86</TITLE>
  <DESCRIPTION>**Describe the bug** Applying a 'vacuum' to a sqlite database file is enough to corrupt it. Comparing the pread64() and pwrite64() syscalls between the same command run on ext4 and seaweedfs shows differences, particularly in the last byte of a 1024-byte read. **System Setup** ``` /usr/local/bin/weed master -mdir=/home/weedfs/master -volumePreallocate -volumeSizeLimitMB=30000 -ip 192.168.1.3 -peers 192.168.1.254:9333,192.168.1.253:9333,192.168.1.3:9333 /usr/local/bin/weed volume -dir=/seaweedfs -mserver=192.168.1.253:9333,192.168.1.254:9333,192.168.1.3:9333 -port=8089 -port.grpc=18089 -ip=192.168.1.10 -max=30000 -index=leveldb -dataCenter=shed weed mount -filer=192.168.1.10:8888 -dir=/mnt ``` OS: archlinux sqlite: v3.37.0 ``` [mysql2] # or memsql, tidb enabled = true createTable = &quot;&quot;&quot; CREATE TABLE IF NOT EXISTS `%s` ( dirhash BIGINT, name VARCHAR(1000) BINARY, directory TEXT BINARY, meta LONGBLOB, PRIMARY KEY (dirhash, name) ) DEFAULT CHARSET=utf8; &quot;&quot;&quot; hostname = &quot;192.168.1.3&quot; port = 3306 username = &quot;weedfiler&quot; password = &quot;weedfsfiler&quot; database = &quot;weedfs&quot; # create or use an existing database connection_max_idle = 2 connection_max_open = 100 connection_max_lifetime_seconds = 0 interpolateParams = false # if insert/upsert failing, you can disable upsert or update query syntax to match your RDBMS syntax: enableUpsert = true upsertQuery = &quot;&quot;&quot;INSERT INTO `%s` (dirhash,name,directory,meta) VALUES(?,?,?,?) ON DUPLICATE KEY UPDATE meta = VALUES(meta)&quot;&quot;&quot; ``` **Expected behavior** To replicate: 1. Download this sample SQLIte database and unpack it: https://www.sqlitetutorial.net/wp-content/uploads/2018/03/chinook.zip unzip chinook.zip On weedfs: ``` $ sqlite3 chinook.db 'vacuum' $ sqlite3 chinook.db '.tables' Error: database disk image is malformed ``` On ext4: ``` $ sqlite3 chinook.db 'vacuum' $ sqlite3 chinook.db '.tables' albums employees invoices playlists artists genres media_types tracks customers invoice_items playlist_track ``` If you unpack chinook.db from the zip file on a non-weedfs and a weedfs filesystem and compare the syscall output, you'll see the byte variations: ``` strace -e pread64,pwrite64,open,fsync,fdatasync -v -xx -s 8192 -- sqlite3 chinook.db 'vacuum' 2&gt;/root/strace-ext4.txt strace -e pread64,pwrite64,open,fsync,fdatasync -v -xx -s 8192 -- sqlite3 chinook.db 'vacuum' 2&gt;/root/strace-weedfs.txt diff -u /root/strace-ext4.txt /root/strace-weedfs.txt ``` If you perform the operation twice i.e. unzip, vacuum, the corruption is shown to be consistent i.e. no byte-differences shown by cmp: ``` unzip chinook.zip cp chinook.db chinook2.db sqlite3 chinook.db 'vacuum; sqlite3 chinook2.db 'vacuum; cmp -l chinook.db chinook2.db ``` I would expect that comparing the chinook.db between the vacuum performed on ext4 and weedfs should have no byte differences either.</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>add piknik</MESSAGE>
    <SHA>e134570a9ceac1084f01a6b223891262a6628ab9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>truncate: don't drop chunk where truncate aligns with chunk length Fixes: https://github.com/seaweedfs/seaweedfs/issues/3384 Fixes: https://github.com/seaweedfs/seaweedfs/issues/2609 Before: Chunk `3,577c823253` is dropped when truncate sets file length to 4096: ``` I0806 19:42:26.236780 weedfs_file_sync.go:151 /file set chunks: 2 I0806 19:42:26.236790 weedfs_file_sync.go:153 /file chunks 0: 3,577c823253 [0,5120) I0806 19:42:26.236798 weedfs_file_sync.go:153 /file chunks 1: 6,58be291f0e [0,4096) I0806 19:42:26.237150 weedfs_attr.go:53 /file setattr set size=4096 filersize=5120 chunks=2 I0806 19:42:26.237171 weedfs_attr.go:66 truncated chunk 3,577c823253 from 5120 to 4096 I0806 19:42:26.237411 weedfs_file_sync.go:102 doFlush /file fh 0 I0806 19:42:26.237430 weedfs_file_sync.go:151 /file set chunks: 1 I0806 19:42:26.237439 weedfs_file_sync.go:153 /file chunks 0: 3,577c823253 [0,4096) ``` After, secondary chunk is retailed: ``` I0806 19:40:51.755588 weedfs_file_sync.go:151 /file set chunks: 2 I0806 19:40:51.755598 weedfs_file_sync.go:153 /file chunks 0: 6,54a83ba23d [0,5120) I0806 19:40:51.755605 weedfs_file_sync.go:153 /file chunks 1: 7,556020bbeb [0,4096) I0806 19:40:51.756049 weedfs_attr.go:53 /file setattr set size=4096 chunks=2 I0806 19:40:51.756066 weedfs_attr.go:65 truncated chunk 6,54a83ba23d from 5120 to 4096 I0806 19:40:51.756077 weedfs_attr.go:65 truncated chunk 7,556020bbeb from 4096 to 4096 I0806 19:40:51.756109 weedfs_file_sync.go:102 doFlush /file fh 0 I0806 19:40:51.756127 weedfs_file_sync.go:151 /file set chunks: 2 I0806 19:40:51.756137 weedfs_file_sync.go:153 /file chunks 0: 6,54a83ba23d [0,4096) I0806 19:40:51.756145 weedfs_file_sync.go:153 /file chunks 1: 7,556020bbeb [0,4096) ```</MESSAGE>
      <SHA>b638ee92a76d52eb2d4ecb7ab62dc262a37a11a2</SHA>
      <PATCHEDFILES>
        <FILE>weed/mount/weedfs_attr.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>mount: fix truncate operation fix https://github.com/seaweedfs/seaweedfs/issues/2609</MESSAGE>
      <SHA>8a880a139d81b3c0ee14d0f22a2f569abb1a48b6</SHA>
      <PATCHEDFILES>
        <FILE>weed/mount/weedfs_attr.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>mount: fix truncate operation fix https://github.com/seaweedfs/seaweedfs/issues/2609</MESSAGE>
      <SHA>ba492f6cbb4d07bb2d62157fc9c518aadd141e3f</SHA>
      <PATCHEDFILES>
        <FILE>weed/mount/weedfs_attr.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
