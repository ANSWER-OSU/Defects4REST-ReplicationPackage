<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1664</ISSUENO>
  <ISSUEURL>https://github.com/MobSF/Mobile-Security-Framework-MobSF/issues/1664</ISSUEURL>
  <TITLE>Wrong CA certificate subject hash leads to certificate being ignored as a trust anchor</TITLE>
  <DESCRIPTION>## ENVIRONMENT ``` OS and Version: Linux 5.4.0, Ubuntu Python Version: 3.8.5 MobSF Version: 3.3.0 Beta (master ``` ## EXPLANATION OF THE ISSUE ``` install_mobsf_ca() calculates the wrong subject name hash when creating the certificate filename. Relevant code: https://github.com/MobSF/Mobile-Security-Framework-MobSF/blob/master/mobsf/DynamicAnalyzer/views/android/environment.py#L187-L192 Android uses the MD5-based `X509_subject_name_hash_old()` to create certificate filenames in `/system/etc/security/cacerts`. MobSF however uses subject_name_hash() from pyOpenSSL, which is based on SHA1. This causes Android to not find the mitmproxy CA certificate when verifying certificate chains, breaking SSL interception in dynamic analysis. ``` &lt;!-- If you see errors while running setup/run scripts, join MobSF Slack channel: http://tiny.cc/mobsf to get limited support. --&gt; ## STEPS TO REPRODUCE THE ISSUE ``` 1. Start dynamic analysis of an APK 2. Try to open an HTTPS page in browser or call an HTTPS API from app 3. HTTP works fine, but HTTPS leads to chain verification errors in logcat. ``` ## Suggested fix Emulate `X509_subject_name_hash_old()` in Python with something like this: ``` from OpenSSL import crypto import hashlib pem = open('mitmproxy-ca-cert.pem', 'rb').read() ca = crypto.load_certificate(crypto.FILETYPE_PEM, pem) h = hashlib.md5(ca.get_subject().der()).digest() i = (h[0] | (h[1] &lt;&lt; 8) | (h[2] &lt;&lt; 16) | h[3] &lt;&lt; 24) print(&quot;hash_old: [%s]&quot; % hex(i).lstrip('0x')) # for comparison only print(&quot;hash : [%s]&quot; % hex(ca.subject_name_hash()).lstrip('0x')) ``` Note that the same certificate is installed under two different names on the device (emulator): ``` generic_x86_64:/ $ sha1sum /system/etc/security/cacerts/8bbe0e8d.0 a94d938d9b8692d51828cb1999f58a2b9d09bff2 /system/etc/security/cacerts/8bbe0e8d.0 ha1sum /system/etc/security/cacerts/c8750f0d.0 &lt; a94d938d9b8692d51828cb1999f58a2b9d09bff2 /system/etc/security/cacerts/c8750f0d.0 ```</DESCRIPTION>
  <REPONAME>Mobile-Security-Framework-MobSF</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix unit test for search by md5</MESSAGE>
    <SHA>b0cabecac2ea49e939bd34d847e34dd4a7a6983b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixes #1664</MESSAGE>
      <SHA>fbbbfda2839b306e815254a2285c301e5998214c</SHA>
      <PATCHEDFILES>
        <FILE>mobsf/DynamicAnalyzer/views/android/environment.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
