<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1422</ISSUENO>
  <ISSUEURL>https://github.com/louislam/uptime-kuma/issues/1422</ISSUEURL>
  <TITLE>Race condition in push monitors</TITLE>
  <DESCRIPTION>### ⚠️ Please verify that this bug has NOT been raised before. - [X] I checked and didn't find similar issue ### ️ Security Policy - [X] I agree to have read this project [Security Policy](https://github.com/louislam/uptime-kuma/security/policy) ### Description There is a race condition in the code for push monitors that can cause repeat notifications within the same second or shortly thereafter. (see some background in #922) ![image](https://user-images.githubusercontent.com/1147328/160219491-5d077488-49b8-4a77-99b4-7397873384f3.png) http logs show that the GET calls are generally 60s apart, but because of discrepancies in system time down to the ms level, it can appear that they happen a second apart, even if they're very close together (ie.e 17:58:05.999 to 17:59:06.000) ``` [25/Mar/2022:17:54:05 -0700] &quot;GET /api/push/xxxx?msg=OK&amp;ping=92.177 HTTP/1.1&quot; &quot;-&quot; &quot;curl/7.74.0&quot; TLSv1.3 TLS_AES_256_GCM_SHA384 200 5567 [25/Mar/2022:17:55:05 -0700] &quot;GET /api/push/xxxx?msg=OK&amp;ping=92.196 HTTP/1.1&quot; &quot;-&quot; &quot;curl/7.74.0&quot; TLSv1.3 TLS_AES_256_GCM_SHA384 200 5567 ----------------------------- [25/Mar/2022:17:58:05 -0700] &quot;GET /api/push/xxx?msg=OK&amp;ping=90.552 HTTP/1.1&quot; &quot;-&quot; &quot;curl/7.74.0&quot; TLSv1.3 TLS_AES_256_GCM_SHA384 200 5567 [25/Mar/2022:17:59:06 -0700] &quot;GET /api/push/xxx?msg=OK&amp;ping=91.308 HTTP/1.1&quot; &quot;-&quot; &quot;curl/7.74.0&quot; TLSv1.3 TLS_AES_256_GCM_SHA384 200 5567 ``` ### Reproduction steps Repro is tricky, but it could be possible by monitoring uptime kuma debug logs and synchronizing to them. Basically, the push URL calls have to happen just shortly after the monitor's calls to `beat()` or `safe_beat()` ### Expected behavior Uptime kuma should be robust against very small clock discrepancies ### Actual Behavior Get double notifications ### Uptime-Kuma Version 1.12.1 ### Operating System and Arch Docker on Ubuntu 20.04 ### Browser Firefox ### Docker Version Latest ### NodeJS Version _No response_ ### Relevant log output _No response_</DESCRIPTION>
  <REPONAME>uptime-kuma</REPONAME>
  <TIMEDIFFERENCEDAYS>62</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #1695 from furkanipek/update-tr-lang Update tr-TR.js</MESSAGE>
    <SHA>46a593534b131824f3744d16196dd109c785163f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #1428 from kaysond/master Synchronize push monitor heartbeats to api calls (fixes #1422)</MESSAGE>
      <SHA>90fe25e8ad521e267926c078cb085eac5da3fedc</SHA>
      <PATCHEDFILES>
        <FILE>package-lock.json</FILE>
        <FILE>package.json</FILE>
        <FILE>server/model/monitor.js</FILE>
        <FILE>server/routers/api-router.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
