<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1552</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/1552</ISSUEURL>
  <TITLE>[Feature Request] Update the Redash webhook payload to be a Snowplow-compatible JSON</TITLE>
  <DESCRIPTION>This is a proposal to take the existing Redash webhook and make some minor changes to make it compatible with [Snowplow](https://github.com/snowplow/snowplow). As well as allowing a Redash+Snowplow user to warehouse all of their Redash activity in Snowplow for audit and compliance, this has the additional benefit that it ties the Redash webhook to an agreed [JSON Schema format](http://json-schema.org/). ### JSON Schema We have published a JSON Schema for the Redash webhook as part of Iglu Central, here: https://github.com/snowplow/iglu-central/blob/master/schemas/io.redash.webhooks/event/jsonschema/1-0-0 The exact naming of the webhook schema (`io.redash.webhooks/event`) was checked with @arikfr and should allow Redash to add further more-specific webhooks in the future as needed. The schema has been carefully specified so that the generated Redshift table maps very closely onto Redash's underlying event table: https://github.com/snowplow/iglu-central/blob/master/sql/io.redash.webhooks/event_1.sql ### Steps to make the Redash webhook compatible Currently the Redash webhook is a POST request with the event data encoded in the body as form data. We want to change this to JSON, but specifically Iglu-compatible self-describing JSON (Snowplow's schema system is called [Iglu](https://github.com/snowplow/iglu)). In place of the current POST payload, the Redash webhook should look like this: ```json { &quot;schema&quot;: &quot;iglu:io.redash.webhooks/event/jsonschema/1-0-0&quot;, &quot;data&quot;: { &quot;id&quot;: 23, &quot;user_id&quot;: null, &quot;action&quot;: &quot;DELETE&quot;, ... } } ``` Notes: * The event's integer types should be kept as numerics in JSON * The `created_at` field should be a valid ISO8601 date-time We can easily check any test webhook JSON against the JSON Schema to verify that they match (if there is an error in the JSON Schema, we can patch it in a new Iglu Central release). ### Outcome When this has been implemented, it will be possible to warehouse all Redash webhooks in Snowplow **with zero coding**, using Snowplow's built-in [Iglu webhook adapter](https://github.com/snowplow/snowplow/wiki/Iglu-webhook-adapter). There are some really interesting use cases here: * Full audit log for Redash in Snowplow (allowing the events table in Redash to be regularly truncated?) * Real-time detection (ML-driven?) of a bad actor based on their SQL queries (e.g. PII theft, corporate espionage)</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>9</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #1555 from 44px/original-source-sourcemaps Change: generate sourcemaps for modules (original source files)</MESSAGE>
    <SHA>dd6028384dc2bf20376c48b42e63129de98558eb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Change: send events to webhook as JSON with a schema. Closes #1552.</MESSAGE>
      <SHA>71fa0139709187915806264fc04db1287c34b1c7</SHA>
      <PATCHEDFILES>
        <FILE>redash/models.py</FILE>
        <FILE>redash/tasks/general.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Change: send events to webhook as JSON with a schema. Closes #1552.</MESSAGE>
      <SHA>458399d1444a4987404a6171761c0ec65bf07358</SHA>
      <PATCHEDFILES>
        <FILE>models.py</FILE>
        <FILE>tasks/general.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
