<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1097</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/1097</ISSUEURL>
  <TITLE>Queries are queued multiple times in the waiting queue</TITLE>
  <DESCRIPTION>### Issue Summary Screenshot of the waiting queue: http://puu.sh/piNh1/975281954b.png Running `keys query_hash_job:*` in Redis gives me 123 results but `zrevrange query_task_trackers:waiting 0 -1` gives me 445 results. I don't see the same queries actually being run at the same time in the datasource, but they are definitely added multiple times to the waiting queue. The bug seems to be located in this function https://github.com/getredash/redash/blob/master/redash/tasks/queries.py#L202 I am not very familiar with the Redis pipeline. Does the `GET` returns immediately or is deferred here? https://github.com/getredash/redash/blob/master/redash/tasks/queries.py#L214-L215 If there is anything I can do to help track down this issue, let me know. ### Technical details: - Redash Version: v0.10.1.b1834 - Browser/OS: Latest Chrome / OS X - How did you install Redash: Ubuntu AMI</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>37</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add test for enqueue_query</MESSAGE>
    <SHA>b67f412f581de07eca4deadba30b3bb1e37ebf50</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Remove potnetially concurrency not safe code form enqueue_query. This might have been causing the behavior described in #1097.</MESSAGE>
      <SHA>7159f0beb048eb5ba472dcf194fc93cf733c32b7</SHA>
      <PATCHEDFILES>
        <FILE>redash/tasks/queries.py</FILE>
        <FILE>tests/tasks/test_queries.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Remove potnetially concurrency not safe code form enqueue_query. This might have been causing the behavior described in #1097.</MESSAGE>
      <SHA>4758207d111b50ca761b0062274c73ff260e7181</SHA>
      <PATCHEDFILES>
        <FILE>redash/tasks/queries.py</FILE>
        <FILE>tests/tasks/test_queries.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Remove potnetially concurrency not safe code form enqueue_query. This might have been causing the behavior described in #1097.</MESSAGE>
      <SHA>c67c90d65d56fd7382fdbc37b7ccb8d1b3167d50</SHA>
      <PATCHEDFILES>
        <FILE>tasks/queries.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
