<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1101</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/1101</ISSUEURL>
  <TITLE>Query execution fails if user name has unicode characters</TITLE>
  <DESCRIPTION>``` [2016-06-08 21:16:08,491: ERROR/MainProcess] Task redash.tasks.execute_query[82e3c23b-ceb7-4ed1-81c2-98f8601a6b14] raised unexpected: UnicodeEncodeError('ascii', u'/* Username: \u4f0a\u85e4\u76f4\u4e5f, Task ID: 82e3c23b-ceb7-4ed1-81c2-98f8601a6b14, Query ID: 6, Queue: queries, Query Hash: f1fc50d12a0b5cd0279b42db51130dbe */ SELECT TOP 100 *\nFROM CurrentDB.dbo.Booking', 13, 17, 'ordinal not in range(128)') Traceback (most recent call last): File &quot;/usr/local/lib/python2.7/dist-packages/celery/app/trace.py&quot;, line 240, in trace_task R = retval = fun(*args, **kwargs) File &quot;/opt/redash/redash.0.11.0.b1903/redash/tasks/base.py&quot;, line 13, in __call__ return super(BaseTask, self).__call__(*args, **kwargs) File &quot;/usr/local/lib/python2.7/dist-packages/celery/app/trace.py&quot;, line 437, in __protected_call__ return self.run(*args, **kwargs) File &quot;/opt/redash/redash.0.11.0.b1903/redash/tasks/queries.py&quot;, line 445, in execute_query return QueryExecutor(self, query, data_source_id, metadata).run() File &quot;/opt/redash/redash.0.11.0.b1903/redash/tasks/queries.py&quot;, line 395, in run data, error = query_runner.run_query(annotated_query) File &quot;/opt/redash/redash.0.11.0.b1903/redash/query_runner/mssql.py&quot;, line 125, in run_query cursor.execute(query) File &quot;pymssql.pyx&quot;, line 445, in pymssql.Cursor.execute (pymssql.c:6242) File &quot;_mssql.pyx&quot;, line 998, in _mssql.MSSQLConnection.execute_query (_mssql.c:10085) File &quot;_mssql.pyx&quot;, line 1029, in _mssql.MSSQLConnection.execute_query (_mssql.c:9964) File &quot;_mssql.pyx&quot;, line 1149, in _mssql.MSSQLConnection.format_and_run_query (_mssql.c:11030) File &quot;_mssql.pyx&quot;, line 200, in _mssql.ensure_bytes (_mssql.c:2544) File &quot;/usr/lib/python2.7/encodings/utf_8.py&quot;, line 16, in decode return codecs.utf_8_decode(input, errors, True) UnicodeEncodeError: 'ascii' codec can't encode characters in position 13-16: ordinal not in range(128) ``` ### Steps to Reproduce - My user name is &quot;伊藤直也&quot; - Using mssql query runner - Querying &quot;select top 100 \* from sometable&quot; When using BigQuery query runner, This error doesn't happen. ### Technical details: - Redash Version: v0.10.1.b1834, 0.11.0 - RC - Browser/OS: Google Chrome/OSX / Server: ubuntu Linux 16.04 LTS - How did you install Redash: used `setup/ubuntu/bootstrap.sh`</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>33</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #1102 from getredash/feature/hipchat_v2 Switch to HipChat V2 API</MESSAGE>
    <SHA>65635ec703bec9b2666d234583b8794bc678f456</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #1101: Query execution fails if user name has unicode characters - Encode the query with connection's charset when its type is unicode(not str).</MESSAGE>
      <SHA>91e99c42cd0d4c2aeaf49e8ca24c247af3809c65</SHA>
      <PATCHEDFILES>
        <FILE>redash/query_runner/mssql.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #1104 from kitsuyui/fix/unicode-error-with-sql-server Fix #1101: MSSQL Query runner: query execution fails if user name has unicode characters</MESSAGE>
      <SHA>7844b908de5cfbf46a0e3c163d0ae0f02668a11f</SHA>
      <PATCHEDFILES>
        <FILE>redash/query_runner/mssql.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #1101: Query execution fails if user name has unicode characters - Encode the query with connection's charset when its type is unicode(not str).</MESSAGE>
      <SHA>82b5e81946849ac65107332729398327e87e5d72</SHA>
      <PATCHEDFILES>
        <FILE>redash/query_runner/mssql.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #1104 from kitsuyui/fix/unicode-error-with-sql-server Fix #1101: MSSQL Query runner: query execution fails if user name has unicode characters</MESSAGE>
      <SHA>bde8e351eae67d7249a57e57cf40798b0f506b5d</SHA>
      <PATCHEDFILES>
        <FILE>redash/query_runner/mssql.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #1101: Query execution fails if user name has unicode characters - Encode the query with connection's charset when its type is unicode(not str).</MESSAGE>
      <SHA>9769e8cf8e6627f61cdcaa758a7260870e96ab58</SHA>
      <PATCHEDFILES>
        <FILE>query_runner/mssql.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #1104 from kitsuyui/fix/unicode-error-with-sql-server Fix #1101: MSSQL Query runner: query execution fails if user name has unicode characters</MESSAGE>
      <SHA>57f0871d62cd8fb74cb532b9a5195f69b71c8920</SHA>
      <PATCHEDFILES>
        <FILE>query_runner/mssql.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
