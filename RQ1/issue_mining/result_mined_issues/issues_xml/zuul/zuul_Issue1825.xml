<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1825</ISSUENO>
  <ISSUEURL>https://github.com/Netflix/zuul/issues/1825</ISSUEURL>
  <TITLE>No check if connection already exists for given client</TITLE>
  <DESCRIPTION>### Problem description When adding new connection to the registry (`PushConnectionRegistry`) there is no check if a connection already exists for given client identity. So, in case when: - there is a connection (`connection1`) for given client in the registry and - a request for new connection(`connection2`) and the same client is received then: the previous connection (`connection1`) is replaced by the new one (`connection2`) in the registry. But the `connection1` is not closed - so `connection1` remains open, but there is no possibility to manage it - as the reference to the connection has been lost. Also, if KEEP_ALIVE_ENABLED` is true, the ping events are still sent to the` connection1`. ### Steps to reproduce 1. Open two connection for the same client identity, e.g: In two terminal's windows send a registration request for the same user : ``` curl -v &quot;http://localhost:7001/sse&quot; \ --header 'Accept: text/event-stream' \ -b 'userAuthCookie=exampleClient' ``` Observe - when the second connection is open, the first remains open as well then send push message to `exampleClient` : ``` curl -v http://localhost:7008/push \ --header 'X-CUSTOMER_ID: exampleClient' \ -d 'some example message' ``` check if the message has been received - it'll appear only in second terminal window - for the connection that was opened last. The first connection won't receive the message, but the connection remains open. ### Suggested solution Checking if a connection already exists in the registry for given client. If so, error event is sent to the new connection and the new connection is closed. PR : https://github.com/Netflix/zuul/pull/1826</DESCRIPTION>
  <REPONAME>zuul</REPONAME>
  <TIMEDIFFERENCEDAYS>67</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #1818 from Netflix/alaborda/cgw_2165_bump_snapshot_version Bump snapshot version</MESSAGE>
    <SHA>b008f90e4a1faf88c9f33b571e2d8c8079c0671a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Checking if connection already exists for given client in registry issue #1825 If another connection is present for given client, the new connection is closed.</MESSAGE>
      <SHA>64895b23c44d8ab8d52e8173f3d66e1929fa1785</SHA>
      <PATCHEDFILES>
        <FILE>zuul-core/src/main/java/com/netflix/zuul/netty/server/push/PushRegistrationHandler.java</FILE>
        <FILE>zuul-core/src/test/java/com/netflix/zuul/netty/server/push/PushRegistrationHandlerTest.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Checking if connection already exists for given client in registry issue #1825 If another connection is present for given client, the new connection is closed.</MESSAGE>
      <SHA>8a7e5076561c549123f7c7ee164ffee2c621b467</SHA>
      <PATCHEDFILES>
        <FILE>zuul-core/src/main/java/com/netflix/zuul/netty/server/push/PushRegistrationHandler.java</FILE>
        <FILE>zuul-core/src/test/java/com/netflix/zuul/netty/server/push/PushRegistrationHandlerTest.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
