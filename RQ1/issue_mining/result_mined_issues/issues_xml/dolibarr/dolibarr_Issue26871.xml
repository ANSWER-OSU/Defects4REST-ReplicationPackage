<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>26871</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/26871</ISSUEURL>
  <TITLE>Double discount on updateline in contract</TITLE>
  <DESCRIPTION>### Bug When you update a line on a contract to change the discount, the discount is applied twice. ### Environment Version 17, 18 ### Environment OS Debian ### Environment Web server Apache ### Environment PHP php 8.0 ### Environment Database mysql ### Environment URL(s) _No response_ ### Expected and actual behavior 1. create a contract 2. add a line 3. save the line 4. modify the line 5. change discount 6. save 7. see the new price with discount ### Steps to reproduce the behavior 1. create a contract 2. add a line 3. save the line 4. modify the line 5. change discount 6. save 7. the price in database is incorrect ### Attached files Workaround: on file contrat/card.php change : // update price_ht with discount // TODO Use object-&gt;updateline instead objedtline-&gt;update $price_ht = price2num(GETPOST('elprice'), 'MU'); $remise_percent = price2num(GETPOST('elremise_percent'), 2); if ($remise_percent &gt; 0) { $remise = round(($price_ht * $remise_percent / 100), 2); $price_ht = ($price_ht - $remise); } to : // update price_ht with discount // TODO Use object-&gt;updateline instead objedtline-&gt;update $price_ht = price2num(GETPOST('elprice'), 'MU'); $remise_percent = price2num(GETPOST('elremise_percent'), 2); if ($remise_percent &gt; 0) { $remise = round(($price_ht * $remise_percent / 100), 2); //$price_ht = ($price_ht - $remise); }</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>10</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Clean code</MESSAGE>
    <SHA>60af6843fd0c08dd18ceea1873d46ad211c80257</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #26949 from hansemschnokeloch/fix-26871 Fix #26871</MESSAGE>
      <SHA>f23c7f6b90561a46b0b7194b93f78d53efdbb02c</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/contrat/card.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
