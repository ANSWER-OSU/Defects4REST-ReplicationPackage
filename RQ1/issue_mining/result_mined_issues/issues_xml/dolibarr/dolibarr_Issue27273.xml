<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>27273</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/27273</ISSUEURL>
  <TITLE>MAIN_ROUNDOFTOTAL_NOT_TOTALOFROUND doesn't work as expected</TITLE>
  <DESCRIPTION>### Bug I wanted to use MAIN_ROUNDOFTOTAL_NOT_TOTALOFROUND=1 (tva calculated and rounded on general sums, cf &quot;mode 2&quot; described here https://wiki.dolibarr.org/index.php/R%C3%A8gles_de_param%C3%A9trage,_calcul_et_arrondi_de_TVA) But it doesn't run as expected. I examined the code of `function update_price(...)` in commonobject.class.php Even in mode 2 wih MAIN_ROUNDOFTOTAL_NOT_TOTALOFROUND=1, the sum of vat is calculated with sum of vat lines (rounded to 2 dec by default), and is eventualy corrected by $diff (see in the code). That's seems to me unlogical. I think the total(s) vat should be calculated at the end of the loop on lines using $total_ht_by_vats array * vat_rate I suggest like in the followig PR to add another mode MAIN_ROUNDOFTOTAL_NOT_TOTALOFROUND=2 which use total_ht_by_vats array, so that it doesn't break existing configurations Inspecting the code, I found in facture and in supplier facture some incoherencies : sometimes `update_price()` is called `update_price(1)` some other times, it's called `update_price(1, 'auto')` As the default value for 2nd param of update_price is 'none', the invoice's total may vary when validated. So I changed every call to `update_price(1, 'auto')` ### Environment Version all (including develop branch) ### Environment OS All ### Environment Web server not applicable ### Environment PHP all ### Environment Database _No response_ ### Environment URL(s) _No response_ ### Expected and actual behavior _No response_ ### Steps to reproduce the behavior _No response_ ### Attached files _No response_</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>375</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Debug v19</MESSAGE>
    <SHA>8b51aa507ba9b5a37ad6f1709bec2327134acff7</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #27273 MAIN_ROUNDOFTOTAL_NOT_TOTALOFROUND doesn't work as expected</MESSAGE>
      <SHA>23cd423985a6995b14dcd3c29725c8fe99e40dd4</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/compta/facture/card.php</FILE>
        <FILE>htdocs/compta/facture/class/facture.class.php</FILE>
        <FILE>htdocs/core/class/commonobject.class.php</FILE>
        <FILE>htdocs/fourn/class/fournisseur.facture.class.php</FILE>
        <FILE>htdocs/fourn/facture/card.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #27273 MAIN_ROUNDOFTOTAL_NOT_TOTALOFROUND doesn't work as expected</MESSAGE>
      <SHA>75f23b36f9d41c6523092837580e014e6cedab07</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/core/class/commonobject.class.php</FILE>
        <FILE>htdocs/fourn/facture/card.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
