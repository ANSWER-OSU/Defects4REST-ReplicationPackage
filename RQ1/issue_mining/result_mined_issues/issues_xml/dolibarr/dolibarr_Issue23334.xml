<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>23334</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/23334</ISSUEURL>
  <TITLE>Modify/add a line in an invoice with a price in foreign currency</TITLE>
  <DESCRIPTION>### Bug When modifying/adding a line in an invoice with a price in foreign currency, php code fails in file htdocs/commande/card.php (line 947 -add- and 1072 -update-) ``` if (((!empty($conf-&gt;global-&gt;MAIN_USE_ADVANCED_PERMS) &amp;&amp; empty($user-&gt;rights-&gt;produit-&gt;ignore_price_min_advance)) || empty($conf-&gt;global-&gt;MAIN_USE_ADVANCED_PERMS)) &amp;&amp; (!empty($price_min) &amp;&amp; (price2num($pu_ht) * (1 - price2num($remise_percent) / 100) &lt; price2num($price_min)))) { $mesg = $langs-&gt;trans(&quot;CantBeLessThanMinPrice&quot;, price(price2num($price_min, 'MU'), 0, $langs, 0, 0, - 1, $conf-&gt;currency)); setEventMessages($mesg, null, 'errors'); ``` Condition fails because $pu_ht is not defined A solution would be to define $pu_ht_equi that would be $pu_ht if defined and $pu_ht_devise if defined My problem is I don't see where is currency rate Many thanks ### Environment Version 16.0.1 ### Environment OS ubuntu ### Environment Web server apache 2.4 ### Environment PHP php8.0 ### Environment Database mariadb ### Environment URL(s) htdocs/commande/card.php (line 947 -add- and 1072 -update-) ### Expected and actual behavior _No response_ ### Steps to reproduce the behavior _No response_ ### Attached files _No response_</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #23243 from Hystepik/develop_v14#1 Fix #19485 : add of missing tickets trad key for menu</MESSAGE>
    <SHA>6950e2be20f92db78f11f2e61333fd19c262bf77</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>FIX #23334 Implement a price equivalent in command Implement a price equivalent when dealing with minimum prices and foreign currencies. Added in command/card.php for add and update.</MESSAGE>
      <SHA>07a1f8e65188d5b352aa233cfca13128de8c1bf8</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/commande/card.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #23334 Implement a price equivalent in propal Implement a price equivalent when dealing with minimum prices and foreign currencies. Added in comm/propal/card.php as it was done in command/card.php for add and update.</MESSAGE>
      <SHA>58d3cdb13cc55fe5d221270d4c8babe107639fa3</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/comm/propal/card.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #23335 from Amael-PE/Amael-PE-FIX-23334 FIX #23334 Price equivalent for minimum price check</MESSAGE>
      <SHA>525f1e89e5ee6c875d2be27305a3282a8f17ffd5</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/comm/propal/card.php</FILE>
        <FILE>htdocs/commande/card.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
