<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>33563</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/33563</ISSUEURL>
  <TITLE>Discount count twice when create a discount from a deposit invoice</TITLE>
  <DESCRIPTION>### Bug When a discount is created from a deposit invoice with a line containing a parent product and children, the discount got a wrong value ### Dolibarr Version develop ### Environment PHP PHP 8.2 ### Environment Database MySQL ### Steps to reproduce the behavior and expected behavior 1. Create an order with this parent product and children : ![Image](https://github.com/user-attachments/assets/b819569c-3f1b-4851-8dc5-b1e0e6f845d0) 2. Create a deposit invoice with variable amount on all lines ![Image](https://github.com/user-attachments/assets/28aa8e44-835e-4400-ad3a-5bee81190d6e) 3. Create a payment of this deposit invoice ![Image](https://github.com/user-attachments/assets/8ccc55ba-05cc-4df2-8027-37cef6cad9c0) 4. Check the discount on this deposit invoice ![Image](https://github.com/user-attachments/assets/4748f599-aa0c-4d32-a350-68e5e6acf78c) **The discount amount is not equal to the amount of payment** ### Attached files _No response_</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>NEW Web pages of websites are protected by the WAF</MESSAGE>
    <SHA>7011d01bde2fe9be2bd22e697faab2ad29d97c82</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>FIX #33563 - Discount amount count twice when create a discount from a deposit invoice</MESSAGE>
      <SHA>ee6a7a47c9a010c689d6823bc190cc26317ad57a</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/compta/paiement/class/paiement.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #33563 - Discount amount count twice when create a discount from a deposit invoice (#33564)</MESSAGE>
      <SHA>f9e42e82d58f2c08f2ecdb4d1fdf07a0b63ce6e1</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/compta/paiement/class/paiement.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
