<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>9512</ISSUENO>
  <ISSUEURL>https://github.com/OrchardCMS/OrchardCore/issues/9512</ISSUEURL>
  <TITLE>Documents are still persisted after an unhandled exception is thrown</TITLE>
  <DESCRIPTION>### Describe the bug ### To Reproduce Steps to reproduce the behavior: - enlist an entity for save with `_session.Save(entity)` - throw an unhandled exception - entity is still commited by the `RegisterBeforeDispose` in the shell scope ### Expected behavior We've resolved this ourselves with some exception handling middleware, which specifically calls `await _session.CancelAsync()` Should we put this, or a similar solution, into the shellscope, so that `RegisterBeforeDispose` can potentially have an option to execute operations, like `SaveChangesAsync()` only if there are no exceptions. /cc @jtkech have we talked about this before, I thought we had?</DESCRIPTION>
  <REPONAME>OrchardCore</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fluid.Core 2.0.11 (#9504)</MESSAGE>
    <SHA>f5bc5e3e51166c491284df32e855f4440f1bc315</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixes #9512 Cancel session on exception</MESSAGE>
      <SHA>6682092c026fe71bab9478f0140bf840d24d71b9</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore/OrchardCore.Abstractions/Shell/Scope/ShellScope.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore.Data.YesSql/OrchardCoreBuilderExtensions.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore/Modules/ModularTenantContainerMiddleware.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixes #9512 Cancel session on exception (#9518)</MESSAGE>
      <SHA>3d6ea52e18a85b5c6173859b99bd72887eca3c77</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore/OrchardCore.Abstractions/Shell/Scope/ShellScope.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore.Abstractions/Shell/Scope/ShellScopeExtensions.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore.Data.YesSql/OrchardCoreBuilderExtensions.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore/Modules/ModularBackgroundService.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore/Modules/ModularTenantContainerMiddleware.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
