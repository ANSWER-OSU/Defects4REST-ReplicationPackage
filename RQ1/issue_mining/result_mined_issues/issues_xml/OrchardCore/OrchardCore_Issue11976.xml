<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>11976</ISSUENO>
  <ISSUEURL>https://github.com/OrchardCMS/OrchardCore/issues/11976</ISSUEURL>
  <TITLE>Object reference not set to an instance of an object exception in production environment</TITLE>
  <DESCRIPTION>### Describe the bug I added a new tenant using the Tenants UI. When I click &quot;Setup&quot; button I am redirected to `https://subdomain.domain.com/?token=CfDJ8KtwYcM66YVAqGUg9CLX......` which shows HTTP Error 500. Looking at the log file I see the following ``` 2022-07-08 22:24:07.6669|test123|00-e5f6a593a8645780dc209197a58c33df-99eff78a1a46d690-00||Microsoft.AspNetCore.Server.Kestrel|ERROR|Connection id &quot;0HMJ1550K2I32&quot;, Request id &quot;0HMJ1550K2I32:0000000A&quot;: An unhandled exception was thrown by the application. System.NullReferenceException: Object reference not set to an instance of an object. at YesSql.QueryExtensions.Query[T](ISession session, String collection) at OrchardCore.Data.Documents.DocumentStore.GetOrCreateImmutableAsync[T](Func`1 factoryAsync) at OrchardCore.Documents.DocumentManager`1.GetOrCreateImmutableAsync(Func`1 factoryAsync) at OrchardCore.Settings.Services.SiteService.GetSiteSettingsAsync() at OrchardCore.Media.Processing.MediaTokenSettingsUpdater.ActivatedAsync() at OrchardCore.Environment.Shell.Scope.ShellScope.&lt;&gt;c.&lt;&lt;ActivateShellInternalAsync&gt;b__43_0&gt;d.MoveNext() --- End of stack trace from previous location --- at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.ActivateShellInternalAsync() at OrchardCore.Environment.Shell.Scope.ShellScope.ActivateShellInternalAsync() at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Modules.ModularTenantContainerMiddleware.Invoke(HttpContext httpContext) at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application) at YesSql.QueryExtensions.Query[T](ISession session, String collection) at OrchardCore.Data.Documents.DocumentStore.GetOrCreateImmutableAsync[T](Func`1 factoryAsync) at OrchardCore.Documents.DocumentManager`1.GetOrCreateImmutableAsync(Func`1 factoryAsync) at OrchardCore.Settings.Services.SiteService.GetSiteSettingsAsync() at OrchardCore.Media.Processing.MediaTokenSettingsUpdater.ActivatedAsync() at OrchardCore.Environment.Shell.Scope.ShellScope.&lt;&gt;c.&lt;&lt;ActivateShellInternalAsync&gt;b__43_0&gt;d.MoveNext() --- End of stack trace from previous location --- at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.ActivateShellInternalAsync() at OrchardCore.Environment.Shell.Scope.ShellScope.ActivateShellInternalAsync() at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Modules.ModularTenantContainerMiddleware.Invoke(HttpContext httpContext) ``` I can't reproduce this issue locally and it is happening only in Production environment. The production environment is running on Azure Web App using docker container with the following features ``` services.AddOrchardCms() .AddSetupFeatures(&quot;OrchardCore.Redis&quot;, &quot;OrchardCore.Redis.Lock&quot;) .AddGlobalFeatures(&quot;OrchardCore.DataProtection.Azure&quot;, &quot;OrchardCore.Media.Azure.Storage&quot;,&quot;OrchardCore.Redis&quot;, &quot;OrchardCore.Redis.Cache&quot;, &quot;OrchardCore.Redis.DataProtection&quot;, &quot;OrchardCore.Redis.Lock&quot;) ``` The app is running in production with no issues. However, I can't seems to be able to setup new tenants. Is this a bug? Any idea how I can trace this issue or go about fixing it?</DESCRIPTION>
  <REPONAME>OrchardCore</REPONAME>
  <TIMEDIFFERENCEDAYS>17</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ImageSharp.Web 2.0.2 (#11941)</MESSAGE>
    <SHA>6bb53d98b7ef5b7d66e9392820bac4f1a77711dd</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #11976</MESSAGE>
      <SHA>ab857cb998f4f1009da628a642d11a6cdb8026f1</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore.Modules/OrchardCore.Media/Processing/MediaTokenSettingsUpdater.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore.DisplayManagement/Razor/RazorViewActionFilter.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
