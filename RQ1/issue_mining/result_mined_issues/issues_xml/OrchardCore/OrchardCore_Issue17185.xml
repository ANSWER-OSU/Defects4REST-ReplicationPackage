<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>17185</ISSUENO>
  <ISSUEURL>https://github.com/OrchardCMS/OrchardCore/issues/17185</ISSUEURL>
  <TITLE>Can't query on content type from Elasticsearch and sample is wrong</TITLE>
  <DESCRIPTION>&lt;!-- Please also see the docs on how we manage issues: https://docs.orchardcore.net/en/latest/docs/guides/contributing/managing-issues/. --&gt; &lt;!-- Please replace all placeholders such as this below. --&gt; ### Describe the bug I can't seem to create an Elasticsearch query that filters on content type. The `RecentBlogPosts` query in TheBlog theme's recipe, as well as all the samples in the documentation are broken too. ### Orchard Core version Latest `main` (238ed0e2414341bfda514275e4f5e40c76d8bda6). This used to work in 1.8.x. ### To Reproduce 1. Run Elasticsearch locally or else, and configure it in appsettings. 2. Set up with the Blog recipe. 3. Run the &quot;Blog - Elasticsearch Query&quot; recipe. 4. Open the `RecentBlogPosts` Query. Notice that its &quot;Query&quot; textbox is empty. This is bug 1. 5. Try to run the same Elasticsearch query that was in the recipe and used to work under 1.8.x, see below, and observe that it doesn't return any items, though it should the Blog Post created during setup. This is bug 2. ```json { &quot;query&quot;: { &quot;term&quot;: { &quot;Content.ContentItem.ContentType&quot;: &quot;BlogPost&quot; } }, &quot;sort&quot;: [ { &quot;Content.ContentItem.CreatedUtc&quot;: &quot;desc&quot; } ], &quot;size&quot;: 3 } ``` Using these variations doesn't return any items either: ```json { &quot;query&quot;: { &quot;term&quot;: { &quot;Content.ContentItem.ContentType.keyword&quot;: &quot;BlogPost&quot; } } } ``` ```json { &quot;query&quot;: { &quot;match&quot;: { &quot;Content.ContentItem.ContentType.keyword&quot;: &quot;BlogPost&quot; } } } ``` ```json { &quot;query&quot;: { &quot;match&quot;: { &quot;Content.ContentItem.ContentType&quot;: &quot;BlogPost&quot; } } } ``` They field is correctly mapped (as a keyword): ```json { &quot;aliases&quot;: {}, &quot;mappings&quot;: { &quot;dynamic_templates&quot;: [ { &quot;*.Inherited&quot;: { &quot;match_mapping_type&quot;: &quot;string&quot;, &quot;path_match&quot;: &quot;*.Inherited&quot;, &quot;mapping&quot;: { &quot;type&quot;: &quot;keyword&quot; } } }, { &quot;*.Ids&quot;: { &quot;match_mapping_type&quot;: &quot;string&quot;, &quot;path_match&quot;: &quot;*.Ids&quot;, &quot;mapping&quot;: { &quot;type&quot;: &quot;keyword&quot; } } }, { &quot;*.Location&quot;: { &quot;match_mapping_type&quot;: &quot;object&quot;, &quot;path_match&quot;: &quot;*.Location&quot;, &quot;mapping&quot;: { &quot;type&quot;: &quot;geo_point&quot; } } } ], &quot;_meta&quot;: { &quot;last_task_id&quot;: 7 }, &quot;properties&quot;: { &quot;Content&quot;: { &quot;properties&quot;: { &quot;BodyAspect&quot;: { &quot;properties&quot;: { &quot;Body&quot;: { &quot;fields&quot;: { &quot;keyword&quot;: { &quot;ignore_above&quot;: 256, &quot;type&quot;: &quot;keyword&quot; } }, &quot;type&quot;: &quot;text&quot; } }, &quot;type&quot;: &quot;object&quot; }, &quot;ContentItem&quot;: { &quot;properties&quot;: { &quot;Author&quot;: { &quot;fields&quot;: { &quot;keyword&quot;: { &quot;ignore_above&quot;: 256, &quot;type&quot;: &quot;keyword&quot; } }, &quot;type&quot;: &quot;text&quot; }, &quot;ContainedPart&quot;: { &quot;properties&quot;: { &quot;Ids&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;Order&quot;: { &quot;type&quot;: &quot;float&quot; } }, &quot;type&quot;: &quot;object&quot; }, &quot;ContentType&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;CreatedUtc&quot;: { &quot;type&quot;: &quot;date&quot; }, &quot;DisplayText&quot;: { &quot;properties&quot;: { &quot;Analyzed&quot;: { &quot;type&quot;: &quot;text&quot; }, &quot;Keyword&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;Normalized&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;keyword&quot;: { &quot;fields&quot;: { &quot;keyword&quot;: { &quot;ignore_above&quot;: 256, &quot;type&quot;: &quot;keyword&quot; } }, &quot;type&quot;: &quot;text&quot; } }, &quot;type&quot;: &quot;object&quot; }, &quot;FullText&quot;: { &quot;type&quot;: &quot;text&quot; }, &quot;Latest&quot;: { &quot;type&quot;: &quot;boolean&quot; }, &quot;ModifiedUtc&quot;: { &quot;type&quot;: &quot;date&quot; }, &quot;Owner&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;Published&quot;: { &quot;type&quot;: &quot;boolean&quot; }, &quot;PublishedUtc&quot;: { &quot;type&quot;: &quot;date&quot; } }, &quot;type&quot;: &quot;object&quot; } }, &quot;type&quot;: &quot;object&quot; }, &quot;ContentItemId&quot;: { &quot;type&quot;: &quot;keyword&quot; }, &quot;ContentItemVersionId&quot;: { &quot;type&quot;: &quot;keyword&quot; } }, &quot;_source&quot;: { &quot;enabled&quot;: true, &quot;excludes&quot;: [ &quot;Content.ContentItem.DisplayText.Analyzed&quot; ] } }, &quot;settings&quot;: { &quot;index&quot;: { &quot;analysis&quot;: { &quot;analyzer&quot;: { &quot;standard&quot;: { &quot;type&quot;: &quot;standard&quot; } } }, &quot;creation_date&quot;: 1733704276685, &quot;number_of_replicas&quot;: &quot;1&quot;, &quot;number_of_shards&quot;: &quot;1&quot;, &quot;provided_name&quot;: &quot;default_search&quot;, &quot;routing&quot;: { &quot;allocation&quot;: { &quot;include&quot;: { &quot;_tier_preference&quot;: &quot;data_content&quot; } } }, &quot;uuid&quot;: &quot;eyiyt9TNTfmnkPV3dA4Egw&quot;, &quot;version&quot;: { &quot;created&quot;: &quot;8518000&quot; } } } } ``` Keyword search from under /Search still works. ### Expected behavior The Query from the recipe should work. Also, samples like the ones under https://docs.orchardcore.net/en/latest/guides/query-content-items-based-on-taxonomy/ should also work (they're for Lucene, but this is supposed to work the same). ### Logs and screenshots &lt;!-- If applicable, add log files, browser console logs, and screenshots (or screen recording videos) to help explain your problem. --&gt;</DESCRIPTION>
  <REPONAME>OrchardCore</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update dependency Microsoft.IdentityModel.Protocols.OpenIdConnect to 8.3.0 and Microsoft.Identity.Web to 3.5.0 (#17175)</MESSAGE>
    <SHA>536066954d79e0ab56c25bcc3048cd042d80570c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix Elasticsearch raw query search Fix #17185 Related Work Items: #1</MESSAGE>
      <SHA>4342c629e215674f405910e7c934f91c56a8fac8</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore/OrchardCore.Search.Elasticsearch.Core/Services/ElasticsearchIndexManager.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore.Search.Elasticsearch.Core/Services/ElasticsearchQueryService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
