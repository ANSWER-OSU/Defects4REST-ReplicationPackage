<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>451</ISSUENO>
  <ISSUEURL>https://github.com/bbernhard/signal-cli-rest-api/issues/451</ISSUEURL>
  <TITLE>[v.0.131-dev] WebSocket connection seems to misbehave</TITLE>
  <DESCRIPTION>### The problem As discussed in https://github.com/bbernhard/signal-cli-rest-api/issues/444#issuecomment-1815686274 In my deployment i use 2 linked numbers and 3 directly registered ones. I use [signalbot](https://pypi.org/project/signalbot/) and spawn for each number a separate thread (multiprocessing.Process). The behavior should be the same like if i run the signalbot two times for different numbers. This used to work with the stable _old_ version v0.70 and prior. (in jsonRPC mode) Not sure how familiar you are with this python module but it establishes an websocket to fetch new messages. So there are 4 open connections (one number unused). I send a message to each number quickly one after another and only one responses; other time another does respond. &gt; Do you know if it is related to the speed you are sending those messages? It is not related to speed, some messages simply wont get through. Test: I send from the same number to all three dedicated numbers in exactly that order: - number 1 receives &quot;a normal _tip-speed_ spam of ones to trigger 'start typing event'&quot; -&gt; message: 1111111111111111111111111111111111 - number 2 receives &quot;a _tip-speed_ spam of twos to trigger 'start typing event'&quot; - number 3 receives &quot;a _tip-speed_ spam of threes to trigger 'start typing event'&quot; i did not count how often i pressed the number. but always at least 20 times. maybe i was typing two to tree numbers a second. furthermore i did not hurry to switch to the other chat. ``` 2023-11-17 05:27:15,040 - root - INFO - [Raw Message] {&quot;envelope&quot;:{&quot;source&quot;:&quot;+49123456789&quot;,&quot;sourceNumber&quot;:&quot;+49123456789&quot;,&quot;sourceUuid&quot;:&quot;TheSourceNumber&quot;,&quot;sourceName&quot;:&quot;TheSourceName&quot;,&quot;sourceDevice&quot;:2,&quot;timestamp&quot;:1700195236085,&quot;typingMessage&quot;:{&quot;action&quot;:&quot;STARTED&quot;,&quot;timestamp&quot;:1700195236085}},&quot;account&quot;:&quot;+4922222222222&quot;} 2023-11-17 05:27:31,418 - root - INFO - [Raw Message] {&quot;envelope&quot;:{&quot;source&quot;:&quot;+4933333333333&quot;,&quot;sourceNumber&quot;:&quot;+4933333333333&quot;,&quot;sourceUuid&quot;:&quot;TheSourceUuid&quot;,&quot;sourceName&quot;:&quot;+4933333333333&quot;,&quot;sourceDevice&quot;:1,&quot;timestamp&quot;:1700195251155,&quot;receiptMessage&quot;:{&quot;when&quot;:1700195251155,&quot;isDelivery&quot;:true,&quot;isRead&quot;:false,&quot;isViewed&quot;:false,&quot;timestamps&quot;:[1700195252435]}},&quot;account&quot;:&quot;+49123456789&quot;} 2023-11-17 05:27:40,746 - root - INFO - [Raw Message] {&quot;envelope&quot;:{&quot;source&quot;:&quot;+49123456789&quot;,&quot;sourceNumber&quot;:&quot;+49123456789&quot;,&quot;sourceUuid&quot;:&quot;TheSourceNumber&quot;,&quot;sourceName&quot;:&quot;TheSourceName&quot;,&quot;sourceDevice&quot;:2,&quot;timestamp&quot;:1700195262058,&quot;typingMessage&quot;:{&quot;action&quot;:&quot;STARTED&quot;,&quot;timestamp&quot;:1700195262058}},&quot;account&quot;:&quot;+4911111111111&quot;} 2023-11-17 05:27:44,474 - root - INFO - [Raw Message] {&quot;envelope&quot;:{&quot;source&quot;:&quot;+4911111111111&quot;,&quot;sourceNumber&quot;:&quot;+4911111111111&quot;,&quot;sourceUuid&quot;:&quot;TheSourceNumber&quot;,&quot;sourceName&quot;:&quot;+4911111111111&quot;,&quot;sourceDevice&quot;:1,&quot;timestamp&quot;:1700195264206,&quot;receiptMessage&quot;:{&quot;when&quot;:1700195264206,&quot;isDelivery&quot;:true,&quot;isRead&quot;:false,&quot;isViewed&quot;:false,&quot;timestamps&quot;:[1700195265500]}},&quot;account&quot;:&quot;+49123456789&quot;} 2023-11-17 05:27:56,567 - root - INFO - [Raw Message] {&quot;envelope&quot;:{&quot;source&quot;:&quot;+49123456789&quot;,&quot;sourceNumber&quot;:&quot;+49123456789&quot;,&quot;sourceUuid&quot;:&quot;TheSourceNumber&quot;,&quot;sourceName&quot;:&quot;TheSourceName&quot;,&quot;sourceDevice&quot;:2,&quot;timestamp&quot;:1700195277843,&quot;dataMessage&quot;:{&quot;timestamp&quot;:1700195277843,&quot;message&quot;:&quot;222222222222222222222222222&quot;,&quot;expiresInSeconds&quot;:604800,&quot;viewOnce&quot;:false}},&quot;account&quot;:&quot;+4922222222222&quot;} ``` the module only registered two &quot;start typing events&quot; and received only one message. and in a wrong order (not an issue at all but interesting) for consistency i wrote the comment to this point and repeated the whole procedure whiteout changing the setup. ``` 2023-11-17 05:37:20,260 - root - INFO - [Raw Message] {&quot;envelope&quot;:{&quot;source&quot;:&quot;+49123456789&quot;,&quot;sourceNumber&quot;:&quot;+49123456789&quot;,&quot;sourceUuid&quot;:&quot;TheSourceNumber&quot;,&quot;sourceName&quot;:&quot;TheSourceName&quot;,&quot;sourceDevice&quot;:2,&quot;timestamp&quot;:1700195841568,&quot;typingMessage&quot;:{&quot;action&quot;:&quot;STARTED&quot;,&quot;timestamp&quot;:1700195841568}},&quot;account&quot;:&quot;+4911111111111&quot;} 2023-11-17 05:37:25,319 - root - INFO - [Raw Message] {&quot;envelope&quot;:{&quot;source&quot;:&quot;+49123456789&quot;,&quot;sourceNumber&quot;:&quot;+49123456789&quot;,&quot;sourceUuid&quot;:&quot;TheSourceNumber&quot;,&quot;sourceName&quot;:&quot;TheSourceName&quot;,&quot;sourceDevice&quot;:2,&quot;timestamp&quot;:1700195845482,&quot;syncMessage&quot;:{&quot;sentMessage&quot;:{&quot;destination&quot;:&quot;+4911111111111&quot;,&quot;destinationNumber&quot;:&quot;+4911111111111&quot;,&quot;destinationUuid&quot;:&quot;TheDestinationUuid&quot;,&quot;timestamp&quot;:1700195845482,&quot;message&quot;:&quot;111111111111111111111&quot;,&quot;expiresInSeconds&quot;:604800,&quot;viewOnce&quot;:false}}},&quot;account&quot;:&quot;+49123456789&quot;} 2023-11-17 05:37:33,305 - root - INFO - [Raw Message] {&quot;envelope&quot;:{&quot;source&quot;:&quot;+49123456789&quot;,&quot;sourceNumber&quot;:&quot;+49123456789&quot;,&quot;sourceUuid&quot;:&quot;TheSourceNumber&quot;,&quot;sourceName&quot;:&quot;TheSourceName&quot;,&quot;sourceDevice&quot;:2,&quot;timestamp&quot;:1700195854576,&quot;dataMessage&quot;:{&quot;timestamp&quot;:1700195854576,&quot;message&quot;:&quot;2222222222222222222222222222222&quot;,&quot;expiresInSeconds&quot;:604800,&quot;viewOnce&quot;:false}},&quot;account&quot;:&quot;+4922222222222&quot;} ``` here i got again not all &quot;typing started&quot; events and one message. ### Are you using the latest released version? - [ ] Yes ### Have you read the troubleshooting page? - [X] Yes ### What type of installation are you running? signal-cli-rest-api Docker Container ### In which mode are you using the docker container? JSON-RPC Mode ### What's the architecture of your host system? x86-64 ### Additional information _No response_ EDIT: &quot;syncMessage&quot; and &quot;receiptMessage&quot; do make sense because the sending number is also an used linked device</DESCRIPTION>
  <REPONAME>signal-cli-rest-api</REPONAME>
  <TIMEDIFFERENCEDAYS>96</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>bumped signal-cli version to v0.12.6</MESSAGE>
    <SHA>844f1d7b91dea018de2db07f689ae8720cf63c05</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fixed bug in golang channel handling (json-rpc mode) * golang channels are meant to be 1:1 channels, so if multiple goroutines listen on the same channel for messages, only one will receive the message and the others are not, which lead to lost messages. In order to fix that, we create a dedicated golang channel for every websocket connection. see #451</MESSAGE>
      <SHA>3d7b73560a06db6c824ac972c29ec88ab905fb1a</SHA>
      <PATCHEDFILES>
        <FILE>src/api/api.go</FILE>
        <FILE>src/client/client.go</FILE>
        <FILE>src/client/jsonrpc2.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
