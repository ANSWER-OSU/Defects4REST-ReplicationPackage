<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2511</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/2511</ISSUEURL>
  <TITLE>[discuss]: use fault-injection plugin to implement mock function</TITLE>
  <DESCRIPTION>### Issue description We can add new features to the fault-injection plugin for the following reasons: Currently, the `fault-injection` plugin does not support custom conditions to implement the `mock` function. I think we can add the request header as a conditional judgment in the request (there may be a better way) to realize the mock function. E.g: ``` &quot;vars&quot;: [ [ &quot;http_mock01&quot;, &quot;==&quot;, &quot; api01&quot; ], [ &quot;http_mock02&quot;, &quot;==&quot;, &quot; api02&quot; ] ] ``` When there are multiple conditions in `vars`, they have an `or` relationship. If `vars` passes the verification, fault injection is performed on the request. Otherwise, no processing is done on the request. In order to maintain backward compatibility, the fault injection operation is still performed when the vars condition is not configured.</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>92</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix: avoid caching outdated discovery upstream nodes (#3295) Fix #2369 Fix #1838 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>6fe399c7d6e315b4bbe3bf65340a432e41ce5122</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat(fault-injection): support conditional fault injection using Nginx variables close #2511</MESSAGE>
      <SHA>7f29e97c4cefcd33402a61aa624ff6b68fa82b3b</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/fault-injection.lua</FILE>
        <FILE>doc/plugins/fault-injection.md</FILE>
        <FILE>doc/zh-cn/plugins/fault-injection.md</FILE>
        <FILE>t/plugin/fault-injection.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat(fault-injection): support conditional fault injection using nginx variables (#3363) close #2511</MESSAGE>
      <SHA>fb9123d4298372820e4969ac74751435fd5b4ed8</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/fault-injection.lua</FILE>
        <FILE>doc/plugins/fault-injection.md</FILE>
        <FILE>doc/zh-cn/plugins/fault-injection.md</FILE>
        <FILE>t/plugin/fault-injection.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
