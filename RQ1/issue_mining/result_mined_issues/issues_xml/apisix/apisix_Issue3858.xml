<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3858</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3858</ISSUEURL>
  <TITLE>bug: When using traffic-split , the key of chash is missing in the upstream of traffic-split</TITLE>
  <DESCRIPTION>### Issue description ### Environment * apisix version (2.3): * OS (ubuntu 16): * OpenResty / Nginx version (1.19.3): * etcd version, if have (3.14): * apisix-dashboard version, if have: ### Minimal test code / Steps to reproduce the issue 1.use traffic-split , and set the upstream as follow ``` curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;uri&quot;: &quot;/index.html&quot;, &quot;plugins&quot;: { &quot;traffic-split&quot;: { &quot;rules&quot;: [ { &quot;match&quot;: [ { &quot;vars&quot;: [ [&quot;http_release&quot;,&quot;==&quot;,&quot;new_release&quot;] ] } ], &quot;weighted_upstreams&quot;: [ { &quot;upstream&quot;: { &quot;type&quot;: &quot;chash&quot;, &quot;key&quot;: &quot;remote_addr&quot;, &quot;name&quot;: &quot;upstream_A&quot;, &quot;nodes&quot;: { &quot;127.0.0.1:1981&quot;:1 &quot;127.0.0.2:1981&quot;:1 } } } ] } ] } }, &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;nodes&quot;: { &quot;127.0.0.1:1980&quot;: 1 } } }' ``` 2. curl http://127.0.0.1:9080/index.html -H &quot;release:new_release&quot; -i ``` &lt;html&gt; &lt;head&gt;&lt;title&gt;500 Internal Server Error&lt;/title&gt;&lt;/head&gt; &lt;body&gt; &lt;center&gt;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&lt;/center&gt; &lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt; &lt;/body&gt; &lt;/html&gt; ``` ### What's the actual result? (including assertion message &amp; call stack if applicable) Error can be found in error.log ``` 2021/03/18 15:36:04 [error] 72662#72662: *683 failed to run balancer_by_lua*: /chash.lua:36: invalid argument, expect string value stack traceback: [C]: in function 'error' /data/app/huya-nginx-proxy/apisix/core/ctx.lua:139: in function '__index' /data/app/huya-nginx-proxy/apisix/balancer/chash.lua:36: in function 'fetch_chash_hash_key' /data/app/huya-nginx-proxy/apisix/balancer/chash.lua:81: in function 'get' /data/app/huya-nginx-proxy/apisix/balancer.lua:172: in function 'pick_server' /data/app/huya-nginx-proxy/apisix/balancer.lua:197: in function 'load_balancer' /data/app/huya-nginx-proxy/apisix/init.lua:718: in function 'http_balancer_phase' ``` ### What's the expected result? No error</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: ret_code type in plugin redirect should be integer (#3940)</MESSAGE>
    <SHA>562841ba30c2dc24b39a6f5f7635a6a31b59c95e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat(traffic-split): upstream.type support chash configuration fix #3858</MESSAGE>
      <SHA>68e819bbbd726f5ae99fa88fe951bc36237ae4f6</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/traffic-split.lua</FILE>
        <FILE>docs/zh/latest/plugins/traffic-split.md</FILE>
        <FILE>t/plugin/traffic-split2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
