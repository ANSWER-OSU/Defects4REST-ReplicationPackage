<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2823</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/2823</ISSUEURL>
  <TITLE>feat(hmac-auth): the request parameter participating in the signature can be the parameter name</TITLE>
  <DESCRIPTION>### Issue description When the request parameters of the hmac-auth plug-in participate in the signature. If the parameter is in the form of `key` instead of `key=value` or `key=`, the Lua thread will be aborted and the signature will fail. Therefore, we need to be compatible with this `key` situation. Example： Add a test case in `hmac-auth.t`, contains request parameters in the form of `key`(name=jack&amp;age): ``` === TEST 41: verify: ok --- config location /t { content_by_lua_block { local ngx_time = ngx.time local ngx_http_time = ngx.http_time local core = require(&quot;apisix.core&quot;) local t = require(&quot;lib.test_admin&quot;) local hmac = require(&quot;resty.hmac&quot;) local ngx_encode_base64 = ngx.encode_base64 local secret_key = &quot;my-secret-key6&quot; local timestamp = ngx_time() local gmt = ngx_http_time(timestamp) local access_key = &quot;my-access-key6&quot; local custom_header_a = &quot;asld$%dfasf&quot; local custom_header_b = &quot;23879fmsldfk&quot; local signing_string = { &quot;GET&quot;, &quot;/hello&quot;, &quot;age&amp;name=jack&quot;, access_key, gmt, &quot;x-custom-header-a:&quot; .. custom_header_a, &quot;x-custom-header-b:&quot; .. custom_header_b } signing_string = core.table.concat(signing_string, &quot;\n&quot;) .. &quot;\n&quot; core.log.info(&quot;signing_string:&quot;, signing_string) local signature = hmac:new(secret_key, hmac.ALGOS.SHA256):final(signing_string) core.log.info(&quot;signature:&quot;, ngx_encode_base64(signature)) local headers = {} headers[&quot;X-HMAC-SIGNATURE&quot;] = ngx_encode_base64(signature) headers[&quot;X-HMAC-ALGORITHM&quot;] = &quot;hmac-sha256&quot; headers[&quot;Date&quot;] = gmt headers[&quot;X-HMAC-ACCESS-KEY&quot;] = access_key headers[&quot;X-HMAC-SIGNED-HEADERS&quot;] = &quot;x-custom-header-a;x-custom-header-b&quot; headers[&quot;x-custom-header-a&quot;] = custom_header_a headers[&quot;x-custom-header-b&quot;] = custom_header_b local code, body = t.test('/hello?name=jack&amp;age', ngx.HTTP_GET, &quot;&quot;, nil, headers ) ngx.status = code ngx.say(body) } } --- request GET /t --- response_body passed --- no_error_log [error] ``` Test case run results： &lt;img width=&quot;1269&quot; alt=&quot;截屏2020-11-23 下午1 59 39&quot; src=&quot;https://user-images.githubusercontent.com/52862365/99932853-44f13400-2d94-11eb-931c-091b1c198e46.png&quot;&gt; ### Environment * apisix version (cmd: `apisix version`): 2.0 * OS:</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: support '.' in id definition (#2795) * feat: support '.' in id definition Close #2274. * tweak test</MESSAGE>
    <SHA>d7593a0ac3f960ab23d5a71d98cf1666e21b207c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: the request parameter participating in the signature can be the parameter name. close #2823</MESSAGE>
      <SHA>247e8eb28bdf4031ec88c05de70fbe078b00faca</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/hmac-auth.lua</FILE>
        <FILE>t/plugin/hmac-auth.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: the request parameter participating in the signature can be the parameter name. close #2823</MESSAGE>
      <SHA>e07096c73410b91f8cf238845069d8d6b4652528</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/hmac-auth.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: the request parameter participating in the signature can be the parameter name (#2830) close #2823</MESSAGE>
      <SHA>72f907ea8bd8387f0e87371e0c820d6db6c884c7</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/hmac-auth.lua</FILE>
        <FILE>t/plugin/hmac-auth.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
