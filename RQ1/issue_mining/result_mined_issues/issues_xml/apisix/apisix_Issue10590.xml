<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>10590</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/10590</ISSUEURL>
  <TITLE>bug: attempt to index local 'opentracing' (a nil value) when using zipkin plugin</TITLE>
  <DESCRIPTION>### Description this situation is rarely triggered, approximately tens of millions of occurrences only occur a few times. more likely to occur when the request is a websocket. error msg: 51#51: *4824 failed to run log_by_lua*: ...ocal/apisix/plugins/apisix/plugins/zipkin.lua:268: attempt to index local 'opentracing' (a nil value) stack traceback: ...ocal/apisix/plugins/apisix/plugins/log-zipkin.lua:268: in function 'phase_func' /usr/local/apisix/apisix/plugin.lua:1139: in function 'run_plugin' /usr/local/apisix/apisix/plugin.lua:1172: in function 'run_global_rules' /usr/local/apisix/apisix/init.lua:461: in function 'common_phase' /usr/local/apisix/apisix/init.lua:870: in function 'http_log_phase' log_by_lua(nginx.conf:417):2: in main chunk while logging request, client: 10.255.217.88, server: _, request: &quot;GET / HTTP/1.1&quot;, upstream: &quot;http://10.212.166.227:9082/&quot;, host: &quot;xxx.com&quot; ### Environment - APISIX version (run `apisix version`): 2.14.1 - Operating system (run `uname -a`): Linux apisix-b7d9c6fd4-5tn2r 4.19.0-10-amd64 #1 SMP Debian 4.19.132-1 (2020-07-24) x86_64 GNU/Linux - OpenResty / Nginx version (run `openresty -V` or `nginx -V`): openresty/1.21.4.2 - etcd version, if relevant (run `curl http://127.0.0.1:9090/v1/server_info`): 3.4.0 - APISIX Dashboard version, if relevant: 3.0.1 - Plugin runner version, for issues related to plugin runners: - LuaRocks version, for installation issues (run `luarocks --version`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>17</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat(limit-count): allow to use environment variables for settings (#10607)</MESSAGE>
    <SHA>bf8940d8d57cb45bc08a75baea4f3293ad97529b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(zipkin): avoid getting a nil value in log phase(#10590)</MESSAGE>
      <SHA>4d613f2db5dc4c2a8a4271dbe64852333ffdbce7</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/zipkin.lua</FILE>
        <FILE>t/plugin/zipkin.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(zipkin): add a new test case(#10590)</MESSAGE>
      <SHA>5895771d7948e5d26774dc35c1f96bb83fc04b15</SHA>
      <PATCHEDFILES>
        <FILE>t/plugin/zipkin.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
