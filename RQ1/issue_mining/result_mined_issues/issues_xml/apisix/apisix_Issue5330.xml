<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5330</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/5330</ISSUEURL>
  <TITLE>request help: my upstream is not evenly loaded</TITLE>
  <DESCRIPTION>### Issue description My upstream's type is RoundRobin,priority is 10,and my config.yaml See below: ``` apisix: stream_proxy: only: false node_listen: 80 allow_admin: - 127.0.0.1 router: http: 'radixtree_host_uri' ssl: listen_port: 443 enable_http2: false ssl_protocols: &quot;TLSv1 TLSv1.1 TLSv1.2 TLSv1.3&quot; ssl_ciphers: &quot;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kED H+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA&quot;plugins: - proxy-rewrite - prometheus - log-rotate - redirect - node-status - server-info - proxy-mirror - echo - ip-restriction - basic-auth - kafka-logger plugin_attr: prometheus: export_uri: /apisix/prometheus/metrics enable_export_server: true export_addr: ip: 0.0.0.0 port: 11091 log-rotate: interval: 21600 max_kept: 120 nginx_config: http_end_configuration_snippet: | reset_timedout_connection off; client_header_buffer_size 128k; client_body_buffer_size 2048k; proxy_intercept_errors on; large_client_header_buffers 8 32k; gzip off; gzip_min_length 1k; gzip_buffers 4 16k; gzip_http_version 1.0; gzip_comp_level 9; gzip_vary on; gzip_types text/plain application/x-javascript text/css application/javascript application/json application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png; proxy_next_upstream off; proxy_connect_timeout 60; proxy_send_timeout 300s; proxy_read_timeout 300s; proxy_buffers 64 32k; # getconf PAGESIZE proxy_buffer_size 1024k; proxy_busy_buffers_size 1024k; proxy_temp_file_write_size 1024k; proxy_max_temp_file_size 0; proxy_ignore_client_abort on; proxy_http_version 1.1; proxy_set_header Connection &quot;&quot;; proxy_set_header Host $host; proxy_set_header traffic-source &quot;INTERNAL&quot;; http: lua_shared_dict: prometheus-metrics: 100m real_ip_header: &quot;X-Forwarded-For&quot; real_ip_from: - 0.0.0.0/0 - 'unix:' keepalive_timeout: 600s client_header_timeout: 600s client_body_timeout: 600s send_timeout: 100s access_log_format: &quot;$time_iso8601|$msec|$status|$request_completion|$bytes_sent|$body_bytes_sent|$realip_remote_addr|$remote_addr|$http_x_forwarded_for|$remote_user|$host|$server_name|$ server_port|$server_protocol|$scheme|$request_method|$request_length|$request_time|$request_uri|$uri|$content_length|$content_type|$http_referer|$http_user_agent|$http_app_jb|$http_client_info|$upstream_addr|$upstream_connect_time|$upstream_header_time|$upstream_response_time|$upstream_status|$upstream_bytes_received|$upstream_cache_status|$upstream_http_content_type|$upstream_http_content_length|$upstream_http_content_disposition|$http_x_cat_parent_id|$upstream_scheme://$upstream_host$upstream_uri&quot;` ----------------------------------------- upstream's config : `{ &quot;hash_on&quot;: &quot;vars&quot;, &quot;pass_host&quot;: &quot;pass&quot;, &quot;nodes&quot;: [ { &quot;host&quot;: &quot;10.1.1.21&quot;, &quot;port&quot;: 11180, &quot;weight&quot;: 100, &quot;priority&quot;: 10 }, { &quot;host&quot;: &quot;10.1.1.213&quot;, &quot;port&quot;: 11180, &quot;weight&quot;: 100, &quot;priority&quot;: 10 }, { &quot;host&quot;: &quot;10.1.1.214&quot;, &quot;port&quot;: 11180, &quot;weight&quot;: 100, &quot;priority&quot;: 10 }, { &quot;host&quot;: &quot;10.1.1.215&quot;, &quot;port&quot;: 11180, &quot;weight&quot;: 100, &quot;priority&quot;: 10 }, { &quot;host&quot;: &quot;10.1.1.216&quot;, &quot;port&quot;: 11180, &quot;weight&quot;: 100, &quot;priority&quot;: 10 }, { &quot;host&quot;: &quot;10.1.1.217&quot;, &quot;port&quot;: 11180, &quot;weight&quot;: 100, &quot;priority&quot;: 10 }, { &quot;host&quot;: &quot;10.1.1.218&quot;, &quot;port&quot;: 11180, &quot;weight&quot;: 100, &quot;priority&quot;: 10 }, { &quot;host&quot;: &quot;10.1.1.219&quot;, &quot;port&quot;: 11180, &quot;weight&quot;: 100, &quot;priority&quot;: 10 } ], &quot;type&quot;: &quot;roundrobin&quot;, &quot;labels&quot;: { &quot;type&quot;: &quot;normal&quot;, &quot;amh_env&quot;: &quot;finack&quot; }, &quot;checks&quot;: { &quot;active&quot;: { &quot;https_verify_certificate&quot;: true, &quot;timeout&quot;: 2.5, &quot;healthy&quot;: { &quot;interval&quot;: 2, &quot;successes&quot;: 3, &quot;http_statuses&quot;: [ 200 ] }, &quot;type&quot;: &quot;http&quot;, &quot;unhealthy&quot;: { &quot;interval&quot;: 2, &quot;http_failures&quot;: 3, &quot;tcp_failures&quot;: 3, &quot;timeouts&quot;: 3, &quot;http_statuses&quot;: [ 429, 404, 500, 501, 502, 503, 504, 505 ] }, &quot;concurrency&quot;: 10, &quot;http_path&quot;: &quot;/gateway/healthCheck&quot; } }, &quot;name&quot;: &quot;api-gateway&quot;, &quot;timeout&quot;: { &quot;read&quot;: 600, &quot;send&quot;: 600, &quot;connect&quot;: 600 }, &quot;scheme&quot;: &quot;http&quot;, } ``` **The back-end node is Eureka gateway. During peak hours, some back-end nodes reach 400 million QPS, some 200 million QPS and some 300 million QPS, which is very unbalanced. All my requests are short connections. Has anyone encountered them? Please let us know the solution, thank you!!!** ### Environment - apisix version (cmd: `apisix version`):2.10.0 - OS (cmd: `uname -a`):centos 7.3 - OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): - etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): - apisix-dashboard version, if have: - the plugin runner version, if the issue is about a plugin runner (cmd: depended on the kind of runner): - luarocks version, if the issue is about installation (cmd: `luarocks --version`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>16</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: support advanced matching based on post form (#5409)</MESSAGE>
    <SHA>c2f5eba5cf86bb8f840279f642e63c4d3ba740fa</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(upstream): load imbalance when it's referred by multiple routes Fix https://github.com/apache/apisix/issues/5330 Thanks to Yong Nie for the advice. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>b8156b3b80edf9b47112e2d9d5284c1f4bc9c395</SHA>
      <PATCHEDFILES>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>t/node/least_conn2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(upstream): load imbalance when it's referred by multiple routes Fix https://github.com/apache/apisix/issues/5330 Thanks to Yong Nie for the advice. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>2cd044e5638b6741589ff6abbd92cc3e4708ad94</SHA>
      <PATCHEDFILES>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>t/node/least_conn2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
