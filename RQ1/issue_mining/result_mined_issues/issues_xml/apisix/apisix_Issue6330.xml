<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6330</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/6330</ISSUEURL>
  <TITLE>bug: Wrong pattern validation in the proxy-mirror plugin</TITLE>
  <DESCRIPTION>### Issue description The `proxy-mirror` plugin validates the `host` pattern with the following regex: `[[^http(s)?:\/\/[a-zA-Z0-9][-a-zA-Z0-9]{0,62}]] .. [[(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+(:[0-9]{1,5})?$]]`. In specific scenarios, the pattern is too restrictive. For example, in Docker Compose, the host is a single name with no dot, _e.g._, `backend`. ### Environment - apisix version (cmd: `apisix version`): `2.12.0` - OS (cmd: `uname -a`): `Linux 53df324263a6 5.10.76-linuxkit #1 SMP PREEMPT Mon Nov 8 11:22:26 UTC 2021 aarch64 Linux` - OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): `nginx version: openresty/1.19.9.1` - etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): `404 page not found` - apisix-dashboard version, if have: - - the plugin runner version, if the issue is about a plugin runner (cmd: depended on the kind of runner): - - luarocks version, if the issue is about installation (cmd: `luarocks --version`): - ### Steps to reproduce 1. Start APISIX 2. Enable the `proxy-mirror` plugin 3. Create a route: ```` curl -v -i http://apisix:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;methods&quot;: [&quot;GET&quot;], &quot;uris&quot;: [&quot;/hello&quot;], &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;nodes&quot;: { &quot;oldapi:8081&quot;: 1 } } &quot;plugins&quot;: { &quot;proxy-mirror&quot;: { &quot;host&quot;: &quot;http://newapi:8082&quot; } } }' ```` 4. Use the route: `curl localhost:9080/hello` ### Actual result ``` {&quot;error_msg&quot;:&quot;failed to check the configuration of plugin proxy-mirror err: property \&quot;host\&quot; validation failed: failed to match pattern \&quot;^http(s)?:\\\\\/\\\\\/[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\\\\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+(:[0-9]{1,5})?$\&quot; with \&quot;http:\/\/newapi:8082\&quot;&quot;} ``` ### Error log There's no error log ### Expected result Plugin is configured and traffic is mirrored</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>20</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix(tracing): should trace request stopped by extern plugin (#6500)</MESSAGE>
    <SHA>492f782d9fae719b3a20e0d65c275962bcdcaab9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(proxy-mirror): pattern validation Fix #6330 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>b7852a1db69097d517a8dd139247825aae1bdc0f</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/proxy-mirror.lua</FILE>
        <FILE>t/plugin/proxy-mirror.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(proxy-mirror): pattern validation Fix #6330 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>56b5852a0c8585fc4066cafa47a994d65aca07c2</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/proxy-mirror.lua</FILE>
        <FILE>t/plugin/proxy-mirror.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
