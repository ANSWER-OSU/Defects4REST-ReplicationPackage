<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8407</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/8407</ISSUEURL>
  <TITLE>Proposal: APISIX Supports Global Data Encryption</TITLE>
  <DESCRIPTION># Background Nowadays, if a plugin needs to store sensitive information, it will design a separate set of encryption mechanism, which causes the problem of repeated development and cumbersome management. Now we consider introducing Data Encryption function, hereinafter referred to as DE, to encrypt the specified information, and any module/plugin that needs to encrypt sensitive information only needs to specify the fields to be encrypted on display, so that transparent encryption/decryption can be performed when saving/reading the information. # Benefits Unify the encryption mechanism of APISIX to avoid duplication of development while improving product competitiveness # Goals APISIX provides DE functionality to support the use of this capability in plugins and elsewhere to protect sensitive information. ## The user scenarios are as follows 1. Turn on the DE function in the configuration file ```YAML apisix: enable_global_data_encryption: true ``` 2. set encrypted fields ```Ada local schema = { type = &quot;object&quot;, properties = { username = { type = &quot;string&quot; }, password = { type = &quot;string&quot;, encrypted = true }, &lt;==== Here }, required = {&quot;username&quot;, &quot;password&quot;}, } ``` 3. Set the plugin ```Shell curl http://127.0.0.1:9180/apisix/admin/consumers -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;username&quot;: &quot;foo&quot;, &quot;plugins&quot;: { &quot;basic-auth&quot;: { &quot;username&quot;: &quot;foo&quot;, &quot;password&quot;: &quot;bar&quot; &lt;= Sensitive Information } } }' ``` 4. The plugin data read directly from ETCD is encrypted ```C# etcdctl get /apisix/consumers/foo { &quot;username&quot;:&quot;foo&quot;, &quot;update_time&quot;:1668584767, &quot;create_time&quot;:1668584767, &quot;plugins&quot;:{ &quot;basic-auth&quot;:{ &quot;username&quot;:&quot;foo&quot;, &quot;password&quot;:&quot;da61c0083b6d19ef3db2490d0da96a71572da0fa&quot; &lt;= encrypted } } } ``` 5. The data surface is read normally ```Bash curl http://127.0.0.1:9180/apisix/admin/consumers -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' { &quot;list&quot;: [ { &quot;createdIndex&quot;: 8627, &quot;modifiedIndex&quot;: 8627, &quot;value&quot;: { &quot;username&quot;: &quot;foo&quot;, &quot;update_time&quot;: 1668584767, &quot;create_time&quot;: 1668584767, &quot;plugins&quot;: { &quot;basic-auth&quot;: { &quot;username&quot;: &quot;foo&quot;, &quot;password&quot;: &quot;bar&quot; &lt;= Unencrypted } } }, &quot;key&quot;: &quot;/apisix/consumers/foo&quot; } ], &quot;total&quot;: 1 } ``` # Detailed Design 1. Add a field in the configuration file to enable data encryption ```YAML apisix: data_encryption: # use `encrypted = {fields}` in plugin schema to enable encryption enable: false # If not set, the default value is `false`. keyring: - edd1c9f0985e76a2 # If not set, will save origin value into etcd. - qeddd145sfvddff3 # If set this, the keyring should be an array whose elements are string, and the size is also 16, and it will encrypt fields with AES-128-CBC # !!! So do not change it after encryption, it can't decrypt the fields have be saved if you change !! # Only use the first key to encrypt, and decrypt in the order of the array. ``` 2. Specify the fields to be encrypted in the schema of the plugin ```Ada local consumer_schema = { type = &quot;object&quot;, title = &quot;work with consumer object&quot;, properties = { username = { type = &quot;string&quot; }, password = { type = &quot;string&quot;, encrypted = true }, &lt;===== here }, required = {&quot;username&quot;, &quot;password&quot;}, } local schema = { } ``` 3. If data encryption is enabled, the corresponding fields of the following plugins will be encrypted ```Bash jwt-auth：secret，private_key basic-auth：password authz-keycloak：client_secret authz-casdoor：client_secret openid-connect：client_secret hmac-auth: secret_key csrf：key rocketmq-logger：secret_key clickhouse-logger：password error-log-logger：clickhouse.password sls-logger：access_key_secret google-cloud-logging：auth_config.private_key elasticsearch-logger：auth.password tencent-cloud-cls：secret_key kafka-proxy：sasl.password ``` 4. Encryption and Decryption - Commonly used algorithms AES, ChaCha20, we use AES128CBC encryption algorithm, the logic is the same as ssl encryption and decryption, that is, only use the first key to encrypt, if it fails to take turns to use all keys to decrypt, consider reusing the ssl encryption and decryption function （https://github.com/apache/apisix/blob/master/apisix/ssl.lua） - Currently, only those distributed through the apisix admin interface can be encrypted. Many users have developed their own admin and directly manipulated storage media such as etcd, so they need to implement the encryption function themselves. - After the encryption function is enabled, the data that was not encrypted needs to be sent down again through the interface in order to be encrypted, is a refresh interface provided? Consider not providing it for now - Combining the above, the original string is used directly after decryption failure - Admin now only uses etcd, considering that the first version only supports etcd and only supports encryption of plugin parameters - Encryption： Add encryption and decryption to check_single_plugin_schema, note that there are 2 different types of schema within the plugin, namely: schema and consumer_schema ```Lua local function check_single_plugin_schema(name, plugin_conf, schema_type, skip_disabled_plugin, encrypt_or_decrypt) ... if plugin_obj.check_schema then ... end if schema_type == core.schema.TYPE_CONSUMER then ok, err = encrypt(plugin_conf, plugin_obj.consumer_schema, encrypt_or_decrypt) else ok, err = encrypt(plugin_conf, plugin_obj.schema, encrypt_or_decrypt) end return true end ``` The encryption and decryption function iterates through the corresponding schema, and if it finds the encrypted = true field, it encrypts and decrypts the field in the corresponding configuration ```Lua local function encrypt(plugin_conf, schema, encrypt_or_decrypt) if schema.type == &quot;object&quot; then for name, obj in pairs(schema.properties) do encrypt(plugin_conf[name], obj, encrypt_or_decrypt) end elseif schema.type = &quot;array&quot; then ... end if schema.encrypted then aes128(plugin_conf) end end ``` Add corresponding options in check_schema and stream_check_schema, now directly called in admin, no need to modify, encrypt_or_decrypt is nil by default, i.e. encrypt ```Lua local function check_schema(plugins_conf, schema_type, skip_disabled_plugin, encrypt_or_decrypt) for name, plugin_conf in pairs(plugins_conf) do local ok, err = check_single_plugin_schema(name, plugin_conf, schema_type, skip_disabled_plugin, encrypt_or_decrypt) if not ok then return false, err end end return true end ``` plugin_checker and stream_plugin_checker are used for checksumming when reading data from etcd, and are decrypted by default ```Ada function _M.plugin_checker(item, schema_type) if item.plugins then return check_schema(item.plugins, schema_type, true, decrypt) &lt;=== decrypt end return true end ```</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>refactor(env): rename funtion name (#8426) Co-authored-by: soulbird &lt;zhaothree@gmail.com&gt;</MESSAGE>
    <SHA>bd6cbef5e53e7127d6393c8013d66c60a3c1677e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: support global data encryption of secret information (#8403) Fixes https://github.com/apache/apisix/issues/8407</MESSAGE>
      <SHA>3d5128de4dde90dc53443cccecc04723962f3831</SHA>
      <PATCHEDFILES>
        <FILE>apisix/admin/init.lua</FILE>
        <FILE>apisix/admin/plugins.lua</FILE>
        <FILE>apisix/admin/utils.lua</FILE>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>apisix/plugins/basic-auth.lua</FILE>
        <FILE>apisix/plugins/clickhouse-logger.lua</FILE>
        <FILE>apisix/plugins/key-auth.lua</FILE>
        <FILE>apisix/ssl.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>docs/en/latest/plugin-develop.md</FILE>
        <FILE>docs/en/latest/plugins/basic-auth.md</FILE>
        <FILE>docs/en/latest/plugins/clickhouse-logger.md</FILE>
        <FILE>docs/en/latest/plugins/key-auth.md</FILE>
        <FILE>docs/zh/latest/plugin-develop.md</FILE>
        <FILE>docs/zh/latest/plugins/basic-auth.md</FILE>
        <FILE>docs/zh/latest/plugins/clickhouse-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/key-auth.md</FILE>
        <FILE>t/admin/plugins.t</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/node/data_encrypt.t</FILE>
        <FILE>t/node/data_encrypt2.t</FILE>
        <FILE>t/plugin/clickhouse-logger.t</FILE>
        <FILE>t/plugin/error-log-logger-clickhouse.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: data encryption support more plugins (#8487) Fixes https://github.com/apache/apisix/issues/8407</MESSAGE>
      <SHA>152ea80e2e5aeafe62bd4358179351e017a0171e</SHA>
      <PATCHEDFILES>
        <FILE>apisix/admin/init.lua</FILE>
        <FILE>apisix/admin/plugin_metadata.lua</FILE>
        <FILE>apisix/admin/utils.lua</FILE>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>apisix/plugins/authz-casdoor.lua</FILE>
        <FILE>apisix/plugins/authz-keycloak.lua</FILE>
        <FILE>apisix/plugins/basic-auth.lua</FILE>
        <FILE>apisix/plugins/clickhouse-logger.lua</FILE>
        <FILE>apisix/plugins/csrf.lua</FILE>
        <FILE>apisix/plugins/elasticsearch-logger.lua</FILE>
        <FILE>apisix/plugins/error-log-logger.lua</FILE>
        <FILE>apisix/plugins/google-cloud-logging.lua</FILE>
        <FILE>apisix/plugins/hmac-auth.lua</FILE>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
        <FILE>apisix/plugins/kafka-proxy.lua</FILE>
        <FILE>apisix/plugins/key-auth.lua</FILE>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
        <FILE>apisix/plugins/rocketmq-logger.lua</FILE>
        <FILE>apisix/plugins/sls-logger.lua</FILE>
        <FILE>apisix/plugins/tencent-cloud-cls.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>docs/en/latest/plugin-develop.md</FILE>
        <FILE>docs/en/latest/plugins/authz-casdoor.md</FILE>
        <FILE>docs/en/latest/plugins/authz-keycloak.md</FILE>
        <FILE>docs/en/latest/plugins/basic-auth.md</FILE>
        <FILE>docs/en/latest/plugins/clickhouse-logger.md</FILE>
        <FILE>docs/en/latest/plugins/csrf.md</FILE>
        <FILE>docs/en/latest/plugins/elasticsearch-logger.md</FILE>
        <FILE>docs/en/latest/plugins/error-log-logger.md</FILE>
        <FILE>docs/en/latest/plugins/google-cloud-logging.md</FILE>
        <FILE>docs/en/latest/plugins/hmac-auth.md</FILE>
        <FILE>docs/en/latest/plugins/jwt-auth.md</FILE>
        <FILE>docs/en/latest/plugins/kafka-proxy.md</FILE>
        <FILE>docs/en/latest/plugins/key-auth.md</FILE>
        <FILE>docs/en/latest/plugins/openid-connect.md</FILE>
        <FILE>docs/en/latest/plugins/rocketmq-logger.md</FILE>
        <FILE>docs/en/latest/plugins/sls-logger.md</FILE>
        <FILE>docs/en/latest/plugins/tencent-cloud-cls.md</FILE>
        <FILE>docs/zh/latest/plugin-develop.md</FILE>
        <FILE>docs/zh/latest/plugins/authz-casdoor.md</FILE>
        <FILE>docs/zh/latest/plugins/authz-keycloak.md</FILE>
        <FILE>docs/zh/latest/plugins/basic-auth.md</FILE>
        <FILE>docs/zh/latest/plugins/clickhouse-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/csrf.md</FILE>
        <FILE>docs/zh/latest/plugins/elasticsearch-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/error-log-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/google-cloud-logging.md</FILE>
        <FILE>docs/zh/latest/plugins/hmac-auth.md</FILE>
        <FILE>docs/zh/latest/plugins/jwt-auth.md</FILE>
        <FILE>docs/zh/latest/plugins/key-auth.md</FILE>
        <FILE>docs/zh/latest/plugins/openid-connect.md</FILE>
        <FILE>docs/zh/latest/plugins/rocketmq-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/sls-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/tencent-cloud-cls.md</FILE>
        <FILE>t/admin/plugins.t</FILE>
        <FILE>t/plugin/authz-casdoor.t</FILE>
        <FILE>t/plugin/authz-keycloak3.t</FILE>
        <FILE>t/plugin/csrf.t</FILE>
        <FILE>t/plugin/elasticsearch-logger.t</FILE>
        <FILE>t/plugin/error-log-logger-clickhouse.t</FILE>
        <FILE>t/plugin/google-cloud-logging2.t</FILE>
        <FILE>t/plugin/hmac-auth3.t</FILE>
        <FILE>t/plugin/jwt-auth3.t</FILE>
        <FILE>t/plugin/kafka-proxy.t</FILE>
        <FILE>t/plugin/openid-connect2.t</FILE>
        <FILE>t/plugin/rocketmq-logger2.t</FILE>
        <FILE>t/plugin/sls-logger.t</FILE>
        <FILE>t/plugin/tencent-cloud-cls.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
