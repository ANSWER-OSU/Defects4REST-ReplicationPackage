<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1798</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/1798</ISSUEURL>
  <TITLE>bug: failed to set server peer when upstreams.node is address in apisix.yaml</TITLE>
  <DESCRIPTION>### Issue description [apisix/init.lua#L316](https://github.com/apache/incubator-apisix/blob/e6e387a1c5e352cff4645f9da08bc580eb2ba1c2/apisix/init.lua#L316) `local upstreams_etcd = core.config.fetch_created_obj(&quot;/upstreams&quot;)` No key named &quot;/upstreams&quot; in apisix.yaml, then upstreams_etcd == nil [apisix/core/config_yaml.lua#269](https://github.com/apache/incubator-apisix/blob/e6e387a1c5e352cff4645f9da08bc580eb2ba1c2/apisix/core/config_yaml.lua#L269) ``` if key then key = sub_str(key, 2) end ``` [apisix/core/config_yaml.lua#314](https://github.com/apache/incubator-apisix/blob/e6e387a1c5e352cff4645f9da08bc580eb2ba1c2/apisix/core/config_yaml.lua#L314) ``` function _M.fetch_created_obj(key) return created_obj[key] end ``` It remove &quot;/&quot; in _M.new() but not remove in _M.fetch_created_obj() ### Environment * apisix version (cmd: `apisix version`): * OS: 1.3 ### Minimal test code / Steps to reproduce the issue apisix.yaml ``` routes: - desc: httpbin plugins: proxy-rewrite: scheme: https priority: 0 service_id: 101 uri: &quot;/get&quot; services: - id: 101 desc: httpbin plugins: {} upstream_id: 1 upstreams: - id: 1 desc: httpbin enable_websocket: false hash_on: vars nodes: httpbin.org:443: 1 type: roundrobin ``` ### What's the actual result? (including assertion message &amp; call stack if applicable) http://***:9080/get ``` &lt;html&gt; &lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt; &lt;body&gt; &lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt; &lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt; &lt;/body&gt; &lt;/html&gt; ``` error.log ``` 2020/07/03 06:02:38 [error] 16#16: *5414 [lua] balancer.lua:310: load_balancer(): failed to set server peer [httpbin.org:443] err: no host allowed while connecting to upstream, client: 10.6.7.104, server: , request: &quot;GET /get?api=1 HTTP/1.1&quot;, host: &quot;***:9080&quot; ```</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>bugfix: wrong counter was used, resulting in only one certificate working fine. (#1818) Fix #1817</MESSAGE>
    <SHA>e598e6fa6aa71fcdfab99aff8eb24acce37d257a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>bugfix: failed to set server peer when upstreams.node is address in apisix.yaml (#1824) Fix #1798</MESSAGE>
      <SHA>54abe58315c1143cf1cfb23c7c93b26321b6a11e</SHA>
      <PATCHEDFILES>
        <FILE>apisix/core/config_yaml.lua</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>t/config-center-yaml/route-upstream.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
