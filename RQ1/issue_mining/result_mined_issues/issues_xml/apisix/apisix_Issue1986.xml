<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1986</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/1986</ISSUEURL>
  <TITLE>bug: plugins limit-conn repeatedly leaving key</TITLE>
  <DESCRIPTION>### Issue description When configuring the limit-conn plugin for both global and route rules, ctx.limit_conn,ctx.limit_conn_key, ctx.limit_conn_delay will be override. in log phase, Repeatedly releasing route key and global rule key not release ### Environment * apisix version (cmd: `apisix version`):1.4 * OS:centos8.1 ### Minimal test code / Steps to reproduce the issue 1. configure the limit-conn plugin for both global and route rules 2. Access trigger upper global limmit conn bound 3. Follow-up requests are all denied route-config ``` &quot;plugins&quot;:{ &quot;anti-replay&quot;:{ &quot;validperiod&quot;:300, &quot;enable&quot;:false }, &quot;proxy-rewrite&quot;:{ &quot;uri&quot;:&quot;/enlink/api/client/conf/v2/qrList&quot;, &quot;scheme&quot;:&quot;https&quot; }, &quot;limit-conn&quot;:{ &quot;conn&quot;:10, &quot;rejected_code&quot;:510, &quot;burst&quot;:10, &quot;default_conn_delay&quot;:1, &quot;key&quot;:&quot;remote_addr&quot; } } ``` global-config ``` { &quot;value&quot;:{ &quot;plugins&quot;:{ &quot;limit-conn&quot;:{ &quot;conn&quot;:50, &quot;burst&quot;:2, &quot;rejected_code&quot;:550, &quot;key&quot;:&quot;remote_addr&quot;, &quot;default_conn_delay&quot;:1 } }, &quot;id&quot;:&quot;f82088a019d34f929e552d44a23555ff&quot; }, &quot;createdIndex&quot;:204, &quot;key&quot;:&quot;/apisix/global_rules/f82088a019d34f929e552d44a23555ff&quot;, &quot;modifiedIndex&quot;:204 } ``` ### What's the actual result? (including assertion message &amp; call stack if applicable) Follow-up requests are all denied ### What's the expected result? normal access</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>bugfix: support parameter way to match request in route. (#2012) fix #2008</MESSAGE>
    <SHA>05f30e1e157ee6fdf37dac3fa1517f6e792df51d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>bugfix: used a table array to store the `status`, allow the plugin can (#1994) be called multiple times. fix #1986</MESSAGE>
      <SHA>31f744580d7026e2e8ce2d2500e3e7af01b295f7</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/limit-conn.lua</FILE>
        <FILE>t/plugin/limit-conn.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
