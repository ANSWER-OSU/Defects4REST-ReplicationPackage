<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4057</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/4057</ISSUEURL>
  <TITLE>bug: setting an empty global rule stops route plugins from running?</TITLE>
  <DESCRIPTION>### Issue description See steps to reproduce. ### Environment * apisix version (cmd: `apisix version`): 2.5 * OS (cmd: `uname -a`): Ubuntu 18.04 * OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): 1.19.3.1 * etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): 3.4.0 * apisix-dashboard version, if have: ### Minimal test code / Steps to reproduce the issue 1. Create a global rule with an empty map of plugins ``` local code, body = t('/apisix/admin/global_rules/1', ngx.HTTP_PUT, [[{ &quot;plugins&quot;: {} }]] ) ``` 2. Create a route, enable prometheus ``` local code, body = t('/apisix/admin/routes/1', ngx.HTTP_PUT, [[{ &quot;plugins&quot;: { &quot;prometheus&quot;: {} }, &quot;upstream&quot;: { &quot;nodes&quot;: { &quot;127.0.0.1:1980&quot;: 1 }, &quot;type&quot;: &quot;roundrobin&quot; }, &quot;uri&quot;: &quot;/hello&quot; }]] ) ``` 3. Request `/hello`. 4. Get prometheus metrics. ### What's the actual result? (including assertion message &amp; call stack if applicable) The `/hello` request is not counted by apisix_http_status. In fact, it never entered log phase of exporter.lua. ### What's the expected result? Prometheus plugin should work as normal.</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>10</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ci: cancel duplicate workflow to reduce CI queue time (#4050)</MESSAGE>
    <SHA>0a8670041a6e9ea51f808c60bd4f375f656900e8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: avoid being taint by empty global rule Fix #4057 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>9e37243513880800c4d5a00c6fa30280a8efa769</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/node/global-rule.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: avoid being taint by empty global rule Fix #4057 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>7b6e19d0c1d279dcf473767445ee02104a734f85</SHA>
      <PATCHEDFILES>
        <FILE>apisix/api_router.lua</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/node/global-rule.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
