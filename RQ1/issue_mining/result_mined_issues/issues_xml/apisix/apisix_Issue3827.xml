<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3827</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3827</ISSUEURL>
  <TITLE>bug: the duration recorded by the zipkin plugin does not match the phase</TITLE>
  <DESCRIPTION>### Issue description The duration recorded by the zipkin plugin does not match the phase. May The plugin should be executed last, not first. ### Minimal test code / Steps to reproduce the issue add ngx.sleep() at some other plugin's rewrite phase, the duration of access phase will be longer, instead of rewrite phase.</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>8</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: update plugin-develop.md (#3862) I still think we should try our best to prevent modifying APISIX itself. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>1064e2d4b7edcc6f590ca69dc34a100ae6bbc12c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>change(zipkin): rearrange the child span If you need to be compatible with the old one, you can set the span_type to 1. Fix #3827 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>129796256516f97ce71459110af3a27ed210987e</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/zipkin.lua</FILE>
        <FILE>docs/en/latest/plugins/zipkin.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/plugin/zipkin.t</FILE>
        <FILE>t/plugin/zipkin2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>change(zipkin): rearrange the child span If you need to be compatible with the old one, you can set the span_version to 1. Fix #3827 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>8df4cf951cb14c034bcc89e0cd42b9f2f91cf545</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/zipkin.lua</FILE>
        <FILE>docs/en/latest/plugins/zipkin.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/plugin/zipkin.t</FILE>
        <FILE>t/plugin/zipkin2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>change(zipkin): rearrange the child span If you need to be compatible with the old one, you can set the span_version to 1. Fix #3827 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>54afe42f550d571d3fa17a066cd205a611a8a139</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/zipkin.lua</FILE>
        <FILE>docs/en/latest/plugins/zipkin.md</FILE>
        <FILE>docs/zh/latest/plugins/zipkin.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/plugin/zipkin.t</FILE>
        <FILE>t/plugin/zipkin2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>change(zipkin): rearrange the child span (#3877) Fix #3827</MESSAGE>
      <SHA>116deb2f367f3ee68e3e237b9d334b916fd8287a</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/zipkin.lua</FILE>
        <FILE>docs/en/latest/plugins/zipkin.md</FILE>
        <FILE>docs/zh/latest/plugins/zipkin.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/plugin/zipkin.t</FILE>
        <FILE>t/plugin/zipkin2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
