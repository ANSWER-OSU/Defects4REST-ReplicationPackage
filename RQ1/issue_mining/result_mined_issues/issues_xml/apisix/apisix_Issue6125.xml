<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6125</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/6125</ISSUEURL>
  <TITLE>enhancement: the ip-restriction can not work if we use mutil-level angent</TITLE>
  <DESCRIPTION>### Issue description the ip-restriction can not work if we use mutil-level angent,because it useses ctx.var.remote_addr,this can olny fetch the ip adress of upper level like lsb ### Environment - apisix version (cmd: `apisix version`): - OS (cmd: `uname -a`): - OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): - etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): - apisix-dashboard version, if have: - the plugin runner version, if the issue is about a plugin runner (cmd: depended on the kind of runner): - luarocks version, if the issue is about installation (cmd: `luarocks --version`): ### Steps to reproduce 1、use a SLB in front of apisix 2、enable ip-restriction plugin 3、the SLB olny fetch the slb's ip ,so it can not work correctly 4、may be we can use ctx.var.http_x_forwarded_for instead ### Actual result the ip-restriction plugin can work even if we use mutil-level angent, ### Error log no error log provide ### Expected result _No response_</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: fix images in architecture-design document (#6138)</MESSAGE>
    <SHA>121b731839f9c121ddab36e8ea31913dbb2e1a45</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#6125 enhancement: the ip-restriction can not work if we use mutil-level angent we use ctx.var.http_x_forwarded_for replace the ctx.var.remote_addr</MESSAGE>
      <SHA>10f45c0531ba2adc3fcd03b3fe6729e057dd5c41</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ip-restriction/init.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #1 from hiqrf/6125 #6125 enhancement: the ip-restriction can not work if we use mutil-le…</MESSAGE>
      <SHA>d194227e0248e45e023bf29ccd6a0b10f0d792a1</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ip-restriction/init.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
