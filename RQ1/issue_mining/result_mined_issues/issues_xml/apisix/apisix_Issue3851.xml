<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3851</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3851</ISSUEURL>
  <TITLE>The upstrem configuration rewrite and upstrem_host in the traffic-split plug-in did not take effect correctly</TITLE>
  <DESCRIPTION>### Issue description 目的：想要根据分流规则，比如-H &quot;user-name:test&quot;，改变Host让流量跑到k8s集群中不同的ingress。 实现方法：使用nginx做为ingress controller，流量根据规则转向同一个k8s里的不同ingress。apisix的route中，nodes里面填的是同一个k8s集群ingress controller的地址，根据规则把upstream_host改为ingress服务的host。详细配置见下面 遇到问题：traffic-split里面的upstream通过upstream_host字段不能正确改变Host值，访问时报错404，不把upstream配在traffic-split里时没问题 ### Environment * apisix version (cmd: `apisix version`): 2.4 * OS (cmd: `uname -a`): Ubuntu 16.04.2 LTS * OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): openresty/1.19.3.1 * etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): 3.4.13 * apisix-dashboard version, if have: 2.4 ### 路由配置 ``` curl http://127.0.0.1:9080/apisix/admin/routes/10 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;uri&quot;: &quot;/route10&quot;, &quot;plugins&quot;: { &quot;traffic-split&quot;: { &quot;rules&quot;: [ { &quot;match&quot;: [ { &quot;vars&quot;: [ [&quot;http_username&quot;, &quot;==&quot;, &quot;test&quot;] ] } ], &quot;weighted_upstreams&quot;: [ { &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;pass_host&quot;: &quot;rewrite&quot;, &quot;upstream_host&quot;: &quot;echo-headers.pro.test-k8s.qslocal.com&quot;, &quot;nodes&quot;: { &quot;10.255.1.107:80&quot;:1, &quot;10.255.1.108:80&quot;:1 } } } ] } ] } }, &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;pass_host&quot;: &quot;rewrite&quot;, &quot;upstream_host&quot;: &quot;echo-headers.pro.test-k8s.qslocal.com&quot;, &quot;nodes&quot;: { &quot;10.255.1.107:80&quot;:1, &quot;10.255.1.108:80&quot;:1 } } }' ``` ### What's the actual result? (including assertion message &amp; call stack if applicable) traffic-split插件中upstream_host改变没生效，流量到不了相应host的ingress，报错404</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: update plugin-develop.md (#3862) I still think we should try our best to prevent modifying APISIX itself. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>1064e2d4b7edcc6f590ca69dc34a100ae6bbc12c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat(traffic-split): the upstream pass_host needs to support IP mode fix #3851</MESSAGE>
      <SHA>df350c5d96bb47ff34e9aeb2d7a895ef07d5acd7</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/traffic-split.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
