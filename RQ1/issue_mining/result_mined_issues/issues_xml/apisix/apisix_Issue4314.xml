<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4314</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/4314</ISSUEURL>
  <TITLE>bug: plugin hot reloading does not take effect</TITLE>
  <DESCRIPTION>### Issue description After modifying the code of the plugin, after performing the following operations according to the [plugins.md](https://github.com/apache/apisix/blob/master/docs/en/latest/plugins.md#hot-reload) document, the hot loading of the apisix plugin did not take effect. ```shell curl http://127.0.0.1:9080/apisix/admin/plugins/reload -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT ``` ### Environment Bug report without environment information will be ignored or closed. * apisix version (cmd: `apisix version`): 2.6 * OS (cmd: `uname -a`): Linux * OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): nginx version: openresty/1.19.3.1 * etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): 3.4.0 * apisix-dashboard version, if have: * luarocks version, if the issue is about installation (cmd: `luarocks --version`): 3.4.0 ### Minimal test code / Steps to reproduce the issue Bug report without steps to reproduce will be ignored or closed. 1. Modify the `limit-count` plugin code (add a warning log) ```sh --- a/apisix/plugins/limit-count.lua +++ b/apisix/plugins/limit-count.lua @@ -156,7 +156,7 @@ end function _M.access(conf, ctx) - core.log.info(&quot;ver: &quot;, ctx.conf_version) + core.log.warn(&quot;ver: &quot;, ctx.conf_version, &quot;hello world, 123456&quot;) local lim, err = core.lrucache.plugin_ctx(lrucache, ctx, conf.policy, create_limit_obj, conf) if not lim then ``` 2. Create a route and bind the plugin ```shell curl -i http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;uri&quot;: &quot;/get&quot;, &quot;plugins&quot;: { &quot;limit-count&quot;: { &quot;count&quot;: 3, &quot;time_window&quot;: 10, &quot;rejected_code&quot;: 503, &quot;key&quot;: &quot;remote_addr&quot; } }, &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;nodes&quot;: { &quot;httpbin.org:80&quot;: 1 } } }' ``` 3. Execute hot load request ```shell curl http://127.0.0.1:9080/apisix/admin/plugins/reload -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT ``` 4. Request a test ```shell curl http://127.0.0.1:9080/get -i HTTP/1.1 200 OK Content-Type: application/json Content-Length: 300 Connection: keep-alive X-RateLimit-Limit: 3 X-RateLimit-Remaining: 2 ``` 5. View the error.log log (no plugin log output) ``` 2021/05/26 22:13:18 [warn] 939867#939867: *164198 [lua] init.lua:290: sync_local_conf_to_etcd(): sync local conf to etcd, context: ngx.timer ``` 6. When the following code is commented, the plugin hot loading will take effect ```sh diff --git a/apisix/plugin.lua b/apisix/plugin.lua index 5b4337c..7be84ac 100644 --- a/apisix/plugin.lua +++ b/apisix/plugin.lua @@ -167,7 +167,7 @@ local function load(plugin_names) -- the same configure may be synchronized more than one if plugins_eq(local_plugins_hash, processed) then core.log.info(&quot;plugins not changed&quot;) - return true + -- return true end core.log.warn(&quot;new plugins: &quot;, core.json.delay_encode(processed)) ``` Repeat the above steps 3, 4, and 5, and the plug-in hot loading takes effect. ``` 2021/05/26 22:13:18 [warn] 939867#939867: *164198 [lua] init.lua:290: sync_local_conf_to_etcd(): sync local conf to etcd, context: ngx.timer 2021/05/26 22:13:31 [warn] 939868#939868: *164687 [lua] limit-count.lua:159: phase_func(): ver: 11517hello world, 123456, client: 127.0.0.1, server: _, request: &quot;GET /get HTTP/1.1&quot;, host: &quot;127.0.0.1:9080&quot; ``` ### What's the actual result? (including assertion message &amp; call stack if applicable) After the hot reload request is executed, the code of the modified plugin cannot take effect. ### What's the expected result? After the hot load request is executed, the modification of the plugin code can take effect in time.</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: release 2.6 (#4286)</MESSAGE>
    <SHA>709561afe7f7a236d5e713a8961c87ef0adca695</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: ensure the plugin is always reloaded Only trigger a reset from admin when the etcd's data is different from the one of admin. So there is no need to add check in node side. Fix #4314 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>6ff2e438d7c798e47116684d409c490eacfac3f6</SHA>
      <PATCHEDFILES>
        <FILE>apisix/admin/init.lua</FILE>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/admin/plugins-reload.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: ensure the plugin is always reloaded Only trigger a reset from admin when the etcd's data is different from the one of admin. So there is no need to add check in node side. Fix #4314 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>de379b81fec5894c14a90c1e274bf4b6124cf782</SHA>
      <PATCHEDFILES>
        <FILE>apisix/admin/init.lua</FILE>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/admin/plugins-reload.t</FILE>
        <FILE>t/config-center-yaml/plugin.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: ensure the plugin is always reloaded (#4319) * fix: ensure the plugin is always reloaded Only trigger a reset from admin when the etcd's data is different from the one of admin. So there is no need to add check in node side. Fix #4314 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt; * fix reset check Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt; * fix error handling Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt; * update test Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>3c857a8a133f8fa09c96d5b9a014a1207a1660a6</SHA>
      <PATCHEDFILES>
        <FILE>apisix/admin/init.lua</FILE>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/admin/plugins-reload.t</FILE>
        <FILE>t/config-center-yaml/plugin.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
