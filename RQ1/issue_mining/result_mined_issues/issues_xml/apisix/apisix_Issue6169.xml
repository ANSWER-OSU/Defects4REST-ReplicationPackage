<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6169</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/6169</ISSUEURL>
  <TITLE>bug: The custom labels will be lost when the route is associated with the service</TITLE>
  <DESCRIPTION>### Issue description 当路由采用和service组合方式来配置时，路由属性里面的自定义标签会丢失，日志插件无法记录到自定义的标签。 ### Environment - apisix version (cmd: `apisix version`): 2.11.0 - OS (cmd: `uname -a`): docker-centos ### Steps to reproduce 1.新增upstream如下: ``` PUT /apisix/admin/upstreams/demo { &quot;nodes&quot;: [ { &quot;host&quot;: &quot;127.0.0.1&quot;, &quot;port&quot;: 9090 } ], &quot;scheme&quot;: &quot;http&quot;, &quot;name&quot;: &quot;demo&quot; } ``` 2.新增service如下: ``` PUT /apisix/admin/services/demo { &quot;name&quot;: &quot;demo&quot;, &quot;upstream_id&quot;: &quot;demo&quot; } ``` 3.新增route如下: ``` PUT /apisix/admin/route/demo { &quot;uris&quot;: [ &quot;/demo&quot; ], &quot;name&quot;: &quot;demo&quot;, &quot;methods&quot;: [ &quot;GET&quot;, &quot;POST&quot;, &quot;HEAD&quot; ], &quot;service_id&quot;: &quot;demo&quot;, &quot;labels&quot;: { &quot;app_name&quot;: &quot;app_demo&quot;, &quot;system_name&quot;: &quot;system_demo&quot; }, &quot;status&quot;: 1 } ``` 4.在requests-id插件里面新增日志阶段函数，内容如下: ``` function _M.log(conf, ctx) core.log.warn(&quot;ctx.matched_route.value: &quot;, core.json.delay_encode(ctx.matched_route.value)) end ``` 5.重载APISIX，请求该路由，查看日志，会发现`ctx.matched_route.value`打印的内容里面没有label相关内容. 6. 如果是使用 route直接关联 upstream的方式来添加路由，`ctx.matched_route.value` 里面会有label内容，应该是 route 和 service 的 配置 merge 的时候漏了. ### Actual result null ### Error log null ### Expected result _No response_</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix(makefile): fix Makefile `install` don't install discovery folder (#6158)</MESSAGE>
    <SHA>e9fab8b2e5b5cb79a302faf8b5c9752766681c63</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: add missing labels after merging route and service Closes #6169 Signed-off-by: tzssangglass &lt;tzssangglass@gmail.com&gt;</MESSAGE>
      <SHA>a5108d2fe23f457d0841622f03878756d63ad3dc</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/node/merge-route.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
