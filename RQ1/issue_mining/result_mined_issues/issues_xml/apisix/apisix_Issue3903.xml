<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3903</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3903</ISSUEURL>
  <TITLE>request help: Accessing ctx.var.upstream_uri in global rule causes failure of proxy-rewrite</TITLE>
  <DESCRIPTION>### Issue description Minimum steps to reproduce: 1. Add a plugin that contains this line in rewrite phase: ``` core.log.info(&quot;Access upstream uri: &quot;, ctx.var.upstream_uri) ``` 2. Add the plugin to global rule. 3. Add a route like this: ``` &quot;uri&quot;: &quot;/hello&quot;, &quot;plugins&quot;: { &quot;proxy-rewrite&quot;: { &quot;uri&quot;: &quot;/world&quot; } } ``` 4. Hit `/hello`, observe that it won't be rewritten to `/world` Essentially after ctx.var.upstream_uri is set in proxy-rewrite, it fails to be updated in ngx.var, given that we read the value ctx.var.upstream_uri in global rule. The case was found in APISIX 2.0 so it might not apply to the current master version (I can see that init.lua has changed a lot). If someone know the root cause of this I'd be grateful to be enlightened. ### Environment * apisix version (cmd: `apisix version`): 2.0 * OS (cmd: `uname -a`): osx &amp; ubuntu * OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): 1.15.8 * etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): 3.4.9 * apisix-dashboard version, if have: N/A</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>21</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: add Slack to the communication channels (#3627)</MESSAGE>
    <SHA>63a6239a68e384fc0001c0675285826287174de9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: new way to cache ctx.var Fix #3903 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>8ba547ecbb449a1f6b2eba6dd043d4547fff17f1</SHA>
      <PATCHEDFILES>
        <FILE>apisix/core/ctx.lua</FILE>
        <FILE>t/core/ctx2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
