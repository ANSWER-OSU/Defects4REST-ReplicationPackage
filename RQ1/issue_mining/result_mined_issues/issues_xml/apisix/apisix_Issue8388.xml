<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8388</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/8388</ISSUEURL>
  <TITLE>bug: external-plugin-post-resp plugin converts content-type from upstream response</TITLE>
  <DESCRIPTION>### Current Behavior Bug : external-plugin-post-resp converts reponse content types to plain/text - Json response if request sended directly to test api server ![image](https://user-images.githubusercontent.com/26168539/203705459-fccb90a2-4c55-4715-9e0b-0a4810c101d8.png) - Encoded to plain/text if request sended via apisix upstream ![image](https://user-images.githubusercontent.com/26168539/203719724-5ccb86d3-e63c-4922-85de-1c1762966039.png) ### Steps to Reproduce Testing with local apisix &amp; test api server env (apisix 3.0.0 on 9080 port , test api server with 8000 port ) - Enable ext-plugin-post-resp plugin (APISIX version &gt; 2.99) - no support in apisix dashboard(2.13) so needed to be add by admin api curl http://localhost:9180/apisix/admin/global_rules/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -i -d '{&quot;plugins&quot;:{&quot;ext-plugin-post-resp&quot;: {&quot;allow_degradation&quot;:true,&quot;conf&quot;:[{&quot;value&quot;:&quot;&quot;, &quot;name&quot;:&quot;PostResponseFilter&quot;}],&quot;disable&quot;:false}}}' Plugin Configuration ``` { &quot;allow_degradation&quot;: false, &quot;conf&quot;:[ { &quot;name&quot;: &quot;PostResponseFilter&quot;, &quot;value&quot;: &quot;&quot; } ], &quot;disable&quot;: false } ``` - Json response if request sended directly to test api server ![image](https://user-images.githubusercontent.com/26168539/203705459-fccb90a2-4c55-4715-9e0b-0a4810c101d8.png) - Encoded to plain/text if request sended via apisix upstream ![image](https://user-images.githubusercontent.com/26168539/203719724-5ccb86d3-e63c-4922-85de-1c1762966039.png) Cause many type of api servers handled by apisix, some of them don't handle http response with json automatically, I expecting apisix not to convert response types to text/plain. Any approach or opinion will be appreciated to fix this problems ### Expected Behavior Content type must be consist after handled by apisix upstream. ### Error Logs This seems to logical problem with apisix core, so no error logs included ### Environment - APISIX version (run `apisix version`): 2.99 - Operating system (run `uname -a`): RHEL 8 - OpenResty / Nginx version (run `openresty -V` or `nginx -V`): 1.21.4 - etcd version, if relevant (run `curl http://127.0.0.1:9090/v1/server_info`): 3.5.4 - APISIX Dashboard version, if relevant: 2.13.0 - Plugin runner version, for issues related to plugin runners: java 17 - LuaRocks version, for installation issues (run `luarocks --version`): 5.4.4</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>43</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: fix typo and grammatical error (#8589)</MESSAGE>
    <SHA>030019b5297268b2171df5aa661d84c3c1ab6b92</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(ext-plugin-post-resp): can't set content-type response header (#8588) Co-authored-by: soulbird &lt;zhaothree@gmail.com&gt; Fixes https://github.com/apache/apisix/issues/8388</MESSAGE>
      <SHA>91122f9e9bf12f352c103b74df3b60d7f6223841</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ext-plugin/init.lua</FILE>
        <FILE>t/lib/ext-plugin.lua</FILE>
        <FILE>t/plugin/ext-plugin/response.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
