<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>7386</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/7386</ISSUEURL>
  <TITLE>feat: Expose an option for (real_)request_uri to be used in proxy-rewrite plugin</TITLE>
  <DESCRIPTION>### Description Hello! During our tests we have noticed that APISIX always uses the normalized/decoded URI coming from nginx (as per its design, which isn't an issue), and this creates an edge case where a backend that _requires_ URL Encoded URIs to not work properly (i.e. GitLab API calls that reference paths inside a project use `%2F` instead of `/`). Looking at the codebase, we've also seen the native `request_uri` variable being moved to the `real_request_uri` variable. And because of how `proxy-rewrite`s rewrite schema work; utilizing `real_request_uri` to bypass the encoding is not possible. We know that this is a really unsafe behavior to utilize `real_request_uri` but the cost of the edge cases this causes is critical. We've copied over `proxy-rewrite` to [our downstream custom plugins repo as `proxy-rewrite-unsafe`](https://github.com/Trendyol/apisix-plugins/blob/main/plugins/proxy-rewrite-unsafe/proxy-rewrite-unsafe.lua) with our addition of the `real_request_uri` override: ```diff --- proxy-rewrite.lua 2022-07-05 09:49:53.000000000 +0300 +++ proxy-rewrite-unsafe.lua 2022-07-05 10:02:39.000000000 +0300 @@ -15,7 +15,7 @@ -- limitations under the License. -- local core = require(&quot;apisix.core&quot;) -local plugin_name = &quot;proxy-rewrite&quot; +local plugin_name = &quot;proxy-rewrite-unsafe&quot; local pairs = pairs local ipairs = ipairs local ngx = ngx @@ -40,6 +40,11 @@ local schema = { type = &quot;object&quot;, properties = { + use_real_request_uri_unsafe = { + description = &quot;use real_request_uri (request_uri in nginx), THIS IS UNSAFE.)&quot;, + type = &quot;boolean&quot;, + default = false, + }, uri = { description = &quot;new uri for upstream&quot;, type = &quot;string&quot;, @@ -161,7 +166,9 @@ end local upstream_uri = ctx.var.uri - if conf.uri ~= nil then + if conf.use_real_request_uri_unsafe then + upstream_uri = core.utils.resolve_var(&quot;$real_request_uri&quot;, ctx.var) + elseif conf.uri ~= nil then upstream_uri = core.utils.resolve_var(conf.uri, ctx.var) elseif conf.regex_uri ~= nil then local uri, _, err = re_sub(ctx.var.uri, conf.regex_uri[1], @@ -178,18 +185,22 @@ end local index = str_find(upstream_uri, &quot;?&quot;) - if index then - upstream_uri = core.utils.uri_safe_encode(sub_str(upstream_uri, 1, index-1)) .. - sub_str(upstream_uri, index) - else - upstream_uri = core.utils.uri_safe_encode(upstream_uri) + if not conf.use_real_request_uri_unsafe then + if index then + upstream_uri = core.utils.uri_safe_encode(sub_str(upstream_uri, 1, index-1)) .. + sub_str(upstream_uri, index) + else + upstream_uri = core.utils.uri_safe_encode(upstream_uri) + end end if ctx.var.is_args == &quot;?&quot; then - if index then - ctx.var.upstream_uri = upstream_uri .. &quot;&amp;&quot; .. (ctx.var.args or &quot;&quot;) - else - ctx.var.upstream_uri = upstream_uri .. &quot;?&quot; .. (ctx.var.args or &quot;&quot;) + if not conf.use_real_request_uri_unsafe then + if index then + ctx.var.upstream_uri = upstream_uri .. &quot;&amp;&quot; .. (ctx.var.args or &quot;&quot;) + else + ctx.var.upstream_uri = upstream_uri .. &quot;?&quot; .. (ctx.var.args or &quot;&quot;) + end end else ctx.var.upstream_uri = upstream_uri ``` Is it possible to expose an option on upstream like in the diff above?</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>13</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat(deployment): implement health check for conf_server (#7378) Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>a8a692d9a58a9a0185e22cfebbe2c0f000ba41f3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat(proxy-rewrite): create use_real_request_uri_unsafe option, see https://github.com/apache/apisix/issues/7386 Resolves: https://github.com/apache/apisix/issues/7386</MESSAGE>
      <SHA>4f7c4fdb36c033fc493bfd374542d5e922e83f5c</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/proxy-rewrite.lua</FILE>
        <FILE>docs/en/latest/plugins/proxy-rewrite.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/lib/toolkit</FILE>
        <FILE>t/plugin/proxy-rewrite3.t</FILE>
        <FILE>toolkit</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat(proxy-rewrite): create use_real_request_uri_unsafe option, see https://github.com/apache/apisix/issues/7386 Resolves: https://github.com/apache/apisix/issues/7386</MESSAGE>
      <SHA>c81832819764990941fec92dc556f6515b8060ca</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/proxy-rewrite.lua</FILE>
        <FILE>docs/en/latest/plugins/proxy-rewrite.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/lib/toolkit</FILE>
        <FILE>t/plugin/proxy-rewrite3.t</FILE>
        <FILE>toolkit</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat(proxy-rewrite): create use_real_request_uri_unsafe option, see https://github.com/apache/apisix/issues/7386 Resolves: https://github.com/apache/apisix/issues/7386</MESSAGE>
      <SHA>c1eb1f9fc86ade192769fde81db6fa77beda6e25</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/proxy-rewrite.lua</FILE>
        <FILE>docs/en/latest/plugins/proxy-rewrite.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/lib/toolkit</FILE>
        <FILE>t/plugin/proxy-rewrite3.t</FILE>
        <FILE>toolkit</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat(proxy-rewrite): create use_real_request_uri_unsafe option, see https://github.com/apache/apisix/issues/7386 Resolves: https://github.com/apache/apisix/issues/7386</MESSAGE>
      <SHA>5041b0f92371238086442c8ffb015a8478e8837f</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/proxy-rewrite.lua</FILE>
        <FILE>docs/en/latest/plugins/proxy-rewrite.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/lib/toolkit</FILE>
        <FILE>t/plugin/proxy-rewrite3.t</FILE>
        <FILE>toolkit</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat(proxy-rewrite): create use_real_request_uri_unsafe option, see https://github.com/apache/apisix/issues/7386 Resolves: https://github.com/apache/apisix/issues/7386</MESSAGE>
      <SHA>9382f8b5983f45c888b1ac59c1dfd0493b6c6dcd</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/proxy-rewrite.lua</FILE>
        <FILE>docs/en/latest/plugins/proxy-rewrite.md</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/plugin/proxy-rewrite3.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
