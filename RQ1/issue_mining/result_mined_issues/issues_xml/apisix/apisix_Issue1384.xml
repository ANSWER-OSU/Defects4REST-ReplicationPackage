<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1384</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/1384</ISSUEURL>
  <TITLE>bug: admin api setting upstream config `checks` , function`clean_handlers` is nil</TITLE>
  <DESCRIPTION>### Issue description upstream conf eg: ```json { &quot;desc&quot;: &quot;AUTO-aimgo-web-v1.21-passport&quot;, &quot;retries&quot;: 1, &quot;key&quot;:&quot;&quot;, &quot;hash_on&quot;: &quot;vars&quot;, &quot;enable_websocket&quot;: false, &quot;timeout&quot;: { &quot;connect&quot;: 0.5, &quot;send&quot;: 1, &quot;read&quot;: 2 }, &quot;checks&quot;: { &quot;active&quot;: { &quot;unhealthy&quot;: { &quot;http_statuses&quot;: [ 429, 404, 500, 501, 502, 503, 504, 505 ], &quot;interval&quot;: 1, &quot;timeouts&quot;: 3, &quot;http_failures&quot;: 2, &quot;tcp_failures&quot;: 2 }, &quot;type&quot;: &quot;http&quot;, &quot;http_path&quot;: &quot;/health&quot;, &quot;healthy&quot;: { &quot;successes&quot;: 1, &quot;interval&quot;: 2, &quot;http_statuses&quot;: [ 200, 302 ] }, &quot;req_headers&quot;: [ &quot;User-Agent: apisix.health,curl/7.29.0&quot; ], &quot;timeout&quot;: 1, &quot;https_verify_certificate&quot;: true, &quot;concurrency&quot;: 10 }, &quot;passive&quot;: { &quot;unhealthy&quot;: { &quot;http_failures&quot;: 3, &quot;http_statuses&quot;: [ 500, 501, 502, 503, 504, 505, 506 ], &quot;tcp_failures&quot;: 3, &quot;timeouts&quot;: 7 }, &quot;healthy&quot;: { &quot;http_statuses&quot;: [ 200, 201 ], &quot;successes&quot;: 3 }, &quot;type&quot;: &quot;http&quot; } }, &quot;nodes&quot;: { &quot;100.64.0.3:40940&quot;: 1 }, &quot;type&quot;: &quot;roundrobin&quot; } ``` first add config happen error, error info eg: ``` 2020/04/01 17:34:12 [error] 5307#0: *21439 failed to run balancer_by_lua*: /usr/local/apisix/lua/apisix/balancer.lua:106: bad argument #1 to 'insert' (table expected, got nil) stack traceback: [C]: in function 'insert' /usr/local/apisix/lua/apisix/balancer.lua:106: in function 'create_obj_fun' /usr/local/apisix/lua/apisix/core/lrucache.lua:66: in function 'lrucache_checker' /usr/local/apisix/lua/apisix/balancer.lua:127: in function 'fetch_healthchecker' /usr/local/apisix/lua/apisix/balancer.lua:248: in function 'pick_server' /usr/local/apisix/lua/apisix/balancer.lua:313: in function 'load_balancer' /usr/local/apisix/lua/apisix.lua:486: in function 'http_balancer_phase' balancer_by_lua:2: in main chunk while connecting to upstream, client: 192.168.132.181, server: , request: &quot;GET /v1/passport/hello/222 HTTP/1.1&quot;, host: &quot;web.uqudu.com:8888&quot; ``` ### Environment * apisix version (cmd: `apisix version`): master And 1.0 * OS: centos7 ### Minimal test code / Steps to reproduce the issue 1. first call admin api write upstream config after request server api error occurred. 2. restart apisix server, request server api get right 3. guess should modify code ,not restart also is success! eg: ``` lua healthcheck_parent.clean_handlers = {} upstream.parent.clean_handlers = {} ``` ### What's the actual result? (including assertion message &amp; call stack if applicable) ### What's the expected result?</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>26</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>doc: fix the doc style for serverless*.md (#1511)</MESSAGE>
    <SHA>50d2957a8a23fa26302c35a152bb593a47f3ac5e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>bugfix: init `clean_handlers` when add new item from etcd. (#1412) fix #1384</MESSAGE>
      <SHA>0f3310562c1a117f9519b8b022c6ede282cf670b</SHA>
      <PATCHEDFILES>
        <FILE>apisix/core/config_etcd.lua</FILE>
        <FILE>t/node/healthcheck.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>bugfix: init `clean_handlers` when add new item from etcd. (#1412) fix #1384</MESSAGE>
      <SHA>798cf9f9d18fd450b58f3b6fef79469dcba1e688</SHA>
      <PATCHEDFILES>
        <FILE>apisix/core/config_etcd.lua</FILE>
        <FILE>t/node/healthcheck.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
