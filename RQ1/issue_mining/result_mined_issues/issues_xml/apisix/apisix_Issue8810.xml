<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8810</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/8810</ISSUEURL>
  <TITLE>bug: mocking plugin panic when response_example contain $</TITLE>
  <DESCRIPTION>### Current Behavior lua entry thread aborted, cause http 500 response. ### Expected Behavior Should not abort. ### Error Logs ``` 2023/02/06 16:20:21 [error] 52#52: *75286 lua entry thread aborted: runtime error: /usr/local/apisix-2.13.2/apisix/core/utils.lua:298: attempt to index upvalue '_ctx' (a nil value) stack traceback: coroutine 0: /usr/local/apisix-2.13.2/apisix/core/utils.lua: in function 'replace' /usr/local/openresty/lualib/resty/core/regex.lua:1003: in function 're_gsub' /usr/local/apisix-2.13.2/apisix/core/utils.lua:319: in function 'resolve_var' /usr/local/apisix-2.13.2/apisix/plugins/mocking.lua:221: in function 'phase_func' /usr/local/apisix-2.13.2/apisix/plugin.lua:748: in function 'run_plugin' /usr/local/apisix-2.13.2/apisix/init.lua:481: in function 'http_access_phase' access_by_lua(nginx.conf:300):2: in main chunk ``` ### Steps to Reproduce config mocking like: ```yaml routes: - uri: /hello upstream: nodes: &quot;127.0.0.1:1980&quot;: 1 type: roundrobin plugins: mocking: response_example: '{&quot;$a&quot;:1}' ``` ### Environment - APISIX version (run `apisix version`): master branch - Operating system (run `uname -a`): - OpenResty / Nginx version (run `openresty -V` or `nginx -V`): - etcd version, if relevant (run `curl http://127.0.0.1:9090/v1/server_info`): - APISIX Dashboard version, if relevant: - Plugin runner version, for issues related to plugin runners: - LuaRocks version, for installation issues (run `luarocks --version`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>364</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: fix global-rule.md wrong curl address (#8793)</MESSAGE>
    <SHA>5984321c34d3cdc90573ebbecfd17ba9082fb3ba</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: mocking plugin panic when response_example contain $ (#8810)</MESSAGE>
      <SHA>8a494d5f515f2be500c1ac736b41bbad8c8a9ba8</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/mocking.lua</FILE>
        <FILE>t/plugin/mocking.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: mocking plugin panic when response_example contain $ (#8810)</MESSAGE>
      <SHA>e72ea8fe8c55a5c782eef6f38fc1ce7c9d848925</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/mocking.lua</FILE>
        <FILE>docs/en/latest/plugins/mocking.md</FILE>
        <FILE>docs/zh/latest/plugins/mocking.md</FILE>
        <FILE>t/plugin/mocking.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: mocking plugin panic when response_example contain $ (#8810)</MESSAGE>
      <SHA>0efa5614575d4e1cf492fc542894f53e04fc8459</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/mocking.lua</FILE>
        <FILE>docs/en/latest/plugins/mocking.md</FILE>
        <FILE>docs/zh/latest/plugins/mocking.md</FILE>
        <FILE>t/plugin/mocking.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: mocking plugin panic when response_example contain $ (#8810) (#8816) Co-authored-by: roketyyang &lt;roketyyang@tencent.com&gt;</MESSAGE>
      <SHA>240e730a293287ec456c90d1c4fb99c3f54e8bda</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/mocking.lua</FILE>
        <FILE>docs/en/latest/plugins/mocking.md</FILE>
        <FILE>docs/zh/latest/plugins/mocking.md</FILE>
        <FILE>t/plugin/mocking.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge branch 'upstream/master' into github/master * upstream/master: docs: change the file name to 'create-ssl.py'.If 'ssl.py' is used as â€¦ (#8623) feat: Body transformer plugin (#8766) fix: mocking plugin panic when response_example contain $ (#8810) (#8816) feat: file logger plugin support response body in variable (#8711) docs(getting-started): rewrite the install section (#8807) feat: allow each logger to define custom log format in its conf (#8806) fix(etcd): reloaded data may be in res.body.node (#8736) fix: fix fetch all service info from consul (#8651) docs: fix global-rule.md wrong curl address (#8793) feat: stream subsystem support consul service discovery (#8696) chore(kafka-logger): support configuration `meta_refresh_interval` parameter (#8762) feat: ready to release 2.15.2 (#8783)</MESSAGE>
      <SHA>a7e20e7b9f142e8794fc4cc086dc2b99be4972f8</SHA>
      <PATCHEDFILES>
        <FILE>CHANGELOG.md</FILE>
        <FILE>apisix/core/config_etcd.lua</FILE>
        <FILE>apisix/core/ctx.lua</FILE>
        <FILE>apisix/discovery/consul/init.lua</FILE>
        <FILE>apisix/plugins/body-transformer.lua</FILE>
        <FILE>apisix/plugins/clickhouse-logger.lua</FILE>
        <FILE>apisix/plugins/elasticsearch-logger.lua</FILE>
        <FILE>apisix/plugins/file-logger.lua</FILE>
        <FILE>apisix/plugins/google-cloud-logging.lua</FILE>
        <FILE>apisix/plugins/http-logger.lua</FILE>
        <FILE>apisix/plugins/kafka-logger.lua</FILE>
        <FILE>apisix/plugins/loggly.lua</FILE>
        <FILE>apisix/plugins/mocking.lua</FILE>
        <FILE>apisix/plugins/rocketmq-logger.lua</FILE>
        <FILE>apisix/plugins/skywalking-logger.lua</FILE>
        <FILE>apisix/plugins/sls-logger.lua</FILE>
        <FILE>apisix/plugins/splunk-hec-logging.lua</FILE>
        <FILE>apisix/plugins/syslog.lua</FILE>
        <FILE>apisix/plugins/tcp-logger.lua</FILE>
        <FILE>apisix/plugins/tencent-cloud-cls.lua</FILE>
        <FILE>apisix/plugins/udp-logger.lua</FILE>
        <FILE>apisix/stream/plugins/syslog.lua</FILE>
        <FILE>apisix/utils/log-util.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>docs/en/latest/apisix-variable.md</FILE>
        <FILE>docs/en/latest/certificate.md</FILE>
        <FILE>docs/en/latest/config.json</FILE>
        <FILE>docs/en/latest/discovery/consul.md</FILE>
        <FILE>docs/en/latest/getting-started.md</FILE>
        <FILE>docs/en/latest/mtls.md</FILE>
        <FILE>docs/en/latest/plugins/body-transformer.md</FILE>
        <FILE>docs/en/latest/plugins/clickhouse-logger.md</FILE>
        <FILE>docs/en/latest/plugins/elasticsearch-logger.md</FILE>
        <FILE>docs/en/latest/plugins/file-logger.md</FILE>
        <FILE>docs/en/latest/plugins/google-cloud-logging.md</FILE>
        <FILE>docs/en/latest/plugins/http-logger.md</FILE>
        <FILE>docs/en/latest/plugins/kafka-logger.md</FILE>
        <FILE>docs/en/latest/plugins/loggly.md</FILE>
        <FILE>docs/en/latest/plugins/mocking.md</FILE>
        <FILE>docs/en/latest/plugins/rocketmq-logger.md</FILE>
        <FILE>docs/en/latest/plugins/skywalking-logger.md</FILE>
        <FILE>docs/en/latest/plugins/sls-logger.md</FILE>
        <FILE>docs/en/latest/plugins/splunk-hec-logging.md</FILE>
        <FILE>docs/en/latest/plugins/syslog.md</FILE>
        <FILE>docs/en/latest/plugins/tcp-logger.md</FILE>
        <FILE>docs/en/latest/plugins/tencent-cloud-cls.md</FILE>
        <FILE>docs/en/latest/plugins/udp-logger.md</FILE>
        <FILE>docs/en/latest/terminology/global-rule.md</FILE>
        <FILE>docs/zh/latest/CHANGELOG.md</FILE>
        <FILE>docs/zh/latest/apisix-variable.md</FILE>
        <FILE>docs/zh/latest/certificate.md</FILE>
        <FILE>docs/zh/latest/getting-started.md</FILE>
        <FILE>docs/zh/latest/mtls.md</FILE>
        <FILE>docs/zh/latest/plugins/clickhouse-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/elasticsearch-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/file-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/google-cloud-logging.md</FILE>
        <FILE>docs/zh/latest/plugins/http-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/kafka-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/loggly.md</FILE>
        <FILE>docs/zh/latest/plugins/mocking.md</FILE>
        <FILE>docs/zh/latest/plugins/rocketmq-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/skywalking-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/sls-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/splunk-hec-logging.md</FILE>
        <FILE>docs/zh/latest/plugins/syslog.md</FILE>
        <FILE>docs/zh/latest/plugins/tcp-logger.md</FILE>
        <FILE>docs/zh/latest/plugins/tencent-cloud-cls.md</FILE>
        <FILE>docs/zh/latest/plugins/udp-logger.md</FILE>
        <FILE>docs/zh/latest/terminology/global-rule.md</FILE>
        <FILE>rockspec/apisix-2.15.2-0.rockspec</FILE>
        <FILE>t/admin/plugins.t</FILE>
        <FILE>t/core/config_etcd.t</FILE>
        <FILE>t/discovery/consul_dump.t</FILE>
        <FILE>t/discovery/stream/consul.t</FILE>
        <FILE>t/plugin/body-transformer.t</FILE>
        <FILE>t/plugin/clickhouse-logger.t</FILE>
        <FILE>t/plugin/elasticsearch-logger.t</FILE>
        <FILE>t/plugin/file-logger.t</FILE>
        <FILE>t/plugin/file-logger2.t</FILE>
        <FILE>t/plugin/google-cloud-logging2.t</FILE>
        <FILE>t/plugin/http-logger-log-format.t</FILE>
        <FILE>t/plugin/kafka-logger-log-format.t</FILE>
        <FILE>t/plugin/kafka-logger2.t</FILE>
        <FILE>t/plugin/loggly.t</FILE>
        <FILE>t/plugin/mocking.t</FILE>
        <FILE>t/plugin/rocketmq-logger-log-format.t</FILE>
        <FILE>t/plugin/skywalking-logger.t</FILE>
        <FILE>t/plugin/sls-logger.t</FILE>
        <FILE>t/plugin/splunk-hec-logging.t</FILE>
        <FILE>t/plugin/syslog.t</FILE>
        <FILE>t/plugin/tcp-logger.t</FILE>
        <FILE>t/plugin/tencent-cloud-cls.t</FILE>
        <FILE>t/plugin/udp-logger.t</FILE>
        <FILE>t/stream-plugin/syslog.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
