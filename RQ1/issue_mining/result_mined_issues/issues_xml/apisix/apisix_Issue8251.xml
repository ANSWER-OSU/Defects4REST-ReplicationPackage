<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8251</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/8251</ISSUEURL>
  <TITLE>bug: built-in variables are not supported in `_meta.filter`</TITLE>
  <DESCRIPTION>### Current Behavior The filters in the plugin support only Nginx variables, not APISIX's built-in variables. For example, I can use the Nginx variable `http_xxx`, but I can't use APISIX custom variables like `arg_xxxx` or `graphql_xxxx`. ### Expected Behavior It can support all APISIX variable syntax, including `cookie_xxxx`, `arg_xxxx`, `post_arg_xxxx`, `graphql_xxxx`, etc. ### Error Logs _No response_ ### Steps to Reproduce 1. Set the filter in the plugin to use the above unsupported syntax. ------------- **The reason is that we didn't pass in our ctx for that expr executor, and the expr uses its default `ngx.var`, which wouldn't support extended syntax.** https://github.com/apache/apisix/blob/master/apisix/plugin.lua#L437 https://github.com/api7/lua-resty-expr/blob/main/lib/resty/expr/v1.lua#L376 We just need to change it to `ok, err = ex:eval(ctx.var)` and it will support those extended syntaxes. ### Environment - APISIX version (run `apisix version`): 3.0.0</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: support connect etcd with ipv6 address (#8245) Fixes https://github.com/apache/apisix/issues/7100</MESSAGE>
    <SHA>4a8a91d63a4ee1ae9f0e1fc7a438124e1380fdbb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: APISIX extended variables cannot be used in `_meta.filter` (#8256) Co-authored-by: soulbird &lt;zhaothree@gmail.com&gt; Fixes https://github.com/apache/apisix/issues/8251</MESSAGE>
      <SHA>4c533ba3557acce5e81b4dfab82ac1faa3679dfa</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/plugin/plugin.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: APISIX extended variables cannot be used in `_meta.filter` (#8256) Co-authored-by: soulbird &lt;zhaothree@gmail.com&gt; Fixes https://github.com/apache/apisix/issues/8251</MESSAGE>
      <SHA>f8fdcc7010e674275f89719001fb9e3112c985a4</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/plugin/plugin.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: APISIX extended variables cannot be used in `_meta.filter` (#8256) Co-authored-by: soulbird &lt;zhaothree@gmail.com&gt; Fixes https://github.com/apache/apisix/issues/8251</MESSAGE>
      <SHA>c020f0eb06e0d011eebc7564632286e9574c8834</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>t/plugin/plugin.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
