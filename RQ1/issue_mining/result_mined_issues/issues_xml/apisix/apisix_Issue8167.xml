<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8167</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/8167</ISSUEURL>
  <TITLE>bug: proxy-rewrite and proxy-mirror do not work together</TITLE>
  <DESCRIPTION>### Current Behavior The route configuration (omitted some irrelevant content): ``` { &quot;uri&quot;: &quot;/v1/hello/*&quot;, &quot;plugins&quot;: { &quot;proxy-mirror&quot;: { &quot;sample_ratio&quot;: 1, &quot;host&quot;: &quot;http://mirror.api:8082&quot; }, &quot;proxy-rewrite&quot;: { &quot;regex_uri&quot;: [ &quot;/v1/(.*)&quot;, &quot;/$1&quot; ], &quot;_meta&quot;: { &quot;priority&quot;: 2000 } } } } ``` The client uses this URI to request: ``` GET /v1/hello ``` Requests to the upstream will be rewritten as: ``` GET /hello ``` But the request to the mirror address is still: ``` GET /v1/hello ``` **So the URI rewritten in `proxy-rewrite` does not actually take effect for `proxy-mirror`. (I have overridden the proxy-rewrite priority via `_meta.priority` and it will be executed first)** ### Expected Behavior The modified URI in `proxy-rewrite` will take effect for `proxy-mirror`. ### Error Logs _No response_ ### Steps to Reproduce 1. Create a route by referring to the route configuration in the current behavior. 2. Request API 3. Check mirror service log Explanation of reasons: `proxy-rewrite` gets the URI from `ctx.var.uri`, writes it to the `upstream_uri` variable, and subsequently uses that variable instead of the original `uri` when forwarding upstream. `proxy-mirror` does not take this into account and uses the original `uri` variable directly. I think it should behave in such a way that the `uri` is used first and the `upstream_uri` is used when the value does not match the `upstream_uri`. If necessary we also need to modify the `proxy-rewrite` priority so that it takes precedence over `proxy-mirror`. ### Environment - APISIX version (run `apisix version`): 2.15.0</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>96</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ci: move helper script to the right dir (#8691) Fixes https://github.com/apache/apisix/issues/8685</MESSAGE>
    <SHA>822d545c3b0991269948fc2a8b684e484d06baf6</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(proxy-mirror): use with uri rewrite (#8718) Fixes https://github.com/apache/apisix/issues/8167</MESSAGE>
      <SHA>db2077ab6a4aa39d623ca8f194ebb56ba4377ba8</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/proxy-mirror.lua</FILE>
        <FILE>t/plugin/proxy-mirror2.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
