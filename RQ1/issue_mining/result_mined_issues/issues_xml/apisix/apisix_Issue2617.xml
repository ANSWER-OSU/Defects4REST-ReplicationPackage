<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2617</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/2617</ISSUEURL>
  <TITLE>bug(proxy-mirror): after proxy-mirror plugin mirroring request, the host in the mirroring request has changed</TITLE>
  <DESCRIPTION>### Issue description When I only used the `proxy-mirror` plugin, I found that the `host` in the mirroring request was not the host in the original request, but the host configured in the `proxy-mirror` plugin. This is my test case in `proxy-mirror.t` : 1.Add 1986 port service, used to print mirroring request information in the log. ``` add_block_preprocessor(sub { my ($block) = @_; my $http_config = $block-&gt;http_config // &lt;&lt;_EOC_; server { listen 1986; server_tokens off; location / { content_by_lua_block { local core = require(&quot;apisix.core&quot;) local headers_tab = ngx.req.get_headers() core.log.warn(ngx.var.request) for k, v in pairs(headers_tab) do core.log.warn( &quot;k: &quot;, k, &quot; v: &quot;, v) end } } } _EOC_ $block-&gt;set_value(&quot;http_config&quot;, $http_config); }); ``` 2.Configure `proxy-mirror` plugin information ``` === TEST 1: sanity check (normal case) --- config location /t { content_by_lua_block { local t = require(&quot;lib.test_admin&quot;).test local code, body = t('/apisix/admin/routes/1', ngx.HTTP_PUT, [[{ &quot;plugins&quot;: { &quot;proxy-mirror&quot;: { &quot;host&quot;: &quot;http://127.0.0.1:1986&quot; } }, &quot;upstream&quot;: { &quot;nodes&quot;: { &quot;127.0.0.1:1980&quot;: 1 }, &quot;type&quot;: &quot;roundrobin&quot; }, &quot;uri&quot;: &quot;/uri&quot; }]] ) if code &gt;= 300 then ngx.status = code end ngx.say(body) } } --- request GET /t --- error_code: 200 --- response_body passed --- no_error_log [error] ``` 3.Send a request to test the plugin. ``` === TEST 9: --- request GET /uri --- error_code: 200 --- more_headers host: 127.0.0.1 api-key: hello pageSize: 11 name: jake --- response_body uri: /uri host: 127.0.0.1 pagesize: 11 x-real-ip: 127.0.0.1 name: jake api-key: hello --- no_error_log [error] ``` 4.View the printed log, host is the host configured in the proxy-mirror plugin : ![image](https://user-images.githubusercontent.com/52862365/97999150-eafcee80-1e25-11eb-8414-0b93f8ba4865.png)</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>improve: refactor partial command line tool. (#2612) This PR moves some environmental variables to `apisix/cli/environ.lua`, and some auxiliary codes to `apisix/cli/util.lua`, which reduces the size of `bin/apisix`.</MESSAGE>
    <SHA>61cd91440bb8826d616e7a056428fe42ea64ebd0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: after proxy-mirror plugin mirroring request, the host in the mirroring request has changed. fix #2617</MESSAGE>
      <SHA>0f2756d5306a57e8fb67f1bde80efbe604cab0e9</SHA>
      <PATCHEDFILES>
        <FILE>apisix/cli/ngx_tpl.lua</FILE>
        <FILE>apisix/plugins/proxy-mirror.lua</FILE>
        <FILE>t/APISIX.pm</FILE>
        <FILE>t/plugin/proxy-mirror.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: after proxy-mirror plugin mirroring request, the host in the mirâ€¦ (#2626) fix #2617</MESSAGE>
      <SHA>b8e853cc392941bb9ff5f46f3f703f340382c56e</SHA>
      <PATCHEDFILES>
        <FILE>apisix/cli/ngx_tpl.lua</FILE>
        <FILE>apisix/plugins/proxy-mirror.lua</FILE>
        <FILE>t/APISIX.pm</FILE>
        <FILE>t/plugin/proxy-mirror.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
