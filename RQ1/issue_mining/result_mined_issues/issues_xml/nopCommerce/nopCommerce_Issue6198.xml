<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6198</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/6198</ISSUEURL>
  <TITLE>Discount coupon with N-Time use (ignore cancelled orders)</TITLE>
  <DESCRIPTION>nopCommerce version: 4.40 Steps to reproduce the problem: 1- Create a discount coupon with N-Time limit with value &quot;1&quot; 2- As a customer, use this coupon. 3- As admin, cancel this order. 4- As a customer, try to use this coupon again, error message appears that this coupon already used and can't be used again. the following is the source code: ``` public virtual async Task&lt;IPagedList&lt;DiscountUsageHistory&gt;&gt; GetAllDiscountUsageHistoryAsync(int? discountId = null, int? customerId = null, int? orderId = null, int pageIndex = 0, int pageSize = int.MaxValue) { return await _discountUsageHistoryRepository.GetAllPagedAsync(query =&gt; { //filter by discount if (discountId.HasValue &amp;&amp; discountId.Value &gt; 0) query = query.Where(historyRecord =&gt; historyRecord.DiscountId == discountId.Value); //filter by customer if (customerId.HasValue &amp;&amp; customerId.Value &gt; 0) query = from duh in query join order in _orderRepository.Table on duh.OrderId equals order.Id where order.CustomerId == customerId select duh; //filter by order if (orderId.HasValue &amp;&amp; orderId.Value &gt; 0) query = query.Where(historyRecord =&gt; historyRecord.OrderId == orderId.Value); //ignore deleted orders query = from duh in query join order in _orderRepository.Table on duh.OrderId equals order.Id where !order.Deleted select duh; //order query = query.OrderByDescending(historyRecord =&gt; historyRecord.CreatedOnUtc) .ThenBy(historyRecord =&gt; historyRecord.Id); return query; }, pageIndex, pageSize); } ``` It should ignore the canceled orders as well as the deleted ones.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>19</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add shopping cart to IPickupPointProvider method</MESSAGE>
    <SHA>dd638621bf2d1580c7700ec7555403d6ac010d70</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#6198 Ignore cancelled orders for discounts with N-Time use (#6208)</MESSAGE>
      <SHA>1cfa5b88ddd732f5919c76e2be914e6881612efb</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Discounts/DiscountService.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Discounts/IDiscountService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
