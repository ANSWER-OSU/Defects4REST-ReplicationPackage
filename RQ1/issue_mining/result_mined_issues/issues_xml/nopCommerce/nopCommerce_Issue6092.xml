<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6092</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/6092</ISSUEURL>
  <TITLE>Add an additional property to `AdditionalTokensAddedEvent` to be used to filter by TokenGroups</TITLE>
  <DESCRIPTION>nopCommerce version: 4.50-rc In order to make the Tokens allowed in Message Templates more extensible, we could add a new property `TokenGroups` to [`AdditionalTokensAddedEvent`](https://github.com/nopSolutions/nopCommerce/blob/12dd4825dfb56bbc64e192cd35d25e3205427646/src/Libraries/Nop.Core/Domain/Messages/AdditionalTokensAddedEvent.cs) ``` public class AdditionalTokensAddedEvent { public IList&lt;string&gt; AdditionalTokens { get; } /// &lt;summary&gt; /// Token groups which can be used to filter the AdditionalTokens /// &lt;/summary&gt; public IEnumerable&lt;string&gt; TokenGroups { get; set; } //&lt;-- Add this line } ``` In the `GetListOfAllowedTokensAsync()` method of [`MessageTokenProvider`](https://github.com/nopSolutions/nopCommerce/blob/cf1cdbe9ccc7a5dfa44f3617e6ed92583e353f84/src/Libraries/Nop.Services/Messages/MessageTokenProvider.cs#L1507), we could supply the `TokenGroups` to `AdditionalTokensAddedEvent` right before publishing it. ``` public virtual async Task&lt;IEnumerable&lt;string&gt;&gt; GetListOfAllowedTokensAsync(IEnumerable&lt;string&gt; tokenGroups = null) { var additionalTokens = new AdditionalTokensAddedEvent { TokenGroups = tokenGroups // &lt;-- Add this line }; await _eventPublisher.PublishAsync(additionalTokens); var allowedTokens = AllowedTokens.Where(x =&gt; tokenGroups == null || tokenGroups.Contains(x.Key)) .SelectMany(x =&gt; x.Value).ToList(); allowedTokens.AddRange(additionalTokens.AdditionalTokens); return allowedTokens.Distinct(); } ``` Now in the our Consumer class, we can use the `TokenGroups` to make a decision of whether to add a certain Tokens. ``` public class AdditionalTokensAddedConsumer : IConsumer&lt;AdditionalTokensAddedEvent&gt; { public Task HandleEventAsync(AdditionalTokensAddedEvent eventMessage) { if (eventMessage.TokenGroups == null || eventMessage.TokenGroups.Contains(TokenGroupNames.OrderTokens)) { eventMessage.AddTokens(&quot;%Order.OrderURLForStoreOwner%&quot;, &quot;%Order.Total%&quot;); } return Task.CompletedTask; } } ``` Without the above, AdditionalTokens are added all the time regardless of TokenGroup.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>73</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'majako-issue-6078-orderdetailsmodel-values' into develop</MESSAGE>
    <SHA>cea39c11764616fa547237d55a173adafab59886</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#6092 Allow AdditionalTokens used in Message Templates to be filtered by TokenGroups.</MESSAGE>
      <SHA>86a15729ac71c65423b83cbc1ea7b350f5756540</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Domain/Messages/AdditionalTokensAddedEvent.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Messages/MessageTokenProvider.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#6092 Allow AdditionalTokens used in Message Templates to be filtered by TokenGroups. (#6093)</MESSAGE>
      <SHA>68ea3916dbb6af2d12732c1d370785cb64c35a4e</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Domain/Messages/AdditionalTokensAddedEvent.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Messages/MessageTokenProvider.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
