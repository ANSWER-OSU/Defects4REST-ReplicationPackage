<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2750</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/2750</ISSUEURL>
  <TITLE>NopEngine ServiceProvider() method null result</TITLE>
  <DESCRIPTION>Hello, I have been working with NopCommerce 4.0 for awhile and just started building a long running background task that can either be started via a scheduled task or manually. However in both instances there are thousands of processes happening. I have found what I think is a bug with the method `NopEngine.GetServiceProvider()` It appears that an HttpContext can be resolved from the service provider however the `RequestedServices` could be null. The orignal code just checks if the `context != null` but we also need to check that the property `RequestedServices` is also not null. I have refactored this method to. ``` protected IServiceProvider GetServiceProvider() { var accessor = ServiceProvider.GetService&lt;IHttpContextAccessor&gt;(); var context = accessor.HttpContext; return context?.RequestServices ?? ServiceProvider; //context != null ? context.RequestServices : ServiceProvider; } ``` Now as you see we are using Null-Condition checking and Null Collesce to return the ServiceProvider if null. Now I have tested what this will do for transiant scopes left open but will review. Also it would be handy if the property `ServiceProvider` was made public not protected.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>126</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'issue-1986-delete-gift-card-usage-history' into develop</MESSAGE>
    <SHA>7a18cf17549e75c0b9a68980a0e483ef0a69da8f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#2750 Prevented null reference exception when context.RequestServices returns null</MESSAGE>
      <SHA>36ca1cc28763f9b64e415a967285f21faa3ca5ce</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Infrastructure/NopEngine.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
