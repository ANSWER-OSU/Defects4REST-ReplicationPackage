<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3529</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/3529</ISSUEURL>
  <TITLE>PerRequestCacheManager Needs Proper Locking</TITLE>
  <DESCRIPTION>nopCommerce version: 4.10 Steps to reproduce the problem: I am using the REST API Plugin and I continually get the following errors/exceptions. The problem is due to the fact we also use Redis caching which uses PerRequestCaching and that class does not have proper thread protection - in my dev build I added reader/writer constructs and this fixed the issue. ``` Application: dotnet.exe CoreCLR Version: 4.6.26919.2 Description: The process was terminated due to an unhandled exception. Exception Info: System.InvalidOperationException: Collection was modified; enumeration operation may not execute. at System.Collections.Generic.Dictionary`2.KeyCollection.Enumerator.MoveNext() at System.Linq.Enumerable.SelectEnumerableIterator`2.MoveNext() at System.Linq.Enumerable.WhereEnumerableIterator`1.ToList() at System.Linq.Enumerable.ToList[TSource](IEnumerable`1 source) at Nop.Core.Caching.PerRequestCacheManager.RemoveByPattern(String pattern) in at Nop.Core.Caching.RedisCacheManager.RemoveByPatternAsync(String pattern) in at Nop.Core.Caching.RedisCacheManager.RemoveByPattern(String pattern) in at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state) --- End of stack trace from previous location where exception was thrown --- at System.Threading.ThreadPoolWorkQueue.Dispatch() ```</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>1289</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch '4.50-bug-fixes' into develop</MESSAGE>
    <SHA>979a322c85e4793ff850ebb9022fbb42364b5bbe</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#3529 Changed the PerRequestCache onto ConcurrentDictionary</MESSAGE>
      <SHA>d9ceda703cc63aec899a5204ed0587dc710185cf</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Caching/DistributedCacheManager.cs</FILE>
        <FILE>src/Tests/Nop.Tests/Nop.Core.Tests/Caching/DistributedCacheManagerTests.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
