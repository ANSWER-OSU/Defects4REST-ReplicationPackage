<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6763</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/6763</ISSUEURL>
  <TITLE>Improve performance of `ShippingByWeightByTotalService.FindRecordsAsync`</TITLE>
  <DESCRIPTION>nopCommerce version: 4.50.x + Steps to reproduce the problem: * We are currently maintaining a nopcommerce instance for one of our customers with 25+ active shops. * Each of these shops has their own shipping rates, and each shops makes heavy use of the `WeightFrom` and `WeightTo` properties. * Currently we have 494k entries in the appropriate table * Our customer reported, that the `ShippingMethod` page during checkout is often loading for 10+ seconds. After investigating the issue in the azure logs, we were able to determine that the following sql is causing huge performance problems: ```sql SELECT [t1].[Id], [t1].[LowerWeightLimit], [t1].[RatePerWeightUnit], [t1].[PercentageRateOfSubtotal], [t1].[AdditionalFixedCost], [t1].[OrderSubtotalTo], [t1].[OrderSubtotalFrom], [t1].[WeightTo], [t1].[WeightFrom], [t1].[TransitDays], [t1].[ShippingMethodId], [t1].[Zip], [t1].[StateProvinceId], [t1].[CountryId], [t1].[WarehouseId], [t1].[StoreId] FROM [ShippingByWeightByTotalRecord] [t1] ORDER BY [t1].[StoreId], [t1].[CountryId], [t1].[StateProvinceId], [t1].[Zip], [t1].[ShippingMethodId], [t1].[WeightFrom], [t1].[OrderSubtotalFrom] ``` Here is an image of the query performance insight for this exact query: ![image](https://github.com/nopSolutions/nopCommerce/assets/54266094/3cbddb9a-2018-4af6-8414-466f984a6965) Let's look at the first row in the table. There we can see, that query is executed 4 times within an hour, and the total duration approximately one minute and ten seconds. If we divide that by 4, we can determine that each query ran for about 17 seconds. This is to much! After analyzing the query above and the source code that appears to be producing this, it looks like there is currently a major performance bottleneck, as all 494k entries are fetched and then filtered in memory. It looks like after fetching these entries once, they appear to stay in memory for a few minutes. But storing all of those entries in memory doesn't sound like a good idea either. Happy to provide you the contents of our table in private if necessary. https://github.com/nopSolutions/nopCommerce/blob/2796b813f366cd0363c024d9b823933600565075/src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/Services/ShippingByWeightByTotalService.cs#L90-L92</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>34</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch '4.60-bug-fixes' into develop</MESSAGE>
    <SHA>49b48bbe0e7101d33bca1cc022ac70274c1edda2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#6763 Improved caching in the ShippingByWeightByTotalService.FindRecordsAsync method (cherry picked from commit a0b6bba6e1c877ad3a2edd6ae2300410f082dd27)</MESSAGE>
      <SHA>4d55db7bdd1cd1d9f6afaae3ba8d95841ef8a4bb</SHA>
      <PATCHEDFILES>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/FixedByWeightByTotalDefaults.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/Services/IShippingByWeightByTotalService.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/Services/ShippingByWeightByTotalService.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/plugin.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#6763 Added settings to change caching type in the ShippingByWeightByTotalService.FindRecordsAsync method</MESSAGE>
      <SHA>781c905bf987b4b97fc4320cf97ea0738092351e</SHA>
      <PATCHEDFILES>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/FixedByWeightByTotalComputationMethod.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/FixedByWeightByTotalSettings.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/Migrations/AddLoadAllRecordSetting.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/Services/ShippingByWeightByTotalService.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Shipping.FixedByWeightByTotal/plugin.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
