<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5612</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/5612</ISSUEURL>
  <TITLE>RemotePost.Post Payment Plugin FAIL Headers are read-only, response has already started</TITLE>
  <DESCRIPTION>nopCommerce version: 4.40 Steps to reproduce the problem: 1. Create a new Payment Plugin. 2. Implement the following: ``` public PaymentMethodType PaymentMethodType =&gt; PaymentMethodType.Redirection; public async Task PostProcessPaymentAsync(PostProcessPaymentRequest postProcessPaymentRequest) { var baseUrl = &quot;https://someurl&quot;; var post = new RemotePost { FormName = &quot;somepaysubmit&quot;, Url = baseUrl, Method = &quot;POST&quot; }; post.Add(&quot;TestKey&quot;, &quot;TestValue&quot;); post.Post(); } ``` When you submit order using this payment plugin the following exception is thrown. This is the whole stack trace. The Nop relevant line is: **Nop.Services.Authentication.AuthenticationMiddleware.InvokeAsync(HttpContext context) in D:\nopCommerce_4.40_Source\src\Libraries\Nop.Services\Authentication\AuthenticationMiddleware.cs:line 94** ` fail: Microsoft.AspNetCore.Server.Kestrel[13] Connection id &quot;0HM7UOQG3F0G8&quot;, Request id &quot;0HM7UOQG3F0G8:00000069&quot;: An unhandled exception was thrown by the application. System.InvalidOperationException: Headers are read-only, response has already started. at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpHeaders.ThrowHeadersReadOnlyException() at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpHeaders.Microsoft.AspNetCore.Http.IHeaderDictionary.set_Item(String key, StringValues value) at Microsoft.AspNetCore.Mvc.Infrastructure.ContentResultExecutor.ExecuteAsync(ActionContext context, ContentResult result) at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.&lt;InvokeNextResultFilterAsync&gt;g__Awaited|29_0[TFilter,TFilterAsync](ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted) at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Rethrow(ResultExecutedContextSealed context) at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.ResultNext[TFilter,TFilterAsync](State&amp; next, Scope&amp; scope, Object&amp; state, Boolean&amp; isCompleted) at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.InvokeResultFilters() --- End of stack trace from previous location --- at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.&lt;InvokeNextResourceFilter&gt;g__Awaited|24_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted) at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Rethrow(ResourceExecutedContextSealed context) at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Next(State&amp; next, Scope&amp; scope, Object&amp; state, Boolean&amp; isCompleted) at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.InvokeFilterPipelineAsync() --- End of stack trace from previous location --- at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.&lt;InvokeAsync&gt;g__Logged|17_1(ResourceInvoker invoker) at Microsoft.AspNetCore.Routing.EndpointMiddleware.&lt;Invoke&gt;g__AwaitRequestTask|6_0(Endpoint endpoint, Task requestTask, ILogger logger) at WebMarkupMin.AspNetCore5.WebMarkupMinMiddleware.ProcessAsync(HttpContext context, Boolean useMinification, Boolean useCompression) at WebMarkupMin.AspNetCore5.WebMarkupMinMiddleware.ProcessAsync(HttpContext context, Boolean useMinification, Boolean useCompression) at WebMarkupMin.AspNetCore5.WebMarkupMinMiddlewareBase.Invoke(HttpContext context) at StackExchange.Profiling.MiniProfilerMiddleware.Invoke(HttpContext context) in C:\projects\dotnet\src\MiniProfiler.AspNetCore\MiniProfilerMiddleware.cs:line 125 at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context) at Nop.Services.Authentication.AuthenticationMiddleware.InvokeAsync(HttpContext context) in D:\nopCommerce_4.40_Source\src\Libraries\Nop.Services\Authentication\AuthenticationMiddleware.cs:line 94 at Microsoft.AspNetCore.Localization.RequestLocalizationMiddleware.Invoke(HttpContext context) at Microsoft.AspNetCore.Session.SessionMiddleware.Invoke(HttpContext context) at Microsoft.AspNetCore.Session.SessionMiddleware.Invoke(HttpContext context) at Nop.Services.Installation.InstallUrlMiddleware.InvokeAsync(HttpContext context, IWebHelper webHelper) in D:\nopCommerce_4.40_Source\src\Libraries\Nop.Services\Installation\InstallUrlMiddleware.cs:line 52 at Nop.Services.Common.KeepAliveMiddleware.InvokeAsync(HttpContext context, IWebHelper webHelper) in D:\nopCommerce_4.40_Source\src\Libraries\Nop.Services\Common\KeepAliveMiddleware.cs:line 49 at Microsoft.AspNetCore.ResponseCompression.ResponseCompressionMiddleware.Invoke(HttpContext context) at Microsoft.AspNetCore.Diagnostics.StatusCodePagesMiddleware.Invoke(HttpContext context) at Microsoft.AspNetCore.Diagnostics.StatusCodePagesMiddleware.Invoke(HttpContext context) at Microsoft.AspNetCore.Diagnostics.ExceptionHandlerMiddleware.&lt;Invoke&gt;g__Awaited|6_0(ExceptionHandlerMiddleware middleware, HttpContext context, Task task) at Microsoft.AspNetCore.Diagnostics.ExceptionHandlerMiddleware.HandleException(HttpContext context, ExceptionDispatchInfo edi) at Microsoft.AspNetCore.Diagnostics.ExceptionHandlerMiddleware.&lt;Invoke&gt;g__Awaited|6_0(ExceptionHandlerMiddleware middleware, HttpContext context, Task task) at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddleware.Invoke(HttpContext context) at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddleware.Invoke(HttpContext context) at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application) ` It could be that this issue is related to #4158.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>162</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'develop' of https://github.com/nopSolutions/nopCommerce into develop</MESSAGE>
    <SHA>2369c33cffdfe3152930d02cfdcdf950dd94008f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#5612 Fixed issue &quot;Headers are read-only, response has already started&quot;</MESSAGE>
      <SHA>8719ad74cfc2e22d560dbc930bd2900ebef1adb9</SHA>
      <PATCHEDFILES>
        <FILE>src/Presentation/Nop.Web.Framework/RemotePost.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#5612 Fixed issue &quot;Headers are read-only, response has already started&quot; (cherry picked from commit 8719ad74cfc2e22d560dbc930bd2900ebef1adb9)</MESSAGE>
      <SHA>788b9284e7bf1dd2ea9c4db75673e44a5f903541</SHA>
      <PATCHEDFILES>
        <FILE>src/Presentation/Nop.Web.Framework/RemotePost.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
