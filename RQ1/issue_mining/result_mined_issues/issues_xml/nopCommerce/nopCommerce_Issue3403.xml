<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3403</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/3403</ISSUEURL>
  <TITLE>Serializing and deserializing Task&lt;T&gt; to json into Redis cache awaits a never returning task</TITLE>
  <DESCRIPTION>nopCommerce version: 4.0 When enabling the Azure blob storage and Redis cache, the Redis cache manager awaits a deserialized task which will never return. After a bunch of debugging sessions, I've found that the method GeneratedThumbExistsAsync in the AzurePictureService never returns. This will eventually cause a timeout error on the home page and the product admin panel since those pages eventually call this method. On startup, the Redis cache manager Get method inserts the thumbnail keys into Redis, saving the task object as value. When trying to deserialize the task, it awaits the deserialization. It happens in the following piece of code: (which can be found in the method GeneratedThumbExistsAsync in the AzurePictureService) ``` return await _cacheManager.Get(key, async () =&gt; { //GetBlockBlobReference doesn't need to be async since it doesn't contact the server yet var blockBlob = _container.GetBlockBlobReference(thumbFileName); return await blockBlob.ExistsAsync(); }); ``` The fix that I've applied is to execute the acquire function synchronously, however, this will have a performance impact since the call is being made synchronously to Azure blob storage. ``` return _cacheManager.Get(key, () =&gt; { //GetBlockBlobReference doesn't need to be async since it doesn't contact the server yet var blockBlob = _container.GetBlockBlobReference(thumbFileName); return blockBlob.ExistsAsync().ConfigureAwait(false).GetAwaiter().GetResult(); }); ``` I've also looked into the source code of nop 4.1, which also should have this problem. I'm curious whether I'm the only one having this problem since this should work out of the box. Steps to reproduce the problem: Enable Azure blob storage with Redis. Go to the home page or product admin panel, these pages will eventually time out.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>141</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Changed channel of Slack to notification from Travis CI</MESSAGE>
    <SHA>7f4b62f93e565917883d7ecd1edf1b7f2bb7c12f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#3403 Added GetAsync method to IStaticCacheManager interface</MESSAGE>
      <SHA>ecc2dbee9116b7218dd634ef5f2989fd7a6791b3</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Caching/IStaticCacheManager.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Caching/MemoryCacheManager.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Caching/NopNullCache.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Caching/RedisCacheManager.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Media/AzurePictureService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3403 Refused to use Task.Run in cache managers, bicause it prodused the thread pool overflow See details by following links: https://blog.stephencleary.com/2013/11/taskrun-etiquette-examples-dont-use.html http://labs.criteo.com/2018/10/net-threadpool-starvation-and-how-queuing-makes-it-worse/</MESSAGE>
      <SHA>942c2d89476158055576e0c76e43a1ae4f480bd3</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Caching/MemoryCacheManager.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Caching/RedisCacheManager.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
