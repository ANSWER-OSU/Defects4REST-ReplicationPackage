<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3146</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/3146</ISSUEURL>
  <TITLE>DbContext not thread safe in Scheduled Tasks during log insert</TITLE>
  <DESCRIPTION>Hi guys, i get the following error immediatly after starting the app pool on a staging server. It seems to be related with Scheduled tasks, because if I disable all them from database and recycle the app pool nopCommerce starts with no problem. ``` info: Microsoft.EntityFrameworkCore.Infrastructure[10403] Entity Framework Core 2.1.1-rtm-30846 initialized 'NopObjectContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer' with options: using lazy-loading proxies info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (45ms) [Parameters=[], CommandType='Text', CommandTimeout='30'] SELECT [t].[Id], [t].[Enabled], [t].[LastEndUtc], [t].[LastStartUtc], [t].[LastSuccessUtc], [t].[Name], [t].[Seconds], [t].[StopOnError], [t].[Type] FROM [ScheduleTask] AS [t] WHERE [t].[Enabled] = 1 ORDER BY [t].[Seconds] DESC info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='30'] SELECT [s].[Id], [s].[CompanyAddress], [s].[CompanyName], [s].[CompanyPhoneNumber], [s].[CompanyVat], [s].[DefaultLanguageId], [s].[DisplayOrder], [s].[Hosts], [s].[Name], [s].[SslEnabled], [s].[Url] FROM [Store] AS [s] ORDER BY [s].[DisplayOrder], [s].[Id] info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (1ms) [Parameters=[], CommandType='Text', CommandTimeout='30'] SELECT [s].[Id], [s].[Name], [s].[StoreId], [s].[Value] FROM [Setting] AS [s] ORDER BY [s].[Name], [s].[StoreId] info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (57ms) [Parameters=[@p0='?' (DbType = DateTime2), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (Size = 200), @p4='?' (DbType = Int32), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='Text', CommandTimeout='30'] SET NOCOUNT ON; INSERT INTO [Log] ([CreatedOnUtc], [CustomerId], [FullMessage], [IpAddress], [LogLevelId], [PageUrl], [ReferrerUrl], [ShortMessage]) VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7); SELECT [Id] FROM [Log] WHERE @@ROWCOUNT = 1 AND [Id] = scope_identity(); info: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[58] Creating key {f09c1237-d91b-49e8-aa73-bea60b62701b} with creation date 2018-07-12 09:06:15Z, activation date 2018-07-12 09:06:15Z, and expiration date 2018-10-10 09:06:15Z. warn: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[35] No XML encryptor configured. Key {f09c1237-d91b-49e8-aa73-bea60b62701b} may be persisted to storage in unencrypted form. info: Microsoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository[39] Writing data to file 'D:\InetPub\wwwroot\DumontB2B\App_Data\DataProtectionKeys\key-f09c1237-d91b-49e8-aa73-bea60b62701b.xml'. Hosting environment: Production Content root path: D:\InetPub\wwwroot\DumontB2B Now listening on: http://127.0.0.1:12256 Application started. Press Ctrl+C to shut down. info: Microsoft.AspNetCore.Hosting.Internal.WebHost[1] Request starting HTTP/1.1 GET http://dumont.flyweb.it/login?ReturnUrl=%2F info: Microsoft.EntityFrameworkCore.Infrastructure[10403] Entity Framework Core 2.1.1-rtm-30846 initialized 'NopObjectContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer' with options: using lazy-loading proxies info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (1ms) [Parameters=[@__customerGuid_0='?' (DbType = Guid)], CommandType='Text', CommandTimeout='30'] SELECT TOP(1) [c].[Id], [c].[Active], [c].[AdminComment], [c].[AffiliateId], [c].[BillingAddress_Id], [c].[CannotLoginUntilDateUtc], [c].[CreatedOnUtc], [c].[CustomerGuid], [c].[Deleted], [c].[Email], [c].[EmailToRevalidate], [c].[FailedLoginAttempts], [c].[HasShoppingCartItems], [c].[IsSystemAccount], [c].[IsTaxExempt], [c].[LastActivityDateUtc], [c].[LastIpAddress], [c].[LastLoginDateUtc], [c].[RegisteredInStoreId], [c].[RequireReLogin], [c].[ShippingAddress_Id], [c].[SystemName], [c].[Username], [c].[VendorId] FROM [Customer] AS [c] WHERE [c].[CustomerGuid] = @__customerGuid_0 ORDER BY [c].[Id] info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (0ms) [Parameters=[@__get_Item_0='?' (DbType = Int32)], CommandType='Text', CommandTimeout='30'] SELECT [e].[Customer_Id], [e].[CustomerRole_Id] FROM [Customer_CustomerRole_Mapping] AS [e] WHERE [e].[Customer_Id] = @__get_Item_0 info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (0ms) [Parameters=[@__get_Item_0='?' (DbType = Int32)], CommandType='Text', CommandTimeout='30'] SELECT [e].[Id], [e].[Active], [e].[DefaultTaxDisplayTypeId], [e].[EnablePasswordLifetime], [e].[FreeShipping], [e].[IsSystemRole], [e].[Name], [e].[OverrideTaxDisplayType], [e].[PurchasedWithProductId], [e].[SystemName], [e].[TaxExempt] FROM [CustomerRole] AS [e] WHERE [e].[Id] = @__get_Item_0 info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (0ms) [Parameters=[@__entityId_0='?' (DbType = Int32), @__keyGroup_1='?' (Size = 400)], CommandType='Text', CommandTimeout='30'] SELECT [ga].[Id], [ga].[EntityId], [ga].[Key], [ga].[KeyGroup], [ga].[StoreId], [ga].[Value] FROM [GenericAttribute] AS [ga] WHERE ([ga].[EntityId] = @__entityId_0) AND ([ga].[KeyGroup] = @__keyGroup_1) info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (0ms) [Parameters=[], CommandType='Text', CommandTimeout='30'] SELECT [l].[Id], [l].[DefaultCurrencyId], [l].[DisplayOrder], [l].[FlagImageFileName], [l].[LanguageCulture], [l].[LimitedToStores], [l].[Name], [l].[Published], [l].[Rtl], [l].[UniqueSeoCode] FROM [Language] AS [l] WHERE [l].[Published] = 1 ORDER BY [l].[DisplayOrder], [l].[Id] info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (1ms) [Parameters=[@p0='?' (DbType = DateTime2), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (Size = 200), @p4='?' (DbType = Int32), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='Text', CommandTimeout='30'] SET NOCOUNT ON; INSERT INTO [Log] ([CreatedOnUtc], [CustomerId], [FullMessage], [IpAddress], [LogLevelId], [PageUrl], [ReferrerUrl], [ShortMessage]) VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7); SELECT [Id] FROM [Log] WHERE @@ROWCOUNT = 1 AND [Id] = scope_identity(); fail: Microsoft.EntityFrameworkCore.Update[10000] An exception occurred in the database while saving changes for context type 'Nop.Data.NopObjectContext'. System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) fail: Microsoft.EntityFrameworkCore.Update[10000] An exception occurred in the database while saving changes for context type 'Nop.Data.NopObjectContext'. System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) Unhandled Exception: Unhandled Exception: Unhandled Exception: fail: Microsoft.EntityFrameworkCore.Update[10000] An exception occurred in the database while saving changes for context type 'Nop.Data.NopObjectContext'. System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) at Nop.Data.EfRepository`1.Insert(TEntity entity) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Data\EfRepository.cs:line 81 at Nop.Services.Logging.DefaultLogger.InsertLog(LogLevel logLevel, String shortMessage, String fullMessage, Customer customer) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Logging\DefaultLogger.cs:line 222 at Nop.Services.Logging.DefaultLogger.Error(String message, Exception exception, Customer customer) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Logging\DefaultLogger.cs:line 271 at Nop.Services.Tasks.TaskThread.Run() in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Tasks\TaskThread.cs:line 69 at Nop.Services.Tasks.TaskThread.TimerHandler(Object state) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Tasks\TaskThread.cs:line 79 at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state) --- End of stack trace from previous location where exception was thrown --- at System.Threading.TimerQueueTimer.CallCallback() at System.Threading.TimerQueueTimer.Fire() at System.Threading.ThreadPoolWorkQueue.Dispatch() System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) at Nop.Data.EfRepository`1.Insert(TEntity entity) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Data\EfRepository.cs:line 81 at Nop.Services.Logging.DefaultLogger.InsertLog(LogLevel logLevel, String shortMessage, String fullMessage, Customer customer) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Logging\DefaultLogger.cs:line 222 at Nop.Services.Logging.DefaultLogger.Error(String message, Exception exception, Customer customer) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Logging\DefaultLogger.cs:line 271 at Nop.Services.Tasks.TaskThread.Run() in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Tasks\TaskThread.cs:line 69 at Nop.Services.Tasks.TaskThread.TimerHandler(Object state) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Tasks\TaskThread.cs:line 79 at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state) --- End of stack trace from previous location where exception was thrown --- at System.Threading.TimerQueueTimer.CallCallback() at System.Threading.TimerQueueTimer.Fire() at System.Threading.TimerQueue.FireNextTimers() info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (1ms) [Parameters=[@p0='?' (DbType = DateTime2), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (Size = 200), @p4='?' (DbType = Int32), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='Text', CommandTimeout='30'] SET NOCOUNT ON; INSERT INTO [Log] ([CreatedOnUtc], [CustomerId], [FullMessage], [IpAddress], [LogLevelId], [PageUrl], [ReferrerUrl], [ShortMessage]) VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7); SELECT [Id] FROM [Log] WHERE @@ROWCOUNT = 1 AND [Id] = scope_identity(); info: Microsoft.EntityFrameworkCore.Database.Command[20101] Executed DbCommand (0ms) [Parameters=[@p0='?' (DbType = DateTime2), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (Size = 200), @p4='?' (DbType = Int32), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='Text', CommandTimeout='30'] SET NOCOUNT ON; INSERT INTO [Log] ([CreatedOnUtc], [CustomerId], [FullMessage], [IpAddress], [LogLevelId], [PageUrl], [ReferrerUrl], [ShortMessage]) VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7); SELECT [Id] FROM [Log] WHERE @@ROWCOUNT = 1 AND [Id] = scope_identity(); System.InvalidOperationException: A second operation started on this context before a previous operation completed. Any instance members are not guaranteed to be thread safe. at Microsoft.EntityFrameworkCore.Internal.ConcurrencyDetector.EnterCriticalSection() at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(IReadOnlyList`1 entriesToSave) at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChanges(Boolean acceptAllChangesOnSuccess) at Microsoft.EntityFrameworkCore.DbContext.SaveChanges(Boolean acceptAllChangesOnSuccess) at Nop.Data.EfRepository`1.Insert(TEntity entity) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Data\EfRepository.cs:line 81 at Nop.Services.Logging.DefaultLogger.InsertLog(LogLevel logLevel, String shortMessage, String fullMessage, Customer customer) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Logging\DefaultLogger.cs:line 222 at Nop.Services.Logging.DefaultLogger.Error(String message, Exception exception, Customer customer) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Logging\DefaultLogger.cs:line 271 at Nop.Services.Tasks.TaskThread.Run() in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Tasks\TaskThread.cs:line 69 at Nop.Services.Tasks.TaskThread.TimerHandler(Object state) in D:\Lavori\Dumont\nopCommerce\src\Libraries\Nop.Services\Tasks\TaskThread.cs:line 79 at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state) --- End of stack trace from previous location where exception was thrown --- at System.Threading.TimerQueueTimer.CallCallback() at System.Threading.TimerQueueTimer.Fire() at System.Threading.ThreadPoolWorkQueue.Dispatch() info: Microsoft.AspNetCore.Mvc.Internal.ControllerActionInvoker[1] Route matched with {action = &quot;Login&quot;, controller = &quot;Customer&quot;, area = &quot;&quot;}. Executing action Nop.Web.Controllers.CustomerController.Login (Nop.Web) ```</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'develop' of https://github.com/nopSolutions/nopCommerce into develop # Conflicts: # upgradescripts/4.00-4.10 (under development)/upgrade.sql</MESSAGE>
    <SHA>208c77d2b658683240a902d45206f75e0d94544b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#3146 #3139 Resolving ILogger interface by new scope when exception was raised in the TaskThread instance</MESSAGE>
      <SHA>6470d22b4a43b82b71171604ea4de28b389b41a2</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Tasks/TaskThread.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
