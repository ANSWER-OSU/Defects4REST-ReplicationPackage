<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1708</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/1708</ISSUEURL>
  <TITLE>Full refund does not take into account already refunded amount</TITLE>
  <DESCRIPTION>Version 3.80 Steps to reproduce: 1) Create an order of $27. 2) Partially refund $7. At this point the order looks like this: ![span](https://cloud.githubusercontent.com/assets/16139612/18027779/a623a31e-6c75-11e6-8212-1751cf0155dd.JPG) I don't understand why the button &quot;Mark as paid&quot; shows up (but that's not the point... maybe the store owner wants to have the order status as PAID.. fine by me). 3) Mark the order as paid, then it will look like this: ![oaud](https://cloud.githubusercontent.com/assets/16139612/18027790/e6dbe290-6c75-11e6-8468-4597dbfa3724.JPG) Afterwards, if we click **Partial Refund** , the maximum amount that we can refund will be $20 (correct, because we previously refunded $7). But if we click **Refund** then the payment plugin's Refund method is called with the whole amount ($27) . So then the payment gateway's API naturally returns an error. --- Solution: We should disable &quot;Refund&quot; (full) button when &quot;Refunded amount&quot; &gt; 0 (some other refund has been done already)</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Some changes of source code comments</MESSAGE>
    <SHA>6d1568aae78e4ba130aa5bc855e4a0163da55d9b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#1708 We should disable &quot;Refund&quot; (full) button when some partial refund has been already done. It was possible to reproduce if a store owner manually marked an order as paid after a partial refund.</MESSAGE>
      <SHA>9dfc6ca48ee658c69d48efd2a94b137e8967af03</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Orders/OrderProcessingService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
