<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5584</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/5584</ISSUEURL>
  <TITLE>Nop did not pass originating scheme (HTTP/HTTPS) to middlewares from proxy.</TITLE>
  <DESCRIPTION>nopCommerce version: all If we deploy Nop behind a proxy, the HTTPS schema is not passed to those middlewares who may need the info (like the authentication middleware), this will cause the facebook auth plugin to send only HTTP callback url to facebook api. To fix this, we need to add XForwardedProto header to request pipline. https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-5.0 ``` public void ConfigureRequestPipeline(IApplicationBuilder application) { application.UseForwardedHeaders(new ForwardedHeadersOptions { ForwardedHeaders = ForwardedHeaders.XForwardedProto }); ServiceProvider = application.ApplicationServices; //find startup configurations provided by other assemblies var typeFinder = Resolve&lt;ITypeFinder&gt;(); var startupConfigurations = typeFinder.FindClassesOfType&lt;INopStartup&gt;(); //create and sort instances of startup configurations var instances = startupConfigurations .Select(startup =&gt; (INopStartup)Activator.CreateInstance(startup)) .OrderBy(startup =&gt; startup.Order); //configure request pipeline foreach (var instance in instances) instance.Configure(application); } ```</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>82</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>#5696 Added search by keywords into message templates</MESSAGE>
    <SHA>b7c7bdc0311e4d0a7a3181e02b732ab733e2c20d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#5584 Added using .NET's middleware to forward proxied headers onto the current request</MESSAGE>
      <SHA>4cf3c49ed33f6023bfef7bd7c73e7892abc42f69</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Configuration/HostingConfig.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Http/NopHttpDefaults.cs</FILE>
        <FILE>src/Libraries/Nop.Core/WebHelper.cs</FILE>
        <FILE>src/Presentation/Nop.Web.Framework/Infrastructure/Extensions/ApplicationBuilderExtensions.cs</FILE>
        <FILE>src/Presentation/Nop.Web.Framework/Infrastructure/NopProxyStartup.cs</FILE>
        <FILE>src/Presentation/Nop.Web.Framework/Migrations/UpgradeTo450/LocalizationMigration.cs</FILE>
        <FILE>src/Presentation/Nop.Web/App_Data/Localization/defaultResources.nopres.xml</FILE>
        <FILE>src/Presentation/Nop.Web/Areas/Admin/Models/Settings/HostingConfigModel.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Areas/Admin/Views/Setting/_AppSettings.Hosting.cshtml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
