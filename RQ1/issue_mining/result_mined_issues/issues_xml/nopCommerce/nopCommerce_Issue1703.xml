<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1703</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/1703</ISSUEURL>
  <TITLE>RedisCacheManager doesn't work properly when using database number greater then 0</TITLE>
  <DESCRIPTION>In our current environment we have an existing redis server. It is important that we are able to leverage this server and configure a specific database for the NopCommerce redis traffic. We set the RedisCaching setting in the Web.Config file to true and correctly set the connectionString using a redis defaultDatabase of 5. Everything was going along smoothly until we found the NopCommerce Admin portal configuration options would not set correctly when changed (ie. Configuration&gt;&gt;Settings&gt;&gt;General and Miscellaneous Settings&gt;&gt;Allow customers to select a theme: checkbox). We began by monitoring the Redis server using the monitor command. We found that when the NopCommerce configuration setting was changed, the Redis database would be changed to database 0 (Redis command - select 0) and not 5 like we set in the connection string and expect it to be. After further review we found that in the NopCommerce RedisCacheManager.cs file, there are two methods that incorrectly parse the Redis Keys. They are methods RemoveByPattern(string pattern) and Clear(). They both make a call to the StackExchange.Redis.IServer.cs &gt;&gt; IServer.Keys(int database = 0, RedisValue pattern = default(RedisValue), int pageSize = RedisBase.CursorUtils.DefaultPageSize, long cursor = RedisBase.CursorUtils.Origin, int pageOffset = 0, CommandFlags flags = CommandFlags.None) method As you see in that StackExchange Keys method that if the database isnâ€™t explicitly set in those calls, the parameter will by default set the database to 0. This in turns causes the Keys requested by NopCommerce for those two method calls (Clear &amp; RemoveByPattern) to look in Redis database 0 and not 5. This is the NopCommerce bug. If you set the database property in the IServer.Keys method call as _db.Database for both the NopCommerce RedisCacheManager.cs Clear and RemoveByPattern methods, this will resolve the bug. Ie... RemoveByPattern: var keys = server.Keys(database: _db.Database, pattern: &quot;_&quot; + pattern + &quot;_&quot;); And Clear: var keys = server.Keys(database: _db.Database); --- I want to add, the impact isn't just to the NopCommerce install, it causes all the keys of a different application we have that uses the Redis db of 0 to be cleared. In addition, Here are the Web.Config RedisCaching settings we are using for your debugging purposes: RedisCaching Enabled=&quot;true&quot; ConnectionString=&quot;xxx.xxx.xxx.xxx:6379,ssl=False,defaultDatabase=5&quot; You can test locally using: RedisCaching Enabled=&quot;true&quot; ConnectionString=&quot;127.0.0.1:6379,ssl=False,defaultDatabase=5&quot;</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'release-3.80-bug-fixes' into develop</MESSAGE>
    <SHA>e06a3e982f7b36a72a50d46ce71200aa6fbcdeaa</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#1703 RedisCacheManager doesn't work properly when using database number greater then 0</MESSAGE>
      <SHA>80102dc9e687758093a095d83b4d265b45e01afe</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Caching/RedisCacheManager.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
