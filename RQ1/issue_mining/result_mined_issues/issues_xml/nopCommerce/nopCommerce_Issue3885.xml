<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3885</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/3885</ISSUEURL>
  <TITLE>Potential refactoring of ExportManager.GetPictures(Product) method</TITLE>
  <DESCRIPTION>nopCommerce version: 4.20 beta Please correct me if I am wrong but I believe that the following `ExportManager.GetPictures(Product)` method: ``` protected virtual string[] GetPictures(Product product) { //pictures (up to 3 pictures) string picture1 = null; string picture2 = null; string picture3 = null; var pictures = _pictureService.GetPicturesByProductId(product.Id, 3); for (var i = 0; i &lt; pictures.Count; i++) { var pictureLocalPath = _pictureService.GetThumbLocalPath(pictures[i]); switch (i) { case 0: picture1 = pictureLocalPath; break; case 1: picture2 = pictureLocalPath; break; case 2: picture3 = pictureLocalPath; break; } } return new[] { picture1, picture2, picture3 }; } ``` can be simplified as: ``` protected virtual string[] GetPictures(Product product) { var pictures = _pictureService.GetPicturesByProductId(product.Id, 3); return pictures.Select(picture =&gt; _pictureService.GetThumbLocalPath(picture)).ToArray(); } ``` Going further, it seems this method is only called when creating a `PropertyByName` in the `ExportManager.ExportProductsToXlsx(IEnumerable&lt;Product&gt;)` method: ``` ... new PropertyByName&lt;Product&gt;(&quot;Picture1&quot;, p =&gt; GetPictures(p)[0]), new PropertyByName&lt;Product&gt;(&quot;Picture2&quot;, p =&gt; GetPictures(p)[1]), new PropertyByName&lt;Product&gt;(&quot;Picture3&quot;, p =&gt; GetPictures(p)[2]) ... ``` This means that 3 pictures are returned from the method each time it is called when only one is needed. Instead, we can just return a single picture to give: ``` protected virtual string GetPicture(Product product, int pictureIndex) { var pictures = _pictureService.GetPicturesByProductId(product.Id, 3); return _pictureService.GetThumbLocalPath(pictures[pictureIndex]); } ... new PropertyByName&lt;Product&gt;(&quot;Picture1&quot;, p =&gt; GetPicture(p, 0), new PropertyByName&lt;Product&gt;(&quot;Picture2&quot;, p =&gt; GetPicture(p, 1), new PropertyByName&lt;Product&gt;(&quot;Picture3&quot;, p =&gt; GetPicture(p, 2) ... ``` Note the renaming of the method above from `GetPictures` to `GetPicture`. Note also that we have reduced the number of times that we call `_pictureService.GetThumbLocalPath(Picture)`. And finally, if we look at what the method is returning we will see that it does not return a picture (as implied by the name) but instead returns a picture thumbnail path or a null value if no picture is found. Therefore, we should rename the method appropriately to reflect this. I suggest the following: ``` protected virtual string GetPictureThumbLocalPathOrNull(Product product, int pictureIndex) { var pictures = _pictureService.GetPicturesByProductId(product.Id, 3); return _pictureService.GetThumbLocalPath(pictures[pictureIndex]); } ``` Note that the comments above the method will also need to be updated.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>406</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>#4809 Added attribute to skip migration</MESSAGE>
    <SHA>5e182a9b349055b8f61c6141ae09f9cb8673816a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#3885 Refactoring of ExportManager.GetPictures(Product) method (#4815) Co-authored-by: Roman Gherman &lt;roman.gherman@infigosoftware.com&gt;</MESSAGE>
      <SHA>5effb18528b20c06327c4d22835b40ff07bc40a5</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/ExportImport/ExportManager.cs</FILE>
        <FILE>src/Tests/Nop.Services.Tests/ExportImport/ExportManagerTests.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
