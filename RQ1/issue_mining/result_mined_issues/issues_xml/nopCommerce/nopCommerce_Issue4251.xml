<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4251</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/4251</ISSUEURL>
  <TITLE>Wrong reservation</TITLE>
  <DESCRIPTION>nopCommerce version: 4.20 Steps to reproduce the problem: Wrong reservation in ProductService in method ReserveInventory when ReservedQuantity bigger than StockQuantity and set postive reservation and set value wrong. ```csharp Action pass = () =&gt; { foreach (var item in productInventory) { var selectQty = Math.Min(item.StockQuantity - item.ReservedQuantity, qty); item.ReservedQuantity += selectQty; qty -= selectQty; if (qty &lt;= 0) break; } }; // 1st pass: Applying reserved pass(); if (qty &gt; 0) { // 2rd pass: Booking negative stock! var pwi = productInventory[0]; pwi.ReservedQuantity += qty; } ``` it's must change to: ```csharp Action pass = () =&gt; { foreach (var item in productInventory) { var selectQty = Math.Min(Math.Max(0, item.StockQuantity - item.ReservedQuantity), qty); item.ReservedQuantity += selectQty; qty -= selectQty; if (qty &lt;= 0) break; } }; // 1st pass: Applying reserved pass(); if (qty &gt; 0) { // 2rd pass: Booking negative stock! var pwi = productInventory[0]; pwi.ReservedQuantity += qty; } ```</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>198</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Revert &quot;#3792 Added algorithm for balancing a reserved product when choosing delivery from other warehouses&quot;</MESSAGE>
    <SHA>a6f315e4def08135890d2358f11f5f74e1a2a611</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#4251 Fix wrong reservation</MESSAGE>
      <SHA>f569efba5248f40200595f71d8abb60b6587283d</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Catalog/ProductService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
