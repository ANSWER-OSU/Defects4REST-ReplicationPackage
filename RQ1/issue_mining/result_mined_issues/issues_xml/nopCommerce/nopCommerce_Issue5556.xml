<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5556</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/5556</ISSUEURL>
  <TITLE>Temp tables connection leak</TITLE>
  <DESCRIPTION>nopCommerce version: 4.40 Steps to reproduce the problem: I'm running the linux build on Digitalocean with Ubuntu 20.04(LTS)x64 Basic instance with 2G of RAM, Postgres, nginx, and Let's Encrypt SSL. When I go to Administration and restart the application the deamon gets killed with a status=6/ABRT. Digging through the log I find this in /var/log/syslog Mar 20 04:18:17 bottles systemd[1]: nopCommerce440.service: Main process exited, code=killed, status=6/ABRT Mar 20 04:18:17 bottles systemd[1]: nopCommerce440.service: Failed with result 'signal'. Mar 20 04:18:27 bottles systemd[1]: nopCommerce440.service: Scheduled restart job, restart counter is at 91. Mar 20 04:18:27 bottles systemd[1]: Stopped Example nopCommerce app running on XUbuntu. Mar 20 04:18:27 bottles systemd[1]: Started Example nopCommerce app running on XUbuntu. Mar 20 04:18:34 bottles nopCommerce440-example[20927]: Unhandled exception. System.NullReferenceException: Object reference not set to an instance of an object. Mar 20 04:18:34 bottles nopCommerce440-example[20927]: at Nop.Services.Tasks.TaskThread.TimerHandler(Object state) in C:\andrei\nop_sources\src\Libraries\Nop.Services\Tasks\TaskThread.cs:line 121 Mar 20 04:18:34 bottles nopCommerce440-example[20927]: at System.Threading.TimerQueueTimer.&lt;&gt;c.&lt;.cctor&gt;b__23_0(Object state) Mar 20 04:18:34 bottles nopCommerce440-example[20927]: at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state) Mar 20 04:18:34 bottles nopCommerce440-example[20927]: --- End of stack trace from previous location --- Mar 20 04:18:34 bottles nopCommerce440-example[20927]: at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state) Mar 20 04:18:34 bottles nopCommerce440-example[20927]: at System.Threading.TimerQueueTimer.CallCallback(Boolean isThreadPool) Mar 20 04:18:34 bottles nopCommerce440-example[20927]: at System.Threading.TimerQueueTimer.Fire(Boolean isThreadPool) Mar 20 04:18:34 bottles nopCommerce440-example[20927]: at System.Threading.TimerQueue.FireNextTimers() Mar 20 04:18:34 bottles nopCommerce440-example[20927]: at System.Threading.TimerQueue.AppDomainTimerCallback(Int32 id) Mar 20 04:18:35 bottles systemd[1]: nopCommerce440.service: Main process exited, code=killed, status=6/ABRT Mar 20 04:18:35 bottles systemd[1]: nopCommerce440.service: Failed with result 'signal'. Mar 20 04:18:38 bottles kernel: [ 8327.985499] [UFW BLOCK] IN=eth0 OUT= MAC=3e:60:4c:f4:6e:2c:fe:00:00:00:01:01:08:00 SRC=89.248.165.204 DST=161.35.238.204 LEN=40 TOS=0x00 PREC=0x00 TTL=243 ID=27564 PROTO=TCP SPT=59976 DPT=17191 WINDOW=&gt; Mar 20 04:18:45 bottles systemd[1]: nopCommerce440.service: Scheduled restart job, restart counter is at 92. Mar 20 04:18:45 bottles systemd[1]: Stopped Example nopCommerce app running on XUbuntu. Mar 20 04:18:45 bottles systemd[1]: Started Example nopCommerce app running on XUbuntu. Mar 20 04:18:52 bottles nopCommerce440-example[20968]: Unhandled exception. System.NullReferenceException: Object reference not set to an instance of an object. Mar 20 04:18:52 bottles nopCommerce440-example[20968]: at Nop.Services.Tasks.TaskThread.TimerHandler(Object state) in C:\andrei\nop_sources\src\Libraries\Nop.Services\Tasks\TaskThread.cs:line 121 Mar 20 04:18:52 bottles nopCommerce440-example[20968]: at System.Threading.TimerQueueTimer.&lt;&gt;c.&lt;.cctor&gt;b__23_0(Object state) Mar 20 04:18:52 bottles nopCommerce440-example[20968]: at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state) Mar 20 04:18:52 bottles nopCommerce440-example[20968]: --- End of stack trace from previous location --- Mar 20 04:18:52 bottles nopCommerce440-example[20968]: at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state) Mar 20 04:18:52 bottles nopCommerce440-example[20968]: at System.Threading.TimerQueueTimer.CallCallback(Boolean isThreadPool) Mar 20 04:18:52 bottles nopCommerce440-example[20968]: at System.Threading.TimerQueueTimer.Fire(Boolean isThreadPool) Mar 20 04:18:52 bottles nopCommerce440-example[20968]: at System.Threading.TimerQueue.FireNextTimers() Mar 20 04:18:52 bottles nopCommerce440-example[20968]: at System.Threading.TimerQueue.AppDomainTimerCallback(Int32 id) Looking at the code in TasksThread.cs looks like it has something to do with the timer. Thank you for looking into this.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>34</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Updated UTMs</MESSAGE>
    <SHA>597a2df22f03bf4509f36c4160caa45f3ad8b37b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#4885 Schedule task stop automatically</MESSAGE>
      <SHA>575ce2d9935e266229acc0632625b4d0cbdeb6ef</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Tasks/TaskThread.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#5556 Added connection closing after the query execution for temporary table context</MESSAGE>
      <SHA>bdee4652f944015eed457547a8c359c7a2d26c7d</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Data/TempSqlDataStorage.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
