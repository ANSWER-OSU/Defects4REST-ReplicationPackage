<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1031</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/1031</ISSUEURL>
  <TITLE>Image Resize Rounding Bug</TITLE>
  <DESCRIPTION>Contribution: http://www.nopcommerce.com/boards/t/40616/image-resizing-bug.aspx An issue exists in the PictureService which creates a white single pixel strip either vertical or horizontal on resized images such as thumbnails. The white strip appears on the right or bottom of the image. The issue appears when the original image size does not divide evenly into the destination size and the remainder is &gt; 0.5. For example, when a final floating point width of 47.8 is determined, the remainder is dropped (not rounded) and the image is resized to only 47 pixels instead of 48 leaving a white border on the right side of the image. The issue is discussed here: http://www.nopcommerce.com/boards/t/30972/getting-one-white-pixel-along-the-height-on-picture-when-upgrading-to-33.aspx In my testing, the solution is to simply add Math.Round() to the results prior to casting to int. The code fixing the issue in PictureService.cs is below: ``` protected virtual Size CalculateDimensions(Size originalSize, int targetSize, ResizeType resizeType = ResizeType.LongestSide, bool ensureSizePositive = true) { var newSize = new Size(); switch (resizeType) { case ResizeType.LongestSide: if (originalSize.Height &gt; originalSize.Width) { // portrait newSize.Width = (int)Math.Round(originalSize.Width * (float)(targetSize / (float)originalSize.Height)); newSize.Height = targetSize; } else { // landscape or square newSize.Height = (int)Math.Round(originalSize.Height * (float)(targetSize / (float)originalSize.Width)); newSize.Width = targetSize; } break; case ResizeType.Width: newSize.Height = (int)Math.Round(originalSize.Height * (float)(targetSize / (float)originalSize.Width)); newSize.Width = targetSize; break; case ResizeType.Height: newSize.Width = (int)Math.Round(originalSize.Width * (float)(targetSize / (float)originalSize.Height)); newSize.Height = targetSize; break; default: throw new Exception(&quot;Not supported ResizeType&quot;); } if (ensureSizePositive) { if (newSize.Width &lt; 1) newSize.Width = 1; if (newSize.Height &lt; 1) newSize.Height = 1; } return newSize; } ```</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>134</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'issue-1336_-Home-Page-Categories-model-cache' into develop</MESSAGE>
    <SHA>03146fa5f8a642b45f1aeccaf861486620de0e3f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#1031 Image Resize Rounding Bug</MESSAGE>
      <SHA>63d7b3e944fe3a1d048a67c5f972c54144ddc342</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Media/PictureService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
