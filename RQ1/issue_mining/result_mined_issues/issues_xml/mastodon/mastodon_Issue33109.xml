<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>33109</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/33109</ISSUEURL>
  <TITLE>Edits appear to fail to process with unresolvable mentions</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Receive an `Update` with an unresolvable mention (ie domain is gone) 2. Job fails to process, so `Update` is never applied 3. See failed job in sidekick morgue Needs a fix akin to #29215 ### Expected behaviour Job will process successfully ### Actual behaviour Job will fail to process ### Detailed description Backtrace: ``` app/lib/request.rb:110:in `rescue in perform': failed to connect: No address for beta.mstdn.cf on https://beta.mstdn.cf/users/mariaressa (HTTP::ConnectionError) from app/lib/request.rb:107:in `perform' from app/helpers/jsonld_helper.rb:174:in `fetch_resource_without_id_validation' from app/helpers/jsonld_helper.rb:167:in `fetch_resource' from app/services/activitypub/fetch_remote_actor_service.rb:18:in `call' from app/services/activitypub/fetch_remote_account_service.rb:6:in `call' from app/services/activitypub/process_status_update_service.rb:198:in `block in update_mentions!' from app/services/activitypub/process_status_update_service.rb:194:in `each' from app/services/activitypub/process_status_update_service.rb:194:in `update_mentions!' from app/services/activitypub/process_status_update_service.rb:182:in `update_metadata!' from app/services/activitypub/process_status_update_service.rb:45:in `block (2 levels) in handle_explicit_update!' from app/services/activitypub/process_status_update_service.rb:40:in `block in handle_explicit_update!' from app/models/concerns/lockable.rb:12:in `block (2 levels) in with_redis_lock' from app/models/concerns/lockable.rb:10:in `block in with_redis_lock' from app/lib/redis_connection.rb:10:in `with' from app/models/concerns/redisable.rb:9:in `with_redis' from app/models/concerns/lockable.rb:9:in `with_redis_lock' ... 13 levels... /home/mastodon/live/app/lib/request.rb:328:in `open': failed to connect: No address for beta.mstdn.cf (HTTP::ConnectionError) from /home/mastodon/live/app/lib/request.rb:24:in `connect' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/connection.rb:42:in `initialize' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:49:in `initialize' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:70:in `new' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:70:in `perform' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:12:in `block (2 levels) in &lt;class:Client&gt;' from /home/mastodon/.rbenv/versions/3.3.5/lib/ruby/3.3.0/benchmark.rb:313:in `realtime' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:11:in `block in &lt;class:Client&gt;' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:31:in `request' from /home/mastodon/live/app/lib/request.rb:108:in `perform' from /home/mastodon/live/app/helpers/jsonld_helper.rb:174:in `fetch_resource_without_id_validation' from /home/mastodon/live/app/helpers/jsonld_helper.rb:167:in `fetch_resource' from /home/mastodon/live/app/services/activitypub/fetch_remote_actor_service.rb:18:in `call' from /home/mastodon/live/app/services/activitypub/fetch_remote_account_service.rb:6:in `call' from /home/mastodon/live/app/services/activitypub/process_status_update_service.rb:198:in `block in update_mentions!' from /home/mastodon/live/app/services/activitypub/process_status_update_service.rb:194:in `each' ... 64 levels... /home/mastodon/live/app/lib/request.rb:328:in `open': No address for beta.mstdn.cf (SocketError) from /home/mastodon/live/app/lib/request.rb:24:in `connect' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/connection.rb:42:in `initialize' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:49:in `initialize' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:70:in `new' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:70:in `perform' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:12:in `block (2 levels) in &lt;class:Client&gt;' from /home/mastodon/.rbenv/versions/3.3.5/lib/ruby/3.3.0/benchmark.rb:313:in `realtime' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:11:in `block in &lt;class:Client&gt;' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:31:in `request' from /home/mastodon/live/app/lib/request.rb:108:in `perform' from /home/mastodon/live/app/helpers/jsonld_helper.rb:174:in `fetch_resource_without_id_validation' from /home/mastodon/live/app/helpers/jsonld_helper.rb:167:in `fetch_resource' from /home/mastodon/live/app/services/activitypub/fetch_remote_actor_service.rb:18:in `call' from /home/mastodon/live/app/services/activitypub/fetch_remote_account_service.rb:6:in `call' from /home/mastodon/live/app/services/activitypub/process_status_update_service.rb:198:in `block in update_mentions!' from /home/mastodon/live/app/services/activitypub/process_status_update_service.rb:194:in `each' ... 64 levels... ``` ### Mastodon instance raphus.social ### Mastodon version v4.3.1 ### Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: ruby 3.3.5 (2024-09-03 revision ef084cc8f4) [x86_64-linux] - Node.js version: v20.5.1</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update dependency active_model_serializers to v0.10.15 (#33120) Co-authored-by: renovate[bot] &lt;29139614+renovate[bot]@users.noreply.github.com&gt;</MESSAGE>
    <SHA>459be1f4e7d10a8b250b4de749c05472e75c9ee8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix processing incoming post edits with mentions to unresolvable accounts Fixes #33109</MESSAGE>
      <SHA>366ccaca132f24bea4129f775b6b6250efe36c8a</SHA>
      <PATCHEDFILES>
        <FILE>app/services/activitypub/process_status_update_service.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
