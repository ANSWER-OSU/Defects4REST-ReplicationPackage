<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>31383</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/31383</ISSUEURL>
  <TITLE>Unable to logout on Safari</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Log in your account on mastodon.social 2. Select logout option in menu section beside profile. 3. Click on &quot;Log out&quot; in Confirm Log out modal. ### Expected behaviour Should be able to logout ### Actual behaviour Unable to logout from my account ### Detailed description _No response_ ### Mastodon instance mastodon.social ### Mastodon version v4.3.0-nightly.2024-08-09 ### Browser name and version Safari Version 17.5 ### Operating system macOS 14.5 ### Technical details _No response_</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add missing Appeals link under Moderation in navigiation (#31071)</MESSAGE>
    <SHA>b42661ba95b7872ba278fca9b0fee8faffd89e52</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix log out from user menu not working on Safari The main issue here is that the form was not submitting. Adding a delay after adding it to the DOM seems to fix it, but this is brittle. As we want to move away from form submits in the app to tighten the CSP policy, I chose to rewrite this to a direct request. After a log out, the backend responds with a 302 request, redirecting to another page. This needs to be reimplemented in JS, but there is no way to get the `Location` of a redirect using `fetch()`. So I went to change the backend to respond with a JSON object to JSON log out queries, exposing the URL to return the user to. Fixes #31383</MESSAGE>
      <SHA>165054c391d3ee9866eb8ea31119099728e2308b</SHA>
      <PATCHEDFILES>
        <FILE>app/controllers/auth/sessions_controller.rb</FILE>
        <FILE>app/javascript/mastodon/utils/log_out.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix log out from user menu not working on Safari The main issue here is that the form was not submitting. Adding a delay after adding it to the DOM seems to fix it, but this is brittle. As we want to move away from form submits in the app to tighten the CSP policy, I chose to rewrite this to a direct request. After a log out, the backend responds with a 302 request, redirecting to another page. This needs to be reimplemented in JS, but there is no way to get the `Location` of a redirect using `fetch()`. So I went to change the backend to respond with a JSON object to JSON log out queries, exposing the URL to return the user to. Fixes #31383</MESSAGE>
      <SHA>35168084eda19f73f48edf265b2ba73c708c4211</SHA>
      <PATCHEDFILES>
        <FILE>app/controllers/auth/sessions_controller.rb</FILE>
        <FILE>app/javascript/mastodon/features/ui/components/confirmation_modals/log_out.tsx</FILE>
        <FILE>app/javascript/mastodon/utils/log_out.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
