<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>28539</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/28539</ISSUEURL>
  <TITLE>Streaming endpoint on Vagrant sends 301 redirect to localhost</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem I wanted to test an in-development Mastodon client's use of the streaming API endpoints such as `/api/v1/streaming/user`, so I set up a development instance using Vagrant as follows: 1. cloned the git repo on Ubuntu 22.04, obtaining the head commit 6374358357ee81b5f137f471f028a56974109155 2. ran `vagrant up` in the root of the checkout, and authorised it to add `mastodon.local` to my `/etc/hosts` 3. ran the suggested startup command `vagrant ssh -c &quot;cd /vagrant &amp;&amp; foreman start&quot;` 4. created a test user on the instance using the web UI, and authenticated my test client The client tried to access the streaming API, by sending an HTTP request as follows (observed via `strace`, since in this environment we're using cleartext HTTP): ``` GET /api/v1/streaming/user HTTP/1.1 authorization: Bearer LHfBPlUXWkgVSZl5DMSiBOTD1CeaidAWwWs8TiUKmUk accept: */* host: mastodon.local ``` ### Expected behaviour I expected that this GET request would return a 200 status and begin delivering chunked data, starting with a line such as &quot;:)&quot; and continuing with &quot;:thump&quot; heartbeats interleaved with update events. ### Actual behaviour The web server on the Vagrant instance returned a 301 redirect to a URL on &quot;localhost&quot;, so my client next tried to connect to the host machine, and got 404 because _that_ web server knows nothing about the test Mastodon instance. ### Detailed description The full HTTP response from the Mastodon test server was: ``` HTTP/1.1 301 Moved Permanently X-Frame-Options: SAMEORIGIN X-XSS-Protection: 0 X-Content-Type-Options: nosniff X-Download-Options: noopen X-Permitted-Cross-Domain-Policies: none Referrer-Policy: strict-origin-when-cross-origin X-RateLimit-Limit: 300 X-RateLimit-Remaining: 299 X-RateLimit-Reset: 2023-12-31T14:55:00.170985Z Location: http://localhost/api/v1/streaming/user Content-Type: text/html; charset=utf-8 Cache-Control: private, no-store Content-Security-Policy: default-src 'none'; frame-ancestors 'none'; form-action 'none' X-Request-Id: 0b582768-c006-4a45-b808-49803c87e1d4 X-Runtime: 0.126129 Server-Timing: cache_read.active_support;dur=0.02, sql.active_record;dur=0.66, cache_generate.active_support;dur=1.31, cache_write.active_support;dur=0.11, instantiation.active_record;dur=0.23, start_processing.action_controller;dur=0.00, redirect_to.action_controller;dur=0.03, process_action.action_controller;dur=7.38 vary: Authorization, Origin Content-Length: 0 ``` ### Mastodon instance mastodon.local (installed via Vagrant) ### Mastodon version v4.3.0-alpha.0 ### Technical details Software versions that `vagrant up` installed for me: ``` vagrant@mastodon:~$ ruby --version ruby 3.2.2 (2023-03-30 revision e51014f9c0) [x86_64-linux] vagrant@mastodon:~$ node --version v20.10.0 ```</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Change media to be hidden/blurred by default in report modal (#28522)</MESSAGE>
    <SHA>6374358357ee81b5f137f471f028a56974109155</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Change streaming API host to not be overridden to localhost in development mode Fixes #28539</MESSAGE>
      <SHA>2fe6291d3b0c6174f7eb8dd0ffc3067e96b5362d</SHA>
      <PATCHEDFILES>
        <FILE>config/initializers/1_hosts.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
