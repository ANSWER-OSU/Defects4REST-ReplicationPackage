<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>27697</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/27697</ISSUEURL>
  <TITLE>any url returns an empty page if no cookie is previously existant</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem try any page on my instance, like : [https://lepoulsdumonde.com/@nico](nico) or [https://lepoulsdumonde.com/](home) Only a grey window is displayed. the console logs : ```Uncaught Error: No current user (me) defined when calling `accountsReducer` at accounts (accounts.ts:51:11)``` But when you already have an existing connection to the server (I guess when you have an existing cookie), everything works fine. For example, on my main browser, firefox 119 on win 11, I can log in and out, get any url because I've been using it with an account for a long time. But if I go to chrome which I never used to access my instance, or on my phone, or if a friend tries to connect to my instance, I get this error, and only a grey empty window is displayed. I don't get any error logs in journalctl. I tried pulling main again, and deleting the packs and cache and recompiling, restarting all services with no success. I'm using the latest nightly main branch from source pull. I don't know when the problem appeared exactly. ### Expected behaviour display the web page ### Actual behaviour empty window ### Detailed description _No response_ ### Mastodon instance lepoulsdumonde.com ### Mastodon version v4.3.0alpha nightly from source ### Browser name and version firefox 119, chrome 119 ### Operating system win 11, ios, win10 ### Technical details _No response_</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Use a wrapper file to export exports used in preval-ed modules as CJS In https://github.com/mastodon/mastodon/pull/27333 I added `useBuiltIns: &quot;usage&quot;`, which causes Babel to inject polyfills into those files. The polyfills are injected using ESM `import` symtax, which disables the handling of `export.` (CommonJS exports). This causes the build in dev to fail, because in dev Babel does not convert the exports to CJS (not sure why). By using a simple wrapper file to re-export to CJS, we avoid having Babel inject anything in the wrapper file, so it is correctly processed as CJS, and exports work. We have plans to rewrite the emoji-related code in the future, which will remove the need for `preval`, and switching to Vite should also solve this. Fixes #27686</MESSAGE>
    <SHA>a70261d0ea3b63d7b41c4bdaa6116b4fe6d37374</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Only check that we are logged in when really needed I made a mistake in #26559 and inadvertently added a check when the reducer runs, which happens on page load. This needs to only be checked when those specific actions are dispatched, which only happen when you are logged in. Added a system check to ensure the UI loads when not logged in. Fixes #27697</MESSAGE>
      <SHA>cb866a8deb341bfede747201823d25c21a89580b</SHA>
      <PATCHEDFILES>
        <FILE>app/javascript/mastodon/reducers/accounts.ts</FILE>
        <FILE>spec/system/unlogged_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Only check that we are logged in when really needed I made a mistake in #26559 and inadvertently added a check when the reducer runs, which happens on page load. This needs to only be checked when those specific actions are dispatched, which only happen when you are logged in. Added a system check to ensure the UI loads when not logged in. Fixes #27697</MESSAGE>
      <SHA>dd640e5d54a2e0a53b5fbe6ad5c7891ad4f22f2b</SHA>
      <PATCHEDFILES>
        <FILE>app/javascript/mastodon/reducers/accounts.ts</FILE>
        <FILE>spec/system/unlogged_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
