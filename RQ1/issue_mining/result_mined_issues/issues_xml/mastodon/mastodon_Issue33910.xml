<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>33910</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/33910</ISSUEURL>
  <TITLE>Sidekiq error: CardinalityViolation: ERROR: ON CONFLICT DO UPDATE</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem I've been getting a lot of Mastodon sidekiq errors: `ActivityPub:ProcessingWorker &quot;ActiveRecord::StatementInvalid: PG::CardinalityViolation: ERROR: ON CONFLICT DO UPDATE command cannot affect row a second time HINT: Ensure that no rows proposed for insertion within the same command...&quot;` ### Expected behaviour No error ### Actual behaviour Error ### Detailed description I've been getting a lot of Mastodon sidekiq errors: ActivityPub:ProcessingWorker &quot;ActiveRecord::StatementInvalid: PG::CardinalityViolation: ERROR: ON CONFLICT DO UPDATE command cannot affect row a second time HINT: Ensure that no rows proposed for insertion within the same command...&quot; I thought it was a widespread problem, but it appears, after pulling journalctl mastodon-* today, all of my many errors come back to one post, I believe came from federation firehose and not an account I follow nor follows me. I didn't look at each error, though. The journalctl rows from the first time the error appeared is attached. I think I got all, or more of the relevant rows. [CardinalityViolation.txt](https://github.com/user-attachments/files/18769336/CardinalityViolation.txt) ### Mastodon instance oldfriends.live ### Mastodon version v4.3.3 ### Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: v3.3.5 - Node.js version: v20.17.0 I posted a question on Mastodon about this to see if anyone else was getting this error and Renchap replied to file a report. https://oisaur.com/@renchap/113990485085328900</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update dependency net-imap to 0.5.6 (#33901)</MESSAGE>
    <SHA>447d12aa0851b3bbeed37f5fb185c037eedb63c8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix handling of duplicate mentions in incoming status `Update` Fixes #33910</MESSAGE>
      <SHA>b70e935daaf7b6e115c8f89fceb3a2461bb2634f</SHA>
      <PATCHEDFILES>
        <FILE>app/services/activitypub/process_status_update_service.rb</FILE>
        <FILE>spec/lib/activitypub/activity/create_spec.rb</FILE>
        <FILE>spec/services/activitypub/process_status_update_service_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
