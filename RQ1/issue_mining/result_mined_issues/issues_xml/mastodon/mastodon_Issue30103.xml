<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>30103</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/30103</ISSUEURL>
  <TITLE>API to subscribe to push notification does not seem to delete previous subscription?</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. [POST `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#create) many times. (Not sure if many times in a short time matters though, just stating based on what I (accidentally) did) 2. Send a post via another account, tagging the logged in user. 3. Wait for notification to arrive 4. Realised that tons of notifications came flooding in, only one decoded correctly (non unexpected, since my app only saved the latest keys) ### Expected behaviour 1 notification with correct contents. ### Actual behaviour hundreds? of notifications. ### Detailed description Now, I am not entirely sure if the fault is on my end, but I am somewhat confident that it is the API's fault. Please advise if I'm doing something terribly wrong without noticing I am referring to the [POST `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#create) endpoint. So the story here is that, new (unreleased) app here, where a bug occurred, which resulted in an endless loop, causing the app to accidentally send out many requests. I realised this probably after like 2 seconds, shut the app down, fixed the issue, and relaunched the app. I sent a post out using another account, tagging my app's logged in account, the rest is explained in the steps to reproduce section. The documentation for that, states: &gt; If you create a new subscription, the old subscription is deleted. In this case, it didn't seem to be true? Eventually, I also tried calling [DELETE `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#delete), but symptoms remains. My setup is for a watchOS app. Notifications are relayed using [metatext-apns](https://github.com/metabolist/metatext-apns), which by the looks of it is just a simple relay so that shouldn't be the cause, right? I am very new to this Mastodon/Web Push notifications stuff, so please let me know if you believe it's an issue from my end. Thank you! ### Mastodon instance mastodon.social ### Mastodon version v4.3.0-nightly.2024-04-18 ### Technical details - watchOS 10.2 - Both accounts are on mastodon.social</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Change ActiveRecordEncryption variable to be more explicit (#30151)</MESSAGE>
    <SHA>33368e3e79a6edfcaf65fd2b80b636a7c1e56e48</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix race condition in `POST /api/v1/push/subscription` Fixes #30103</MESSAGE>
      <SHA>61b7a04528e875e61361bb22ed3b45fbee38f3fd</SHA>
      <PATCHEDFILES>
        <FILE>app/controllers/api/v1/push/subscriptions_controller.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
