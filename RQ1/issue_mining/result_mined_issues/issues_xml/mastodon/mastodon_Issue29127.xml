<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>29127</ISSUENO>
  <ISSUEURL>https://github.com/mastodon/mastodon/issues/29127</ISSUEURL>
  <TITLE>Possible to create domain blocks when a stricter limit already exists in Admin UI</TITLE>
  <DESCRIPTION>### Steps to reproduce the problem 1. Go to `/admin/instances?limited=1` to manage federation 2. Add a domain block for `example` (noop/none severity) 3. Using the API try to create a domain block for `test.example` observe that an error is returned 4. Go back to the admin UI and create a domain block for `test.example` observe that no error is returned and the block is successfully created. ### Expected behaviour Both methods for creating domain blocks should have same behaviour ### Actual behaviour The API failed whilst the Admin UI succeeded ### Detailed description This bug affects IFTAS FediCheck, where we weren't observing the same logic as `DomainBlock.rule_for` when attempting to create a domain block, which meant an existing block of `example` would fail the block creation of `test.example` leaving us out of sync with the Mastodon server (we also weren't handling the error response from the API correctly. ### Mastodon instance _No response_ ### Mastodon version main ### Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: v 3.2.3 - Node.js version: v20.11.0</DESCRIPTION>
  <REPONAME>mastodon</REPONAME>
  <TIMEDIFFERENCEDAYS>85</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Remove unused `Account.popular` scope (#30068)</MESSAGE>
    <SHA>bbf1b603e0bb3c0ffeb4eba8a1d5faf645335d91</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix not being able to block a subdomain of an already-blocked domain through the API Fixes #29127</MESSAGE>
      <SHA>690f2b9031848f029a2e0470bb0f02c4727e626e</SHA>
      <PATCHEDFILES>
        <FILE>app/controllers/api/v1/admin/domain_blocks_controller.rb</FILE>
        <FILE>spec/requests/api/v1/admin/domain_blocks_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix not being able to block a subdomain of an already-blocked domain through the API Fixes #29127</MESSAGE>
      <SHA>c3c719b5faeea5be46d178a92e6ff52994645172</SHA>
      <PATCHEDFILES>
        <FILE>app/controllers/api/v1/admin/domain_blocks_controller.rb</FILE>
        <FILE>spec/requests/api/v1/admin/domain_blocks_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix not being able to block a subdomain of an already-blocked domain through the API Fixes #29127</MESSAGE>
      <SHA>ea52fb329817982f834bab8dd629d0a829f8d6be</SHA>
      <PATCHEDFILES>
        <FILE>app/controllers/api/v1/admin/domain_blocks_controller.rb</FILE>
        <FILE>spec/requests/api/v1/admin/domain_blocks_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix not being able to block a subdomain of an already-blocked domain through the API Fixes #29127</MESSAGE>
      <SHA>bbf9d29a129d0b0acaed474ed16fcba6c87b1fb9</SHA>
      <PATCHEDFILES>
        <FILE>app/controllers/api/v1/admin/domain_blocks_controller.rb</FILE>
        <FILE>spec/requests/api/v1/admin/domain_blocks_spec.rb</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
