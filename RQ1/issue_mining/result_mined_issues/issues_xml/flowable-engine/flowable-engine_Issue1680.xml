<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1680</ISSUENO>
  <ISSUEURL>https://github.com/flowable/flowable-engine/issues/1680</ISSUEURL>
  <TITLE>Filtering history task instance by variable not working for completed tasks</TITLE>
  <DESCRIPTION>Flowable 6.4.1 I'm trying to get all history task instances filtered with a specific variable. It's ok when the task is not completed because the filter uses runtime variable but it fails when the variable does not exist in the runtime table but only in the history. The code I used : ``` List&lt;HistoricTaskInstance&gt; taskInstances = cmmnHistoryService.createHistoricTaskInstanceQuery().includeTaskLocalVariables().taskVariableValueEquals(&quot;type&quot;, &quot;action&quot;).list(); ``` After digging in source code, i found that the query mapper for history task instance is about runtime variable (``ACT_RU_VARIABLE``) instead of history variable (``ACT_HI_VARINST``) Here is an extract from the ``org/flowable/task/service/db/mapping/entity/HistoricTaskInstance.xml`` file : ``` &lt;foreach item=&quot;queryVar&quot; collection=&quot;orQueryObject.queryVariableValues&quot; index=&quot;index&quot;&gt; or &lt;trim prefix=&quot;(&quot; prefixOverrides=&quot;AND&quot; suffix=&quot;)&quot;&gt; &lt;choose&gt; &lt;when test=&quot;queryVar.operator.equals('EXISTS')&quot;&gt; and EXISTS ( select ID_ from ${prefix}ACT_RU_VARIABLE where NAME_ = #{queryVar.name} &lt;if test=&quot;!queryVar.local&quot;&gt; and RES.PROC_INST_ID_ = PROC_INST_ID_ and TASK_ID_ is null &lt;/if&gt; &lt;if test=&quot;queryVar.local&quot;&gt; and RES.ID_ = TASK_ID_ &lt;/if&gt; ) &lt;/when&gt; &lt;when test=&quot;queryVar.operator.equals('NOT_EXISTS')&quot;&gt; and NOT EXISTS ( select ID_ from ${prefix}ACT_RU_VARIABLE where NAME_ = #{queryVar.name} &lt;if test=&quot;!queryVar.local&quot;&gt; and RES.PROC_INST_ID_ = PROC_INST_ID_ and TASK_ID_ is null &lt;/if&gt; &lt;if test=&quot;queryVar.local&quot;&gt; and RES.ID_ = TASK_ID_ &lt;/if&gt; ) ... ``` Thanks for your help. Regards. St√©ph.</DESCRIPTION>
  <REPONAME>flowable-engine</REPONAME>
  <TIMEDIFFERENCEDAYS>10</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'master' of https://github.com/flowable/flowable-engine into upstream-master</MESSAGE>
    <SHA>f4b55b0f386f62fffb1e6bb318badd1833ecc7bf</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#1680 historicTaskInstance `exists` variable query fix</MESSAGE>
      <SHA>c506ca96b53b366f598a6e283f8c6c41fbf7312e</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/api/history/HistoricTaskAndVariablesQueryTest.java</FILE>
        <FILE>modules/flowable-task-service/src/main/resources/org/flowable/task/service/db/mapping/entity/HistoricTaskInstance.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#1680 historicTaskInstance `exists` variable query fix</MESSAGE>
      <SHA>91dd163da58419367dbd016e6e7bc29924da0b58</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/api/history/HistoricTaskAndVariablesQueryTest.java</FILE>
        <FILE>modules/flowable-task-service/src/main/resources/org/flowable/task/service/db/mapping/entity/HistoricTaskInstance.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#1680 historicTaskInstance `exists` variable query fix (#1681)</MESSAGE>
      <SHA>a3ab6316af969859da3600223baace5e8452ca9e</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/api/history/HistoricTaskAndVariablesQueryTest.java</FILE>
        <FILE>modules/flowable-task-service/src/main/resources/org/flowable/task/service/db/mapping/entity/HistoricTaskInstance.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
