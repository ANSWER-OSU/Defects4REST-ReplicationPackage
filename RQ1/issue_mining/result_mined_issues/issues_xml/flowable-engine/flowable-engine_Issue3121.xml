<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3121</ISSUENO>
  <ISSUEURL>https://github.com/flowable/flowable-engine/issues/3121</ISSUEURL>
  <TITLE>HistoricProcessInstanceQuery also query task variable</TITLE>
  <DESCRIPTION>**Describe the bug** when use HistoricProcessInstanceQuery with variable value, it also query query task variable with the same name **Expected behavior** HistoricProcessInstanceQuery only query process variable **Code** ``` HistoricProcessInstanceQuery query = historyService .createHistoricProcessInstanceQuery() .processInstanceId(&quot;abc&quot;) .includeProcessVariables(); query.variableValueEquals(&quot;process_variable&quot;, &quot;process_variable_value&quot;); query.count(); ``` this query produce a sql : ``` select count(distinct RES.ID_) from ACT_HI_PROCINST RES left outer join ACT_RE_PROCDEF DEF on RES.PROC_DEF_ID_ = DEF.ID_ inner join ACT_HI_VARINST A0 on RES.PROC_INST_ID_ = A0.PROC_INST_ID_ WHERE RES.PROC_INST_ID_ = ? and A0.NAME_ = ? and A0.VAR_TYPE_ = ? and (A0.TEXT_ = ?) ``` the right sql should be ``` select count(distinct RES.ID_) from ACT_HI_PROCINST RES left outer join ACT_RE_PROCDEF DEF on RES.PROC_DEF_ID_ = DEF.ID_ inner join ACT_HI_VARINST A0 on RES.PROC_INST_ID_ = A0.PROC_INST_ID_ WHERE RES.PROC_INST_ID_ = ? and A0.NAME_ = ? and A0.VAR_TYPE_ = ? and (A0.TEXT_ = ?) and A0.TASK_ID_ IS NULL ``` **Additional context** flowable: 6.6.0 , 6.7.0 database: mysql</DESCRIPTION>
  <REPONAME>flowable-engine</REPONAME>
  <TIMEDIFFERENCEDAYS>28</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Use correct waitForAsyncHistoryExecutorToProcessAllJobs in CmmnTaskQueryCaseVariablesTest</MESSAGE>
    <SHA>6d58e7d82c1a84e6939ec66bb59f51e3f0bfc4ec</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix issue with historic process instance query with local variables #3121</MESSAGE>
      <SHA>d193849baa7439dc90637906a92228f0a11aabff</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/history/HistoricProcessInstanceQuery.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/HistoricProcessInstanceQueryImpl.java</FILE>
        <FILE>modules/flowable-engine/src/main/resources/org/flowable/db/mapping/entity/HistoricProcessInstance.xml</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/api/history/HistoricProcessInstanceAndVariablesQueryTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/api/history/HistoryServiceTest.java</FILE>
        <FILE>modules/flowable-variable-service/src/main/java/org/flowable/variable/service/impl/AbstractVariableQueryImpl.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
