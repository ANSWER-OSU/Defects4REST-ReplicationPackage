<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3327</ISSUENO>
  <ISSUEURL>https://github.com/flowable/flowable-engine/issues/3327</ISSUEURL>
  <TITLE>Process instance is incorrect when use JavaDelegate for ExecutionListener</TITLE>
  <DESCRIPTION>**Describe the bug** When I use JavaDelegate for sequenceFlow's ExecutionListener, the process instance give a incorrect result **Expected behavior** Expect a right process **Code** - This is process definition ```xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;definitions xmlns=&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:flowable=&quot;http://flowable.org/bpmn&quot; xmlns:bpmndi=&quot;http://www.omg.org/spec/BPMN/20100524/DI&quot; xmlns:omgdc=&quot;http://www.omg.org/spec/DD/20100524/DC&quot; xmlns:omgdi=&quot;http://www.omg.org/spec/DD/20100524/DI&quot; typeLanguage=&quot;http://www.w3.org/2001/XMLSchema&quot; expressionLanguage=&quot;http://www.w3.org/1999/XPath&quot; targetNamespace=&quot;http://www.flowable.org/processdef&quot; exporter=&quot;Flowable Open Source Modeler&quot; exporterVersion=&quot;6.7.2&quot;&gt; &lt;process id=&quot;MyFlow&quot; name=&quot;MyFlow&quot; isExecutable=&quot;true&quot;&gt; &lt;startEvent id=&quot;startEvent1&quot; flowable:formFieldValidation=&quot;true&quot;&gt;&lt;/startEvent&gt; &lt;userTask id=&quot;sid-5C3D68E7-1D85-43C6-8395-EC625DB7DE07&quot; name=&quot;Production Manager&quot; flowable:candidateUsers=&quot;ProductionManager,StationManager&quot; flowable:formFieldValidation=&quot;true&quot;&gt; &lt;extensionElements&gt; &lt;flowable:taskListener event=&quot;create&quot; class=&quot;com.sealinetech.demo.listener.MyTaskListener&quot;&gt; &lt;flowable:field name=&quot;action&quot;&gt; &lt;flowable:string&gt;&lt;![CDATA[notify1]]&gt;&lt;/flowable:string&gt; &lt;/flowable:field&gt; &lt;/flowable:taskListener&gt; &lt;modeler:user-info-email-ProductionManager xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[ProductionManager@foxmail.com]]&gt;&lt;/modeler:user-info-email-ProductionManager&gt; &lt;modeler:user-info-firstname-ProductionManager xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[生产经理]]&gt;&lt;/modeler:user-info-firstname-ProductionManager&gt; &lt;modeler:user-info-lastname-ProductionManager xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[圣兰]]&gt;&lt;/modeler:user-info-lastname-ProductionManager&gt; &lt;modeler:user-info-email-StationManager xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[StationManager@foxmail.com]]&gt;&lt;/modeler:user-info-email-StationManager&gt; &lt;modeler:user-info-firstname-StationManager xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[站长]]&gt;&lt;/modeler:user-info-firstname-StationManager&gt; &lt;modeler:user-info-lastname-StationManager xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[圣兰]]&gt;&lt;/modeler:user-info-lastname-StationManager&gt; &lt;modeler:activiti-idm-candidate-user xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[true]]&gt;&lt;/modeler:activiti-idm-candidate-user&gt; &lt;modeler:initiator-can-complete xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[false]]&gt;&lt;/modeler:initiator-can-complete&gt; &lt;/extensionElements&gt; &lt;/userTask&gt; &lt;userTask id=&quot;sid-5228C746-FE0B-407A-AE17-7DA540271C46&quot; name=&quot;Station Manager&quot; flowable:assignee=&quot;StationManager&quot; flowable:formFieldValidation=&quot;true&quot;&gt; &lt;extensionElements&gt; &lt;flowable:taskListener event=&quot;create&quot; class=&quot;com.sealinetech.demo.listener.MyTaskListener&quot;&gt; &lt;flowable:field name=&quot;action&quot;&gt; &lt;flowable:string&gt;&lt;![CDATA[notify2]]&gt;&lt;/flowable:string&gt; &lt;/flowable:field&gt; &lt;/flowable:taskListener&gt; &lt;modeler:activiti-idm-assignee xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[true]]&gt;&lt;/modeler:activiti-idm-assignee&gt; &lt;modeler:assignee-info-email xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[StationManager@foxmail.com]]&gt;&lt;/modeler:assignee-info-email&gt; &lt;modeler:assignee-info-firstname xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[站长]]&gt;&lt;/modeler:assignee-info-firstname&gt; &lt;modeler:assignee-info-lastname xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[圣兰]]&gt;&lt;/modeler:assignee-info-lastname&gt; &lt;modeler:initiator-can-complete xmlns:modeler=&quot;http://flowable.org/modeler&quot;&gt;&lt;![CDATA[false]]&gt;&lt;/modeler:initiator-can-complete&gt; &lt;/extensionElements&gt; &lt;/userTask&gt; &lt;endEvent id=&quot;sid-A46C569A-2C8D-448B-9F98-BBB6C13061E0&quot;&gt;&lt;/endEvent&gt; &lt;sequenceFlow id=&quot;sid-5D648E6B-705D-40C9-B911-1880865A22D3&quot; sourceRef=&quot;sid-5C3D68E7-1D85-43C6-8395-EC625DB7DE07&quot; targetRef=&quot;sid-5228C746-FE0B-407A-AE17-7DA540271C46&quot;&gt;&lt;/sequenceFlow&gt; &lt;sequenceFlow id=&quot;sid-BED0F7CD-0089-42DA-88F1-9FBE29745F85&quot; sourceRef=&quot;sid-5228C746-FE0B-407A-AE17-7DA540271C46&quot; targetRef=&quot;sid-A46C569A-2C8D-448B-9F98-BBB6C13061E0&quot;&gt;&lt;/sequenceFlow&gt; &lt;sequenceFlow id=&quot;sid-BBE08CC4-2B4E-415B-ADCE-8B15A2FE55E8&quot; sourceRef=&quot;startEvent1&quot; targetRef=&quot;sid-5C3D68E7-1D85-43C6-8395-EC625DB7DE07&quot;&gt; &lt;extensionElements&gt; &lt;flowable:executionListener event=&quot;take&quot; class=&quot;com.sealinetech.demo.listener.MyExecutionListener&quot;&gt; &lt;flowable:field name=&quot;action&quot;&gt; &lt;flowable:string&gt;&lt;![CDATA[start]]&gt;&lt;/flowable:string&gt; &lt;/flowable:field&gt; &lt;/flowable:executionListener&gt; &lt;/extensionElements&gt; &lt;/sequenceFlow&gt; &lt;/process&gt; &lt;bpmndi:BPMNDiagram id=&quot;BPMNDiagram_MyFlow&quot;&gt; &lt;bpmndi:BPMNPlane bpmnElement=&quot;MyFlow&quot; id=&quot;BPMNPlane_MyFlow&quot;&gt; &lt;bpmndi:BPMNShape bpmnElement=&quot;startEvent1&quot; id=&quot;BPMNShape_startEvent1&quot;&gt; &lt;omgdc:Bounds height=&quot;30.0&quot; width=&quot;30.0&quot; x=&quot;100.0&quot; y=&quot;163.0&quot;&gt;&lt;/omgdc:Bounds&gt; &lt;/bpmndi:BPMNShape&gt; &lt;bpmndi:BPMNShape bpmnElement=&quot;sid-5C3D68E7-1D85-43C6-8395-EC625DB7DE07&quot; id=&quot;BPMNShape_sid-5C3D68E7-1D85-43C6-8395-EC625DB7DE07&quot;&gt; &lt;omgdc:Bounds height=&quot;80.0&quot; width=&quot;100.0&quot; x=&quot;175.0&quot; y=&quot;138.0&quot;&gt;&lt;/omgdc:Bounds&gt; &lt;/bpmndi:BPMNShape&gt; &lt;bpmndi:BPMNShape bpmnElement=&quot;sid-5228C746-FE0B-407A-AE17-7DA540271C46&quot; id=&quot;BPMNShape_sid-5228C746-FE0B-407A-AE17-7DA540271C46&quot;&gt; &lt;omgdc:Bounds height=&quot;79.0&quot; width=&quot;98.0&quot; x=&quot;315.0&quot; y=&quot;138.0&quot;&gt;&lt;/omgdc:Bounds&gt; &lt;/bpmndi:BPMNShape&gt; &lt;bpmndi:BPMNShape bpmnElement=&quot;sid-A46C569A-2C8D-448B-9F98-BBB6C13061E0&quot; id=&quot;BPMNShape_sid-A46C569A-2C8D-448B-9F98-BBB6C13061E0&quot;&gt; &lt;omgdc:Bounds height=&quot;28.0&quot; width=&quot;28.0&quot; x=&quot;465.0&quot; y=&quot;163.5&quot;&gt;&lt;/omgdc:Bounds&gt; &lt;/bpmndi:BPMNShape&gt; &lt;bpmndi:BPMNEdge bpmnElement=&quot;sid-BBE08CC4-2B4E-415B-ADCE-8B15A2FE55E8&quot; id=&quot;BPMNEdge_sid-BBE08CC4-2B4E-415B-ADCE-8B15A2FE55E8&quot; flowable:sourceDockerX=&quot;15.0&quot; flowable:sourceDockerY=&quot;15.0&quot; flowable:targetDockerX=&quot;50.0&quot; flowable:targetDockerY=&quot;40.0&quot;&gt; &lt;omgdi:waypoint x=&quot;129.9499984899576&quot; y=&quot;178.0&quot;&gt;&lt;/omgdi:waypoint&gt; &lt;omgdi:waypoint x=&quot;174.9999999999917&quot; y=&quot;178.0&quot;&gt;&lt;/omgdi:waypoint&gt; &lt;/bpmndi:BPMNEdge&gt; &lt;bpmndi:BPMNEdge bpmnElement=&quot;sid-BED0F7CD-0089-42DA-88F1-9FBE29745F85&quot; id=&quot;BPMNEdge_sid-BED0F7CD-0089-42DA-88F1-9FBE29745F85&quot; flowable:sourceDockerX=&quot;35.5&quot; flowable:sourceDockerY=&quot;40.0&quot; flowable:targetDockerX=&quot;14.0&quot; flowable:targetDockerY=&quot;14.0&quot;&gt; &lt;omgdi:waypoint x=&quot;412.94999999999476&quot; y=&quot;177.7568093385214&quot;&gt;&lt;/omgdi:waypoint&gt; &lt;omgdi:waypoint x=&quot;465.00010099159215&quot; y=&quot;177.554279921789&quot;&gt;&lt;/omgdi:waypoint&gt; &lt;/bpmndi:BPMNEdge&gt; &lt;bpmndi:BPMNEdge bpmnElement=&quot;sid-5D648E6B-705D-40C9-B911-1880865A22D3&quot; id=&quot;BPMNEdge_sid-5D648E6B-705D-40C9-B911-1880865A22D3&quot; flowable:sourceDockerX=&quot;50.0&quot; flowable:sourceDockerY=&quot;40.0&quot; flowable:targetDockerX=&quot;49.0&quot; flowable:targetDockerY=&quot;39.5&quot;&gt; &lt;omgdi:waypoint x=&quot;274.94999999999277&quot; y=&quot;177.8201438848921&quot;&gt;&lt;/omgdi:waypoint&gt; &lt;omgdi:waypoint x=&quot;315.0&quot; y=&quot;177.67607913669062&quot;&gt;&lt;/omgdi:waypoint&gt; &lt;/bpmndi:BPMNEdge&gt; &lt;/bpmndi:BPMNPlane&gt; &lt;/bpmndi:BPMNDiagram&gt; &lt;/definitions&gt; ``` - This is MyExecutionListener, if MyExecutionListener implements from ExecutionListener, the result is right ```java public class MyExecutionListener implements JavaDelegate /* ExecutionListener */ { private FixedValue action; @Override public void execute(DelegateExecution execution) { System.out.println(&quot;Hello ExecutionListener --- &quot; + action.getExpressionText()); } } ``` - This is MyTaskListener ```java public class MyTaskListener implements TaskListener { private FixedValue action; @Override public void notify(DelegateTask delegateTask) { System.out.println(&quot;Hello TaskListener --- &quot; + action.getExpressionText()); } } ``` - Process is start by the code below ```java public String index() { runtimeService.startProcessInstanceByKey(&quot;MyFlow&quot;); return &quot;Hello flowable&quot;; } ``` - Here is the incorrect result, the ProductionManager task is not executed, but the StationManager is executed twice, when I use the ExecutionListener interface, the result is OK Hello ExecutionListener --- start Hello TaskListener --- notify2 Hello TaskListener --- notify2 **Additional context** flowable version is 6.7.2 spring boot version is 2.6.2 database is mysql, its version is 8.0</DESCRIPTION>
  <REPONAME>flowable-engine</REPONAME>
  <TIMEDIFFERENCEDAYS>43</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add deleteReason param to DELETE process instance (#3291) Create documentation for the deleteReason parameter of the DELETE process instance action</MESSAGE>
    <SHA>bfe00ce30a8a6b29996411b6c9b503360d8bb94f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix wrong behavior for JavaDelegate as executionListener fixes #3327 See problem description in issue #3327</MESSAGE>
      <SHA>6b799128373f77d1d9271c50d738e3baa42177e6</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/helper/ClassDelegate.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/examples/bpmn/executionlistener/JavaDelegateTestExecutionListener.java</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/examples/bpmn/executionlistener/ExecutionListenerJavaDelegate.bpmn20.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix wrong behavior for JavaDelegate as executionListener fixes #3327 See problem description in issue #3327</MESSAGE>
      <SHA>798413954157cedf63896ea74bb27d780aaf8e71</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/helper/ClassDelegate.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/listener/DelegateExecutionListener.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/examples/bpmn/executionlistener/JavaDelegateTestExecutionListener.java</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/examples/bpmn/executionlistener/ExecutionListenerJavaDelegate.bpmn20.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix wrong behavior for JavaDelegate as executionListener (#3387) fixes #3327</MESSAGE>
      <SHA>c15f8ce0df5bc8e10b4648161ff1acb8b23d25df</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/helper/ClassDelegate.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/listener/DelegateExecutionListener.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/examples/bpmn/executionlistener/JavaDelegateTestExecutionListener.java</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/examples/bpmn/executionlistener/ExecutionListenerJavaDelegate.bpmn20.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix wrong behavior for JavaDelegate as executionListener (#3387) fixes #3327</MESSAGE>
      <SHA>b27653f869d7adcafedc87be4e07a18121d0400c</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/helper/ClassDelegate.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/listener/DelegateExecutionListener.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/examples/bpmn/executionlistener/ExecutionListenerTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/examples/bpmn/executionlistener/JavaDelegateTestExecutionListener.java</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/examples/bpmn/executionlistener/ExecutionListenerJavaDelegate.bpmn20.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
