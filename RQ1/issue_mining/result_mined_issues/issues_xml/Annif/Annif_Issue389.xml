<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>389</ISSUENO>
  <ISSUEURL>https://github.com/NatLibFi/Annif/issues/389</ISSUEURL>
  <TITLE>Annif breaks when MauiServer returns malformed URIs for topic IDs</TITLE>
  <DESCRIPTION>### Steps to reproduce ``` annif loadvoc rula-maui-en Annif-corpora/vocab/lcsh/lcsh.ttl annif train rula-maui-en Annif-corpora/fulltext/rula/validate/ ``` https://github.com/mjsuhonos/Annif-corpora/blob/master/vocab/lcsh/lcsh.ttl https://github.com/mjsuhonos/Annif-corpora/tree/master/fulltext/rula/validate ``` annif eval rula-maui-en Annif-corpora/fulltext/rula/test/ -v DEBUG ``` ```python â€¦ warning: Unknown subject URI &lt;http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450&gt; Traceback (most recent call last): File &quot;/usr/local/bin/annif&quot;, line 11, in &lt;module&gt; load_entry_point('annif', 'console_scripts', 'annif')() File &quot;/usr/local/lib/python3.7/site-packages/click/core.py&quot;, line 764, in __call__ return self.main(*args, **kwargs) File &quot;/usr/local/lib/python3.7/site-packages/flask/cli.py&quot;, line 586, in main return super(FlaskGroup, self).main(*args, **kwargs) File &quot;/usr/local/lib/python3.7/site-packages/click/core.py&quot;, line 717, in main rv = self.invoke(ctx) File &quot;/usr/local/lib/python3.7/site-packages/click/core.py&quot;, line 1137, in invoke return _process_result(sub_ctx.command.invoke(sub_ctx)) File &quot;/usr/local/lib/python3.7/site-packages/click/core.py&quot;, line 956, in invoke return ctx.invoke(self.callback, **ctx.params) File &quot;/usr/local/lib/python3.7/site-packages/click/core.py&quot;, line 555, in invoke return callback(*args, **kwargs) File &quot;/usr/local/lib/python3.7/site-packages/click/decorators.py&quot;, line 17, in new_func return f(get_current_context(), *args, **kwargs) File &quot;/usr/local/lib/python3.7/site-packages/flask/cli.py&quot;, line 426, in decorator return __ctx.invoke(f, *args, **kwargs) File &quot;/usr/local/lib/python3.7/site-packages/click/core.py&quot;, line 555, in invoke return callback(*args, **kwargs) File &quot;/Annif/annif/cli.py&quot;, line 305, in run_eval results = project.suggest(doc.text, backend_params) File &quot;/Annif/annif/project.py&quot;, line 161, in suggest hits = self._suggest_with_backend(text, backend_params) File &quot;/Annif/annif/project.py&quot;, line 105, in _suggest_with_backend hits = self.backend.suggest(text, beparams) File &quot;/Annif/annif/backend/backend.py&quot;, line 67, in suggest return self._suggest(text, params=beparams) File &quot;/Annif/annif/backend/maui.py&quot;, line 155, in _suggest return self._response_to_result(response) File &quot;/Annif/annif/backend/maui.py&quot;, line 150, in _response_to_result self.project.subjects) File &quot;/Annif/annif/suggestion.py&quot;, line 169, in create_from_index subject = subject_index[subject_index.by_uri(hit.uri)] File &quot;/Annif/annif/corpus/subject.py&quot;, line 55, in __getitem__ return (self._uris[subject_id], self._labels[subject_id], TypeError: list indices must be integers or slices, not NoneType ``` ### Malformed response Document source (1126 bytes) &gt; Key findings: The survey results for both countries were similar in terms of the percentage of respondents who reported working in smaller newsrooms and working longer hours compared to two years ago Respondents in both countries said that the perception of local newspapers as a dying industry deters advertisers and makes it challenging to recruit new staff Use of metrics to measure engagement and shape the production of stories is about the same in both countries Respondents in Canada and the United States both reported that few employers provided training courses to assist with learning about new technologies While approximately half of the participants in both surveys felt slightly or very secure in their jobs, almost twice as many Canadians felt slightly or very insecure in their jobs American respondents overall tended to be more positive about the future of local newspapers Respondents from American newspapers were more likely to use video reporting, live video and **and podcasts than their Canadian counterparts Researchers who compare the state of local journalism across** ```json { &quot;title&quot;: &quot;10 recommendations from rula-maui-en&quot;, &quot;topics&quot;: [ { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85004368&quot;, &quot;label&quot;: &quot;American newspapers&quot;, &quot;probability&quot;: 0.06058101652075777 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450&quot;, &quot;label&quot;: &quot;http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450&quot;, &quot;probability&quot;: 0.03634347847356808 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85143204&quot;, &quot;label&quot;: &quot;Video recordings&quot;, &quot;probability&quot;: 0.02480501693510654 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85070585&quot;, &quot;label&quot;: &quot;Job security&quot;, &quot;probability&quot;: 0.022298487879186563 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh2007001518&quot;, &quot;label&quot;: &quot;Podcasts&quot;, &quot;probability&quot;: 0.021532180099457447 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh2006006472&quot;, &quot;label&quot;: &quot;Podcasting&quot;, &quot;probability&quot;: 0.021532180099457447 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh2012001802&quot;, &quot;label&quot;: &quot;Podcasters&quot;, &quot;probability&quot;: 0.021532180099457447 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85091588&quot;, &quot;label&quot;: &quot;Newspapers&quot;, &quot;probability&quot;: 0.01622784151074123 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh99001641&quot;, &quot;label&quot;: &quot;Newspapers&quot;, &quot;probability&quot;: 0.01622784151074123 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh2007008878&quot;, &quot;label&quot;: &quot;First responders&quot;, &quot;probability&quot;: 0.01622784151074123 } ] } ``` ### Correct response Document source (1126 bytes) &gt; Key findings: The survey results for both countries were similar in terms of the percentage of respondents who reported working in smaller newsrooms and working longer hours compared to two years ago Respondents in both countries said that the perception of local newspapers as a dying industry deters advertisers and makes it challenging to recruit new staff Use of metrics to measure engagement and shape the production of stories is about the same in both countries Respondents in Canada and the United States both reported that few employers provided training courses to assist with learning about new technologies While approximately half of the participants in both surveys felt slightly or very secure in their jobs, almost twice as many Canadians felt slightly or very insecure in their jobs American respondents overall tended to be more positive about the future of local newspapers Respondents from American newspapers were more likely to use video reporting, live video and **common questions revealed two notable differences between the countries. The first had to do with sentiments** ```json { &quot;title&quot;: &quot;10 recommendations from rula-maui-en&quot;, &quot;topics&quot;: [ { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85004368&quot;, &quot;label&quot;: &quot;American newspapers&quot;, &quot;probability&quot;: 0.06058101652075777 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85143204&quot;, &quot;label&quot;: &quot;Video recordings&quot;, &quot;probability&quot;: 0.02480501693510654 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85070585&quot;, &quot;label&quot;: &quot;Job security&quot;, &quot;probability&quot;: 0.022298487879186563 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85091588&quot;, &quot;label&quot;: &quot;Newspapers&quot;, &quot;probability&quot;: 0.01622784151074123 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh99001641&quot;, &quot;label&quot;: &quot;Newspapers&quot;, &quot;probability&quot;: 0.01622784151074123 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh2007008878&quot;, &quot;label&quot;: &quot;First responders&quot;, &quot;probability&quot;: 0.01622784151074123 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh93009373&quot;, &quot;label&quot;: &quot;Advertisers&quot;, &quot;probability&quot;: 0.01382364849909128 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh85001086&quot;, &quot;label&quot;: &quot;Advertising&quot;, &quot;probability&quot;: 0.01382364849909128 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh2001009077&quot;, &quot;label&quot;: &quot;Supplementary employment&quot;, &quot;probability&quot;: 0.01382364849909128 }, { &quot;id&quot;: &quot;http://id.loc.gov/authorities/subjects/sh2005004875&quot;, &quot;label&quot;: &quot;Employability&quot;, &quot;probability&quot;: 0.01382364849909128 } ] } ``` ### Suspected cause This vocabulary contains two `skos:prefLabel` statements with identical object literals: ``` &lt;http://id.loc.gov/authorities/genreForms/gf2011026450&gt; &lt;http://www.w3.org/2004/02/skos/core#prefLabel&gt; &quot;Podcasts&quot;@en . &lt;http://id.loc.gov/authorities/subjects/sh2007001518&gt; &lt;http://www.w3.org/2004/02/skos/core#prefLabel&gt; &quot;Podcasts&quot;@en . ``` It seems plausible that due to its lexical approach, Maui uses the object literal as a unique value, which would match two topic URIs, given the above statements. The (albeit strangely truncated) concatenation of these two URI values are then returned in the response. This theory is currently being tested. ### Proposed resolution Ideally, Annif could extract valid URIs from the invalid response, but this may be too much overhead if each response URI must be validated. At a minimum, Annif should ignore the malformed response and continue with eg. a warning statement on STDERR.</DESCRIPTION>
  <REPONAME>Annif</REPONAME>
  <TIMEDIFFERENCEDAYS>26</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Modify unit test to exercise all code paths</MESSAGE>
    <SHA>3ae06f900bb1b9d46f1c26fd5b8b5dae47d1aaef</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Robustness fix: Don't break if Maui returns an unknown URI. Fixes #389</MESSAGE>
      <SHA>158616229b4dbe5be76dcb1e2a8d70df3f432a77</SHA>
      <PATCHEDFILES>
        <FILE>annif/suggestion.py</FILE>
        <FILE>tests/test_backend_maui.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
