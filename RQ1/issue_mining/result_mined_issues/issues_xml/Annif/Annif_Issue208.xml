<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>208</ISSUENO>
  <ISSUEURL>https://github.com/NatLibFi/Annif/issues/208</ISSUEURL>
  <TITLE>Robustness issues in HTTP backend</TITLE>
  <DESCRIPTION>These issues are similar enough that I'm only opening a single issue. When using the `arto-fi` data set to train a PAV model, I got this exception: ``` File &quot;/srv/Annif/annif/backend/pav.py&quot;, line 69, in _analyze_train_corpus hits = source_project.analyze(doc.text) File &quot;/srv/Annif/annif/project.py&quot;, line 158, in analyze hits_from_backends = self._analyze_with_backends(text, backend_params) File &quot;/srv/Annif/annif/project.py&quot;, line 109, in _analyze_with_backends hits = backend.analyze(text, project=self, params=beparams) File &quot;/srv/Annif/annif/backend/backend.py&quot;, line 53, in analyze return self._analyze(text, project, params=beparams) File &quot;/srv/Annif/annif/backend/http.py&quot;, line 17, in _analyze req = requests.post(params['endpoint'], data=data) File &quot;/srv/Annif/.venv/lib/python3.6/site-packages/requests/api.py&quot;, line 116, in post return request('post', url, data=data, json=json, **kwargs) File &quot;/srv/Annif/.venv/lib/python3.6/site-packages/requests/api.py&quot;, line 60, in request return session.request(method=method, url=url, **kwargs) File &quot;/srv/Annif/.venv/lib/python3.6/site-packages/requests/sessions.py&quot;, line 533, in request resp = self.send(prep, **send_kwargs) File &quot;/srv/Annif/.venv/lib/python3.6/site-packages/requests/sessions.py&quot;, line 646, in send r = adapter.send(request, **kwargs) File &quot;/srv/Annif/.venv/lib/python3.6/site-packages/requests/adapters.py&quot;, line 498, in send raise ConnectionError(err, request=request) requests.exceptions.ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) ``` When training a PAV model with the `jyu-fin` data set, I got this: ``` File &quot;/srv/Annif/annif/backend/pav.py&quot;, line 80, in _create_pav_model scores, true = self._analyze_train_corpus(source_project, corpus) File &quot;/srv/Annif/annif/backend/pav.py&quot;, line 69, in _analyze_train_corpus hits = source_project.analyze(doc.text) File &quot;/srv/Annif/annif/project.py&quot;, line 158, in analyze hits_from_backends = self._analyze_with_backends(text, backend_params) File &quot;/srv/Annif/annif/project.py&quot;, line 109, in _analyze_with_backends hits = backend.analyze(text, project=self, params=beparams) File &quot;/srv/Annif/annif/backend/backend.py&quot;, line 53, in analyze return self._analyze(text, project, params=beparams) File &quot;/srv/Annif/annif/backend/http.py&quot;, line 26, in _analyze for h in results File &quot;/srv/Annif/annif/backend/http.py&quot;, line 27, in &lt;listcomp&gt; if h['score'] &gt; 0.0], TypeError: string indices must be integers ``` In both cases the problem is that HTTP exceptions and other error conditions are not properly handled by the HTTP backend.</DESCRIPTION>
  <REPONAME>Annif</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Use errors=replace for more robust handling of text corpus files. Fixes #207</MESSAGE>
    <SHA>897db7b2f2f05c6e7c0249b1fdfe10f0de9ee574</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Handle HTTP exceptions and error codes in http backend. Part of #208</MESSAGE>
      <SHA>142de278afe14d286c9909a9db67e64b6688c80d</SHA>
      <PATCHEDFILES>
        <FILE>annif/backend/http.py</FILE>
        <FILE>tests/test_backend_http.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Handle case where JSON decoding fails in HTTP backend. Part of #208</MESSAGE>
      <SHA>73bcfd4b600226d904c5344ae30e2feea3923ddd</SHA>
      <PATCHEDFILES>
        <FILE>annif/backend/http.py</FILE>
        <FILE>tests/test_backend_http.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Handle unexpected JSON data in HTTP backend. Part of #208</MESSAGE>
      <SHA>d58fbea56b5f91321789187b174add42bdc881ef</SHA>
      <PATCHEDFILES>
        <FILE>annif/backend/http.py</FILE>
        <FILE>tests/test_backend_http.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
