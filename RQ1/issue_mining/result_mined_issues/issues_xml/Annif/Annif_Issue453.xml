<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>453</ISSUENO>
  <ISSUEURL>https://github.com/NatLibFi/Annif/issues/453</ISSUEURL>
  <TITLE>Parallelized eval of nn_ensemble projects hangs</TITLE>
  <DESCRIPTION>When running evaluations for new models with four parallel jobs I noticed that evaluation of nn_ensemble projects never finished. Without multiprocessing there was no problem. Minimal example: ``` # projects.cfg: [arch-fasttext] name=FastText language=fi backend=fasttext limit=100 vocab=arch analyzer=snowball(finnish) [arch-nn] name=YSO NN ensemble Finnish language=fi backend=nn_ensemble sources=arch-fasttext limit=100 vocab=arch nodes=100 dropout_rate=0.2 epochs=2 # Testing: annif loadvoc arch-fasttext tests/corpora/archaeology/subjects.tsv annif train arch-fasttext tests/corpora/archaeology/documents.tsv annif train arch-nn tests/corpora/archaeology/fulltext/ time annif eval arch-nn tests/corpora/archaeology/documents.tsv --jobs 1 # finishes in 3 min time annif eval arch-nn tests/corpora/archaeology/documents.tsv --jobs 2 # won't finish ``` This seems to be a common problem, there's many search results for &quot;python multiprocess hangs when calling a tensorflow model&quot;. The problem occurs at least with TF versions 2.2.0 and 2.3.1. A quick fix could be to throw a `NotSupportedException` instead of indefinite freeze. Parallelized eval was not promised to work with nn_ensemble when the feature was implemented in #418.</DESCRIPTION>
  <REPONAME>Annif</REPONAME>
  <TIMEDIFFERENCEDAYS>266</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Avoid initializing project twice</MESSAGE>
    <SHA>c69b065a436e96773f62a3c3425a6a5d83b31a90</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Avoid loading TF models just before parallel execution in eval. Fixes #453</MESSAGE>
      <SHA>56b992efd709a86a57a4a2b0d9aec2b789a33ec5</SHA>
      <PATCHEDFILES>
        <FILE>annif/backend/backend.py</FILE>
        <FILE>annif/backend/dummy.py</FILE>
        <FILE>annif/backend/ensemble.py</FILE>
        <FILE>annif/backend/fasttext.py</FILE>
        <FILE>annif/backend/mllm.py</FILE>
        <FILE>annif/backend/nn_ensemble.py</FILE>
        <FILE>annif/backend/omikuji.py</FILE>
        <FILE>annif/backend/pav.py</FILE>
        <FILE>annif/backend/stwfsa.py</FILE>
        <FILE>annif/backend/svc.py</FILE>
        <FILE>annif/backend/tfidf.py</FILE>
        <FILE>annif/backend/vw_multi.py</FILE>
        <FILE>annif/backend/yake.py</FILE>
        <FILE>annif/cli.py</FILE>
        <FILE>annif/project.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
