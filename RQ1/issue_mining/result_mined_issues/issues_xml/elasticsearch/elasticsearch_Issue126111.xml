<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>126111</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/126111</ISSUEURL>
  <TITLE>Optimize segment merging in the tsdb doc value codec</TITLE>
  <DESCRIPTION>The doc values codec iterates a few times over the doc value instance that needs to be written to disk. In case when merging and index sorting is enabled, this is much more expensive, as each time the doc values instance is iterated a merge sort is performed (in order to get the doc ids from different segments in order of index sorting). There are several reasons why the doc value instance is iterated multiple times: - To compute stats (num values, number of docs with value) required for writing values to disk. - To write bitset that indicate which documents have a value. (indexed disi, jump table) - To write the actual values to disk. - To write the addresses to disk (in case docs have multiple values) This applies for numeric doc values, but also for the ordinals of sorted (set) doc values. The following changes should be made to address this performance issue: - [x] Change the tsdb doc values format to allows store `numDocsWithField` as metadata and store jump table after the values (#125933). - [x] Reuse statistics used during merging from the metadata instead of computing it on the fly by creating a merged `SortedNumericDocValues ` (#125403). - [x] Keep track of documents with value while iterating over values and use that to write jump table later (#126499) - [x] Keep track of `docValueCount` while iterating over values and write to later for the address offsets. (#126732) - [x] Optimize merging binary doc value. By accumulating offsets and disi, so that we iterate once. (#127278)</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>23</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add ability to redirect ingestion failures on data streams to a failure store (#126973) Removes the feature flags and guards that prevent the new failure store functionality from operating in production runtimes.</MESSAGE>
    <SHA>7b89f4d4a6b12abf0a1571a924a6a6363f3e5139</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Optimize ES819 doc values address offset calculation (#126732) When writing the doc values addresses, we currently perform an iteration over all the sorted numeric doc values to calculate the addresses. When merging sorted segments, this iteration is expensive as it requires performing a merge sort. This patch removes this iteration by instead calculating the addresses while we are writing the values, writing the addresses to a temporary file. Afterwards, they are copied from the temporary file into the merged segment. Relates to #126111</MESSAGE>
      <SHA>b972364539cbaba02b2b03c89cf95c70d000e545</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elasticsearch/index/codec/tsdb/es819/ES819TSDBDocValuesConsumer.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/codec/tsdb/es819/OffsetsAccumulator.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/index/codec/tsdb/es819/ES819TSDBDocValuesFormatTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Optimize ES819 doc values address offset calculation (#126732) (#127079) When writing the doc values addresses, we currently perform an iteration over all the sorted numeric doc values to calculate the addresses. When merging sorted segments, this iteration is expensive as it requires performing a merge sort. This patch removes this iteration by instead calculating the addresses while we are writing the values, writing the addresses to a temporary file. Afterwards, they are copied from the temporary file into the merged segment. Relates to #126111</MESSAGE>
      <SHA>0d376770308c6c9ab7d460b7cf39861559a309b8</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elasticsearch/index/codec/tsdb/es819/ES819TSDBDocValuesConsumer.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/codec/tsdb/es819/OffsetsAccumulator.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/index/codec/tsdb/es819/ES819TSDBDocValuesFormatTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
