<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>126742</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/126742</ISSUEURL>
  <TITLE>[CI] GeoDistanceIT testDistanceSortingWithUnmappedField failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic #7620 / openjdk17_checkpart1_java-fips-matrix](https://gradle-enterprise.elastic.co/s/yak7bs3dh7ln4) - [elasticsearch-periodic-platform-support #7614 / debian-12_platform-support-unix](https://gradle-enterprise.elastic.co/s/537qlqaeyas26) - [elasticsearch-periodic-platform-support #7614 / rhel-9_platform-support-unix](https://gradle-enterprise.elastic.co/s/vdqs5yvzjc5l2) - [elasticsearch-periodic #7578 / openjdk23_checkpart1_java-matrix](https://gradle-enterprise.elastic.co/s/udwja2z7fxoqy) **Reproduction Line:** ``` ./gradlew &quot;:server:internalClusterTest&quot; --tests &quot;org.elasticsearch.search.sort.GeoDistanceIT.testDistanceSortingWithUnmappedField&quot; -Dtests.seed=6216A97CDE49EF02 -Dtests.locale=nn -Dtests.timezone=America/Creston -Druntime.java=17 -Dtests.fips.enabled=true ``` **Applicable branches:** 8.x **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.search.sort.GeoDistanceIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testDistanceSortingWithUnmappedField),title:'Test',type:optionsListControl))))) **Failure Message:** ``` org.elasticsearch.action.search.SearchPhaseExecutionException: ``` **Issue Reasons:** - [8.x] 4 failures in test testDistanceSortingWithUnmappedField (1.8% fail rate in 221 executions) - [8.x] 2 failures in pipeline elasticsearch-periodic (28.6% fail rate in 7 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.xpack.test.rest.XPackRestIT test {p0=transform/transforms_start_stop/Test start/stop/start continuous transform} #126755</MESSAGE>
    <SHA>411a946b7f59d2a1fcfbe4951a2cba86df292f36</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Remove empty results before merging We addressed the empty top docs issue with #126385 specifically for scenarios where empty top docs don't go through the wire. Yet they may be serialized from data node back to the coord node, in which case they will no longer be equal to Lucene#EMPTY_TOP_DOCS. This commit expands the existing filtering of empty top docs to include also those that did go through serialization. Closes #126742</MESSAGE>
      <SHA>e7cf1e9f68bf1fc0a0962adbb401d189fa6188b6</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Remove empty results before merging (#126770) We addressed the empty top docs issue with #126385 specifically for scenarios where empty top docs don't go through the wire. Yet they may be serialized from data node back to the coord node, in which case they will no longer be equal to Lucene#EMPTY_TOP_DOCS. This commit expands the existing filtering of empty top docs to include also those that did go through serialization. Closes #126742</MESSAGE>
      <SHA>f274ab7402c40c8b003e55f15a541481a1d6506b</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/126770.yaml</FILE>
        <FILE>muted-tests.yml</FILE>
        <FILE>server/src/main/java/org/elasticsearch/TransportVersions.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/action/search/QueryPhaseResultConsumer.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/common/lucene/Lucene.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Remove empty results before merging (#126770) (#127031) We addressed the empty top docs issue with #126385 specifically for scenarios where empty top docs don't go through the wire. Yet they may be serialized from data node back to the coord node, in which case they will no longer be equal to Lucene#EMPTY_TOP_DOCS. This commit expands the existing filtering of empty top docs to include also those that did go through serialization. Closes #126742</MESSAGE>
      <SHA>21563fae38d00c22e94ccbe1d3c094fbad51a8af</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/126770.yaml</FILE>
        <FILE>server/src/main/java/org/elasticsearch/TransportVersions.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/action/search/QueryPhaseResultConsumer.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/common/lucene/Lucene.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
