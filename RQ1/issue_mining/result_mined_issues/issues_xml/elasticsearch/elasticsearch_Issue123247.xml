<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>123247</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/123247</ISSUEURL>
  <TITLE>Avoid license checks on every call to `LicensedWriteLoadForecaster#getForecastedWriteLoad`</TITLE>
  <DESCRIPTION>In production the `LicensedWriteLoadForecaster#hasValidLicense` predicate calls `XPackLicenseState#featureUsed` which records the usage time of the feature in a `ConcurrentHashMap`. We call this in hot O(#shards) loops in various places, e.g. here: ``` 4/10 snapshots sharing following 19 elements java.base@23/java.util.concurrent.ConcurrentHashMap.put(ConcurrentHashMap.java:1007) org.elasticsearch.xcore@8.17.0/org.elasticsearch.license.XPackLicenseState.featureUsed(XPackLicenseState.java:429) org.elasticsearch.xcore@8.17.0/org.elasticsearch.license.LicensedFeature$Momentary.check(LicensedFeature.java:32) org.elasticsearch.xpack.writeloadforecaster.WriteLoadForecasterPlugin.hasValidLicense(WriteLoadForecasterPlugin.java:44) org.elasticsearch.xpack.writeloadforecaster.WriteLoadForecasterPlugin$$Lambda/0x00003f00017f2550.getAsBoolean(Unknown Source) org.elasticsearch.xpack.writeloadforecaster.LicensedWriteLoadForecaster.getForecastedWriteLoad(LicensedWriteLoadForecaster.java:146) app/org.elasticsearch.server@8.17.0/org.elasticsearch.cluster.routing.allocation.AllocationStatsService.stats(AllocationStatsService.java:65) app/org.elasticsearch.server@8.17.0/org.elasticsearch.action.admin.cluster.allocation.TransportGetAllocationStatsAction.masterOperation(TransportGetAllocationStatsAction.java:94) ``` This is rather expensive at the best of times, and astronomically expensive when multiple threads are running such loops (because of all the contention on that one CHM lock). We don't need to enforce the license expiry so precisely, so we can surely relax this licence-validity check to a simple volatile read, refreshing the validity flag via some periodic background process.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Move eclipse specific extention property into elasticsearch eclipse plugin (#123320)</MESSAGE>
    <SHA>4bd1f81ef90a283a9271f8d079ecf2196b541ca9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Reduce licence checks in `LicensedWriteLoadForecaster` Rather than checking the license (updating the usage map) on every single shard, just do it once at the start of a computation that needs to forecast write loads. Closes #123247</MESSAGE>
      <SHA>1b1c061aa26ad75decfb0cc1c82fee1beee7eea6</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elasticsearch/action/admin/cluster/allocation/TransportGetDesiredBalanceAction.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/cluster/routing/allocation/NodeAllocationStatsAndWeightsCalculator.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/cluster/routing/allocation/WriteLoadForecaster.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java</FILE>
        <FILE>test/framework/src/main/java/org/elasticsearch/cluster/ESAllocationTestCase.java</FILE>
        <FILE>x-pack/plugin/write-load-forecaster/src/internalClusterTest/java/org/elasticsearch/xpack/writeloadforecaster/WriteLoadForecasterIT.java</FILE>
        <FILE>x-pack/plugin/write-load-forecaster/src/main/java/org/elasticsearch/xpack/writeloadforecaster/LicensedWriteLoadForecaster.java</FILE>
        <FILE>x-pack/plugin/write-load-forecaster/src/test/java/org/elasticsearch/xpack/writeloadforecaster/LicensedWriteLoadForecasterTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
