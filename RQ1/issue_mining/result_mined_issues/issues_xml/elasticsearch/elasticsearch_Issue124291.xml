<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>124291</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/124291</ISSUEURL>
  <TITLE>[CI] MetricsApmIT testApmIntegration failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #6836 / almalinux-9_platform-support-unix](https://gradle-enterprise.elastic.co/s/ceshqrwljeji4) - [elasticsearch-pull-request #59805 / part-1](https://gradle-enterprise.elastic.co/s/gxlenwqzhenqy) - [elasticsearch-pull-request #59780 / part-1](https://gradle-enterprise.elastic.co/s/izoat6zkmxgxk) - [elasticsearch-pull-request #59780 / part-1](https://gradle-enterprise.elastic.co/s/tmsoskml6vwmg) **Reproduction Line:** ``` ./gradlew &quot;:test:external-modules:test-apm-integration:javaRestTest&quot; --tests &quot;org.elasticsearch.test.apmintegration.MetricsApmIT.testApmIntegration&quot; -Dtests.seed=A7396AAA6A124AA8 -Dtests.locale=ru-KZ -Dtests.timezone=Etc/GMT+6 -Druntime.java=24 ``` **Applicable branches:** 9.0 **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.test.apmintegration.MetricsApmIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testApmIntegration),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.RuntimeException: An error occurred orchestrating test cluster. ``` **Issue Reasons:** - [9.0] 4 failures in test testApmIntegration (0.7% fail rate in 590 executions) - [9.0] 3 failures in step part-1 (4.2% fail rate in 72 executions) - [9.0] 2 failures in pipeline elasticsearch-pull-request (2.8% fail rate in 72 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>59</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Retry ILM async action after reindexing data stream (#124149) (#124280) When reindexing a data stream, the ILM metadata is copied from the index metadata of the source index to the destination index. But the ILM state of the new index can be stuck if the source index was in an AsyncAction at the time of reindexing. To un-stick the new index, we call TransportRetryAction to retry the AsyncAction. In the past this action would only run if the index were in the error phase. This change includes an update to TransportRetryAction, which allows it to be run when the index is not in an error phase, if the parameter requireError is set to false. (cherry picked from commit 10a8dcf0fb4e5c3757e26dfc777dc84dfc25fae3) # Conflicts: # server/src/main/java/org/elasticsearch/TransportVersions.java # x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/action/TransportRetryAction.java</MESSAGE>
    <SHA>12b402cb16bfe860cfd8a572e97ba992198cd1e9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.test.apmintegration.MetricsApmIT testApmIntegration #124291</MESSAGE>
      <SHA>5adaa9135cfbf0b604cfa9d6c36c22b57fa43e8a</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Unmute MetricsApmIT (closes #124291)</MESSAGE>
      <SHA>e551e41257f024fc337eabbab3064e246fa5eb7f</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Unmute MetricsApmIT (closes #124291) (#124471) Unmute MetricsApmIT (closes #124291). This was already fixed by https://github.com/elastic/elasticsearch/pull/123744.</MESSAGE>
      <SHA>91f33cb52811fa65f259b9ad4c56cce6ea3d5900</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Unmute TracesApmIT (related to #124291)</MESSAGE>
      <SHA>cbf9dc1e13c3d5bbe3d65ac7a18852be607bc832</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Unmute TracesApmIT (related to #124291) (#124475) Unmute TracesApmIT (related to #124291, https://github.com/elastic/elasticsearch/pull/124471)</MESSAGE>
      <SHA>0c60158c81f28d2411e1c54dbce644458f335ddf</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
