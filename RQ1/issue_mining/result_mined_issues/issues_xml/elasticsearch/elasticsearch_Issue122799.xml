<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>122799</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/122799</ISSUEURL>
  <TITLE>[CI] S3RepositoryAnalysisRestIT testRepositoryAnalysis failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #6483 / oraclelinux-8_platform-support-unix](https://gradle-enterprise.elastic.co/s/ru4l67s5oo25i) - [elasticsearch-periodic-platform-support #6483 / rhel-9_platform-support-unix](https://gradle-enterprise.elastic.co/s/wxmfnxna3tcky) - [elasticsearch-periodic #6494 / openjdk17_checkpart2_java-matrix](https://gradle-enterprise.elastic.co/s/qesd6pse7wj2y) - [elasticsearch-intake #18368 / part2](https://gradle-enterprise.elastic.co/s/neqcj3ce345ma) - [elasticsearch-intake #18315 / part2](https://gradle-enterprise.elastic.co/s/n7j4f2amhbfre) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:snapshot-repo-test-kit:qa:s3:javaRestTest&quot; --tests &quot;org.elasticsearch.repositories.blobstore.testkit.analyze.S3RepositoryAnalysisRestIT.testRepositoryAnalysis&quot; -Dtests.seed=129F849E2DF6C55B -Dtests.locale=en-VU -Dtests.timezone=Pacific/Tarawa -Druntime.java=23 ``` **Applicable branches:** 8.x **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.repositories.blobstore.testkit.analyze.S3RepositoryAnalysisRestIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testRepositoryAnalysis),title:'Test',type:optionsListControl))))) **Failure Message:** ``` org.elasticsearch.client.ResponseException: method [POST], host [http://[::1]:40217], URI [/_snapshot/repository/_analyze?blob_count=10&amp;seed=3000866559835271268&amp;max_blob_size=1mb&amp;timeout=120s&amp;concurrency=4], status line [HTTP/1.1 500 Internal Server Error] {&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;amazon_s3_exception&quot;,&quot;reason&quot;:&quot;No such upload (Service: Amazon S3; Status Code: 200; Error Code: NoSuchUpload; Request ID: test-request-id; S3 Extended Request ID: test-host-id; Proxy: null)&quot;}],&quot;type&quot;:&quot;repository_verification_exception&quot;,&quot;reason&quot;:&quot;[repository] Elasticsearch observed the storage system underneath this repository behaved incorrectly which indicates it is not suitable for use with Elasticsearch snapshots. Typically this happens when using storage other than AWS S3 which incorrectly claims to be S3-compatible. If so, please report this incompatibility to your storage supplier. Do not report Elasticsearch issues involving storage systems which claim to be S3-compatible unless you can demons [truncated] ``` **Issue Reasons:** - [8.x] 2 consecutive failures in test testRepositoryAnalysis - [8.x] 5 failures in test testRepositoryAnalysis (2.9% fail rate in 174 executions) - [8.x] 2 failures in step part2 (12.5% fail rate in 16 executions) - [8.x] 2 failures in pipeline elasticsearch-intake (12.5% fail rate in 16 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Remove `@UpdateForV9` annotation from `ReindexRequest#failOnSizeSpecified` (#122729) The size parameter hasn't been accepted since 8.0, end users should use max_docs and if the user specify it, we can defer to the standard error message produced by the parser.</MESSAGE>
    <SHA>e702edcbab3720c0f99a78fa472af24cafaab850</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.repositories.blobstore.testkit.analyze.S3RepositoryAnalysisRestIT testRepositoryAnalysis #122799</MESSAGE>
      <SHA>7199fa2b9db1c0c2270fca76e59dfdc76f1fc5ea</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Handle status code 200 for s3 CMU response (#122815) When a CopmleteMultipartUpload request fails after the initial 200 response, the status code of the failure response use to be not set and hence got translated to status code 0. With #116212, we handle this case accordingly. Since AWS SDK 1.12.691, the status code is now set to 200 instead of 0. This PR changes our error handling code accordingly. Relates: #122431 Relates: #116212 Resolves: #122799 Relevant AWS SDK change https://github.com/aws/aws-sdk-java/blame/430899c217f34fae63b35c77f4d9bfd361c9de77/aws-java-sdk-s3/src/main/java/com/amazonaws/services/s3/AmazonS3Client.java#L3696-L3709</MESSAGE>
      <SHA>850249b8970b1f1e2ff622867c475d9a007aaa9d</SHA>
      <PATCHEDFILES>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java</FILE>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.repositories.blobstore.testkit.analyze.S3RepositoryAnalysisRestIT testRepositoryAnalysis #122799</MESSAGE>
      <SHA>7637b6b0d2d0100f3405636dd3d5c6aad75da609</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Handle status code 200 for s3 CMU response (#122815) When a CopmleteMultipartUpload request fails after the initial 200 response, the status code of the failure response use to be not set and hence got translated to status code 0. With #116212, we handle this case accordingly. Since AWS SDK 1.12.691, the status code is now set to 200 instead of 0. This PR changes our error handling code accordingly. Relates: #122431 Relates: #116212 Resolves: #122799 Relevant AWS SDK change https://github.com/aws/aws-sdk-java/blame/430899c217f34fae63b35c77f4d9bfd361c9de77/aws-java-sdk-s3/src/main/java/com/amazonaws/services/s3/AmazonS3Client.java#L3696-L3709 (cherry picked from commit 850249b8970b1f1e2ff622867c475d9a007aaa9d) # Conflicts: # muted-tests.yml</MESSAGE>
      <SHA>47b4842468010cd8b3b4806d1a6a7b1abceaa8fb</SHA>
      <PATCHEDFILES>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Handle status code 200 for s3 CMU response (#122815) When a CopmleteMultipartUpload request fails after the initial 200 response, the status code of the failure response use to be not set and hence got translated to status code 0. With #116212, we handle this case accordingly. Since AWS SDK 1.12.691, the status code is now set to 200 instead of 0. This PR changes our error handling code accordingly. Relates: #122431 Relates: #116212 Resolves: #122799 Relevant AWS SDK change https://github.com/aws/aws-sdk-java/blame/430899c217f34fae63b35c77f4d9bfd361c9de77/aws-java-sdk-s3/src/main/java/com/amazonaws/services/s3/AmazonS3Client.java#L3696-L3709 (cherry picked from commit 850249b8970b1f1e2ff622867c475d9a007aaa9d) # Conflicts: # muted-tests.yml</MESSAGE>
      <SHA>a900d9e634850189fd689158842d4d0602ed78bc</SHA>
      <PATCHEDFILES>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
