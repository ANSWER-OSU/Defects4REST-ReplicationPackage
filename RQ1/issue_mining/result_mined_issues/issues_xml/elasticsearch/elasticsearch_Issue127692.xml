<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>127692</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/127692</ISSUEURL>
  <TITLE>[CI] IndexTemplateRegistryRolloverIT testRollover failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-intake #22611 / part2](https://gradle-enterprise.elastic.co/s/yx64hzf4yxnx6) - [elasticsearch-periodic-platform-support #8027 / ubuntu-2404-aarch64_checkpart2_platform-support-arm](https://gradle-enterprise.elastic.co/s/nn3xkchv23gv2) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:core:internalClusterTest&quot; --tests &quot;org.elasticsearch.xpack.core.template.IndexTemplateRegistryRolloverIT.testRollover&quot; -Dtests.seed=95F1982676EAF4D -Dtests.locale=lb-Latn-LU -Dtests.timezone=Europe/Kirov -Druntime.java=24 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.core.template.IndexTemplateRegistryRolloverIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testRollover),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: Expected: a collection with size &lt;2&gt; but: collection size was &lt;1&gt; ``` **Issue Reasons:** - [main] 2 failures in test testRollover (2.2% fail rate in 89 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.snapshots.SnapshotShutdownIT testSnapshotShutdownProgressTracker #127690</MESSAGE>
    <SHA>81adb0f449bf8167211b487cfc691ccddc3fd9d1</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.core.template.IndexTemplateRegistryRolloverIT testRollover #127692</MESSAGE>
      <SHA>a4cb8d291a7a528681013081d82933a6e75f74e8</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `IndexTemplateRegistryRolloverIT` My theory of why this test failed is that when we waited for the data stream to be marked for rollover, that condition was met on one of the nodes, causing us to index the documents to trigger the rollover, but the master node did not fully process the mark-for-rollover cluster state, resulting in the documents ending up in the first backing index. Therefore, we use `awaitClusterState` to wait for the data stream to be marked for rollover, which waits on the master node by default. Fixes #127692</MESSAGE>
      <SHA>8d45ae790cd8e6741ea55070c985adedd260f4c0</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
        <FILE>x-pack/plugin/core/src/internalClusterTest/java/org/elasticsearch/xpack/core/template/IndexTemplateRegistryRolloverIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `IndexTemplateRegistryRolloverIT` (#127695) My theory of why this test failed is that when we waited for the data stream to be marked for rollover, that condition was met on one of the nodes, causing us to index the documents to trigger the rollover, but the master node did not fully process the mark-for-rollover cluster state, resulting in the documents ending up in the first backing index. Therefore, we use `awaitClusterState` to wait for the data stream to be marked for rollover, which waits on the master node by default. Fixes #127692</MESSAGE>
      <SHA>1bfaec8731217f98cf0347654601f2707f898ae8</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
        <FILE>x-pack/plugin/core/src/internalClusterTest/java/org/elasticsearch/xpack/core/template/IndexTemplateRegistryRolloverIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
