<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>121532</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/121532</ISSUEURL>
  <TITLE>[ML] &quot;Get deployment stats failed&quot; shown when ML is disabled</TITLE>
  <DESCRIPTION>### Elasticsearch Version 8.17.0 ### Installed Plugins _No response_ ### Java Version _bundled_ ### OS Version All ### Problem Description Logs show WARN related to ML errors when ML is disabled: ``` es01-1 | [14:27:20,222][WARN ][o.e.x.i.s.e.ElasticsearchInternalService] Get deployment stats failed, cannot update the endpoint's number of allocations es01-1 | java.lang.IllegalStateException: failed to find action [cluster:internal/xpack/ml/trained_models/deployments/stats/get] to execute es01-1 | at org.elasticsearch.client.internal.node.NodeClient.transportAction(NodeClient.java:135) ~[elasticsearch-8.17.0.jar:?] es01-1 | at org.elasticsearch.client.internal.node.NodeClient.executeLocally(NodeClient.java:108) ~[elasticsearch-8.17.0.jar:?] es01-1 | at org.elasticsearch.client.internal.node.NodeClient.doExecute(NodeClient.java:84) ~[elasticsearch-8.17.0.jar:?] es01-1 | at org.elasticsearch.client.internal.support.AbstractClient.execute(AbstractClient.java:140) ~[elasticsearch-8.17.0.jar:?] es01-1 | at org.elasticsearch.client.internal.FilterClient.doExecute(FilterClient.java:56) ~[elasticsearch-8.17.0.jar:?] es01-1 | at org.elasticsearch.client.internal.OriginSettingClient.doExecute(OriginSettingClient.java:44) ~[elasticsearch-8.17.0.jar:?] es01-1 | at org.elasticsearch.client.internal.support.AbstractClient.execute(AbstractClient.java:140) ~[elasticsearch-8.17.0.jar:?] es01-1 | at org.elasticsearch.xpack.inference.services.elasticsearch.ElasticsearchInternalService.updateModelsWithDynamicFields(ElasticsearchInternalService.java:847) ~[?:?] es01-1 | at org.elasticsearch.xpack.inference.action.TransportGetInferenceModelAction.parseModels(TransportGetInferenceModelAction.java:168) ~[?:?] es01-1 | at org.elasticsearch.xpack.inference.action.TransportGetInferenceModelAction.lambda$getAllModels$2(TransportGetInferenceModelAction.java:120) ~[?:?] es01-1 | at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:956) ~[elasticsearch-8.17.0.jar:?] es01-1 | at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144) ~[?:?] es01-1 | at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642) ~[?:?] es01-1 | at java.lang.Thread.run(Thread.java:1575) ~[?:?] ``` ### Steps to Reproduce 1. Launch docker container for 8.17.0 2. Call `_xpack/usage` ``` version: '2.2' services: es01: image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0 container_name: es01-1 environment: - node.name=es01-1 - cluster.name=es-docker-cluster - xpack.security.enabled=false - discovery.type=single-node - bootstrap.memory_lock=true - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot; - path.repo=/usr/share/elasticsearch/backup - xpack.ml.enabled=false ulimits: memlock: soft: -1 hard: -1 volumes: - data01:/usr/share/elasticsearch/data ports: - 9200:9200 - 9300:9300 networks: - elastic volumes: data01: driver: local kibana-data01: driver: local networks: elastic: driver: bridge ``` ### Logs (if relevant) _No response_</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[ML] Unmute XPackRestIT and mute all ml and transform tests (#121377)</MESSAGE>
    <SHA>2e84950cb3476d7cf1f347326069a099e25ec3db</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[ML] Skip Usage stats update when ML is disabled Fix #121532</MESSAGE>
      <SHA>a45c2ddcf94142870c426ae2c870ac07bbd81dcd</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalService.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[ML] Skip Usage stats update when ML is disabled (#121559) Do not call ML's GetDeploymentStatsAction API when ML is disabled in the cluster, instead return the inference configurations as-is. Fix #121532</MESSAGE>
      <SHA>4ac6aee6e4142d024a220a175b631cc1c692671d</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/121559.yaml</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalService.java</FILE>
        <FILE>x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalServiceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[ML] Skip Usage stats update when ML is disabled (#121559) Do not call ML's GetDeploymentStatsAction API when ML is disabled in the cluster, instead return the inference configurations as-is. Fix #121532</MESSAGE>
      <SHA>4e21e7ccd3d449009bac829c7bd743e6a2fe4760</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/121559.yaml</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalService.java</FILE>
        <FILE>x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalServiceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[ML] Skip Usage stats update when ML is disabled (#121559) Do not call ML's GetDeploymentStatsAction API when ML is disabled in the cluster, instead return the inference configurations as-is. Fix #121532</MESSAGE>
      <SHA>24e58d53e499c8dd06aad3fc90d6c760876ae078</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/121559.yaml</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalService.java</FILE>
        <FILE>x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalServiceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[ML] Skip Usage stats update when ML is disabled (#121559) Do not call ML's GetDeploymentStatsAction API when ML is disabled in the cluster, instead return the inference configurations as-is. Fix #121532</MESSAGE>
      <SHA>9c8abeaa315a09e858aa6c154453772c2226bd53</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/121559.yaml</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalService.java</FILE>
        <FILE>x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalServiceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[ML] Skip Usage stats update when ML is disabled (#121559) Do not call ML's GetDeploymentStatsAction API when ML is disabled in the cluster, instead return the inference configurations as-is. Fix #121532</MESSAGE>
      <SHA>c8053d4aca263776eb929de212ff07bf4a1d7321</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/121559.yaml</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalService.java</FILE>
        <FILE>x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalServiceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[ML] Skip Usage stats update when ML is disabled (#121559) (#121769) Do not call ML's GetDeploymentStatsAction API when ML is disabled in the cluster, instead return the inference configurations as-is. Fix #121532</MESSAGE>
      <SHA>f6e01514c39310e0eb97f4e0dedd8acd6ca9454d</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/121559.yaml</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalService.java</FILE>
        <FILE>x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalServiceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[ML] Skip Usage stats update when ML is disabled (#121559) (#121766) Do not call ML's GetDeploymentStatsAction API when ML is disabled in the cluster, instead return the inference configurations as-is. Fix #121532</MESSAGE>
      <SHA>06914269881da3a6b215baed3b711cec32186568</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/121559.yaml</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalService.java</FILE>
        <FILE>x-pack/plugin/inference/src/test/java/org/elasticsearch/xpack/inference/services/elasticsearch/ElasticsearchInternalServiceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
