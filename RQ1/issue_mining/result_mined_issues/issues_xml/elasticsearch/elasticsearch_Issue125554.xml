<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>125554</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/125554</ISSUEURL>
  <TITLE>[CI] ModelRegistryMetadataTests testUpgrade failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-intake #20966 / part2](https://gradle-enterprise.elastic.co/s/n4ruvxarqo5gg) - [elasticsearch-periodic-platform-support #7238 / sles-15_platform-support-unix](https://gradle-enterprise.elastic.co/s/zndtnrtsrg4tw) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:inference:test&quot; --tests &quot;org.elasticsearch.xpack.inference.registry.ModelRegistryMetadataTests.testUpgrade&quot; -Dtests.seed=34A4E865A50F2C52 -Dtests.locale=es-CR -Dtests.timezone=Pacific/Ponape -Druntime.java=24 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.inference.registry.ModelRegistryMetadataTests),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testUpgrade),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.IllegalArgumentException: Can't pick a random object from an empty collection. ``` **Issue Reasons:** - [main] 2 failures in test testUpgrade (2.7% fail rate in 74 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ESQL - date nanos range bug? (#125345) Fixes #125439 We were incorrectly formatting nanosecond dates when building lucene queries. We had missed this in our testing because none of the CSV tests were running against Lucene. This happened because the date nanos test data includes multivalue fields. Our warning behavior for multivalue fields is inconsistent between queries run in Lucene and queries run in pure ES|QL without pushdown. Our warning tests, however, require that the specified warnings be present in all execution paths. When we first built the date nanos CSV tests, we worked around this by always using an MV function to unpack the multivalue fields. But we forgot that using an MV function prevents the entire query from being pushed down to Lucene, and thus that path wasn't being tested. In this PR, I've duplicated many of the tests to have a version that doesn't use the MV function, and uses warningRegex instead of warning. The regex version does not fail if the header is absent, so it's safe to use in both modes. Rewriting the tests this way revealed several situations in which this bug can manifest, all of which are fixed in this PR. I cannot be confidant that there aren't more paths that can trigger this bug and aren't covered by these tests, but I haven't found any yet. I've left some trace level logging that I found helpful while debugging this. --------- Co-authored-by: elasticsearchmachine &lt;infra-root+elasticsearchmachine@elastic.co&gt;</MESSAGE>
    <SHA>30a56d6e2cff00591a0812a7138f732b56215e84</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.inference.registry.ModelRegistryMetadataTests testUpgrade #125554</MESSAGE>
      <SHA>f461731a30a6fe55d7d7b343d38426ddca1ac873</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.inference.registry.ModelRegistryMetadataTests testUpgrade #125554</MESSAGE>
      <SHA>e05d4cfcf76d378008659508087e2344fd9fde1c</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.inference.registry.ModelRegistryMetadataTests testUpgrade #125554</MESSAGE>
      <SHA>a02241b252a496bfb12bff1de4ffac22205fd13b</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.inference.registry.ModelRegistryMetadataTests testUpgrade #125554</MESSAGE>
      <SHA>abad6c2915c7e940df39790c37b7281193cda0e8</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.inference.registry.ModelRegistryMetadataTests testUpgrade #125554</MESSAGE>
      <SHA>8fed026f203a7ffff49e2f8e4a35293883f36ed0</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
