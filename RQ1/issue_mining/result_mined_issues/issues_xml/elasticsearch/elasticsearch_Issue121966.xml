<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>121966</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/121966</ISSUEURL>
  <TITLE>[CI] DataNodeRequestSenderTests testDoNotRetryOnRequestLevelFailure failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic #6237 / openjdk21_checkpart3_java-matrix](https://gradle-enterprise.elastic.co/s/cnvda7hpb4xey) - [elasticsearch-pull-request #55490 / part-3](https://gradle-enterprise.elastic.co/s/yltcwo3oekdki) - [elasticsearch-pull-request #55479 / part-3](https://gradle-enterprise.elastic.co/s/srqm4em6pwyyc) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:esql:test&quot; --tests &quot;org.elasticsearch.xpack.esql.plugin.DataNodeRequestSenderTests.testDoNotRetryOnRequestLevelFailure&quot; -Dtests.seed=5F94CB1AA392B574 -Dtests.locale=ga-Latn-IE -Dtests.timezone=Asia/Kathmandu -Druntime.java=21 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.esql.plugin.DataNodeRequestSenderTests),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testDoNotRetryOnRequestLevelFailure),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: null ``` **Issue Reasons:** - [main] 3 failures in test testDoNotRetryOnRequestLevelFailure (2.2% fail rate in 137 executions) - [main] 2 failures in step part-3 (2.7% fail rate in 75 executions) - [main] 2 failures in pipeline elasticsearch-pull-request (2.7% fail rate in 75 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.test.rest.ClientYamlTestSuiteIT test {yaml=update/100_synthetic_source/keyword} #121965</MESSAGE>
    <SHA>bcca97d47d9317d4b0a7455c652961080d062865</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.esql.plugin.DataNodeRequestSenderTests testDoNotRetryOnRequestLevelFailure #121966</MESSAGE>
      <SHA>e24489f1420370a7638dd761527f9af0ea45dc6e</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix DataNodeRequestSender (#121999) There are two issues in the current implementation: 1. We should use the list of shardIds from the request, rather than all targets, when removing failures for shards that have been successfully executed. 2. We should remove shardIds from the pending list once a failure is reported and abort execution at that point, as the results will be discarded. Closes #121966</MESSAGE>
      <SHA>8365e581ed2d91e6b37112682d7e88cae74b59b4</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plugin/DataNodeRequestSender.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
