<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>118327</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/118327</ISSUEURL>
  <TITLE>Request to use rescore with retriever for ES Query DSL</TITLE>
  <DESCRIPTION>### Description First, I'm grateful for your work and SW and look forward to your new design of &quot;retrievers&quot;. However, currently, Elasticsearch does not support using rescore in conjunction with retrieve API. Even, a standard retriever, which has 'query', does not support rescore. That means, unfortunately, I realized if I'm not missing something, there is no way to migrate the previous Query DSL having rescored into the new design Adding this rescore capability is required to enhance the flexibility and precision of search workflows significantly in our examples. Rescoring is a powerful tool to refine the ranking of top-k results after an initial retrieval query, and enabling this combination could address numerous real-world use cases, such as personalized ranking and boosting relevance based on secondary scoring logic. ## Feature Request I propose enhancing Elasticsearch to allow rescore operations to be integrated seamlessly with retrieval queries. Specifically, the feature should support: ```bash { &quot;retriever&quot;: {...}, &quot;rescore&quot;: [{...}], } ``` Hybrid Rescoring: Allowing rescoring over retrieval results generated by a combination of text-based queries, vector searches, or other retrieval methods. Customizable Pipelines: Defining custom rescoring logic (e.g., script-based, machine learning model inference) post-retrieval. ## Expected Use Cases Personalized Recommendations: Use retrieval for candidate selection and rescore using user-specific preferences or behavior data. Semantic Search: Enhance the ranking of results retrieved through semantic or vector-based search with additional scoring layers. E-commerce Applications: Rank products based on business-specific signals such as user reviews, sales data, or clickstream analysis. Benefits Improved Search Quality: Enable more precise ranking mechanisms to surface the most relevant results. Flexibility: Combine multiple ranking signals for complex search scenarios. Efficiency: Optimize workflows by allowing rescoring to target the top-k results instead of recalculating scores for the entire result set.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>8</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Don't throw VerificationException on illegal state (#118826) If we end up here, we need to know this - and we won't know it if we return a 400 to the user. This should be a 500.</MESSAGE>
    <SHA>7d301185bf1a650db09bb87033be70141353a5a5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Add a generic `rescorer` retriever based on the search request's rescore functionality (#118585) This pull request introduces a new retriever called `rescorer`, which leverages the `rescore` functionality of the search request. The `rescorer` retriever re-scores only the top documents retrieved by its child retriever, offering fine-tuned scoring capabilities. All rescorers supported in the `rescore` section of a search request are available in this retriever, and the same format is used to define the rescore configuration. &lt;details&gt; &lt;summary&gt;Example:&lt;/summary&gt; ```yaml - do: search: index: test body: retriever: rescorer: rescore: window_size: 10 query: rescore_query: rank_feature: field: &quot;features.second_stage&quot; linear: { } query_weight: 0 retriever: standard: query: rank_feature: field: &quot;features.first_stage&quot; linear: { } size: 2 ``` &lt;/details&gt; Closes #118327 Co-authored-by: Liam Thompson &lt;32779855+leemthompo@users.noreply.github.com&gt;</MESSAGE>
      <SHA>6f261067f215c0eb95b714796382d6a035d24e41</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/118585.yaml</FILE>
        <FILE>docs/reference/search/retriever.asciidoc</FILE>
        <FILE>rest-api-spec/build.gradle</FILE>
        <FILE>rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/search.retrievers/30_rescorer_retriever.yml</FILE>
        <FILE>rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/search/90_search_after.yml</FILE>
        <FILE>server/src/internalClusterTest/java/org/elasticsearch/search/functionscore/QueryRescorerIT.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/DefaultSearchContext.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/SearchFeatures.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/SearchModule.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/query/QueryPhaseCollectorManager.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/rescore/RescorePhase.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/rescore/RescorerBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/RescorerRetrieverBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/RetrieverBuilder.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/search/DefaultSearchContextTests.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/search/retriever/RescorerRetrieverBuilderParsingTests.java</FILE>
        <FILE>x-pack/plugin/ent-search/src/main/java/org/elasticsearch/xpack/application/rules/retriever/QueryRuleRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/build.gradle</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/yamlRestTest/java/org/elasticsearch/xpack/rank/rrf/RRFRankClientYamlTestSuiteIT.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/900_rrf_with_rescorer.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Add a generic `rescorer` retriever based on the search request's rescore functionality (#118585) This pull request introduces a new retriever called `rescorer`, which leverages the `rescore` functionality of the search request. The `rescorer` retriever re-scores only the top documents retrieved by its child retriever, offering fine-tuned scoring capabilities. All rescorers supported in the `rescore` section of a search request are available in this retriever, and the same format is used to define the rescore configuration. &lt;details&gt; &lt;summary&gt;Example:&lt;/summary&gt; ```yaml - do: search: index: test body: retriever: rescorer: rescore: window_size: 10 query: rescore_query: rank_feature: field: &quot;features.second_stage&quot; linear: { } query_weight: 0 retriever: standard: query: rank_feature: field: &quot;features.first_stage&quot; linear: { } size: 2 ``` &lt;/details&gt; Closes #118327 Co-authored-by: Liam Thompson &lt;32779855+leemthompo@users.noreply.github.com&gt;</MESSAGE>
      <SHA>b589cce3690cc2ed30940a40a42b2ab5b407cf82</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/118585.yaml</FILE>
        <FILE>docs/reference/search/retriever.asciidoc</FILE>
        <FILE>rest-api-spec/build.gradle</FILE>
        <FILE>rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/search.retrievers/30_rescorer_retriever.yml</FILE>
        <FILE>rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/search/90_search_after.yml</FILE>
        <FILE>server/src/internalClusterTest/java/org/elasticsearch/search/functionscore/QueryRescorerIT.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/DefaultSearchContext.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/SearchFeatures.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/SearchModule.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/query/QueryPhaseCollectorManager.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/rescore/RescorePhase.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/rescore/RescorerBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/RescorerRetrieverBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/RetrieverBuilder.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/search/DefaultSearchContextTests.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/search/retriever/RescorerRetrieverBuilderParsingTests.java</FILE>
        <FILE>x-pack/plugin/ent-search/src/main/java/org/elasticsearch/xpack/application/rules/retriever/QueryRuleRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/build.gradle</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/yamlRestTest/java/org/elasticsearch/xpack/rank/rrf/RRFRankClientYamlTestSuiteIT.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/900_rrf_with_rescorer.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[8.x] Add a generic `rescorer` retriever based on the search request's rescore functionality (#119023) * Add a generic `rescorer` retriever based on the search request's rescore functionality (#118585) This pull request introduces a new retriever called `rescorer`, which leverages the `rescore` functionality of the search request. The `rescorer` retriever re-scores only the top documents retrieved by its child retriever, offering fine-tuned scoring capabilities. All rescorers supported in the `rescore` section of a search request are available in this retriever, and the same format is used to define the rescore configuration. &lt;details&gt; &lt;summary&gt;Example:&lt;/summary&gt; ```yaml - do: search: index: test body: retriever: rescorer: rescore: window_size: 10 query: rescore_query: rank_feature: field: &quot;features.second_stage&quot; linear: { } query_weight: 0 retriever: standard: query: rank_feature: field: &quot;features.first_stage&quot; linear: { } size: 2 ``` &lt;/details&gt; Closes #118327 Co-authored-by: Liam Thompson &lt;32779855+leemthompo@users.noreply.github.com&gt; * replace java21 only method * fix compil --------- Co-authored-by: Liam Thompson &lt;32779855+leemthompo@users.noreply.github.com&gt;</MESSAGE>
      <SHA>940ef77320d2372a05302406beda3465f482a855</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/118585.yaml</FILE>
        <FILE>docs/reference/search/retriever.asciidoc</FILE>
        <FILE>rest-api-spec/build.gradle</FILE>
        <FILE>rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/search.retrievers/30_rescorer_retriever.yml</FILE>
        <FILE>rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/search/90_search_after.yml</FILE>
        <FILE>server/src/internalClusterTest/java/org/elasticsearch/search/functionscore/QueryRescorerIT.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/DefaultSearchContext.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/SearchFeatures.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/SearchModule.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/query/QueryPhaseCollectorManager.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/rescore/RescorePhase.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/rescore/RescorerBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/RescorerRetrieverBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/RetrieverBuilder.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/search/DefaultSearchContextTests.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/search/retriever/RescorerRetrieverBuilderParsingTests.java</FILE>
        <FILE>x-pack/plugin/ent-search/src/main/java/org/elasticsearch/xpack/application/rules/retriever/QueryRuleRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/build.gradle</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/yamlRestTest/java/org/elasticsearch/xpack/rank/rrf/RRFRankClientYamlTestSuiteIT.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/900_rrf_with_rescorer.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Add a generic `rescorer` retriever based on the search request's rescore functionality (#118585) This pull request introduces a new retriever called `rescorer`, which leverages the `rescore` functionality of the search request. The `rescorer` retriever re-scores only the top documents retrieved by its child retriever, offering fine-tuned scoring capabilities. All rescorers supported in the `rescore` section of a search request are available in this retriever, and the same format is used to define the rescore configuration. &lt;details&gt; &lt;summary&gt;Example:&lt;/summary&gt; ```yaml - do: search: index: test body: retriever: rescorer: rescore: window_size: 10 query: rescore_query: rank_feature: field: &quot;features.second_stage&quot; linear: { } query_weight: 0 retriever: standard: query: rank_feature: field: &quot;features.first_stage&quot; linear: { } size: 2 ``` &lt;/details&gt; Closes #118327 Co-authored-by: Liam Thompson &lt;32779855+leemthompo@users.noreply.github.com&gt;</MESSAGE>
      <SHA>1cb5c2df10aa0359056c2c1d7510f90eb6fd743b</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/118585.yaml</FILE>
        <FILE>docs/reference/search/retriever.asciidoc</FILE>
        <FILE>rest-api-spec/build.gradle</FILE>
        <FILE>rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/search.retrievers/30_rescorer_retriever.yml</FILE>
        <FILE>rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/search/90_search_after.yml</FILE>
        <FILE>server/src/internalClusterTest/java/org/elasticsearch/search/functionscore/QueryRescorerIT.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/DefaultSearchContext.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/SearchFeatures.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/SearchModule.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/query/QueryPhaseCollectorManager.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/rescore/RescorePhase.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/rescore/RescorerBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/CompoundRetrieverBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/RescorerRetrieverBuilder.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/search/retriever/RetrieverBuilder.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/search/DefaultSearchContextTests.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/search/retriever/RescorerRetrieverBuilderParsingTests.java</FILE>
        <FILE>x-pack/plugin/ent-search/src/main/java/org/elasticsearch/xpack/application/rules/retriever/QueryRuleRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/inference/src/main/java/org/elasticsearch/xpack/inference/rank/textsimilarity/TextSimilarityRankRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/build.gradle</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/main/java/org/elasticsearch/xpack/rank/rrf/RRFRetrieverBuilder.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/yamlRestTest/java/org/elasticsearch/xpack/rank/rrf/RRFRankClientYamlTestSuiteIT.java</FILE>
        <FILE>x-pack/plugin/rank-rrf/src/yamlRestTest/resources/rest-api-spec/test/rrf/900_rrf_with_rescorer.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
