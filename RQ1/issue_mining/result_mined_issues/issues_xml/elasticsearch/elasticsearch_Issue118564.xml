<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>118564</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/118564</ISSUEURL>
  <TITLE>[CI] DiscoveryEc2AvailabilityZoneAttributeNoImdsIT testAvailabilityZoneAttribute failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #5349 / almalinux-8-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/owt3cf3pttuha) - [elasticsearch-periodic-platform-support #5349 / amazonlinux-2023_platform-support-aws](https://gradle-enterprise.elastic.co/s/nohuckrsgdunw) - [elasticsearch-periodic-platform-support #5344 / almalinux-8-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/qut3adw5a5m76) - [elasticsearch-periodic-platform-support #5344 / ubuntu-2004-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/wp34ylfd3vt5g) - [elasticsearch-periodic-platform-support #5344 / amazonlinux-2023_platform-support-aws](https://gradle-enterprise.elastic.co/s/63sbr2wrg2pfs) - [elasticsearch-periodic-platform-support #5339 / ubuntu-2004-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/gbh3lodrr7z2a) - [elasticsearch-periodic-platform-support #5339 / almalinux-8-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/vid6krktxir72) - [elasticsearch-periodic-platform-support #5339 / amazonlinux-2023_platform-support-aws](https://gradle-enterprise.elastic.co/s/d7o7s3bvu224w) - [elasticsearch-periodic-platform-support #5331 / ubuntu-2004-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/mivvgw7oq3ow2) - [elasticsearch-periodic-platform-support #5331 / almalinux-8-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/uu3ox5alfmcdy) **Reproduction Line:** ``` ./gradlew &quot;:plugins:discovery-ec2:javaRestTest&quot; --tests &quot;org.elasticsearch.discovery.ec2.DiscoveryEc2AvailabilityZoneAttributeNoImdsIT.testAvailabilityZoneAttribute&quot; -Dtests.seed=9867363BCF60CBE0 -Dtests.locale=fr-PF -Dtests.timezone=America/Knox_IN -Druntime.java=23 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.discovery.ec2.DiscoveryEc2AvailabilityZoneAttributeNoImdsIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testAvailabilityZoneAttribute),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: expected null, but was:&lt;us-west-2b&gt; ``` **Issue Reasons:** - [main] 4 consecutive failures in step almalinux-8-aarch64_checkpart1_platform-support-arm - [main] 4 consecutive failures in step amazonlinux-2023_platform-support-aws - [main] 3 consecutive failures in step ubuntu-2004-aarch64_checkpart1_platform-support-arm - [main] 11 failures in test testAvailabilityZoneAttribute (7.2% fail rate in 152 executions) - [main] 4 failures in step almalinux-8-aarch64_checkpart1_platform-support-arm (100.0% fail rate in 4 executions) - [main] 4 failures in step amazonlinux-2023_platform-support-aws (100.0% fail rate in 4 executions) - [main] 3 failures in step ubuntu-2004-aarch64_checkpart1_platform-support-arm (100.0% fail rate in 3 executions) - [main] 4 failures in pipeline elasticsearch-periodic-platform-support (100.0% fail rate in 4 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>14</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Remove version 8.15.6</MESSAGE>
    <SHA>2f1e1f8632cdfbdb942123039b5eaeaf2e6bfa5b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix `DiscoveryEc2AvailabilityZoneAttributeNoImdsIT` This test asserts that no AZ attribute is set, assuming that the current AZ is unavailable, but in fact that's not true when running these tests in EC2. With this commit we override the IMDS endpoint address to one that definitely does not exist. Closes #118564</MESSAGE>
      <SHA>b0cf3d5e4e76a7062258615bdf6ff392d45d4052</SHA>
      <PATCHEDFILES>
        <FILE>plugins/discovery-ec2/src/javaRestTest/java/org/elasticsearch/discovery/ec2/DiscoveryEc2AvailabilityZoneAttributeNoImdsIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.discovery.ec2.DiscoveryEc2AvailabilityZoneAttributeNoImdsIT testAvailabilityZoneAttribute #118564</MESSAGE>
      <SHA>23ba880ccc459ef0cf4335c7abda4c8c684cd2f5</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.discovery.ec2.DiscoveryEc2AvailabilityZoneAttributeNoImdsIT testAvailabilityZoneAttribute #118564</MESSAGE>
      <SHA>f5a23fdd3e97978f2a391e44990d5ff511a90345</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.discovery.ec2.DiscoveryEc2AvailabilityZoneAttributeNoImdsIT testAvailabilityZoneAttribute #118564</MESSAGE>
      <SHA>5e9467012665e155133ee73836a4b087c8058b91</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `DiscoveryEc2AvailabilityZoneAttributeNoImdsIT` This test asserts that no AZ attribute is set, assuming that the current AZ is unavailable, but in fact that's not true when running these tests in EC2. With this commit we override the IMDS endpoint address to one that definitely does not exist. Relates #118675 Closes #118564</MESSAGE>
      <SHA>d6c3112f4877172dbb76b741cc6e343beab8de61</SHA>
      <PATCHEDFILES>
        <FILE>plugins/discovery-ec2/src/javaRestTest/java/org/elasticsearch/discovery/ec2/DiscoveryEc2AvailabilityZoneAttributeNoImdsIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `DiscoveryEc2AvailabilityZoneAttributeNoImdsIT` (#118821) This test asserts that no AZ attribute is set, assuming that the current AZ is unavailable, but in fact that's not true when running these tests in EC2. With this commit we override the IMDS endpoint address to one that definitely does not exist. Relates #118675 Closes #118564</MESSAGE>
      <SHA>fe64ae0e087666f787a4bf9dafefdaf6a5ba9473</SHA>
      <PATCHEDFILES>
        <FILE>plugins/discovery-ec2/src/javaRestTest/java/org/elasticsearch/discovery/ec2/DiscoveryEc2AvailabilityZoneAttributeNoImdsIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `DiscoveryEc2AvailabilityZoneAttributeNoImdsIT` (#118821) This test asserts that no AZ attribute is set, assuming that the current AZ is unavailable, but in fact that's not true when running these tests in EC2. With this commit we override the IMDS endpoint address to one that definitely does not exist. Relates #118675 Closes #118564</MESSAGE>
      <SHA>1810e5d46c9dda9fdc451ec5166d7569990a664c</SHA>
      <PATCHEDFILES>
        <FILE>plugins/discovery-ec2/src/javaRestTest/java/org/elasticsearch/discovery/ec2/DiscoveryEc2AvailabilityZoneAttributeNoImdsIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `DiscoveryEc2AvailabilityZoneAttributeNoImdsIT` (#118821) (#119307) This test asserts that no AZ attribute is set, assuming that the current AZ is unavailable, but in fact that's not true when running these tests in EC2. With this commit we override the IMDS endpoint address to one that definitely does not exist. Relates #118675 Closes #118564</MESSAGE>
      <SHA>041390ce0d362833367b8c3541cfa56e798a2a60</SHA>
      <PATCHEDFILES>
        <FILE>plugins/discovery-ec2/src/javaRestTest/java/org/elasticsearch/discovery/ec2/DiscoveryEc2AvailabilityZoneAttributeNoImdsIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
