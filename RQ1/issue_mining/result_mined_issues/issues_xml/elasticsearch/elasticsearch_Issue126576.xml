<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>126576</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/126576</ISSUEURL>
  <TITLE>[CI] S3RepositoryAnalysisRestIT testRepositoryAnalysis failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #7602 / opensuse-leap-15_platform-support-unix](https://gradle-enterprise.elastic.co/s/5rdzhkdies3ra) - [elasticsearch-pull-request #67546 / part-2](https://gradle-enterprise.elastic.co/s/r6ga7hzee2swk) - [elasticsearch-pull-request #67528 / part-2](https://gradle-enterprise.elastic.co/s/gtfvb2dqrpi7k) - [elasticsearch-pull-request #67464 / part-2](https://gradle-enterprise.elastic.co/s/rgmicha6x53g6) - [elasticsearch-pull-request #67425 / part-2](https://gradle-enterprise.elastic.co/s/y3cw2idmveoq2) - [elasticsearch-intake #21621 / part2](https://gradle-enterprise.elastic.co/s/2up523edcsmhu) - [elasticsearch-periodic-platform-support #7567 / ubuntu-2004_platform-support-unix](https://gradle-enterprise.elastic.co/s/jy4szgmadtxu2) - [elasticsearch-pull-request #67190 / part-2](https://gradle-enterprise.elastic.co/s/yvsfi6tnh4ckq) - [elasticsearch-pull-request #67191 / part-2](https://gradle-enterprise.elastic.co/s/dfaowj2hjm3iw) - [elasticsearch-pull-request #67180 / part-2](https://gradle-enterprise.elastic.co/s/4skolm3funweu) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:snapshot-repo-test-kit:qa:s3:javaRestTest&quot; --tests &quot;org.elasticsearch.repositories.blobstore.testkit.analyze.S3RepositoryAnalysisRestIT.testRepositoryAnalysis&quot; -Dtests.seed=B71B1505C30AE167 -Dtests.locale=vi-VN -Dtests.timezone=US/Michigan -Druntime.java=24 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.repositories.blobstore.testkit.analyze.S3RepositoryAnalysisRestIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testRepositoryAnalysis),title:'Test',type:optionsListControl))))) **Failure Message:** ``` org.elasticsearch.client.ResponseException: method [POST], host [http://[::1]:34247], URI [/_snapshot/repository/_analyze?blob_count=10&amp;seed=-2481787089920117582&amp;max_blob_size=10mb&amp;timeout=120s&amp;concurrency=4], status line [HTTP/1.1 500 Internal Server Error] {&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;uncategorized_execution_exception&quot;,&quot;reason&quot;:&quot;Failed execution&quot;}],&quot;type&quot;:&quot;repository_verification_exception&quot;,&quot;reason&quot;:&quot;[repository] Elasticsearch observed the storage system underneath this repository behaved incorrectly which indicates it is not suitable for use with Elasticsearch snapshots. Typically this happens when using storage other than AWS S3 which incorrectly claims to be S3-compatible. If so, please report this incompatibility to your storage supplier. Do not report Elasticsearch issues involving storage systems which claim to be S3-compatible unless you can demonstrate that the same issue exists when using a genuine AWS S3 repository. See [https://www.elastic.co/docs/api/doc/elasticsearch [truncated] ``` **Issue Reasons:** - [main] 15 failures in test testRepositoryAnalysis (3.0% fail rate in 505 executions) - [main] 11 failures in step part-2 (4.6% fail rate in 237 executions) - [main] 11 failures in pipeline elasticsearch-pull-request (4.7% fail rate in 236 executions) - [main] 2 failures in pipeline elasticsearch-periodic-platform-support (22.2% fail rate in 9 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.xpack.esql.qa.single_node.GenerativeIT test #126573</MESSAGE>
    <SHA>90f8b87a2ef958a3dbca5d8b079bd164c7a9a6a1</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.repositories.blobstore.testkit.analyze.S3RepositoryAnalysisRestIT testRepositoryAnalysis #126576</MESSAGE>
      <SHA>4ea4a298a48521968fafd2b3f0a7174d2099cf8c</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `S3RepositoryAnalysisRestIT` - Translate a 404 during a multipart copy into a `FileNotFoundException` - Use multiple threads in `S3HttpHandler` to avoid `CopyObject`/`PutObject` deadlock Closes #126576</MESSAGE>
      <SHA>4552f9602df0024bb2301b50e696d70c41542523</SHA>
      <PATCHEDFILES>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java</FILE>
        <FILE>muted-tests.yml</FILE>
        <FILE>test/fixtures/s3-fixture/src/main/java/fixture/s3/S3HttpFixture.java</FILE>
        <FILE>x-pack/plugin/snapshot-repo-test-kit/src/test/java/org/elasticsearch/repositories/blobstore/testkit/analyze/AbstractRepositoryAnalysisRestTestCase.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `S3RepositoryAnalysisRestIT` - Translate a 404 during a multipart copy into a `FileNotFoundException` - Use multiple threads in `S3HttpHandler` to avoid `CopyObject`/`PutObject` deadlock Closes #126576</MESSAGE>
      <SHA>89e72384426e339232b9dc4597f8652286c928d3</SHA>
      <PATCHEDFILES>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java</FILE>
        <FILE>muted-tests.yml</FILE>
        <FILE>test/fixtures/s3-fixture/src/main/java/fixture/s3/S3HttpFixture.java</FILE>
        <FILE>test/fixtures/s3-fixture/src/main/java/fixture/s3/S3HttpHandler.java</FILE>
        <FILE>x-pack/plugin/snapshot-repo-test-kit/src/test/java/org/elasticsearch/repositories/blobstore/testkit/analyze/AbstractRepositoryAnalysisRestTestCase.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `S3RepositoryAnalysisRestIT` - Translate a 404 during a multipart copy into a `FileNotFoundException` - Use multiple threads in `S3HttpHandler` to avoid `CopyObject`/`PutObject` deadlock Closes #126576</MESSAGE>
      <SHA>801dd86373a98ab361795245331b226ca28b869b</SHA>
      <PATCHEDFILES>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java</FILE>
        <FILE>muted-tests.yml</FILE>
        <FILE>test/fixtures/s3-fixture/src/main/java/fixture/s3/S3HttpFixture.java</FILE>
        <FILE>test/fixtures/s3-fixture/src/main/java/fixture/s3/S3HttpHandler.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix `S3RepositoryAnalysisRestIT` - Translate a 404 during a multipart copy into a `FileNotFoundException` - Use multiple threads in `S3HttpHandler` to avoid `CopyObject`/`PutObject` deadlock Closes #126576</MESSAGE>
      <SHA>03690fbb9f6359543d332fa8cf81247a7b3ecc5b</SHA>
      <PATCHEDFILES>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java</FILE>
        <FILE>muted-tests.yml</FILE>
        <FILE>test/fixtures/s3-fixture/src/main/java/fixture/s3/S3HttpFixture.java</FILE>
        <FILE>test/fixtures/s3-fixture/src/main/java/fixture/s3/S3HttpHandler.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
