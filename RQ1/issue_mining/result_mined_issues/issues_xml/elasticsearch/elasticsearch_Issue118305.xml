<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>118305</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/118305</ISSUEURL>
  <TITLE>ESQL: Pushdown filter through lookup join</TITLE>
  <DESCRIPTION>### Description One feature we want to get in for `LOOKUP JOIN` is the ability to push down filters passed the join: ``` | LOOKUP JOIN lookup ON a | WHERE a &gt; 10 // becomes | WHERE a &gt; 10 | LOOKUP JOIN lookup ON a ``` Right now, we're looking only at pushing the filter on the main index (left side) - pushdown on the right side will occur later. The overall plan is to convert the `USING/ON a` into an equality expression (resolved in the analyzer since we're not introducing name qualifiers), then combine filters on top of the join, with those in the expression: e.g. (`ON a` becomes `ON leftside.a == rightside.a`) A benefit of the expression combination is creating transient constraints on one join key to the other side (regardless if the name qualifiers are present or not), e.g.: ``` LOOKUP JOIN lookup ON l.a == r.b | WHERE a &gt; 10 // becomes LOOKUP JOIN lookup ON l.a == r.b AND l.a &gt; 10 // through transitivity LOOKUP ON lookup ON l.a == r.b AND l.a &gt; 10 AND r.b &gt; 10 ``` The relevant filters (per side) can then be pushed down on their relevant side: in the example above l.a on the left and r.b on the right. The benefit of this approach is the transitivity rule is generic enough and can be applied in other filters as well. As such: - [ ] Retrofit JoinConfig into a (bool) condition @costin - [ ] extract the equijoin fields through an utility to keep the compute layer untouched - [ ] Combine Filter following JOIN with its condition as a conjunction - [ ] Create rule to detect and infer logic transitivity (for starters we can enable it only for join) /cc @bpintea (given a filter where `a == b and a &gt;1 ` infer than b &gt; 1. Let's get this working for multiple cases as well: `a == b AND b == c AND c &gt; 10 and a &lt; 100` determines that ` a &gt; 10`, `b &gt; 10 AND b &lt; 100` and ` c &lt; 100` - [ ] Break down the filter into conjunctions islands and push down these based on their references to the relevant side</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add a shard snapshot current status debug string (#118198) SnapshotShardsService will update the new debug string field in IndexShardSnapshotStatus as a shard snapshot operation proceeds so that the current state can be logged. The SnapshotShutdownProgressTracker will iterate through the SnapshotShardsService's list of shard snapshots and log their current status. We want to know where in the code a shard snapshot operation potentially gets stuck. This new field should be updated as frequently as is reasonable to inform on the shard snapshot's progress. Closes ES-10261</MESSAGE>
    <SHA>47be542459ee024801fc2fd8bea5e8cc5dea2e0e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>ESQL: Push down filter passed lookup join Improve the planner to detect filters that can be pushed down 'through' a LOOKUP JOIN by determining the conditions scoped to the left/main side and moving them closer to the source. Relates #118305</MESSAGE>
      <SHA>6029a39c020250a9db2593dd885ff64819339854</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/PushDownAndCombineFilters.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/optimizer/LogicalPlanOptimizerTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Push down filter passed lookup join Improve the planner to detect filters that can be pushed down 'through' a LOOKUP JOIN by determining the conditions scoped to the left/main side and moving them closer to the source. Relates #118305</MESSAGE>
      <SHA>e8ffd9281ad25f6243f1e001f7d28b32efb3d401</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/PushDownAndCombineFilters.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/optimizer/LogicalPlanOptimizerTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
