<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>127711</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/127711</ISSUEURL>
  <TITLE>[CI] DiskThresholdDeciderIT testRestoreSnapshotAllocationDoesNotExceedWatermarkWithMultipleRestores failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic #8040 / encryption-at-rest](https://gradle-enterprise.elastic.co/s/p4zfqa3gjcnbo) - [elasticsearch-periodic-platform-support #8055 / ubuntu-1804_platform-support-unix](https://gradle-enterprise.elastic.co/s/hevj2qbxaf43c) - [elasticsearch-periodic-platform-support #8055 / ubuntu-2404_platform-support-unix](https://gradle-enterprise.elastic.co/s/n36vduiifwmsu) - [elasticsearch-periodic-platform-support #8049 / rocky-9_platform-support-unix](https://gradle-enterprise.elastic.co/s/vvrm5qhy3mr7q) **Reproduction Line:** ``` ./gradlew &quot;:server:internalClusterTest&quot; --tests &quot;org.elasticsearch.cluster.routing.allocation.decider.DiskThresholdDeciderIT.testRestoreSnapshotAllocationDoesNotExceedWatermarkWithMultipleRestores&quot; -Dtests.seed=29F197D13958671B -Dtests.locale=en-KY -Dtests.timezone=Antarctica/Palmer -Druntime.java=24 ``` **Applicable branches:** 8.19 **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.cluster.routing.allocation.decider.DiskThresholdDeciderIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testRestoreSnapshotAllocationDoesNotExceedWatermarkWithMultipleRestores),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.util.NoSuchElementException: null ``` **Issue Reasons:** - [8.19] 4 failures in test testRestoreSnapshotAllocationDoesNotExceedWatermarkWithMultipleRestores (5.1% fail rate in 78 executions) - [8.19] 2 failures in pipeline elasticsearch-periodic-platform-support (100.0% fail rate in 2 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[Test] Use version range for elasticsearch-java (#127510) (#127707) Snapshot builds of elasticsearch-java are no longer available. Using the current major highest version should be safe according to the compatibility guarantees described on https://github.com/elastic/elasticsearch-java?tab=readme-ov-file#compatibility Additionally, reorganize Maven repository configuration in build.gradle Repo https://snapshots.elastic.co/maven/ is no longer needed in a composite build. Previously it was only used to provide snapshot version of `elasticsearch-java` client which is no longer available in snapshot version. We keep the https://snapshots.elastic.co/maven/ repo to be used when for non-composite builds when any other dependencies snapshot versions can be fetched.</MESSAGE>
    <SHA>e63c65e6c39d87a910addf4bb33bb76402f1feff</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix assertion in DiskThresholdDeciderIT (#127615) (#127642) The test launches two concurrent restores and wants to verify that the node with limited disk space is only assigned a single shard from one of the indices. The test was asserting that it had one shard from the first index, but it is possible for it to get one shard from the index copy instead. This change allows the shard to be from either index, but still asserts there is only one assignment to the tiny node. Closes #127711 (cherry picked from commit 6263f4400f032e41272a715ed89ad2f55b689e05)</MESSAGE>
      <SHA>ed052b044eb65d1fa90aeaed36e64fe90a4cfc76</SHA>
      <PATCHEDFILES>
        <FILE>server/src/internalClusterTest/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
