<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>120757</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/120757</ISSUEURL>
  <TITLE>[CI] CrossClusterAsyncEnrichStopIT testEnrichAfterStop failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #6226 / almalinux-8-aarch64_checkpart3_platform-support-arm](https://gradle-enterprise.elastic.co/s/a2mcjxvspqiwu) - [elasticsearch-periodic-platform-support #6219 / windows-2022_checkpart3_platform-support-windows](https://gradle-enterprise.elastic.co/s/lik4ok3hlybi6) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:esql:internalClusterTest&quot; --tests &quot;org.elasticsearch.xpack.esql.action.CrossClusterAsyncEnrichStopIT.testEnrichAfterStop&quot; -Dtests.seed=1A7DB3EBADF65FCF -Dtests.locale=en-GM -Dtests.timezone=Asia/Jerusalem -Druntime.java=23 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.esql.action.CrossClusterAsyncEnrichStopIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testEnrichAfterStop),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: Expected: &lt;[[5, Apple], [6, Microsoft], [3, Redhat], [2, Samsung], [2, null]]&gt; but: was &lt;[[6, Apple], [7, Microsoft], [3, Redhat], [3, Samsung], [3, null]]&gt; ``` **Issue Reasons:** - [main] 2 failures in test testEnrichAfterStop (1.9% fail rate in 105 executions) - [main] 2 failures in pipeline elasticsearch-periodic-platform-support (100.0% fail rate in 2 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>13</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[ML] Migrate stream to core error parsing (#120722) Avoid trapping Throwable by rethrowing it on another thread, allowing us to reuse the `generateFailureXContent` for Exceptions and match the new 9.0 format.</MESSAGE>
    <SHA>bee1a4b2efc3aeef978b9a6908599f03c66941a9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.esql.action.CrossClusterAsyncEnrichStopIT testEnrichAfterStop #120757</MESSAGE>
      <SHA>c7d8862c75dab684c1997f486ccf869dee5459f3</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.esql.action.CrossClusterAsyncEnrichStopIT testEnrichAfterStop #120757</MESSAGE>
      <SHA>47be8e5965a6fd5802f5ea70c278fada35f8e5c1</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Keep outstanding pages when finish buffer early (#121857) Today, the exchange buffer of an exchange source is finished in two cases: (1) when the downstream pipeline has received enough data and (2) when all remote sinks have completed. In the first case, outstanding pages could be safely discarded. In the second case, no new pages should be received after finishing. In both scenarios, discarding all outstanding pages was safe if noMoreInputs was switched while adding pages. However, with the stop API, the buffer may now finish while keeping outstanding pages, and new pages may still be received. This change updates the exchange buffer to discard only the incoming page when noMoreInputs is switched, rather than all pages in the buffer. Closes #120757</MESSAGE>
      <SHA>924eb89d212f3b4b9371f12e8d0a7d07c126e126</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/operator/exchange/ExchangeBuffer.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/test/java/org/elasticsearch/compute/operator/exchange/ExchangeBufferTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
