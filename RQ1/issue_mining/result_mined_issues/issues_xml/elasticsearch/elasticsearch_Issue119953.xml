<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>119953</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/119953</ISSUEURL>
  <TITLE>ESQL: Port `CaseEagerEvaluator` style optimization to COALESCE`</TITLE>
  <DESCRIPTION>### Description We have an optimization for `CASE` where it can sometimes eagerly evaluate it's child blocks. That makes it *much* faster. But COALESCE doesn't have that optimization. Here are some examples for a fairly small amount of data: ``` COALESCE 362853310 nanos CASE 2939272 nanos ```</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>13</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ESQL: Signatures for `NOT IN` et al (#120673) (#120737) * ESQL: Signatures for `NOT IN` et al This generates signatures for `NOT IN`, `NOT LIKE`, and `NOT RLIKE` using a small hack on top of the process used to generate the signatures for `IN`, `LIKE`, and `RLIKE`. This is a very perl-worth hack, replacing `LIKE` with `NOT LIKE` in the description. But it's useful for our kibana friends and if we need to make it nicer we can do so later. * Zap</MESSAGE>
    <SHA>227f582c07bff5fc923e381922e788550b8203d5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Speed up COALESCE significantly (#120139) ``` before after (operation) Score Error Score Error Units coalesce_2_noop 75.949 ± 3.961 -&gt; 0.010 ± 0.001 ns/op 99.9% coalesce_2_eager 99.299 ± 6.959 -&gt; 4.292 ± 0.227 ns/op 95.7% coalesce_2_lazy 113.118 ± 5.747 -&gt; 26.746 ± 0.954 ns/op 76.4% ``` We tend to advise folks that &quot;COALESCE is faster than CASE&quot;, but, as of 8.16.0/https://github.com/elastic/elasticsearch/pull/112295 that wasn't the true. I was working with someone a few days ago to port a scripted_metric aggregation to ESQL and we saw COALESCE taking ~60% of the time. That won't do. The trouble is that CASE and COALESCE have to be *lazy*, meaning that operations like: ``` COALESCE(a, 1 / b) ``` should never emit a warning if `a` is not `null`, even if `b` is `0`. In 8.16/https://github.com/elastic/elasticsearch/pull/112295 CASE grew an optimization where it could operate non-lazily if it was flagged as &quot;safe&quot;. This brings a similar optimization to COALESCE, see it above as &quot;case_2_eager&quot;, a 95.7% improvement. It also brings and arguably more important optimization - entire-block execution for COALESCE. The schort version is that, if the first parameter of COALESCE returns no nulls we can return it without doing anything lazily. There are a few more cases, but the upshot is that COALESCE is pretty much *free* in cases where long strings of results are `null` or not `null`. That's the `coalesce_2_noop` line. Finally, when there mixed null and non-null values we were using a single builder with some fairly inefficient paths. This specializes them per type and skips some slow null-checking where possible. That's the `coalesce_2_lazy` result, a more modest 76.4%. NOTE: These %s of improvements on COALESCE itself, or COALESCE with some load-overhead operators like `+`. If COALESCE isn't taking a *ton* time in your query don't get particularly excited about this. It's fun though. Closes #119953</MESSAGE>
      <SHA>c2bff8184a1436f66c4c81fa5c53f71aa69a3a6f</SHA>
      <PATCHEDFILES>
        <FILE>.gitattributes</FILE>
        <FILE>benchmarks/README.md</FILE>
        <FILE>benchmarks/src/main/java/org/elasticsearch/benchmark/compute/operator/EvalBenchmark.java</FILE>
        <FILE>x-pack/plugin/esql/build.gradle</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BooleanBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BooleanBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BytesRefBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BytesRefBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/DoubleBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/DoubleBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/FloatBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/FloatBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/IntBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/IntBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/LongBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/LongBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/Block.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/X-Block.java.st</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/X-BlockBuilder.java.st</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/operator/EvalOperator.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/test/java/org/elasticsearch/compute/data/BlockBuilderCopyFromTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceBooleanEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceBytesRefEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceDoubleEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceIntEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceLongEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/conditional/Case.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/Coalesce.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/X-CoalesceEvaluator.java.st</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Speed up COALESCE significantly (#120139) ``` before after (operation) Score Error Score Error Units coalesce_2_noop 75.949 ± 3.961 -&gt; 0.010 ± 0.001 ns/op 99.9% coalesce_2_eager 99.299 ± 6.959 -&gt; 4.292 ± 0.227 ns/op 95.7% coalesce_2_lazy 113.118 ± 5.747 -&gt; 26.746 ± 0.954 ns/op 76.4% ``` We tend to advise folks that &quot;COALESCE is faster than CASE&quot;, but, as of 8.16.0/https://github.com/elastic/elasticsearch/pull/112295 that wasn't the true. I was working with someone a few days ago to port a scripted_metric aggregation to ESQL and we saw COALESCE taking ~60% of the time. That won't do. The trouble is that CASE and COALESCE have to be *lazy*, meaning that operations like: ``` COALESCE(a, 1 / b) ``` should never emit a warning if `a` is not `null`, even if `b` is `0`. In 8.16/https://github.com/elastic/elasticsearch/pull/112295 CASE grew an optimization where it could operate non-lazily if it was flagged as &quot;safe&quot;. This brings a similar optimization to COALESCE, see it above as &quot;case_2_eager&quot;, a 95.7% improvement. It also brings and arguably more important optimization - entire-block execution for COALESCE. The schort version is that, if the first parameter of COALESCE returns no nulls we can return it without doing anything lazily. There are a few more cases, but the upshot is that COALESCE is pretty much *free* in cases where long strings of results are `null` or not `null`. That's the `coalesce_2_noop` line. Finally, when there mixed null and non-null values we were using a single builder with some fairly inefficient paths. This specializes them per type and skips some slow null-checking where possible. That's the `coalesce_2_lazy` result, a more modest 76.4%. NOTE: These %s of improvements on COALESCE itself, or COALESCE with some load-overhead operators like `+`. If COALESCE isn't taking a *ton* time in your query don't get particularly excited about this. It's fun though. Closes #119953</MESSAGE>
      <SHA>dc4fa2617451d57bc0a72a09990ae0855bfce95f</SHA>
      <PATCHEDFILES>
        <FILE>.gitattributes</FILE>
        <FILE>benchmarks/README.md</FILE>
        <FILE>benchmarks/src/main/java/org/elasticsearch/benchmark/compute/operator/EvalBenchmark.java</FILE>
        <FILE>x-pack/plugin/esql/build.gradle</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BooleanBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BooleanBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BytesRefBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BytesRefBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/DoubleBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/DoubleBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/FloatBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/FloatBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/IntBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/IntBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/LongBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/LongBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/Block.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/X-Block.java.st</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/X-BlockBuilder.java.st</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/operator/EvalOperator.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/test/java/org/elasticsearch/compute/data/BlockBuilderCopyFromTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceBooleanEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceBytesRefEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceDoubleEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceIntEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceLongEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/conditional/Case.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/Coalesce.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/X-CoalesceEvaluator.java.st</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Speed up COALESCE significantly (#120139) (#120747) ``` before after (operation) Score Error Score Error Units coalesce_2_noop 75.949 ± 3.961 -&gt; 0.010 ± 0.001 ns/op 99.9% coalesce_2_eager 99.299 ± 6.959 -&gt; 4.292 ± 0.227 ns/op 95.7% coalesce_2_lazy 113.118 ± 5.747 -&gt; 26.746 ± 0.954 ns/op 76.4% ``` We tend to advise folks that &quot;COALESCE is faster than CASE&quot;, but, as of 8.16.0/https://github.com/elastic/elasticsearch/pull/112295 that wasn't the true. I was working with someone a few days ago to port a scripted_metric aggregation to ESQL and we saw COALESCE taking ~60% of the time. That won't do. The trouble is that CASE and COALESCE have to be *lazy*, meaning that operations like: ``` COALESCE(a, 1 / b) ``` should never emit a warning if `a` is not `null`, even if `b` is `0`. In 8.16/https://github.com/elastic/elasticsearch/pull/112295 CASE grew an optimization where it could operate non-lazily if it was flagged as &quot;safe&quot;. This brings a similar optimization to COALESCE, see it above as &quot;case_2_eager&quot;, a 95.7% improvement. It also brings and arguably more important optimization - entire-block execution for COALESCE. The schort version is that, if the first parameter of COALESCE returns no nulls we can return it without doing anything lazily. There are a few more cases, but the upshot is that COALESCE is pretty much *free* in cases where long strings of results are `null` or not `null`. That's the `coalesce_2_noop` line. Finally, when there mixed null and non-null values we were using a single builder with some fairly inefficient paths. This specializes them per type and skips some slow null-checking where possible. That's the `coalesce_2_lazy` result, a more modest 76.4%. NOTE: These %s of improvements on COALESCE itself, or COALESCE with some load-overhead operators like `+`. If COALESCE isn't taking a *ton* time in your query don't get particularly excited about this. It's fun though. Closes #119953</MESSAGE>
      <SHA>34e7953b4ffe590e53ed25159bab5c328ebe8ae7</SHA>
      <PATCHEDFILES>
        <FILE>.gitattributes</FILE>
        <FILE>benchmarks/README.md</FILE>
        <FILE>benchmarks/src/main/java/org/elasticsearch/benchmark/compute/operator/EvalBenchmark.java</FILE>
        <FILE>x-pack/plugin/esql/build.gradle</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BooleanBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BooleanBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BytesRefBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/BytesRefBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/DoubleBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/DoubleBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/FloatBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/FloatBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/IntBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/IntBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/LongBlock.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/data/LongBlockBuilder.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/Block.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/X-Block.java.st</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/data/X-BlockBuilder.java.st</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/operator/EvalOperator.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/test/java/org/elasticsearch/compute/data/BlockBuilderCopyFromTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceBooleanEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceBytesRefEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceDoubleEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceIntEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/generated-src/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceLongEvaluator.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/conditional/Case.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/Coalesce.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/X-CoalesceEvaluator.java.st</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/scalar/nulls/CoalesceTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
