<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>509</ISSUENO>
  <ISSUEURL>https://github.com/openstf/stf/issues/509</ISSUEURL>
  <TITLE>Migrations sometimes don't take effect when running `stf local` for the first time</TITLE>
  <DESCRIPTION>I have installed all requirements for stf and run npm install normally. but when I run stf local command, the error messages is threw. FTL/reaper 690 [reaper001] Unable to load initial state { ReqlOpFailedError: Database `stf` does not exist in: r.table(&quot;devices&quot;).getAll(true, {&quot;index&quot;: &quot;present&quot;}) ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ at ReqlOpFailedError.ReqlError [as constructor] (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/errors.js:23:13) at ReqlOpFailedError.ReqlRuntimeError [as constructor] (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/errors.js:90:51) at ReqlOpFailedError.ReqlAvailabilityError [as constructor] (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/errors.js:167:56) at new ReqlOpFailedError (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/errors.js:178:52) at mkErr (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/util.js:177:10) at TcpConnection.Connection._processResponse (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/net.js:152:16) at TcpConnection.Connection._data (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/net.js:122:12) at Socket.&lt;anonymous&gt; (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/net.js:689:32) at emitOne (events.js:96:13) at Socket.emit (events.js:188:7) at readableAddChunk (_stream_readable.js:176:18) at Socket.Readable.push (_stream_readable.js:134:10) at TCP.onread (net.js:551:20) From previous event: at Function.TermBase.run (/Users/zhangwl/work/stf-master/node_modules/rethinkdb/ast.js:135:12) at /Users/zhangwl/work/stf-master/lib/db/index.js:110:14 at runCallback (timers.js:651:20) at tryOnImmediate (timers.js:624:5) at processImmediate [as _immediateCallback] (timers.js:596:5) From previous event: at Object.db.run (/Users/zhangwl/work/stf-master/lib/db/index.js:109:23) at Object.dbapi.loadPresentDevices (/Users/zhangwl/work/stf-master/lib/db/api.js:333:13) at loadInitialState (/Users/zhangwl/work/stf-master/lib/units/reaper/index.js:80:18) at module.exports (/Users/zhangwl/work/stf-master/lib/units/reaper/index.js:122:3) at Object.module.exports.handler (/Users/zhangwl/work/stf-master/lib/cli/reaper/index.js:42:39) at Object.self.runCommand (/Users/zhangwl/work/stf-master/node_modules/yargs/lib/command.js:169:22) at parseArgs (/Users/zhangwl/work/stf-master/node_modules/yargs/yargs.js:869:28) at Object.get [as argv] (/Users/zhangwl/work/stf-master/node_modules/yargs/yargs.js:809:16) at Object.&lt;anonymous&gt; (/Users/zhangwl/work/stf-master/lib/cli/index.js:40:3) at Module._compile (module.js:571:32) at Object.Module._extensions..js (module.js:580:10) at Module.load (module.js:488:32) at tryModuleLoad (module.js:447:12) at Function.Module._load (module.js:439:3) at Module.runMain (module.js:605:10) at run (bootstrap_node.js:420:7) at startup (bootstrap_node.js:139:9) at bootstrap_node.js:535:3 name: 'ReqlOpFailedError', msg: 'Database `stf` does not exist.', frames: [], message: 'Database `stf` does not exist in:\nr.table(&quot;devices&quot;).getAll(true, {&quot;index&quot;: &quot;present&quot;})\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^' } FTL/util:lifecycle 690 [reaper001] Shutting down due to fatal error FTL/cli:local 684 [*] Child process had an error ExitError: Exit code &quot;1&quot; at ChildProcess.&lt;anonymous&gt; (/Users/zhangwl/work/stf-master/lib/util/procutil.js:49:23) at emitTwo (events.js:106:13) at ChildProcess.emit (events.js:191:7) at Process.ChildProcess._handle.onexit (internal/child_process.js:215:12) INF/cli:local 684 [*] Shutting down all child processes INF/util:lifecycle 686 [app001] Winding down for graceful exit INF/util:lifecycle 687 [dev001] Winding down for graceful exit INF/util:lifecycle 688 [proc001] Winding down for graceful exit INF/util:lifecycle 689 [proc002] Winding down for graceful exit WRN/db 688 [proc001] Connection closed INF/db 688 [proc001] Connecting to 127.0.0.1:28015 WRN/db 689 [proc002] Connection closed INF/db 689 [proc002] Connecting to 127.0.0.1:28015</DESCRIPTION>
  <REPONAME>stf</REPONAME>
  <TIMEDIFFERENCEDAYS>46</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Don't allow the processor unit to run before we're able to connect to the database. This caused an issue when the database started up slowly, but the processor connected to the app/dev dealers regardless. Any received messages requiring database connectivity would cause the processor to die (and be restarted by systemd), causing lost messages on occasion.</MESSAGE>
    <SHA>385acc4ff2062eba85ca78c3a6807f22c8500854</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix incorrect migrate file path in stf local. Fixes #535 and #509.</MESSAGE>
      <SHA>083a2a1f92534e03137f261d294d793a5101815e</SHA>
      <PATCHEDFILES>
        <FILE>lib/cli/local/index.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix incorrect migrate file path in stf local. Fixes #535 and #509.</MESSAGE>
      <SHA>c6ac1878b3be6afeed430651817d50745b0ad8ad</SHA>
      <PATCHEDFILES>
        <FILE>lib/cli/local/index.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
