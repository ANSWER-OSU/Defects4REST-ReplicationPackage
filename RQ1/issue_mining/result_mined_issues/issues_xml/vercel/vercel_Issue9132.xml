<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>9132</ISSUENO>
  <ISSUEURL>https://github.com/vercel/vercel/issues/9132</ISSUEURL>
  <TITLE>Python ASGI functions crashing on incoming headers</TITLE>
  <DESCRIPTION>## Issue When deploying a Python ASGI application (e.g. using FastAPI, Sanic) with Vercel Serverless, the function is built successfully but invoking the URL the function leads to a crash with a 500 error. Here is the backend log from Vercel: ``` [ERROR] AttributeError: 'list' object has no attribute 'encode' Traceback (most recent call last): File &quot;/var/task/vc__handler__python.py&quot;, line 288, in vc_handler 'headers': [[k.lower().encode(), v.encode()] for k, v in headers.items()], File &quot;/var/task/vc__handler__python.py&quot;, line 288, in &lt;listcomp&gt; 'headers': [[k.lower().encode(), v.encode()] for k, v in headers.items()], ``` ## Investigations It seems there is an issue with incoming complex headers parsing for ASGI functions: - Python WSGI applications (e.g. using Flask) do not show this error - Invocations of ASGI functions using `curl` or `httpie` works perfectly, no errors - Bisecting headers from the web browser (Firefox, Chrome), here is a faulty header causing the crash: ``` Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 ``` - Invocations of ASGI functions using `curl` or `httpie` using the above header are triggering the error ## Reproduction A simple hello world app with FastAPI or Sanic in a module name `app.py`: ```python from fastapi import FastAPI app = FastAPI() @app.get(&quot;/&quot;) def index(): return {&quot;message&quot;: &quot;Hello World&quot;} ``` ```python from sanic import Sanic from sanic.response import json app = Sanic(name=__name__) @app.route(&quot;/&quot;) async def index(request): return json({&quot;message&quot;: &quot;Hello World&quot;}) ``` `vercel.json`: ``` { &quot;builds&quot;: [ { &quot;src&quot;: &quot;app.py&quot;, &quot;use&quot;: &quot;@vercel/python&quot; } ], &quot;routes&quot;: [ { &quot;src&quot;: &quot;/(.*)&quot;, &quot;dest&quot;: &quot;app.py&quot; } ] } ``` ## Related issues - https://github.com/vercel/vercel/issues/2526</DESCRIPTION>
  <REPONAME>vercel</REPONAME>
  <TIMEDIFFERENCEDAYS>39</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[node] Add log for unused config runtime (#9373) Both `runtime: undefined` and `runtime: nodejs` have the same behavior but we want to change that in the future. The first step is to see if `runtime: nodejs` is currently used at all.</MESSAGE>
    <SHA>b5a940827266893fb5649afc539630d2de1f4821</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[python] Cope with duplicate header values (#9205) There are times when a request can arrive for a Python function with headers as a list. One of those examples is this header `x-vercel-proxied-for` which apparently is set twice. Example: `[b'x-vercel-proxied-for', [b'207.81.134.243', b'172.71.147.74']]` I took a quick scan through the other Python server implementations and I don't think any of them manipulate the value of the HTTP headers, the way the ASGI one does so I think we are good there. To reproduce: `curl https://..../ -H &quot;foo: bar&quot; -H &quot;foo: bar&quot;` Will fail. Fixes: https://github.com/vercel/vercel/issues/9132</MESSAGE>
      <SHA>ba498f3a8e7dc7097d34fc380f097f9a55197c90</SHA>
      <PATCHEDFILES>
        <FILE>packages/python/test/fixtures/32-fail-duplicate-header/index.py</FILE>
        <FILE>packages/python/test/fixtures/32-fail-duplicate-header/probe.js</FILE>
        <FILE>packages/python/test/fixtures/32-fail-duplicate-header/vercel.json</FILE>
        <FILE>packages/python/vc_init.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
