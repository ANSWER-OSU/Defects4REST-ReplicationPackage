<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3091</ISSUENO>
  <ISSUEURL>https://github.com/vercel/vercel/issues/3091</ISSUEURL>
  <TITLE>UnicodeEncodeError in python builder</TITLE>
  <DESCRIPTION>Any payload that has non-ascii characters in it blows up if not encoded in latin-1. All payloads from browsers will be utf-8. To reproduce: Have a web app send (fetch) a json payload with strings with Greek (or other non-ascii characters) to a python endpoint deployed on now. Logs: ``` Duration: 1.84 ms Billed Duration: 100 ms Memory Size: 3008 MB Max Memory Used: 66 MB Unhandled exception in thread started by &lt;bound method BaseServer.handle_request of &lt;http.server.HTTPServer object at 0x7f83a3e29e48&gt;&gt; Traceback (most recent call last): File &quot;/var/lang/lib/python3.6/socketserver.py&quot;, line 298, in handle_request ready = selector.select(timeout) File &quot;/var/lang/lib/python3.6/selectors.py&quot;, line 376, in select fd_event_list = self._poll.poll(timeout) PermissionError: [Errno 1] Operation not permitted 'latin-1' codec can't encode characters in position 2370-2379: Body ('Χριστοφορε') is not valid Latin-1. Use body.encode('utf-8') if you want to send it encoded in UTF-8.: UnicodeEncodeError Traceback (most recent call last): File &quot;/var/task/now__handler__python.py&quot;, line 42, in now_handler headers=headers, data=body, allow_redirects=False) File &quot;/var/task/requests/api.py&quot;, line 60, in request return session.request(method=method, url=url, **kwargs) File &quot;/var/task/requests/sessions.py&quot;, line 533, in request resp = self.send(prep, **send_kwargs) File &quot;/var/task/requests/sessions.py&quot;, line 646, in send r = adapter.send(request, **kwargs) File &quot;/var/task/requests/adapters.py&quot;, line 449, in send timeout=timeout File &quot;/var/task/urllib3/connectionpool.py&quot;, line 672, in urlopen chunked=chunked, File &quot;/var/task/urllib3/connectionpool.py&quot;, line 387, in _make_request conn.request(method, url, **httplib_request_kw) File &quot;/var/lang/lib/python3.6/http/client.py&quot;, line 1254, in request self._send_request(method, url, body, headers, encode_chunked) File &quot;/var/lang/lib/python3.6/http/client.py&quot;, line 1299, in _send_request body = _encode(body, 'body') File &quot;/var/lang/lib/python3.6/http/client.py&quot;, line 171, in _encode (name.title(), data[err.start:err.end], name)) from None UnicodeEncodeError: 'latin-1' codec can't encode characters in position 2370-2379: Body ('Χριστοφορε') is not valid Latin-1. Use body.encode('utf-8') if you want to send it encoded in UTF-8. ``` Full reproduction here: https://github.com/offero/nowpyunicodefail</DESCRIPTION>
  <REPONAME>vercel</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>encode body as utf-8 before making a request</MESSAGE>
    <SHA>e4bb25d58d2d133e36f46433c9cad4603120aba8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>added test for #3091</MESSAGE>
      <SHA>c0a2f047d5d9fece0f87e2df95ead366db9b31cc</SHA>
      <PATCHEDFILES>
        <FILE>packages/now-python/test/fixtures/14-unicode-handler/index.py</FILE>
        <FILE>packages/now-python/test/fixtures/14-unicode-handler/now.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>only encode when str type #3091</MESSAGE>
      <SHA>5f2d43f6b54f090860a0e7a906c610fb88aabefb</SHA>
      <PATCHEDFILES>
        <FILE>packages/now-python/now_init.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[now-python] Encode body as utf-8 before making a request (#3093) Fixes #3091</MESSAGE>
      <SHA>c3020e30710003095f21dfec8e8d42d0a8ccbdc2</SHA>
      <PATCHEDFILES>
        <FILE>packages/now-python/now_init.py</FILE>
        <FILE>packages/now-python/test/fixtures/14-unicode-handler/index.py</FILE>
        <FILE>packages/now-python/test/fixtures/14-unicode-handler/now.json</FILE>
        <FILE>packages/now-python/test/fixtures/14-unicode-handler/probe.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[now-python] Encode body as utf-8 before making a request (#3093) Fixes #3091</MESSAGE>
      <SHA>94fba1d7afef822aa333dbb990dec98ad25f1ec9</SHA>
      <PATCHEDFILES>
        <FILE>packages/now-python/now_init.py</FILE>
        <FILE>packages/now-python/test/fixtures/14-unicode-handler/index.py</FILE>
        <FILE>packages/now-python/test/fixtures/14-unicode-handler/now.json</FILE>
        <FILE>packages/now-python/test/fixtures/14-unicode-handler/probe.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
