<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3747</ISSUENO>
  <ISSUEURL>https://github.com/vercel/vercel/issues/3747</ISSUEURL>
  <TITLE>Can't unignore default ignored paths</TITLE>
  <DESCRIPTION>There currently does not seem to be a way to un-ignore any of the [default ignored file path specs](https://zeit.co/docs/v2/build-step/#ignored-files-and-folders), attempting to do so via `.nowignore` like the following does not work: ``` !.env.json ```</DESCRIPTION>
  <REPONAME>vercel</REPONAME>
  <TIMEDIFFERENCEDAYS>127</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[cli] Invalidate the configuration if `vercel.json` is deleted (#4629) Before this, if the `vercel.json` file gets deleted while the dev server is running, then it would still act like the file exists since it would use the cached version. Now it properly invalidates to an empty configuration if the `vercel.json` file does not exist.</MESSAGE>
    <SHA>42f2fa1a203e01ec2576a4ab2d06b479109a6bbd</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[client] Fix `.vercelignore` override default ignore list (#4627) - Fixes #3747 - Related to #4325 - Related to [tweet](https://twitter.com/Rich_Harris/status/1270871878018699264) from @Rich-Harris - Docs updated in https://github.com/vercel/docs/pull/1909 There was an issue that was likely introduced when we started using `@vercel/client`: the [default ignore list](https://vercel.com/docs/v2/build-step#ignored-files-and-folders) could not be overridden. This is because the default `ignores` array was always used instead of the combined `default ignore + user ignore`. The solution was to utilize [`recursive-readdir` ignore function](https://www.npmjs.com/package/recursive-readdir#usage) along with [`ig.ignores` function](https://www.npmjs.com/package/ignore#usage) so that the combined result is used for ignoring files while walking the file tree. This ensures that the fix from PR #4325 is still effective and also fixes the longstanding bug from Issue #3747.</MESSAGE>
      <SHA>8d015e3138936fd6b692ef0e48764c4fca092c7b</SHA>
      <PATCHEDFILES>
        <FILE>packages/now-client/.gitignore</FILE>
        <FILE>packages/now-client/src/utils/index.ts</FILE>
        <FILE>packages/now-client/tests/fixtures/vercelignore-allow-nodemodules/.env.local</FILE>
        <FILE>packages/now-client/tests/fixtures/vercelignore-allow-nodemodules/.vercelignore</FILE>
        <FILE>packages/now-client/tests/fixtures/vercelignore-allow-nodemodules/exclude.txt</FILE>
        <FILE>packages/now-client/tests/fixtures/vercelignore-allow-nodemodules/hello.txt</FILE>
        <FILE>packages/now-client/tests/fixtures/vercelignore-allow-nodemodules/node_modules/one.txt</FILE>
        <FILE>packages/now-client/tests/fixtures/vercelignore-allow-nodemodules/sub/include.txt</FILE>
        <FILE>packages/now-client/tests/fixtures/vercelignore-allow-nodemodules/sub/node_modules/two.txt</FILE>
        <FILE>packages/now-client/tests/unit.utils.test.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[client] (Major) Remove trailing `/` from default ignore list (#4810) The trailing slash ends up making the root directory be accepted, causing the ignore logic to traverse one level deep into the directory that should be ignored. Removing the slash makes the root directory be correctly ignored so that traversing one level into the ignored directory is avoided, which is less work to do and thus is faster. Before: ``` &gt; [debug] [2020-07-07T23:22:05.768Z] Locating files /Users/nrajlich/project &gt; [debug] [2020-07-07T23:22:05.769Z] Ignoring /Users/nrajlich/project/.editorconfig &gt; [debug] [2020-07-07T23:22:05.769Z] Ignoring /Users/nrajlich/project/.git &gt; [debug] [2020-07-07T23:22:05.769Z] Ignoring /Users/nrajlich/project/.gitignore &gt; [debug] [2020-07-07T23:22:05.769Z] Ignoring /Users/nrajlich/project/.next &gt; [debug] [2020-07-07T23:22:05.769Z] Ignoring /Users/nrajlich/project/.vercel &gt; [debug] [2020-07-07T23:22:05.770Z] Ignoring /Users/nrajlich/project/.vercelignore &gt; [debug] [2020-07-07T23:22:05.770Z] Ignoring /Users/nrajlich/project/README.md &gt; [debug] [2020-07-07T23:22:05.770Z] Ignoring /Users/nrajlich/project/dist &gt; [debug] [2020-07-07T23:22:05.774Z] Ignoring /Users/nrajlich/project/node_modules/.bin &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/.yarn-integrity &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@ampproject &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@babel &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@mrmlnc &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@next &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@nodelib &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@tootallnate &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@types &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@typescript-eslint &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@vercel &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@webassemblyjs &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/@xtuc &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/acorn &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/acorn-jsx &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/adjust-sourcemap-loader &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/aggregate-error &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/ajv &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/ajv-errors &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/ajv-keywords &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/ally.js &gt; [debug] [2020-07-07T23:22:05.775Z] Ignoring /Users/nrajlich/project/node_modules/alphanum-sort &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/anser &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/ansi-escapes &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/ansi-regex &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/ansi-styles &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/anymatch &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/aproba &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/argparse &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/aria-query &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/arity-n &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/arr-diff &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/arr-flatten &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/arr-union &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/array-find-index &gt; [debug] [2020-07-07T23:22:05.776Z] Ignoring /Users/nrajlich/project/node_modules/array-includes … … many more … &gt; [debug] [2020-07-07T23:25:19.854Z] Locating files /Users/nrajlich/project: 20.117ms ``` After: ``` &gt; [debug] [2020-07-07T23:24:37.403Z] Locating files /Users/nrajlich/project &gt; [debug] [2020-07-07T23:24:37.413Z] Ignoring /Users/nrajlich/project/.editorconfig &gt; [debug] [2020-07-07T23:24:37.414Z] Ignoring /Users/nrajlich/project/.git &gt; [debug] [2020-07-07T23:24:37.414Z] Ignoring /Users/nrajlich/project/.gitignore &gt; [debug] [2020-07-07T23:24:37.414Z] Ignoring /Users/nrajlich/project/.next &gt; [debug] [2020-07-07T23:24:37.414Z] Ignoring /Users/nrajlich/project/.vercel &gt; [debug] [2020-07-07T23:24:37.415Z] Ignoring /Users/nrajlich/project/.vercelignore &gt; [debug] [2020-07-07T23:24:37.415Z] Ignoring /Users/nrajlich/project/README.md &gt; [debug] [2020-07-07T23:24:37.415Z] Ignoring /Users/nrajlich/project/dist &gt; [debug] [2020-07-07T23:24:37.416Z] Ignoring /Users/nrajlich/project/node_modules &gt; [debug] [2020-07-07T23:25:19.854Z] Locating files /Users/nrajlich/project: 2.117ms ``` - Related to #3980 - Related to #3747 - Related to #4325 - Related to #4627</MESSAGE>
      <SHA>46836e12b5b026b36504e81e69ee20e0abb696df</SHA>
      <PATCHEDFILES>
        <FILE>packages/now-cli/src/util/ignored.ts</FILE>
        <FILE>packages/now-client/src/utils/index.ts</FILE>
        <FILE>packages/now-client/tests/fixtures/vercelignore-allow-nodemodules/.vercelignore</FILE>
        <FILE>packages/now-client/tests/unit.utils.test.ts</FILE>
        <FILE>packages/now-static-build/src/index.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
