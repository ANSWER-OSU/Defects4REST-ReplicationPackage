<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5136</ISSUENO>
  <ISSUEURL>https://github.com/vercel/vercel/issues/5136</ISSUEURL>
  <TITLE>Deployment sometimes fails when using Yarn 2</TITLE>
  <DESCRIPTION>I'm playing with Yarn 2 and Vercel ([my project](http://github.com/kidonng/swiss), which [doesn't use Plug'n'Play](https://github.com/kidonng/swiss/blob/aa67475ee9bbea49fb468c8bdad8003b6cf40bf5/.yarnrc.yml#L1)). It works fine when using the Vercel CLI, but sometimes fails when using GitHub integration. **EDIT**: looks like it may also fail even if using the Vercel CLI, so I'm changing the title to make it clear. - An example of failed deployment (https://vercel.com/kidonng/swiss/non9mdxh5) Actually, most of the deployments will fail ``` 20:30:20.203 | Cloning github.com/kidonng/swiss (Branch: master, Commit: aa67475) 20:30:20.849 | Cloning completed in 646ms 20:30:20.850 | Analyzing source code... (Omitted) 20:30:46.416 | ➤ YN0013: │ yn@npm:3.1.1 can't be found in the cache and will be fetched from the remote registry 20:30:46.416 | ➤ YN0013: │ yorkie@npm:2.0.0 can't be found in the cache and will be fetched from the remote registry 20:31:48.790 | ➤ YN0000: └ Completed in 1.37m 20:31:48.956 | ➤ YN0000: ┌ Link step 20:31:49.037 | ➤ YN0062: │ fsevents@patch:fsevents@npm%3A2.1.3#builtin&lt;compat/fsevents&gt;::version=2.1.3&amp;hash=87eb42 The platform linux is incompatible with this module, linking skipped. 20:31:49.382 | ➤ YN0062: │ fsevents@patch:fsevents@npm%3A1.2.13#builtin&lt;compat/fsevents&gt;::version=1.2.13&amp;hash=87eb42 The platform linux is incompatible with this module, linking skipped. 20:31:50.230 | ➤ YN0001: │ Error: While loading /vercel/6b66e1f4/node_modules/cet-score: Manifest not found 20:31:50.230 | at Function.find (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:272112) 20:31:50.230 | at async j.cachedManifestLoad (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:154591) 20:31:50.230 | at async r.loadManifest (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:150434) 20:31:50.230 | at async baseFs (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:150323) 20:31:50.230 | at async j.finalizeInstallWithPnp (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:146882) 20:31:50.230 | at async j.finalizeInstall (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:223849) 20:31:50.230 | at async ie.linkEverything (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:321535) 20:31:50.230 | at async /vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:328208 20:31:50.230 | at async C.startTimerPromise (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:337598) 20:31:50.230 | at async ie.install (/vercel/6b66e1f4/.yarn/releases/yarn-berry.cjs:2:327992) 20:31:50.230 | ➤ YN0000: └ Completed in 1.27s 20:31:50.230 | ➤ YN0000: Failed with errors in 1.4m 20:31:50.302 | Error: Command &quot;yarn install&quot; exited with 1 ``` - An example of success deployment (https://vercel.com/kidonng/swiss/pqwx93xs0) This is the same commit as the above one, I just clicked &quot;Redeploy&quot; ``` 20:38:45.993 | Cloning github.com/kidonng/swiss (Branch: master, Commit: aa67475) 20:38:46.609 | Cloning completed in 616ms 20:38:46.611 | Analyzing source code... (Omitted) 20:39:08.451 | ➤ YN0013: │ yn@npm:3.1.1 can't be found in the cache and will be fetched from the remote registry 20:39:08.451 | ➤ YN0013: │ yorkie@npm:2.0.0 can't be found in the cache and will be fetched from the remote registry 20:40:09.438 | ➤ YN0000: └ Completed in 1.32m 20:40:09.601 | ➤ YN0000: ┌ Link step 20:40:09.678 | ➤ YN0062: │ fsevents@patch:fsevents@npm%3A2.1.3#builtin&lt;compat/fsevents&gt;::version=2.1.3&amp;hash=87eb42 The platform linux is incompatible with this module, linking skipped. 20:40:10.024 | ➤ YN0062: │ fsevents@patch:fsevents@npm%3A1.2.13#builtin&lt;compat/fsevents&gt;::version=1.2.13&amp;hash=87eb42 The platform linux is incompatible with this module, linking skipped. 20:40:15.608 | ➤ YN0007: │ protobufjs@npm:6.10.1 must be built because it never did before or the last one failed 20:40:15.608 | ➤ YN0007: │ yorkie@npm:2.0.0 must be built because it never did before or the last one failed 20:40:15.608 | ➤ YN0007: │ ejs@npm:2.7.4 must be built because it never did before or the last one failed 20:40:15.851 | ➤ YN0000: └ Completed in 6.25s 20:40:15.851 | ➤ YN0000: Done with warnings in 1.44m 20:40:16.123 | Using TypeScript 3.9.7 (local user-provided) ``` --- A few other things I'd like to mention about Yarn 2: - Yarn 2 outputs a massive amount of log in the Vercel dashboard unfortunately I didn't find an argument to silence the message. I wish the log to be hidden in the dashboard. **EDIT**: Vercel just rolled out a sane log limit: ![image](https://user-images.githubusercontent.com/44045911/94879030-a9c59780-0491-11eb-81f0-71e26b6acc09.png) So this issue is mostly resolved. - Is PnP support on your roadmap? Currently the Serverless Function build will fail if using PnP I know it could be hard but I can wait</DESCRIPTION>
  <REPONAME>vercel</REPONAME>
  <TIMEDIFFERENCEDAYS>190</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Publish Canary - @vercel/build-utils@2.6.1-canary.1 - vercel@21.0.2-canary.2 - @vercel/client@9.0.5-canary.1</MESSAGE>
    <SHA>503b9a242976c20c48d691c72de6017da65f387a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[build-utils][static-build][next] Force `YARN_NODE_LINKER=&quot;node-modules&quot;` env var when executing `yarn` (#5552) ### Related Issues * https://vercel.com/knowledge/does-vercel-support-yarn-2 * https://github.com/vercel/vercel/discussions/4223 * https://github.com/vercel/vercel/discussions/4910 * https://github.com/vercel/vercel/issues/5136 * https://github.com/vercel/vercel/issues/5280 ### Checklist &lt;!-- Please keep your PR as a Draft until the checklist is complete --&gt; #### Tests - [x] The code changed/added as part of this PR has been covered with tests - [x] All tests pass locally with `yarn test-unit` #### Code Review - [ ] This PR has a concise title and thorough description useful to a reviewer - [ ] Issue from task tracker has a link to this PR</MESSAGE>
      <SHA>85908a0524167ea1ddf09efd4f85bb6958c1d44b</SHA>
      <PATCHEDFILES>
        <FILE>packages/now-build-utils/src/fs/run-user-scripts.ts</FILE>
        <FILE>packages/now-build-utils/test/fixtures/19-yarn-v2/api/index.js</FILE>
        <FILE>packages/now-build-utils/test/fixtures/19-yarn-v2/now.json</FILE>
        <FILE>packages/now-build-utils/test/fixtures/19-yarn-v2/package.json</FILE>
        <FILE>packages/now-build-utils/test/fixtures/19-yarn-v2/vercel.json</FILE>
        <FILE>packages/now-build-utils/test/fixtures/19-yarn-v2/yarn.lock</FILE>
        <FILE>packages/now-next/src/index.ts</FILE>
        <FILE>packages/now-next/test/fixtures/32-custom-install-command/.yarn/releases/yarn-berry.cjs</FILE>
        <FILE>packages/now-next/test/fixtures/32-custom-install-command/.yarnrc.yml</FILE>
        <FILE>packages/now-next/test/fixtures/32-custom-install-command/yarn.lock</FILE>
        <FILE>packages/now-static-build/src/index.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
