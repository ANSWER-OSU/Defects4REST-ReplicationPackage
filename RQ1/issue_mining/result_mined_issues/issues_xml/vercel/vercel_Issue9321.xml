<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>9321</ISSUENO>
  <ISSUEURL>https://github.com/vercel/vercel/issues/9321</ISSUEURL>
  <TITLE>`vercel rm &lt;project&gt; --safe` is not working</TITLE>
  <DESCRIPTION>The `vercel rm &lt;project&gt; --safe` command is not working as intended in the latest version of the CLI (currently v28.13.1). ### Steps to reproduce: 1. Create a few deployments 2. Run the command `vercel rm &lt;project&gt; --safe` 3. Receive the incorrect error: ``` &gt; Could not find unaliased deployments or projects matching &quot;&lt;project&gt;&quot;. Run `vercel ls` to list. ``` ### Expected: The command should print all deployments except for the current production deployment and prompt you to delete. Example: ``` &gt; Found N deployments for removal in &lt;scope&gt; [723ms] &gt; The following N deployments will be permanently removed: dpl_&lt;id&gt; &lt;url&gt; 11h ago ... &gt; Are you sure? [y/N] ``` To confirm this expected behavior, I ran the command with a version of the CLI from several months ago (v28.4.8) and the command worked as expected. ### Additional Information Here is the debug output from each CLI version when running these commands: &lt;details&gt; &lt;summary&gt;Working (v28.4.8)&lt;/summary&gt; ``` &gt; [debug] [2023-01-26T05:30:45.414Z] user supplied known subcommand: &quot;rm&quot; &gt; [debug] [2023-01-26T05:30:45.434Z] #1 → GET https://api.vercel.com/v2/user &gt; [debug] [2023-01-26T05:30:45.590Z] #1 ← 200 OK: sfo1::mxm5k-1674711045582-e0f2f1d06c51 [156ms] &gt; [debug] [2023-01-26T05:30:45.592Z] Spinner invoked (Fetching deployment(s) &quot;&lt;project&gt;&quot; in &lt;user&gt;) with a 300ms delay &gt; [debug] [2023-01-26T05:30:45.596Z] #2 → GET https://api.vercel.com/v5/now/deployments/&lt;project&gt;? &gt; [debug] [2023-01-26T05:30:45.598Z] #3 → GET https://api.vercel.com/v8/projects/&lt;project&gt;? &gt; [debug] [2023-01-26T05:30:45.747Z] #2 ← 404 Not Found: sfo1::rt842-1674711045747-041940a27823 [151ms] &gt; [debug] [2023-01-26T05:30:45.765Z] #3 ← 200 OK: sfo1::pjfmt-1674711045743-da54e38ad74e [167ms] &gt; [debug] [2023-01-26T05:30:45.771Z] #4 → GET https://api.vercel.com/v4/now/deployments?projectId=prj_&lt;id&gt;&amp;limit=100 &gt; [debug] [2023-01-26T05:30:45.935Z] #4 ← 200 OK: sfo1::25qb8-1674711045913-b68a0f7843e5 [163ms] &gt; [debug] [2023-01-26T05:30:45.943Z] #5 → GET https://api.vercel.com/now/deployments/dpl_&lt;id&gt;/aliases? &gt; [debug] [2023-01-26T05:30:45.947Z] #6 → GET https://api.vercel.com/now/deployments/dpl_&lt;id&gt;/aliases? &gt; [debug] [2023-01-26T05:30:45.950Z] #7 → GET https://api.vercel.com/now/deployments/dpl_&lt;id&gt;/aliases? &gt; [debug] [2023-01-26T05:30:46.172Z] #5 ← 200 OK: sfo1::5rpvc-1674711046085-392d8e79c6a5 [229ms] &gt; [debug] [2023-01-26T05:30:46.180Z] #7 ← 200 OK: sfo1::n8tp4-1674711046096-1290a6aa6f33 [230ms] &gt; [debug] [2023-01-26T05:30:46.183Z] #6 ← 200 OK: sfo1::qncbd-1674711046096-e79353408dfa [236ms] ``` &lt;/details&gt; &lt;details&gt; &lt;summary&gt;Not working (v28.13.1 latest)&lt;/summary&gt; ``` &gt; [debug] [2023-01-26T05:30:20.722Z] user supplied known subcommand: &quot;rm&quot; &gt; [debug] [2023-01-26T05:30:20.744Z] #1 → GET https://api.vercel.com/v2/user &gt; [debug] [2023-01-26T05:30:21.032Z] #1 ← 200 OK: sfo1::8xsng-1674711021021-f4a5ccad3cbc [288ms] &gt; [debug] [2023-01-26T05:30:21.035Z] Spinner invoked (Fetching deployment(s) &quot;&lt;project&gt;&quot; in &lt;user&gt;) with a 300ms delay &gt; [debug] [2023-01-26T05:30:21.041Z] #2 → GET https://api.vercel.com/v13/deployments/&lt;project&gt; &gt; [debug] [2023-01-26T05:30:21.045Z] #3 → GET https://api.vercel.com/v8/projects/&lt;project&gt; &gt; [debug] [2023-01-26T05:30:21.214Z] #2 ← 404 Not Found: sfo1::pcrkt-1674711021205-b85db600fed1 [173ms] &gt; [debug] [2023-01-26T05:30:21.228Z] #3 ← 200 OK: sfo1::b54z9-1674711021205-8b4f8c3faed3 [183ms] &gt; [debug] [2023-01-26T05:30:21.235Z] #4 → GET https://api.vercel.com/v4/now/deployments?projectId=prj_&lt;id&gt;&amp;limit=100 &gt; [debug] [2023-01-26T05:30:21.423Z] #4 ← 200 OK: sfo1::b54z9-1674711021376-b4b5efb94e4c [187ms] &gt; [debug] [2023-01-26T05:30:21.431Z] #5 → GET https://api.vercel.com/v3/now/aliases?limit=20 &gt; [debug] [2023-01-26T05:30:21.435Z] #6 → GET https://api.vercel.com/v3/now/aliases?limit=20 &gt; [debug] [2023-01-26T05:30:21.437Z] #7 → GET https://api.vercel.com/v3/now/aliases?limit=20 &gt; [debug] [2023-01-26T05:30:21.642Z] #7 ← 200 OK: sfo1::dhsr6-1674711021588-a5ed20901dbd [205ms] &gt; [debug] [2023-01-26T05:30:21.661Z] #5 ← 200 OK: sfo1::h58kr-1674711021578-57a823bcb98c [230ms] &gt; [debug] [2023-01-26T05:30:21.668Z] #6 ← 200 OK: sfo1::kslfr-1674711021593-a41f58517c08 [233ms] ``` &lt;/details&gt;</DESCRIPTION>
  <REPONAME>vercel</REPONAME>
  <TIMEDIFFERENCEDAYS>27</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[cli] fix content type determination logic (#9498) The logic behind `getMimeType` only works for file names, not file paths. This PR fixes the logic to work regardless and adds a couple tests.</MESSAGE>
    <SHA>756174714f35ad205e06614f79e5010fc1d482be</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[cli] Fix 'vc remove --safe &lt;project&gt;' (#9477) `vc remove --safe &lt;project&gt;` has a unique code path that queries all deployments by project id. This function calls v4 deployments endpoint and returns the legacy deployment structure. The problem is the `vc remove` command relies on the new `Deployment` structure defined by the v13 get deployment endpoint. I've updated the `getDeploymentsByProjectId()` function to transform the legacy structure into the current one. Fixes #9321 Linear: https://linear.app/vercel/issue/VCCLI-538/vc-rm-project-safe-is-not-working</MESSAGE>
      <SHA>1f51e043877fdf232fea3d51b0e56d7219546754</SHA>
      <PATCHEDFILES>
        <FILE>packages/cli/src/commands/remove.ts</FILE>
        <FILE>packages/cli/src/util/deploy/get-deployments-by-project-id.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
