<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>7951</ISSUENO>
  <ISSUEURL>https://github.com/vercel/vercel/issues/7951</ISSUEURL>
  <TITLE>Cannot find module '@vercel/build-utils' or its corresponding type declarations.</TITLE>
  <DESCRIPTION>### System Info - yarn: `1.22.17` - pnpm: `7.1.6` - npm: `8.1.2` All three had the same issue. ### Dependencies - `&quot;@types/node&quot;: &quot;^17.0.42&quot;` - `&quot;@vercel/node&quot;: &quot;^2.1.0&quot;` - `&quot;typescript&quot;: &quot;^4.7.3&quot;` ### Error ``` node_modules/.pnpm/@vercel+node@2.1.0/node_modules/@vercel/node/dist/index.d.ts:1:29 - error TS2307: Cannot find module '@vercel/build-utils' or its corresponding type declarations. 1 import { shouldServe } from '@vercel/build-utils'; node_modules/.pnpm/@vercel+node@2.1.0/node_modules/@vercel/node/dist/index.d.ts:2:60 - error TS2307: Cannot find module '@vercel/build-utils' or its corresponding type declarations. 2 import type { BuildV3, PrepareCache, StartDevServer } from '@vercel/build-utils'; ``` ## Reproduction ```js import type { VercelRequest, VercelResponse } from '@vercel/node'; import type { Readable } from 'node:stream'; export const config = { api: { bodyParser: false, }, }; async function buffer(readable: Readable) { const chunks = []; for await (const chunk of readable) { chunks.push(typeof chunk === 'string' ? Buffer.from(chunk) : chunk); } return Buffer.concat(chunks); } export default async function (req: VercelRequest, res: VercelResponse) { if (req.method === 'POST') { const buf = await buffer(req); const rawBody = buf.toString('utf8'); res.json({ rawBody }); } else { res.setHeader('Allow', 'POST'); res.status(405).end('Method Not Allowed'); } } ```</DESCRIPTION>
  <REPONAME>vercel</REPONAME>
  <TIMEDIFFERENCEDAYS>19</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[cli] Add full stdio mockability for unit tests (#8052) This PR is a follow-up to #8039, which provides an intuitive syntax for writing unit tests for interactive CLI commands. The heart of this is the new `await expect(stream).toOutput(test)` custom Jest matcher, which is intended for use with the mock Client `stdout` and `stderr` stream properties. The `test` is a string that will wait for the stream to output via &quot;data&quot; events until a match is found, or it will timeout (after 3 seconds by default). The timeout error has nice Jest-style formatting so that you can easily identify what was output: &lt;img width=&quot;553&quot; alt=&quot;Screen Shot 2022-06-29 at 10 33 06 PM&quot; src=&quot;https://user-images.githubusercontent.com/71256/176600324-cb1ebecb-e891-42d9-bdc9-4864d3594a8c.png&quot;&gt; Below is an example of a unit test that was added for an interactive `vc login` session: ```typescript it('should allow login via email', async () =&gt; { const user = useUser(); const exitCodePromise = login(client); // Wait for login interactive prompt await expect(client.stderr).toOutput(`&gt; Log in to Vercel`); // Move down to &quot;Email&quot; option client.stdin.write('\x1B[B'); // Down arrow client.stdin.write('\x1B[B'); // Down arrow client.stdin.write('\x1B[B'); // Down arrow client.stdin.write('\r'); // Return key // Wait for email input prompt await expect(client.stderr).toOutput('&gt; Enter your email address:'); // Write user email address into prompt client.stdin.write(`${user.email}\n`); // Wait for login success message await expect(client.stderr).toOutput( `Success! Email authentication complete for ${user.email}` ); // Assert that the `login()` command returned 0 exit code await expect(exitCodePromise).resolves.toEqual(0); }); ``` **Note:** as a consequence of this PR, prompts are now written to stderr instead of stdout, so this change _may_ be considered a breaking change, in which case we should tag it for major release.</MESSAGE>
    <SHA>695bfbdd60a97030457ea1861c5bb89bcfe92353</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[build-utils][fs-detectors][cli] MAJOR: move some of `build-utils` into new `fs-detectors` (#8054) The `@vercel/build-utils` package was meant be shared functions necessary for writing a Vercel Builder (aka Runtime). This package has since bloated into the catch-all package for anything that wasn't a Builder. This PR removes the bloat in favor of a new package, `@vercel/fs-detectors`. It also removes the need for `@vercel/build-utils` to have a dependency on `@vercel/frameworks`. - Related to #7951</MESSAGE>
      <SHA>51fe09d5e96df72877e5daf21929aa7ec43cd382</SHA>
      <PATCHEDFILES>
        <FILE>packages/build-utils/package.json</FILE>
        <FILE>packages/build-utils/src/index.ts</FILE>
        <FILE>packages/build-utils/test/convert-runtime/invalid-functions/api/users.rb</FILE>
        <FILE>packages/build-utils/test/convert-runtime/invalid-functions/vercel.json</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/api/db/[id].py</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/api/index.py</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/api/project/[aid]/[bid]/index.py</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/api/users/get.py</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/api/users/post.py</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/file.txt</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/util/date.py</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/util/math.py</FILE>
        <FILE>packages/build-utils/test/convert-runtime/python-api/vercel.json</FILE>
        <FILE>packages/build-utils/test/integration.test.ts</FILE>
        <FILE>packages/build-utils/test/unit.test.ts</FILE>
        <FILE>packages/cli/package.json</FILE>
        <FILE>packages/cli/src/commands/build.ts</FILE>
        <FILE>packages/cli/src/util/dev/builder.ts</FILE>
        <FILE>packages/cli/src/util/dev/server.ts</FILE>
        <FILE>packages/client/package.json</FILE>
        <FILE>packages/client/src/types.ts</FILE>
        <FILE>packages/fs-detectors/.gitignore</FILE>
        <FILE>packages/fs-detectors/jest.config.js</FILE>
        <FILE>packages/fs-detectors/package.json</FILE>
        <FILE>packages/fs-detectors/src/detect-builders.ts</FILE>
        <FILE>packages/fs-detectors/src/detect-file-system-api.ts</FILE>
        <FILE>packages/fs-detectors/src/detect-framework.ts</FILE>
        <FILE>packages/fs-detectors/src/detectors/filesystem.ts</FILE>
        <FILE>packages/fs-detectors/src/get-project-paths.ts</FILE>
        <FILE>packages/fs-detectors/src/index.ts</FILE>
        <FILE>packages/fs-detectors/src/is-official-runtime.ts</FILE>
        <FILE>packages/fs-detectors/src/monorepos/monorepo-managers.ts</FILE>
        <FILE>packages/fs-detectors/src/workspaces/get-glob-fs.ts</FILE>
        <FILE>packages/fs-detectors/src/workspaces/get-workspace-package-paths.ts</FILE>
        <FILE>packages/fs-detectors/src/workspaces/get-workspaces.ts</FILE>
        <FILE>packages/fs-detectors/src/workspaces/workspace-managers.ts</FILE>
        <FILE>packages/fs-detectors/test/fixtures/01-zero-config-api/.gitignore</FILE>
        <FILE>packages/fs-detectors/test/fixtures/01-zero-config-api/api/[endpoint].js</FILE>
        <FILE>packages/fs-detectors/test/fixtures/01-zero-config-api/api/[endpoint]/[id].js</FILE>
        <FILE>packages/fs-detectors/test/fixtures/01-zero-config-api/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/02-zero-config-api/.gitignore</FILE>
        <FILE>packages/fs-detectors/test/fixtures/02-zero-config-api/api/date.js</FILE>
        <FILE>packages/fs-detectors/test/fixtures/02-zero-config-api/api/date/index.js</FILE>
        <FILE>packages/fs-detectors/test/fixtures/02-zero-config-api/api/index.js</FILE>
        <FILE>packages/fs-detectors/test/fixtures/02-zero-config-api/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/02-zero-config-api/yarn.lock</FILE>
        <FILE>packages/fs-detectors/test/fixtures/21-npm-workspaces/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/21-npm-workspaces/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/21-npm-workspaces/package-lock.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/21-npm-workspaces/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/22-pnpm/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/22-pnpm/pnpm-lock.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/22-pnpm/vercel.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/23-pnpm-workspaces/c/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/23-pnpm-workspaces/d/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/23-pnpm-workspaces/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/23-pnpm-workspaces/pnpm-lock.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/23-pnpm-workspaces/pnpm-workspace.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/24-pnpm-hoisted/.gitignore</FILE>
        <FILE>packages/fs-detectors/test/fixtures/24-pnpm-hoisted/.npmrc</FILE>
        <FILE>packages/fs-detectors/test/fixtures/24-pnpm-hoisted/a/index.js</FILE>
        <FILE>packages/fs-detectors/test/fixtures/24-pnpm-hoisted/b/index.js</FILE>
        <FILE>packages/fs-detectors/test/fixtures/24-pnpm-hoisted/index.js</FILE>
        <FILE>packages/fs-detectors/test/fixtures/24-pnpm-hoisted/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/24-pnpm-hoisted/pnpm-lock.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/24-pnpm-hoisted/vercel.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/25-multiple-lock-files-yarn/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/25-multiple-lock-files-yarn/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/25-multiple-lock-files-yarn/package-lock.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/25-multiple-lock-files-yarn/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/25-multiple-lock-files-yarn/pnpm-lock.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/25-multiple-lock-files-yarn/vercel.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/25-multiple-lock-files-yarn/yarn.lock</FILE>
        <FILE>packages/fs-detectors/test/fixtures/26-multiple-lock-files-pnpm/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/26-multiple-lock-files-pnpm/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/26-multiple-lock-files-pnpm/package-lock.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/26-multiple-lock-files-pnpm/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/26-multiple-lock-files-pnpm/pnpm-lock.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/26-multiple-lock-files-pnpm/pnpm-workspace.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/26-multiple-lock-files-pnpm/vercel.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/27-yarn-workspaces/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/27-yarn-workspaces/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/27-yarn-workspaces/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/27-yarn-workspaces/yarn.lock</FILE>
        <FILE>packages/fs-detectors/test/fixtures/28-pnpm-7/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/28-pnpm-7/pnpm-lock.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/28-pnpm-7/vercel.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/28-turborepo-with-yarn-workspaces/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/28-turborepo-with-yarn-workspaces/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/28-turborepo-with-yarn-workspaces/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/28-turborepo-with-yarn-workspaces/turbo.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/28-turborepo-with-yarn-workspaces/yarn.lock</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/backend/c/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/backend/d/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/backend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/backend/pnpm-lock.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/backend/pnpm-workspace.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/frontend/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/frontend/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/frontend/ignored/.gitkeep</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/frontend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/29-nested-workspaces/frontend/yarn.lock</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/backend/c/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/backend/d/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/backend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/backend/pnpm-lock.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/backend/pnpm-workspace.yaml</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/frontend/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/frontend/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/frontend/ignored/.gitkeep</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/frontend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/30-double-nested-workspaces/packages/frontend/yarn.lock</FILE>
        <FILE>packages/fs-detectors/test/fixtures/31-turborepo-in-package-json/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/31-turborepo-in-package-json/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/31-turborepo-in-package-json/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/31-turborepo-in-package-json/yarn.lock</FILE>
        <FILE>packages/fs-detectors/test/fixtures/32-monorepo-highly-nested/src/backend/app-three/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/32-monorepo-highly-nested/src/backend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/32-monorepo-highly-nested/src/frontend/app-one/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/32-monorepo-highly-nested/src/frontend/app-two/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/32-monorepo-highly-nested/src/frontend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/33-hybrid-monorepo/backend/app-three/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/33-hybrid-monorepo/backend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/33-hybrid-monorepo/frontend/a/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/33-hybrid-monorepo/frontend/b/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/33-hybrid-monorepo/frontend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/34-monorepo-no-workspaces/backend/app-three/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/34-monorepo-no-workspaces/backend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/34-monorepo-no-workspaces/frontend/app-one/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/34-monorepo-no-workspaces/frontend/app-two/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/34-monorepo-no-workspaces/frontend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/35-no-monorepo/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/36-monorepo-some-nested/frontend/app-one/app-three/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/36-monorepo-some-nested/frontend/app-two/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/36-monorepo-some-nested/frontend/package.json</FILE>
        <FILE>packages/fs-detectors/test/fixtures/37-project-depth-one-level/package.json</FILE>
        <FILE>packages/fs-detectors/test/integration.test.ts</FILE>
        <FILE>packages/fs-detectors/test/tsconfig.json</FILE>
        <FILE>packages/fs-detectors/test/unit.builds-and-routes-detector.test.ts</FILE>
        <FILE>packages/fs-detectors/test/unit.detect-file-system-api.test.ts</FILE>
        <FILE>packages/fs-detectors/test/unit.detect-monorepo-managers.test.ts</FILE>
        <FILE>packages/fs-detectors/test/unit.detect-workspace-managers.test.ts</FILE>
        <FILE>packages/fs-detectors/test/unit.framework-detector.test.ts</FILE>
        <FILE>packages/fs-detectors/test/unit.get-project-paths.test.ts</FILE>
        <FILE>packages/fs-detectors/test/unit.get-workspaces-package-paths.test.ts</FILE>
        <FILE>packages/fs-detectors/test/unit.get-workspaces.test.ts</FILE>
        <FILE>packages/fs-detectors/test/unit.is-official-runtime.test.ts</FILE>
        <FILE>packages/fs-detectors/test/utils/fixture-filesystem.ts</FILE>
        <FILE>packages/fs-detectors/tsconfig.json</FILE>
        <FILE>utils/run.js</FILE>
        <FILE>yarn.lock</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
