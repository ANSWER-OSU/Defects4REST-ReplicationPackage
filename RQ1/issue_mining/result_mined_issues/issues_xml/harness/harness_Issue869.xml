<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>869</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/869</ISSUEURL>
  <TITLE>Remove Socat for local access to service containers</TITLE>
  <DESCRIPTION>Ideally we could have a fallback when `socat` is not installed. My idea is to inject a perl script in the container when `socat` isn't available that is capable of proxying connections. Why choose Perl? It is the only scripting language included in the default Ubuntu and Debian containers. I found the an proxy Perl script here: https://github.com/pkrumins/perl-tcp-proxy/blob/master/tcp-proxy.pl I adjusted the below example to work with Redis: ``` perl #!/usr/bin/perl use warnings; use strict; use IO::Socket; use IO::Select; my $ioset = IO::Select-&gt;new; my %socket_map; my $debug = 1; sub new_conn { my ($host, $port) = @_; return IO::Socket::INET-&gt;new( PeerAddr =&gt; $host, PeerPort =&gt; $port ) || die &quot;Unable to connect to $host:$port: $!&quot;; } sub new_server { my ($host, $port) = @_; my $server = IO::Socket::INET-&gt;new( LocalAddr =&gt; $host, LocalPort =&gt; $port, ReuseAddr =&gt; 1, Listen =&gt; 100 ) || die &quot;Unable to listen on $host:$port: $!&quot;; } sub new_connection { my $server = shift; my $client = $server-&gt;accept; my $remote = new_conn($ENV{&quot;REDIS_PORT_6379_TCP_ADDR&quot;}, $ENV{REDIS_PORT_6379_TCP_PORT}); $ioset-&gt;add($client); $ioset-&gt;add($remote); $socket_map{$client} = $remote; $socket_map{$remote} = $client; } sub close_connection { my $client = shift; my $remote = $socket_map{$client}; $ioset-&gt;remove($client); $ioset-&gt;remove($remote); delete $socket_map{$client}; delete $socket_map{$remote}; $client-&gt;close; $remote-&gt;close; } my $server = new_server('0.0.0.0', $ENV{REDIS_PORT_6379_TCP_PORT}); $ioset-&gt;add($server); while (1) { for my $socket ($ioset-&gt;can_read) { if ($socket == $server) { new_connection($server); } else { next unless exists $socket_map{$socket}; my $remote = $socket_map{$socket}; my $buffer; my $read = $socket-&gt;sysread($buffer, 4096); if ($read) { $remote-&gt;syswrite($buffer); } else { close_connection($socket); } } } } ``` So how would this work? We would embed the perl script in our `build.sh` file and write that file from inside the container. It could look something like this: ``` echo IyEvdXNyL2Jpbi9wZXJsCnByaW50ICJoZWxsbyB3b3JsZCIKCg== | base64 -d &gt; /tmp/drone-proxy ``` We could then invoke with `/tmp/drone-proxy $IP $PORT` as an alternative to `socat`. It may seem a bit strange to embed the file in the `build.sh` script, but this is because when #749 is implemented we won't be able to inject files into the container any other way.</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>43</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #862 from ilbambino/master Possibility to retag docker images</MESSAGE>
    <SHA>bd606c43e082ee709527cdec4847d1019a6d5580</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #870 from bradrydzewski/master embedded socat polyfill for #869</MESSAGE>
      <SHA>ba5db98d446957470f22cdeeb2c29bc99ab9bd35</SHA>
      <PATCHEDFILES>
        <FILE>.drone.yml</FILE>
        <FILE>Makefile</FILE>
        <FILE>shared/build/proxy/proxy.go</FILE>
        <FILE>shared/build/proxy/proxy_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Use 'which' (if present) to check socat anywhere in path #869.</MESSAGE>
      <SHA>32ef4cefd1059e776e4cbc8657172233214ea872</SHA>
      <PATCHEDFILES>
        <FILE>shared/build/proxy/proxy.go</FILE>
        <FILE>shared/build/proxy/proxy_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Use command -v to check socat anywhere in path #869.</MESSAGE>
      <SHA>0e3b499996e548b5f2859476b10d614ffd461457</SHA>
      <PATCHEDFILES>
        <FILE>shared/build/proxy/proxy.go</FILE>
        <FILE>shared/build/proxy/proxy_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #932 from jvortmann/check_presence_socat_anywhere_in_path_using_command_v Use 'comand -v' to check presence of socat anywhere in path #869.</MESSAGE>
      <SHA>aa3eeda9b8134f233d591dbb2ade880be24dddc2</SHA>
      <PATCHEDFILES>
        <FILE>shared/build/proxy/proxy.go</FILE>
        <FILE>shared/build/proxy/proxy_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
