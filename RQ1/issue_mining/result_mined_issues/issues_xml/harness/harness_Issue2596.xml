<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2596</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/2596</ISSUEURL>
  <TITLE>Streams leaking resources</TITLE>
  <DESCRIPTION>I'm raising this issue and a PR (#2597) to address memory and goroutine leaks in drone server. ### The Problem I've noticed that, when using Streams, Drone was leaking go routines and heap space. I was able to reproduce it by doing the following: - Opening a new tab and access Drone - Refreshing the page multiple times (or opening multiple tabs) - Analysing the resource usage by accessing `/api/debug/pprof/`, `go tool pprof`, debug logs and chrome developer tools. The logs showed multiple connections being opened but never closed, just by refreshing the page ![connections](https://user-images.githubusercontent.com/4629568/52945024-b357c580-3368-11e9-927a-59cee9da76c9.png) Memory tracking showed that the heap never got garbage collected ![memory_pre](https://user-images.githubusercontent.com/4629568/52945400-8a840000-3369-11e9-8799-de6250d22385.png) Go routines would never terminate &lt;img width=&quot;2400&quot; alt=&quot;goroutines&quot; src=&quot;https://user-images.githubusercontent.com/4629568/52945604-01b99400-336a-11e9-8c57-5dda43b8f08b.png&quot;&gt; Go routines and heap usage confirmation in pprof endpoint ![pprof](https://user-images.githubusercontent.com/4629568/52945440-a4254780-3369-11e9-86a9-e71e83ee94f9.png) Idle streams not getting closed: &lt;img width=&quot;530&quot; alt=&quot;stream duration&quot; src=&quot;https://user-images.githubusercontent.com/4629568/52945765-64ab2b00-336a-11e9-806d-1836eea62822.png&quot;&gt; ### Analysis When profiling I found the two main issues to be: **Timers memory leak** &lt;img width=&quot;288&quot; alt=&quot;timer_leak&quot; src=&quot;https://user-images.githubusercontent.com/4629568/52947069-9c67a200-336d-11e9-9dd9-cab454744523.png&quot;&gt; The 60 minute timer to close the stream was not actually working. This was due to the fact that a new timer was being created for every iteration of the for loop, which happened every 30 seconds when the ping timeout ran, which meant that new 60 minute timers were created every 60 seconds. This would also prevent the old timers from being garbage collected as Go won't consider them unused until they're triggered. I solved that issue by creating the timers outside of the for loop and properly reseting them only when data was flowing through the stream. **Stream not being closed** &lt;img width=&quot;435&quot; alt=&quot;repolist&quot; src=&quot;https://user-images.githubusercontent.com/4629568/52947459-accc4c80-336e-11e9-97f0-c2f1c15ff2e9.png&quot;&gt; Using drone with a large number of repositories (&gt; 1000) means that the database call to retrieve the repos can generate a map of over 1MB in size. This is done for every stream (this means every tab, every page refresh, etc) and this is not cached and only cleaned up once the stream closes. Since the stream was not closing, the memory usage gets very high very quickly. The fix for this is to ensure the 1 hour idle timeout actually works and all this data can eventually be garbage collected. I also added some handlers to close the stream based on the gin context. ### The Fix Memory being freed and reused after the 1 hour idle timeout ![post memory](https://user-images.githubusercontent.com/4629568/52945996-edc26200-336a-11e9-834d-51283db166af.png) Connections being properly closed by the server and reopened by the browser after the default 3 seconds ![post_conn](https://user-images.githubusercontent.com/4629568/52948188-b5be1d80-3370-11e9-9029-62e56cf3c20d.png) Testing the timers, both the ping and the idle timer work &lt;img width=&quot;335&quot; alt=&quot;timers&quot; src=&quot;https://user-images.githubusercontent.com/4629568/52946695-8c9b8e00-336c-11e9-8c05-63cd736fed65.png&quot;&gt;</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: [CDE-267]: Add custom hook useOpenVSCodeBrowserURL (#2595) * feat: [CDE-267]: Add custom hook useOpenVSCodeBrowserURL</MESSAGE>
    <SHA>d370295e7c38ae64fedad7fca6e25baec20b5fa5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix label value define permissions (#2596) * Simplify if test and keep check- prefix * Fix label value define permissions</MESSAGE>
      <SHA>0346a91cdaec730f073f3d8038f17ba7289fc72f</SHA>
      <PATCHEDFILES>
        <FILE>app/api/controller/repo/label_value_define.go</FILE>
        <FILE>app/api/controller/space/label_value_define.go</FILE>
        <FILE>app/services/label/label.go</FILE>
        <FILE>app/services/label/label_pullreq.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
