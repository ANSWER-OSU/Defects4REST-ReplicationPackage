<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2190</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/2190</ISSUEURL>
  <TITLE>Matrix builds are stuck even though the agent finished</TITLE>
  <DESCRIPTION>This is using Drone 0.8. I have an agent running on a different machine than the server. I have matrix builds that complete (according to the agent), the logs are visible in the UI, but the &quot;parent&quot; job keeps &quot;spinning&quot;. This causes all subsequent builds to be queued forever. Also, Github status is not set (this is consistent with the build being marked &quot;in progress&quot;). The only suspicious thing I see in the server log is a bunch of RPC errors: ``` INFO: 2017/09/05 14:36:26 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 14:37:50 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 14:38:26 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 14:47:43 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 14:53:11 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 15:00:28 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 15:00:39 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 15:00:53 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 15:02:27 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 15:04:27 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 15:06:27 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; INFO: 2017/09/05 15:09:40 grpc: Server.processUnaryRPC failed to write status stream error: code = DeadlineExceeded desc = &quot;context deadline exceeded&quot; ``` The agent logs look good, I have a bunch of innocent looking lines like this: ``` 2017/09/05 13:16:25 pipeline: finish uploading logs: application/json+logs: step 222: build 2017/09/05 13:16:25 pipeline: finish uploading logs: 222: step build 2017/09/05 13:16:27 pipeline: execution complete: 222 2017/09/05 13:16:27 pipeline: logging complete: 222 2017/09/05 13:16:27 pipeline: cancel channel closed: 222 2017/09/05 13:16:27 pipeline: done: 222 2017/09/05 13:16:27 pipeline: request next execution 2017/09/05 13:16:27 pipeline: cancel ping loop: 222 2017/09/05 13:16:27 pipeline: received next execution: 213 2017/09/05 13:16:29 pipeline: finish uploading logs: application/json+logs: step 213: clone 2017/09/05 13:16:29 pipeline: finish uploading logs: 213: step clone 2017/09/05 13:17:27 pipeline: ping queue: 213 2017/09/05 13:17:34 pipeline: execution complete: 213 2017/09/05 13:17:35 pipeline: finish uploading logs: application/json+logs: step 213: build 2017/09/05 13:17:35 pipeline: finish uploading logs: 213: step build 2017/09/05 13:17:35 pipeline: logging complete: 213 2017/09/05 13:17:35 pipeline: done: 213 2017/09/05 13:17:35 pipeline: request next execution 2017/09/05 13:17:35 pipeline: cancel ping loop: 213 ``` I'm configuring the agent like this (I had the script lying around since 0.4 so I just reused it instead of going to docker-compose, especially since the server and agent are on different machines): ``` # run Drone agent docker run \ --env DOCKER_API_VERSION=1.24 \ --env DRONE_SERVER=drone.iulidragos.com:9000 \ --env DRONE_SECRET=... \ --env DRONE_MAX_PROCS=4 \ --volume /var/run/docker.sock:/var/run/docker.sock \ --restart=always \ --detach=true \ --name=drone-agent \ drone/agent:0.8 ``` Not sure if the Docker API version has anything to do with this (the agent logs don't show any error though). At this point all builds are stuck, so I'm considering reverting to 0.7, but there I had similar issues but less consistent.</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: [CDE-127]: read multi-table and multi query data in a single SQL txn (#2193) * feat: [CDE-127]: starting and stopping states. * feat: [CDE-127]: read multi-table and multi query data in a single SQL txn</MESSAGE>
    <SHA>6e525fca4a5e1b02626bfe014c60c5ce4f4e7c2d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: [code-2088]: fix bugs on pr panel (#2190) * fix: [code-2088]: fix bugs on pr panel</MESSAGE>
      <SHA>6864710e8e0674ba15fd58cfff2c1b9bcd013498</SHA>
      <PATCHEDFILES>
        <FILE>web/src/components/Changes/Changes.tsx</FILE>
        <FILE>web/src/images/index.ts</FILE>
        <FILE>web/src/images/prEmptyChanges.png</FILE>
        <FILE>web/src/pages/PullRequest/Conversation/PullRequestActionsBox/PullRequestActionsBox.tsx</FILE>
        <FILE>web/src/pages/PullRequest/Conversation/PullRequestOverviewPanel/sections/ChangesSection.tsx</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
