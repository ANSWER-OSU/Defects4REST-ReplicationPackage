<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>308</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/308</ISSUEURL>
  <TITLE>Docker container start failure not detected correctly</TITLE>
  <DESCRIPTION>While the issue described in this [mailing list thread](https://groups.google.com/d/msg/drone-dev/teea2XSrK2M/mDZcfuwCU5YJ) was a docker-problem and not a drone-problem, drone still fails to detect the docker failures correctly and marks builds as ok although docker wasn't even able to fire up the containers where the build should run. Steps to reproduce: - Set up a drone project that uses a database service: ``` yaml image: node0.10 script: - npm install - npm test services: - bradrydzewski/postgres:9.3 ``` - Start docker. - Check iptables: ``` iptables -L -n -t nat --line-numbers Chain PREROUTING (policy ACCEPT) num target prot opt source destination 1 DOCKER all -- 0.0.0.0/0 0.0.0.0/0 ADDRTYPE match dst-type LOCAL Chain INPUT (policy ACCEPT) num target prot opt source destination Chain OUTPUT (policy ACCEPT) num target prot opt source destination 1 DOCKER all -- 0.0.0.0/0 !127.0.0.0/8 ADDRTYPE match dst-type LOCAL Chain POSTROUTING (policy ACCEPT) num target prot opt source destination 1 MASQUERADE all -- 172.17.0.0/16 !172.17.0.0/16 Chain DOCKER (2 references) num target prot opt source destination ``` - Run a build, it should pass. - Remove the firewall rules (be careful, rulenumbers should match the linenumbers from the output above): ``` iptables -t nat -D PREROUTING 1 iptables -t nat -D OUTPUT 1 iptables -t nat -D POSTROUTING 1 iptables -t nat -X DOCKER iptables -L -n -t nat --line-numbers Chain PREROUTING (policy ACCEPT) num target prot opt source destination Chain INPUT (policy ACCEPT) num target prot opt source destination Chain OUTPUT (policy ACCEPT) num target prot opt source destination Chain POSTROUTING (policy ACCEPT) num target prot opt source destination ``` - Re-run the build, it will be marked as OK but the build script will actually never be run. - Check `/var/log/upstart/drone.log` (it looks like for a successful build): ``` ... Step 16 : ENTRYPOINT /bin/bash -e /usr/local/bin/drone ---&gt; Running in 1fa8c2cc6cc2 ---&gt; 2c49102ab872 Removing intermediate container 1fa8c2cc6cc2 Successfully built 2c49102ab872 copying repository to /var/cache/drone/src/github.com/***/*** starting build temp directory is /tmp/drone mounting volume /tmp/drone/github.com/***/***/test-drone/tmp/npm:/tmp/npm removing build container removing service container bradrydzewski/postgres:9.3 removing build image ``` - Check `/var/log/upstart/docker.log`: ``` 2014/05/11 12:27:43 GET /v1.9/images/bradrydzewski/postgres:9.3/json [c800b788] +job inspect(bradrydzewski/postgres:9.3, image) [c800b788] -job inspect(bradrydzewski/postgres:9.3, image) = OK (0) 2014/05/11 12:27:43 POST /v1.9/containers/create [c800b788] +job create() [c800b788] -job create() = OK (0) 2014/05/11 12:27:43 POST /v1.9/containers/3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d/start [c800b788] +job start(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) [c800b788] +job allocate_interface(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) [c800b788] -job allocate_interface(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) = OK (0) [c800b788] +job allocate_port(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) iptables failed: iptables -t nat -A DOCKER -p tcp -d 127.0.0.1 --dport 49155 ! -i docker0 -j DNAT --to-destination 172.17.0.2:5432: iptables: No chain/target/match by that name. (exit status 1) [c800b788] -job allocate_port(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) = ERR (1) [c800b788] +job release_interface(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) [c800b788] -job release_interface(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) = OK (0) [c800b788] +job release_interface(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) [c800b788] -job release_interface(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) = OK (0) Cannot start container 3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d: (exit status 1) [c800b788] -job start(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) = ERR (1) [error] server.go:1011 Error: Cannot start container 3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d: (exit status 1) [error] server.go:90 HTTP Error: statusCode=500 Cannot start container 3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d: (exit status 1) 2014/05/11 12:27:43 GET /v1.9/containers/3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d/json [c800b788] +job inspect(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d, container) [c800b788] -job inspect(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d, container) = OK (0) 2014/05/11 12:27:43 GET /v1.9/images/bradrydzewski/node:0.10/json [c800b788] +job inspect(bradrydzewski/node:0.10, image) [c800b788] -job inspect(bradrydzewski/node:0.10, image) = OK (0) 2014/05/11 12:27:43 POST /v1.9/build?q=1&amp;rm=1&amp;t=drone-086b240e9b [c800b788] +job build() [c800b788] +job allocate_interface(736e7cd2b209e969a457f2ced54be44745412b08a20c54a6988567279abee841) [c800b788] -job allocate_interface(736e7cd2b209e969a457f2ced54be44745412b08a20c54a6988567279abee841) = OK (0) [c800b788] +job release_interface(736e7cd2b209e969a457f2ced54be44745412b08a20c54a6988567279abee841) [c800b788] -job release_interface(736e7cd2b209e969a457f2ced54be44745412b08a20c54a6988567279abee841) = OK (0) [c800b788] +job allocate_interface(88d3525561c3e43ce75e2c3274924a3f70ab8824efcee90f0e15b07a4fa0def3) [c800b788] -job allocate_interface(88d3525561c3e43ce75e2c3274924a3f70ab8824efcee90f0e15b07a4fa0def3) = OK (0) [c800b788] +job release_interface(88d3525561c3e43ce75e2c3274924a3f70ab8824efcee90f0e15b07a4fa0def3) [c800b788] -job release_interface(88d3525561c3e43ce75e2c3274924a3f70ab8824efcee90f0e15b07a4fa0def3) = OK (0) [c800b788] +job allocate_interface(1ef4af6b89c5e14a450194ab91a8470ca83075e60b7fe96ef786bfa50c79903c) [c800b788] -job allocate_interface(1ef4af6b89c5e14a450194ab91a8470ca83075e60b7fe96ef786bfa50c79903c) = OK (0) [c800b788] +job release_interface(1ef4af6b89c5e14a450194ab91a8470ca83075e60b7fe96ef786bfa50c79903c) [c800b788] -job release_interface(1ef4af6b89c5e14a450194ab91a8470ca83075e60b7fe96ef786bfa50c79903c) = OK (0) [c800b788] +job allocate_interface(3543a0ae8d2d31af147b7f5379247a59a0a251beb284324b85a8862d029ca671) [c800b788] -job allocate_interface(3543a0ae8d2d31af147b7f5379247a59a0a251beb284324b85a8862d029ca671) = OK (0) [c800b788] +job release_interface(3543a0ae8d2d31af147b7f5379247a59a0a251beb284324b85a8862d029ca671) [c800b788] -job release_interface(3543a0ae8d2d31af147b7f5379247a59a0a251beb284324b85a8862d029ca671) = OK (0) [c800b788] -job build() = OK (0) 2014/05/11 12:27:48 GET /v1.9/images/drone-086b240e9b/json [c800b788] +job inspect(drone-086b240e9b, image) [c800b788] -job inspect(drone-086b240e9b, image) = OK (0) 2014/05/11 12:27:48 POST /v1.9/containers/create [c800b788] +job create() [c800b788] -job create() = OK (0) 2014/05/11 12:27:48 POST /v1.9/containers/78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e/start [c800b788] +job start(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) 2014/05/11 12:27:48 POST /v1.9/containers/78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e/attach?&amp;stream=1&amp;stdout=1&amp;stderr=1 [c800b788] +job inspect(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e, container) [c800b788] -job inspect(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e, container) = OK (0) [c800b788] +job attach(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) [c800b788] +job allocate_interface(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) [c800b788] -job allocate_interface(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) = OK (0) [c800b788] +job release_interface(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) [c800b788] -job release_interface(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) = OK (0) [c800b788] -job attach(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) = OK (0) Cannot start container 78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e: Cannot link to a non running container: /loving_feynman AS /loving_colden/postgres [c800b788] -job start(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) = ERR (1) [error] server.go:1011 Error: Cannot start container 78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e: Cannot link to a non running container: /loving_feynman AS /loving_colden/postgres [error] server.go:90 HTTP Error: statusCode=500 Cannot start container 78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e: Cannot link to a non running container: /loving_feynman AS /loving_colden/postgres 2014/05/11 12:27:48 POST /v1.9/containers/78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e/wait [c800b788] +job wait(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) [c800b788] -job wait(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) = OK (0) 2014/05/11 12:27:48 POST /v1.9/containers/78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e/stop?t=15 [c800b788] +job stop(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) [c800b788] -job stop(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) = OK (0) 2014/05/11 12:27:48 DELETE /v1.9/containers/78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e [c800b788] +job container_delete(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) [c800b788] -job container_delete(78c3db403c1cbd67673662879ba793fb43242dbb493380468a15c8324e1eea0e) = OK (0) 2014/05/11 12:27:48 POST /v1.9/containers/3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d/stop?t=15 [c800b788] +job stop(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) [c800b788] -job stop(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) = OK (0) 2014/05/11 12:27:48 DELETE /v1.9/containers/3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d [c800b788] +job container_delete(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) [c800b788] -job container_delete(3d0eee92e2088c91ec5eec6d236d9343b7907ffea7db39043ef13bd1f5e77f0d) = OK (0) 2014/05/11 12:27:49 DELETE /v1.9/images/0847b81088b1e7fb6ab87f96f0547674cecc9d7913f935218a44dab141f7f863 [c800b788] +job image_delete(0847b81088b1e7fb6ab87f96f0547674cecc9d7913f935218a44dab141f7f863) [c800b788] -job image_delete(0847b81088b1e7fb6ab87f96f0547674cecc9d7913f935218a44dab141f7f863) = OK (0) ``` Docker clearly shows that errors creating the containers but somehow drone doesn't seem to notice.</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'fix_build' of _OKE5H2PQKOUfzFFDuD4FA/default/CODE/gitness (#306)</MESSAGE>
    <SHA>b7b89ba5f20874b2af492917120ac269073de85c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: [code-738]: fix commit link in sidebar (#308)</MESSAGE>
      <SHA>adbb106d8d075bcfba1c141eefbdc0a4a03446d4</SHA>
      <PATCHEDFILES>
        <FILE>web/src/layouts/menu/DefaultMenu.tsx</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
