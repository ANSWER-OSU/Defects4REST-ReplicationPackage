<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1775</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/1775</ISSUEURL>
  <TITLE>expose errors in oauth2 authorization code grant</TITLE>
  <DESCRIPTION>Right now when the oauth2 provider (ie Bitbucket) fails to grant an authorization code an `error` query parameter is returned, as defined in the oauth2 specification: https://tools.ietf.org/html/rfc6749#section-4.1.2.1 Drone currently looks for the `code` and re-directs, without checking for the `error` query parameter. In error scenarios (misconfiguration for example) this can result in redirect loops, and by not catching and exposing the error it can be difficult to debug. We should therefore start catching and returning the error. This is the block of code: https://github.com/drone/drone/blob/master/remote/bitbucket/bitbucket.go#L46:L50 Which could be adjusted to something like this: ``` diff package bitbucket import ( + &quot;errors&quot; &quot;fmt&quot; &quot;net/http&quot; &quot;net/url&quot; ``` ``` diff code := r.FormValue(&quot;code&quot;) + if err := r.FormValue(&quot;error&quot;); err != &quot;&quot; { + return nil, errors.New(err) + } if len(code) == 0 { http.Redirect(w, r, config.AuthCodeURL(&quot;drone&quot;), http.StatusSeeOther) return nil, nil } ``` Note that this should be adjusted in both the GitHub and Bitbucket implementations.</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>144</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #1885 from bradrydzewski/master added backoff to fetch yaml file</MESSAGE>
    <SHA>b83a719e37c6f1c1f3f728f5250189d5aa4699af</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Expose OAuth2 errors, avoid redirect loop. Closes #1775.</MESSAGE>
      <SHA>e259c64bac16d9b47b3a9bd8842d4a9b2e15cf49</SHA>
      <PATCHEDFILES>
        <FILE>remote/bitbucket/bitbucket.go</FILE>
        <FILE>remote/bitbucket/bitbucket_test.go</FILE>
        <FILE>remote/bitbucket/fixtures/handler.go</FILE>
        <FILE>remote/github/github.go</FILE>
        <FILE>remote/github/github_test.go</FILE>
        <FILE>remote/gitlab/gitlab.go</FILE>
        <FILE>shared/oauth2/oauth2.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
