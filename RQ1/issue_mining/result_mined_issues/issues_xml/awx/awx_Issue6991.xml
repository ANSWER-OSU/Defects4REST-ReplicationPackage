<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6991</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/6991</ISSUEURL>
  <TITLE>Host summary generation for large inventories is too slow</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY Generate an inventory with 5000 hosts, and run a playbook. Observe that the `playbook_on_stats` event takes a **very** long time (depending on total hosts, and how your inventory is structured, several minutes+) to show up. This code is super duper crazy slow (mostly because it generates *lots* of insert and update queries for large inventories): https://github.com/ansible/awx/blob/devel/awx/main/models/events.py#L482 ```python @pytest.mark.django_db def test_host_summary_generation(): hostnames = [f'Host {i}' for i in range(5000)] inv = Inventory() inv.save() for h in hostnames: Host(name=h, inventory_id=inv.id).save() j = Job(inventory=inv) j.save() JobEvent.create_from_data( job_id=j.pk, parent_uuid='abc123', event='playbook_on_stats', event_data={'ok': dict((hostname, 5) for hostname in hostnames)} ).save() je = JobEvent.objects.first() je._update_host_summary_from_stats(hostnames) assert j.job_host_summaries.count() == len(hostnames) assert sorted([s.host_name for s in j.job_host_summaries.all()]) == sorted(hostnames) ```</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>56</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #6940 from jlmitch5/makeIdSearchANumber make job id search use number field Reviewed-by: https://github.com/apps/softwarefactory-project-zuul</MESSAGE>
    <SHA>9fd396cbe01f73d1274f18be6ee1534cb232399a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>drastically optimize job host summary creation see: https://github.com/ansible/awx/issues/6991</MESSAGE>
      <SHA>a9468caf0529398131149e6d02afd2075f08f80b</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/models/events.py</FILE>
        <FILE>awx/main/tasks.py</FILE>
        <FILE>awx/main/tests/functional/models/test_events.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>drastically optimize job host summary creation see: https://github.com/ansible/awx/issues/6991</MESSAGE>
      <SHA>6703223a44c223011ea08132c9e0631a947da47c</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/models/events.py</FILE>
        <FILE>awx/main/tasks.py</FILE>
        <FILE>awx/main/tests/functional/models/test_events.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>drastically optimize job host summary creation see: https://github.com/ansible/awx/issues/6991</MESSAGE>
      <SHA>e7347d15c1fcba482012580a22f1052694e3a361</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/models/events.py</FILE>
        <FILE>awx/main/tasks.py</FILE>
        <FILE>awx/main/tests/functional/models/test_events.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
