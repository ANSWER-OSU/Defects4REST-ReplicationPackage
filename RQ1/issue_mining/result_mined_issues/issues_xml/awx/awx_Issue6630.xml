<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6630</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/6630</ISSUEURL>
  <TITLE>refresh token does not expire</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY Using password grant type, refresh token does not expire according to `REFRESH_TOKEN_EXPIRE_SECONDS`. ##### ENVIRONMENT * AWX version: 10.0.0 * AWX install method: docker on linux * Operating System: CentOS v8 * Web Browser: Chrome ##### STEPS TO REPRODUCE Set the expiry times low from AWX GUI &gt; Settings &gt; System Confirm the settings from api ``` https://x.x.x.x/api/v2/settings/all/ ``` ``` &quot;OAUTH2_PROVIDER&quot;: { &quot;ACCESS_TOKEN_EXPIRE_SECONDS&quot;: 10, &quot;REFRESH_TOKEN_EXPIRE_SECONDS&quot;: 10, &quot;AUTHORIZATION_CODE_EXPIRE_SECONDS&quot;: 600 }, ``` Create an Application from the GUI of Authorization Grant Type `Resource owner password-based`. Save a copy of the `clientId` and `clientSecret`. Create the access and refresh tokens using password grant: ```bash curl -v -k -X POST -d \ &quot;grant_type=password&amp;username=someuser&amp;password=somepassword&amp;scope=read&quot; \ -u &quot;clientId:clientSecret&quot; https://x.x.x.x/api/o/token/ -i ``` Which returns ```json {&quot;access_token&quot;: &quot;Ma5cLFKYs1Q8iknITJjAe0VXJyiUVP&quot;, &quot;expires_in&quot;: 10, &quot;token_type&quot;: &quot;Bearer&quot;, &quot;scope&quot;: &quot;read&quot;, &quot;refresh_token&quot;: &quot;IymTfQp0JtT3HtDUitoAj7eaxXr3zM&quot;} ``` Wait at least 20 seconds and try use refresh token ``` curl -k -X POST -d \ &quot;grant_type=refresh_token&amp;refresh_token=IymTfQp0JtT3HtDUitoAj7eaxXr3zM&quot; \ -u &quot;clientId:clientSecret&quot; https://x.x.x.x/api/o/token/ -i ``` That previous refresh token continues to generate new `access_token` and new `refresh_token` after 20 seconds. Even after I waited 12 hours it still worked. I also tried manually adding the settings to `/etc/tower/settings.py` of the docker container. ``` OAUTH2_PROVIDER = {'ACCESS_TOKEN_EXPIRE_SECONDS': 10, 'REFRESH_TOKEN_EXPIRE_SECONDS': 10, 'AUTHORIZATION_CODE_EXPIRE_SECONDS': 600} ``` and restarting the container. ##### EXPECTED RESULTS The refresh token should have failed to generate a new access token and returned an error message after more than 10 + 10 seconds. ##### ACTUAL RESULTS The last refresh token still generates a new `access_token` and new `refresh_token` after 20 seconds. I waited 12 hours and the last generated refresh token still works. So it appears to ignore the refresh token expiry time. #### ADDITIONAL INFO Should the refresh token stay the same each time it is used? Current behavior is that a new refresh token is generated each time it is used. The previous one no longer works. So the way it works currently, refresh tokens are one-time use only.</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>make the `awx login` command print refresh tokens (where applicable)</MESSAGE>
    <SHA>3b0146e724f73eb598820fe3132f7040f88138ce</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>properly respect REFRESH_TOKEN_EXPIRE_SECONDS when generating new tokens see: https://github.com/ansible/awx/issues/6630 see: https://github.com/jazzband/django-oauth-toolkit/issues/746</MESSAGE>
      <SHA>0cb8685019751f11cb57ee39bf5f854c3c069641</SHA>
      <PATCHEDFILES>
        <FILE>awx/api/urls/oauth2_root.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>properly respect REFRESH_TOKEN_EXPIRE_SECONDS when generating new tokens see: https://github.com/ansible/awx/issues/6630 see: https://github.com/jazzband/django-oauth-toolkit/issues/746</MESSAGE>
      <SHA>43ea541506bb334d6978f79a09e74f088e954b33</SHA>
      <PATCHEDFILES>
        <FILE>awx/api/urls/oauth2_root.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>properly respect REFRESH_TOKEN_EXPIRE_SECONDS when generating new tokens see: https://github.com/ansible/awx/issues/6630 see: https://github.com/jazzband/django-oauth-toolkit/issues/746</MESSAGE>
      <SHA>5ec5c1b5a439781416dcbdaaa00ec62b751af043</SHA>
      <PATCHEDFILES>
        <FILE>awx/api/urls/oauth2_root.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>properly respect REFRESH_TOKEN_EXPIRE_SECONDS when generating new tokens see: https://github.com/ansible/awx/issues/6630 see: https://github.com/jazzband/django-oauth-toolkit/issues/746</MESSAGE>
      <SHA>fbc60a56d78d145f8a2ab90294edb14f0c0ea0a5</SHA>
      <PATCHEDFILES>
        <FILE>awx/api/urls/oauth2_root.py</FILE>
        <FILE>awx/main/tests/functional/api/test_oauth.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>properly respect REFRESH_TOKEN_EXPIRE_SECONDS when generating new tokens see: https://github.com/ansible/awx/issues/6630 see: https://github.com/jazzband/django-oauth-toolkit/issues/746</MESSAGE>
      <SHA>03d9153d73919462eb4fe6a64226181dac53f26f</SHA>
      <PATCHEDFILES>
        <FILE>awx/api/urls/oauth2_root.py</FILE>
        <FILE>awx/main/tests/functional/api/test_oauth.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>properly respect REFRESH_TOKEN_EXPIRE_SECONDS when generating new tokens see: https://github.com/ansible/awx/issues/6630 see: https://github.com/jazzband/django-oauth-toolkit/issues/746</MESSAGE>
      <SHA>0bf1116ef8ccf1cc96af5e073d7527ac47dd1f1a</SHA>
      <PATCHEDFILES>
        <FILE>awx/api/urls/oauth2_root.py</FILE>
        <FILE>awx/main/tests/functional/api/test_oauth.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
