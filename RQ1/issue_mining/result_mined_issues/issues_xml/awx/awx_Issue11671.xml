<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>11671</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/11671</ISSUEURL>
  <TITLE>[Tech debt] Task manager fetches resources (instances, jobs, etc.) twice</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Feature Idea ##### SUMMARY Running the task manager, it repeats itself doing the same thing twice. Documenting partial call stack here. Both start with the main call path to the task manager: https://github.com/ansible/awx/blob/bff49f2a5fd8929808b2890bc2d16279c523cc53/awx/main/scheduler/task_manager.py#L674 Both of these ultimately do the same queries, and the only reason we have two is because multiple developers wrote them, probably mutually unaware of the other data structures that were built, or an unwillingness to modify the code in order to combine efforts. We should combine them. An attempt at this problem was started in https://github.com/ansible/awx/pull/11651 **first fetch** https://github.com/ansible/awx/blob/bff49f2a5fd8929808b2890bc2d16279c523cc53/awx/main/scheduler/task_manager.py#L634 https://github.com/ansible/awx/blob/bff49f2a5fd8929808b2890bc2d16279c523cc53/awx/main/scheduler/task_manager.py#L71 This will then fetch _jobs_ indirectly as `instance.remaining_capacity` is referenced. **second fetch** https://github.com/ansible/awx/blob/bff49f2a5fd8929808b2890bc2d16279c523cc53/awx/main/scheduler/task_manager.py#L662 https://github.com/ansible/awx/blob/bff49f2a5fd8929808b2890bc2d16279c523cc53/awx/main/scheduler/task_manager.py#L620 https://github.com/ansible/awx/blob/bff49f2a5fd8929808b2890bc2d16279c523cc53/awx/main/scheduler/task_manager.py#L601 https://github.com/ansible/awx/blob/bff49f2a5fd8929808b2890bc2d16279c523cc53/awx/main/managers.py#L237 This case attempts to avoid _fetching the jobs list_ by reusing the main list that the task manager operates on. Consider this is a sub-issue of https://github.com/ansible/awx/issues/11306</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>89</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #11914 from ansible/instances_list_filtering add ID as default filter if no other filtering criteria is provided as well as some tests that should cover order integrity for future scenarios</MESSAGE>
    <SHA>ac8204427e241efcadd3bf8152007e1c04179a1e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>drop call that queries all running and waiting jobs this is to fix one more place in the task manager where we end up querying all running and waiting jobs. Partial fix for https://github.com/ansible/awx/issues/11671</MESSAGE>
      <SHA>63bd9ee202bda4e907c95bc88aaff81bfe4a188f</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/models/ha.py</FILE>
        <FILE>awx/main/scheduler/task_manager.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>drop call that queries all running and waiting jobs this is to fix one more place in the task manager where we end up querying all running and waiting jobs. Partial fix for https://github.com/ansible/awx/issues/11671</MESSAGE>
      <SHA>4328b4cb6717e1bc8a5ef4c28129d9e08b43134d</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/models/ha.py</FILE>
        <FILE>awx/main/scheduler/task_manager.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
