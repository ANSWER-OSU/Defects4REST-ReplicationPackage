<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6342</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/6342</ISSUEURL>
  <TITLE>Virtualenv in Kubernetes deployment doesn't work</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY Error when applying `curl -X PATCH 'https://admin:mypass@myurl/api/v2/organizations/my_org/' \ -d '{&quot;custom_virtualenv&quot;: &quot;/opt/custom-venvs/my_env/&quot;}' -H 'Content-Type:application/json'` `{&quot;custom_virtualenv&quot;:[&quot;/opt/custom-venvs/my_env/ is not a valid virtualenv in /var/lib/awx/venv&quot;]}` ##### ENVIRONMENT * AWX version: 9.3.0 * AWX install method: Kubernetes v1.15.3 * Ansible version: 2.9.5 ##### STEPS TO REPRODUCE 1) Install AWX to kubernetes with similar config &lt;details&gt; &lt;summary&gt;inventory config&lt;/summary&gt; ``` localhost ansible_connection=local ansible_python_interpreter=&quot;/usr/bin/env python&quot; [all:vars] dockerhub_base=ansible kubernetes_context=mycontext kubernetes_namespace=awx kubernetes_ingress_hostname=myingress awx_task_hostname=awx awx_web_hostname=awxweb postgres_data_dir=&quot;~/.awx/pgdocker&quot; host_port=80 host_port_ssl=443 docker_compose_dir=&quot;~/.awx/awxcompose&quot; pg_hostname=mypghost pg_username=awx pg_password=mypgpass pg_database=awx pg_port=5432 rabbitmq_password=awxpass rabbitmq_erlang_cookie=cookiemonster admin_user=admin admin_password=myadminpass secret_key=mysecretkey logos/blob/master/TRADEMARKS.md ``` &lt;/details&gt; &lt;details&gt; &lt;summary&gt;venv_vars.yaml&lt;/summary&gt; ``` --- custom_venvs: - name: my_env python: python3 python_ansible_version: 2.9.6 python_modules: - dnspython - zabbix-api - jmespath ``` &lt;/details&gt; 2) Assigning custom venv according to [this documentation](https://github.com/ansible/awx/blob/devel/docs/custom_virtualenvs.md) `curl -X PATCH 'https://admin:mypass@myurl/api/v2/settings/system/' \ -d '{&quot;CUSTOM_VENV_PATHS&quot;: [[&quot;/opt/custom-venvs/my_env/&quot;]}' -H 'Content-Type:application/json'` &lt;details&gt; &lt;summary&gt;answer&lt;/summary&gt; ``` { &quot;ACTIVITY_STREAM_ENABLED&quot;:true, &quot;ACTIVITY_STREAM_ENABLED_FOR_INVENTORY_SYNC&quot;:false, &quot;ORG_ADMINS_CAN_SEE_ALL_USERS&quot;:true, &quot;MANAGE_ORGANIZATION_AUTH&quot;:true, &quot;TOWER_URL_BASE&quot;:&quot;myurl&quot;, &quot;REMOTE_HOST_HEADERS&quot;:[ &quot;HTTP_X_FORWARDED_FOR&quot; ], &quot;PROXY_IP_WHITELIST&quot;:[ ], &quot;LICENSE&quot;:{ }, &quot;REDHAT_USERNAME&quot;:&quot;admin&quot;, &quot;REDHAT_PASSWORD&quot;:&quot;$encrypted$&quot;, &quot;AUTOMATION_ANALYTICS_URL&quot;:&quot;https://example.org&quot;, &quot;INSTALL_UUID&quot;:&quot;c1885c2a-d736-4023-9517-49929f8d77fa&quot;, &quot;CUSTOM_VENV_PATHS&quot;:[ &quot;/opt/custom-venvs/my_env/&quot; ], &quot;INSIGHTS_TRACKING_STATE&quot;:false, &quot;BROKER_DURABILITY&quot;:true, &quot;AUTOMATION_ANALYTICS_LAST_GATHER&quot;:null, &quot;AUTOMATION_ANALYTICS_GATHER_INTERVAL&quot;:14400 } ``` &lt;/details&gt; 3) Assigning custom venv to organization and get and error `curl -X PATCH 'https://admin:mypass@myurl/api/v2/organizations/my_org/' \ -d '{&quot;custom_virtualenv&quot;: &quot;/opt/custom-venvs/my_env/&quot;}' -H 'Content-Type:application/json'` &lt;details&gt; &lt;summary&gt;error&lt;/summary&gt; ``` {&quot;custom_virtualenv&quot;:[&quot;/opt/custom-venvs/my_env/ is not a valid virtualenv in /var/lib/awx/venv&quot;]} ``` &lt;/details&gt; ##### EXPECTED RESULTS `my_org` will use custom venv ##### ACTUAL RESULTS `my_org` raises an error when apllying custom venv ##### ADDITIONAL INFORMATION I've checked both containers `awx_web` and `awx_task`, they have `/opt/custom-venvs/my_env/` dir with working venv. Even if `PATCH api/v2/settings/system/` works properly (according to it answer, and i can see added venv in web interface), `GET api/v2/config/` still returns no venv's &lt;details&gt; &lt;summary&gt;api/v2/config/ answer&lt;/summary&gt; ``` { &quot;time_zone&quot;: &quot;UTC&quot;, &quot;license_info&quot;: { &quot;license_key&quot;: &quot;OPEN&quot;, &quot;valid_key&quot;: true, &quot;compliant&quot;: true, &quot;features&quot;: { &quot;activity_streams&quot;: true, &quot;ha&quot;: true, &quot;ldap&quot;: true, &quot;multiple_organizations&quot;: true, &quot;surveys&quot;: true, &quot;system_tracking&quot;: true, &quot;rebranding&quot;: true, &quot;enterprise_auth&quot;: true, &quot;workflows&quot;: true }, &quot;license_type&quot;: &quot;open&quot; }, &quot;version&quot;: &quot;9.3.0&quot;, &quot;ansible_version&quot;: &quot;2.9.5&quot;, &quot;eula&quot;: &quot;&quot;, &quot;analytics_status&quot;: &quot;off&quot;, &quot;become_methods&quot;: [ [ &quot;sudo&quot;, &quot;Sudo&quot; ], [ &quot;su&quot;, &quot;Su&quot; ], [ &quot;pbrun&quot;, &quot;Pbrun&quot; ], [ &quot;pfexec&quot;, &quot;Pfexec&quot; ], [ &quot;dzdo&quot;, &quot;DZDO&quot; ], [ &quot;pmrun&quot;, &quot;Pmrun&quot; ], [ &quot;runas&quot;, &quot;Runas&quot; ], [ &quot;enable&quot;, &quot;Enable&quot; ], [ &quot;doas&quot;, &quot;Doas&quot; ], [ &quot;ksu&quot;, &quot;Ksu&quot; ], [ &quot;machinectl&quot;, &quot;Machinectl&quot; ], [ &quot;sesu&quot;, &quot;Sesu&quot; ] ], &quot;project_base_dir&quot;: &quot;/var/lib/awx/projects&quot;, &quot;project_local_paths&quot;: [], &quot;custom_virtualenvs&quot;: [ &quot;/var/lib/awx/venv/ansible/&quot; ] } ``` &lt;/details&gt; After finding that venv doesn't apply even in `system`, i've tried to make fresh install of awx on another kube cluster, with same results.</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #6341 from mabashian/fix-broken-lang-fallback [4.4] Adds missing language fallback when no translations are present</MESSAGE>
    <SHA>b262a627ae622b89da18543d3deb1a18f18f8c73</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #6342 from fosterseth/release_4.4 [4.4] Store serialized metrics locally</MESSAGE>
      <SHA>35efe09579a603af1f96eae5b1f843ccbd368f20</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/analytics/subsystem_metrics.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
