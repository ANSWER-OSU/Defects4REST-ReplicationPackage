<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>11422</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/11422</ISSUEURL>
  <TITLE>Notifications are not sent</TITLE>
  <DESCRIPTION>### Please confirm the following - [X] I agree to follow this project's [code of conduct](http://docs.ansible.com/ansible/latest/community/code_of_conduct.html). - [X] I have checked the [current issues](https://github.com/ansible/awx/issues) for duplicates. - [X] I understand that AWX is open source software provided for free and that I am not entitled to status updates or other assurances. ### Summary Currently notifications for (some) jobs are not sent due to a race condition (?): ``` awx_1 | 2021-12-06 13:39:14,446 WARNING [a1a65966262c4559afd398df32b5f445] awx.main.dispatch scaling down worker pid:14114 awx_1 | 2021-12-06 13:39:14,448 DEBUG [a1a65966262c4559afd398df32b5f445] awx.main.dispatch task 4648c5ba-e5bb-49c4-8040-0e98e1d4975b starting awx.main.tasks.handle_success_and_failure_notifications(*[4021]) awx_1 | 2021-12-06 13:39:14,450 WARNING [a1a65966262c4559afd398df32b5f445] awx.main.dispatch scaling down worker pid:14116 awx_1 | 2021-12-06 13:39:14,451 WARNING [a1a65966262c4559afd398df32b5f445] awx.main.dispatch worker exiting gracefully pid:14114 awx_1 | 2021-12-06 13:39:14,453 WARNING [a1a65966262c4559afd398df32b5f445] awx.main.dispatch worker exiting gracefully pid:14116 awx_1 | 2021-12-06 13:39:14,813 INFO [949fbc302a95418e85b3b941b7bb551d] awx.main.commands.run_callback_receiver Event processing is finished for Job 4021, sending notifications awx_1 | 2021-12-06 13:39:14,813 INFO [949fbc302a95418e85b3b941b7bb551d] awx.main.commands.run_callback_receiver Event processing is finished for Job 4021, sending notifications awx_1 | INFO 2021/12/06 13:39:15 Stdout complete - closing channel for: aCroB8Bf awx_1 | ERROR 2021/12/06 13:39:15 Read error in control service: read unix /var/run/awx-receptor/receptor.sock-&gt;@: use of closed network connection awx_1 | INFO 2021/12/06 13:39:15 Client disconnected from control service @ awx_1 | ERROR 2021/12/06 13:39:15 Error closing connection: close unix /var/run/awx-receptor/receptor.sock-&gt;@: use of closed network connection awx_1 | 2021-12-06 13:39:15,939 DEBUG [-] awx.main.commands.run_callback_receiver JobEvent.objects.bulk_create(1) awx_1 | 2021-12-06 13:39:15,939 DEBUG [-] awx.main.commands.run_callback_receiver JobEvent.objects.bulk_create(1) awx_1 | 2021-12-06 13:39:18,015 DEBUG [4f92e389a2534afd82ac34149033c2f3] awx.analytics.performance request: &lt;WSGIRequest: GET '/api/v2/jobs/4021/job_events/?counter__gte=13&amp;limit=9&amp;order_by=counter'&gt;, response_time: 0.218s awx_1 | [pid: 45|app: 0|req: 300/912] 192.168.207.101 () {56 vars in 2559 bytes} [Mon Dec 6 13:39:17 2021] GET /api/v2/jobs/4021/job_events/?counter__gte=13&amp;limit=9&amp;order_by=counter =&gt; generated 14232 bytes in 220 msecs (HTTP/2.0 200) 15 headers in 581 bytes (1 switches on core 0) awx_1 | INFO 2021/12/06 13:39:18 Client connected to control service @ awx_1 | INFO 2021/12/06 13:39:18 Control service closed awx_1 | INFO 2021/12/06 13:39:18 Client disconnected from control service @ awx_1 | 2021-12-06 13:39:18,481 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.tasks job 4021 (running) finished running, producing 22 events. awx_1 | 2021-12-06 13:39:18,494 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.analytics.job_lifecycle job-4021 post run awx_1 | 2021-12-06 13:39:18,676 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.analytics.job_lifecycle job-4021 finalize run awx_1 | 2021-12-06 13:39:18,776 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.dispatch task e9c3cb47-b314-4f01-9a80-67388d7c42e0 starting awx.main.tasks.update_inventory_computed_fields(*[2]) awx_1 | 2021-12-06 13:39:18,806 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.models.inventory Going to update inventory computed fields, pk=2 awx_1 | 2021-12-06 13:39:18,839 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.models.inventory Finished updating inventory computed fields, pk=2, in 0.032 seconds awx_1 | 2021-12-06 13:39:18,931 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.dispatch task 7fdefc75-7d90-41f1-8bd5-11f173086630 starting awx.main.tasks.handle_work_success(*[]) awx_1 | 2021-12-06 13:39:18,951 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.dispatch task 8246994d-45e1-4576-be9a-e53a623f7015 starting awx.main.scheduler.tasks.run_task_manager(*[]) awx_1 | 2021-12-06 13:39:18,955 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.scheduler Running task manager. awx_1 | 2021-12-06 13:39:18,966 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.scheduler Starting Scheduler awx_1 | 2021-12-06 13:39:19,034 DEBUG [fc7226b03a7247d0bf5f473108e35e76] awx.analytics.job_lifecycle job-4021 event processing finished awx_1 | 2021-12-06 13:39:19,042 DEBUG [949fbc302a95418e85b3b941b7bb551d] awx.main.scheduler Finishing Scheduler awx_1 | 2021-12-06 13:39:19,070 DEBUG [fc7226b03a7247d0bf5f473108e35e76] awx.analytics.performance request: &lt;WSGIRequest: GET '/api/v2/jobs/4021/'&gt;, response_time: 0.207s awx_1 | [pid: 45|app: 0|req: 301/913] 192.168.207.101 () {56 vars in 2456 bytes} [Mon Dec 6 13:39:18 2021] GET /api/v2/jobs/4021/ =&gt; generated 4964 bytes in 210 msecs (HTTP/2.0 200) 14 headers in 565 bytes (1 switches on core 0) awx_1 | 2021-12-06 13:39:19,561 WARNING [a1a65966262c4559afd398df32b5f445] awx.main.tasks Failed to even try to send notifications for job '2021-12-06 13:38:04.895362+00:00-4021-successful' due to job not being in finished state. ``` Are the receptor error messages in there expected? ### AWX version 19.5.0 ### Installation method docker on linux ### Modifications no ### Ansible version 4.9.0 ### Operating system CentOS 7 ### Web browser Firefox, Chrome, Safari, Edge ### Steps to reproduce Create a notification and change a job to send notifications on success/failure ### Expected results Notifications are sent out ### Actual results Notifications are not sent out for some jobs ### Additional information _No response_</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>184</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fixup conversion of memory and cpu settings to support k8s resource request format (#11725) fix memory and cpu settings to suport k8s resource request format * fix conversion of memory setting to bytes This setting has not been getting set by default, and needed some fixing up to be compatible with setting the memory in the same way as we set it in the operator, as well as with other changes from last year which assume that ansible runner is returning memory in bytes. This way we can start setting this setting in the operator, and get a more accurate reflection of how much memory is available to the control pod in k8s. On platforms where services are all sharing memory, we deduct a penalty from the memory available. On k8s we don't need to do this because the web, redis, and task containers each have memory allocated to them. * Support CPU setting expressed in units used by k8s This setting has not been getting set by default, and needed some fixing up to be compatible with setting the CPU resource request/limits in the same way as we set it in the resource requests/limits. This way we can start setting this setting in the operator, and get a more accurate reflection of how much cpu is available to the control pod in k8s. Because cpu on k8s can be partial cores, migrate cpu field to decimal. k8s does not allow granularity of less than 100m (equivalent to 0.1 cores), so only store up to 1 decimal place. fix analytics to deal with decimal cpu need to use DjangoJSONEncoder when Decimal fields in data passed to json.dumps</MESSAGE>
    <SHA>799968460d4794bcd9959f57a2b97846b9a00bb7</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Give the system a bit more time to finish This will fix notification not being sent due to slow(er) communications between all moving parts. See #11422 (and probably #2982 too)</MESSAGE>
      <SHA>36b05c3c5ed64938bcdde4c9301178f0eb7b3e94</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/tasks/system.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
