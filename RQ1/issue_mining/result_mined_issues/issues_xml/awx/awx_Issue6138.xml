<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6138</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/6138</ISSUEURL>
  <TITLE>AWX 9.2 vmware_inventory.py TLS v1 not supported</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY &lt;!-- Briefly describe the problem. --&gt; It is not possible to connect to vmware vsphere (TLSv1) since at least AWX version 8. TLSv1 needs to be enabled/supported! ##### ENVIRONMENT * AWX version: 9.2.0 * AWX install method: docker on linux * Ansible version: 2.9.5 ##### ACTUAL RESULTS &lt;!-- What actually happened? --&gt; Output when synching with vsphere: (It complains about username or password but that is a wrong error message. I can connect no problem with the account and the error message when using vmware_guest is different.) ``` 3.375 INFO Updating inventory 28: Vcenter Inventory 4.108 INFO Reading Ansible inventory source: /var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/plugins/inventory/vmware_inventory.py 4.112 INFO Using VIRTUAL_ENV: /var/lib/awx/venv/ansible 4.113 INFO Using PATH: /var/lib/awx/venv/ansible/bin:/var/lib/awx/venv/awx/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin 4.113 INFO Using PYTHONPATH: /var/lib/awx/venv/ansible/lib/python3.6/site-packages: Traceback (most recent call last): File &quot;/var/lib/awx/venv/awx/bin/awx-manage&quot;, line 8, in &lt;module&gt; sys.exit(manage()) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/__init__.py&quot;, line 152, in manage execute_from_command_line(sys.argv) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 381, in execute_from_command_line utility.execute() File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 375, in execute self.fetch_command(subcommand).run_from_argv(self.argv) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 323, in run_from_argv self.execute(*args, **cmd_options) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 364, in execute output = self.handle(*args, **options) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/management/commands/inventory_import.py&quot;, line 1157, in handle raise exc File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/management/commands/inventory_import.py&quot;, line 1047, in handle venv_path=venv_path, verbosity=self.verbosity).load() File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/management/commands/inventory_import.py&quot;, line 215, in load return self.command_to_json(base_args + ['--list']) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/management/commands/inventory_import.py&quot;, line 198, in command_to_json self.method, proc.returncode, stdout, stderr)) RuntimeError: ansible-inventory failed (rc=1) with stdout: stderr: ansible-inventory 2.9.3 config file = /etc/ansible/ansible.cfg configured module search path = ['/var/lib/awx/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3.6/site-packages/ansible executable location = /usr/bin/ansible-inventory python version = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507 (Red Hat 8.3.1-4)] Using /etc/ansible/ansible.cfg as config file [WARNING]: * Failed to parse /var/lib/awx/venv/awx/lib/python3.6/site- packages/awx/plugins/inventory/vmware_inventory.py with script plugin: Inventory script (/var/lib/awx/venv/awx/lib/python3.6/site- packages/awx/plugins/inventory/vmware_inventory.py) had an execution error: Could not connect to the specified host using specified username and password File &quot;/usr/lib/python3.6/site-packages/ansible/inventory/manager.py&quot;, line 280, in parse_source plugin.parse(self._inventory, self._loader, source, cache=cache) File &quot;/usr/lib/python3.6/site-packages/ansible/plugins/inventory/script.py&quot;, line 161, in parse raise AnsibleParserError(to_native(e)) [WARNING]: Unable to parse /var/lib/awx/venv/awx/lib/python3.6/site- packages/awx/plugins/inventory/vmware_inventory.py as an inventory source ERROR! No inventory was parsed, please check your configuration and options. ``` Output when using vmware_guest to build a new VM: ``` Unable to connect to vCenter or ESXi API at virtualcenter.local on TCP/443: [SSL: UNSUPPORTED_PROTOCOL] unsupported protocol (_ssl.c:897) ``` I tried adding support for TLSv1 by adding the below lines inside vmware_inventory.py but the installed openssl does not know the TLSVersion parameter: ``` context.options &amp;= ~ssl.OP_NO_TLSv1_3 &amp; ~ssl.OP_NO_TLSv1_2 &amp; ~ssl.OP_NO_TLSv1_1 context.minimum_version = ssl.TLSVersion.TLSv1 ``` ``` def get_instances(self): ''' Get a list of vm instances with pyvmomi ''' kwargs = {'host': self.server, 'user': self.username, 'pwd': self.password, 'port': int(self.port)} if self.validate_certs and hasattr(ssl, 'SSLContext'): context = ssl.SSLContext(ssl.PROTOCOL_TLS) context.options &amp;= ~ssl.OP_NO_TLSv1_3 &amp; ~ssl.OP_NO_TLSv1_2 &amp; ~ssl.OP_NO_TLSv1_1 context.minimum_version = ssl.TLSVersion.TLSv1 context.verify_mode = ssl.CERT_REQUIRED context.check_hostname = True kwargs['sslContext'] = context elif self.validate_certs and not hasattr(ssl, 'SSLContext'): sys.exit('pyVim does not support changing verification mode with python &lt; 2.7.9. Either update ' 'python or use validate_certs=false.') elif not self.validate_certs and hasattr(ssl, 'SSLContext'): context = ssl.SSLContext(ssl.PROTOCOL_TLS) context.options &amp;= ~ssl.OP_NO_TLSv1_3 &amp; ~ssl.OP_NO_TLSv1_2 &amp; ~ssl.OP_NO_TLSv1_1 context.minimum_version = ssl.TLSVersion.TLSv1 context.verify_mode = ssl.CERT_NONE context.check_hostname = False kwargs['sslContext'] = context elif not self.validate_certs and not hasattr(ssl, 'SSLContext'): # Python 2.7.9 &lt; or RHEL/CentOS 7.4 &lt; pass return self._get_instances(kwargs) ``` ```AttributeError:` module 'ssl' has no attribute 'TLSVersion``` ##### ADDITIONAL INFORMATION &lt;!-- Include any links to sosreport, database dumps, screenshots or other information. --&gt;</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #6124 from ansible/fix-topology-css-overflow [4.3] Fix CSS overflow for legend and tooltip in Topology view.</MESSAGE>
    <SHA>e51e39e4b0965573eb6e6e49a4838a801a38b58d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #6138 from ansible/attribute_error [Backport 4.3] Add attribute error field in line 285, the same we do in line 293, to get more information about the error</MESSAGE>
      <SHA>bc1e6bd362307d6806216e186720abf742ab95e1</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/models/credential/__init__.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
