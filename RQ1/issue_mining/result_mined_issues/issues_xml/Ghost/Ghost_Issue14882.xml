<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14882</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/14882</ISSUEURL>
  <TITLE>Remove the bluebird dependency from everywhere</TITLE>
  <DESCRIPTION>Now that there are native promises in Node.js _and_ with async/await, bluebird really is a blast from the past. However, it's embedded pretty hard across our dependencies and some of our code uses catch predicates, which means we have to be careful about the order in which we rip bluebird out, otherwise we could break our error handling in weird and unexpected ways. Here's some notes on what we need to do, most importantly starting with finding everywhere we depend on catch predicates: **Native:** - Promise.all - Promise.then - Promise.reject - Promise.resolve **Bluebird** - catch predicates -&gt; replace with normal if statements - Promise.promisify -&gt; require('util').promisify - Promise.props -&gt; Promise.all [example](https://github.com/serverless/serverless/pull/8414/files) - Promise.join -&gt; Promise.all - Promise.each -&gt; Promise.all + array.map - Promise.map -&gt; Promise.all + array.map - Promise.filter -&gt; for and async/await - Promise.mapSeries -&gt; use our sequence util (which needs an implementation of reduce, but is our only usage of it) - Promise.delay -&gt; promisify getTimeout? Or get rid? --- ## Refactor Approach This refactor needs to be done in two phases: 1. ✅ Remove all the catch predicates The best way to find catch predicates is with this regex: `/\.catch\([^)]+,/`. 2. Remove bluebird from everywhere else: - Ghost monorepo - bluebird is required 117 times - [framework](https://github.com/TryGhost/framework) - bluebird required 5 times, but these are some of the most critical usages - [SDK](https://github.com/TryGhost/SDK) - just one usage, easy win! - [gscan](https://github.com/TryGhost/gscan) - 3 usages - [knex-migrator](https://github.com/TryGhost/knex-migrator) - 3 usages **Why did we have to do catch predicates first?** Catch predicates result in error handling that assume the Promise they are handling is a Bluebird promise. If that isn't the case, Ghost will error, and quite possibly crash. Our code coverage isn't quite good enough to be certain that all the unhappy paths are tested and we'll find these, and it's too much cognitive load for anyone to figure out if removing Bluebird is safe whilst there are still catch predicates in the codebase. --- ## How to work on this issue The slow and steady approach to refactoring is the only thing that really works. Branches should be very short lived (&lt;1 day if possible). Therefore, please do not attempt to do this entire refactor in a single PR. It is not possible for us to review! Instead, please find a single file with many references, or a small subfolder of the codebase with a handful of usages, make the changes, and submit a PR. Then repeat. Please follow our contribution guidelines as closely as you can, particularly being sure to reference this issue in your commit. Refactor commits should not use emojis as they are not user-facing changes. Note: This refactor has almost no user facing impact and (hopefully) no tests should break or change. A reference refactor commit can be found here: https://github.com/TryGhost/Ghost/commit/10aad8db7e12b6d08089cd7beee3ea9df64b3adb Thank you ❤️</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>924</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Renamed #ghost-comments-root to #ghost-comments (fragment to jump to comments section) fixes https://github.com/TryGhost/Team/issues/1730 refs https://github.com/TryGhost/comments-ui/commit/db8d1120f451adb8c40828d1f93da8c588dd6ff0</MESSAGE>
    <SHA>a5084c7ee6207d6173a6334d3e5dd22711a2e538</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>refactored security.password to use native bcrypt promises (#15126) refs: https://github.com/TryGhost/Ghost/issues/14882 * refactored security.password to use native bcrypt promises * refactored security.string to use more modern es features</MESSAGE>
      <SHA>59f4570ee743aa2d0c625b4b745c1e1fbfe4fcdd</SHA>
      <PATCHEDFILES>
        <FILE>ghost/security/lib/password.js</FILE>
        <FILE>ghost/security/lib/string.js</FILE>
        <FILE>ghost/security/package.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#14882 Remove catch predicate from intergrations</MESSAGE>
      <SHA>2bdbe52222207a0e02e2c82c1f05dbcd449f9482</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/api/endpoints/integrations.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>removed catch predicate from integrations (#14969) refs https://github.com/TryGhost/Ghost/issues/14882 - catch predicates make removing Bluebird from other parts of the code risky.</MESSAGE>
      <SHA>3c76172e8191a8d80191694aa788f487cdb9ad30</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/api/endpoints/integrations.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Removed bluebird catch predicates from API endpoints refs: https://github.com/TryGhost/Ghost/issues/14882 - I found a common pattern where catch predicates were being used to catch non-existent models in destroy methods, and sometimes elsewhere in the API endpoints - The use of predicates is deprecated, and we're working to remove them from everywhere, so that we can remove bluebird - In order to still handle these errors correctly, we needed a small change to mw-error-handler so that it can detect EmptyResponse errors from bookshelf, as well as 404s Note: there is a small change as a result of this - the context on these errors now says &quot;Resource not found&quot; instead of &quot;{ModelName} not found&quot;. - I think this is acceptable for now, as we will be reviewing these errors in more depth later. It's quite easy to make changes, we just have to decide what with proper design input</MESSAGE>
      <SHA>8bcdfb8377b416b8bd0087d1639dad7347aee32e</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/api/endpoints/comments-members.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/invites.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/labels.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/members.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/pages.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/posts.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/snippets.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/tags.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/webhooks.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/__snapshots__/labels.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/admin/__snapshots__/members.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/admin/__snapshots__/snippets.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/admin/__snapshots__/webhooks.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/admin/invites.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/labels.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/members.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/snippets.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/tags.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/webhooks.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/members-comments/__snapshots__/comments.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/members-comments/comments.test.js</FILE>
        <FILE>ghost/mw-error-handler/lib/mw-error-handler.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Removed all remaining bluebird catch predicates refs: https://github.com/TryGhost/Ghost/issues/14882 - The use of predicates is deprecated, and we're working to remove them from everywhere, so that we can remove bluebird - This should be the final piece of the puzzle in terms of predicates, from here we can start removing bluebird without concern that a predicate somewhere will explode - Note: some of this code is poorly tested, but the refactors are very straightforward and minimal</MESSAGE>
      <SHA>2163b553e798afbeb0eeea9c111fabfeabc39f03</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/lib/image/gravatar.js</FILE>
        <FILE>ghost/core/core/server/lib/image/image-size.js</FILE>
        <FILE>ghost/core/core/server/services/auth/passwordreset.js</FILE>
        <FILE>ghost/core/core/server/services/route-settings/default-settings-manager.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Removed bluebird catch predicates from API endpoints refs: https://github.com/TryGhost/Ghost/issues/14882 - I found a common pattern where catch predicates were being used to catch non-existent models in destroy methods, and sometimes elsewhere in the API endpoints - The use of predicates is deprecated, and we're working to remove them from everywhere, so that we can remove bluebird - In order to still handle these errors correctly, we needed a small change to mw-error-handler so that it can detect EmptyResponse errors from bookshelf, as well as 404s Note: there is a small change as a result of this - the context on these errors now says &quot;Resource not found&quot; instead of &quot;{ModelName} not found&quot;. - I think this is acceptable for now, as we will be reviewing these errors in more depth later. It's quite easy to make changes, we just have to decide what with proper design input</MESSAGE>
      <SHA>af948553497de999d03569eb3b4fd32077cb93f7</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/api/endpoints/comments-members.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/invites.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/labels.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/members.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/pages.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/posts.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/snippets.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/tags.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/webhooks.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/__snapshots__/labels.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/admin/__snapshots__/members.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/admin/__snapshots__/snippets.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/admin/__snapshots__/webhooks.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/admin/invites.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/labels.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/members.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/snippets.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/tags.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/admin/webhooks.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/members-comments/__snapshots__/comments.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/members-comments/comments.test.js</FILE>
        <FILE>ghost/mw-error-handler/lib/mw-error-handler.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Removed all remaining bluebird catch predicates refs: https://github.com/TryGhost/Ghost/issues/14882 - The use of predicates is deprecated, and we're working to remove them from everywhere, so that we can remove bluebird - This should be the final piece of the puzzle in terms of predicates, from here we can start removing bluebird without concern that a predicate somewhere will explode - Note: some of this code is poorly tested, but the refactors are very straightforward and minimal</MESSAGE>
      <SHA>21231536cbee53bce990cd4ddf79a3df6d7f6746</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/lib/image/gravatar.js</FILE>
        <FILE>ghost/core/core/server/lib/image/image-size.js</FILE>
        <FILE>ghost/core/core/server/services/auth/passwordreset.js</FILE>
        <FILE>ghost/core/core/server/services/route-settings/default-settings-manager.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Removed bluebird from frontend/meta (#14940) refs: https://github.com/TryGhost/Ghost/issues/14882 - Usage of bluebird is deprecated in favour of using native promises Co-authored-by: Navarjun &lt;navarjun@Navarjuns-MBP.hitronhub.home&gt;</MESSAGE>
      <SHA>57a786c63c30321debad438fd260d6e4bd5b2fdb</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/meta/get-meta.js</FILE>
        <FILE>ghost/core/core/frontend/meta/image-dimensions.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Replaced Promise.join() with .all() in user model (#14972) refs: https://github.com/TryGhost/Ghost/issues/14882 - Usage of bluebird is deprecated in favour of using native promises</MESSAGE>
      <SHA>d9f0db6a22713dcfd5b77f3662c04838c3aceea1</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/models/user.js</FILE>
        <FILE>ghost/core/test/regression/models/model_users.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
