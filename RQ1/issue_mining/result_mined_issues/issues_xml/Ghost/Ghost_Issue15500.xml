<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15500</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/15500</ISSUEURL>
  <TITLE>Incorrect quotes in translate helper causes 500 error</TITLE>
  <DESCRIPTION>### Issue Summary Using smart quotes in the translate helper causes page visits to throw 500 errors. Mac OS for example will auto-convert quotes by default, and this a common and VERY hard to spot issue for people new to code. Smart quotes example: `{{t “This causes an error”}}` Straight quotes example: `{{t &quot;This causes an error&quot;}}` As handlebars would always expect straight quotes, I suspect this is true for several helpers. Although the fact that this is an error is correct, we have a policy of never throwing 500 Internal Server errors for theme issues, but instead throw 400 Bad Request errors. This is slightly odd, but nothing is wrong with the server, it's doing everything correctly and therefore this is not an error that the person running Ghost needs to deal with, but rather the user who uploaded the theme. In this case, the error can probably be handled better. ### Steps to Reproduce 1. Open the default.hbs file of the current active theme 2. Paste in the example translate helper with smart quotes `{{t “This causes an error”}}` 3. Try to visit any page 4. See the 500 error in the logs ### Ghost Version 4.42.1 ### Node.js Version 16.14.2 ### How did you install Ghost? ghost install ### Database type MySQL 8 ### Browser &amp; OS version Any ### Relevant log / error output ```shell HTTP/1.1 500 Internal Server Error -- TypeError: [default.hbs] Cannot read properties of undefined (reading 'hash') at Object.t (/home/ghost/core/frontend/helpers/t.js:18:26) at Object.wrapper (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/internal/wrapHelper.js:15:19) at Object.eval [as main] (eval at createFunctionContext (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/compiler/javascript-compiler.js:262:23), &lt;anonymous&gt;:13:92) at main (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/runtime.js:208:32) at ret (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/runtime.js:212:12) at ret (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/compiler/compiler.js:519:21) at Object.invokePartial (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/runtime.js:334:12) at Object.invokePartialWrapper [as invokePartial] (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/runtime.js:84:39) at Object.eval [as main] (eval at createFunctionContext (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/compiler/javascript-compiler.js:262:23), &lt;anonymous&gt;:39:28) at main (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/runtime.js:208:32) at ret (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/runtime.js:212:12) at ret (/home/ghost/node_modules/handlebars/dist/cjs/handlebars/compiler/compiler.js:519:21) at renderTemplate (/home/ghost/node_modules/express-hbs/lib/hbs.js:490:13) at _stackRenderer (/home/ghost/node_modules/express-hbs/lib/hbs.js:519:9) at renderTemplate (/home/ghost/node_modules/express-hbs/lib/hbs.js:499:5) at render (/home/ghost/node_modules/express-hbs/lib/hbs.js:526:5) ```` ``` ### Code of Conduct - [X] I agree to be friendly and polite to people in this repository</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>13</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fixed staff acceptance test refs https://github.com/TryGhost/Ghost/commit/e0430b4efc557e0ba909d74b99c9a2ecdcb71131 - acceptance test had mixed up name/slug fields so was testing for incorrect values now that cmd+s inside the slug field is working as really expected</MESSAGE>
    <SHA>289e8a8da60b407cd098f0aa43fa18573ec2c3cf</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>:bug: fixed error message code for HB translate helper closes #15500 Per the issue, Ghost has a policy to never throw 500 Internal Server errors for theme issues. This change adds a check inside of `ghost\core\core\frontend\helpers\t.js` if `text` or `options` is undefined, to throw an `IncorrectUsageError` error within the function. Messaging was borrowed from `ghost\core\core\frontend\web\middleware\error-handler.js`.</MESSAGE>
      <SHA>3f2d281c5d837d37d003be53a0148ea6a7079d3e</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/helpers/t.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>:art: add unit tests for HB translate helper Added unit tests to the MR #15529 / issue #15500. Added a regex in the `t()` to explicitly check for smart apostrophes in the event that they are not stripped out/come through as undefined.</MESSAGE>
      <SHA>f9448d31f7dbbe952389d04033fccfaf7b379fae</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/helpers/t.js</FILE>
        <FILE>ghost/core/test/unit/frontend/helpers/t.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fixed error message code for HB translate helper (#15529) closes: https://github.com/TryGhost/Ghost/issues/15500 - Per the issue, Ghost has a policy to never throw 500 Internal Server errors for theme issues. This change adds a check inside of `ghost\core\core\frontend\helpers\t.js` if `text` or `options` is undefined, to throw an `IncorrectUsageError` error within the function. - Messaging was borrowed from `ghost\core\core\frontend\web\middleware\error-handler.js`.</MESSAGE>
      <SHA>d0e11da7872c2cb8935714af4a75b8b7ba4d01e0</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/helpers/t.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed error in translate helper when invalid parameters are passed (#20663) ref https://linear.app/tryghost/issue/SLO-182 ref https://github.com/TryGhost/Ghost/issues/15500 - when the {{ t }} helper is used with no parameter or an empty string, it now returns an empty string - when the {{ t }} helper is used without options, it now does not throw an error</MESSAGE>
      <SHA>1422ad5e6f10d06742caccc2a571fcde185bdf0e</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/helpers/t.js</FILE>
        <FILE>ghost/core/core/frontend/services/theme-engine/i18n/I18n.js</FILE>
        <FILE>ghost/core/test/unit/frontend/helpers/t.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
