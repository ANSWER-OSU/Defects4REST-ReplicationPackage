<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>17937</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/17937</ISSUEURL>
  <TITLE>StaffServiceEmails.js (eventually) sends new member notifications with wrong styles</TITLE>
  <DESCRIPTION>### Issue Summary Sometimes Ghost sends new member email notifications with incorrect styles, resulting in ugly blue backgrounds like this: ![Screenshot 2023-09-01 at 4 37 19 PM@0 5x](https://github.com/TryGhost/Ghost/assets/710176/6d714f87-d2b8-47ff-a839-feec46c6fc7f) The `StaffServiceEmails` class sends new member email notifications that initially show no problem. However, at some point, it appears the `styles` Handlebars partial (from ghost/**staff**-service/lib/email-templates/partials/styles.hbs) gets overwritten with the styles from ghost/**email**-service/lib/email-templates/partials/styles.hbs. My guess is that they both use the same Handlebars instance, but the partials for `StaffServiceEmails` are only registered once in its constructor. ### Steps to Reproduce 1. Enable new member email notifications. 2. Wait for new sign-ups. 3. Initially the notification messages appear with correct styles. 4. Eventually the notification messages will show incorrect styles. ### Ghost Version 5.59.4 ### Node.js Version 16.20.2 ### How did you install Ghost? Ubuntu 22.04 ### Database type MySQL 8 ### Browser &amp; OS version _No response_ ### Relevant log / error output _No response_ ### Code of Conduct - [X] I agree to be friendly and polite to people in this repository</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>24</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fixed minor issues with AdminX Ember sync (#18359) refs https://github.com/TryGhost/Product/issues/3832</MESSAGE>
    <SHA>fb435cc1159f430aa84aeab4afcdc9c573c155be</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixed staff emails eventually having invalid styles fixes https://github.com/TryGhost/Ghost/issues/17937 - We used a global Handlebars instance, which means it was reused across Ghost - Partials are different between parts of Ghost, that means the partials were overwritten every time a normal Mailgun email was send - All staff emails send after a normal newsletter would have invalid styles because the partials for styles were overwritten</MESSAGE>
      <SHA>63fa23802f016914989b936b19dd1aee43afa90c</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/services/comments/CommentsServiceEmails.js</FILE>
        <FILE>ghost/email-service/lib/EmailRenderer.js</FILE>
        <FILE>ghost/staff-service/lib/StaffServiceEmails.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed staff emails eventually having invalid styles (#18363) fixes https://github.com/TryGhost/Ghost/issues/17937 - We used a global Handlebars instance, which means it was reused across Ghost - Partials are different between parts of Ghost, that means the partials were overwritten every time a normal Mailgun email was send - All staff emails send after a normal newsletter would have invalid styles because the partials for styles were overwritten</MESSAGE>
      <SHA>3a5c233122c333a0b7a3834092574d9b90df9d32</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/services/comments/CommentsServiceEmails.js</FILE>
        <FILE>ghost/email-service/lib/EmailRenderer.js</FILE>
        <FILE>ghost/staff-service/lib/StaffServiceEmails.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
