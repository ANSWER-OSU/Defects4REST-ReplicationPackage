<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>16748</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/16748</ISSUEURL>
  <TITLE>admin/members/:id/signin_url won't take Owner's staff access token</TITLE>
  <DESCRIPTION>### Issue Summary I'm trying to make a fetch request to admin/members/:id/signin_url The [commit](https://github.com/TryGhost/Ghost/commit/b0ff1e7cacf619deed1d4f07c3cb0e7731707597) (Hi @naz !) that added the functionality seems to suggest this is possible. I'm converting the owner's staff access token into a JWT successfully, based on it working elsewhere on the admin API. I've tried on Ghost Pro (but it was a site where I'd switched owners, so could be an edge case). I've also tried on a production 5.13 self-hosted site, and on a 5.47 local install (Windows). Here's what I'm getting back (fresh 5.47 install, but all cases are the same): Request to: http://localhost:2368/ghost/api/canary/admin/members/6456ef85849b402bb40c61f4/signin_urls/ ``` errors: [ { message: 'Permission error, cannot read member_signin_url.', context: 'You do not have permission to read member_signin_urls', type: 'NoPermissionError', details: null, property: null, help: null, code: null, id: '714c58e0-ec6e-11ed-94c9-6ba7df6bb971', ghostErrorCode: null } ] ``` The endpoint works fine if I pass in the site owner's cookie. ### Steps to Reproduce ``` const session = require('express-session') const express = require(&quot;express&quot;); const fetch = require('node-fetch') const app = express(); app.use(express.json()); app.use(express.urlencoded({ extended: false })); const jwt = require('jsonwebtoken') const GhostAdminAPI = require('@tryghost/admin-api'); const GHOST_URL = 'http://localhost:2368' let GHOST_API_KEY = '6456efec849b402bb40c61fc:07df42c75551444cb88af8601acbdcc4cc0d8ea983392ddb44dbb1cebb87a32b'; //local install, not worried about leakage. let [GHOST_ID, GHOST_SECRET] = GHOST_API_KEY.split(':') const api = new GhostAdminAPI({ url: GHOST_URL, key: GHOST_API_KEY, version: &quot;v5.0&quot;, }); let GHOST_TOKEN = jwt.sign({}, Buffer.from(GHOST_SECRET, 'hex'), { // eslint-disable-line no-undef keyid: GHOST_ID, algorithm: 'HS256', expiresIn: '5m', audience: '/canary/admin' }); console.log(GHOST_TOKEN) async function getMember(email) { let result = await api.members.browse({email:email, limit: 1}) console.log('getMember result is', result[0].id) return result[0].id; } async function getAuthUrl(id) { // does not work let result = await fetch(GHOST_URL + '/ghost/api/canary/admin/members/' + id + '/signin_urls/', { method: 'GET' , headers: { 'Authorization': `Ghost ${GHOST_TOKEN}`, 'Content-type': 'application/json'} } ) let json= await result.json() console.log('result is', json) return result; } async function getMemberUrl(id) { // works fine console.log('getMemberUrl request to: ', GHOST_URL + '/ghost/api/canary/admin/members/' + id ) let result = await fetch( GHOST_URL + '/ghost/api/canary/admin/members/' + id , { method: 'GET' , headers: { 'Authorization': 'Ghost ' + GHOST_TOKEN} }) let json= await result.json() console.log('result is', json) return result; } app.get(&quot;/&quot;, async (req, res) =&gt; { res.send(`&lt;center style=&quot;font-size:160%&quot;&gt; &lt;p&gt;This is Home Page &lt;/p&gt; ${await getMemberUrl(await getMember('catsarisky@gmail.com'))} ${await getAuthUrl(await getMember('catsarisky@gmail.com'))} `); } ); app.listen(3002); ``` ### Ghost Version 5.47 ### Node.js Version 16 ### How did you install Ghost? Ghost Pro, also local install on Windows, also 5.13 production ### Database type MySQL 8 ### Browser &amp; OS version _No response_ ### Relevant log / error output _No response_ ### Code of Conduct - [X] I agree to be friendly and polite to people in this repository</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>171</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Reverted &quot;Stripped moment from BaseSiteMapGenerator&quot; refs https://ghost.slack.com/archives/C02G9E68C/p1729083762579479 - this reverts commit 30220aa6effd043c0b120a975e6e484adb86c118.</MESSAGE>
    <SHA>7fc4dfaac1cea366d6119619eca93047ee9114b5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixed members/signin_urls endpoint to take admin api key (#21284) closes #16748 The members/:member_id/signin_urls endpoint currently only does cookie-based authentication. When #21249 is merged, turning on 2FA is going to break any 3rd party processes that use it (including my social sign-in offering). This patch gives admin API keys 'read' permission on this endpoint, and enables 3rd party processes to handle user logins the right way, instead of via a staff member's email/password. Migration included. Feedback appreciated. I have the wrong name on my migration. I can see it doesn't follow the naming convention, but I'm not sure how the names are generated. --------- Co-authored-by: Michael Barrett &lt;mike182uk@gmail.com&gt;</MESSAGE>
      <SHA>73a39ead9a5a19b66b70f6fa09b4b14aab38c5a7</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/data/migrations/versions/5.97/2024-10-10-01-02-03-add-signin-urls-permissions.js</FILE>
        <FILE>ghost/core/core/server/data/schema/fixtures/fixtures.json</FILE>
        <FILE>ghost/core/test/integration/migrations/migration.test.js</FILE>
        <FILE>ghost/core/test/regression/api/admin/members-signin-url.test.js</FILE>
        <FILE>ghost/core/test/unit/server/data/schema/fixtures/fixture-manager.test.js</FILE>
        <FILE>ghost/core/test/unit/server/data/schema/integrity.test.js</FILE>
        <FILE>ghost/core/test/utils/fixtures/fixtures.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed members/signin_urls endpoint to take admin api key (#21284) closes #16748 The members/:member_id/signin_urls endpoint currently only does cookie-based authentication. When #21249 is merged, turning on 2FA is going to break any 3rd party processes that use it (including my social sign-in offering). This patch gives admin API keys 'read' permission on this endpoint, and enables 3rd party processes to handle user logins the right way, instead of via a staff member's email/password. Migration included. Feedback appreciated. I have the wrong name on my migration. I can see it doesn't follow the naming convention, but I'm not sure how the names are generated. --------- Co-authored-by: Michael Barrett &lt;mike182uk@gmail.com&gt;</MESSAGE>
      <SHA>470ece8d2c9235a27061a49d707491b3a4132f07</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/data/migrations/versions/5.97/2024-10-10-01-02-03-add-signin-urls-permissions.js</FILE>
        <FILE>ghost/core/core/server/data/schema/fixtures/fixtures.json</FILE>
        <FILE>ghost/core/test/integration/migrations/migration.test.js</FILE>
        <FILE>ghost/core/test/regression/api/admin/members-signin-url.test.js</FILE>
        <FILE>ghost/core/test/unit/server/data/schema/fixtures/fixture-manager.test.js</FILE>
        <FILE>ghost/core/test/unit/server/data/schema/integrity.test.js</FILE>
        <FILE>ghost/core/test/utils/fixtures/fixtures.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed members/signin_urls endpoint to take admin api key (#21284) closes #16748 The members/:member_id/signin_urls endpoint currently only does cookie-based authentication. When #21249 is merged, turning on 2FA is going to break any 3rd party processes that use it (including my social sign-in offering). This patch gives admin API keys 'read' permission on this endpoint, and enables 3rd party processes to handle user logins the right way, instead of via a staff member's email/password. Migration included. Feedback appreciated. I have the wrong name on my migration. I can see it doesn't follow the naming convention, but I'm not sure how the names are generated. --------- Co-authored-by: Michael Barrett &lt;mike182uk@gmail.com&gt;</MESSAGE>
      <SHA>2aa6852d3d7c269af833b1bfa13c40ef4afb1d90</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/data/migrations/versions/5.97/2024-10-10-01-02-03-add-signin-urls-permissions.js</FILE>
        <FILE>ghost/core/core/server/data/schema/fixtures/fixtures.json</FILE>
        <FILE>ghost/core/test/integration/migrations/migration.test.js</FILE>
        <FILE>ghost/core/test/regression/api/admin/members-signin-url.test.js</FILE>
        <FILE>ghost/core/test/unit/server/data/schema/fixtures/fixture-manager.test.js</FILE>
        <FILE>ghost/core/test/unit/server/data/schema/integrity.test.js</FILE>
        <FILE>ghost/core/test/utils/fixtures/fixtures.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed members/signin_urls endpoint to take admin api key (#21284) closes #16748 The members/:member_id/signin_urls endpoint currently only does cookie-based authentication. When #21249 is merged, turning on 2FA is going to break any 3rd party processes that use it (including my social sign-in offering). This patch gives admin API keys 'read' permission on this endpoint, and enables 3rd party processes to handle user logins the right way, instead of via a staff member's email/password. Migration included. Feedback appreciated. I have the wrong name on my migration. I can see it doesn't follow the naming convention, but I'm not sure how the names are generated. --------- Co-authored-by: Michael Barrett &lt;mike182uk@gmail.com&gt;</MESSAGE>
      <SHA>a89e2d0bf495be756b999d54b190ad0d5950d26c</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/data/migrations/versions/5.97/2024-10-10-01-02-03-add-signin-urls-permissions.js</FILE>
        <FILE>ghost/core/core/server/data/schema/fixtures/fixtures.json</FILE>
        <FILE>ghost/core/test/integration/migrations/migration.test.js</FILE>
        <FILE>ghost/core/test/regression/api/admin/members-signin-url.test.js</FILE>
        <FILE>ghost/core/test/unit/server/data/schema/fixtures/fixture-manager.test.js</FILE>
        <FILE>ghost/core/test/unit/server/data/schema/integrity.test.js</FILE>
        <FILE>ghost/core/test/utils/fixtures/fixtures.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
