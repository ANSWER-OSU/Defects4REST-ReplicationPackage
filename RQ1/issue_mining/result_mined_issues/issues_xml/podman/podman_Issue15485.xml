<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15485</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15485</ISSUEURL>
  <TITLE>invalid event on image removal + missing untag event from REST API</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** Removing an image should send a `delete` event but I'm receiving a `remove` event https://docs.docker.com/engine/api/v1.41/#tag/System/operation/SystemEvents states: Images report these events: `delete`, `import`, `load`, `pull`, `push`, `save`, `tag`, `untag`, and `prune` **Steps to reproduce the issue:** 1. pull an image with docker ```bash $ docker pull httpd ``` track events in a separate terminal ``` $ curl --unix-socket /var/run/docker.sock http:/v1.41/events ``` remove the image ``` $ docker rmi a981c8992512 ``` look at the events ``` {&quot;status&quot;:&quot;untag&quot;,&quot;id&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;,&quot;Type&quot;:&quot;image&quot;,&quot;Action&quot;:&quot;untag&quot;,&quot;Actor&quot;:{&quot;ID&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;,&quot;Attributes&quot;:{&quot;name&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;}},&quot;scope&quot;:&quot;local&quot;,&quot;time&quot;:1661444877,&quot;timeNano&quot;:1661444877274518985} {&quot;status&quot;:&quot;untag&quot;,&quot;id&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;,&quot;Type&quot;:&quot;image&quot;,&quot;Action&quot;:&quot;untag&quot;,&quot;Actor&quot;:{&quot;ID&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;,&quot;Attributes&quot;:{&quot;name&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;}},&quot;scope&quot;:&quot;local&quot;,&quot;time&quot;:1661444877,&quot;timeNano&quot;:1661444877278753809} {&quot;status&quot;:&quot;delete&quot;,&quot;id&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;,&quot;Type&quot;:&quot;image&quot;,&quot;Action&quot;:&quot;delete&quot;,&quot;Actor&quot;:{&quot;ID&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;,&quot;Attributes&quot;:{&quot;name&quot;:&quot;sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;}},&quot;scope&quot;:&quot;local&quot;,&quot;time&quot;:1661444877,&quot;timeNano&quot;:1661444877436313927} ``` 2. Now, try with podman pull httpd image ``` $ podman pull httpd Resolving &quot;httpd&quot; using unqualified-search registries (/etc/containers/registries.conf.d/999-podman-machine.conf) Trying to pull docker.io/library/httpd:latest... Getting image source signatures Copying blob sha256:152876b0d24a5561415915c652dceeb3bcd5080dc24c3994e77343a81f64b9f1 Copying blob sha256:7a6db449b51b92eac5c81cdbd82917785343f1664b2be57b22337b0a40c5b29d Copying blob sha256:b4effd428409f1da4dc8c896afb9818ef1ba24be5e7e5e3d86dea650ac3ed8bc Copying blob sha256:6b29c2b62286e254216da297b4066a4bb79b918bc02811ba954bd7b8fd51360b Copying blob sha256:c2123effa3fcb96c62bf4d891147aef09029d429321bfb4c6a535fa3ca7e13d6 Copying config sha256:a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825 Writing manifest to image destination Storing signatures a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825 ``` Track events in a separate terminal ``` $ curl --unix-socket /Users/benoitf/.local/share/containers/podman/machine/podman-machine-default/podman.sock http:/v1.41/events ``` remove the image ``` $ podman rmi a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825 ``` Untagged: docker.io/library/httpd:latest Deleted: a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825 look at events ``` {&quot;status&quot;:&quot;remove&quot;,&quot;id&quot;:&quot;a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;,&quot;Type&quot;:&quot;image&quot;,&quot;Action&quot;:&quot;remove&quot;,&quot;Actor&quot;:{&quot;ID&quot;:&quot;a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;,&quot;Attributes&quot;:{&quot;containerExitCode&quot;:&quot;0&quot;,&quot;image&quot;:&quot;&quot;,&quot;name&quot;:&quot;a981c8992512d65c9b450a9ecabb1cb9d35bb6b03f3640f86471032d5800d825&quot;}},&quot;scope&quot;:&quot;local&quot;,&quot;time&quot;:1661444997,&quot;timeNano&quot;:1661444997046721781,&quot;HealthStatus&quot;:&quot;&quot;} ``` we are missing the `untag` event and we receive a `remove` event instead of `delete` **Describe the results you received:** receive `remove` **Describe the results you expected:** expect `untag` + `delete` events **Additional information you deem important (e.g. issue happens only occasionally):** **Output of `podman version`:** ``` Client: Podman Engine Version: 4.2.0 API Version: 4.2.0 Go Version: go1.18.5 Built: Wed Aug 10 22:46:05 2022 OS/Arch: darwin/amd64 Server: Podman Engine Version: 4.2.0 API Version: 4.2.0 Go Version: go1.18.4 Built: Thu Aug 11 16:42:17 2022 OS/Arch: linux/amd64 ``` **Output of `podman info`:** ``` (paste your output here) ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` (paste your output here) ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes/No **Additional environment details (AWS, VirtualBox, physical, etc.):**</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #15480 from lsm5/tmp-revert-packit Temporarily Revert &quot;Packit: Enable scratch build testing for Fedora 36, 37 and Rawhide&quot;</MESSAGE>
    <SHA>f98215c668746e9a7b9603448428cd1301a56eac</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Compat API image remove events now have 'delete' status Change only the compat API, so we don't force a breaking change on Libpod API users. Partial fix for #15485 Signed-off-by: Matthew Heon &lt;matthew.heon@pm.me&gt;</MESSAGE>
      <SHA>c7fda06f669ab1be6b36aa3312c6c6d732e06c9b</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/events.go</FILE>
        <FILE>test/apiv2/10-images.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman rmi: emit untag events Emit untag events for each tag when removing an image. Fixes: #15485 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>0ee9a3129b312e0a40b2e78e97ee356205495333</SHA>
      <PATCHEDFILES>
        <FILE>go.mod</FILE>
        <FILE>go.sum</FILE>
        <FILE>test/system/090-events.bats</FILE>
        <FILE>vendor/github.com/containers/common/libimage/image.go</FILE>
        <FILE>vendor/modules.txt</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Compat API image remove events now have 'delete' status Change only the compat API, so we don't force a breaking change on Libpod API users. Partial fix for #15485 Signed-off-by: Matthew Heon &lt;matthew.heon@pm.me&gt;</MESSAGE>
      <SHA>063f332416c16532ada2465c3be53f1d4d8c8966</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/events.go</FILE>
        <FILE>test/apiv2/10-images.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
