<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14493</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14493</ISSUEURL>
  <TITLE>Docker Compose health check disable flag is not handled correctly</TITLE>
  <DESCRIPTION>**Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** Podman seems to ignore the `healthcheck` disable flag set via Docker Compose. **Steps to reproduce the issue:** 1. Setup Podman service (to emulate a Docker socket). 2. Create a Docker Compose service for a container that has healthchecks defined and then disable them using `healthcheck` (example): ```yaml version: &quot;3.7&quot; dashy: image: docker.io/lissy93/dashy:latest container_name: dashy volumes: - /var/volumes/dashy:/app/public ports: - &quot;4000:80&quot; restart: unless-stopped healthcheck: disable: true ``` **Describe the results you received:** Health checks are not disabled properly. Inspecting the container (for example: `podman inspect dashy`): ```json &quot;Healthcheck&quot;:{ &quot;Test&quot;:[ &quot;CMD-SHELL&quot;, &quot;NONE&quot; ], &quot;Interval&quot;:30000000000, &quot;Timeout&quot;:30000000000, &quot;Retries&quot;:3 } ``` If we remove the `healthcheck` section from the service definition, we see the default healthcheck, as expected: ```json &quot;Healthcheck&quot;:{ &quot;Test&quot;:[ &quot;CMD-SHELL&quot;, &quot;yarn health-check&quot; ], &quot;StartPeriod&quot;:30000000000, &quot;Interval&quot;:300000000000, &quot;Timeout&quot;:2000000000 } ``` **Describe the results you expected:** When we run the same container directly using the Podman CLI and pass in `--no-healthcheck`, we get the desired behavior: ``` $ sudo podman run --no-healthcheck -d -v /var/volumes/dashy:/app/public docker.io/lissy93/dashy:latest $ podman inspect [...] ... &quot;Healthcheck&quot;:{ &quot;Test&quot;:[ &quot;NONE&quot; ] } ``` The Docker Compose `healthcheck` disable flag should be handled the same way. **Output of `podman version`:** ``` Version: 3.4.2 API Version: 3.4.2 Go Version: go1.15.2 Built: Wed Dec 31 19:00:00 1969 OS/Arch: linux/amd64 ``` **Output of `podman info --debug`:** ``` host: arch: amd64 buildahVersion: 1.23.1 cgroupControllers: - cpuset - cpu - cpuacct - blkio - memory - devices - freezer - net_cls - perf_event - net_prio - hugetlb - pids - rdma cgroupManager: systemd cgroupVersion: v1 conmon: package: 'conmon: /usr/libexec/podman/conmon' path: /usr/libexec/podman/conmon version: 'conmon version 2.0.30, commit: ' cpus: 8 distribution: codename: focal distribution: ubuntu version: &quot;20.04&quot; eventLogger: journald hostname: nabeul idMappings: gidmap: null uidmap: null kernel: 5.4.0-113-generic linkmode: dynamic logDriver: journald memFree: 3881971712 memTotal: 12260155392 ociRuntime: name: crun package: 'crun: /usr/bin/crun' path: /usr/bin/crun version: |- crun version UNKNOWN commit: ea1fe3938eefa14eb707f1d22adff4db670645d6 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: true capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: 'slirp4netns: /usr/bin/slirp4netns' version: |- slirp4netns version 1.1.8 commit: unknown libslirp: 4.3.1-git SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.4.3 swapFree: 0 swapTotal: 0 uptime: 6h 15m 45.9s (Approximately 0.25 days) plugins: log: - k8s-file - none - journald network: - bridge - macvlan volume: - local registries: search: - docker.io - quay.io store: configFile: /etc/containers/storage.conf containerStore: number: 18 paused: 0 running: 14 stopped: 4 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;true&quot; imageStore: number: 20 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 3.4.2 Built: 0 BuiltTime: Wed Dec 31 19:00:00 1969 GitCommit: &quot;&quot; GoVersion: go1.15.2 OsArch: linux/amd64 Version: 3.4.2 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` Listing... Done podman/unknown,now 100:3.4.2-5 amd64 [installed] podman/unknown 100:3.4.2-5 arm64 podman/unknown 100:3.4.2-5 armhf podman/unknown 100:3.4.2-5 s390x ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes - also tested with a version built manually: ``` Client: Podman Engine Version: 4.0.0-dev API Version: 4.0.0-dev Go Version: go1.16.5 Git Commit: b1d37a7e21bfb3e12af2e7cee25dc88ac4f148dd-dirty Built: Mon Dec 31 19:00:00 1979 OS/Arch: linux/amd64 ``` **Additional environment details (AWS, VirtualBox, physical, etc.):** Running in KVM on Proxmox.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>29</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14521 from cevich/fix_build_dep Cirrus: Fix artifact passing when dep. skipped</MESSAGE>
    <SHA>b34cba6cd53cfd4df58f2b26d3e5a6be86dfb132</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Docker-compose disable healthcheck properly handled Previously, if a container had healthchecks disabled in the docker-compose.yml file and the user did a `podman inspect &lt;container&gt;`, they would have an incorrect output: ``` &quot;Healthcheck&quot;:{ &quot;Test&quot;:[ &quot;CMD-SHELL&quot;, &quot;NONE&quot; ], &quot;Interval&quot;:30000000000, &quot;Timeout&quot;:30000000000, &quot;Retries&quot;:3 } ``` After a quick change, the correct output is now the result: ``` &quot;Healthcheck&quot;:{ &quot;Test&quot;:[ &quot;NONE&quot; ] } ``` Additionally, I extracted the hard-coded strings that were used for comparisons into constants in `libpod/define` to prevent a similar issue from recurring. Closes: #14493 Signed-off-by: Jake Correnti &lt;jcorrenti13@gmail.com&gt;</MESSAGE>
      <SHA>c81454673343f17fb9c3059bd864d824dbb09ce1</SHA>
      <PATCHEDFILES>
        <FILE>libpod/define/healthchecks.go</FILE>
        <FILE>libpod/healthcheck.go</FILE>
        <FILE>pkg/specgen/generate/kube/kube.go</FILE>
        <FILE>pkg/specgenutil/specgen.go</FILE>
        <FILE>test/compose/disable_healthcheck/docker-compose.yml</FILE>
        <FILE>test/compose/disable_healthcheck/tests.sh</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Docker-compose disable healthcheck properly handled Previously, if a container had healthchecks disabled in the docker-compose.yml file and the user did a `podman inspect &lt;container&gt;`, they would have an incorrect output: ``` &quot;Healthcheck&quot;:{ &quot;Test&quot;:[ &quot;CMD-SHELL&quot;, &quot;NONE&quot; ], &quot;Interval&quot;:30000000000, &quot;Timeout&quot;:30000000000, &quot;Retries&quot;:3 } ``` After a quick change, the correct output is now the result: ``` &quot;Healthcheck&quot;:{ &quot;Test&quot;:[ &quot;NONE&quot; ] } ``` Additionally, I extracted the hard-coded strings that were used for comparisons into constants in `libpod/define` to prevent a similar issue from recurring. Closes: #14493 Signed-off-by: Jake Correnti &lt;jcorrenti13@gmail.com&gt;</MESSAGE>
      <SHA>5633ef1d15c17fa2e0249710c7591da777cd7b5e</SHA>
      <PATCHEDFILES>
        <FILE>libpod/define/healthchecks.go</FILE>
        <FILE>libpod/healthcheck.go</FILE>
        <FILE>pkg/specgen/generate/kube/kube.go</FILE>
        <FILE>pkg/specgenutil/specgen.go</FILE>
        <FILE>test/compose/disable_healthcheck/docker-compose.yml</FILE>
        <FILE>test/compose/disable_healthcheck/tests.sh</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
