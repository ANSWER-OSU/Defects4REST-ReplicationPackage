<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>18384</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/18384</ISSUEURL>
  <TITLE>podman play kube fails to launch initContainers without a PATH in the environment</TITLE>
  <DESCRIPTION>### Issue Description It appears that `podman play kube` is not able to handle a `initContainers` in a deployment where the image has no `PATH` defined in `Config.Env`. E.g. the following deployment fails to launch: ```yaml --- apiVersion: apps/v1 kind: Deployment metadata: name: rmt-front spec: template: spec: containers: - name: &quot;rmt-front&quot; image: &quot;registry.suse.com/suse/rmt-nginx:1.19&quot; imagePullPolicy: Always initContainers: - name: &quot;rmt-front-init&quot; image: &quot;registry.suse.com/bci/bci-micro:15.3&quot; imagePullPolicy: Always command: ['sh', '-c', 'echo foo'] ``` You get the following error: ```ShellSession ❯ podman play kube /tmp/podman-play/rmt-app.yml Trying to pull registry.suse.com/bci/bci-micro:15.3... Getting image source signatures Copying blob 534639c69224 skipped: already exists Copying config 0ddf45aab0 done Writing manifest to image destination Storing signatures Trying to pull registry.suse.com/suse/rmt-nginx:1.19... Getting image source signatures Copying blob 7448fc1a6468 skipped: already exists Copying blob a8e7a8d5a3ff skipped: already exists Copying config 2e5e2fc16e done Writing manifest to image destination Storing signatures Error: encountered while bringing up pod rmt-front-pod: crun: executable file `sh` not found in $PATH: No such file or directory: OCI runtime attempted to invoke a command that was not found ``` However, if you swap out ` &quot;registry.suse.com/bci/bci-micro:15.3&quot;` for e.g. `&quot;docker.io/busybox&quot;`, then everything works. The difference is that `registry.suse.com/bci/bci-micro:15.3` has not been built via docker, but with kiwi and has no `PATH` entry in `Config.Env`: ```ShellSession ❯ podman inspect -f {{.Config.Env}} registry.suse.com/bci/bci-micro:15.3 [] ❯ podman inspect -f {{.Config.Env}} docker.io/busybox [PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin] ``` Also, the missing PATH entry is not the actual problem, because if I try to emulate what `podman play kube` does internally with `initContainers` (see https://github.com/containers/podman/blob/19152fa349199e88212aa9607c27139730d1710b/pkg/specgen/generate/kube/kube.go#L337), i.e. set `CMD` to nil and `ENTRYPOINT` to `CMD` as follows, everything still works: ```ShellSession ❯ podman run --rm --entrypoint '[&quot;sh&quot;, &quot;-c&quot;, &quot;echo hello&quot;]' registry.suse.com/bci/bci-base:15.3 hello ``` ### Steps to reproduce the issue Steps to reproduce the issue 1. create the above yaml snippet 2. run `podman play kube /path/to/yaml` ### Describe the results you received Error: encountered while bringing up pod rmt-front-pod: crun: executable file `sh` not found in $PATH: No such file or directory: OCI runtime attempted to invoke a command that was not found ### Describe the results you expected The first `initContainers` should have been created. ### podman info output ```yaml I think this is irrelevant, but for completeness: host: arch: amd64 buildahVersion: 1.30.0 cgroupControllers: - cpu - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.7-2.fc38.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.7, commit: ' cpuUtilization: idlePercent: 87.91 systemPercent: 1.98 userPercent: 10.11 cpus: 16 databaseBackend: boltdb distribution: distribution: fedora version: &quot;38&quot; eventLogger: journald hostname: Skirnir idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 10000 size: 65536 - container_id: 65537 host_id: 524288 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 10000 size: 65536 - container_id: 65537 host_id: 524288 size: 65536 kernel: 6.2.12-300.fc38.x86_64 linkmode: dynamic logDriver: journald memFree: 3897225216 memTotal: 33354240000 networkBackend: netavark ociRuntime: name: crun package: crun-1.8.3-2.fc38.x86_64 path: /usr/bin/crun version: |- crun version 1.8.3 commit: 59f2beb7efb0d35611d5818fd0311883676f6f7e rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux remoteSocket: path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-12.fc38.x86_64 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.3 swapFree: 8579444736 swapTotal: 8589930496 uptime: 20h 16m 52.00s (Approximately 0.83 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io - quay.io - registry.suse.com store: configFile: /home/dan/.config/containers/storage.conf containerStore: number: 3 paused: 0 running: 1 stopped: 2 graphDriverName: overlay graphOptions: {} graphRoot: /home/dan/.local/share/containers/storage graphRootAllocated: 510389125120 graphRootUsed: 180980338688 graphStatus: Backing Filesystem: btrfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 257 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/dan/.local/share/containers/storage/volumes version: APIVersion: 4.5.0 Built: 1681486942 BuiltTime: Fri Apr 14 17:42:22 2023 GitCommit: &quot;&quot; GoVersion: go1.20.2 Os: linux OsArch: linux/amd64 Version: 4.5.0 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details I have tried this with 4.5.0 and with the current HEAD (19152fa349199e88212aa9607c27139730d1710b) ### Additional information _No response_</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #18441 from Luap99/remote-connect-err remote: return better connect error</MESSAGE>
    <SHA>b98960d1cb8b12c672296ffe0d627b760759e6eb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Run generate.CompleteSpec() for initContainers as well initContainers in kubernetes deployments had no call to CompleteSpec in the generation, which means that the default environment is not configured for these. This causes issues with missing default environment variables like $HOME or $PÄTH. Also, switch to using logrus.Warn() instead of fmt.Fprintf(os.Stderr) This fixes https://github.com/containers/podman/issues/18384 Co-authored-by: Ed Santiago &lt;santiago@redhat.com&gt; Signed-off-by: Dan Čermák &lt;dcermak@suse.com&gt;</MESSAGE>
      <SHA>75d92f41d8da81bcae87dcebe34282c19e700a1d</SHA>
      <PATCHEDFILES>
        <FILE>pkg/domain/infra/abi/play.go</FILE>
        <FILE>test/e2e/play_kube_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
