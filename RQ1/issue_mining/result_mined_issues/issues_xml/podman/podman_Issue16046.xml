<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>16046</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/16046</ISSUEURL>
  <TITLE>create --init-ctr once: once again, seems to be incorrectly running</TITLE>
  <DESCRIPTION>Another init-ctr flake; it actually looks identical to #11682 except for the warning, which is new: ``` podman make sure once container is removed /var/tmp/go/src/github.com/containers/podman/test/e2e/pod_initcontainers_test.go:100 [BeforeEach] Podman init containers /var/tmp/go/src/github.com/containers/podman/test/e2e/pod_initcontainers_test.go:22 [It] podman make sure once container is removed /var/tmp/go/src/github.com/containers/podman/test/e2e/pod_initcontainers_test.go:100 $ podman [options] create --init-ctr once --pod new:foobar quay.io/libpod/alpine:latest bin/sh -c echo AjWwhTHctcuAxhxK &gt; /dev/shm/XVlBzgbaiCMR SHA1 $ podman [options] create --pod foobar -t quay.io/libpod/alpine:latest top SHA2 $ podman [options] pod start foobar time=&quot;2022-09-29T01:38:01Z&quot; level=error msg=&quot;Removing container SHA1 from database: no container with ID SHA1 found in DB: no such container&quot; SHA3 $ podman [options] container exists SHA1 $ podman [options] pod stop foobar SHA3 $ podman [options] pod start foobar SHA3 $ podman [options] exec -it SHA2 cat /dev/shm/XVlBzgbaiCMR AjWwhTHctcuAxhxK &lt;&lt;&lt;&lt;------ UNEXPECTED! This causes test to fail, because this file should not exist ``` Only two instances in the past month; before that, May. ### Podman init containers [It] podman make sure once container is removed * fedora-36 : int podman fedora-36 root container * PR #15753 * [09-12 18:21](https://api.cirrus-ci.com/v1/artifact/task/4883521108967424/html/int-podman-fedora-36-root-container.log.html#t--podman-make-sure-once-container-is-removed--1) * ubuntu-2204 : int podman ubuntu-2204 rootless host * PR #13808 * [09-28 21:46](https://api.cirrus-ci.com/v1/artifact/task/5938777561497600/html/int-podman-ubuntu-2204-rootless-host.log.html#t--podman-make-sure-once-container-is-removed--1)</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #15988 from sstosh/manifest-annotate-remote remote: fix manifest add --annotation</MESSAGE>
    <SHA>f52feded3ce6c1ad2af046ab774fbc2b9c832487</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Clean up when stopping pods We have a test to verify that init containers in pods are deleted when the `--init-ctr=once` option is specified. The test creates two containers, one of them an init container, starts the pod, stops the pod, and restarts the pod, checking for the presence of a file created by the init container during the second start. We're seeing a race where the file still exists, which I'm fairly certain comes down to the SHM mount not being cleaned up after the pod is stopped. Fortunately, we already have code to do this - just flip the bool that controls cleanup from false to true. [NO NEW TESTS NEEDED] Fixes a difficult to reproduce race condition. Fixes #16046 Signed-off-by: Matthew Heon &lt;mheon@redhat.com&gt;</MESSAGE>
      <SHA>e136376d1f898303fb059cad729e2d65578a4c8c</SHA>
      <PATCHEDFILES>
        <FILE>pkg/domain/infra/abi/pods.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Clean up when stopping pods We have a test to verify that init containers in pods are deleted when the `--init-ctr=once` option is specified. The test creates two containers, one of them an init container, starts the pod, stops the pod, and restarts the pod, checking for the presence of a file created by the init container during the second start. We're seeing a race where the file still exists, which I'm fairly certain comes down to the SHM mount not being cleaned up after the pod is stopped. Fortunately, we already have code to do this - just flip the bool that controls cleanup from false to true. [NO NEW TESTS NEEDED] Fixes a difficult to reproduce race condition. Fixes #16046 Signed-off-by: Matthew Heon &lt;mheon@redhat.com&gt;</MESSAGE>
      <SHA>640eac4659e0bb5ed2df4e62a215a43c28ed792e</SHA>
      <PATCHEDFILES>
        <FILE>pkg/domain/infra/abi/pods.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
