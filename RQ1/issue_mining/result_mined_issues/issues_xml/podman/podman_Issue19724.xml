<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>19724</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/19724</ISSUEURL>
  <TITLE>sdnotify healthcheck test: not seeing READY=1</TITLE>
  <DESCRIPTION>Infrequent but nontrivial flake: ``` [+1339s] not ok 398 sdnotify : healthy ... # podman healthcheck run drdkiraaWq drdkiraaWq socat log: MAINPID=158209 #/vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv #| FAIL: podman healthcheck run drdkiraaWq #| expected: 'MAINPID=158209 READY=1' #| actual: 'MAINPID=158209' #\^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ``` I thought I had a smoking gun! Every one of the failures shows this in the journal: ``` Aug 17 09:07:21 cirrus-task-xxx conmon[158249]: conmon yyy &lt;error&gt;: Unable to send container stderr message to parent Broken pipe ``` But of course as a responsible human being I checked the base rate. And that message happens *hundreds* of times in CI runs, including successful CI runs. Maybe worth filing, maybe not, right now I'm sweeping that under the rug. I've reviewed the test itself in painful details and can't find any logic problems. There is a possible race, the delay between `READY=1` getting sent through `socat`. I can't think of a reliable way to check or fix that. Filing because I give up. Have wasted too much time on it by now with nothing to show for it. * fedora-38 : sys podman fedora-38 root host boltdb * PR #19444 * [07-31 09:15](https://api.cirrus-ci.com/v1/artifact/task/5721854241931264/html/sys-podman-fedora-38-root-host-boltdb.log.html#t--00394) * fedora-38 : sys podman fedora-38 root host sqlite * PR #19661 * [08-17 10:16](https://api.cirrus-ci.com/v1/artifact/task/6295180769230848/html/sys-podman-fedora-38-root-host-sqlite.log.html#t--00398) * PR #19425 * [08-04 09:36](https://api.cirrus-ci.com/v1/artifact/task/4753931369185280/html/sys-podman-fedora-38-root-host-sqlite.log.html#t--00396)</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #19733 from edsantiago/registry_282 e2e tests: use registry:2.8.2 (was 2.8)</MESSAGE>
    <SHA>0322b9df9d94605fad0c50e0b599138678a5a06e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>system tests: try to fix sdnotify flakes Unexplained infrequent flakes in sdnotify system tests, waiting for READY=1. Hypothesis: race condition between the container sending the READY string and that string making it through conmon and socat into the log file. Solution: don't just check once; keep trying in a loop. Write a reusable wait_for_file_content() helper function, and clean up a bunch more tests as long as we're at it. Fixes: #19724 Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>d898ae7f9c6c0ef6a6f30d9336fb248bd93c93e1</SHA>
      <PATCHEDFILES>
        <FILE>test/system/260-sdnotify.bats</FILE>
        <FILE>test/system/helpers.bash</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
