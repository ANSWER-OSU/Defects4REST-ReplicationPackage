<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>25610</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/25610</ISSUEURL>
  <TITLE>Groups for root user not applied during podman exec when no explicit user specified</TITLE>
  <DESCRIPTION>### Issue Description Under certain conditions - specifically when the container relies on an implicit root user for each step - the Linux groups added to the root user in the Dockerfile do not apply to an interactive shell session started with podman exec -it ... /bin/sh. This issue also impacts any groups defined in the base image. I am only able to reproduce this issue when the following conditions are met: - Building from a Dockerfile WITHOUT any **USER** directive - Podman run the image WITHOUT the **--user** parameter - Podman exec into the running container WITHOUT the **--user** parameter Note: As soon as I add --user or the USER directive at any step I cannot reproduce this issue anymore. ### Steps to reproduce the issue Steps to reproduce the issue 1. Create a Dockerfile with the following content: ```Dockerfile FROM alpine # for capsh --print RUN apk add libcap RUN addgroup -S appgroup &amp;&amp; \ adduser -S appuser -G appgroup &amp;&amp; \ addgroup root appgroup ``` 2. Build the image ``` podman build . ``` 3. Run the container (without the --user parameter). ``` podman run -itd $IMAGE /bin/sh ``` 4. Exec into the container (without the --user parameter). ```sh podman exec -it $CONTAINER /bin/sh ``` 5. Verify that the root user does not have any group memberships in the current shell session: ```sh # In the container capsh --print | grep groups ``` ### Describe the results you received ``` / # capsh --print | grep groups groups= ``` ### Describe the results you expected ``` / # capsh --print | grep groups groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video),101(appgroup) ``` ### podman info output ```yaml Client: Podman Engine Version: 5.5.0-dev API Version: 5.5.0-dev Go Version: go1.22.9 (Red Hat 1.22.9-2.el9_5) Git Commit: 5eeaa437286c84ee29339911e68ec7957161b231 Built: Tue Mar 11 01:00:00 2025 Build Origin: Copr: rhcontainerbot/podman-next OS/Arch: linux/s390x ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release Yes ### Additional environment details _No response_ ### Additional information _No response_</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #25611 from containers/renovate/github.com-opencontainers-runc-1.x fix(deps): update module github.com/opencontainers/runc to v1.2.6</MESSAGE>
    <SHA>98de6f3c10e56ddb775358b8d166a2c4b41fda11</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>libpod: fix handling of additional gids in exec change the behavior to match what Docker does. Docker always adds the specified additional gids, no matter the user specified to exec. Instead the additional gids read from the /etc/group file are added only when there is not an explicit group specified in the exec userspec. ➜ docker run -d --name container-with-groups --group-add mail --group-add news --group-add cron --group-add ftp --rm alpine top c4190928097f64cabb83af7cac6ec10041a9e74de359433dfd3e5b9d8a7dce1a ➜ docker exec container-with-groups id -G 0 1 2 3 4 6 10 11 12 13 16 20 21 26 27 ➜ docker exec --user root container-with-groups id -G 0 1 2 3 4 6 10 11 12 13 16 20 21 26 27 ➜ docker exec --user nobody container-with-groups id -G 65534 12 13 16 21 ➜ docker exec --user nobody:nobody container-with-groups id -G 65534 12 13 16 21 ➜ docker exec --user root:root container-with-groups id -G 0 12 13 16 21 ➜ docker exec --user root:root container-with-groups id -G 0 12 13 16 21 Closes: https://github.com/containers/podman/issues/25610 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
      <SHA>51ca839c1478943232fe4cc6daec072ff79e2ae5</SHA>
      <PATCHEDFILES>
        <FILE>libpod/oci_conmon_exec_common.go</FILE>
        <FILE>test/system/075-exec.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
