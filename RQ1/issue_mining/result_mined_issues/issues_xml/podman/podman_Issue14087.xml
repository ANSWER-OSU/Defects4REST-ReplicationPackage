<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14087</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14087</ISSUEURL>
  <TITLE>failed to pull image when use system proxy</TITLE>
  <DESCRIPTION>**Description** **In China we have to use proxy to access docker hub to pull image** proxy setting (**this works fine in docker**) `http_proxy=socks5://127.0.0.1:7890` access test, success to resolve **docker.io** ``` bash curl -vv registry-1.docker.io * Uses proxy env variable http_proxy == 'socks5://127.0.0.1:7890' * Trying 127.0.0.1:7890... * SOCKS5 connect to IPv4 34.237.244.67:80 (locally resolved) * SOCKS5 request granted. * Connected to 127.0.0.1 (127.0.0.1) port 7890 (#0) &gt; GET / HTTP/1.1 &gt; Host: registry-1.docker.io &gt; User-Agent: curl/7.79.1 &gt; Accept: */* &gt; * Mark bundle as not supporting multiuse &lt; HTTP/1.1 301 Moved Permanently &lt; content-length: 0 &lt; location: https://registry-1.docker.io/ &lt; * Connection #0 to host 127.0.0.1 left intact ``` or (success when use podman login) ``` bash podman login docker.io -u y0zong Password: ``` but connection refused when pull image ``` bash podman-compose -f docker-compose.yml -f docker-compose.without-nginx.yml up -d ['podman', '--version', ''] using podman version: 4.0.2 ** merged: { &quot;_dirname&quot;: &quot;/Users/orlowang/Projects/tools/matttermost&quot;, &quot;version&quot;: &quot;2.4&quot;, &quot;services&quot;: { &quot;postgres&quot;: { &quot;container_name&quot;: &quot;postgres_mattermost&quot;, &quot;image&quot;: &quot;postgres:13-alpine&quot;, &quot;restart&quot;: &quot;unless-stopped&quot;, &quot;security_opt&quot;: [ &quot;no-new-privileges:true&quot; ], &quot;pids_limit&quot;: 100, &quot;read_only&quot;: true, &quot;tmpfs&quot;: [ &quot;/tmp&quot;, &quot;/var/run/postgresql&quot; ], &quot;volumes&quot;: [ &quot;./volumes/db/var/lib/postgresql/data:/var/lib/postgresql/data&quot; ], &quot;environment&quot;: { &quot;TZ&quot;: null, &quot;POSTGRES_USER&quot;: null, &quot;POSTGRES_PASSWORD&quot;: null, &quot;POSTGRES_DB&quot;: null } }, &quot;mattermost&quot;: { &quot;depends_on&quot;: [ &quot;postgres&quot; ], &quot;container_name&quot;: &quot;mattermost&quot;, &quot;image&quot;: &quot;mattermost/mattermost-enterprise-edition:6.3&quot;, &quot;restart&quot;: &quot;unless-stopped&quot;, &quot;security_opt&quot;: [ &quot;no-new-privileges:true&quot; ], &quot;pids_limit&quot;: 200, &quot;read_only&quot;: &quot;false&quot;, &quot;tmpfs&quot;: [ &quot;/tmp&quot; ], &quot;volumes&quot;: [ &quot;./volumes/app/mattermost/config:/mattermost/config:rw&quot;, &quot;./volumes/app/mattermost/data:/mattermost/data:rw&quot;, &quot;./volumes/app/mattermost/logs:/mattermost/logs:rw&quot;, &quot;./volumes/app/mattermost/plugins:/mattermost/plugins:rw&quot;, &quot;./volumes/app/mattermost/client/plugins:/mattermost/client/plugins:rw&quot;, &quot;./volumes/app/mattermost/bleve-indexes:/mattermost/bleve-indexes:rw&quot; ], &quot;environment&quot;: { &quot;TZ&quot;: null, &quot;MM_SQLSETTINGS_DRIVERNAME&quot;: null, &quot;MM_SQLSETTINGS_DATASOURCE&quot;: null, &quot;MM_BLEVESETTINGS_INDEXDIR&quot;: null, &quot;MM_SERVICESETTINGS_SITEURL&quot;: null }, &quot;ports&quot;: [ &quot;8065:8065&quot; ] } } } ** excluding: set() ['podman', 'network', 'exists', 'matttermost_default'] podman run --name=postgres_mattermost -d --security-opt no-new-privileges:true --read-only --label io.podman.compose.config-hash=123 --label io.podman.compose.project=matttermost --label io.podman.compose.version=0.0.1 --label com.docker.compose.project=matttermost --label com.docker.compose.project.working_dir=/Users/orlowang/Projects/tools/matttermost --label com.docker.compose.project.config_files=docker-compose.yml,docker-compose.without-nginx.yml --label com.docker.compose.container-number=1 --label com.docker.compose.service=postgres -e TZ -e POSTGRES_USER -e POSTGRES_PASSWORD -e POSTGRES_DB --tmpfs /tmp --tmpfs /var/run/postgresql -v /Users/orlowang/Projects/tools/matttermost/volumes/db/var/lib/postgresql/data:/var/lib/postgresql/data --net matttermost_default --network-alias postgres --restart unless-stopped postgres:13-alpine Resolving &quot;postgres&quot; using unqualified-search registries (/etc/containers/registries.conf.d/999-podman-machine.conf) Trying to pull docker.io/library/postgres:13-alpine... Error: initializing source docker://postgres:13-alpine: pinging container registry registry-1.docker.io: Get &quot;https://registry-1.docker.io/v2/&quot;: proxyconnect tcp: dial tcp 127.0.0.1:7890: connect: connection refused exit code: 125 podman start postgres_mattermost Error: no container with name or ID &quot;postgres_mattermost&quot; found: no such container exit code: 125 ['podman', 'network', 'exists', 'matttermost_default'] podman run --name=mattermost -d --security-opt no-new-privileges:true --read-only --label io.podman.compose.config-hash=123 --label io.podman.compose.project=matttermost --label io.podman.compose.version=0.0.1 --label com.docker.compose.project=matttermost --label com.docker.compose.project.working_dir=/Users/orlowang/Projects/tools/matttermost --label com.docker.compose.project.config_files=docker-compose.yml,docker-compose.without-nginx.yml --label com.docker.compose.container-number=1 --label com.docker.compose.service=mattermost -e TZ -e MM_SQLSETTINGS_DRIVERNAME -e MM_SQLSETTINGS_DATASOURCE -e MM_BLEVESETTINGS_INDEXDIR -e MM_SERVICESETTINGS_SITEURL --tmpfs /tmp -v /Users/orlowang/Projects/tools/matttermost/volumes/app/mattermost/config:/mattermost/config:rw -v /Users/orlowang/Projects/tools/matttermost/volumes/app/mattermost/data:/mattermost/data:rw -v /Users/orlowang/Projects/tools/matttermost/volumes/app/mattermost/logs:/mattermost/logs:rw -v /Users/orlowang/Projects/tools/matttermost/volumes/app/mattermost/plugins:/mattermost/plugins:rw -v /Users/orlowang/Projects/tools/matttermost/volumes/app/mattermost/client/plugins:/mattermost/client/plugins:rw -v /Users/orlowang/Projects/tools/matttermost/volumes/app/mattermost/bleve-indexes:/mattermost/bleve-indexes:rw --net matttermost_default --network-alias mattermost -p 8065:8065 --restart unless-stopped mattermost/mattermost-enterprise-edition:6.3 Resolving &quot;mattermost/mattermost-enterprise-edition&quot; using unqualified-search registries (/etc/containers/registries.conf.d/999-podman-machine.conf) Trying to pull docker.io/mattermost/mattermost-enterprise-edition:6.3... Error: initializing source docker://mattermost/mattermost-enterprise-edition:6.3: pinging container registry registry-1.docker.io: Get &quot;https://registry-1.docker.io/v2/&quot;: proxyconnect tcp: dial tcp 127.0.0.1:7890: connect: connection refused exit code: 125 podman start mattermost Error: no container with name or ID &quot;mattermost&quot; found: no such container exit code: 125 ``` keypoint in error `pinging container registry registry-1.docker.io: Get &quot;https://registry-1.docker.io/v2/&quot;: proxyconnect tcp: dial tcp 127.0.0.1:7890: connect: connection refused` I don't know if podman use ping result to decide connection status, otherwise ping can be failed but connection is still alive when use socks5 proxy (that's why I use curl -vv test instead ping) pls help **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug (maybe) **Steps to reproduce the issue:** 1. set system proxy (http_proxy) 2. podman-compose start project **Additional information you deem important (e.g. issue happens only occasionally):** **Output of `podman version`:** ``` podman version Client: Podman Engine Version: 4.0.2 API Version: 4.0.2 Go Version: go1.17.8 Built: Wed Mar 2 22:04:36 2022 OS/Arch: darwin/amd64 Server: Podman Engine Version: 4.0.3 API Version: 4.0.3 Go Version: go1.18 Built: Sat Apr 2 02:21:54 2022 OS/Arch: linux/amd64 ``` **Output of `podman info --debug`:** ``` podman info --debug host: arch: amd64 buildahVersion: 1.24.3 cgroupControllers: - cpu - io - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.0-2.fc36.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.0, commit: ' cpus: 1 distribution: distribution: fedora variant: coreos version: &quot;36&quot; eventLogger: journald hostname: localhost.localdomain idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 1000000 uidmap: - container_id: 0 host_id: 502 size: 1 - container_id: 1 host_id: 100000 size: 1000000 kernel: 5.17.3-300.fc36.x86_64 linkmode: dynamic logDriver: journald memFree: 1363165184 memTotal: 2066817024 networkBackend: netavark ociRuntime: name: crun package: crun-1.4.4-1.fc36.x86_64 path: /usr/bin/crun version: |- crun version 1.4.4 commit: 6521fcc5806f20f6187eb933f9f45130c86da230 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: /run/user/502/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: true slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-0.2.beta.0.fc36.x86_64 version: |- slirp4netns version 1.2.0-beta.0 commit: 477db14a24ff1a3de3a705e51ca2c4c1fe3dda64 libslirp: 4.6.1 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.3 swapFree: 0 swapTotal: 0 uptime: 3h 10m 6.18s (Approximately 0.12 days) plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - docker.io store: configFile: /var/home/core/.config/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /var/home/core/.local/share/containers/storage graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 0 runRoot: /run/user/502/containers volumePath: /var/home/core/.local/share/containers/storage/volumes version: APIVersion: 4.0.3 Built: 1648837314 BuiltTime: Sat Apr 2 02:21:54 2022 GitCommit: &quot;&quot; GoVersion: go1.18 OsArch: linux/amd64 Version: 4.0.3 ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** mac os Monterey</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #18917 from Luap99/ip-range network create --ip-range allow for custom range</MESSAGE>
    <SHA>772f82ee67d4e947920b052f122761e90cfc7c5e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(machine): throw `connect: connection refused` after set proxy When the `machine start` command is executed, Podman automatically retrieves the current host's `*_PROXY` environment variable and assigns it directly to the virtual machine in QEMU. However, most `*_PROXY` variables are set with `127.0.0.1` or `localhost`, such as `127.0.0.1:8888`. This causes failures in network-related operations within the virtual machine due to incorrect proxy settings. Fixes: #14087 Signed-off-by: Black-Hole1 &lt;bh@bugs.cc&gt;</MESSAGE>
      <SHA>81e63227e66a2814b4539c4cc2226f1ee6177960</SHA>
      <PATCHEDFILES>
        <FILE>pkg/machine/ignition.go</FILE>
        <FILE>pkg/machine/qemu/machine_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
