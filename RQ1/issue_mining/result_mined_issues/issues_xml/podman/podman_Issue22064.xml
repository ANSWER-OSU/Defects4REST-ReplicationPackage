<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>22064</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/22064</ISSUEURL>
  <TITLE>Percentage values reported by `podman stats` can differ from calculated values for large and small values</TITLE>
  <DESCRIPTION>### Issue Description The values for percentage values reported by `podman stats` can differ from the calculated values (as reported by calls to the podman API). More specifically for very small (large) percentage values the command may report much larger (smaller) values. E.g. the command would report a value of `2.384087614310953e-07` as _2.38 %_. This issue was already posted before (with a narrower scope), but not yet solved: #16025. The reason for this seems to be a call to [`RemoveScientificNotationFromFloat`](https://github.com/containers/podman/blob/v5.0.0-rc7/utils/utils.go#L119) in `floatToPercentString` ([here](https://github.com/containers/podman/blob/v5.0.0-rc7/cmd/podman/containers/stats.go#L245) and [here](https://github.com/containers/podman/blob/v5.0.0-rc7/pkg/domain/infra/abi/pods_stats.go#L87)). This function (`RemoveScientificNotationFromFloat`) seems to - convert the float to a string with scientific notation (for values large or small enough), - then remove the exponent (e.g. &quot;2.384087614310953e-07&quot; becomes &quot;2.384087614310953&quot;) - convert the string back to a float. Note that the values are already _formatted_ without scientific notation by `floatToPercentString` and the call to `RemoveScientificNotationFromFloat` actually alters the _value_. I think the reason for altering the value should either be described better in the code or calls to the function `RemoveScientificNotationFromFloat` (and possibly the function itself) should be removed. My links are to code of v5.0.0-rc7 where the behavior seems still to be present. I observed small enough values to be affected for _AvgCPU_ with podman version 3.4.4 (just like the author of #16025). I am skipping all the following fields, as this issue should be understandable just by looking at the code. ### Steps to reproduce the issue - ### Describe the results you received - ### Describe the results you expected - ### podman info output ```yaml - ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release No ### Additional environment details _No response_ ### Additional information _No response_</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #22018 from containers/renovate/github.com-containers-ocicrypt-1.x fix(deps): update module github.com/containers/ocicrypt to v1.1.10</MESSAGE>
    <SHA>8d02d8a96b3ca1f866b8f715221efb167106abc5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>utils: drop conversion float-&gt;string-&gt;float remove unclear conversion to string to handle float precision. Closes: https://github.com/containers/podman/issues/22064 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
      <SHA>2566ee2f383312ae6088d1af3b2074b896700b84</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/containers/stats.go</FILE>
        <FILE>libpod/util_test.go</FILE>
        <FILE>pkg/domain/infra/abi/pods_stats.go</FILE>
        <FILE>utils/utils.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
