<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>22844</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/22844</ISSUEURL>
  <TITLE>windows: system connection: unexpected ports</TITLE>
  <DESCRIPTION>``` start machine with conflict on SSH port ... [FAILED] Expected &lt;[]string | len:4, cap:4&gt;: [&quot;50443&quot;, &quot;50443&quot;, &quot;50229&quot;, &quot;50229&quot;] &lt;&lt;&lt;&lt;&lt; 50443 is in there to contain element matching &lt;string&gt;: 50443 In [It] at: C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo[/pkg/machine/e2e/start_test.go:113](https://github.com/containers/podman/blob/1093ebb72be3117c5312b702ea89ecfcab5d3452/pkg/machine/e2e/start_test.go#L113) @ 05/28/24 12:52:44.223 ``` ~~Maybe it's a windows `^M` thing?~~ My misunderstanding. The error message means &quot;I want 50443 and **ONLY** 50443, nothing else&quot;. The 50229 is what's causing the problem. * windows : machine-hyperv podman windows rootless host sqlite * PR #22821 * [05-28 08:59](https://api.cirrus-ci.com/v1/artifact/task/6192583691468800/html/machine-hyperv-podman-windows-rootless-host-sqlite.log.html#t--podman-machine-start-C--Users-Administrator-AppData-Local-cirrus-ci-build-repo-pkg-machine-e2e-start_test-go-16-start-machine-with-conflict-on-SSH-port-C--Users-Administrator-AppData-Local-cirrus-ci-build-repo-pkg-machine-e2e-start_test-go-94--1) in podman machine start C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo/pkg/machine/e2e/start_test.go:16 start machine with conflict on SSH port C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo/pkg/machine/e2e/start_test.go:94 * PR #22815 * [05-27 07:03](https://api.cirrus-ci.com/v1/artifact/task/6039987328647168/html/machine-hyperv-podman-windows-rootless-host-sqlite.log.html#t--podman-machine-start-C--Users-Administrator-AppData-Local-cirrus-ci-build-repo-pkg-machine-e2e-start_test-go-16-start-machine-with-conflict-on-SSH-port-C--Users-Administrator-AppData-Local-cirrus-ci-build-repo-pkg-machine-e2e-start_test-go-94--1) in podman machine start C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo/pkg/machine/e2e/start_test.go:16 start machine with conflict on SSH port C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo/pkg/machine/e2e/start_test.go:94 * PR #22764 * [05-27 08:07](https://api.cirrus-ci.com/v1/artifact/task/4597051416117248/html/machine-hyperv-podman-windows-rootless-host-sqlite.log.html#t--podman-machine-start-C--Users-Administrator-AppData-Local-cirrus-ci-build-repo-pkg-machine-e2e-start_test-go-16-start-machine-with-conflict-on-SSH-port-C--Users-Administrator-AppData-Local-cirrus-ci-build-repo-pkg-machine-e2e-start_test-go-94--1) in podman machine start C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo/pkg/machine/e2e/start_test.go:16 start machine with conflict on SSH port C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo/pkg/machine/e2e/start_test.go:94 * PR #22757 * [05-20 11:21](https://api.cirrus-ci.com/v1/artifact/task/5092062477942784/html/machine-hyperv-podman-windows-rootless-host-sqlite.log.html#t--podman-machine-start-C--Users-Administrator-AppData-Local-cirrus-ci-build-repo-pkg-machine-e2e-start_test-go-16-start-machine-with-conflict-on-SSH-port-C--Users-Administrator-AppData-Local-cirrus-ci-build-repo-pkg-machine-e2e-start_test-go-94--1) in podman machine start C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo/pkg/machine/e2e/start_test.go:16 start machine with conflict on SSH port C:/Users/Administrator/AppData/Local/cirrus-ci-build/repo/pkg/machine/e2e/start_test.go:94 | x | x | x | x | x | x | | ---: | ---: | ---: | ---: | ---: | ---: | | machine-hyperv(4) | podman(4) | windows(4) | rootless(4) | host(4) | sqlite(4) |</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>33</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #23133 from Luap99/device-validation specgen: parse devices even with privileged set</MESSAGE>
    <SHA>672c6c87024feaeba724ba75729b7a8b818518c0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>pkg/machine/e2e: use tmp file for connections On linux and macos the connections are stored under the home dir by default so it is not a problem there but on windows we first check the APPDATA env and use this dir as config storage. This has the problem that it is not cleaned up after each test as such connections might leak into the following test causing failues there. Fixes #22844 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>f84f4a9cce614e6db1fd71e8900ead9a78763dc7</SHA>
      <PATCHEDFILES>
        <FILE>pkg/machine/e2e/machine_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>pkg/machine/e2e: fix broken cleanup Currently all podman machine rm errors in AfterEach were ignored. This means some leaked and caused issues later on, see #22844. To fix it first rework the logic to only remove machines when needed at the place were they are created using DeferCleanup(), however DeferCleanup() does not work well together with AfterEach() as it always run AfterEach() before DeferCleanup(). As AfterEach() deletes the dir the podman machine rm call can not be done afterwards. As such migrate all cleanup to use DeferCleanup() and while I have to touch this fix the code to remove the per file duplciation and define the setup/cleanup once in the global scope. Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>3c0176b2d0dd3d4dbd3713c5e7fedf5501e304c5</SHA>
      <PATCHEDFILES>
        <FILE>pkg/machine/e2e/basic_test.go</FILE>
        <FILE>pkg/machine/e2e/config_init_test.go</FILE>
        <FILE>pkg/machine/e2e/info_test.go</FILE>
        <FILE>pkg/machine/e2e/init_test.go</FILE>
        <FILE>pkg/machine/e2e/init_windows_test.go</FILE>
        <FILE>pkg/machine/e2e/inspect_test.go</FILE>
        <FILE>pkg/machine/e2e/list_test.go</FILE>
        <FILE>pkg/machine/e2e/machine_test.go</FILE>
        <FILE>pkg/machine/e2e/os_test.go</FILE>
        <FILE>pkg/machine/e2e/proxy_test.go</FILE>
        <FILE>pkg/machine/e2e/reset_test.go</FILE>
        <FILE>pkg/machine/e2e/rm_test.go</FILE>
        <FILE>pkg/machine/e2e/set_test.go</FILE>
        <FILE>pkg/machine/e2e/ssh_test.go</FILE>
        <FILE>pkg/machine/e2e/start_test.go</FILE>
        <FILE>pkg/machine/e2e/stop_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
