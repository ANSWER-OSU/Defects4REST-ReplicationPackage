<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>17922</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/17922</ISSUEURL>
  <TITLE>With Pasta, Infrastructure container entry doesn't manifest</TITLE>
  <DESCRIPTION>### Issue Description When using `--net=pasta` with a pod the invocation fails to set the infrastructure container hostname. Instead the pod name is set in front of the host name of the next container added to the pod. I noticed this when attempting to deploy [immich](https://github.com/immich-app/immich), which requires several containers and local hostname resolution within the pod. ### Steps to reproduce the issue (WORKING) Without Pasta: ``` podman pod create --name immich --publish 127.0.0.1:3300:8080 podman run --replace --detach --pod=immich --name=redis --label &quot;io.containers.autoupdate=image&quot; docker.io/library/redis:latest podman exec -it redis bash # cat /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 172.22.4.4 host.containers.internal 10.0.2.100 immich 3c0d761ba169-infra 127.0.0.1 redis ``` (FAILURE) With Pasta: ``` podman pod create --name immich --net=pasta --publish 127.0.0.1:3300:8080 podman run --replace --detach --pod=immich --name=redis --label &quot;io.containers.autoupdate=image&quot; docker.io/library/redis:latest podman exec -it redis bash # cat /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 172.22.4.4 host.containers.internal 127.0.0.1 immich redis ``` ### Describe the results you received Describe the results you received ### Describe the results you expected I'd expected as I added more containers to the pod to have name resolution work, however whatever container is first added to the pod when using `--net=pasta` has its hostname effectively mangled. ### podman info output ```yaml $ podman info host: arch: amd64 buildahVersion: 1.29.0 cgroupControllers: - cpu - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.6-1.el9.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.6, commit: ae34694dbfd15d1b90e7219e4a964df2f1c6c415' cpuUtilization: idlePercent: 99.04 systemPercent: 0.44 userPercent: 0.52 cpus: 32 distribution: distribution: '&quot;centos&quot;' version: &quot;9&quot; eventLogger: file hostname: muckle idMappings: gidmap: - container_id: 0 host_id: 3300 size: 1 - container_id: 1 host_id: 362144 size: 65536 uidmap: - container_id: 0 host_id: 3300 size: 1 - container_id: 1 host_id: 362144 size: 65536 kernel: 5.14.0-285.el9.x86_64 linkmode: dynamic logDriver: k8s-file memFree: 99337564160 memTotal: 270122323968 networkBackend: netavark ociRuntime: name: crun package: crun-1.8.1-1.el9.x86_64 path: /usr/bin/crun version: |- crun version 1.8.1 commit: f8a096be060b22ccd3d5f3ebe44108517fbf6c30 rundir: /run/user/3300/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: path: /run/user/3300/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-3.el9.x86_64 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.4.0 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.2 swapFree: 34345054208 swapTotal: 34345054208 uptime: 70h 22m 31.00s (Approximately 2.92 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - registry.access.redhat.com - registry.redhat.io - docker.io store: configFile: /zfs/safe/memory/.config/containers/storage.conf containerStore: number: 4 paused: 0 running: 4 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /zfs/safe/memory/.local/share/containers/storage graphRootAllocated: 3610553614336 graphRootUsed: 3122003968 graphStatus: Backing Filesystem: zfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 10 runRoot: /run/user/3300/containers transientStore: false volumePath: /zfs/safe/memory/.local/share/containers/storage/volumes version: APIVersion: 4.4.1 Built: 1676977843 BuiltTime: Tue Feb 21 06:10:43 2023 GitCommit: &quot;&quot; GoVersion: go1.19.4 Os: linux OsArch: linux/amd64 Version: 4.4.1 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details Running podman rootless-as-non-root (using a non-root user). ### Additional information _No response_</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>97</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #19049 from dfr/freebsd-api-server Add support for 'podman system service' on FreeBSD</MESSAGE>
    <SHA>fca3c2ef8476669825564af89b008946bdf87599</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>pasta: Create /etc/hosts entries for pods using pasta networking For pods with bridged and slirp4netns networking we create /etc/hosts entries to make it more convenient for the containers to address each other. We omitted to do this for pasta networking, however. Add the necessary code to do this. Closes: https://github.com/containers/podman/issues/17922 Signed-off-by: David Gibson &lt;david@gibson.dropbear.id.au&gt;</MESSAGE>
      <SHA>39624473b0dd65f96f2ee93d4edc5fb22fce68df</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/networking_freebsd.go</FILE>
        <FILE>libpod/networking_linux.go</FILE>
        <FILE>test/system/505-networking-pasta.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>pasta: Create /etc/hosts entries for pods using pasta networking For pods with bridged and slirp4netns networking we create /etc/hosts entries to make it more convenient for the containers to address each other. We omitted to do this for pasta networking, however. Add the necessary code to do this. Closes: https://github.com/containers/podman/issues/17922 Signed-off-by: David Gibson &lt;david@gibson.dropbear.id.au&gt;</MESSAGE>
      <SHA>efbcfe364db3490151ee55f1bf50598bf67feb26</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/networking_freebsd.go</FILE>
        <FILE>libpod/networking_linux.go</FILE>
        <FILE>test/system/505-networking-pasta.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>pasta: Create /etc/hosts entries for pods using pasta networking For pods with bridged and slirp4netns networking we create /etc/hosts entries to make it more convenient for the containers to address each other. We omitted to do this for pasta networking, however. Add the necessary code to do this. Closes: https://github.com/containers/podman/issues/17922 Signed-off-by: David Gibson &lt;david@gibson.dropbear.id.au&gt;</MESSAGE>
      <SHA>2f25372de4924e77117bb7cb18b29b49dc0d89e7</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/networking_freebsd.go</FILE>
        <FILE>libpod/networking_linux.go</FILE>
        <FILE>test/system/505-networking-pasta.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
