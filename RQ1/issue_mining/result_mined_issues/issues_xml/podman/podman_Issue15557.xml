<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15557</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15557</ISSUEURL>
  <TITLE>Conmon and crun processes are hangs if podman was killed by SIGTERM</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** If `podman run` command is killed by SIGTERM signal, there is a probability that child processes - conmon and crun - will hang and never exit. **Steps to reproduce the issue:** 1. Create a bash script with the following content (be careful - kill command inside): ``` #!/bin/bash set -o errexit podman rm -f -i label-for-kill while true; do podman info &gt; /dev/null podman run --rm --init --name label-for-kill nginx &amp; sleep 3 echo send kill for `pgrep -f label-for-kill` kill `pgrep -f label-for-kill` sleep 3 done ``` 2. Execute the script. 3. Interrupt it after some time. **Describe the results you received:** After several iterations, there are several conmons and cruns, that don't have a parent. These processes will run even after the script interruption. **Describe the results you expected:** There are no conmon and crun without parent `podman run`. And after script interruption there are no conmon and crun at all. **Additional information you deem important (e.g. issue happens only occasionally):** The issue happens only occasionally. In my case, it's not reproduced in the adm64 machine, but very often reproduced in my weak ARMv7 device. **Output of `podman version`:** ``` Client: Podman Engine Version: 4.3.0-dev API Version: 4.3.0-dev Go Version: go1.17.8 Built: Thu Jan 1 00:00:00 1970 OS/Arch: linux/arm ``` **Output of `podman info`:** ``` host: arch: arm buildahVersion: 1.27.0 cgroupControllers: - cpuset - cpu - cpuacct - blkio - memory - devices - freezer - net_cls - perf_event - net_prio - pids cgroupManager: systemd cgroupVersion: v1 conmon: package: Unknown path: /usr/bin/conmon version: 'conmon version 2.0.29, commit: unknown' cpuUtilization: idlePercent: 87.12 systemPercent: 10.63 userPercent: 2.24 cpus: 4 distribution: distribution: buildroot version: &quot;2022.02&quot; eventLogger: journald hostname: comm99-dev idMappings: gidmap: null uidmap: null kernel: 4.14.98 linkmode: dynamic logDriver: k8s-file memFree: 180031488 memTotal: 511803392 networkBackend: cni ociRuntime: name: crun package: Unknown path: /usr/bin/crun version: |- crun version 1.4.3 commit: 61c9600d1335127eba65632731e2d72bc3f0b9e8 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +YAJL os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: &quot;&quot; selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: &quot;&quot; package: &quot;&quot; version: &quot;&quot; swapFree: 0 swapTotal: 0 uptime: 0h 17m 39.00s plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - docker.io - registry.fedoraproject.org - registry.access.redhat.com - registry.centos.org store: configFile: /etc/containers/storage.conf containerStore: number: 6 paused: 0 running: 0 stopped: 6 graphDriverName: overlay graphOptions: overlay.mountopt: nodev graphRoot: /opt/containers/storage graphRootAllocated: 29639618560 graphRootUsed: 3874271232 graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 35 runRoot: /run/containers/storage volumePath: /opt/containers/storage/volumes version: APIVersion: 4.3.0-dev Built: 0 BuiltTime: Thu Jan 1 00:00:00 1970 GitCommit: &quot;&quot; GoVersion: go1.17.8 Os: linux OsArch: linux/arm Version: 4.3.0-dev ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` Manual build from the main branch. ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):**</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #15480 from lsm5/tmp-revert-packit Temporarily Revert &quot;Packit: Enable scratch build testing for Fedora 36, 37 and Rawhide&quot;</MESSAGE>
    <SHA>f98215c668746e9a7b9603448428cd1301a56eac</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Inhibit SIGTERM during Conmon startup If we get a SIGTERM immediately after Conmon starts but before we record its PID in the database, we end up leaking a Conmon and associated OCI runtime process. Inhibit shutdown using the logic we originally wrote to prevent similar issues during container creation to prevent this problem. [NO NEW TESTS NEEDED] No real way to test this I can think of. Fixes #15557 Signed-off-by: Matthew Heon &lt;matthew.heon@pm.me&gt;</MESSAGE>
      <SHA>fed4ce0ea9a9c85b45f5f6733f82051ea3a179db</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Inhibit SIGTERM during Conmon startup If we get a SIGTERM immediately after Conmon starts but before we record its PID in the database, we end up leaking a Conmon and associated OCI runtime process. Inhibit shutdown using the logic we originally wrote to prevent similar issues during container creation to prevent this problem. [NO NEW TESTS NEEDED] No real way to test this I can think of. Fixes #15557 Signed-off-by: Matthew Heon &lt;matthew.heon@pm.me&gt;</MESSAGE>
      <SHA>ecfbc6f3247448df8c297dca8c32ce7aea18656a</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
