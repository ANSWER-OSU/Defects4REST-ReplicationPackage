<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14676</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14676</ISSUEURL>
  <TITLE>Wrong memory limit stats from podman's remote stats API</TITLE>
  <DESCRIPTION>### Description `podman` remote stats API reports wrong &quot;memory_limit&quot; stats for memory-limited container when the container is launched with `crun`. I am not sure whether the issue comes from `podman` or `crun`, but decided to report here because the issue is gone if I change the runtime to `runc`. ### How to reproduce 1. Run **rootful** podman API daemon ``` podman system service -t 0 tcp:127.0.0.1:12345 ``` 2. Launch a container with latest `crun` runtime with memory limit ``` podman run --rm -it -m 512m --runtime=/crun-1.4.5-linux-amd64 --name test busybox ``` 3. Check the output from `podman`'s remote stats API ``` curl http://127.0.0.1:12345/containers/test/stats?stream=false ``` 4. Confirm that `memory_stats.limit` is wrongly reported. ``` { &quot;read&quot;: &quot;2022-06-21T05:27:32.81008054Z&quot;, &quot;preread&quot;: &quot;0001-01-01T00:00:00Z&quot;, &quot;pids_stats&quot;: ..., &quot;blkio_stats&quot;: ..., &quot;num_procs&quot;: ..., &quot;storage_stats&quot;: ..., &quot;cpu_stats&quot;: ...,, &quot;precpu_stats&quot;: ..., &quot;memory_stats&quot;: { &quot;usage&quot;: 589824, &quot;max_usage&quot;: 18446744073709551615, &quot;limit&quot;: 18446744073709551615 }, &quot;name&quot;: &quot;test&quot;, &quot;Id&quot;: ..., &quot;networks&quot;: ... } ``` 5. Repeat the same procedure with `runc` runtime ``` podman run --rm -it -m 512m --runtime=/home/ubuntu/runc-1.1.3.amd64 --name test busybox ``` 6. Confirm that `memory_stats.limit` is correctly reported. ``` { &quot;read&quot;: &quot;2022-06-21T05:33:54.710659699Z&quot;, &quot;preread&quot;: &quot;0001-01-01T00:00:00Z&quot;, &quot;pids_stats&quot;: ..., &quot;blkio_stats&quot;: ..., &quot;num_procs&quot;: ..., &quot;storage_stats&quot;: ..., &quot;cpu_stats&quot;: ...,, &quot;precpu_stats&quot;: ..., &quot;memory_stats&quot;: { &quot;usage&quot;: 335872, &quot;max_usage&quot;: 536870912, &quot;limit&quot;: 536870912 }, &quot;name&quot;: &quot;test&quot;, &quot;Id&quot;: ..., &quot;networks&quot;: ... } ``` ### Environment ``` root@machine:/home/ubuntu# podman info host: arch: amd64 buildahVersion: 1.23.1 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: 'conmon: /usr/bin/conmon' path: /usr/bin/conmon version: 'conmon version 2.0.25, commit: unknown' cpus: 16 distribution: codename: jammy distribution: ubuntu version: &quot;22.04&quot; eventLogger: journald hostname: {maksed} idMappings: gidmap: null uidmap: null kernel: 5.15.0-1004-aws linkmode: dynamic logDriver: journald memFree: 1502658560 memTotal: 67403698176 ociRuntime: name: crun package: 'crun: /usr/bin/crun' path: /usr/bin/crun version: |- crun version 0.17 commit: 0e9229ae34caaebcb86f1fde18de3acaf18c6d9a spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +YAJL os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: true capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: 'slirp4netns: /usr/bin/slirp4netns' version: |- slirp4netns version 1.0.1 commit: 6a7b16babc95b6a3056b33fb45b74a6f62262dd4 libslirp: 4.6.1 swapFree: 0 swapTotal: 0 uptime: {maksed} plugins: log: - k8s-file - none - journald network: - bridge - macvlan volume: - local registries: {} store: configFile: /etc/containers/storage.conf containerStore: number: {maksed} paused: {maksed} running: {maksed} stopped: {maksed} graphDriverName: overlay graphOptions: {} graphRoot: /var/lib/containers/storage graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageStore: number: {maksed} runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 3.4.4 Built: 0 BuiltTime: Thu Jan 1 00:00:00 1970 GitCommit: &quot;&quot; GoVersion: go1.17.3 OsArch: linux/amd64 Version: 3.4.4 ```</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14556 from sstosh/system-prune-network podman system prune support prune unused networks</MESSAGE>
    <SHA>fe8e536328eef61f0cf7ffd42b74d4e5be4654ee</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>api: show the memory limit specified for the container use the memory limit specified for the container instead of reading it from the cgroup. It is not reliable to read it from the cgroup since the container could have been moved to a different cgroup and in general the OCI runtime might create a sub-cgroup (like crun does). Closes: https://github.com/containers/podman/issues/14676 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
      <SHA>1f539a26417bf5e76604361c1ea2841941809359</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/containers_stats.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
