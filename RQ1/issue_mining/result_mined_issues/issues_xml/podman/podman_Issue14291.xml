<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14291</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14291</ISSUEURL>
  <TITLE>Podman's Docker-compatible REST API and previously pulled images.</TITLE>
  <DESCRIPTION>/kind bug **Description** Since podman 4, when using the Docker-compatible REST API, trying to start a container that was previously pulled fails because the container does not exist on Docker Hub. More precisely I get a 404 for docker.io/library/NAME:TAG. This issue is fixed by setting `compat_api_enforce_docker_hub` to `false`. I can also report that Docker is perfectly happy with starting the containers with the same API request. This was originally discussed [here](https://github.com/containers/podman/issues/12320#issuecomment-1131537455) **Steps to reproduce the issue:** 1. Login to a private registry 2. Pull a container 3. Logout from the registry 4. Try to start the container using the Docker-compatible REST API **Describe the results you received:** 404 on `docker.io/library/NAME:TAG` Please note that I removed the environment variables sections of the requests. ``` # podman --version podman version 4.0.2 # podman --log-level=debug system service -t 0 tcp:0.0.0.0:2376 INFO[0000] podman filtering at log level debug DEBU[0000] Called service.PersistentPreRunE(podman --log-level=debug system service -t 0 tcp:0.0.0.0:2376) DEBU[0000] Merged system config &quot;/usr/share/containers/containers.conf&quot; DEBU[0000] Merged system config &quot;/etc/containers/containers.conf&quot; DEBU[0000] Using conmon: &quot;/usr/bin/conmon&quot; DEBU[0000] Initializing boltdb state at /var/lib/containers/storage/libpod/bolt_state.db DEBU[0000] Using graph driver overlay DEBU[0000] Using graph root /var/lib/containers/storage DEBU[0000] Using run root /run/containers/storage DEBU[0000] Using static dir /var/lib/containers/storage/libpod DEBU[0000] Using tmp dir /run/libpod DEBU[0000] Using volume path /var/lib/containers/storage/volumes DEBU[0000] Set libpod namespace to &quot;&quot; DEBU[0000] [graphdriver] trying provided driver &quot;overlay&quot; DEBU[0000] Cached value indicated that overlay is supported DEBU[0000] Cached value indicated that metacopy is being used DEBU[0000] Cached value indicated that native-diff is not being used INFO[0000] Not using native diff for overlay, this may cause degraded performance for building images: kernel has CONFIG_OVERLAY_FS_REDIRECT_DIR enabled DEBU[0000] backingFs=xfs, projectQuotaSupported=false, useNativeDiff=false, usingMetacopy=true DEBU[0000] Initializing event backend file DEBU[0000] Configured OCI runtime runsc initialization failed: no valid executable found for OCI runtime runsc: invalid argument DEBU[0000] Configured OCI runtime krun initialization failed: no valid executable found for OCI runtime krun: invalid argument DEBU[0000] Configured OCI runtime kata initialization failed: no valid executable found for OCI runtime kata: invalid argument DEBU[0000] Using OCI runtime &quot;/usr/bin/runc&quot; INFO[0000] Setting parallel job count to 25 DEBU[0000] registered SIGHUP watcher for config DEBU[0000] CORS Headers were not set INFO[0000] API service listening on &quot;[::]:2376&quot; DEBU[0000] waiting for SIGHUP to reload configuration DEBU[0000] API service(s) shutting down, idle for 0s DEBU[0000] API service shutdown request ignored as timeout Duration is UnlimitedService DEBU[0020] IdleTracker:new 0m+0h/0t connection(s) X-Reference-Id=0xc000011318 DEBU[0020] IdleTracker:new 0m+0h/1t connection(s) X-Reference-Id=0xc000011320 DEBU[0020] IdleTracker:active 0m+0h/2t connection(s) X-Reference-Id=0xc000011320 DEBU[0020] IdleTracker:active 1m+0h/2t connection(s) X-Reference-Id=0xc000011318 DEBU[0020] Looking up image &quot;NAME:TAG&quot; in local containers storage DEBU[0020] Normalized platform linux/amd64 to {amd64 linux [] } DEBU[0020] Trying &quot;NAME:TAG&quot; ... DEBU[0020] Loading registries configuration &quot;/etc/containers/registries.conf&quot; DEBU[0020] Looking up image &quot;NAME:TAG&quot; in local containers storage DEBU[0020] Normalized platform linux/amd64 to {amd64 linux [] } DEBU[0020] Trying &quot;NAME:TAG&quot; ... DEBU[0020] Loading registries configuration &quot;/etc/containers/registries.conf.d/000-shortnames.conf&quot; DEBU[0020] Loading registries configuration &quot;/etc/containers/registries.conf.d/001-rhel-shortnames.conf&quot; DEBU[0020] Loading registries configuration &quot;/etc/containers/registries.conf.d/002-rhel-shortnames-overrides.conf&quot; DEBU[0020] Trying &quot;localhost/NAME:TAG&quot; ... DEBU[0020] Trying &quot;registry.fedoraproject.org/NAME:TAG&quot; ... DEBU[0020] Trying &quot;localhost/NAME:TAG&quot; ... DEBU[0020] Trying &quot;registry.access.redhat.com/NAME:TAG&quot; ... DEBU[0020] Trying &quot;registry.fedoraproject.org/NAME:TAG&quot; ... DEBU[0020] Trying &quot;registry.centos.org/NAME:TAG&quot; ... DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... DEBU[0020] Trying &quot;registry.access.redhat.com/NAME:TAG&quot; ... DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... DEBU[0020] Trying &quot;registry.centos.org/NAME:TAG&quot; ... DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... DEBU[0020] Trying &quot;REGISTRY/PATH/NAME:TAG&quot; ... DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... DEBU[0020] parsed reference into &quot;[overlay@/var/lib/containers/storage+/run/containers/storage:overlay.mountopt=nodev,metacopy=on]@5fb70826285b943f31f0c4b0dc0247d29177941c6e01a99b188bdda633244892&quot; DEBU[0020] Found image &quot;NAME:TAG&quot; as &quot;REGISTRY/PATH/NAME:TAG&quot; in local containers storage DEBU[0020] Trying &quot;REGISTRY/PATH/NAME:TAG&quot; ... DEBU[0020] parsed reference into &quot;[overlay@/var/lib/containers/storage+/run/containers/storage:overlay.mountopt=nodev,metacopy=on]@5fb70826285b943f31f0c4b0dc0247d29177941c6e01a99b188bdda633244892&quot; DEBU[0020] Found image &quot;NAME:TAG&quot; as &quot;REGISTRY/PATH/NAME:TAG&quot; in local containers storage DEBU[0020] Found image &quot;NAME:TAG&quot; as &quot;REGISTRY/PATH/NAME:TAG&quot; in local containers storage ([overlay@/var/lib/containers/storage+/run/containers/storage:overlay.mountopt=nodev,metacopy=on]@5fb70826285b943f31f0c4b0dc0247d29177941c6e01a99b188bdda633244892) DEBU[0020] Looking up image &quot;docker.io/library/NAME:TAG&quot; in local containers storage DEBU[0020] Normalized platform linux/amd64 to {amd64 linux [] } DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... DEBU[0020] Found image &quot;NAME:TAG&quot; as &quot;REGISTRY/PATH/NAME:TAG&quot; in local containers storage ([overlay@/var/lib/containers/storage+/run/containers/storage:overlay.mountopt=nodev,metacopy=on]@5fb70826285b943f31f0c4b0dc0247d29177941c6e01a99b188bdda633244892) DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... DEBU[0020] Looking up image &quot;docker.io/library/NAME:TAG&quot; in local containers storage DEBU[0020] Normalized platform linux/amd64 to {amd64 linux [] } DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... INFO[0020] Request Failed(Not Found): No such image: docker.io/library/NAME:TAG: image not known DEBU[0020] Trying &quot;docker.io/library/NAME:TAG&quot; ... INFO[0020] Request Failed(Not Found): No such image: docker.io/library/NAME:TAG: image not known 34.74.239.56 - - [19/May/2022:11:31:19 +0000] &quot;POST /containers/create?Image=NAME%3ATAG&amp;Tty=true&amp;Cmd=%5B%22%2Fopt%2Fbin%2Fentry_point.sh%22%5D&amp;HostConfig=%7B%22Privileged%22%3Atrue%2C%22Binds%22%3A%5B%22%2Fdev%2Fshm%3A%2Fdev%2Fshm%22%2C%22%2Fdata%2Fvideo%3A%2Fvideo%22%2C%22%2Fdata%2Fbrowsers%3A%2Fbrowsers%22%5D%7D&amp;name=overconfident-wish-2&amp;Env=REMOVED_BY_PETER HTTP/1.1&quot; 404 133 &quot;&quot; &quot;&quot; 34.74.239.56 - - [19/May/2022:11:31:19 +0000] &quot;POST /containers/create?Image=NAME%3ATAG&amp;Tty=true&amp;Cmd=%5B%22%2Fopt%2Fbin%2Fentry_point.sh%22%5D&amp;HostConfig=%7B%22Privileged%22%3Atrue%2C%22Binds%22%3A%5B%22%2Fdev%2Fshm%3A%2Fdev%2Fshm%22%2C%22%2Fdata%2Fvideo%3A%2Fvideo%22%2C%22%2Fdata%2Fbrowsers%3A%2Fbrowsers%22%5D%2C%22PortBindings%22%3A%7B%225900%2Ftcp%22%3A%5B%7B%22HostPort%22%3A%225900%22%7D%5D%2C%229229%2Ftcp%22%3A%5B%7B%22HostPort%22%3A%229229%22%7D%5D%7D%7D&amp;name=overconfident-wish-1&amp;Env=REMOVED_BY_PETER HTTP/1.1&quot; 404 133 &quot;&quot; &quot;&quot; DEBU[0020] IdleTracker:closed 2m+0h/2t connection(s) X-Reference-Id=0xc000011320 DEBU[0020] IdleTracker:closed 1m+0h/2t connection(s) X-Reference-Id=0xc000011318 ``` **Describe the results you expected:** The container should start as it is found on local storage. **Additional information you deem important (e.g. issue happens only occasionally):** **Output of `podman version`:** ``` podman version 4.0.2 ``` **Output of `podman info --debug`:** ``` host: arch: amd64 buildahVersion: 1.24.1 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - rdma cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.0-1.module_el8.6.0+2877+8e437bf5.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.0, commit: edfc4e28654b9f8e3597bb8f87c6af099a50261f' cpus: 8 distribution: distribution: '&quot;spearlineos&quot;' version: &quot;8.6&quot; eventLogger: file hostname: peter-from-image1 idMappings: gidmap: null uidmap: null kernel: 4.18.0-372.9.1.el8.x86_64 linkmode: dynamic logDriver: k8s-file memFree: 4423311360 memTotal: 8340979712 networkBackend: cni ociRuntime: name: runc package: runc-1.0.3-1.module_el8.6.0+2877+8e437bf5.x86_64 path: /usr/bin/runc version: |- runc version 1.0.3 spec: 1.0.2-dev go: go1.17.7 libseccomp: 2.5.2 os: linux remoteSocket: path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_NET_RAW,CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.1.8-2.module_el8.6.0+2877+8e437bf5.x86_64 version: |- slirp4netns version 1.1.8 commit: d361001f495417b880f20329121e3aa431a8f90f libslirp: 4.4.0 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.2 swapFree: 2209345536 swapTotal: 2209345536 uptime: 1h 18m 47.63s (Approximately 0.04 days) plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - registry.centos.org - docker.io store: configFile: /etc/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 4 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.0.2 Built: 1652194338 BuiltTime: Tue May 10 14:52:18 2022 GitCommit: &quot;&quot; GoVersion: go1.17.7 OsArch: linux/amd64 Version: 4.0.2 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` podman-4.0.2-5.module_el8.6.0+2877+8e437bf5.x86_64 ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** No **Additional environment details (AWS, VirtualBox, physical, etc.):** GCP</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14300 from mtrmac/test-gpgme-build Update c/image</MESSAGE>
    <SHA>769e777656e62172ccdd1b98989627d6dae57a96</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix compat image resolution Fix a bug in the resolution of images in the Docker compat API. When looking up an image by a short name, the name may match an image that does not live on Docker Hub. The resolved name should be used for normalization instead of the input name to make sure that `busybox` can resolve to `registry.com/busybox` if present in the local storage. Fixes: #14291 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>c984956f932be12951df4273e8b4a7b9737dce9c</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/utils/images.go</FILE>
        <FILE>test/apiv2/70-short-names.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix compat image resolution Fix a bug in the resolution of images in the Docker compat API. When looking up an image by a short name, the name may match an image that does not live on Docker Hub. The resolved name should be used for normalization instead of the input name to make sure that `busybox` can resolve to `registry.com/busybox` if present in the local storage. Fixes: #14291 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>1021afb6b0a06701e0cc778a4f5d0c88b9042a9b</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/utils/images.go</FILE>
        <FILE>test/apiv2/70-short-names.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix compat image resolution Fix a bug in the resolution of images in the Docker compat API. When looking up an image by a short name, the name may match an image that does not live on Docker Hub. The resolved name should be used for normalization instead of the input name to make sure that `busybox` can resolve to `registry.com/busybox` if present in the local storage. Fixes: #14291 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>c6c6618a29cb3cc6580e932969fcb59eb77012ce</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/utils/images.go</FILE>
        <FILE>test/apiv2/70-short-names.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
