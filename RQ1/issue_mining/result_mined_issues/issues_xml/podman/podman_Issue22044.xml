<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>22044</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/22044</ISSUEURL>
  <TITLE>With podman 5.0.0-rc6, rootless containers can no longer resolve DNS using corporate VPN servers</TITLE>
  <DESCRIPTION>### Issue Description After updating, I can no longer resolve domain names using DNS servers on my corporation's VPN. ``` $ podman run --rm -it quay.io/fedora/fedora:38-x86_64 curl http://download-node-02.eng.bos.redhat.com curl: (6) Could not resolve host: download-node-02.eng.bos.redhat.com ``` My DNS setup looks like this ``` $ resolvectl Global Protocols: LLMNR=resolve -mDNS -DNSOverTLS DNSSEC=no/unsupported resolv.conf mode: stub Current DNS Server: 127.0.0.1 DNS Servers: 127.0.0.1 Link 2 (enp9s0u2u1u2) Current Scopes: none Protocols: -DefaultRoute LLMNR=resolve -mDNS -DNSOverTLS DNSSEC=no/unsupported Link 3 (wlp0s20f3) Current Scopes: DNS LLMNR/IPv4 LLMNR/IPv6 Protocols: +DefaultRoute LLMNR=resolve -mDNS -DNSOverTLS DNSSEC=no/unsupported Current DNS Server: 10.42.42.42 DNS Servers: 10.m.n.o 10.p.q.r Link 4 (tun0) Current Scopes: DNS LLMNR/IPv4 LLMNR/IPv6 Protocols: -DefaultRoute LLMNR=resolve -mDNS -DNSOverTLS DNSSEC=no/unsupported Current DNS Server: 10.8.8.8 DNS Servers: 10.y.z.Å¾ 10.a.b.c DNS Domain: redhat.com ``` ### Steps to reproduce the issue Steps to reproduce the issue ``` $ podman run --rm -it quay.io/fedora/fedora:38-x86_64 curl http://download-node-02.eng.bos.redhat.com curl: (6) Could not resolve host: download-node-02.eng.bos.redhat.com ``` ### Describe the results you received ``` $ podman run --rm -it quay.io/fedora/fedora:38-x86_64 cat /etc/resolv.conf search redhat.com nameserver 10.200.0.245 nameserver 10.192.206.245 ``` ### Describe the results you expected When I add `--network=slirp4netns`, things start to work. ``` $ podman run --network=slirp4netns --rm -it quay.io/fedora/fedora:38-x86_64 curl http://download-node-02.eng.bos.redhat.com &lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 3.2 Final//EN&quot;&gt; &lt;html&gt; &lt;head&gt; &lt;title&gt;Index of /&lt;/title&gt; ... ``` ``` $ podman run --network=slirp4netns --rm -it quay.io/fedora/fedora:38-x86_64 cat /etc/resolv.conf search redhat.com nameserver 10.0.2.3 nameserver 10.200.0.245 nameserver 10.192.206.245 ``` ### podman info output ```yaml $ podman info host: arch: amd64 buildahVersion: 1.35.0 cgroupControllers: - cpu - io - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.8-4.fc40.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.8, commit: ' cpuUtilization: idlePercent: 93.3 systemPercent: 1.15 userPercent: 5.55 cpus: 12 databaseBackend: sqlite distribution: distribution: fedora variant: workstation version: &quot;40&quot; eventLogger: journald freeLocks: 2047 hostname: fedora idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 10000 size: 65536 - container_id: 65537 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 10000 size: 65536 kernel: 6.8.0-63.fc40.1.x86_64 linkmode: dynamic logDriver: journald memFree: 394874880 memTotal: 33395396608 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.10.0-1.fc40.x86_64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.10.0 package: netavark-1.10.3-2.fc40.x86_64 path: /usr/libexec/podman/netavark version: netavark 1.10.3 ociRuntime: name: crun package: crun-1.14.4-1.fc40.x86_64 path: /usr/bin/crun version: |- crun version 1.14.4 commit: a220ca661ce078f2c37b38c92e66cf66c012d9c1 rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt-0^20240220.g1e6f92b-1.fc40.x86_64 version: | pasta 0^20240220.g1e6f92b-1.fc40.x86_64 Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: false path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.2-2.fc40.x86_64 version: |- slirp4netns version 1.2.2 commit: 0ee2d87523e906518d34a6b423271e4826f71faf libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.3 swapFree: 8324640768 swapTotal: 8589930496 uptime: 3h 2m 15.00s (Approximately 0.12 days) variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: image-registry.openshift-image-registry.svc: Blocked: false Insecure: false Location: default-route-openshift-image-registry.apps-crc.testing MirrorByDigestOnly: false Mirrors: null Prefix: image-registry.openshift-image-registry.svc PullFromMirror: &quot;&quot; store: configFile: /home/jdanek/.config/containers/storage.conf containerStore: number: 1 paused: 0 running: 1 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /home/jdanek/.local/share/containers/storage graphRootAllocated: 510389125120 graphRootUsed: 473875283968 graphStatus: Backing Filesystem: btrfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;false&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 2 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/jdanek/.local/share/containers/storage/volumes version: APIVersion: 5.0.0-rc6 Built: 1710288000 BuiltTime: Wed Mar 13 01:00:00 2024 GitCommit: &quot;&quot; GoVersion: go1.22.0 Os: linux OsArch: linux/amd64 Version: 5.0.0-rc6 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details $ podman version Client: Podman Engine Version: 5.0.0-rc6 API Version: 5.0.0-rc6 Go Version: go1.22.0 Built: Wed Mar 13 01:00:00 2024 OS/Arch: linux/amd64 $ rpm -q podman podman-5.0.0~rc6-2.fc40.x86_64 $ cat /etc/redhat-release Fedora release 40 (Forty) Prerelease, updated to today's versions of packages. ### Additional information This problem is similar in symptoms to my previous issue * https://github.com/containers/podman/issues/17075</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>CVE-2024-1753 fix for main Bump to the version of Buidah in it's main branch to get the CVE-2024-1753 fix. [NO NEW TESTS NEEDED] Signed-off-by: tomsweeneyredhat &lt;tsweeney@redhat.com&gt;</MESSAGE>
    <SHA>079bfb085abedb25946870a7cffb0323dfc638b2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>use new c/common pasta2 setup logic to fix dns By default we just ignored any localhost reolvers, this is problematic for anyone with more complicated dns setups, i.e. split dns with systemd-reolved. To address this we now make use of the build in dns proxy in pasta. As such we need to set the default nameserver ip now. A second change is the option to exclude certain ips when generating the host.containers.internal ip. With that we no longer set it to the same ip as is used in the netns. The fix is not perfect as it could mean on a system with a single ip we no longer add the entry, however given the previous entry was incorrect anyway this seems like the better behavior. Fixes #22044 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>dc1795b4b2864f379b67d4cc50930febd8e64b3c</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container.go</FILE>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/container_internal_freebsd.go</FILE>
        <FILE>libpod/container_internal_linux.go</FILE>
        <FILE>libpod/networking_freebsd.go</FILE>
        <FILE>libpod/networking_linux.go</FILE>
        <FILE>libpod/networking_pasta_linux.go</FILE>
        <FILE>test/system/505-networking-pasta.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[v5.0] use new c/common pasta2 setup logic to fix dns By default we just ignored any localhost reolvers, this is problematic for anyone with more complicated dns setups, i.e. split dns with systemd-reolved. To address this we now make use of the build in dns proxy in pasta. As such we need to set the default nameserver ip now. A second change is the option to exclude certain ips when generating the host.containers.internal ip. With that we no longer set it to the same ip as is used in the netns. The fix is not perfect as it could mean on a system with a single ip we no longer add the entry, however given the previous entry was incorrect anyway this seems like the better behavior. Fixes #22044 [NO NEW TESTS NEEDED] Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>92b3cda79b0f0ec380d4ce2585d14b055d892cce</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container.go</FILE>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/container_internal_freebsd.go</FILE>
        <FILE>libpod/container_internal_linux.go</FILE>
        <FILE>libpod/networking_freebsd.go</FILE>
        <FILE>libpod/networking_linux.go</FILE>
        <FILE>libpod/networking_pasta_linux.go</FILE>
        <FILE>test/system/505-networking-pasta.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
