<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>16150</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/16150</ISSUEURL>
  <TITLE>Podman push image to redhat quay with sigstore was failed caused by send malformed manifest to quay</TITLE>
  <DESCRIPTION>Hi Guys, When use podman 4.2.1 to push image to Redhat Quay 3.8.0, hit 500 error code, based on the log error message , seems like podman send malformed json to quay, pls review this issue and give suggestions. ``` [root@ip-10-0-1-76 fedora]# podman push quayregistry-quay-quay-enterprise-13240.apps.quaytest-13240.qe.azure.devcluster.openshift.com/quay/demo --tls-verify=false --sign-by-sigstore-private-key=./cosign.key Key Passphrase: Getting image source signatures Copying blob 288cf3a46e32 done Copying blob 75ba02937496 done Copying blob 0c7daf9a72c8 done Copying blob 955c9335e041 done Copying blob 8e079fee2186 done Copying blob 186da837555d done Copying blob d172a9e6f9e6 done Copying blob cf399be408ea done Copying blob 793b971ccb99 done Copying config da84e66c3a done Writing manifest to image destination Signing manifest using a sigstore signature Storing signatures Error: writing signatures: uploading manifest sha256-2353c13421e07e3d3dd1bb181cf0b7ad5e6dce3e1bb363c33f48d12e0a0ada49.sig to quayregistry-quay-quay-enterprise-13240.apps.quaytest-13240.qe.azure.devcluster.openshift.com/quay/demo: received unexpected HTTP status: 500 Internal Server Error ``` ``` gunicorn-registry stdout | 2022-10-11 03:58:52,461 [214] [ERROR] [gunicorn.error] Error handling request /v2/quay/demo/manifests/sha256-2353c13421e07e3d3dd1bb181cf0b7ad5e6dce3e1bb363c33f48d12e0a0ada49.sig gunicorn-registry stdout | Traceback (most recent call last): gunicorn-registry stdout | File &quot;/quay-registry/image/oci/config.py&quot;, line 209, in __init__ gunicorn-registry stdout | validate_schema(self._parsed, OCIConfig.METASCHEMA) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/jsonschema/validators.py&quot;, line 934, in validate gunicorn-registry stdout | raise error gunicorn-registry stdout | jsonschema.exceptions.ValidationError: '' is not one of ['layers'] gunicorn-registry stdout | Failed validating 'enum' in schema['properties']['rootfs']['properties']['type']: gunicorn-registry stdout | {'description': 'MUST be set to layers.', gunicorn-registry stdout | 'enum': ['layers'], gunicorn-registry stdout | 'type': 'string'} gunicorn-registry stdout | On instance['rootfs']['type']: gunicorn-registry stdout | '' gunicorn-registry stdout | During handling of the above exception, another exception occurred: gunicorn-registry stdout | Traceback (most recent call last): gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/gunicorn/workers/base_async.py&quot;, line 55, in handle gunicorn-registry stdout | self.handle_request(listener_name, req, client, addr) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/gunicorn/workers/ggevent.py&quot;, line 127, in handle_request gunicorn-registry stdout | super().handle_request(listener_name, req, sock, addr) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/gunicorn/workers/base_async.py&quot;, line 108, in handle_request gunicorn-registry stdout | respiter = self.wsgi(environ, resp.start_response) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/flask/app.py&quot;, line 2463, in __call__ gunicorn-registry stdout | return self.wsgi_app(environ, start_response) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/werkzeug/middleware/proxy_fix.py&quot;, line 169, in __call__ gunicorn-registry stdout | return self.app(environ, start_response) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/flask/app.py&quot;, line 2449, in wsgi_app gunicorn-registry stdout | response = self.handle_exception(e) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/flask/app.py&quot;, line 1866, in handle_exception gunicorn-registry stdout | reraise(exc_type, exc_value, tb) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/flask/_compat.py&quot;, line 39, in reraise gunicorn-registry stdout | raise value gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/flask/app.py&quot;, line 2446, in wsgi_app gunicorn-registry stdout | response = self.full_dispatch_request() gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/flask/app.py&quot;, line 1951, in full_dispatch_request gunicorn-registry stdout | rv = self.handle_user_exception(e) gunicorn-registry stdout | File &quot;/usr/local/lib/python3.9/site-packages/flask/app.py&quot;, line 1820, in handle_user_exceptiongunicorn-registry stdout | 'x-ms-copy-source': 'REDACTED' ```</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #16166 from misuto/main Change to correct break statements to prevent infinite recursion causing OOM</MESSAGE>
    <SHA>d21a35630dc4c57d329ac5c753c9c3f1305408e1</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Update vendor containers/(common,image,storage) Fixes: https://github.com/containers/podman/issues/16150 Signed-off-by: Daniel J Walsh &lt;dwalsh@redhat.com&gt;</MESSAGE>
      <SHA>01a3245d7d940d10de75f2f630e6b8b0f4b393f7</SHA>
      <PATCHEDFILES>
        <FILE>go.mod</FILE>
        <FILE>go.sum</FILE>
        <FILE>vendor/github.com/blang/semver/.travis.yml</FILE>
        <FILE>vendor/github.com/blang/semver/LICENSE</FILE>
        <FILE>vendor/github.com/blang/semver/README.md</FILE>
        <FILE>vendor/github.com/blang/semver/json.go</FILE>
        <FILE>vendor/github.com/blang/semver/package.json</FILE>
        <FILE>vendor/github.com/blang/semver/range.go</FILE>
        <FILE>vendor/github.com/blang/semver/semver.go</FILE>
        <FILE>vendor/github.com/blang/semver/sort.go</FILE>
        <FILE>vendor/github.com/blang/semver/sql.go</FILE>
        <FILE>vendor/github.com/containers/common/libimage/pull.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/config/containers.conf</FILE>
        <FILE>vendor/github.com/containers/common/version/version.go</FILE>
        <FILE>vendor/github.com/containers/image/v5/directory/directory_dest.go</FILE>
        <FILE>vendor/github.com/containers/image/v5/docker/docker_client.go</FILE>
        <FILE>vendor/github.com/containers/image/v5/docker/docker_image_dest.go</FILE>
        <FILE>vendor/github.com/containers/storage/containers.go</FILE>
        <FILE>vendor/github.com/containers/storage/images.go</FILE>
        <FILE>vendor/github.com/containers/storage/layers.go</FILE>
        <FILE>vendor/github.com/containers/storage/store.go</FILE>
        <FILE>vendor/github.com/containers/storage/userns.go</FILE>
        <FILE>vendor/github.com/opencontainers/runtime-spec/specs-go/config.go</FILE>
        <FILE>vendor/github.com/opencontainers/runtime-tools/generate/generate.go</FILE>
        <FILE>vendor/github.com/opencontainers/runtime-tools/validate/validate.go</FILE>
        <FILE>vendor/modules.txt</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
