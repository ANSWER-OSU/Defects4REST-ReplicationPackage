<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>23613</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/23613</ISSUEURL>
  <TITLE>ABBA deadlock in podman volume rm --force</TITLE>
  <DESCRIPTION>### Issue Description When a volume is removed via podman volume rm --force and there containers with the volume it is trivial to run into deadlocks. The main issue is that most code paths get first the ctr lock and then the voluem lock while volume rm does the opposite so it causes ABBA deadlocks. ### Steps to reproduce the issue Terminal 1: `i=0; while :; do bin/podman run -v test:/test quay.io/libpod/testimage:20240123 sleep 0.1 &amp;&amp; echo $i &amp;&amp; i=$((i + 1)) || break; done` Terminal 2 `i=0; while :; do bin/podman volume rm test --force &amp;&amp; echo $i &amp;&amp; i=$((i + 1)) || break; done` you may need to rerun the volume rm command a couple of times until you hit the deadlock because it can fail with `Error: removing volume test: volume test is in use by containers cb054c09134cfe08da758410a901c3897b5714202ab000713ad2e603eb694270: volume is being used` which is also another issue ### Describe the results you received Both commands deadlock ### Describe the results you expected volume should be deleted properly ### podman info output ```yaml podman@main ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release Yes ### Additional environment details Additional environment details ### Additional information podman run is just one simple example to hit this. It happen with the container cleanup process as well which causes CI issue here: https://api.cirrus-ci.com/v1/artifact/task/6114089225682944/html/int-podman-fedora-39-root-container-boltdb.log.html#t--Podman-volume-create-image-backed-volume-force-removal--1</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>test/system: fix network cleanup restart test Now that on-failure exits right away the test is racy as the RestartCount is not at the value we expect as the container is still restarting in the background. As such add a timer based approach. Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
    <SHA>b6beed9f7693f69b91a584d3a21c51a6710f5871</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>podman volume rm --force: fix ABBA deadlock We cannot get first the volume lock and the container locks. Other code paths always have to first lock the container and the lock the volumes, i.e. to mount/umount them. As such locking the volume fust can always result in ABBA deadlocks. To fix this move the lock down after the container removal. The removal code is racy regardless of the lock as the volume lcok on create is no longer taken since commit 3cc9db8626 due another deadlock there. Fixes #23613 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>a65aecd2604addd14290971f09e894d408ff86d2</SHA>
      <PATCHEDFILES>
        <FILE>libpod/runtime_volume_common.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
