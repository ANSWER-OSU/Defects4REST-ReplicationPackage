<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>20335</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/20335</ISSUEURL>
  <TITLE>network connect/disconnect with port forwarding: curl: empty results</TITLE>
  <DESCRIPTION>This looks identical to #11248, except this one is *root*, not rootless. And, sigh, is only happening under VFS (which makes no sense to me). ``` [+1694s] not ok 482 podman network connect/disconnect with port forwarding ... &lt;+020ms&gt; # # podman run -d -p 5074:80 --hostname host-V1gILFpgNx --network testnet-ursuRNcqbm -v /var/tmp/podman_bats.h95bel/hello.txt:/var/www/index.txt:Z -w /var/www quay.io/libpod/testimage:20221018 /bin/busybox-extras httpd -f -p 80 &lt;+505ms&gt; # e748507a00fcf0651f6a8cbe66c04d4cfb8e154720ff8af6fcb90aad29c57e51 # #/vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv # #| FAIL: curl 127.0.0.1:/index.txt # #| expected: '8nrO6jGUa1Rp16iHkFilXAz2GKbQm8' # #| actual: '' # #\^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ``` The failing command is `curl --max-time 3 -s $SERVER/index.txt`. Do note that this is not a curl-error-7 (connection failure). Curl connects, but gets empty results. This is disturbingly similar to other VFS flakes I'm seeing involving empty files that should not be empty, but I'm going to ignore that for now. ### [sys] podman network connect/disconnect with port forwarding * fedora-38 : sys podman fedora-38 root host boltdb * [10-10 08:01](https://api.cirrus-ci.com/v1/artifact/task/6116867048210432/html/sys-podman-fedora-38-root-host-boltdb.log.html#t--00482) * fedora-38 : sys remote fedora-38 root host boltdb [remote] * [10-10 07:48](https://api.cirrus-ci.com/v1/artifact/task/6327973280743424/html/sys-remote-fedora-38-root-host-boltdb.log.html#t--00482) * [10-09 19:18](https://api.cirrus-ci.com/v1/artifact/task/5530963996835840/html/sys-remote-fedora-38-root-host-boltdb.log.html#t--00482) * [10-03 13:37](https://api.cirrus-ci.com/v1/artifact/task/6031089584570368/html/sys-remote-fedora-38-root-host-boltdb.log.html#t--00481) * [10-03 12:23](https://api.cirrus-ci.com/v1/artifact/task/6702977679884288/html/sys-remote-fedora-38-root-host-boltdb.log.html#t--00481) Seen in: sys podman+remote fedora-38 root host boltdb</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>14</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #20481 from vrothberg/fix-20469 compat API: fix image-prune --all</MESSAGE>
    <SHA>556898511c1034eeec1509628bfddc3cf35c42ce</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>CI: try to fix more networking flakes There's a whole slew of networking-related flakes whose common element seems to be improper use of curl. Fix those by: * add --retry --retry-connrefused; and/or * add -S (&quot;show errors&quot;. Plain -s silences everything!); and/or * test exit status from curl; and/or * add wait_for_port after &quot;podman run -d&quot;, to avoid races * log commands, to make debugging easier Important note: wait_for_port() was not working with rootless podman ports. Trivial proof: $ podman run -d --name foo -p 8192:80 \ quay.io/libpod/testimage:20221018 \ /bin/busybox-extras httpd -f -p 80 $ grep :2000 /proc/net/tcp [no results] Solution: use ss tool; it seems to handle this just fine. There may be a better solution. Oh, also, add -t1 to a podman restart, to shave 18s from test run. Fixes: #20335 and, I think, a handful of others Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>c0fb8fe594c5e288e927438983ed4696e4a6a6e1</SHA>
      <PATCHEDFILES>
        <FILE>test/e2e/pod_infra_container_test.go</FILE>
        <FILE>test/system/500-networking.bats</FILE>
        <FILE>test/system/700-play.bats</FILE>
        <FILE>test/system/helpers.network.bash</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
