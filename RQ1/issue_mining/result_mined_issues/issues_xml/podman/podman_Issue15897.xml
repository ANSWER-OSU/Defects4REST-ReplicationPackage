<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15897</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15897</ISSUEURL>
  <TITLE>Failed to save an image as a 'docker-dir' format on remote environment</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** &lt;!-- Briefly describe the problem you are having in a few paragraphs. --&gt; `podman-remote save --format docker-dir` saves an image as a `docker-archive` format. **Describe the results you received:** An image is saved as `docker-archive` format. ``` # podman-remote save --format docker-dir -o /root/hoge quay.io/libpod/testimage:20220615 # ls /root/hoge 5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef.tar 830537cf97f8edabf3c9defa4b0e1d5300728c5897af15ab6f2ae9c5fba36c04 d376924959cf31ee3dcd95c8079b2cc3feb1655a7182bdc638d8becfe377183c.tar eb752aaf0876f1dc9ef8fabb9c2cc3eadd77f58d3ef6280f15451640488b289c f26aa69bb3f3de470d358b6c4e7f9de8ca165ef7f1689af1cdd446902dc27928.json manifest.json repositories ``` **Describe the results you expected:** An image is saved as `docker-dir` format. ``` # podman-remote save --format docker-dir -o /root/hoge quay.io/libpod/testimage:20220615 # ls /root/hoge 5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef manifest.json d376924959cf31ee3dcd95c8079b2cc3feb1655a7182bdc638d8becfe377183c version f26aa69bb3f3de470d358b6c4e7f9de8ca165ef7f1689af1cdd446902dc27928 ``` **Additional information you deem important (e.g. issue happens only occasionally):** Succeeded to save a image as a `docker-dir` format on local environment. ``` # podman save --format docker-dir -o /root/hoge quay.io/libpod/testimage:20220615 Copying blob d376924959cf done Copying blob 5f70bf18a086 done Copying config f26aa69bb3 done Writing manifest to image destination Storing signatures # ls /root/hoge 5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef manifest.json d376924959cf31ee3dcd95c8079b2cc3feb1655a7182bdc638d8becfe377183c version f26aa69bb3f3de470d358b6c4e7f9de8ca165ef7f1689af1cdd446902dc27928 ``` &lt;details&gt; &lt;summary&gt;podman-remote version&lt;/summary&gt; ``` Client: Podman Engine Version: 4.3.0-dev API Version: 4.3.0-dev Go Version: go1.18.3 Git Commit: ecaefee43495eed3e387b5cdbd416d85ddaa2254 Built: Thu Sep 22 10:07:10 2022 OS/Arch: linux/amd64 Server: Podman Engine Version: 4.3.0-dev API Version: 4.3.0-dev Go Version: go1.18.3 Git Commit: ecaefee43495eed3e387b5cdbd416d85ddaa2254 Built: Thu Sep 22 10:06:47 2022 OS/Arch: linux/amd64 ``` &lt;/details&gt; &lt;details&gt; &lt;summary&gt;podman-remote info&lt;/summary&gt; ``` host: arch: amd64 buildahVersion: 1.28.0-dev cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.0-2.fc36.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.0, commit: ' cpuUtilization: idlePercent: 99.92 systemPercent: 0.02 userPercent: 0.06 cpus: 12 distribution: distribution: fedora variant: server version: &quot;36&quot; eventLogger: journald hostname: fedora36 idMappings: gidmap: null uidmap: null kernel: 5.18.11-200.fc36.x86_64 linkmode: dynamic logDriver: journald memFree: 6102122496 memTotal: 8326590464 networkBackend: netavark ociRuntime: name: crun package: crun-1.5-1.fc36.x86_64 path: /usr/bin/crun version: |- crun version 1.5 commit: 54ebb8ca8bf7e6ddae2eb919f5b82d1d96863dea spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: unix:///run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: true slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-0.2.beta.0.fc36.x86_64 version: |- slirp4netns version 1.2.0-beta.0 commit: 477db14a24ff1a3de3a705e51ca2c4c1fe3dda64 libslirp: 4.6.1 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.3 swapFree: 8325689344 swapTotal: 8325689344 uptime: 5h 33m 59.00s (Approximately 0.21 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io - quay.io store: configFile: /usr/share/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 106285760512 graphRootUsed: 20381958144 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 1 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.3.0-dev Built: 1663808807 BuiltTime: Thu Sep 22 10:06:47 2022 GitCommit: ecaefee43495eed3e387b5cdbd416d85ddaa2254 GoVersion: go1.18.3 Os: linux OsArch: linux/amd64 Version: 4.3.0-dev ``` &lt;/details&gt; **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** KVM, fedora36</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>235</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #18535 from rhatdan/mount Fix handling of .containenv on tmpfs</MESSAGE>
    <SHA>493aac69e06605a26307bb3d774670c0b1fb5e3b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>remote-save: fix permissions and dir formats Make sure that the directory formats are not just substituted with their archive counterparts but actually tar'ed up directories. Also make sure that the clients don't get chown errors by setting rootless user and group ID instead of O when running in the user namespace. Fixes: #15897 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>d01ae436ee26535a302bee42a357b12f51d19fde</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/libpod/images.go</FILE>
        <FILE>pkg/domain/infra/tunnel/images.go</FILE>
        <FILE>test/e2e/save_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
