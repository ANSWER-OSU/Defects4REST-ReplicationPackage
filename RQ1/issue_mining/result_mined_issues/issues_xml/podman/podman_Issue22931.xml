<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>22931</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/22931</ISSUEURL>
  <TITLE>Quadlet containers in Quadlet pods ignore user namespace</TITLE>
  <DESCRIPTION>### Issue Description If a pod creates a new user namespace and containers are started with the option `--pod-id-file &lt;path&gt;` to associate the container with the pod, the container does not inherit the user namespace of the pod. If the container is instead started with the option `--pod &lt;pod-name&gt;` the container successfully joins the user namespace of the pod. This behavior can be observed in Quadlet containers which are associated with Quadlet pods, because those containers are started with the `--pod-id-file &lt;path&gt;` option. ### Steps to reproduce the issue Steps to reproduce the issue ``` [root@host]# podman pod create --pod-id-file=/run/userns-pod.pod-id --name=userns-pod --userns=auto 12fb65c712557159938a2dd929fdb303a266c6b2809c5a98ed913382e95aab88 [root@host]# cat /run/userns-pod.pod-id 12fb65c712557159938a2dd929fdb303a266c6b2809c5a98ed913382e95aab88 [root@host]# podman run --rm --pod-id-file /run/userns-pod.pod-id fedora:40 cat /proc/self/uid_map /proc/self/gid_map 0 0 4294967295 0 0 4294967295 [root@host]# podman run --rm --pod userns-pod fedora:40 cat /proc/self/uid_map /proc/self/gid_map 0 173728 1024 0 173728 1024 ``` ### Describe the results you received Containers started with the `--pod-id-file` option do not join the user namespace of the pod. ``` [root@host]# podman run --rm --pod-id-file /run/userns-pod.pod-id fedora:40 cat /proc/self/uid_map /proc/self/gid_map 0 0 4294967295 0 0 4294967295 ``` ### Describe the results you expected Containers started with the `--pod-id-file` option should behave the same way as containers started with the `--pod ` option and join the user namespace of the pod. ``` [root@host]# podman run --rm --pod userns-pod fedora:40 cat /proc/self/uid_map /proc/self/gid_map 0 173728 1024 0 173728 1024 ``` ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.36.0 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.10-1.fc40.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.10, commit: ' cpuUtilization: idlePercent: 97.66 systemPercent: 1.48 userPercent: 0.86 cpus: 4 databaseBackend: boltdb distribution: distribution: fedora version: &quot;40&quot; eventLogger: journald freeLocks: 2013 hostname: host idMappings: gidmap: null uidmap: null kernel: 6.8.11-300.fc40.x86_64 linkmode: dynamic logDriver: journald memFree: 4913332224 memTotal: 16531955712 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.10.0-1.fc40.x86_64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.10.0 package: netavark-1.10.3-3.fc40.x86_64 path: /usr/libexec/podman/netavark version: netavark 1.10.3 ociRuntime: name: crun package: crun-1.15-1.fc40.x86_64 path: /usr/bin/crun version: |- crun version 1.15 commit: e6eacaf4034e84185fd8780ac9262bbf57082278 rundir: /run/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt-0^20240510.g7288448-1.fc40.x86_64 version: | pasta 0^20240510.g7288448-1.fc40.x86_64-pasta Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: false path: /run/podman/podman.sock rootlessNetworkCmd: pasta security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: &quot;&quot; package: &quot;&quot; version: &quot;&quot; swapFree: 8588881920 swapTotal: 8589930496 uptime: 72h 20m 25.00s (Approximately 3.00 days) variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io - quay.io store: configFile: /usr/share/containers/storage.conf containerStore: number: 11 paused: 0 running: 11 stopped: 0 graphDriverName: overlay graphOptions: overlay.imagestore: /usr/lib/containers/storage overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 510337744896 graphRootUsed: 42109374464 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;true&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 46 runRoot: /run/containers/storage transientStore: false volumePath: /var/lib/containers/storage/volumes version: APIVersion: 5.1.0 Built: 1716940800 BuiltTime: Wed May 29 02:00:00 2024 GitCommit: &quot;&quot; GoVersion: go1.22.3 Os: linux OsArch: linux/amd64 Version: 5.1.0 ``` ### Podman in a container No ### Privileged Or Rootless Privileged ### Upstream Latest Release Yes ### Additional environment details _No response_ ### Additional information _No response_</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>17</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #23068 from ashley-cui/speedymacci pkg/machine/e2e: Remove unnecessary copy of machine image.</MESSAGE>
    <SHA>fe18a872f7e7efd8ea525edc32234262e1f6d55f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>podman run use pod userns even with --pod-id-file The pod was set after we checked the namespace and the namespace code only checked the --pod flag but didn't consider --pod-id-file option. As such fix the check to first set the pod option on the spec then use that for the namespace. Also make sure we always use an empty default otherwise it would be impossible in the backend to know if a user requested a specific userns or not, i.e. even in case of a set PODMAN_USERNS env a container should still get the userns from the pod and not use the var in this case. Therefore unset it from the default cli value. There are more issues here around --pod-id-file and cli validation that does not consider the option as conflicting with --userns like --pod does but I decided to fix the bug at hand and don't try to fix the entire mess which most likely would take days. Fixes #22931 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>a158eae7ff188102e54ec0a7ca570c3746fedefa</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/common/create.go</FILE>
        <FILE>cmd/podman/kube/play.go</FILE>
        <FILE>pkg/specgenutil/specgen.go</FILE>
        <FILE>test/e2e/run_userns_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman run use pod userns even with --pod-id-file The pod was set after we checked the namespace and the namespace code only checked the --pod flag but didn't consider --pod-id-file option. As such fix the check to first set the pod option on the spec then use that for the namespace. Also make sure we always use an empty default otherwise it would be impossible in the backend to know if a user requested a specific userns or not, i.e. even in case of a set PODMAN_USERNS env a container should still get the userns from the pod and not use the var in this case. Therefore unset it from the default cli value. There are more issues here around --pod-id-file and cli validation that does not consider the option as conflicting with --userns like --pod does but I decided to fix the bug at hand and don't try to fix the entire mess which most likely would take days. Fixes #22931 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>d230a6b91272d3438653a56a1395d01a7620a249</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/common/create.go</FILE>
        <FILE>cmd/podman/kube/play.go</FILE>
        <FILE>pkg/specgenutil/specgen.go</FILE>
        <FILE>test/e2e/run_userns_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
