<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14401</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14401</ISSUEURL>
  <TITLE>Podman machine ssh does not preserve exit status from SSH</TITLE>
  <DESCRIPTION>**Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** When executing a command against the Podman VM the exit status of the command is not preserved and relayed back to the host correctly. It is a standard expectation that the exit status is preserved, after all, SSH itself does. **Steps to reproduce the issue:** 1. `podman machine ssh exit 5 ; echo $?` incorrectly yields `125` and it should be `5` 2. `podman machine ssh exit 0 ; echo $?` correctly yields `0` 3. `ssh -i ~/.ssh/podman-machine-default -p &lt;podman-port&gt; core@localhost exit 5 ; echo $?` correctly yields `5` 4. `ssh -i ~/.ssh/podman-machine-default -p &lt;podman-port&gt; core@localhost exit 0 ; echo $?` correctly yields `0` **Describe the results you received:** Whenever the lasts executed command via `podman machine ssh` returns a non-zero exit status in the VM the result of `$?` on the host for last process exit status is incorrectly and always reported as `125`. **Describe the results you expected:** The exit status as returned in the VM from the last command execution should be accurately reflected on the host via `$?`, just like `ssh`. **Additional information you deem important (e.g. issue happens only occasionally):** **Output of `podman version`:** ``` Client: Podman Engine Version: 4.1.0 API Version: 4.1.0 Go Version: go1.18.1 Built: Thu May 5 15:07:47 2022 OS/Arch: darwin/arm64 Server: Podman Engine Version: 4.1.0 API Version: 4.1.0 Go Version: go1.18 Built: Fri May 6 11:16:38 2022 OS/Arch: linux/arm64 ``` **Output of `podman info --debug`:** ``` host: arch: arm64 buildahVersion: 1.26.1 cgroupControllers: - cpu - io - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.0-2.fc36.aarch64 path: /usr/bin/conmon version: 'conmon version 2.1.0, commit: ' cpuUtilization: idlePercent: 99.17 systemPercent: 0.56 userPercent: 0.27 cpus: 1 distribution: distribution: fedora variant: coreos version: &quot;36&quot; eventLogger: journald hostname: localhost.localdomain idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 1000000 uidmap: - container_id: 0 host_id: 501 size: 1 - container_id: 1 host_id: 100000 size: 1000000 kernel: 5.17.9-300.fc36.aarch64 linkmode: dynamic logDriver: journald memFree: 1675538432 memTotal: 2052694016 networkBackend: netavark ociRuntime: name: crun package: crun-1.4.4-1.fc36.aarch64 path: /usr/bin/crun version: |- crun version 1.4.4 commit: 6521fcc5806f20f6187eb933f9f45130c86da230 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: /run/user/501/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: true slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-0.2.beta.0.fc36.aarch64 version: |- slirp4netns version 1.2.0-beta.0 commit: 477db14a24ff1a3de3a705e51ca2c4c1fe3dda64 libslirp: 4.6.1 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.3 swapFree: 0 swapTotal: 0 uptime: 18m 27.76s plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - docker.io store: configFile: /var/home/core/.config/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /var/home/core/.local/share/containers/storage graphRootAllocated: 106825756672 graphRootUsed: 2438529024 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 0 runRoot: /run/user/501/containers volumePath: /var/home/core/.local/share/containers/storage/volumes version: APIVersion: 4.1.0 Built: 1651853798 BuiltTime: Fri May 6 11:16:38 2022 GitCommit: &quot;&quot; GoVersion: go1.18 Os: linux OsArch: linux/arm64 Version: 4.1.0 ``` **Package info (e.g. output of `brew info podman`):** ``` podman: stable 4.1.0 (bottled), HEAD Tool for managing OCI containers and pods https://podman.io/ /opt/Homebrew/Cellar/podman/4.1.0 (174 files, 46.3MB) * Poured from bottle on 2022-05-20 at 22:19:07 From: https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/podman.rb License: Apache-2.0 ==&gt; Dependencies Build: go, go-md2man Required: qemu ==&gt; Options --HEAD Install HEAD version ==&gt; Caveats zsh completions have been installed to: /opt/Homebrew/share/zsh/site-functions ==&gt; Analytics install: 21,403 (30 days), 58,046 (90 days), 148,111 (365 days) install-on-request: 21,349 (30 days), 57,984 (90 days), 148,036 (365 days) build-error: 0 (30 days) ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** This behavior has been present since at least podman 3.4.4 on MacOS both M1 and Intel processors and includes, at least, Big Sur and Monterrey.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix bad import path for cmd/podman/utils Libpod or packages under /pkg should never import from /cmd/... This will quickly result in import cycles and weird code paths. Also there is no reason to use this special code we can just use syscall.SIGHUB as SIGNAL. Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
    <SHA>a6f8cad545fa3242a2778c9a0d25da4da0a51ce2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>podman machine ssh: set correct exit code Forward the ssh exit code to the podman caller. This is useful for scripts. Use the same logic as podman unshare. Fixes #14401 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>0e58636c3a599bb3d7d5ef06ab2773befe8a0150</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/machine/ssh.go</FILE>
        <FILE>cmd/podman/system/unshare.go</FILE>
        <FILE>cmd/podman/utils/error.go</FILE>
        <FILE>docs/source/markdown/podman-machine-ssh.1.md</FILE>
        <FILE>pkg/machine/e2e/config.go</FILE>
        <FILE>pkg/machine/e2e/ssh_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
