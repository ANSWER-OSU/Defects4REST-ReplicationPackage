<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>23246</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/23246</ISSUEURL>
  <TITLE>podman start --filter restart-policy=always : container state improper</TITLE>
  <DESCRIPTION>Looks related to #22914, although probably not a regression (that one was a reliable panic, this is a flaky podman error): ``` [+0319s] not ok 151 [045] podman start --filter - start only containers that match the filter in 1914ms ... &lt;+010ms&gt; # $ podman start --filter restart-policy=always &lt;&lt;&lt; first restart &lt;+268ms&gt; # e214e6b649c557e0b24e610cb2bb986694f01f16e5545337195319b5f86763c8 # 877d80fe7cfa11755af13fe02dbf4a359887ac6ca40e41b17f67b3d1c08392d9 # &lt;+074ms&gt; # $ podman start --filter restart-policy=always &lt;&lt;&lt;&lt; second restart &lt;+351ms&gt; # Error: unable to start container &quot;e214e6b649c557e0b24e610cb2bb986694f01f16e5545337195319b5f86763c8&quot;: container e214e6b649c557e0b24e610cb2bb986694f01f16e5545337195319b5f86763c8 must be in Created or Stopped state to be started: container state improper ``` For extra credit, maybe someone could fix that error message to indicate the actual current container state * fedora-39 : sys podman fedora-39 rootless host boltdb * PR #22726 * [07-10 09:35](https://api.cirrus-ci.com/v1/artifact/task/6475531296702464/html/sys-podman-fedora-39-rootless-host-boltdb.log.html#t--00151) in [sys] [045] podman start --filter - start only containers that match the filter * [07-08 14:00](https://api.cirrus-ci.com/v1/artifact/task/5449520568336384/html/sys-podman-fedora-39-rootless-host-boltdb.log.html#t--00151) in [sys] [045] podman start --filter - start only containers that match the filter * rawhide : sys podman rawhide rootless host sqlite * PR #22425 * [07-10 13:35](https://api.cirrus-ci.com/v1/artifact/task/5628035582394368/html/sys-podman-rawhide-rootless-host-sqlite.log.html#t--00151) in [sys] [045] podman start --filter - start only containers that match the filter | x | x | x | x | x | x | | ---: | ---: | ---: | ---: | ---: | ---: | | sys(3) | podman(3) | fedora-39(2) | rootless(3) | host(3) | boltdb(2) | | | | rawhide(1) | | | sqlite(1) |</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #23234 from Luap99/test-nftables test netavark nftables driver</MESSAGE>
    <SHA>360c4f372dceb35727e80d3f13ae2438766368f9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix race conditions in start/attach logic The current code did something like this: lock() getState() unlock() if state != running lock() getState() == running -&gt; error unlock() This of course is wrong because between the first unlock() and second lock() call another process could have modified the state. This meant that sometimes you would get a weird error on start because the internal setup errored as the container was already running. In general any state check without holding the lock is incorrect and will result in race conditions. As such refactor the code to combine both StartAndAttach and Attach() into one function that can handle both. With that we can move the running check into the locked code. Also use typed error for this specific error case then the callers can check and ignore the specific error when needed. This also allows us to fix races in the compat API that did a similar racy state check. This commit changes slightly how we output the result, previously a start on already running container would never print the id/name of the container which is confusing and sort of breaks idempotence. Now it will include the output except when --all is used. Then it only reports the ids that were actually started. Fixes #23246 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>3280da0500e9f78901e86575ba2bdffd83fd1b66</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_api.go</FILE>
        <FILE>libpod/container_internal.go</FILE>
        <FILE>libpod/define/errors.go</FILE>
        <FILE>libpod/oci_conmon_attach_common.go</FILE>
        <FILE>pkg/api/handlers/compat/containers_start.go</FILE>
        <FILE>pkg/domain/infra/abi/containers.go</FILE>
        <FILE>pkg/domain/infra/abi/terminal/terminal_common.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
