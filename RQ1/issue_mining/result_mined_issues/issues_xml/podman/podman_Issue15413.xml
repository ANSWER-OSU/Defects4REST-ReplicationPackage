<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15413</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15413</ISSUEURL>
  <TITLE>CONTAINERS_CONF envariable insufficient for testing</TITLE>
  <DESCRIPTION>It's not as clear as I'd like, but this is the containers.conf man page: &gt;If the CONTAINERS_CONF path environment variable is set, just this path will be used. This is primarily used for testing. To be 100% explicit: &quot;just this path&quot; means &quot;podman will only read this file, ignoring all other `containers.conf` files in `/usr/share/containers` an `/etc/containers`. This is causing headaches and gaps in our test coverage, specifically Ubuntu and RHEL8 which use cgroups v1: ```console # podman info --format '{{.Host.OCIRuntime.Name}}' runc ! create a dummy empty containers.conf # truncate --size=0 /tmp/containers-foo.conf # CONTAINERS_CONF=/tmp/containers-foo.conf podman info --format '{{.Host.OCIRuntime.Name}}' crun ``` There are a ton of system tests that write custom `containers.conf` files with stuff like `userns=&quot;auto&quot;`, `dns-this-that`, `infra_image`, `events_logger`. All of those, on Ubuntu and RHEL8, are being run with `crun` instead of the expected `runc`. (This probably doesn't matter with some options, but I bet it does with `userns`). It also means that podman is running with its full capability set. This is really hard to fix. The options I see are: * make `CONTAINERS_CONF` mean &quot;in addition to&quot; not &quot;exclusively&quot;. Nonstarter: it breaks compatibility (not a big deal on a test-only setting) but also breaks tests that require an exactly-tuned `containers.conf`. * Add a new element to the end of the default containers-conf-file read path, maybe something in `/run`. Or add a new `CONTAINERS_CONF_PATH` envariable that defines what that path should be. (IMHO: Ewwww) * Add a new `CONTAINERS_CONF_EXTRA` envariable whose meaning is, &quot;first read all the defaults, then read this one&quot; * Add a `--dump-containers-conf` option to podman, such that tests can use that to `&gt;/tmp/mycontainers.conf` and edit that * Make it the test-writer's problem to write runtime engine, DefaultCapabilities, Logging, and every other possible necessary setting before invoking `podman run` * Have tests write their own overrides into `/etc/containers/containers.conf.d` or the rootless equivalent (Nope. One of my hard-fast- principles is never to vandalize a system. If test crashes, this would leave a user's system in a nonstandard, possibly unusable, state) Suggestions (and fixes) welcome.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>231</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #17895 from vrothberg/containers_conf_extra add CONTAINERS_CONF_OVERRIDE</MESSAGE>
    <SHA>905dc6de48e38c8ce4be675f947355a862b9afb5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>system tests: use CONTAINERS_CONF_OVERRIDE ...not CONTAINERS_CONF. At least for most tests. Nearly every system test currently using CONTAINERS_CONF=tmpfile should be using CONTAINERS_CONF_OVERRIDE. Simple reason: runtime (crun/runc), database_backend (bolt/sqlite), logger, and other important settings from /etc/c.conf are not usually written into the tmpfile. Those tests, therefore, are not running podman as configured on the system. Much more discussion: #15413 This PR is a prerequisite for enabling sqlite system tests. For the sake of simplicity and sanity, I choose to submit the sqlite switch as a separate PR once this passes and merges. Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>d85c8d7e842e9e94d69b7c379b100cd81d25a35e</SHA>
      <PATCHEDFILES>
        <FILE>test/system/030-run.bats</FILE>
        <FILE>test/system/070-build.bats</FILE>
        <FILE>test/system/090-events.bats</FILE>
        <FILE>test/system/160-volumes.bats</FILE>
        <FILE>test/system/170-run-userns.bats</FILE>
        <FILE>test/system/200-pod.bats</FILE>
        <FILE>test/system/500-networking.bats</FILE>
        <FILE>test/system/700-play.bats</FILE>
        <FILE>test/system/800-config.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
