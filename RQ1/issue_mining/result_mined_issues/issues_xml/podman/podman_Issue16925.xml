<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>16925</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/16925</ISSUEURL>
  <TITLE>not possible to share tty (e.g. usb-dongle) devices with privileged containers</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** I want to run a rootless privileged podman container and access a Sonoff USB zigbee stick in the container. The container shows up on the host as /dev/ttyACM0. The host user has access to the device. In the container the device node is missing. I found the previous related bugfix https://github.com/containers/podman/pull/3593. I believe the issue is that in `AddPrivilegedDevices()` devices are skipped if their path starts with `/dev/tty`: https://github.com/containers/podman/blob/d20dbcd155e09842e8c2c81e14f7a97aed755f44/pkg/util/utils_linux.go#L93-L95 **Steps to reproduce the issue:** 1. have a tty device to share on the host: ``` $ ls -la /dev/ttyACM0 crw-rw---- 1 root dialout 166, 0 Dec 22 18:30 /dev/ttyACM0 $ groups homeassistant dialout ``` 2. run a privilieged podman container and check if /dev/ttyACM0 is available: ``` $ podman run -i -t --privileged ghcr.io/home-assistant/home-assistant:2022.12.7 ls /dev/tty* ``` **Describe the results you received:** /dev/ttyACM0 device file does not exist in the container **Describe the results you expected:** /dev/ttyACM0 exists in the container **Additional information you deem important (e.g. issue happens only occasionally):** I can share the device via `--device` if i start it as unprivileged container. **Output of `podman version`:** ``` podman version 4.3.1 ``` **Output of `podman info`:** N/A **Package info (e.g. output of `rpm -q podman` or `apt list podman` or `brew info podman`):** N/A **Have you tested with the latest version of Podman and have you checked [the Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md)?** No, same if-condition exist in the latest commit in main (d20dbcd) branch.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>20</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #17038 from ygalblum/quadlet-kube-configmap Quadlet: Add support for ConfigMap key in Kube section</MESSAGE>
    <SHA>382c55eeaa8d7d756d4bb11483d2722844e1795a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Only prevent VTs to be mounted inside privileged systemd containers While mounting virtual console devices in a systemd container is a recipe for disaster (I experienced it first hand), mounting serial console devices, modems, and others should still be done by default for privileged systemd-based containers. v2, addressing the review from @fho: - use backticks in the regular expression to remove backslashes - pre-compile the regex at the package level - drop IsVirtualTerminalDevice (not needed for a one-liner) v3, addressing the review from @fho and @rhatdan: - re-introduce a private function for matching the device names - use path.Match rather than a regex not to slow down startup time Closes #16925. Fixes: 5a2405ae1b3a (&quot;Don't mount /dev/tty* inside privileged...&quot;) Signed-off-by: Martin Roukala (né Peres) &lt;martin.roukala@mupuf.org&gt;</MESSAGE>
      <SHA>f4c81b0aa5fd1528be9baf2603fe54dd66a23954</SHA>
      <PATCHEDFILES>
        <FILE>pkg/util/utils_linux.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Make rootless privileged containers share the same tty devices as rootfull ones Until Podman v4.3, privileged rootfull containers would expose all the host devices to the container while rootless ones would exclude `/dev/ptmx` and `/dev/tty*`. When 5a2405ae1b3a (&quot;Don't mount /dev/tty* inside privileged containers running systemd&quot;) landed, rootfull containers started excluding all the `/dev/tty*` devices when the container would be running in systemd mode, reducing the disparity between rootless and rootfull containers when running in this mode. However, this commit regressed some legitimate use cases: exposing non-virtual-terminal tty devices (modems, arduinos, serial consoles, ...) to the container, and the regression was addressed in f4c81b0aa5fd (&quot;Only prevent VTs to be mounted inside privileged systemd containers&quot;). This now calls into question why all tty devices were historically prevented from being shared to the rootless non-privileged containers. A look at the podman git history reveals that the code was introduced as part of ba430bfe5ef6 (&quot;podman v2 remove bloat v2&quot;), and obviously was copy-pasted from some other code I couldn't find. In any case, we can easily guess that this check was put for the same reason 5a2405ae1b3a was introduced: to prevent breaking the host environment's consoles. This also means that excluding *all* tty devices is overbearing, and should instead be limited to just virtual terminals like we do on the rootfull path. This is what this commit does, thus making the rootless codepath behave like the rootfull one when in systemd mode. This leaves `/dev/ptmx` as the main difference between the two codepath. Based on the blog post from the then-runC maintainer[1] and this Red Hat bug[2], I believe that this is intentional and a needed difference for the rootless path. Closes: #16925 Suggested-by: Fabian Holler &lt;mail@fholler.de&gt; Signed-off-by: Martin Roukala (né Peres) &lt;martin.roukala@mupuf.org&gt; [1]: https://www.cyphar.com/blog/post/20160627-rootless-containers-with-runc [2]: https://bugzilla.redhat.com/show_bug.cgi?id=501718</MESSAGE>
      <SHA>70057c8b477c0fc6b9f9f26160d85d513288326b</SHA>
      <PATCHEDFILES>
        <FILE>pkg/util/utils_linux.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
