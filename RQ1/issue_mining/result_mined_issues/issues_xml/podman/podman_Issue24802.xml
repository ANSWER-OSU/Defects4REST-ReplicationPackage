<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24802</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/24802</ISSUEURL>
  <TITLE>Rootless Integration tests in Debian fail with &quot;Lchown failed: operation not permitted&quot;.</TITLE>
  <DESCRIPTION>### Issue Description This is triggered by the specific way Debian's autopkgtest framework sets up the sources. To illustrate, I was able to workaround this with this patch: ``` --- test/e2e/common_test.go | 2 +- 1 file changed, 1 insertion(+), 1 deletion(-) diff --git a/test/e2e/common_test.go b/test/e2e/common_test.go index 61fed90..6d938cf 100644 --- a/test/e2e/common_test.go +++ b/test/e2e/common_test.go @@ -1490,7 +1490,7 @@ func CopyDirectory(srcDir, dest string) error { } if err := os.Lchown(destPath, int(stat.Uid), int(stat.Gid)); err != nil { - return err + GinkgoWriter.Printf(&quot;Warning: Failed to chown %s to uid=%d, gid=%d: %v\n&quot;, destPath, int(stat.Uid), int(stat.Gid), err) } fInfo, err := entry.Info() ``` Now I'm getting this output in the log: ``` &gt; Enter [It] template@.container - /tmp/autopkgtest.lL1okL/build.rYm/real-tree/_build/src/github.com/containers/podman/test/e2e/quadlet_test.go:921 @ 12/06/24 15:12:56.818 Warning: Failed to chown /tmp/podman-e2e-2554937726/subtest-376925938/quadlet/template@.container.d/10-env.conf to uid=1000, gid=0: lchown /tmp/podman-e2e-2554937726/subtest-376925938/quadlet/template@.container.d/10-env.conf: operation not permitted Running: /usr/libexec/podman/quadlet --user --no-kmsg-log /tmp/podman-e2e-2554937726/subtest-376925938/generated with QUADLET_UNIT_DIRS=/tmp/podman-e2e-2554937726/subtest-376925938/quadlet &lt; Exit [It] template@.container - /tmp/autopkgtest.lL1okL/build.rYm/real-tree/_build/src/github.com/containers/podman/test/e2e/quadlet_test.go:921 @ 12/06/24 15:12:56.831 (12ms) ```` Apparently this is because the sources are installed into the build environment with uid=1000 but gid=0, and the copy operation is failing at setting the gid. Is that chown really necessary? ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details Additional environment details ### Additional information Additional information like issue happens only occasionally or issue happens with a particular architecture or on a particular setting</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>9</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>test/system: remove system dial-stdio test This test a pretty much useless, it checks that a connection attempt on the default socket fails. But this is incorrect as the socket is outside of the test control as such it might be ready to accept connections as thus the test can fail locally or as reported here in the debian tests. Given that a simple connection fails does not add any value I opted to remove it. Fixes #24803 Signed-off-by: Paul Holzinger &lt;git@holzinger.dev&gt;</MESSAGE>
    <SHA>87297256841125cc7c841753ef097d09c381d696</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>test/system: CopyDirectory() do not chown files If the source dir is owned by another user then the test the chown will fail assuming we run the tests rootless. This function is only used by the quadlet tests and for the purpose all we need is to read the files so the simple fix is remove the chown as this should make the tests pass on the special debian gating env. Fixes #24802 Signed-off-by: Paul Holzinger &lt;git@holzinger.dev&gt;</MESSAGE>
      <SHA>23d4908c8bda1e4d86d6c799c51ff9ffc3374337</SHA>
      <PATCHEDFILES>
        <FILE>test/e2e/common_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>test/system: CopyDirectory() do not chown files If the source dir is owned by another user then the test the chown will fail assuming we run the tests rootless. This function is only used by the quadlet tests and for the purpose all we need is to read the files so the simple fix is remove the chown as this should make the tests pass on the special debian gating env. Fixes #24802 Signed-off-by: Paul Holzinger &lt;git@holzinger.dev&gt;</MESSAGE>
      <SHA>4c04d0e717a664b873c30486ec4841faf17a2908</SHA>
      <PATCHEDFILES>
        <FILE>test/e2e/common_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
