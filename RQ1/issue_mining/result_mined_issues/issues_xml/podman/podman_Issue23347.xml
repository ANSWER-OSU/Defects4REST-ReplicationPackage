<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>23347</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/23347</ISSUEURL>
  <TITLE>Named volume incorrectly mapped with any `userns` option but `&quot;&quot;`</TITLE>
  <DESCRIPTION>### Issue Description I am running rootless podman. If I run with any option but `&quot;&quot;` for `userns` then, whenever I try to mount a volume on a rootless image at a mount point created during build, the ownership of the directory get corrupted. In particular, I see `UID=GID=999`. ### Steps to reproduce the issue Steps to reproduce the issue 1. Make a minimal `Dockerfile` that creates a non-root user and directory inside his `$HOME` ```Dockerfile FROM alpine AS test-image RUN adduser -D test-user USER test-user RUN mkdir /home/test-user/test-dir CMD [ &quot;/bin/sh&quot; ] ``` 2. Create an image from it ```shell $ podman build -t test-image . ``` 3. Run the container mounting a named volume and see its ownership ```shell $ podman run --rm -it -v test-volume:/home/test-user/test-dir test-image ls -ln /home/test-user total 4 drwxr-sr-x 2 1000 1000 4096 Jul 19 18:31 test-dir ``` 4. Re-run but using any `userns` option but `uid=999,gid=999`, and get ```shell $ podman volume rm test-volume &amp;&amp; podman run --rm -it --userns=keep-id -v test-volume:/home/test-user/test-dir test-image ls -ln /home/test-user total 4 drwxr-sr-x 2 999 999 4096 Jul 19 18:31 test-dir ``` ### Describe the results you received I get ownership `999` for the volume's UID. ### Describe the results you expected I would expect to get `1000` for the volume's UID. ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.37.0-dev cgroupControllers: - cpu - io - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.10-1.fc40.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.10, commit: ' cpuUtilization: idlePercent: 87.42 systemPercent: 2.51 userPercent: 10.07 cpus: 8 databaseBackend: sqlite distribution: distribution: fedora variant: workstation version: &quot;40&quot; eventLogger: journald freeLocks: 2038 hostname: someuser-laptop idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 524288 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 524288 size: 65536 kernel: 6.9.6-200.fc40.x86_64 linkmode: dynamic logDriver: journald memFree: 678354944 memTotal: 16442929152 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.11.0-1.fc40.x86_64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.11.0 package: netavark-1.11.0-1.fc40.x86_64 path: /usr/libexec/podman/netavark version: netavark 1.11.0 ociRuntime: name: crun package: crun-1.15-1.fc40.x86_64 path: /usr/bin/crun version: |- crun version 1.15 commit: e6eacaf4034e84185fd8780ac9262bbf57082278 rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt-0^20240624.g1ee2eca-1.fc40.x86_64 version: | pasta 0^20240624.g1ee2eca-1.fc40.x86_64 Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: true path: /run/user/1000/podman/podman.sock rootlessNetworkCmd: pasta security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.2-2.fc40.x86_64 version: |- slirp4netns version 1.2.2 commit: 0ee2d87523e906518d34a6b423271e4826f71faf libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.5 swapFree: 9933959168 swapTotal: 21474828288 uptime: 435h 23m 40.00s (Approximately 18.12 days) variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io store: configFile: /home/someuser/.config/containers/storage.conf containerStore: number: 1 paused: 0 running: 1 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /home/someuser/.local/share/containers/storage graphRootAllocated: 314163765248 graphRootUsed: 187244351488 graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;false&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 106 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/someuser/.local/share/containers/storage/volumes version: APIVersion: 5.2.0-dev-5e47444a9 Built: 1721347200 BuiltTime: Fri Jul 19 02:00:00 2024 GitCommit: &quot;&quot; GoVersion: go1.22.5 Os: linux OsArch: linux/amd64 Version: 5.2.0-dev-5e47444a9 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details Additional environment details ### Additional information I still get confused about ns mapping, as you might realize. But I would think this is not the expected behavior, otherwise it would be impossible (or I cannot see how it would be done) to have both bind mounts and volume mounts, in the case that the volume mount overrides something previously written during build, for the same container.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>59</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #23893 from afbjorklund/ssh-config-refactor refactor: add sshClient function</MESSAGE>
    <SHA>b1efc500b46d85019c22190783b8e6e9af8eb1f8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>libpod: convert owner IDs only with :idmap convert the owner UID and GID into the user namespace only when &quot;:idmap&quot; mount is used. This changes the behaviour of :idmap with an empty volume. Now the existing directory ownership is copied up as in the other case. Closes: https://github.com/containers/podman/issues/23347 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
      <SHA>432325236b7d195045edb9a4cc47be00f71d407f</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/runtime_ctr.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>libpod: convert owner IDs only with :idmap convert the owner UID and GID into the user namespace only when &quot;:idmap&quot; mount is used. This changes the behaviour of :idmap with an empty volume. Now the existing directory ownership is copied up as in the other case. Closes: https://github.com/containers/podman/issues/23347 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
      <SHA>aaf15f81c4ac7bf401634e7ea0f157cc29e3fc1a</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/runtime_ctr.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>libpod: convert owner IDs only with :idmap convert the owner UID and GID into the user namespace only when &quot;:idmap&quot; mount is used. This changes the behaviour of :idmap with an empty volume. Now the existing directory ownership is copied up as in the other case. Closes: https://github.com/containers/podman/issues/23347 Closes: https://issues.redhat.com/browse/RHEL-67842 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt; (cherry picked from commit 432325236b7d195045edb9a4cc47be00f71d407f)</MESSAGE>
      <SHA>8b8d2139b28a797705adeef0e587fdf98d4a00a5</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/runtime_ctr.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
