<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>16135</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/16135</ISSUEURL>
  <TITLE>podman system df does not seem to report actual disk usage</TITLE>
  <DESCRIPTION>**Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** `podman system df` doesn't show actual disk usage of container images. Looking to find the actual disk usage of the images on disk I tried the `podman system df` command. The image size output was 50% larger than my entire virtual disk. **Steps to reproduce the issue:** 1. Pull many images that have common bases. I installed SNO on a VM with a 20G disk. 2. Check `podman system df` 3. See actual disk usage of images **Describe the results you received:** The size of images reported vastly exceeds disk capacity. ``` # podman system df TYPE TOTAL ACTIVE SIZE RECLAIMABLE Images 75 75 30.21GB 0B (0%) Containers 0 0 0B 0B (0%) Local Volumes 0 0 0B 0B (0%) ``` **Describe the results you expected:** Actual disk usage information. **Additional information you deem important (e.g. issue happens only occasionally):** ``` # lsblk Filesystem Size Used Avail Use% Mounted on devtmpfs 7.8G 0 7.8G 0% /dev tmpfs 7.9G 168K 7.9G 1% /dev/shm tmpfs 7.9G 61M 7.8G 1% /run tmpfs 7.9G 0 7.9G 0% /sys/fs/cgroup **/dev/vda4 20G 16G 3.6G 82% /sysroot** tmpfs 7.9G 4.0K 7.9G 1% /tmp /dev/vda3 350M 103M 225M 32% /boot ... # du -shc /var/lib/containers/storage/overlay/*/diff ... **11G total** ``` **Output of `podman version`:** ``` Client: Podman Engine Version: 4.0.2 API Version: 4.0.2 Go Version: go1.18 Built: Wed Jun 15 08:06:29 2022 OS/Arch: linux/amd64 ``` **Output of `podman info`:** ``` Client: Podman Engine Version: 4.0.2 API Version: 4.0.2 Go Version: go1.18 Built: Wed Jun 15 08:06:29 2022 OS/Arch: linux/amd64 [root@api-int storage]# podman info host: arch: amd64 buildahVersion: 1.24.4 cgroupControllers: - cpuset - cpu - cpuacct - blkio - memory - devices - freezer - net_cls - perf_event - net_prio - hugetlb - pids - rdma cgroupManager: systemd cgroupVersion: v1 conmon: package: conmon-2.1.2-2.rhaos4.11.el8.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.2, commit: 2d84c39981acfc41e61c1c8b21ce9e8941ce41de' cpus: 4 distribution: distribution: '&quot;rhcos&quot;' version: &quot;4.11&quot; eventLogger: file hostname: api-int.sno.ocp.lan idMappings: gidmap: null uidmap: null kernel: 4.18.0-372.26.1.el8_6.x86_64 linkmode: dynamic logDriver: journald memFree: 878510080 memTotal: 16797462528 networkBackend: cni ociRuntime: name: runc package: runc-1.1.2-1.rhaos4.11.el8.x86_64 path: /usr/bin/runc version: |- runc version 1.1.2 spec: 1.0.2-dev go: go1.18 libseccomp: 2.5.2 os: linux remoteSocket: path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_NET_RAW,CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /bin/slirp4netns package: slirp4netns-1.1.8-1.rhaos4.11.el8.x86_64 version: |- slirp4netns version 1.1.8 commit: d361001f495417b880f20329121e3aa431a8f90f libslirp: 4.4.0 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.2 swapFree: 0 swapTotal: 0 uptime: 2h 10m 29.51s (Approximately 0.08 days) plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.access.redhat.com - docker.io store: configFile: /etc/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /var/lib/containers/storage graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 75 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.0.2 Built: 1655280389 BuiltTime: Wed Jun 15 08:06:29 2022 GitCommit: &quot;&quot; GoVersion: go1.18 OsArch: linux/amd64 Version: 4.0.2 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman` or `brew info podman`):** ``` podman-4.0.2-6.rhaos4.11.el8.x86_64 ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** No, this is the latest version shipped with OCP. I tried to reproduce on a different host with RHEL 8.6 and podman 4.1.1; it seemed to still report disk usage the same way. **Additional environment details (AWS, VirtualBox, physical, etc.):** libvirt VM</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #16207 from rhatdan/reference Reference</MESSAGE>
    <SHA>2fb7218e63e7c915dbbcb7eecf871d68d45846bd</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>system df: fix image-size calculations Fix two bugs in `system df`: 1. The total size was calculated incorrectly as it was creating the sum of all image sizes but did not consider that a) the same image may be listed more than once (i.e., for each repo-tag pair), and that b) images share layers. The total size is now calculated directly in `libimage` by taking multi-layer use into account. 2. The reclaimable size was calculated incorrectly. This number indicates which data we can actually remove which means the total size minus what containers use (i.e., the &quot;unique&quot; size of the image in use by containers). NOTE: The c/storage version is pinned back to the previous commit as it is buggy. c/common already requires the buggy version, so use a `replace` to force/pin. Fixes: #16135 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>34235b27267feb8fd5c5d16322f23fb270eabe97</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/system/df.go</FILE>
        <FILE>go.mod</FILE>
        <FILE>go.sum</FILE>
        <FILE>pkg/domain/entities/system.go</FILE>
        <FILE>pkg/domain/infra/abi/system.go</FILE>
        <FILE>test/apiv2/45-system.at</FILE>
        <FILE>test/system/320-system-df.bats</FILE>
        <FILE>vendor/github.com/containers/common/libimage/disk_usage.go</FILE>
        <FILE>vendor/github.com/containers/common/libimage/filters.go</FILE>
        <FILE>vendor/github.com/containers/common/libimage/image.go</FILE>
        <FILE>vendor/github.com/containers/common/libimage/layer_tree.go</FILE>
        <FILE>vendor/github.com/containers/common/libimage/platform.go</FILE>
        <FILE>vendor/github.com/containers/common/libnetwork/cni/cni_conversion.go</FILE>
        <FILE>vendor/github.com/containers/common/libnetwork/netavark/network.go</FILE>
        <FILE>vendor/github.com/containers/common/libnetwork/network/interface.go</FILE>
        <FILE>vendor/github.com/containers/common/libnetwork/resolvconf/resolvconf.go</FILE>
        <FILE>vendor/github.com/containers/common/libnetwork/types/network.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/cgroups/cgroups.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/cgroups/cgroups_linux.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/cgroups/cgroups_supported.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/cgroups/pids.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/cgroups/systemd.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/cgroups/systemd_linux.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/cgroups/utils.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/config/config.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/config/default.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/config/default_freebsd.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/config/default_linux.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/config/systemd.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/download/download.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/filters/filters.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/hooks/hooks.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/hooks/monitor.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/hooks/read.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/machine/machine.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/parse/parse.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/report/camelcase/camelcase.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/report/doc.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/report/formatter.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/report/template.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/report/validate.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/secrets/filedriver/filedriver.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/secrets/passdriver/passdriver.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/secrets/secrets.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/secrets/secretsdb.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/ssh/utils.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/subscriptions/subscriptions.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/sysinfo/sysinfo_linux.go</FILE>
        <FILE>vendor/github.com/containers/common/pkg/timetype/timestamp.go</FILE>
        <FILE>vendor/modules.txt</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
