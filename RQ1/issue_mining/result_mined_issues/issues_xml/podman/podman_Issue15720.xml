<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15720</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15720</ISSUEURL>
  <TITLE>REST API /system/df UsageData.RefCount on volumes is always 1</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** In order to see who is using a volume, I'm using the `RefCount` attribute of `UsageData` field But even if you create a volume without using it, it returns 1. And if you create multiple containers using that volume, it's still using 1 **Steps to reproduce the issue:** 1. Create a volume without using it ```bash $ dummyVolume=$(podman volume create) ``` 2. Use REST api to see refCount ``` $ curl --silent --unix-socket /Users/benoitf/.local/share/containers/podman/machine/podman-machine-default/podman.sock &quot;http:/v1.41/system/df&quot; | jq --arg volumeName $dummyVolume '.Volumes[] | select(.Name == ($volumeName))' { &quot;Driver&quot;: &quot;&quot;, &quot;Labels&quot;: {}, &quot;Mountpoint&quot;: &quot;&quot;, &quot;Name&quot;: &quot;413f47a2d1656a4ec6e876543dc8a0caa5256c670a425638eff7be9730da0229&quot;, &quot;Options&quot;: null, &quot;Scope&quot;: &quot;local&quot;, &quot;UsageData&quot;: { &quot;RefCount&quot;: 1, &quot;Size&quot;: 0 } } ``` It's already invalid 3. Now, try to start containers using that volume ```bash $ podman run -d --mount &quot;type=volume,src=$dummyVolume,target=/foo&quot; docker.io/library/httpd $ podman run -d --mount &quot;type=volume,src=$dummyVolume,target=/foo&quot; docker.io/library/httpd ``` 4. Rest API is still invalid ```bash $ curl --silent --unix-socket /Users/benoitf/.local/share/containers/podman/machine/podman-machine-default/podman.sock &quot;http:/v1.41/system/df&quot; | jq --arg volumeName $dummyVolume '.Volumes[] | select(.Name == ($volumeName))' { &quot;Driver&quot;: &quot;&quot;, &quot;Labels&quot;: {}, &quot;Mountpoint&quot;: &quot;&quot;, &quot;Name&quot;: &quot;413f47a2d1656a4ec6e876543dc8a0caa5256c670a425638eff7be9730da0229&quot;, &quot;Options&quot;: null, &quot;Scope&quot;: &quot;local&quot;, &quot;UsageData&quot;: { &quot;RefCount&quot;: 1, &quot;Size&quot;: 0 } } ``` And we still have our container using it ```bash $ podman inspect 18e7216f21ab0eddb5fab99c388ba04030809b6870cd0c595e7bc84008c7fb3d | jq '.[0].Mounts' [ { &quot;Type&quot;: &quot;volume&quot;, &quot;Name&quot;: &quot;413f47a2d1656a4ec6e876543dc8a0caa5256c670a425638eff7be9730da0229&quot;, &quot;Source&quot;: &quot;/var/home/core/.local/share/containers/storage/volumes/413f47a2d1656a4ec6e876543dc8a0caa5256c670a425638eff7be9730da0229/_data&quot;, &quot;Destination&quot;: &quot;/foo&quot;, &quot;Driver&quot;: &quot;local&quot;, &quot;Mode&quot;: &quot;&quot;, &quot;Options&quot;: [ &quot;nosuid&quot;, &quot;nodev&quot;, &quot;rbind&quot; ], &quot;RW&quot;: true, &quot;Propagation&quot;: &quot;rprivate&quot; } ] ``` **Describe the results you received:** RefCount = 1 **Describe the results you expected:** Valid RefCount **Additional information you deem important (e.g. issue happens only occasionally):** **Output of `podman version`:** ``` 4.2.1 ``` **Output of `podman info`:** ``` (paste your output here) ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` (paste your output here) ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes/No **Additional environment details (AWS, VirtualBox, physical, etc.):**</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #15706 from edsantiago/docs_dedup_volume [CI:DOCS] Man pages: refactor common options: --volume</MESSAGE>
    <SHA>94864cbce6e758552c853999951681bfdef93b18</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Ensure that the DF endpoint updated volume refcount The field was already exposed already in the `system df` output so this just required a bit of plumbing and testing. As part of this, fix `podman systemd df` volume in-use logic. Previously, volumes were only considered to be in use if the container using them was running. This does not match Docker's behavior, where a volume is considered in use as long as a container exists that uses the volume, even if said container is not running. Fixes #15720 Signed-off-by: Matthew Heon &lt;matthew.heon@pm.me&gt;</MESSAGE>
      <SHA>07a8eb829563df9215d86eed7b3337c14dadb6cc</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/system.go</FILE>
        <FILE>pkg/domain/infra/abi/system.go</FILE>
        <FILE>test/apiv2/45-system.at</FILE>
        <FILE>test/system/320-system-df.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
