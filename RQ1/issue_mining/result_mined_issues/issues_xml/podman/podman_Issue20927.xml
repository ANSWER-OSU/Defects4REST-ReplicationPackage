<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>20927</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/20927</ISSUEURL>
  <TITLE>pasta: system tests fail under IPv6</TITLE>
  <DESCRIPTION>Bring up 1minutetip VM (Fedora 39). ```console # dnf install podman-tests # loginctl enable-linger fedora # su - fedora $ bats /usr/share/podman/test/system/505-networking-pasta.bats [ tons and tons and tons of errors, common factor is IPv6 ] ``` e.g. ``` [13:17:16.243623304] $ podman run --net=pasta:-6 quay.io/libpod/testimage:20221018 ip -j -4 address show [13:17:16.376916936] Error: pasta failed with exit code 1: No external routable interface for IPv6 External interface not usable [13:17:16.379969866] [ rc=126 (** EXPECTED 0 **) ] ``` ``` [13:17:16.708433156] $ podman run --net=pasta quay.io/libpod/testimage:20221018 ip -j -6 address show [13:17:17.017262587] [{&quot;ifindex&quot;:1,&quot;ifname&quot;:&quot;lo&quot;,&quot;flags&quot;:[&quot;LOOPBACK&quot;,&quot;UP&quot;,&quot;LOWER_UP&quot;],&quot;mtu&quot;:65536,&quot;operstate&quot;:&quot;UNKNOWN&quot;,&quot;txqlen&quot;:1000,&quot;addr_info&quot;:[{&quot;family&quot;: &quot;inet6&quot;,&quot;local&quot;:&quot;::1&quot;,&quot;prefixlen&quot;:128,&quot;scope&quot;:&quot;host&quot;,&quot;valid_life_time&quot;:4294967295,&quot;preferred_life_time&quot;:4294967295}]},{&quot;ifindex&quot;:2,&quot;ifname&quot;:&quot;eth0&quot;,&quot;flags&quot;:[&quot;BRO ADCAST&quot;,&quot;MULTICAST&quot;,&quot;UP&quot;,&quot;LOWER_UP&quot;],&quot;mtu&quot;:65520,&quot;operstate&quot;:&quot;UNKNOWN&quot;,&quot;txqlen&quot;:1000,&quot;addr_info&quot;:[{&quot;family&quot;:&quot;inet6&quot;,&quot;local&quot;:&quot;fe80::f46e:9eff:fe44:4b55&quot;,&quot;prefixl en&quot;:64,&quot;scope&quot;:&quot;link&quot;,&quot;tentative&quot;:true,&quot;valid_life_time&quot;:4294967295,&quot;preferred_life_time&quot;:4294967295}]}] Device &quot;null&quot; does not exist. #/vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv #| FAIL: Container address not matching host #| expected: = '' #| actual: null #\^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ``` ``` [13:17:17.431924250] $ podman run --net=pasta:-a,2001:db8::1 quay.io/libpod/testimage:20221018 ip -j -6 address show [13:17:17.746388751] [{&quot;ifindex&quot;:1,&quot;ifname&quot;:&quot;lo&quot;,&quot;flags&quot;:[&quot;LOOPBACK&quot;,&quot;UP&quot;,&quot;LOWER_UP&quot;],&quot;mtu&quot;:65536,&quot;operstate&quot;:&quot;UNKNOWN&quot;,&quot;txqlen&quot;:1000,&quot;addr_info&quot;:[{&quot;family&quot;: &quot;inet6&quot;,&quot;local&quot;:&quot;::1&quot;,&quot;prefixlen&quot;:128,&quot;scope&quot;:&quot;host&quot;,&quot;valid_life_time&quot;:4294967295,&quot;preferred_life_time&quot;:4294967295}]},{&quot;ifindex&quot;:2,&quot;ifname&quot;:&quot;eth0&quot;,&quot;flags&quot;:[&quot;BRO ADCAST&quot;,&quot;MULTICAST&quot;,&quot;UP&quot;,&quot;LOWER_UP&quot;],&quot;mtu&quot;:65520,&quot;operstate&quot;:&quot;UNKNOWN&quot;,&quot;txqlen&quot;:1000,&quot;addr_info&quot;:[{&quot;family&quot;:&quot;inet6&quot;,&quot;local&quot;:&quot;fe80::5cd2:c4ff:fe1f:77bc&quot;,&quot;prefixl en&quot;:64,&quot;scope&quot;:&quot;link&quot;,&quot;tentative&quot;:true,&quot;valid_life_time&quot;:4294967295,&quot;preferred_life_time&quot;:4294967295}]}] #/vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv #| FAIL: Container address not matching configured value #| expected: = 2001:db8::1 #| actual: null #\^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ``` ``` [13:17:45.819629632] $ podman run --net=pasta -p []:5207:5207/tcp quay.io/libpod/testimage:20221018 sh -c for port in $(seq 5207 5207); do socat -u TCP6-LISTEN:${port} STDOUT &amp; done; wait [13:17:45.889865930] Error: must provide a non-empty container host IP to publish [13:17:45.893574737] [ rc=125 (** EXPECTED 0 **) ] ``` For posterity, this is how to disable ipv6 in Fedora 39: ```console # nmcli connection modify eth0 ipv6.method &quot;disabled&quot; # nmcli connection up eth0 Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/5) ```</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>102</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #21979 from chilikk/fix-exec-headers fix invalid HTTP header values when hijacking a connection</MESSAGE>
    <SHA>f5abca415d6367021d37b9369a3f32e975bbbe0f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>test/system: Add support for multipath routes in pasta networking tests In some environments, such as the one described in https://github.com/containers/podman/issues/20927, the default route is given as nexthop gateways. That is, it's a multipath routes with multiple gateways. That means that pasta(1), after commit 6c7623d07bbd (&quot;netlink: Add support to fetch default gateway from multipath routes&quot;), can start and use a default gateway from that route. Just like in pasta(1), in these tests, the default route indicates which upstream interface we should pick. If we ignore multipath routes, IPv6 addresses and gateway addresses themselves won't be available, so, while pasta is now able to configure the container, IPv6 tests will expect to find no address and no gateway, hence fail due to the mismatch. Try to get routes, including gateway addresses and interface names, from nexthop objects, in case the selection of a regular default route yields no results. Link: https://github.com/containers/podman/issues/20927 Closes: #20927 Signed-off-by: Stefano Brivio &lt;sbrivio@redhat.com&gt;</MESSAGE>
      <SHA>23433ec7bdccd7fe9a0d7514c8dc3f0e1cd4a0ad</SHA>
      <PATCHEDFILES>
        <FILE>test/system/helpers.network.bash</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
