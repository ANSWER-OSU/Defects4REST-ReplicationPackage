<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15018</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15018</ISSUEURL>
  <TITLE>restore --pod: cannot restore pod container without --pod</TITLE>
  <DESCRIPTION>Failing in [ubuntu 2204, remote, with cgroupsv1 and runc](https://api.cirrus-ci.com/v1/artifact/task/5879373692665856/html/int-remote-ubuntu-2204-root-host.log.html#t--podman-checkpoint-and-restore-container-out-of-and-into-pod--ipc-net-uts-pid---1): ``` podman checkpoint and restore container out of and into pod (ipc,net,uts,pid) ... # podman-remote [options] container restore --pod NEW-POD-ID -i /tmp/checkpoint-CONTAINER-ID.tar.gz Error: cannot restore pod container without --pod ``` (The discerning reader will note that `--pod` is specified in the command line). That error seems to come from https://github.com/containers/podman/blob/039deece50525b1fc812890dfa1ce2fa1f4c98b3/pkg/checkpoint/checkpoint_restore.go#L59-L61 Earlier in that test, I see this warning: ``` # podman-remote [options] container checkpoint -e /tmp/checkpoint-CONTAINER-ID.tar.gz CONTAINER-ID time=&quot;2022-07-20T21:07:00Z&quot; level=warning msg=&quot;lstat /sys/fs/cgroup/devices/machine.slice/machine-libpod_pod_OLD-POD-ID.slice/libpod-CONTAINER-ID.scope: no such file or directory&quot; ``` So, yeah, seems to be cgroups-related. Something we just never tested because we haven't been testing runc.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>70</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14876 from cdoern/cgroup resource limits for pods</MESSAGE>
    <SHA>ee937c518e7efb9c47d21a4e1050b966ca02d005</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Bump VMs, to Ubuntu 2204 with cgroups v1 ...and enable the at-test-time confirmation, the one that double-checks that if CI requests runc we actually use runc. This exposed a nasty surprise in our setup: there are steps to define $OCI_RUNTIME, but that's actually a total fakeout! OCI_RUNTIME is used only in e2e tests, it has no effect whatsoever on actual podman itself as invoked via command line such as in system tests. Solution: use containers.conf Given how fragile all this runtime stuff is, I've also added new tests (e2e and system) that will check $CI_DESIRED_RUNTIME. Image source: https://github.com/containers/automation_images/pull/146 Since we haven't actually been testing with runc, we need to fix a few tests: - handle an error-message change (make it work in both crun and runc) - skip one system test, &quot;survive service stop&quot;, that doesn't work with runc and I don't think we care. ...and skip a bunch, filing issues for each: - #15013 pod create --share-parent - #15014 timeout in dd - #15015 checkpoint tests time out under $CONTAINER - #15017 networking timeout with registry - #15018 restore --pod gripes about missing --pod - #15025 run --uidmap broken - #15027 pod inspect cgrouppath broken - ...and a bunch more (&quot;podman pause&quot;) that probably don't even merit filing an issue. Also, use /dev/urandom in one test (was: /dev/random) because the test is timing out and /dev/urandom does not block. (But the test is still timing out anyway, even with this change) Also, as part of the VM switch we are now using go 1.18 (up from 1.17) and this broke the gitlab tests. Thanks to @Luap99 for a quick fix. Also, slight tweak to #15021: include the timeout value, and reword message so command string is at end. Also, fixed a misspelling in a test name. Fixes: #14833 Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>0a160fed77c753d1d5683ad40285bb41f1c895d5</SHA>
      <PATCHEDFILES>
        <FILE>.cirrus.yml</FILE>
        <FILE>contrib/cirrus/runner.sh</FILE>
        <FILE>contrib/cirrus/setup_environment.sh</FILE>
        <FILE>test/e2e/build_test.go</FILE>
        <FILE>test/e2e/checkpoint_image_test.go</FILE>
        <FILE>test/e2e/checkpoint_test.go</FILE>
        <FILE>test/e2e/info_test.go</FILE>
        <FILE>test/e2e/kill_test.go</FILE>
        <FILE>test/e2e/manifest_test.go</FILE>
        <FILE>test/e2e/network_connect_disconnect_test.go</FILE>
        <FILE>test/e2e/pod_create_test.go</FILE>
        <FILE>test/e2e/run_test.go</FILE>
        <FILE>test/system/005-info.bats</FILE>
        <FILE>test/system/030-run.bats</FILE>
        <FILE>test/system/160-volumes.bats</FILE>
        <FILE>test/system/170-run-userns.bats</FILE>
        <FILE>test/system/200-pod.bats</FILE>
        <FILE>test/system/251-system-service.bats</FILE>
        <FILE>test/system/400-unprivileged-access.bats</FILE>
        <FILE>test/system/500-networking.bats</FILE>
        <FILE>test/utils/utils.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
