<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14536</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14536</ISSUEURL>
  <TITLE>build with --squash-all + --timestamp clobbers timestamps in preexisting layers</TITLE>
  <DESCRIPTION>[filing under podman, not buildah, because `--squash-all` is a podman-only option] ```console $ printf &quot;FROM alpine\nRUN echo hi\n&quot; | bin/podman build --squash-all --timestamp 0 -t foo - STEP 1/2: FROM alpine STEP 2/2: RUN echo hi hi COMMIT foo Getting image source signatures Copying blob f89409ba1b89 skipped: already exists Copying config 7350b81f59 done Writing manifest to image destination Storing signatures --&gt; 7350b81f59a Successfully tagged localhost/foo:latest 7350b81f59a6cb83bd33e1a5f36a404655b947fa8b47f876dfc9b9e14b041ccc $ for i in alpine foo;do bin/podman run --rm $i ls -l /etc/profile;done -rw-r--r-- 1 root root 857 Mar 2 19:00 /etc/profile -rw-r--r-- 1 root root 857 Jan 1 1970 /etc/profile &lt;&lt;&lt;&lt;&lt; unexpected ``` Documentation for `--timestamp` includes: &gt;All files committed to the layers of the image will be created with the timestamp. ...but to me that applies to files added/created in the build, not files in the existing image. The current behavior violates POLA.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>818</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14601 from mheon/bump_main_411 [CI:DOCS] Update release notes and README on Main for v4.1.1</MESSAGE>
    <SHA>31095349e394b4f5db0b76d3e4c5d05d3e6d05c3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>system test image: bump to 20220615 Changes: - use --timestamp option to produce 'created' stamps that can be reliably tested in the image-history test - podman now supports manifest &amp; multiarch run, so we no longer need buildah - bump up base alpine &amp; busybox images This turned out to be WAY more complicated than it should've been, because: - alpine 3.14 fixed 'date -Iseconds' to include a colon in the TZ offset (&quot;-07:00&quot;, was &quot;-0700&quot;). This is now consistent with GNU date's --iso-8601 format, yay, so we can eliminate a minor workaround. - with --timestamp, all ADDed files are set to that timestamp, including the custom-reference-timestamp file that many tests rely on. So we need to split the build into two steps. But: - ...with a two-step build I need to use --squash-all, not --squash, but: - ... (deep sigh) --squash-all doesn't work with --timestamp (#14536) so we need to alter existing tests to deal with new image layers. - And, long and sordid story relating to --rootfs. TL;DR that option only worked by a miracle relating to something special in one specific test image; it doesn't work with any other images. Fix seems to be complicated, so we're bypassing with a FIXME (#14505). And, unrelated: - remove obsolete skip and workaround in run-basic test (dating back to varlink days) - add a pause-image cleanup to avoid icky red warnings in logs Fixes: #14456 Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>0a202a9f03e3bb9c9a2f45f6e2593e60b24f794e</SHA>
      <PATCHEDFILES>
        <FILE>test/system/010-images.bats</FILE>
        <FILE>test/system/030-run.bats</FILE>
        <FILE>test/system/070-build.bats</FILE>
        <FILE>test/system/500-networking.bats</FILE>
        <FILE>test/system/build-testimage</FILE>
        <FILE>test/system/helpers.bash</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
