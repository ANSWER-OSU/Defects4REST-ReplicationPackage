<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14854</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14854</ISSUEURL>
  <TITLE>test/system: podman run port forward range problem</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** There seems to be an error with the reworked free port range logic. I just saw this on one of my PRs: ``` not ok 345 podman run port forward range # (from function `die' in file test/system/[helpers.bash, line 555](https://github.com/containers/podman/blob/329c28e75a6e524d8e7a92f11873c1a28147a487/test/system/helpers.bash#L555), # from function `run_podman' in file test/system/[helpers.bash, line 219](https://github.com/containers/podman/blob/329c28e75a6e524d8e7a92f11873c1a28147a487/test/system/helpers.bash#L219), # in test file test/system/[500-networking.bats, line 684](https://github.com/containers/podman/blob/329c28e75a6e524d8e7a92f11873c1a28147a487/test/system/500-networking.bats#L684)) # `run_podman run --network $netmode -p &quot;$range:$range&quot; -d $IMAGE sleep inf' failed with status 126 # $ podman rm -t 0 --all --force --ignore # $ podman ps --all --external --format {{.ID}} {{.Names}} # $ podman images --all --format {{.Repository}}:{{.Tag}} {{.ID}} # quay.io/libpod/testimage:20220615 f26aa69bb3f3 # $ podman run --network bridge -p 5621-5623:5621-5623 -d quay.io/libpod/testimage:20220615 sleep inf # e4042a4315372ca06000d92a4d5430f3a05ebf29175547b08f1fbe9d9d99c793 # seq: missing operand # Try 'seq --help' for more information. # $ podman rm -f -t0 e4042a4315372ca06000d92a4d5430f3a05ebf29175547b08f1fbe9d9d99c793 # e4042a4315372ca06000d92a4d5430f3a05ebf29175547b08f1fbe9d9d99c793 # $ podman run --network slirp4netns:port_handler=slirp4netns -p 5354-5356:5354-5356 -d quay.io/libpod/testimage:20220615 sleep inf # Error: from slirp4netns while setting up port redirection: map[desc:bad request: add_hostfwd: slirp_add_hostfwd failed] # [ rc=126 (** EXPECTED 0 **) ] # #/vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv # #| FAIL: exit code is 126; expected 0 # #\^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ # # [teardown] # $ podman pod rm -t 0 --all --force --ignore # $ podman rm -t 0 --all --force --ignore # e450c9c9ab94205befe79d6969e2a3fec02a7c4fe696484a81a9e45addb614eb # $ podman network prune --force ``` https://api.cirrus-ci.com/v1/artifact/build/6520991475040256/sys%20podman%20fedora-36%20rootless%20host/html/sys-podman-fedora-36-rootless-host.log.html cc @edsantiago I report this here since I do not have time to look at this right now.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14762 from ashley-cui/machinfo Podman machine info</MESSAGE>
    <SHA>dd0418a5fe0c44d4358b0118bd2a9847d78a80a2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>port forward range test: fix many oopses Wrong variable. And, wrong index range. And, wrong bash syntax for extracting end_port. And, add explicit check for valid range, because die() inside 'foo=$(...)' will not actually die. And, refactor some confusing code. And, reformat/clean up a confusing and too-wide comment. Fixes: #14854 Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>e8d2d70ee2ee9307c929793df50a56e9f54dcb57</SHA>
      <PATCHEDFILES>
        <FILE>test/system/500-networking.bats</FILE>
        <FILE>test/system/helpers.bash</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
