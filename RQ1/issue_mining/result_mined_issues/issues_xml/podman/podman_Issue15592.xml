<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15592</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15592</ISSUEURL>
  <TITLE>Generating a systemd file for a pod will put &quot;--exit-policy&quot; option after pod name, causing the service to fail</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** &lt;!-- Briefly describe the problem you are having in a few paragraphs. --&gt; Running `podman generate systemd --new --name` against a pod without a manually defined `--exit-policy` will cause the option to be appended after the name, which causes the pod creation to fail. **Steps to reproduce the issue:** 1. Create pod without specifying `--exit-policy` 2. Generate systemd unit with `podman generate systemd --new --name mypod` **Describe the results you received:** The following line in the unit file: ``` ExecStartPre=/usr/bin/podman pod create --infra-conmon-pidfile %t/pod-dns.pid --pod-id-file %t/pod-dns.pod-id --publish 53:53/tcp --publish 53:53/udp --publish 3000:3000/tcp --publish 853:853/tcp --publish 784:784/udp --publish 853:853/udp --publish 8853:8853/udp --publish 5443:5443/tcp --publish 5443:5443/udp dns --exit-policy=stop ``` **Describe the results you expected:** The extra option is appended before the pod name. **Additional information you deem important (e.g. issue happens only occasionally):** This unit file can successfully start after moving &quot;dns&quot; to the end of the line. Manually running the command with minor modifications produces the following: ``` # /usr/bin/podman pod create --infra-conmon-pidfile /run/pod-dns.pid --pod-id-file /run/pod-dns.pod-id --publish 53:53/tcp --publish 53:53/udp --publish 3000:3000/tcp --publish 853:853/tcp --publish 784:784/udp --publish 853:853/udp --publish 8853:8853/udp --publish 5443:5443/tcp --publish 5443:5443/udp dns --exit-policy=stop Error: accepts at most 1 arg(s), received 2 ``` Manually specifying `--exit-policy` on the pod before generating the unit file avoids this issue. **Output of `podman version`:** ``` podman version 4.2.0 ``` **Output of `podman info`:** ``` host: arch: arm buildahVersion: 1.27.0 cgroupControllers: - cpuset - cpu - io - memory - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.3-1.1.armv7hl path: /usr/bin/conmon version: 'conmon version 2.1.3, commit: unknown' cpuUtilization: idlePercent: 99.04 systemPercent: 0.4 userPercent: 0.55 cpus: 4 distribution: distribution: '&quot;opensuse-microos&quot;' version: &quot;20220827&quot; eventLogger: journald hostname: pi2-server idMappings: gidmap: null uidmap: null kernel: 5.19.2-1-default linkmode: dynamic logDriver: journald memFree: 358948864 memTotal: 998154240 networkBackend: cni ociRuntime: name: runc package: runc-1.1.3-2.1.armv7hl path: /usr/bin/runc version: |- runc version 1.1.3 commit: v1.1.3-0-ga916309fff0f spec: 1.0.2-dev go: go1.18.3 libseccomp: 2.5.4 os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /etc/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.1.11-1.5.armv7hl version: |- slirp4netns version 1.1.11 commit: unknown libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.4 swapFree: 0 swapTotal: 0 uptime: 20h 34m 23.00s (Approximately 0.83 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.opensuse.org - registry.suse.com - docker.io store: configFile: /etc/containers/storage.conf containerStore: number: 4 paused: 0 running: 4 stopped: 0 graphDriverName: btrfs graphOptions: {} graphRoot: /var/lib/containers/storage graphRootAllocated: 15913713664 graphRootUsed: 2584170496 graphStatus: Build Version: Btrfs v5.18.1 Library Version: &quot;102&quot; imageCopyTmpDir: /var/tmp imageStore: number: 4 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.2.0 Built: 1660176000 BuiltTime: Thu Aug 11 00:00:00 2022 GitCommit: &quot;&quot; GoVersion: go1.16.15 Os: linux OsArch: linux/arm Version: 4.2.0 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` podman-4.2.0-1.1.armv7hl ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** A Raspberry Pi 2 device running OpenSUSE Micro OS</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>12</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #15784 from edsantiago/docs_dedup_tlsverify [CI:DOCS] Man pages: refactor common options: --tls-verify</MESSAGE>
    <SHA>c64388728f5efec2658cf9097dbe15126f30753e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[systemd] Ensure that podCreateArgs appear last in ExecStartPre= When creating a new pod without the `--name` flag, e.g.: `podman pod create foobar` it will get the name `foobar` implicitly and this will be recorded as the in the `podCreateArgs`. Unfortunately, the implicit name only works if it appears as the **last** argument of the startup command. With 6e2e3a78ed1d05ee5f23f65b814e8135021961dd we started appending the pod security policy to the startCommand, resulting in the following `ExecStartPre=` line: ``` /usr/bin/podman pod create --infra-conmon-pidfile %t/pod-foobar.pid --pod-id-file %t/pod-foobar.pod-id foobar --exit-policy=stop ``` This fails to launch, as the `pod create` command expects only a single non-flag parameter, but it assumes that `exit-policy=stop` is a second and terminates immediately instead. This fixes https://github.com/containers/podman/issues/15592 Signed-off-by: Dan Čermák &lt;dcermak@suse.com&gt;</MESSAGE>
      <SHA>0aedddd3b3ec0f14818aa0f04c24df1f0b2e3f3b</SHA>
      <PATCHEDFILES>
        <FILE>pkg/systemd/generate/pods.go</FILE>
        <FILE>pkg/systemd/generate/pods_test.go</FILE>
        <FILE>test/e2e/generate_systemd_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
