<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>21863</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/21863</ISSUEURL>
  <TITLE>v4.1 stable image: --network=bridge: hang</TITLE>
  <DESCRIPTION>Upgrade tests are failing from `v4.1`, and have been disabled. This is a reproducer: ### Setup: iptables-legacy Needed to avoid mixing apples and oranges ```console # dnf install iptables-legacy # update-alternatives --set iptables /usr/sbin/iptables-legacy ``` Reboot (`^D`, then comma) ### Reproducer: run podman-in-podman Start podman-v4.1 container ```console 1mt# bin/podman run -it --pid=host --net=host --privileged --cgroupns=host -v /dev/fuse:/dev/fuse -v /run/crun:/run/crun -v /run/netns:/run/netns:rshared -v /run/containers:/run/containers -v /dev/shm:/dev/shm -v /etc/containers/networks:/etc/containers/networks quay.io/podman/stable:v4.1.0 sh ``` In that container, run podman with `--network=bridge`: ```console container-shell# podman run --log-level=debug --network bridge quay.io/libpod/testimage:20240123 date ... [DEBUG netavark::commands::setup] Setting up network podman with driver bridge [DEBUG netavark::network::core] Container veth name: &quot;eth0&quot; [DEBUG netavark::network::core] Brige name: &quot;podman0&quot; [DEBUG netavark::network::core] IP address for veth vector: [10.88.0.20/16] [DEBUG netavark::network::core] Gateway ip address vector: [10.88.0.1/16] &lt;&lt;&lt;&lt;&lt;------ HANGS HERE FOREVER ``` With `v4.8.0`, same output to that point, then proceeds with ``` DEBU[0000] [graphdriver] trying provided driver &quot;overlay&quot; DEBU[0000] overlay: imagestore=/var/lib/shared DEBU[0000] overlay: mount_program=/usr/bin/fuse-overlayfs DEBU[0000] backingFs=extfs, projectQuotaSupported=false, useNativeDiff=false, usingMetacopy=false DEBU[0000] Cached value indicated that overlay is supported DEBU[0000] overlay: mount_data=lowerdir=/var/lib/containers/storage/overlay/l/MFIXF3UCPA2MOECTKRK3UN5P2P:/var/lib/containers/storage/overlay/l/PVUCPFSNBS4VTMQC3 ....etc and completes successfully ``` When hanging, lslocks (from a different login) reports: ``` COMMAND PID TYPE SIZE MODE M START END PATH podman 13774 POSIX WRITE 0 0 0 /etc/containers/networks/netavark.lock ``` I don't know where to take it from here.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #21839 from lsm5/rpm-spec [CI:BUILD] rpm: spec file updates from Fedora dist-git</MESSAGE>
    <SHA>031e7a15b090bc041a3efef5a9cbffdd28a96b4b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Reenable boltdb upgrade tests Upgrade-from-v4.1 was temporarily disabled in #21618: we brought in new CI VMs, and v4.1 setup no longer works. Nobody quite understands why, and we've hit diminishing returns in the investigation (#21863). The current thinking is that it is related to netavark, and versions &lt; 1.3 do not work in the current f39 VMs. (No clue why, because f39 kernel did not change in #21618). Anyhow, reenable the pre-4.8 upgrade test, using v4.3.1 which has netavark-1.4.0 which seems to work fine. For now. Also, some upgrade test cleanup: - Skip, not fail, if initial setup fails. Makes for less noisy logs. - Remove duplicate --pid=host - Ports: 808x -&gt; 909x, because 8081 is used by restraint on 1mt Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>064258b496415ec855a5fa2f31138ccade380b3c</SHA>
      <PATCHEDFILES>
        <FILE>.cirrus.yml</FILE>
        <FILE>test/upgrade/test-upgrade.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
