<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15726</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15726</ISSUEURL>
  <TITLE>CPU limit in play kube doesn't work</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** Limitation of CPU consumption doesn't work if it's used in play kube yaml. **Steps to reproduce the issue:** 1. Create to following yaml: ``` apiVersion: v1 kind: Pod metadata: labels: app: my-pod name: my-pod spec: containers: - name: app image: debian command: - /bin/bash args: - &quot;-c&quot; - &quot;while true; do echo 123 &gt; /dev/null; done&quot; resources: limits: cpu: 300m # 30% of one core ``` 2. Launch podman play kube with this yaml. 3. Observe CPU load for container. **Describe the results you received:** CPU load is about 100%. **Describe the results you expected:** CPU load is about 30%. **Additional information you deem important (e.g. issue happens only occasionally):** - **Output of `podman version`:** ``` Client: Podman Engine Version: 4.3.0-dev API Version: 4.3.0-dev Go Version: go1.17.8 Built: Thu Jan 1 00:00:00 1970 OS/Arch: linux/arm ``` **Output of `podman info`:** ``` host: arch: arm buildahVersion: 1.27.0 cgroupControllers: - cpuset - cpu - cpuacct - blkio - memory - devices - freezer - net_cls - perf_event - net_prio - pids cgroupManager: systemd cgroupVersion: v1 conmon: package: Unknown path: /usr/bin/conmon version: 'conmon version 2.0.29, commit: unknown' cpuUtilization: idlePercent: 87.12 systemPercent: 10.63 userPercent: 2.24 cpus: 4 distribution: distribution: buildroot version: &quot;2022.02&quot; eventLogger: journald hostname: comm99-dev idMappings: gidmap: null uidmap: null kernel: 4.14.98 linkmode: dynamic logDriver: k8s-file memFree: 180031488 memTotal: 511803392 networkBackend: cni ociRuntime: name: crun package: Unknown path: /usr/bin/crun version: |- crun version 1.4.3 commit: 61c9600d1335127eba65632731e2d72bc3f0b9e8 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +YAJL os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: &quot;&quot; selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: &quot;&quot; package: &quot;&quot; version: &quot;&quot; swapFree: 0 swapTotal: 0 uptime: 0h 17m 39.00s plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - docker.io - registry.fedoraproject.org - registry.access.redhat.com - registry.centos.org store: configFile: /etc/containers/storage.conf containerStore: number: 6 paused: 0 running: 0 stopped: 6 graphDriverName: overlay graphOptions: overlay.mountopt: nodev graphRoot: /opt/containers/storage graphRootAllocated: 29639618560 graphRootUsed: 3874271232 graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 35 runRoot: /run/containers/storage volumePath: /opt/containers/storage/volumes version: APIVersion: 4.3.0-dev Built: 0 BuiltTime: Thu Jan 1 00:00:00 1970 GitCommit: &quot;&quot; GoVersion: go1.17.8 Os: linux OsArch: linux/arm Version: 4.3.0-dev ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` manual build ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #15706 from edsantiago/docs_dedup_volume [CI:DOCS] Man pages: refactor common options: --volume</MESSAGE>
    <SHA>94864cbce6e758552c853999951681bfdef93b18</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix CPU usage limitation in play kube for non integer values This logic has been broken by commit 9c6c981928c3e020ff6eef9454c7ee86aa8c83d1 (kube: fix conversion from milliCPU to period/quota). [NO NEW TESTS NEEDED] Fixes: #15726 Signed-off-by: Mikhail Khachayants &lt;tyler92@inbox.ru&gt;</MESSAGE>
      <SHA>b8108d06b431018b4022879a2504a44ee95e6911</SHA>
      <PATCHEDFILES>
        <FILE>pkg/specgen/generate/kube/kube.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
