<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14505</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14505</ISSUEURL>
  <TITLE>Unhealthy pod(created via podman play kube) doesn't restart</TITLE>
  <DESCRIPTION>**Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** When pod is created via &quot;podman play kube&quot; with livness probe - it is always running with &quot;unhealthy&quot; status. ``` spec: restartPolicy: OnFailure ``` I checked a code and found: ``` // append `kill 1` to `cmd` if appropriate restart policy is configured. if restartPolicy == &quot;always&quot; || restartPolicy == &quot;onfailure&quot; { // container will be restarted so we can kill init. failureCmd = &quot;kill 1&quot; } ``` So i inspected my container(created with 'play kube') and it has a restart policy: ``` &quot;PortBindings&quot;: {}, &quot;RestartPolicy&quot;: { &quot;Name&quot;: &quot;on-failure&quot;, &quot;MaximumRetryCount&quot;: 0 }, &quot;AutoRemove&quot;: false, ``` and &quot;exit 1&quot; failureCmd instead &quot;kill 1&quot; ``` &quot;Healthcheck&quot;: { &quot;Test&quot;: [ &quot;CMD-SHELL&quot;, &quot;curl&quot;, &quot;http://localhost:8080/&quot;, &quot;&quot;, &quot;||&quot;, &quot;exit&quot;, &quot;1&quot; ], ``` **Steps to reproduce the issue:** 1. Create Kubernetes YAML file with liveness probe and restartPolicy: OnFailure 2. Play kube **Describe the results you received:** Container always running with unhealthy status.. **Describe the results you expected:** unhealthy container should be killed.. **Additional information you deem important (e.g. issue happens only occasionally):** **Output of `podman version`:** ``` Client: Podman Engine Version: 4.1.0 API Version: 4.1.0 Go Version: go1.17.5 Built: Wed May 25 07:40:16 2022 OS/Arch: linux/amd64 ``` **Output of `podman info --debug`:** ``` host: arch: amd64 buildahVersion: 1.26.1 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.1-1.el9.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.1, commit: bb7e4979ae5b33d8c8793618965018f335af0827' cpuUtilization: idlePercent: 90.1 systemPercent: 0.63 userPercent: 9.27 cpus: 4 distribution: distribution: '&quot;centos&quot;' version: &quot;9&quot; eventLogger: journald hostname: ip-172-25-33-161.ec2.internal idMappings: gidmap: null uidmap: null kernel: 5.14.0-101.el9.x86_64 linkmode: dynamic logDriver: journald memFree: 130281472 memTotal: 7743361024 networkBackend: netavark ociRuntime: name: crun package: crun-1.4.5-2.el9.x86_64 path: /usr/bin/crun version: |- crun version 1.4.5 commit: c381048530aa750495cf502ddb7181f2ded5b400 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_NET_RAW,CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /bin/slirp4netns package: slirp4netns-1.2.0-2.el9.x86_64 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.4.0 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.2 swapFree: 0 swapTotal: 0 uptime: 93h 43m 1.12s (Approximately 3.88 days) plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - registry.centos.org - quay.io - docker.io store: configFile: /etc/containers/storage.conf containerStore: number: 4 paused: 0 running: 3 stopped: 1 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 10724814848 graphRootUsed: 2292486144 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 3 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.1.0 Built: 1653464416 BuiltTime: Wed May 25 07:40:16 2022 GitCommit: &quot;&quot; GoVersion: go1.17.5 Os: linux OsArch: linux/amd64 Version: 4.1.0 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` podman-4.1.0-4.el9.x86_64 ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):**</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>113</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14601 from mheon/bump_main_411 [CI:DOCS] Update release notes and README on Main for v4.1.1</MESSAGE>
    <SHA>31095349e394b4f5db0b76d3e4c5d05d3e6d05c3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>system test image: bump to 20220615 Changes: - use --timestamp option to produce 'created' stamps that can be reliably tested in the image-history test - podman now supports manifest &amp; multiarch run, so we no longer need buildah - bump up base alpine &amp; busybox images This turned out to be WAY more complicated than it should've been, because: - alpine 3.14 fixed 'date -Iseconds' to include a colon in the TZ offset (&quot;-07:00&quot;, was &quot;-0700&quot;). This is now consistent with GNU date's --iso-8601 format, yay, so we can eliminate a minor workaround. - with --timestamp, all ADDed files are set to that timestamp, including the custom-reference-timestamp file that many tests rely on. So we need to split the build into two steps. But: - ...with a two-step build I need to use --squash-all, not --squash, but: - ... (deep sigh) --squash-all doesn't work with --timestamp (#14536) so we need to alter existing tests to deal with new image layers. - And, long and sordid story relating to --rootfs. TL;DR that option only worked by a miracle relating to something special in one specific test image; it doesn't work with any other images. Fix seems to be complicated, so we're bypassing with a FIXME (#14505). And, unrelated: - remove obsolete skip and workaround in run-basic test (dating back to varlink days) - add a pause-image cleanup to avoid icky red warnings in logs Fixes: #14456 Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>0a202a9f03e3bb9c9a2f45f6e2593e60b24f794e</SHA>
      <PATCHEDFILES>
        <FILE>test/system/010-images.bats</FILE>
        <FILE>test/system/030-run.bats</FILE>
        <FILE>test/system/070-build.bats</FILE>
        <FILE>test/system/500-networking.bats</FILE>
        <FILE>test/system/build-testimage</FILE>
        <FILE>test/system/helpers.bash</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
