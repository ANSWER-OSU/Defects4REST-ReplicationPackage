<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>17016</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/17016</ISSUEURL>
  <TITLE>[Bug]: container inconsistancy between play-kube and manual run</TITLE>
  <DESCRIPTION>### Issue Description I am trying to run a tailscale-subnet-router node in a root-less pod (using systemd and play-kube integration which is awesome btw). This pod/container runs as expected when they are created manually. However when the equivalent yaml description for the pod is used either directly with play-kube or indirectly using the systemd template, the container fails and exits with the following error logged in the container: ``` exec: &quot;tailscaled&quot;: executable file not found in $PATH ``` At first I thought tailscale must have messed up their image, but then as a sanity check I converted my yaml to a manual podman command and the container worked as expected. So either there is some inconsitancy with play-kube, or (more-likely) I am missing some element thant makes my yaml definition substantivly different from the manual command. restartPolicy: Never was added to the yaml as the pod just loops in error without it. ### Steps to reproduce the issue Steps to reproduce the issue 1. Manually create the pod: ``` podman pod create --name=tailscale-manual podman run -d --pod=tailscale-manual --name=subnet-router -e TS_AUTH_KEY=tskey-auth-redacted -e TS_USERSPACE=true -e TS_ROUTES=10.10.0.0/16,10.89.0.0/24 ghcr.io/tailscale/tailscale:latest ``` 2. Create a temp.yaml file with the following contents: ``` apiVersion: v1 kind: Pod metadata: name: tailscale-kube spec: restartPolicy: Never containers: - name: subnet-router image: ghcr.io/tailscale/tailscale:latest env: - name: TS_USERSPACE value: true - name: TS_AUTH_KEY value: tskey-auth-redacted - name: TS_ROUTES value: 10.10.0.0/16,10.89.0.0/24 ``` 3. Use play kube to create the pod: ``` podman play kube /path/to/temp.yaml ``` 4. Compare the logs ### Describe the results you received Log from exited container after starting using play kube: ``` boot: 2023/01/05 20:43:56 Starting tailscaled boot: 2023/01/05 20:43:56 failed to bring up tailscale: starting tailscaled failed: exec: &quot;tailscaled&quot;: executable file not found in $PATH ``` ### Describe the results you expected Here are the successfull manual logs for comaprison: ``` boot: 2023/01/05 20:46:29 Starting tailscaled boot: 2023/01/05 20:46:29 Waiting for tailscaled socket 2023/01/05 20:46:29 logtail started 2023/01/05 20:46:29 Program starting: v1.34.1-t331d553a5, Go 1.19.2-ts3fd24dee31: []string{&quot;tailscaled&quot;, &quot;--socket=/tmp/tailscaled.sock&quot;, &quot;--state=mem:&quot;, &quot;--statedir=/tmp&quot;, &quot;--tun=userspace-networking&quot;} 2023/01/05 20:46:29 LogID: d872b8689f9ab2442de71769e44be440d43f4444ac59b8fe05af12b754357d6d 2023/01/05 20:46:29 logpolicy: using system state directory &quot;/var/lib/tailscale&quot; logpolicy.ConfigFromFile /var/lib/tailscale/tailscaled.log.conf: open /var/lib/tailscale/tailscaled.log.conf: no such file or directory logpolicy.Config.Validate for /var/lib/tailscale/tailscaled.log.conf: config is nil 2023/01/05 20:46:29 wgengine.NewUserspaceEngine(tun &quot;userspace-networking&quot;) ... 2023/01/05 20:46:29 dns: using dns.noopManager 2023/01/05 20:46:29 link state: interfaces.State{defaultRoute=tap0 ifs={tap0:[10.0.2.100/24 fd00::7081:dcff:fe23:9f99/64]} v4=true v6=true} 2023/01/05 20:46:29 magicsock: failed to force-set UDP read buffer size to 7340032: operation not permitted 2023/01/05 20:46:29 magicsock: failed to force-set UDP write buffer size to 7340032: operation not permitted 2023/01/05 20:46:29 magicsock: failed to force-set UDP read buffer size to 7340032: operation not permitted 2023/01/05 20:46:29 magicsock: failed to force-set UDP write buffer size to 7340032: operation not permitted 2023/01/05 20:46:29 magicsock: disco key = d:1b36f50eea3f84e9 2023/01/05 20:46:29 Creating WireGuard device... 2023/01/05 20:46:29 Bringing WireGuard device up... 2023/01/05 20:46:29 Bringing router up... 2023/01/05 20:46:29 Clearing router settings... 2023/01/05 20:46:29 Starting link monitor... 2023/01/05 20:46:29 Engine created. 2023/01/05 20:46:29 pm: migrating &quot;_daemon&quot; profile to new format 2023/01/05 20:46:29 got LocalBackend in 3ms 2023/01/05 20:46:29 Start 2023/01/05 20:46:29 Backend: logs: be:d872b8689f9ab2442de71769e44be440d43f4444ac59b8fe05af12b754357d6d fe: 2023/01/05 20:46:29 Switching ipn state NoState -&gt; NeedsLogin (WantRunning=false, nm=false) 2023/01/05 20:46:29 blockEngineUpdates(true) 2023/01/05 20:46:29 health(&quot;overall&quot;): error: state=NeedsLogin, wantRunning=false 2023/01/05 20:46:29 wgengine: Reconfig: configuring userspace WireGuard config (with 0/0 peers) 2023/01/05 20:46:29 wgengine: Reconfig: configuring router 2023/01/05 20:46:29 wgengine: Reconfig: configuring DNS 2023/01/05 20:46:29 dns: Set: {DefaultResolvers:[] Routes:{} SearchDomains:[] Hosts:0} 2023/01/05 20:46:29 dns: Resolvercfg: {Routes:{} Hosts:0 LocalDomains:[]} 2023/01/05 20:46:29 dns: OScfg: {Nameservers:[] SearchDomains:[] MatchDomains:[] Hosts:[]} boot: 2023/01/05 20:46:29 Running 'tailscale up' 2023/01/05 20:46:29 Start 2023/01/05 20:46:29 generating new machine key 2023/01/05 20:46:29 machine key written to store 2023/01/05 20:46:29 control: client.Shutdown() 2023/01/05 20:46:29 control: client.Shutdown: inSendStatus=0 2023/01/05 20:46:29 Backend: logs: be:d872b8689f9ab2442de71769e44be440d43f4444ac59b8fe05af12b754357d6d fe: 2023/01/05 20:46:29 control: mapRoutine: quit 2023/01/05 20:46:29 control: Client.Shutdown done. 2023/01/05 20:46:29 Switching ipn state NoState -&gt; NeedsLogin (WantRunning=true, nm=false) 2023/01/05 20:46:29 blockEngineUpdates(true) 2023/01/05 20:46:29 StartLoginInteractive: url=false 2023/01/05 20:46:29 control: client.Login(false, 6) 2023/01/05 20:46:29 control: LoginInteractive -&gt; regen=true 2023/01/05 20:46:29 control: doLogin(regen=true, hasUrl=false) 2023/01/05 20:46:30 control: control server key from https://controlplane.tailscale.com: ts2021=[fSeS+], legacy=[nlFWp] 2023/01/05 20:46:30 control: Generating a new nodekey. 2023/01/05 20:46:30 control: RegisterReq: onode= node=[vgLkz] fup=false nks=false 2023/01/05 20:46:30 control: creating new noise client 2023/01/05 20:46:30 control: RegisterReq: got response; nodeKeyExpired=false, machineAuthorized=true; authURL=false 2023/01/05 20:46:30 blockEngineUpdates(false) 2023/01/05 20:46:30 active login: luna-ts@github 2023/01/05 20:46:30 Switching ipn state NeedsLogin -&gt; Starting (WantRunning=true, nm=true) 2023/01/05 20:46:30 magicsock: SetPrivateKey called (init) 2023/01/05 20:46:30 wgengine: Reconfig: configuring userspace WireGuard config (with 0/7 peers) 2023/01/05 20:46:30 wgengine: Reconfig: configuring router 2023/01/05 20:46:30 wgengine: Reconfig: configuring DNS 2023/01/05 20:46:30 dns: Set: {DefaultResolvers:[] Routes:{} SearchDomains:[] Hosts:8} 2023/01/05 20:46:30 dns: Resolvercfg: {Routes:{} Hosts:8 LocalDomains:[]} 2023/01/05 20:46:30 dns: OScfg: {Nameservers:[] SearchDomains:[] MatchDomains:[] Hosts:[]} 2023/01/05 20:46:30 peerapi: serving on http://100.125.68.122:45106 2023/01/05 20:46:30 peerapi: serving on http://[fd7a:115c:a1e0:ab12:4843:cd96:627d:447a]:45106 2023/01/05 20:46:30 magicsock: home is now derp-9 (dfw) 2023/01/05 20:46:30 magicsock: adding connection to derp-9 for home-keep-alive 2023/01/05 20:46:30 magicsock: 1 active derp conns: derp-9=cr0s,wr0s 2023/01/05 20:46:30 Switching ipn state Starting -&gt; Running (WantRunning=true, nm=true) 2023/01/05 20:46:30 derphttp.Client.Connect: connecting to derp-9 (dfw) 2023/01/05 20:46:30 control: NetInfo: NetInfo{varies=false hairpin=false ipv6=false ipv6os=true udp=true icmpv4=false derp=#9 portmap= link=&quot;&quot;} 2023/01/05 20:46:30 magicsock: endpoints changed: 69.231.79.102:57436 (stun), 10.0.2.100:55163 (local) boot: 2023/01/05 20:46:30 Startup complete, waiting for shutdown signal 2023/01/05 20:46:30 magicsock: derp-9 connected; connGen=1 2023/01/05 20:46:30 health(&quot;overall&quot;): ok ``` ### podman info output ``` Client: Podman Engine Version: 4.3.1 API Version: 4.3.1 Go Version: go1.19.2 Built: Fri Nov 11 09:01:27 2022 OS/Arch: linux/amd64 ``` ``` host: arch: amd64 buildahVersion: 1.28.0 cgroupControllers: - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.5-1.fc37.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.5, commit: ' cpuUtilization: idlePercent: 99.69 systemPercent: 0.11 userPercent: 0.21 cpus: 24 distribution: distribution: fedora variant: server version: &quot;37&quot; eventLogger: journald hostname: umbriel idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 kernel: 6.0.15-300.fc37.x86_64 linkmode: dynamic logDriver: journald memFree: 873988096 memTotal: 66806587392 networkBackend: netavark ociRuntime: name: crun package: crun-1.7.2-2.fc37.x86_64 path: /usr/bin/crun version: |- crun version 1.7.2 commit: 0356bf4aff9a133d655dc13b1d9ac9424706cac4 rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux remoteSocket: exists: true path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-8.fc37.x86_64 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.3 swapFree: 8219521024 swapTotal: 8589930496 uptime: 19h 55m 4.00s (Approximately 0.79 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io - quay.io store: configFile: /home/hluengas/.config/containers/storage.conf containerStore: number: 12 paused: 0 running: 12 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /home/hluengas/.local/share/containers/storage graphRootAllocated: 498403901440 graphRootUsed: 16769605632 graphStatus: Backing Filesystem: btrfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 6 runRoot: /run/user/1000/containers volumePath: /home/hluengas/.local/share/containers/storage/volumes version: APIVersion: 4.3.1 Built: 1668178887 BuiltTime: Fri Nov 11 09:01:27 2022 GitCommit: &quot;&quot; GoVersion: go1.19.2 Os: linux OsArch: linux/amd64 Version: 4.3.1 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details Fedora 37 Server Edition Machine with the latest podman. I do have root access for troubleshooting though my goal was to make this work root-less. ### Additional information none</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #17072 from edsantiago/refactor_700 podman-play system test: refactor</MESSAGE>
    <SHA>e473c93e94d2f3e16902932f51399053e6555fb2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>kube play: complete container spec Make sure that the specs of containers generated by `kube play` are correctly completed. They have not before which surfaced in default environment variables not being set. Fixes: #17016 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>9a206fdc9f73f0b5f761bd48a1e306618cbecc48</SHA>
      <PATCHEDFILES>
        <FILE>pkg/domain/infra/abi/play.go</FILE>
        <FILE>test/system/700-play.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
