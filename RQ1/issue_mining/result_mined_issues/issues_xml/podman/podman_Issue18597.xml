<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>18597</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/18597</ISSUEURL>
  <TITLE>API endpoint /images/create seems to ignore the tag parameter?</TITLE>
  <DESCRIPTION>### Issue Description Hey there. This issue originated when trying to use Podman as a backend for GitLab Runner. The issue presented itself when GitLab Runner was attempting to pull images for performing builds as can be seen by some of the log entries: ``` podman[400972]: Trying to pull registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66... podman[400972]: @ - - [17/May/2023:10:50:23 +1000] &quot;POST /v1.40/images/create?fromImage=registry.gitlab.com%2Fgitlab-org%2Fgitlab-runner%2Fgitlab-runner-helper&amp;tag=x86_64-dcfb4b66 HTTP/1.1&quot; 200 284 &quot;&quot; &quot;Go-http-client/1.1&quot; podman[400972]: time=&quot;2023-05-17T10:50:23+10:00&quot; level=info msg=&quot;Request Failed(Not Found): failed to find image registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66: registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66: No such image&quot; podman[400972]: @ - - [17/May/2023:10:50:23 +1000] &quot;GET /v1.40/images/registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66/json HTTP/1.1&quot; 404 441 &quot;&quot; &quot;Go-http-client/1.1&quot; gitlab-runner[400957]: WARNING: Failed to pull image with policy &quot;if-not-present&quot;: Error response from daemon: failed to find image registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66: registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66: No such image (manager.go:241:0s) job=639118 project=39435 runner=r3KQ8vBa gitlab-runner[400957]: WARNING: Preparation failed: failed to pull image &quot;registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66&quot; with specified policies [if-not-present]: Error response from daemon: failed to find image registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66: registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-dcfb4b66: No such image (manager.go:241:0s) job=639118 project=39435 runner=r3KQ8vBa ``` After investigating this further, I can actually reproduce a difference in behaviour between Docker and the Podman Docker API which I believe is resulting in the issue. When hitting the `/images/create` API endpoint with a repo and tag parameter, Docker creates an image with the chosen name and tag while Podman seems to only use the name and set the tag to `latest`. More information is shown below with a repro. ### Steps to reproduce the issue Steps to reproduce the issue 1. Ensure you have a system with both Podman and Docker available 2. Create an empty image using each and inspect the results as follows: ```bash me@myserver:~$ # Create an empty image with Docker. me@myserver:~$ curl -v -XPOST --unix-socket /run/docker.sock 'http:///api/images/create?fromSrc=-&amp;repo=myimage&amp;tag=mytag' * Trying /run/docker.sock:0... * Connected to api (/run/docker.sock) port 80 (#0) &gt; POST /images/create?fromSrc=-&amp;repo=myimage&amp;tag=mytag HTTP/1.1 &gt; Host: api &gt; User-Agent: curl/7.81.0 &gt; Accept: */* &gt; * Mark bundle as not supporting multiuse &lt; HTTP/1.1 200 OK &lt; Api-Version: 1.41 &lt; Content-Type: application/json &lt; Docker-Experimental: false &lt; Ostype: linux &lt; Server: Docker/20.10.21 (linux) &lt; Date: Wed, 17 May 2023 06:51:16 GMT &lt; Transfer-Encoding: chunked &lt; {&quot;status&quot;:&quot;sha256:bb944196d717548f774e7d64da0c3b1ab9b567dcef3577d5db11c712b0eb8df1&quot;} * Connection #0 to host api left intact me@myserver:~$ docker images REPOSITORY TAG IMAGE ID CREATED SIZE myimage mytag bb944196d717 6 seconds ago 0B me@myserver:~$ curl -v --unix-socket /run/docker.sock 'http://api/images/myimage:mytag/json' * Trying /run/docker.sock:0... * Connected to api (/run/docker.sock) port 80 (#0) &gt; GET /images/myimage:mytag/json HTTP/1.1 &gt; Host: api &gt; User-Agent: curl/7.81.0 &gt; Accept: */* &gt; * Mark bundle as not supporting multiuse &lt; HTTP/1.1 200 OK &lt; Api-Version: 1.41 &lt; Content-Type: application/json &lt; Docker-Experimental: false &lt; Ostype: linux &lt; Server: Docker/20.10.21 (linux) &lt; Date: Wed, 17 May 2023 06:51:26 GMT &lt; Content-Length: 1424 &lt; {&quot;Id&quot;:&quot;sha256:bb944196d717548f774e7d64da0c3b1ab9b567dcef3577d5db11c712b0eb8df1&quot;,&quot;RepoTags&quot;:[&quot;myimage:mytag&quot;],&quot;RepoDigests&quot;:[],&quot;Parent&quot;:&quot;&quot;,&quot;Comment&quot;:&quot;Imported from -&quot;,&quot;Created&quot;:&quot;2023-05-17T06:51:16.354773741Z&quot;,&quot;Container&quot;:&quot;&quot;,&quot;ContainerConfig&quot;:{&quot;Hostname&quot;:&quot;&quot;,&quot;Domainname&quot;:&quot;&quot;,&quot;User&quot;:&quot;&quot;,&quot;AttachStdin&quot;:false,&quot;AttachStdout&quot;:false,&quot;AttachStderr&quot;:false,&quot;Tty&quot;:false,&quot;OpenStdin&quot;:false,&quot;StdinOnce&quot;:false,&quot;Env&quot;:null,&quot;Cmd&quot;:null,&quot;Image&quot;:&quot;&quot;,&quot;Volumes&quot;:null,&quot;WorkingDir&quot;:&quot;&quot;,&quot;Entrypoint&quot;:null,&quot;OnBuild&quot;:null,&quot;Labels&quot;:null},&quot;DockerVersion&quot;:&quot;20.10.21&quot;,&quot;Author&quot;:&quot;&quot;,&quot;Config&quot;:{&quot;Hostname&quot;:&quot;&quot;,&quot;Domainname&quot;:&quot;&quot;,&quot;User&quot;:&quot;&quot;,&quot;AttachStdin&quot;:false,&quot;AttachStdout&quot;:false,&quot;AttachStderr&quot;:false,&quot;Tty&quot;:false,&quot;OpenStdin&quot;:false,&quot;StdinOnce&quot;:false,&quot;Env&quot;:null,&quot;Cmd&quot;:null,&quot;Image&quot;:&quot;&quot;,&quot;Volumes&quot;:null,&quot;WorkingDir&quot;:&quot;&quot;,&quot;Entrypoint&quot;:null,&quot;OnBuild&quot;:null,&quot;Labels&quot;:null},&quot;Architecture&quot;:&quot;amd64&quot;,&quot;Os&quot;:&quot;linux&quot;,&quot;Size&quot;:0,&quot;VirtualSize&quot;:0,&quot;GraphDriver&quot;:{&quot;Data&quot;:{&quot;MergedDir&quot;:&quot;/var/lib/docker/overlay2/669ba8d7a9fcdf7b1b321ec814400ec4df2964cfdc11c65a0d320afb7e288114/merged&quot;,&quot;UpperDir&quot;:&quot;/var/lib/docker/overlay2/669ba8d7a9fcdf7b1b321ec814400ec4df2964cfdc11c65a0d320afb7e288114/diff&quot;,&quot;WorkDir&quot;:&quot;/var/lib/docker/overlay2/669ba8d7a9fcdf7b1b321ec814400ec4df2964cfdc11c65a0d320afb7e288114/work&quot;},&quot;Name&quot;:&quot;overlay2&quot;},&quot;RootFS&quot;:{&quot;Type&quot;:&quot;layers&quot;,&quot;Layers&quot;:[&quot;sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&quot;]},&quot;Metadata&quot;:{&quot;LastTagTime&quot;:&quot;2023-05-17T16:51:16.357888207+10:00&quot;}} * Connection #0 to host api left intact me@myserver:~$ # Create an empty image with Podman. me@myserver:~$ curl -v -XPOST --unix-socket /run/user/1000/podman/podman.sock 'http:///api/images/create?fromSrc=-&amp;repo=myimage&amp;tag=mytag' * Trying /run/user/1000/podman/podman.sock:0... * Connected to api (/run/user/1000/podman/podman.sock) port 80 (#0) &gt; POST /images/create?fromSrc=-&amp;repo=myimage&amp;tag=mytag HTTP/1.1 &gt; Host: api &gt; User-Agent: curl/7.81.0 &gt; Accept: */* &gt; * Mark bundle as not supporting multiuse &lt; HTTP/1.1 200 OK &lt; Api-Version: 1.41 &lt; Content-Type: application/json &lt; Libpod-Api-Version: 4.5.0 &lt; Server: Libpod/4.5.0 (linux) &lt; X-Reference-Id: 0xc0000c0490 &lt; Date: Wed, 17 May 2023 06:51:45 GMT &lt; Content-Length: 198 &lt; {&quot;status&quot;:&quot;sha256:b27eea98c26530caa6fbb4754d1dd08d401f5c839e0ae4068fff65be1668ddb1&quot;,&quot;progress&quot;:&quot;&quot;,&quot;progressDetail&quot;:{},&quot;id&quot;:&quot;sha256:b27eea98c26530caa6fbb4754d1dd08d401f5c839e0ae4068fff65be1668ddb1&quot;} * Connection #0 to host api left intact me@myserver:~$ podman images REPOSITORY TAG IMAGE ID CREATED SIZE docker.io/library/myimage latest b27eea98c265 3 seconds ago 1.09 kB me@myserver:~$ curl -v --unix-socket /run/user/1000/podman/podman.sock 'http://api/images/myimage:mytag/json' * Trying /run/user/1000/podman/podman.sock:0... * Connected to api (/run/user/1000/podman/podman.sock) port 80 (#0) &gt; GET /images/myimage:mytag/json HTTP/1.1 &gt; Host: api &gt; User-Agent: curl/7.81.0 &gt; Accept: */* &gt; * Mark bundle as not supporting multiuse &lt; HTTP/1.1 404 Not Found &lt; Api-Version: 1.41 &lt; Content-Type: application/json &lt; Libpod-Api-Version: 4.5.0 &lt; Server: Libpod/4.5.0 (linux) &lt; X-Reference-Id: 0xc0000c92a0 &lt; Date: Wed, 17 May 2023 06:51:59 GMT &lt; Content-Length: 205 &lt; {&quot;cause&quot;:&quot;failed to find image myimage:mytag: docker.io/library/myimage:mytag: No such image&quot;,&quot;message&quot;:&quot;failed to find image myimage:mytag: docker.io/library/myimage:mytag: No such image&quot;,&quot;response&quot;:404} * Connection #0 to host api left intact ``` ### Describe the results you received As you can see, Docker creates the image `myimage:mytag` while Podman creates the image `docker.io/library/myimage:latest` where the tag has not been respected by Podman. ### Describe the results you expected I expected Podman to create the image with the tag `mytag` as Docker does. ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.30.0 cgroupControllers: - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon_100:2.1.2~0_amd64 path: /usr/libexec/podman/conmon version: 'conmon version 2.1.2, commit: ' cpuUtilization: idlePercent: 99.08 systemPercent: 0.23 userPercent: 0.69 cpus: 4 databaseBackend: boltdb distribution: codename: jammy distribution: ubuntu version: &quot;22.04&quot; eventLogger: journald hostname: myserver.mydomain idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 kernel: 5.15.0-71-generic linkmode: dynamic logDriver: journald memFree: 7083307008 memTotal: 16753397760 networkBackend: cni ociRuntime: name: runc package: runc_1.1.0-0ubuntu1_amd64 path: /usr/sbin/runc version: |- runc version 1.1.0-0ubuntu1 spec: 1.0.2-dev go: go1.17.3 libseccomp: 2.5.3 os: linux remoteSocket: exists: true path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns_1.0.1-2_amd64 version: |- slirp4netns version 1.0.1 commit: 6a7b16babc95b6a3056b33fb45b74a6f62262dd4 libslirp: 4.6.1 swapFree: 4294963200 swapTotal: 4294963200 uptime: 314h 16m 0.00s (Approximately 13.08 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - docker.io - quay.io store: configFile: /home/me/.config/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /home/me/.local/share/containers/storage graphRootAllocated: 103240073216 graphRootUsed: 48463527936 graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 1 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/me/.local/share/containers/storage/volumes version: APIVersion: 4.5.0 Built: 0 BuiltTime: Thu Jan 1 10:00:00 1970 GitCommit: &quot;&quot; GoVersion: go1.18.1 Os: linux OsArch: linux/amd64 Version: 4.5.0 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details I've replicated this problem on various versions of Podman ranging from 3.4.4 to the latest on both Ubuntu 22.04 and AlmaLinux 9. ### Additional information Additional information like issue happens only occasionally or issue happens with a particular architecture or on a particular setting</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #18583 from flouthoc/compat-pull-accept-string compat,build: pull must accept string</MESSAGE>
    <SHA>a1201843fd6a72181bf47b3df731ac1f8863195f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>compat: accept tag in /images/create?fromSrc Accept a tag in the compat api endpoint. For the fromImage param we already parse it but for fromSrc we did not. Fixes #18597 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>ad8d0e57d73c1ffe92ce08fabcb4c35e8aa94e9a</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/images.go</FILE>
        <FILE>test/apiv2/10-images.at</FILE>
        <FILE>test/apiv2/test-apiv2</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>compat: accept tag in /images/create?fromSrc Accept a tag in the compat api endpoint. For the fromImage param we already parse it but for fromSrc we did not. Fixes #18597 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>1e86d0a75b9db7fe8b342c4f0bc9561d27ce0c24</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/images.go</FILE>
        <FILE>test/apiv2/10-images.at</FILE>
        <FILE>test/apiv2/test-apiv2</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
