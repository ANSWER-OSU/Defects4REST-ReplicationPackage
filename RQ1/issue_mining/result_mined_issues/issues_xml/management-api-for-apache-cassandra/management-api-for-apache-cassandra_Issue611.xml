<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>611</ISSUENO>
  <ISSUEURL>https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/611</ISSUEURL>
  <TITLE>Fix HCD CC4 Agent for newer Netty</TITLE>
  <DESCRIPTION>We have the same ClassCastException issue during startup with newer versions of Netty for HCD using CC4 as we did for Cassandra 5.0 and the HCD CC5 Agent: ``` ERROR [epollEventLoopGroup-5-2] 2025-02-24 19:29:11,757 ExceptionHandlers.java:206 - Unexpected exception during request; channel = [id: 0xf8a5ce2f, L:/tmp/hcd.sock - R:] io.netty.handler.codec.DecoderException: java.lang.ClassCastException: class io.netty.channel.unix.DomainSocketAddress cannot be cast to class java.net.InetSocketAddress (io.netty.channel.unix.DomainSocketAddress is in unnamed module of loader 'app'; java.net.InetSocketAddress is in module java.base of loader 'bootstrap') at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:500) at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1357) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:868) at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:799) at io.netty.channel.epoll.EpollDomainSocketChannel$EpollDomainUnsafe.epollInReady(EpollDomainSocketChannel.java:138) at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:501) at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:399) at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.Thread.run(Thread.java:829) Caused by: java.lang.ClassCastException: class io.netty.channel.unix.DomainSocketAddress cannot be cast to class java.net.InetSocketAddress (io.netty.channel.unix.DomainSocketAddress is in unnamed module of loader 'app'; java.net.InetSocketAddress is in module java.base of loader 'bootstrap') at org.apache.cassandra.service.ClientState.forExternalCalls(ClientState.java:187) at org.apache.cassandra.transport.ServerConnection.&lt;init&gt;(ServerConnection.java:47) at org.apache.cassandra.transport.UnixSocketServerHcd$UnixSocketConnection.&lt;init&gt;(UnixSocketServerHcd.java:176) at org.apache.cassandra.transport.UnixSocketServerHcd$1.lambda$initChannel$0(UnixSocketServerHcd.java:68) at org.apache.cassandra.transport.UnixSocketServerHcd$PipelineChannelInitializer.decode(UnixSocketServerHcd.java:286) at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530) at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469) ... 16 common frames omitted ``` We need to employ the same fix we used when we saw this for C* 5.0 and wrap the Netty Channel class to override the `remoteAddress()` method. ┆Issue is synchronized with this [Jira Story](https://datastax.jira.com/browse/MAPI-105) by [Unito](https://www.unito.io) ┆Issue Number: MAPI-105</DESCRIPTION>
  <REPONAME>management-api-for-apache-cassandra</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix the Channel Pipeline initializer for CC4 Agent (#610) This creates a ConnectionFactory wrapper that overrides the Netty Channel class to not have a class cast exception when retrieving the remoteAddress(). In newer versions of Netty, this causes startup problems with Management API. This same strategy is being done for the C* 5.0 agent as well as the HCD CC5 agent.</MESSAGE>
    <SHA>72205140e7cbc39a0db8bff1c9fe5ba70129996a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Release v0.1.98 * [BUGFIX] [#611](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/611) Fix HCD CC4 Agent for newer Netty</MESSAGE>
      <SHA>d40a935cff727a688b9a061de171fe8b5e660c62</SHA>
      <PATCHEDFILES>
        <FILE>CHANGELOG.md</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
