<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>257</ISSUENO>
  <ISSUEURL>https://github.com/strapdata/elassandra/issues/257</ISSUEURL>
  <TITLE>The index is still keeping dynamic update even that index mapping has configured dynamic: false</TITLE>
  <DESCRIPTION>&lt;!-- ** Please read the guidelines below. ** Issues that do not follow these guidelines are likely to be closed. 1. GitHub is reserved for bug reports and feature requests. 2. Is this bug report or feature request for a supported OS? If not, it is likely to be closed. See https://www.elastic.co/support/matrix#show_os 3. Please fill out EITHER the feature request block or the bug report block below, and delete the other block. --&gt; &lt;!-- Bug report --&gt; **Elassandra version**: elassandra:5.5.0.24 **Plugins installed**: NONE **JVM version**: openjdk version &quot;1.8.0_181&quot; OpenJDK Runtime Environment (build 1.8.0_181-8u181-b13-1~deb9u1-b13) OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode) **OS version**: 3.10.0-862.9.1.el7.x86_64 x86_64 GNU/Linux **Description of the problem including expected versus actual behavior**: We setup a small elassandra cluster(3 nodes) **Problem**: Elassandra dynamically updates the index mapping when inserted a new row with more new keys in a map field, even the index mapping has set the **dynamic** flag to **false** **Expected behavior**: Elassandra keeps the index mapping as it once created. https://www.elastic.co/guide/en/elasticsearch/reference/5.5/dynamic.html **Steps to reproduce**: 1. create the key space 'mytest' and table 'mymaptable': &lt;pre&gt; CREATE KEYSPACE mytest WITH REPLICATION = { 'class' : 'NetworkTopologyStrategy', 'DC1': '2'}; use mytest; CREATE TABLE mymaptable ( id text, name text, counters map&lt;text, int&gt;, PRIMARY KEY ( id ) ); &lt;/pre&gt; 2. create index 'dyntest ' `curl -XPUT http://localhost:9200/dyntest -d @/dyn_mapping_check.json` the **dyn_mapping_check.json** content: &lt;pre&gt; { &quot;settings&quot;: { &quot;keyspace&quot;: &quot;mytest&quot; }, &quot;mappings&quot;: { &quot;mymaptable&quot;: { &quot;dynamic&quot;: false, &quot;properties&quot;: { &quot;id&quot;: { &quot;type&quot;: &quot;keyword&quot;, &quot;cql_partition_key&quot; : true, &quot;cql_collection&quot;: &quot;singleton&quot;, &quot;cql_primary_key_order&quot;: 0 }, &quot;name&quot;: { &quot;type&quot;: &quot;keyword&quot;, &quot;cql_collection&quot;: &quot;singleton&quot; }, &quot;counters&quot;: { &quot;dynamic&quot;: false, &quot;type&quot;: &quot;nested&quot;, &quot;cql_struct&quot;: &quot;map&quot;, &quot;cql_collection&quot;: &quot;singleton&quot;, &quot;properties&quot;: { &quot;retry&quot;: { &quot;type&quot;: &quot;integer&quot; }, &quot;fail&quot;: { &quot;type&quot;: &quot;integer&quot; } } } } } } } &lt;/pre&gt; 3. use cqlsh tool to insert 2 rows: &lt;pre&gt; insert into mytest.mymaptable (id, name, counters) values ('john.d', 'john', {'tps':1000, 'retry':1}); &lt;/pre&gt; &lt;pre&gt; insert into mytest.mymaptable (id, name, counters) values ('Kelly.S', 'kelly', {'tps':1200, 'fail':2, 'pending':100}); &lt;/pre&gt; 4. check whether the index mapping keep as it: curl -XGET http://localhost:9200/dyntest?pretty &lt;pre&gt; { &quot;dyntest&quot; : { &quot;aliases&quot; : { }, &quot;mappings&quot; : { &quot;mymaptable&quot; : { &quot;dynamic&quot; : &quot;false&quot;, &quot;properties&quot; : { &quot;counters&quot; : { &quot;type&quot; : &quot;nested&quot;, &quot;cql_struct&quot; : &quot;map&quot;, &quot;cql_collection&quot; : &quot;singleton&quot;, &quot;dynamic&quot; : &quot;false&quot;, &quot;properties&quot; : { &quot;fail&quot; : { &quot;type&quot; : &quot;integer&quot; }, &quot;pending&quot; : { &quot;type&quot; : &quot;integer&quot; }, &quot;retry&quot; : { &quot;type&quot; : &quot;integer&quot; }, &quot;tps&quot; : { &quot;type&quot; : &quot;integer&quot; } } }, &quot;id&quot; : { &quot;type&quot; : &quot;keyword&quot;, &quot;cql_collection&quot; : &quot;singleton&quot;, &quot;cql_partition_key&quot; : true, &quot;cql_primary_key_order&quot; : 0 }, &quot;name&quot; : { &quot;type&quot; : &quot;keyword&quot;, &quot;cql_collection&quot; : &quot;singleton&quot; } } } }, &quot;settings&quot; : { &quot;index&quot; : { &quot;keyspace&quot; : &quot;mytest&quot;, &quot;number_of_shards&quot; : &quot;3&quot;, &quot;provided_name&quot; : &quot;dyntest&quot;, &quot;creation_date&quot; : &quot;1545887324964&quot;, &quot;number_of_replicas&quot; : &quot;1&quot;, &quot;uuid&quot; : &quot;XaWOdvh9STa--IIk6PcNFA&quot;, &quot;version&quot; : { &quot;created&quot; : &quot;5050099&quot; } } } } } &lt;/pre&gt; We saw that all the keys in the map field have been updated to the index mapping. The expected behavior is it shall keep as **only having &quot;retry&quot; and &quot;fail&quot;** @vroyer If there is any more information required, please let me know, thanks.</DESCRIPTION>
  <REPONAME>elassandra</REPONAME>
  <TIMEDIFFERENCEDAYS>18</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>remove dead code</MESSAGE>
    <SHA>948a614223af0b4461a56094c35a587d8ee4301d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #257 The index is still keeping dynamic update even that index mapping has configured dynamic: false</MESSAGE>
      <SHA>73f56acf3a2bb5d327cb7cd4846dee8f0194bfb3</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elassandra/index/ElasticSecondaryIndex.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java</FILE>
        <FILE>server/src/test/java/org/elassandra/CqlTypesTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
