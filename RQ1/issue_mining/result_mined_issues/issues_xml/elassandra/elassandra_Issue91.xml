<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>91</ISSUENO>
  <ISSUEURL>https://github.com/strapdata/elassandra/issues/91</ISSUEURL>
  <TITLE>Timeout when updating mapping due to new field in nested field (c* map)</TITLE>
  <DESCRIPTION>I have a single node and a table with map&lt;text, text&gt;. When i insert a row via cql, elassandra attempts to update the type mapping (presumably in the elastic_admin.metadata table. I'm getting a timeout in the logs for each field update, like so: ``` 2017-04-10 13:48:14,726 INFO [SharedPool-Worker-2] ElasticSecondaryIndex.java:470 addField updating mapping={&quot;event_structured&quot;:{&quot;properties&quot;:{&quot;strings&quot;:{&quot;type&quot;:&quot;nested&quot;,&quot;cql_struct&quot;:&quot;map&quot;,&quot;cql_collection&quot;:&quot;singleton &quot;,&quot;properties&quot;:{&quot;stringProperty1&quot;:{&quot;type&quot;:&quot;string&quot;}}}}}} 2017-04-10 13:48:44,727 ERROR [SharedPool-Worker-2] ElasticSecondaryIndex.java:476 addField error while updating mapping org.elasticsearch.ElasticsearchTimeoutException: blocking update timeout at org.elassandra.cluster.InternalCassandraClusterService$BlockingActionListener.waitForUpdate(InternalCassandraClusterService.java:1690) at org.elassandra.cluster.InternalCassandraClusterService.blockingMappingUpdate(InternalCassandraClusterService.java:1717) at org.elassandra.index.ElasticSecondaryIndex$Context.addField(ElasticSecondaryIndex.java:472) at org.elassandra.index.ElasticSecondaryIndex$ImmutableMappingInfo$RowcumentIndexer$Rowcument.buildContext(ElasticSecondaryIndex.java:1706) at org.elassandra.index.ElasticSecondaryIndex$ImmutableMappingInfo$WideRowcumentIndexer$WideRowcument.buildContext(ElasticSecondaryIndex.java:1264) at org.elassandra.index.ElasticSecondaryIndex$ImmutableMappingInfo$RowcumentIndexer$Rowcument.index(ElasticSecondaryIndex.java:1774) at org.elassandra.index.ElasticSecondaryIndex$ImmutableMappingInfo$RowcumentIndexer$Rowcument.index(ElasticSecondaryIndex.java:1764) at org.elassandra.index.ElasticSecondaryIndex$ImmutableMappingInfo$WideRowcumentIndexer$WideRowcument.index(ElasticSecondaryIndex.java:1264) at org.elassandra.index.ElasticSecondaryIndex$ImmutableMappingInfo$WideRowcumentIndexer.flush(ElasticSecondaryIndex.java:1307) at org.elassandra.index.ElasticSecondaryIndex$ImmutableMappingInfo$RowcumentIndexer.finish(ElasticSecondaryIndex.java:1496) at org.apache.cassandra.index.SecondaryIndexManager$WriteTimeTransaction.commit(SecondaryIndexManager.java:869) at org.apache.cassandra.db.partitions.AtomicBTreePartition.addAllWithSizeDelta(AtomicBTreePartition.java:180) at org.apache.cassandra.db.Memtable.put(Memtable.java:258) at org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:1189) at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:558) at org.apache.cassandra.db.Keyspace.applyNotDeferrable(Keyspace.java:404) at org.apache.cassandra.db.Mutation.apply(Mutation.java:213) at org.apache.cassandra.db.Mutation.apply(Mutation.java:227) at org.apache.cassandra.service.StorageProxy$8.runMayThrow(StorageProxy.java:1344) at org.apache.cassandra.service.StorageProxy$LocalMutationRunnable.run(StorageProxy.java:2516) at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) at org.apache.cassandra.concurrent.SEPExecutor.maybeExecuteImmediately(SEPExecutor.java:192) at org.apache.cassandra.service.StorageProxy.performLocally(StorageProxy.java:1338) at org.apache.cassandra.service.StorageProxy.sendToHintedEndpoints(StorageProxy.java:1247) at org.apache.cassandra.service.StorageProxy$2.apply(StorageProxy.java:136) at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:1053) at org.apache.cassandra.service.StorageProxy.mutate(StorageProxy.java:607) at org.apache.cassandra.service.StorageProxy.mutateWithTriggers(StorageProxy.java:833) at org.apache.cassandra.cql3.statements.ModificationStatement.executeWithoutCondition(ModificationStatement.java:422) at org.apache.cassandra.cql3.statements.ModificationStatement.execute(ModificationStatement.java:408) at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:206) at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:237) at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:222) at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:115) at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:513) at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:407) at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:292) at io.netty.channel.AbstractChannelHandlerContext.access$600(AbstractChannelHandlerContext.java:32) at io.netty.channel.AbstractChannelHandlerContext$7.run(AbstractChannelHandlerContext.java:283) at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) at java.lang.Thread.run(Thread.java:745) ``` Here, my map&lt;text,text&gt; column name is 'strings' and the key in the map is 'stringProperty1'. The metadata table does have the initial index settings created using the discover method. I'm able to insert data into my table successfully when it does not have a secondary index. Both my keyspace and the elastic_admin keyspace have the same replication = { 'class' : 'NetworkTopologyStrategy', 'DC1' : 1 } Is this a single node issue perhaps?</DESCRIPTION>
  <REPONAME>elassandra</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Skip tests on travis because too long</MESSAGE>
    <SHA>6a181b3893246b18cc034c138047eb3fb6ea1f40</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#91 fix Fix Timeout when updating mapping due to new field in nested field (c* map) (#91)</MESSAGE>
      <SHA>d5734edfd9169028291e7e75a6a6381cdbca9e08</SHA>
      <PATCHEDFILES>
        <FILE>core/src/main/java/org/elassandra/cluster/InternalCassandraClusterService.java</FILE>
        <FILE>core/src/main/java/org/elassandra/index/ElasticSecondaryIndex.java</FILE>
        <FILE>core/src/main/java/org/elasticsearch/index/mapper/object/ObjectMapper.java</FILE>
        <FILE>core/src/test/java/org/elassandra/CqlTypesTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#91 dynamic mapping with maps</MESSAGE>
      <SHA>09800cb4609db063729613af64b665a0b8a91a58</SHA>
      <PATCHEDFILES>
        <FILE>core/src/main/java/org/elassandra/index/ElasticSecondaryIndex.java</FILE>
        <FILE>core/src/main/java/org/elasticsearch/index/mapper/object/ObjectMapper.java</FILE>
        <FILE>core/src/main/java/org/elasticsearch/index/mapper/object/RootObjectMapper.java</FILE>
        <FILE>core/src/test/java/org/elassandra/CqlTypesTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
