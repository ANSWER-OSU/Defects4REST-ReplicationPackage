<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>323</ISSUENO>
  <ISSUEURL>https://github.com/strapdata/elassandra/issues/323</ISSUEURL>
  <TITLE>Elassandra mappings with type coercing aren't behaving the same as elasticsearch</TITLE>
  <DESCRIPTION>&lt;!-- Bug report --&gt; **Elassandra version**: 6.8.4.0 **JVM version** (`java -version`): docker image **OS version** (`uname -a` if on a Unix-like system): host system is OSx but I also tested it in GKE. **Description of the problem including expected versus actual behavior**: When using a mapping template, that enables type coercing, Elassandra doesn't behave the same as ElasticSearch. Instead it returns a 500 and an exception. **Steps to reproduce**: In both of these examples we'll be inserting a document that has an integer mapping. And in both cases the int field's value will be submitted as a string value. #### Testing Elasticsearch 6.8 ``` docker pull docker.elastic.co/elasticsearch/elasticsearch:6.8.6 docker run -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; docker.elastic.co/elasticsearch/elasticsearch:6.8.6 export HOST=localhost export INDEX=ents_type_site1 echo '{ &quot;index_patterns&quot;: &quot;ents_*&quot;, &quot;mappings&quot;: { &quot;_doc&quot;: { &quot;properties&quot;: { &quot;_created&quot;: { &quot;type&quot;: &quot;date&quot; } }, &quot;dynamic_templates&quot;: [ { &quot;integer_fields&quot;: { &quot;match&quot;: &quot;int_*&quot;, &quot;mapping&quot;: { &quot;coerce&quot;: true, &quot;type&quot;: &quot;long&quot; } } } ] } } }' | http PUT http://$HOST:9200/_template/ent_table_template { &quot;acknowledged&quot;: true } echo '{&quot;int__eventcnt&quot;:&quot;1&quot;}' | http POST http://$HOST:9200/$INDEX/_doc/a1bc=:1cd== { &quot;_id&quot;: &quot;a1bc=:1cd==&quot;, &quot;_index&quot;: &quot;ents_type_site1&quot;, &quot;_primary_term&quot;: 1, &quot;_seq_no&quot;: 0, &quot;_shards&quot;: { &quot;failed&quot;: 0, &quot;successful&quot;: 1, &quot;total&quot;: 2 }, &quot;_type&quot;: &quot;_doc&quot;, &quot;_version&quot;: 1, &quot;result&quot;: &quot;created&quot; } ``` * Note that elasticsearch handled the casting of the string to an int. #### Testing elassandra 6.8 ``` docker run -p 9200:9200 -p 9300:9300 --name node0 -d strapdata/elassandra:6.8.4.0 export INDEX=ents_type_site1 echo '{ &quot;index_patterns&quot;: &quot;ents_*&quot;, &quot;mappings&quot;: { &quot;_doc&quot;: { &quot;properties&quot;: { &quot;_created&quot;: { &quot;type&quot;: &quot;date&quot; } }, &quot;dynamic_templates&quot;: [ { &quot;integer_fields&quot;: { &quot;match&quot;: &quot;int_*&quot;, &quot;mapping&quot;: { &quot;coerce&quot;: true, &quot;type&quot;: &quot;long&quot; } } } ] } } }' | http PUT http://$HOST:9200/_template/ent_table_template { &quot;acknowledged&quot;: true } echo '{&quot;int__eventcnt&quot;:&quot;1&quot;}' | http POST http://$HOST:9200/$INDEX/_doc/a1bc=:1cd== { &quot;error&quot;: { &quot;reason&quot;: &quot;java.lang.String cannot be cast to java.lang.Number&quot;, &quot;root_cause&quot;: [ { &quot;reason&quot;: &quot;[172.17.0.2][172.17.0.2:9300][indices:data/write/bulk[s][p]]&quot;, &quot;type&quot;: &quot;remote_transport_exception&quot; } ], &quot;type&quot;: &quot;class_cast_exception&quot; }, &quot;status&quot;: 500 } ``` **Please provide the following information**: * elassandra logs (logs/system.logs or /var/lib/cassandra/system.log) ``` 2020-01-10 06:01:40,015 WARN [elasticsearch[172.17.0.2][http_server_worker][T#2]] org.elasticsearch.common.logging.DeprecationLogger.deprecated(DeprecationLogger.java:242) [types removal] The parameter include_type_name should be explicitly specified in put template requests to prepare for 7.0. In 7.0 include_type_name will default to 'false', and requests are expected to omit the type name in mapping definitions. 2020-01-10 06:01:42,691 INFO [elasticsearch[172.17.0.2][generic][T#3]] org.elassandra.shard.CassandraShardStateListener.afterIndexShardStarted(CassandraShardStateListener.java:69) shard [ents_type_site1][0] started 2020-01-10 06:01:42,994 ERROR [elasticsearch[172.17.0.2][write][T#1]] org.elassandra.cluster.QueryManager.upsertDocument(QueryManager.java:842) [java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Number].[ents_type_site1] failed to parse field _doc=int__eventcnt 2020-01-10 06:01:43,011 WARN [elasticsearch[172.17.0.2][write][T#1]] org.elasticsearch.rest.BytesRestResponse.build(BytesRestResponse.java:133) path: /ents_type_site1/_doc/a1bc=:1cd==, params: {index=ents_type_site1, id=a1bc=:1cd==, type=_doc} org.elasticsearch.transport.RemoteTransportException: [172.17.0.2][172.17.0.2:9300][indices:data/write/bulk[s][p]] Caused by: java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Number at org.elasticsearch.index.mapper.NumberFieldMapper$NumberType$7.cqlValue(NumberFieldMapper.java:870) at org.elasticsearch.index.mapper.NumberFieldMapper$NumberFieldType.cqlValue(NumberFieldMapper.java:1057) at org.elasticsearch.index.mapper.MappedFieldType.cqlValue(MappedFieldType.java:423) at org.elassandra.cluster.Serializer.serialize(Serializer.java:230) at org.elassandra.cluster.Serializer.serialize(Serializer.java:223) at org.elassandra.cluster.QueryManager.upsertDocument(QueryManager.java:840) at org.elassandra.cluster.QueryManager.insertDocument(QueryManager.java:694) at org.elasticsearch.action.bulk.TransportShardBulkAction.lambda$executeIndexRequestOnPrimary$3(TransportShardBulkAction.java:468) at org.elasticsearch.action.bulk.TransportShardBulkAction.executeOnPrimaryWhileHandlingMappingUpdates(TransportShardBulkAction.java:495) at org.elasticsearch.action.bulk.TransportShardBulkAction.executeIndexRequestOnPrimary(TransportShardBulkAction.java:464) at org.elasticsearch.action.bulk.TransportShardBulkAction.executeBulkItemRequest(TransportShardBulkAction.java:226) at org.elasticsearch.action.bulk.TransportShardBulkAction.performOnPrimary(TransportShardBulkAction.java:169) at org.elasticsearch.action.bulk.TransportShardBulkAction.performOnPrimary(TransportShardBulkAction.java:160) at org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:146) at org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:83) at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:1088) at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:1066) at org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:105) at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.runWithPrimaryShardReference(TransportReplicationAction.java:445) at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:387) at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:327) at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:314) at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:696) at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) ``` * elasticsearch cluster state (curl http://localhost:9200/_cluster/state) * cassandra schema (cqlsh&gt;DESC KEYSPACE &lt;your_keyspace&gt;) * cassandra gossip state (run: nodetool gossipinfo)</DESCRIPTION>
  <REPONAME>elassandra</REPONAME>
  <TIMEDIFFERENCEDAYS>62</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Disable elasticsearch cluster state persistence</MESSAGE>
    <SHA>afee1653bd93d9861f227a6998cea22d37bc51a9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[#323] Elassandra Mapping coercing issue with dynamic template</MESSAGE>
      <SHA>3c9335caaa64619a9ec7254c9bdf5c68460abd24</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elassandra/cluster/Serializer.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/mapper/NumberFieldMapper.java</FILE>
        <FILE>server/src/test/java/org/elassandra/CqlTypesTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[#323] Elassandra Mapping coercing issue with dynamic template</MESSAGE>
      <SHA>d7b409ee607fc440eb3ab9e88b1d2cdf7fbefbc6</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elassandra/cluster/Serializer.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/mapper/NumberFieldMapper.java</FILE>
        <FILE>server/src/test/java/org/elassandra/CqlTypesTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
