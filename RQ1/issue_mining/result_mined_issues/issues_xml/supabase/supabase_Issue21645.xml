<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>21645</ISSUENO>
  <ISSUEURL>https://github.com/supabase/supabase/issues/21645</ISSUEURL>
  <TITLE>supabase_imgproxy &quot;Source image resolution is too big&quot; when images &gt;= 16.8MP in local dev / self-hosted</TITLE>
  <DESCRIPTION># Bug report - [X] I confirm this is a bug with Supabase, not with my own application. - [X] I confirm I have searched the [Docs](https://docs.supabase.com), GitHub [Discussions](https://github.com/supabase/supabase/discussions), and [Discord](https://discord.supabase.com). ## Describe the bug [Storage Image Transformations § Limits](https://supabase.com/docs/guides/storage/serving/image-transformations#limits) states: &quot;The image resolution cannot exceed 50MP.&quot; However, `docker-compose.yml` does not set the required value `IMGPROXY_MAX_SRC_RESOLUTION` to increase the default value of 16.8MP to 50MP for local development / self-hosted contexts. As a result, my local dev / self hosted experience differs in an undocumented way from production, and there doesn't seem to be an easy way to adjust this setting locally. The way it manifests locally is also a bit confusing/unclear because (at least for me in the context of building a Next.js app), the first way it manifests is as a 404 error when requesting an image transform URL for an image that is &gt;= 16.8 MP. From [upstream documentation $ Security](https://docs.imgproxy.net/configuration/options#security): &gt; `IMGPROXY_MAX_SRC_RESOLUTION`: the maximum resolution of the source image, in megapixels. Images with larger actual size will be rejected. Default: `16.8` The [Docker config for `supabase-imgproxy`](https://github.com/supabase/supabase/blob/d9dbd66a8204f5525e07812f851d8f12402257e7/docker/docker-compose.yml#L241) does not set this variable: ```yaml imgproxy: container_name: supabase-imgproxy image: darthsim/imgproxy:v3.8.0 healthcheck: test: [ &quot;CMD&quot;, &quot;imgproxy&quot;, &quot;health&quot; ] timeout: 5s interval: 5s retries: 3 environment: IMGPROXY_BIND: &quot;:5001&quot; IMGPROXY_LOCAL_FILESYSTEM_ROOT: / IMGPROXY_USE_ETAG: &quot;true&quot; IMGPROXY_ENABLE_WEBP_DETECTION: ${IMGPROXY_ENABLE_WEBP_DETECTION} volumes: - ./volumes/storage:/var/lib/storage:z ``` The trail I followed looked like this: 1. In my Next.js app, 404 errors in console when using the image transform URLs, even though I knew the image existed and other images of a roughly similar size (and same settings such as color depth) were working fine 2. 422 errors from Axios 3. `supabase_storage` log errors: ```json &quot;error&quot;: { &quot;raw&quot;: &quot;{\&quot;name\&quot;:\&quot;ImageProcessingError\&quot;,\&quot;httpStatusCode\&quot;:422,\&quot;userStatusCode\&quot;:400,\&quot;originalError\&quot;:{\&quot;message\&quot;:\&quot;Request failed with status code 422\&quot;,\&quot;name\&quot;:\&quot;AxiosError\&quot;,\&quot;stack\&quot;:\&quot;AxiosError: Request failed with status code 422\\n at settle (/app/node_modules/axios/dist/node/axios.cjs:1967:12)\\n at RedirectableRequest.handleResponse (/app/node_modules/axios/dist/node/axios.cjs:3010:9)\\n at RedirectableRequest.emit (node:events:529:35)\\n at RedirectableRequest._processResponse (/app/node_modules/follow-redirects/index.js:351:10)\\n at RedirectableRequest._onNativeResponse (/app/node_modules/follow-redirects/index.js:57:10)\\n at Object.onceWrapper (node:events:632:26)\\n at ClientRequest.emit (node:events:517:28)\\n at HTTPParser.parserOnIncomingClient (node:_http_client:700:27)\\n at HTTPParser.parserOnHeadersComplete (node:_http_common:119:17)\\n at Socket.socketOnData (node:_http_client:541:22)\&quot;,\&quot;config\&quot;:{\&quot;transitional\&quot;:{\&quot;silentJSONParsing\&quot;:true,\&quot;forcedJSONParsing\&quot;:true,\&quot;clarifyTimeoutError\&quot;:false},\&quot;adapter\&quot;:[\&quot;xhr\&quot;,\&quot;http\&quot;],\&quot;transformRequest\&quot;:[null],\&quot;transformResponse\&quot;:[null],\&quot;timeout\&quot;:15000,\&quot;xsrfCookieName\&quot;:\&quot;XSRF-TOKEN\&quot;,\&quot;xsrfHeaderName\&quot;:\&quot;X-XSRF-TOKEN\&quot;,\&quot;maxContentLength\&quot;:-1,\&quot;maxBodyLength\&quot;:-1,\&quot;env\&quot;:{},\&quot;headers\&quot;:{\&quot;Accept\&quot;:\&quot;application/json, text/plain, */*\&quot;,\&quot;User-Agent\&quot;:\&quot;axios/1.6.3\&quot;,\&quot;Accept-Encoding\&quot;:\&quot;gzip, compress, deflate, br\&quot;},\&quot;baseURL\&quot;:\&quot;http://storage_imgproxy_cumulus-web-app:5001\&quot;,\&quot;httpAgent\&quot;:{\&quot;_events\&quot;:{\&quot;free\&quot;:[null,null]},\&quot;_eventsCount\&quot;:2,\&quot;defaultPort\&quot;:80,\&quot;protocol\&quot;:\&quot;http:\&quot;,\&quot;options\&quot;:{\&quot;maxSockets\&quot;:5000,\&quot;freeSocketTimeout\&quot;:2000,\&quot;keepAlive\&quot;:true,\&quot;timeout\&quot;:61000,\&quot;socketActiveTTL\&quot;:0,\&quot;noDelay\&quot;:true,\&quot;path\&quot;:null},\&quot;requests\&quot;:{},\&quot;sockets\&quot;:{},\&quot;freeSockets\&quot;:{\&quot;storage_imgproxy_cumulus-web-app:5001:\&quot;:[{\&quot;connecting\&quot;:false,\&quot;_hadError\&quot;:false,\&quot;_parent\&quot;:null,\&quot;_host\&quot;:\&quot;storage_imgproxy_cumulus-web-app\&quot;,\&quot;_closeAfterHandlingError\&quot;:false,\&quot;_readableState\&quot;:{\&quot;state\&quot;:266328,\&quot;highWaterMark\&quot;:16384,\&quot;buffer\&quot;:{\&quot;head\&quot;:null,\&quot;tail\&quot;:null,\&quot;length\&quot;:0},\&quot;length\&quot;:0,\&quot;pipes\&quot;:[],\&quot;flowing\&quot;:true,\&quot;errored\&quot;:null,\&quot;defaultEncoding\&quot;:\&quot;utf8\&quot;,\&quot;awaitDrainWriters\&quot;:null,\&quot;decoder\&quot;:null,\&quot;encoding\&quot;:null},\&quot;_events\&quot;:{\&quot;free\&quot;:[null,null],\&quot;close\&quot;:[null,null],\&quot;timeout\&quot;:[null,null,null],\&quot;error\&quot;:[null,null],\&quot;agentRemove\&quot;:[null,null]},\&quot;_eventsCount\&quot;:6,\&quot;_writableState\&quot;:{\&quot;objectMode\&quot;:false,\&quot;highWaterMark\&quot;:16384,\&quot;finalCalled\&quot;:false,\&quot;needDrain\&quot;:false,\&quot;ending\&quot;:false,\&quot;ended\&quot;:false,\&quot;finished\&quot;:false,\&quot;destroyed\&quot;:false,\&quot;decodeStrings\&quot;:false,\&quot;defaultEncoding\&quot;:\&quot;utf8\&quot;,\&quot;length\&quot;:0,\&quot;writing\&quot;:false,\&quot;corked\&quot;:0,\&quot;sync\&quot;:false,\&quot;bufferProcessing\&quot;:false,\&quot;writecb\&quot;:null,\&quot;writelen\&quot;:0,\&quot;afterWriteTickInfo\&quot;:null,\&quot;buffered\&quot;:[],\&quot;bufferedIndex\&quot;:0,\&quot;allBuffers\&quot;:true,\&quot;allNoop\&quot;:true,\&quot;pendingcb\&quot;:0,\&quot;constructed\&quot;:true,\&quot;prefinished\&quot;:false,\&quot;errorEmitted\&quot;:false,\&quot;emitClose\&quot;:false,\&quot;autoDestroy\&quot;:true,\&quot;errored\&quot;:null,\&quot;closed\&quot;:false,\&quot;closeEmitted\&quot;:false},\&quot;allowHalfOpen\&quot;:false,\&quot;_sockname\&quot;:null,\&quot;_pendingData\&quot;:null,\&quot;_pendingEncoding\&quot;:\&quot;\&quot;,\&quot;server\&quot;:null,\&quot;_server\&quot;:null,\&quot;timeout\&quot;:2000,\&quot;parser\&quot;:null,\&quot;_httpMessage\&quot;:null}]},\&quot;keepAliveMsecs\&quot;:1000,\&quot;keepAlive\&quot;:true,\&quot;maxSockets\&quot;:5000,\&quot;maxFreeSockets\&quot;:256,\&quot;scheduling\&quot;:\&quot;lifo\&quot;,\&quot;maxTotalSockets\&quot;:null,\&quot;totalSocketCount\&quot;:1,\&quot;createSocketCount\&quot;:138,\&quot;createSocketCountLastCheck\&quot;:0,\&quot;createSocketErrorCount\&quot;:0,\&quot;createSocketErrorCountLastCheck\&quot;:0,\&quot;closeSocketCount\&quot;:137,\&quot;closeSocketCountLastCheck\&quot;:0,\&quot;errorSocketCount\&quot;:0,\&quot;errorSocketCountLastCheck\&quot;:0,\&quot;requestCount\&quot;:805,\&quot;requestCountLastCheck\&quot;:0,\&quot;timeoutSocketCount\&quot;:137,\&quot;timeoutSocketCountLastCheck\&quot;:0},\&quot;responseType\&quot;:\&quot;stream\&quot;,\&quot;method\&quot;:\&quot;get\&quot;,\&quot;url\&quot;:\&quot;/public/height:364/width:547/resizing_type:fit/plain/local:////mnt/stub/stub/medias/df7e6830-5e8f-4193-9e6e-26e4c1e89d30/0e8783b5-0bf7-48a2-9149-8ac94e4ead5d/04efa708-3c06-446a-b551-cf15e9222b0d\&quot;,\&quot;axios-retry\&quot;:{\&quot;retries\&quot;:5,\&quot;shouldResetTimeout\&quot;:true,\&quot;retryCount\&quot;:0,\&quot;lastRequestTime\&quot;:1709146948608}},\&quot;code\&quot;:\&quot;ERR_BAD_REQUEST\&quot;,\&quot;status\&quot;:422}}&quot;, &quot;name&quot;: &quot;ImageProcessingError&quot;, &quot;message&quot;: &quot;Invalid source image&quot;, &quot;stack&quot;: &quot;ImageProcessingError: Invalid source image\n at ImageRenderer.handleRequestError (/app/dist/storage/renderer/image.js:206:15)\n at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n at async ImageRenderer.getAsset (/app/dist/storage/renderer/image.js:186:17)\n at async ImageRenderer.render (/app/dist/storage/renderer/renderer.js:12:26)&quot; } ``` 5. `supabase_imgproxy` log warnings with the final culprit, &quot;Source image resolution too big&quot;: ``` WARNING [2024-02-28T19:30:25Z] Completed in 180.963µs /public/plain/local:////mnt/stub/stub/medias/7f6edb55-d232-4b0e-a212-898970cf02ab/812edfb9-a41c-4971-a802-c40bb7f24dab/f27dc083-0214-4b11-8dee-f05261d3eda6 request_id=qcRwRWIVydig-VtcM9MdY method=GET status=422 client_ip=172.18.0.10 error=&quot;Can't download source image: Source image resolution is too big&quot; ``` ## To Reproduce Steps to reproduce the behavior, please provide code snippets or a repository: 1. Upload an image to Supabase storage bucket that is equal to or exceeds 16.8MP 2. Request an image transformation of it Here are 3 test images at very slightly different resolutions to test the MP threshold. In my case it accepts the 16.79 MP but not the 16.8 MP. Since 16.8 MP is the default according to imgproxy, it seems clear that this default is not being overridden to the 50MP stated in docs. It isn't set in `docker-compose` ![4731x3549-16 79](https://github.com/supabase/supabase/assets/7676223/41d7d776-84a7-4c02-b6e7-597b344ba0ef) ![4733x3550-16 80](https://github.com/supabase/supabase/assets/7676223/8ae432a2-e7ce-4960-8aec-d946c8313bda) ![4734x3551-16 81](https://github.com/supabase/supabase/assets/7676223/332122f8-273b-4cba-9fde-4fc8d6b1479b) ## Expected behavior Can use image transform on up to 50MP **or, ideally, an easily user-configurable value** in local dev / self hosted settings ## System information - OS: Ubuntu 22.04 on WSL2 on Win11 - Version of supabase-js: 2.39.7 - Version of Node.js: v18.17.1 Container versions: public.ecr.aws/supabase/edge-runtime:v1.33.5 public.ecr.aws/supabase/studio:20240101-8e4a094 public.ecr.aws/supabase/postgres-meta:v0.75.0 public.ecr.aws/supabase/imgproxy:v3.8.0 public.ecr.aws/supabase/storage-api:v0.46.4 public.ecr.aws/supabase/postgrest:v12.0.1 public.ecr.aws/supabase/realtime:v2.25.50 public.ecr.aws/supabase/inbucket:3.0.3 public.ecr.aws/supabase/gotrue:v2.132.3 public.ecr.aws/supabase/kong:2.8.1 public.ecr.aws/supabase/logflare:1.4.0 public.ecr.aws/supabase/postgres:15.1.0.147 public.ecr.aws/supabase/vector:0.28.1-alpine ## Additional context This seems to work fine in hosted Supabase. It seems to only affect local development instances or self-hosted. I've tried uploading an image that is 50.1 MP and it worked OK.</DESCRIPTION>
  <REPONAME>supabase</REPONAME>
  <TIMEDIFFERENCEDAYS>348</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>chore: Regenerate the pnpm lockfile (#35552) Regen lockfile.</MESSAGE>
    <SHA>7bfbe2d5ef4b85202b9ab969de908c5a6bba34be</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Update imgproxy image solves #21645</MESSAGE>
      <SHA>1a609969b1d6553a9272b4ddb123098f8d12891d</SHA>
      <PATCHEDFILES>
        <FILE>docker/docker-compose.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
