<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3428</ISSUENO>
  <ISSUEURL>https://github.com/DSpace/DSpace/issues/3428</ISSUEURL>
  <TITLE>[DS-50] LDAP+Active Directory authentication patch - ID: 2100378</TITLE>
  <DESCRIPTION>&lt;i&gt;Imported from JIRA &lt;a href=&quot;https://jira.lyrasis.org/browse/DS-50&quot;&gt;[DS-50]&lt;/a&gt; created by kipkorir2008&lt;/i&gt; &lt;p&gt;Thanks, Stuart -&lt;/p&gt; &lt;p&gt;I'll submit the patch to the queue.&lt;br/&gt; You can grab a zip file that includes only the&lt;br/&gt; changed files here:&lt;br/&gt; &lt;a href=&quot;http://erwg.lib.auburn.edu/dspace-ldap_20080828.zip&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://erwg.lib.auburn.edu/dspace-ldap_20080828.zip&lt;/a&gt;&lt;/p&gt; &lt;p&gt;The main changes were:&lt;/p&gt; &lt;p&gt;*. Our A.D. setup does not allow anonymous bind,&lt;br/&gt; and also has user info scattered around the LDAP tree.&lt;br/&gt; To bind an arbitrary user, we pass a distinguished name&lt;br/&gt; of:&lt;br/&gt; DOMAIN\USER-ID&lt;br/&gt; rather than some LDAP path like cn=USER&amp;ou=People&amp;dc=...&lt;br/&gt; We detect this case by allowing the admin&lt;br/&gt; to specify&lt;br/&gt; windows_domain:domain-name&lt;br/&gt; (something like that) as the LDAP object-context in dspace.cfg.&lt;/p&gt; &lt;p&gt;*. Since our user info is scattered through an LDAP tree -&lt;br/&gt; I patched the &quot;lookup user info&quot; part of the code&lt;br/&gt; to specify a recursive JNDI search.&lt;br/&gt; Your last patch may have done the same thing.&lt;/p&gt; &lt;p&gt;*. We would like a user that successfully authenticates against A.D.&lt;br/&gt; to automatically be given certain privileges.&lt;br/&gt; I setup the getSpecialGroups function to accept a list of group-ids in&lt;br/&gt; the&lt;br/&gt; &quot;ldap.dspace.autogroup&quot;&lt;br/&gt; dspace.cfg parameter.&lt;/p&gt; &lt;p&gt;*. I wanted to be able to run a standalone test case against the LDAP&lt;br/&gt; authenticate and search code, so I split out the 'DataFromLDAP'&lt;br/&gt; nested class to an external interface, and include a junit test case.&lt;br/&gt; Also added a few lines to pom.xml to help run the test with verbose&lt;br/&gt; logging, etc.&lt;/p&gt; &lt;p&gt;Cheers,&lt;br/&gt; Reuben&lt;/p&gt; &lt;p&gt;&gt;&gt;&gt; Stuart Lewis &lt;sdl@aber.ac.uk&gt; 9/6/2008 7:57 AM &gt;&gt;&gt;&lt;br/&gt; Hi Reuben,&lt;/p&gt; &lt;p&gt;Thanks for getting in touch. I¹ve got that email sitting in my inbox&lt;br/&gt; waiting&lt;br/&gt; for me to get around to replying to it - sorry it has taken a little&lt;br/&gt; while.&lt;/p&gt; &lt;p&gt;What changes have you made to make it work with Active Directory?&lt;/p&gt; &lt;p&gt;It would be great if you could formally submit your patch to the DSpace&lt;br/&gt; patch queue&lt;br/&gt; (&lt;a href=&quot;http://sourceforge.net/tracker/?atid=319984&amp;group_id=19984&amp;func=browse&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://sourceforge.net/tracker/?atid=319984&amp;group_id=19984&amp;func=browse&lt;/a&gt;).&lt;br/&gt; There are a few of us working on a generic LDAP authenticator which will&lt;br/&gt; hopefully work with any AD / LDAP system, so it would be good to see what&lt;br/&gt; changes you¹ve made to see if we can incorporate them too.&lt;/p&gt; &lt;p&gt;Thanks,&lt;/p&gt; &lt;p&gt;Stuart&lt;/p&gt; &lt;p&gt;On 28/08/2008 16:14, &quot;Reuben Pasquini&quot; &lt;rdp0004@auburn.edu&gt; wrote:&lt;/p&gt; &lt;p&gt;&gt; Hello!&lt;br/&gt; &gt;&lt;br/&gt; &gt; I've put together a set of patches to the LDAPAuthentication&lt;br/&gt; &gt; code to get it working against Active Directory at Auburn&lt;br/&gt; &gt; University, support implicit-group member-ids in dspace.cfg,&lt;br/&gt; &gt; and add a JUnit regression test.&lt;br/&gt; &gt; I think the changes are backward compatable and generic,&lt;br/&gt; &gt; but I've only tested the code in my environment.&lt;br/&gt; &gt;&lt;br/&gt; &gt; I hope that we can check this patch into the dspace repository.&lt;br/&gt; &gt; An overview and svn diff follow, and a zip file with&lt;br/&gt; &gt; the modified files is available here:&lt;br/&gt; &gt; &lt;a href=&quot;http://erwg.lib.auburn.edu/dspace-ldap_20080828.zip&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://erwg.lib.auburn.edu/dspace-ldap_20080828.zip&lt;/a&gt;&lt;br/&gt; &gt; Please take a look, and let me know what you think.&lt;br/&gt; &gt;&lt;br/&gt; &gt; Cheers,&lt;br/&gt; &gt; Reuben&lt;br/&gt; &gt;&lt;br/&gt; &gt; -----------------------------------&lt;br/&gt; &gt;&lt;br/&gt; &gt; Changes under dspace-api org.dspace.authentication.&lt;br/&gt; &gt;&lt;br/&gt; &gt; *. Moved the&lt;br/&gt; &gt; LDAPAuthentication.SpeakerToLDAP&lt;br/&gt; &gt; nested class out to its own non-nested interface&lt;br/&gt; &gt; with a DefaultSpeakerToLDAP implementation.&lt;br/&gt; &gt;&lt;br/&gt; &gt; *. Refactored SpeakerToLDAP#ldapAuthenticate(...)&lt;br/&gt; &gt; to return a DataFromLDAP POJO data object&lt;br/&gt; &gt; rather than set object member variables.&lt;br/&gt; &gt;&lt;br/&gt; &gt; *. Implemented SpeakerToLDAPCase JUnit test-case&lt;br/&gt; &gt; and PackageTestSuite classes to support simple&lt;br/&gt; &gt; regression tests against SpeakerToLDAP implementations.&lt;br/&gt; &gt; Modified pom.xml so that&lt;br/&gt; &gt; 'mvn test'&lt;br/&gt; &gt; runs with a verbose log4j setting.&lt;br/&gt; &gt;&lt;br/&gt; &gt; *. Modified the way SpeakToLDAP handles the&lt;br/&gt; &gt; ldap.object_context&lt;br/&gt; &gt; dspace.cfg configuration property so that&lt;br/&gt; &gt; if the ldap.object_context matches&lt;br/&gt; &gt; 'WINDOWS_DOMAIN:DOMAIN_NAME',&lt;br/&gt; &gt; then LDAP attempts to bind with&lt;br/&gt; &gt; 'DOMAIN_NAME\NETID'&lt;br/&gt; &gt; rather than&lt;br/&gt; &gt; 'cn=NETID,ldap.object_context'&lt;br/&gt; &gt; . This change allows us to configure LDAP&lt;br/&gt; &gt; to bind with Active Directory out of the box.&lt;br/&gt; &gt;&lt;br/&gt; &gt; *. Modifed the LDAP search for user-info to take a SearchControls&lt;br/&gt; &gt; parameter that specifies a recursive tree-search under the&lt;br/&gt; &gt; ldap.search_context&lt;br/&gt; &gt; tree for a single user-object result.&lt;br/&gt; &gt; Once again - this allows LDAPAuthenticate to work&lt;br/&gt; &gt; with an Active Directory tree that has user objects&lt;br/&gt; &gt; organized into different folders under a tree.&lt;br/&gt; &gt;&lt;br/&gt; &gt; *. Modified LDAPAuthentication.getSpecialGroups&lt;br/&gt; &gt; to access the&lt;br/&gt; &gt; ldap.dspace.autogroup&lt;br/&gt; &gt; dspace.cfg configuration property&lt;br/&gt; &gt; to get the group-ids that an LDAP-authenticated&lt;br/&gt; &gt; user should be an implicit member of.&lt;br/&gt; &gt; This makes it easy to configure a system where&lt;br/&gt; &gt; every user that can authenticate can also&lt;br/&gt; &gt; submit material to some collections.&lt;br/&gt; &gt;&lt;br/&gt; &gt; *. Changed some of the if/else nesting in&lt;br/&gt; &gt; LDAPAuthentication.authenticate&lt;br/&gt; &gt; so that instead of having something like&lt;br/&gt; &gt; if () &lt;/p&gt; { &gt; ... &gt; return bla; &gt; } else {&lt;br/&gt; &gt; we have&lt;br/&gt; &gt; if () {&gt; ...&gt; return bla;&gt; } &lt;p&gt;&gt; ... // no else&lt;br/&gt; &gt; and instead of&lt;br/&gt; &gt; } else {&lt;br/&gt; &gt; if () &lt;/p&gt; { &gt; return goo &gt; } &lt;p&gt;&gt; }&lt;br/&gt; &gt; we just have&lt;br/&gt; &gt; } else if () {&lt;br/&gt; &gt; just to make the control flow a little&lt;br/&gt; &gt; easier to look at.&lt;br/&gt; &gt;&lt;br/&gt; &gt; ----------------------------------&lt;br/&gt; &gt;&lt;br/&gt; &gt; $ svn diff pom.xml src/test src/main/java/org/dspace/authenticate &gt;&lt;br/&gt; &gt; /tmp/bla&lt;br/&gt; &gt;&lt;br/&gt; &gt; Index: pom.xml&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212; pom.xml (revision 2942)&lt;br/&gt; &gt; +++ pom.xml (working copy)&lt;br/&gt; &gt; @@ -61,6 +61,7 @@&lt;br/&gt; &gt;&lt;br/&gt; &gt;&lt;br/&gt; &lt;url&gt;&lt;a href=&quot;http://dspace.svn.sourceforge.net/viewvc/dspace/branches/dspace-1_5_x/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://dspace.svn.sourceforge.net/viewvc/dspace/branches/dspace-1_5_x/&lt;/a&gt;&lt;br/&gt; dsp&lt;br/&gt; &gt; ace&lt;/url&gt;&lt;br/&gt; &gt; &lt;/scm&gt;&lt;br/&gt; &gt;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; &lt;!--&lt;br/&gt; &gt; Runtime and Compile Time dependencies for DSpace.&lt;br/&gt; &gt; --&gt;&lt;br/&gt; &gt; @@ -188,6 +189,23 @@&lt;br/&gt; &gt; &lt;groupId&gt;com.ibm.icu&lt;/groupId&gt;&lt;br/&gt; &gt; &lt;artifactId&gt;icu4j&lt;/artifactId&gt;&lt;br/&gt; &gt; &lt;/dependency&gt;&lt;br/&gt; &gt; + &lt;dependency&gt;&lt;br/&gt; &gt; + &lt;groupId&gt;junit&lt;/groupId&gt;&lt;br/&gt; &gt; + &lt;artifactId&gt;junit&lt;/artifactId&gt;&lt;br/&gt; &gt; + &lt;version&gt;3.8.1&lt;/version&gt;&lt;br/&gt; &gt; + &lt;scope&gt;test&lt;/scope&gt;&lt;br/&gt; &gt; + &lt;/dependency&gt;&lt;br/&gt; &gt; &lt;/dependencies&gt;&lt;br/&gt; &gt;&lt;br/&gt; &gt; -&lt;/project&gt;&lt;br/&gt; &gt; \ No newline at end of file&lt;br/&gt; &gt; +&lt;build&gt;&lt;br/&gt; &gt; + &lt;testResources&gt;&lt;br/&gt; &gt; + &lt;testResource&gt;&lt;br/&gt; &gt; + &lt;directory&gt;src/test/resources&lt;/directory&gt;&lt;br/&gt; &gt; + &lt;includes&gt;&lt;br/&gt; &gt; + &lt;include&gt;log4j.properties&lt;/include&gt;&lt;br/&gt; &gt; + &lt;/includes&gt;&lt;br/&gt; &gt; + &lt;/testResource&gt;&lt;br/&gt; &gt; + &lt;/testResources&gt;&lt;br/&gt; &gt; + &lt;/build&gt;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +&lt;/project&gt;&lt;br/&gt; &gt; Index: src/test/java/org/dspace/authenticate/SpeakerToLDAPCase.java&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212;&lt;br/&gt; &gt; src/test/java/org/dspace/authenticate/SpeakerToLDAPCase.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; +++&lt;br/&gt; &gt; src/test/java/org/dspace/authenticate/SpeakerToLDAPCase.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; @@ -0,0 +1,56 @@&lt;br/&gt; &gt; +package org.dspace.authenticate;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +import junit.framework.TestCase;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +import org.apache.log4j.Logger;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +/**&lt;br/&gt; &gt; + * Generic test runner for SpeakerToLDAP implementations.&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; +public class SpeakerToLDAPCase extends TestCase {&lt;br/&gt; &gt; + private static final Logger olog = Logger.getLogger(&lt;br/&gt; &gt; SpeakerToLDAPCase.class );&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + private SpeakerToLDAP oldap;&lt;br/&gt; &gt; + private String os_netid;&lt;br/&gt; &gt; + private String os_password;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; + * Inject the test dependencies - initializes test properties&lt;br/&gt; &gt; + *&lt;br/&gt; &gt; + * @param s_name of test - pass to super&lt;br/&gt; &gt; + * @param ldap instance to authenticate agains&lt;br/&gt; &gt; + * @param s_netid user-id to authenticate as&lt;br/&gt; &gt; + * @param s_password for s_netid&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public SpeakerToLDAPCase ( String s_name, SpeakerToLDAP ldap,&lt;br/&gt; &gt; + String s_netid, String s_password&lt;br/&gt; &gt; + ) &lt;/p&gt; { &gt; + super( s_name ); &gt; + oldap = ldap; &gt; + os_netid = s_netid; &gt; + os_password = s_password; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; + * Try to authenticate against the constructor-supplied&lt;br/&gt; &gt; + * (SpeakerToLDAP, s_netid, s_password)&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public void testAuthenticate() {&lt;br/&gt; &gt; + try &lt;/p&gt; { &gt; + DataFromLDAP ldap_info = oldap.ldapAuthenticate( os_netid, &gt; os_password ); &gt; + assertTrue( &quot;Test user logged in ok: &quot; + os_netid, &gt; + null != ldap_info &gt; + ); &gt; + // need e-mail to key into eperson database &gt; + olog.info( &quot;Got e-mail for &quot; + os_netid + &quot;: &quot; + &gt; ldap_info.getEmail () ); &gt; + assertTrue( &quot;Got e-mail info for &quot; + os_netid + &quot; from &gt; ldap&quot;, &gt; + null != ldap_info.getEmail () &gt; + ); &gt; + } &lt;p&gt; catch ( Exception e ) &lt;/p&gt; { &gt; + olog.info( &quot;Failed to authenticate user: &quot; + os_netid, e &gt; ); &gt; + assertTrue( &quot;Failed to authenticate user: &quot; + os_netid + &gt; &quot;, caught: &quot; + e, false ); &gt; + } &lt;p&gt;&gt; + }&lt;br/&gt; &gt; +}&lt;br/&gt; &gt; Index: src/test/java/org/dspace/authenticate/PackageTest.java&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212;&lt;br/&gt; &gt; src/test/java/org/dspace/authenticate/PackageTest.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; +++&lt;br/&gt; &gt; src/test/java/org/dspace/authenticate/PackageTest.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; @@ -0,0 +1,40 @@&lt;br/&gt; &gt; +package org.dspace.authenticate;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +import junit.framework.TestCase;&lt;br/&gt; &gt; +import junit.framework.TestSuite;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +import org.apache.log4j.Logger;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +/**&lt;br/&gt; &gt; + * Specialization of AbstactSpeakerToLDAPTest configured&lt;br/&gt; &gt; + * to run a DefaultSpeakerToLDAPTest through a test.&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; +public class PackageTest extends TestCase {&lt;br/&gt; &gt; + private static final Logger olog = Logger.getLogger(&lt;br/&gt; &gt; PackageTest.class );&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; + * Build up the batch of tests to run for the&lt;br/&gt; &gt; org.dspace.authenticate&lt;br/&gt; &gt; + * package. You'll have to modify the properties injected into&lt;br/&gt; &gt; the&lt;br/&gt; &gt; + * test SpeakerToLDAP to work with your environment&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public static TestSuite suite () &lt;/p&gt; { &gt; + TestSuite suite = new TestSuite( PackageTest.class.getName &gt; () ); &gt; + SpeakerToLDAP ldap = new DefaultSpeakerToLDAP ( &gt; &quot;ldap://ldaps.university.edu&quot;, &gt; + &quot;cn&quot;, &gt; + &gt; &quot;OU=People,OU=AUMain,DC=auburn,DC=edu&quot;, &gt; + &gt; &quot;WINDOWS_DOMAIN:AUBURN&quot;, &gt; + &quot;mail&quot;, &gt; + &quot;givenName&quot;, &gt; + &quot;sn&quot;, &gt; + &gt; &quot;telephoneNumber&quot; &gt; + ); &gt; + suite.addTest ( new SpeakerToLDAPCase( &quot;testAuthenticate&quot;, &gt; ldap, &gt; + &quot;USER&quot;, &quot;PASSWORD&quot; &gt; + ) &gt; + ); &gt; + return suite; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; +}&lt;br/&gt; &gt; Index: src/test/resources/log4j.properties&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212; src/test/resources/log4j.properties (revision 0)&lt;br/&gt; &gt; +++ src/test/resources/log4j.properties (revision 0)&lt;br/&gt; &gt; @@ -0,0 +1,9 @@&lt;br/&gt; &gt; +# Set root logger level to DEBUG and its only appender to A1.&lt;br/&gt; &gt; +log4j.rootLogger=DEBUG, A1&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +# A1 is set to be a ConsoleAppender.&lt;br/&gt; &gt; +log4j.appender.A1=org.apache.log4j.ConsoleAppender&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +# A1 uses PatternLayout.&lt;br/&gt; &gt; +log4j.appender.A1.layout=org.apache.log4j.PatternLayout&lt;br/&gt; &gt; +log4j.appender.A1.layout.ConversionPattern=%-4r &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %-5p %c %x -&lt;br/&gt; &gt; %m%n&lt;br/&gt; &gt; Index: src/main/java/org/dspace/authenticate/LDAPAuthentication.java&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212;&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/LDAPAuthentication.java (revision&lt;br/&gt; &gt; 3054)&lt;br/&gt; &gt; +++&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/LDAPAuthentication.java (working&lt;br/&gt; &gt; copy)&lt;br/&gt; &gt; @@ -40,17 +40,11 @@&lt;br/&gt; &gt; package org.dspace.authenticate;&lt;br/&gt; &gt;&lt;br/&gt; &gt; import java.sql.SQLException;&lt;br/&gt; &gt; +import java.util.ArrayList;&lt;br/&gt; &gt; +import java.util.List;&lt;br/&gt; &gt; import java.util.Hashtable;&lt;br/&gt; &gt;&lt;br/&gt; &gt; -import javax.naming.NamingEnumeration;&lt;br/&gt; &gt; import javax.naming.NamingException;&lt;br/&gt; &gt; -import javax.naming.directory.Attribute;&lt;br/&gt; &gt; -import javax.naming.directory.Attributes;&lt;br/&gt; &gt; -import javax.naming.directory.BasicAttribute;&lt;br/&gt; &gt; -import javax.naming.directory.BasicAttributes;&lt;br/&gt; &gt; -import javax.naming.directory.DirContext;&lt;br/&gt; &gt; -import javax.naming.directory.InitialDirContext;&lt;br/&gt; &gt; -import javax.naming.directory.SearchResult;&lt;br/&gt; &gt; import javax.servlet.http.HttpServletRequest;&lt;br/&gt; &gt; import javax.servlet.http.HttpServletResponse;&lt;br/&gt; &gt;&lt;br/&gt; &gt; @@ -60,6 +54,7 @@&lt;br/&gt; &gt; import org.dspace.core.Context;&lt;br/&gt; &gt; import org.dspace.core.LogManager;&lt;br/&gt; &gt; import org.dspace.eperson.EPerson;&lt;br/&gt; &gt; +import org.dspace.eperson.Group;&lt;br/&gt; &gt;&lt;br/&gt; &gt; /**&lt;br/&gt; &gt; * Authentication module to authenticate against a flat LDAP tree&lt;br/&gt; &gt; where&lt;br/&gt; &gt; @@ -72,9 +67,66 @@&lt;br/&gt; &gt; implements AuthenticationMethod {&lt;br/&gt; &gt;&lt;br/&gt; &gt; /** log4j category */&lt;br/&gt; &gt; - private static Logger log =&lt;br/&gt; &gt; Logger.getLogger(LDAPAuthentication.class);&lt;br/&gt; &gt; + private static final Logger olog =&lt;br/&gt; &gt; Logger.getLogger(LDAPAuthentication.class);&lt;br/&gt; &gt;&lt;br/&gt; &gt; + private final SpeakerToLDAP oldap;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; /**&lt;br/&gt; &gt; + * Constructor injects SpeakerToLDAP dependency&lt;br/&gt; &gt; + *&lt;br/&gt; &gt; + * @param ldap SpeakerToLDAP knows how to authenticate&lt;br/&gt; &gt; + * against and query the LDAP directory&lt;br/&gt; &gt; + * @param b_autoregister set true to auto-register an eperson&lt;br/&gt; &gt; + * for a new user that succesfully authenticates&lt;br/&gt; &gt; + * with LDAP&lt;br/&gt; &gt; + * @param v_special_group ids of user groups that an&lt;br/&gt; &gt; LDAP-authenticated&lt;br/&gt; &gt; + * user should be considered an implicit member of&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public LDAPAuthentication ( SpeakerToLDAP ldap,&lt;br/&gt; &gt; + boolean b_autoregister,&lt;br/&gt; &gt; + int[] v_special_group&lt;br/&gt; &gt; + ) &lt;/p&gt; { &gt; + oldap = ldap; &gt; + ob_autoregister = b_autoregister; &gt; + ov_special_group = v_special_group; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; + * Constructor invoked by dspace.cfg based configuration&lt;br/&gt; &gt; + * engine sets up DefaultSpeakerToLDAP,&lt;br/&gt; &gt; + * checks ldap.autoregister and ldap.dspace.autogroup&lt;br/&gt; &gt; + * configuration values to determine canSelfRegister&lt;br/&gt; &gt; + * and getSpecialGroups property values.&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public LDAPAuthentication () {&lt;br/&gt; &gt; + String s_groups =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.dspace.autogroup&quot;);&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + List&lt;Integer&gt; v_group_id = new ArrayList&lt;Integer&gt;();&lt;br/&gt; &gt; + if ( null != s_groups ) {&lt;br/&gt; &gt; + String[] v_group_name = s_groups.trim ().split(&lt;br/&gt; &gt; &quot;,&lt;br class=&quot;atl-forced-newline&quot; /&gt;s*&quot; );&lt;br/&gt; &gt; + for ( int i=0; i &lt; v_group_name.length; ++i ) {&lt;br/&gt; &gt; + String s_group = v_group_name&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.trim ();&lt;br/&gt; &gt; + if ( s_group.length () &gt; 0 ) {&lt;br/&gt; &gt; + try &lt;/p&gt; { &gt; + v_group_id.add ( Integer.parseInt( s_group ) &gt; ); &gt; + } &lt;p&gt; catch ( Exception e ) &lt;/p&gt; { &gt; + olog.warn( &quot;Exception parsing group &quot; + &gt; s_group, e ); &gt; + } &lt;p&gt;&gt; + }&lt;br/&gt; &gt; + }&lt;br/&gt; &gt; + }&lt;br/&gt; &gt; + oldap = new DefaultSpeakerToLDAP ();&lt;br/&gt; &gt; + ob_autoregister =&lt;br/&gt; &gt; ConfigurationManager.getBooleanProperty(&quot;webui.ldap.autoregister&quot;);&lt;br/&gt; &gt; + ov_special_group = new int[ v_group_id.size () ];&lt;br/&gt; &gt; + int i_count = 0;&lt;br/&gt; &gt; + for ( Integer i_group_id : v_group_id ) &lt;/p&gt; { &gt; + ov_special_group[ i_count ] = i_group_id; &gt; + ++i_count; &gt; + } &lt;p&gt;&gt; + }&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + private final boolean ob_autoregister;&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; * Let a real auth method return true if it wants.&lt;br/&gt; &gt; */&lt;br/&gt; &gt; public boolean canSelfRegister(Context context,&lt;br/&gt; &gt; @@ -83,8 +135,7 @@&lt;br/&gt; &gt; throws SQLException&lt;br/&gt; &gt; &lt;/p&gt; { &gt; // XXX might also want to check that username exists in LDAP. &gt; - &gt; - return &gt; ConfigurationManager.getBooleanProperty(&quot;webui.ldap.autoregister&quot;); &gt; + return ob_autoregister; &gt; } &lt;p&gt;&gt;&lt;br/&gt; &gt; /**&lt;br/&gt; &gt; @@ -118,12 +169,10 @@&lt;br/&gt; &gt; return false;&lt;br/&gt; &gt; }&lt;br/&gt; &gt;&lt;br/&gt; &gt; - /*&lt;br/&gt; &gt; - * Nothing here.&lt;br/&gt; &gt; - */&lt;br/&gt; &gt; + private final int[] ov_special_group;&lt;br/&gt; &gt; public int[] getSpecialGroups(Context context, HttpServletRequest&lt;br/&gt; &gt; request)&lt;br/&gt; &gt; &lt;/p&gt; { &gt; - return new int[0]; &gt; + return ov_special_group; &gt; } &lt;p&gt;&gt;&lt;br/&gt; &gt; /*&lt;br/&gt; &gt; @@ -139,261 +188,140 @@&lt;br/&gt; &gt; HttpServletRequest request)&lt;br/&gt; &gt; throws SQLException&lt;br/&gt; &gt; {&lt;br/&gt; &gt; - log.info(LogManager.getHeader(context, &quot;auth&quot;, &quot;attempting&lt;br/&gt; &gt; trivial auth of user=&quot;+netid));&lt;br/&gt; &gt; + olog.info(LogManager.getHeader(context, &quot;auth&quot;, &quot;attempting&lt;br/&gt; &gt; auth of user=&quot;+netid));&lt;br/&gt; &gt;&lt;br/&gt; &gt; // Skip out when no netid or password is given.&lt;br/&gt; &gt; - if (netid == null || password == null)&lt;br/&gt; &gt; - return BAD_ARGS;&lt;br/&gt; &gt; + if (netid == null || password == null) &lt;/p&gt; { &gt; + return BAD_ARGS; &gt; + } &lt;p&gt;&gt;&lt;br/&gt; &gt; // Locate the eperson&lt;br/&gt; &gt; - EPerson eperson = null;&lt;br/&gt; &gt; + EPerson eperson = null;&lt;br/&gt; &gt; try&lt;br/&gt; &gt; &lt;/p&gt; { &gt; - eperson = EPerson.findByNetid(context, &gt; netid.toLowerCase()); &gt; + eperson = EPerson.findByNetid(context, &gt; netid.toLowerCase()); &gt; } &lt;p&gt;&gt; catch (SQLException e)&lt;br/&gt; &gt; &lt;/p&gt; { &gt; } &lt;p&gt;&gt; - boolean loggedIn = false;&lt;br/&gt; &gt; - SpeakerToLDAP ldap = new SpeakerToLDAP(log);&lt;br/&gt; &gt;&lt;br/&gt; &gt; + olog.debug( &quot;Found eperson for &quot; + netid );&lt;br/&gt; &gt; +&lt;br/&gt; &gt; // if they entered a netid that matches an eperson&lt;br/&gt; &gt; if (eperson != null)&lt;br/&gt; &gt; {&lt;br/&gt; &gt; // e-mail address corresponds to active account&lt;br/&gt; &gt; - if (eperson.getRequireCertificate())&lt;br/&gt; &gt; + if (eperson.getRequireCertificate()) &lt;/p&gt; { &gt; return CERT_REQUIRED; &gt; - else if (!eperson.canLogIn()) &gt; + } &lt;p&gt; else if (!eperson.canLogIn()) {&lt;br/&gt; &gt; return BAD_ARGS;&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - if (ldap.ldapAuthenticate(netid, password, context))&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; + } &lt;p&gt;&gt; + try {&lt;br/&gt; &gt; + // authenticate&lt;br/&gt; &gt; + olog.debug( &quot;Attempting LDAP auth-1 for &quot; + netid );&lt;br/&gt; &gt; + DataFromLDAP ldap_info = oldap.ldapAuthenticate(&lt;br/&gt; &gt; netid, password );&lt;br/&gt; &gt; + if ( null != ldap_info ) &lt;/p&gt; { &gt; context.setCurrentUser(eperson = &gt; EPerson.findByNetid(context, netid.toLowerCase())); &gt; - log.info(LogManager &gt; - .getHeader(context, &quot;authenticate&quot;, &gt; &quot;type=ldap&quot;)); &gt; + olog.info(LogManager &gt; + .getHeader(context, &quot;authenticate&quot;, &gt; &quot;type=ldap&quot;)); &gt; return SUCCESS; &gt; - } &lt;p&gt;&gt; - else&lt;br/&gt; &gt; - return BAD_CREDENTIALS;&lt;br/&gt; &gt; + }&lt;br/&gt; &gt; + } catch ( NamingException e ) &lt;/p&gt; { &gt; + olog.warn( &quot;Failed to authenticate user: &quot; + netid, e &gt; ); &gt; } &lt;p&gt;&gt; + //else &lt;/p&gt; { &gt; + return BAD_CREDENTIALS; &gt; + } &lt;p&gt;&gt; + // eperson == null&lt;br/&gt; &gt; + if ( null != eperson ) &lt;/p&gt; { &gt; + throw new AssertionError( &quot;eperson should be null here!&quot; &gt; ); &gt; } &lt;p&gt;&gt; -&lt;br/&gt; &gt; - // the user does not already exist so try and authenticate&lt;br/&gt; &gt; them&lt;br/&gt; &gt; - // with ldap and create an eperson for them&lt;br/&gt; &gt; - else&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - if (ldap.ldapAuthenticate(netid, password, context))&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - // Register the new user automatically&lt;br/&gt; &gt; - log.info(LogManager.getHeader(context,&lt;br/&gt; &gt; - &quot;autoregister&quot;, &quot;netid=&quot; + netid));&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - if&lt;br/&gt; &gt; ((ldap.ldapEmail!=null)&amp;&amp;(!ldap.ldapEmail.equals(&quot;&quot;)))&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - try&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - eperson = EPerson.findByEmail(context,&lt;br/&gt; &gt; ldap.ldapEmail);&lt;br/&gt; &gt; - if (eperson!=null)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - log.info(LogManager.getHeader(context, &gt; - &quot;type=ldap-login&quot;, &gt; &quot;type=ldap_but_already_email&quot;)); &gt; - context.setIgnoreAuthorization(true); &gt; - eperson.setNetid(netid); &gt; - eperson.update(); &gt; - context.commit(); &gt; - context.setIgnoreAuthorization(false); &gt; - context.setCurrentUser(eperson); &gt; - return SUCCESS; &gt; - } &lt;p&gt;&gt; - else&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - if (canSelfRegister(context, request,&lt;br/&gt; &gt; netid))&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - // TEMPORARILY turn off&lt;br/&gt; &gt; authorisation&lt;br/&gt; &gt; - try&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - &gt; context.setIgnoreAuthorization(true); &gt; - eperson = &gt; EPerson.create(context); &gt; - if &gt; ((ldap.ldapEmail!=null)&amp;&amp;(!ldap.ldapEmail.equals(&quot;&quot;))) &gt; eperson.setEmail(ldap.ldapEmail); &gt; - else eperson.setEmail(netid); &gt; - if &gt; ((ldap.ldapGivenName!=null)&amp;&amp;(!ldap.ldapGivenName.equals(&quot;&quot;))) &gt; eperson.setFirstName(ldap.ldapGivenName); &gt; - if &gt; ((ldap.ldapSurname!=null)&amp;&amp;(!ldap.ldapSurname.equals(&quot;&quot;))) &gt; eperson.setLastName(ldap.ldapSurname); &gt; - if &gt; ((ldap.ldapPhone!=null)&amp;&amp;(!ldap.ldapPhone.equals(&quot;&quot;))) &gt; eperson.setMetadata(&quot;phone&quot;, ldap.ldapPhone); &gt; - eperson.setNetid(netid); &gt; - eperson.setCanLogIn(true); &gt; - &gt; AuthenticationManager.initEPerson(context, request, eperson); &gt; - eperson.update(); &gt; - context.commit(); &gt; - context.setCurrentUser(eperson); &gt; - } &lt;p&gt;&gt; - catch (AuthorizeException e)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - return NO_SUCH_USER; &gt; - } &lt;p&gt;&gt; - finally&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - &gt; context.setIgnoreAuthorization(false); &gt; - } &lt;p&gt;&gt; -&lt;br/&gt; &gt; -&lt;br/&gt; &gt; log.info(LogManager.getHeader(context, &quot;authenticate&quot;,&lt;br/&gt; &gt; - &quot;type=ldap-login,&lt;br/&gt; &gt; created ePerson&quot;));&lt;br/&gt; &gt; - return SUCCESS;&lt;br/&gt; &gt; - }&lt;br/&gt; &gt; - else&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - // No auto-registration for valid &gt; certs &gt; - &gt; log.info(LogManager.getHeader(context, &gt; - &quot;failed_login&quot;, &gt; &quot;type=ldap_but_no_record&quot;)); &gt; - return NO_SUCH_USER; &gt; - } &lt;p&gt;&gt; - }&lt;br/&gt; &gt; - }&lt;br/&gt; &gt; - catch (AuthorizeException e)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - eperson = null; &gt; - } &lt;p&gt;&gt; - finally&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - context.setIgnoreAuthorization(false); &gt; - } &lt;p&gt;&gt; - }&lt;br/&gt; &gt; - }&lt;br/&gt; &gt; + olog.debug( &quot;Attempting LDAP auth-2 for &quot; + netid );&lt;br/&gt; &gt; + DataFromLDAP ldap_info = null;&lt;br/&gt; &gt; + try &lt;/p&gt; { &gt; + ldap_info = oldap.ldapAuthenticate( netid, password ); &gt; + } &lt;p&gt; catch ( NamingException e ) &lt;/p&gt; { &gt; + olog.warn( &quot;Failed to authenticate user: &quot; + netid, e ); &gt; } &lt;p&gt;&gt; - return BAD_ARGS;&lt;br/&gt; &gt; - }&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - /**&lt;br/&gt; &gt; - * Internal class to manage LDAP query and results, mainly&lt;br/&gt; &gt; - * because there are multiple values to return.&lt;br/&gt; &gt; - */&lt;br/&gt; &gt; - public class SpeakerToLDAP {&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - private Logger log = null;&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - /** ldap email result */&lt;br/&gt; &gt; - protected String ldapEmail = null;&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - /** ldap name result */&lt;br/&gt; &gt; - protected String ldapGivenName = null;&lt;br/&gt; &gt; - protected String ldapSurname = null;&lt;br/&gt; &gt; - protected String ldapPhone = null;&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - SpeakerToLDAP(Logger thelog)&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - log = thelog;&lt;br/&gt; &gt; + if ( (null == ldap_info)&lt;br/&gt; &gt; + || (ldap_info.getEmail()==null)&lt;br/&gt; &gt; + || ldap_info.getEmail().equals(&quot;&quot;)&lt;br/&gt; &gt; + ) &lt;/p&gt; { &gt; + return BAD_ARGS; // failed to authenticate or get e-mail &gt; address &gt; } &lt;p&gt;&gt;&lt;br/&gt; &gt; - /**&lt;br/&gt; &gt; - * contact the ldap server and attempt to authenticate&lt;br/&gt; &gt; - */&lt;br/&gt; &gt; - protected boolean ldapAuthenticate(String netid, String&lt;br/&gt; &gt; password, Context context)&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - if (!password.equals(&quot;&quot;))&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - String ldap_provider_url =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.provider_url&quot;);&lt;br/&gt; &gt; - String ldap_id_field =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.id_field&quot;);&lt;br/&gt; &gt; - String ldap_search_context =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.search_context&quot;);&lt;br/&gt; &gt; - String ldap_object_context =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.object_context&quot;);&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - // Set up environment for creating initial context&lt;br/&gt; &gt; - Hashtable env = new Hashtable(11);&lt;br/&gt; &gt; - env.put(javax.naming.Context.INITIAL_CONTEXT_FACTORY,&lt;br/&gt; &gt; &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);&lt;br/&gt; &gt; - env.put(javax.naming.Context.PROVIDER_URL,&lt;br/&gt; &gt; ldap_provider_url);&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - // Authenticate&lt;br/&gt; &gt; - env.put(javax.naming.Context.SECURITY_AUTHENTICATION,&lt;br/&gt; &gt; &quot;simple&quot;);&lt;br/&gt; &gt; - env.put(javax.naming.Context.SECURITY_PRINCIPAL,&lt;br/&gt; &gt; ldap_id_field+&quot;=&quot;&lt;ins&gt;netid&lt;/ins&gt;&quot;,&quot;+ldap_object_context);&lt;br/&gt; &gt; - env.put(javax.naming.Context.SECURITY_CREDENTIALS,&lt;br/&gt; &gt; password);&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - DirContext ctx = null;&lt;br/&gt; &gt; - try&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - // Create initial context&lt;br/&gt; &gt; - ctx = new InitialDirContext(env);&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - String ldap_email_field =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.email_field&quot;);&lt;br/&gt; &gt; - String ldap_givenname_field =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.givenname_field&quot;);&lt;br/&gt; &gt; - String ldap_surname_field =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.surname_field&quot;);&lt;br/&gt; &gt; - String ldap_phone_field =&lt;br/&gt; &gt; ConfigurationManager.getProperty(&quot;ldap.phone_field&quot;);&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - Attributes matchAttrs = new&lt;br/&gt; &gt; BasicAttributes(true);&lt;br/&gt; &gt; - matchAttrs.put(new BasicAttribute(ldap_id_field,&lt;br/&gt; &gt; netid));&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - String attlist[] = &lt;/p&gt; {ldap_email_field, &gt; ldap_givenname_field, ldap_surname_field, ldap_phone_field} &lt;p&gt;;&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - // look up attributes&lt;br/&gt; &gt; - try&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - NamingEnumeration answer =&lt;br/&gt; &gt; ctx.search(ldap_search_context, matchAttrs, attlist);&lt;br/&gt; &gt; - while(answer.hasMore()) {&lt;br/&gt; &gt; - SearchResult sr =&lt;br/&gt; &gt; (SearchResult)answer.next();&lt;br/&gt; &gt; - Attributes atts = sr.getAttributes();&lt;br/&gt; &gt; - Attribute att;&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - if (attlist&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;!=null)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - att = atts.get(attlist[0]); &gt; - if (att != null) ldapEmail = &gt; (String)att.get(); &gt; - } &lt;p&gt;&gt; -&lt;br/&gt; &gt; - if (attlist&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;!=null)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - att = atts.get(attlist[1]); &gt; - if (att != null) ldapGivenName = &gt; (String)att.get(); &gt; - } &lt;p&gt;&gt; -&lt;br/&gt; &gt; - if (attlist&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;!=null)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - att = atts.get(attlist[2]); &gt; - if (att != null) ldapSurname = &gt; (String)att.get(); &gt; - } &lt;p&gt;&gt; -&lt;br/&gt; &gt; - if (attlist&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;!=null)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - att = atts.get(attlist[3]); &gt; - if (att != null) ldapPhone = &gt; (String)att.get(); &gt; - } &lt;p&gt;&gt; - }&lt;br/&gt; &gt; + //&lt;br/&gt; &gt; + // autoregister the ldap-authenticated user&lt;br/&gt; &gt; + //&lt;br/&gt; &gt; + olog.info(LogManager.getHeader(context,&lt;br/&gt; &gt; + &quot;autoregister&quot;, &quot;netid=&quot; +&lt;br/&gt; &gt; netid)&lt;br/&gt; &gt; + );&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + try {&lt;br/&gt; &gt; + eperson = EPerson.findByEmail(context,&lt;br/&gt; &gt; ldap_info.getEmail());&lt;br/&gt; &gt; + if (eperson!=null) &lt;/p&gt; { &gt; + // Just need to set the netid on the eperson record &gt; + olog.info(LogManager.getHeader(context, &gt; + &quot;type=ldap-login&quot;, &gt; &quot;type=ldap_but_already_email&quot;)); &gt; + context.setIgnoreAuthorization(true); &gt; + eperson.setNetid(netid); &gt; + eperson.update(); &gt; + context.commit(); &gt; + context.setIgnoreAuthorization(false); &gt; + context.setCurrentUser(eperson); &gt; + return SUCCESS; &gt; + } &lt;p&gt; else if (canSelfRegister(context, request, netid)) {&lt;br/&gt; &gt; + // TEMPORARILY turn off authorisation&lt;br/&gt; &gt; + try {&lt;br/&gt; &gt; + context.setIgnoreAuthorization(true);&lt;br/&gt; &gt; + eperson = EPerson.create(context);&lt;br/&gt; &gt; + eperson.setEmail(ldap_info.getEmail());&lt;br/&gt; &gt; + if ((ldap_info.getGivenName()!=null)&lt;br/&gt; &gt; + &amp;&amp;(!ldap_info.getGivenName().equals(&quot;&quot;))&lt;br/&gt; &gt; + ) &lt;/p&gt; { &gt; + &gt; eperson.setFirstName(ldap_info.getGivenName()); &gt; } &lt;p&gt;&gt; - catch (NamingException e)&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - // if the lookup fails go ahead and create a&lt;br/&gt; &gt; new record for them because the authentication&lt;br/&gt; &gt; - // succeeded&lt;br/&gt; &gt; - log.warn(LogManager.getHeader(context,&lt;br/&gt; &gt; - &quot;ldap_attribute_lookup&quot;,&lt;br/&gt; &gt; &quot;type=failed_search &quot;+e));&lt;br/&gt; &gt; - return true;&lt;br/&gt; &gt; + if ((ldap_info.getSurname()!=null)&lt;br/&gt; &gt; + &amp;&amp;(!ldap_info.getSurname().equals(&quot;&quot;))&lt;br/&gt; &gt; + ) &lt;/p&gt; { &gt; + eperson.setLastName(ldap_info.getSurname()); &gt; } &lt;p&gt;&gt; - }&lt;br/&gt; &gt; - catch (NamingException e)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - log.warn(LogManager.getHeader(context, &gt; - &quot;ldap_authentication&quot;, &gt; &quot;type=failed_auth &quot;+e)); &gt; - return false; &gt; - } &lt;p&gt;&gt; - finally&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - // Close the context when we're done&lt;br/&gt; &gt; - try&lt;br/&gt; &gt; - {&lt;br/&gt; &gt; - if (ctx != null)&lt;br/&gt; &gt; - ctx.close();&lt;br/&gt; &gt; + if ((ldap_info.getPhone()!=null)&lt;br/&gt; &gt; + &amp;&amp;(!ldap_info.getPhone().equals(&quot;&quot;))&lt;br/&gt; &gt; + ) &lt;/p&gt; { &gt; + eperson.setMetadata(&quot;phone&quot;, &gt; ldap_info.getPhone()); &gt; } &lt;p&gt;&gt; - catch (NamingException e)&lt;br/&gt; &gt; - &lt;/p&gt; { &gt; - } &lt;p&gt;&gt; + eperson.setNetid(ldap_info.getNetId());&lt;br/&gt; &gt; + eperson.setCanLogIn(true);&lt;br/&gt; &gt; + AuthenticationManager.initEPerson(context,&lt;br/&gt; &gt; request, eperson);&lt;br/&gt; &gt; + eperson.update();&lt;br/&gt; &gt; + context.commit();&lt;br/&gt; &gt; + context.setCurrentUser(eperson);&lt;br/&gt; &gt; + } catch (AuthorizeException e) &lt;/p&gt; { &gt; + return NO_SUCH_USER; &gt; + } &lt;p&gt; finally &lt;/p&gt; { &gt; + context.setIgnoreAuthorization(false); &gt; }&lt;br/&gt; &gt; + olog.info(LogManager.getHeader(context,&lt;br/&gt; &gt; &quot;authenticate&quot;,&lt;br/&gt; &gt; + &quot;type=ldap-login,&lt;br/&gt; &gt; created ePerson&quot;));&lt;br/&gt; &gt; + return SUCCESS;&lt;br/&gt; &gt; + } else { &gt; + // No auto-registration for valid certs &gt; + olog.info(LogManager.getHeader(context, &gt; + &quot;failed_login&quot;, &gt; &quot;type=ldap_but_no_record&quot;)); &gt; + return NO_SUCH_USER; &gt; }&lt;br/&gt; &gt; - else&lt;br/&gt; &gt; - { &gt; - return false; &gt; - }&lt;br/&gt; &gt; -&lt;br/&gt; &gt; - return true;&lt;br/&gt; &gt; + } catch (AuthorizeException e) { &gt; + eperson = null; &gt; + // authentication failed &gt; + return BAD_ARGS; &gt; + } finally {&gt; + context.setIgnoreAuthorization(false);&gt; } &lt;p&gt;&gt; -&lt;br/&gt; &gt; -&lt;br/&gt; &gt; + // Unreachable!&lt;br/&gt; &gt; }&lt;br/&gt; &gt;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; /*&lt;br/&gt; &gt; * Returns URL to which to redirect to obtain credentials (either&lt;br/&gt; &gt; password&lt;br/&gt; &gt; * prompt or e.g. HTTPS port for client cert.); null means no&lt;br/&gt; &gt; redirect.&lt;br/&gt; &gt; @@ -430,4 +358,4 @@&lt;br/&gt; &gt; &lt;/p&gt; { &gt; return &quot;org.dspace.eperson.LDAPAuthentication.title&quot;; &gt; } &lt;p&gt;&gt; -}&lt;br/&gt; &gt; \ No newline at end of file&lt;br/&gt; &gt; +}&lt;br/&gt; &gt; Index: src/main/java/org/dspace/authenticate/DefaultSpeakerToLDAP.java&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212;&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/DefaultSpeakerToLDAP.java&lt;br/&gt; (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; +++&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/DefaultSpeakerToLDAP.java&lt;br/&gt; (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; @@ -0,0 +1,183 @@&lt;br/&gt; &gt; +package org.dspace.authenticate;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +import java.util.Hashtable;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +import javax.naming.NamingEnumeration;&lt;br/&gt; &gt; +import javax.naming.NamingException;&lt;br/&gt; &gt; +import javax.naming.directory.Attribute;&lt;br/&gt; &gt; +import javax.naming.directory.Attributes;&lt;br/&gt; &gt; +import javax.naming.directory.BasicAttribute;&lt;br/&gt; &gt; +import javax.naming.directory.BasicAttributes;&lt;br/&gt; &gt; +import javax.naming.directory.DirContext;&lt;br/&gt; &gt; +import javax.naming.directory.InitialDirContext;&lt;br/&gt; &gt; +import javax.naming.directory.SearchControls;&lt;br/&gt; &gt; +import javax.naming.directory.SearchResult;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +import org.apache.log4j.Logger;&lt;br/&gt; &gt; +import org.dspace.core.ConfigurationManager;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +/**&lt;br/&gt; &gt; + * Internal class to manage LDAP query and results, mainly&lt;br/&gt; &gt; + * because there are multiple values to return.&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; +public class DefaultSpeakerToLDAP implements SpeakerToLDAP {&lt;br/&gt; &gt; + private static final Logger olog =&lt;br/&gt; &gt; Logger.getLogger(DefaultSpeakerToLDAP.class);&lt;br/&gt; &gt; + private final String os_provider_url;&lt;br/&gt; &gt; + private final String os_id_field;&lt;br/&gt; &gt; + private final String os_search_context;&lt;br/&gt; &gt; + private final String os_object_context;&lt;br/&gt; &gt; + private final String os_email_field;&lt;br/&gt; &gt; + private final String os_givenname_field;&lt;br/&gt; &gt; + private final String os_surname_field;&lt;br/&gt; &gt; + private final String os_phone_field;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; + * Constructor allows injection of&lt;br/&gt; &gt; + * configuration parameters.&lt;br/&gt; &gt; + *&lt;br/&gt; &gt; + * @param s_provider_url to the server - we assume simple&lt;br/&gt; &gt; authentication&lt;br/&gt; &gt; + * @param s_id_field attribute of user object - usually cn&lt;br/&gt; &gt; + * @param s_search_context subtree under which to search for user&lt;br/&gt; &gt; info,&lt;br/&gt; &gt; + * ex: ou=People,dc=myschool,dc=edu&lt;br/&gt; &gt; + * @param s_object_context of user bind-path -&lt;br/&gt; &gt; + * ex: ou=People,dc=myschool,dc=edu leads to bind attempt&lt;br/&gt; &gt; + * againt cn=username,ou=People,dc=myschool,dc=edu&lt;br/&gt; &gt; + * @param s_email_field in user record&lt;br/&gt; &gt; + * @param s_givenname_field in user record&lt;br/&gt; &gt; + * @param s_surname_field in user record, usually sn&lt;br/&gt; &gt; + * @param s_phone_field in user record&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public DefaultSpeakerToLDAP( String s_provider_url,&lt;br/&gt; &gt; + String s_id_field,&lt;br/&gt; &gt; + String s_search_context,&lt;br/&gt; &gt; + String s_object_context,&lt;br/&gt; &gt; + String s_email_field,&lt;br/&gt; &gt; + String s_givenname_field,&lt;br/&gt; &gt; + String s_surname_field,&lt;br/&gt; &gt; + String s_phone_field&lt;br/&gt; &gt; + )&lt;br/&gt; &gt; + &lt;/p&gt; { &gt; + os_provider_url = s_provider_url; &gt; + os_id_field = s_id_field; &gt; + os_search_context = s_search_context; &gt; + os_object_context = s_object_context; &gt; + os_email_field = s_email_field; &gt; + os_givenname_field = s_givenname_field; &gt; + os_surname_field = s_surname_field; &gt; + os_phone_field = s_phone_field; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; + * Default constructor extracts LDAP-server parameters&lt;br/&gt; &gt; + * from ConfigurationManager (dspace.cfg):&lt;br/&gt; &gt; + * ldap.provider_url, ldap_id_field,&lt;br/&gt; &gt; + * ldap_search_contect, ldap_object_context&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public DefaultSpeakerToLDAP() &lt;/p&gt; { &gt; + os_provider_url = &gt; ConfigurationManager.getProperty(&quot;ldap.provider_url&quot;); &gt; + os_id_field = &gt; ConfigurationManager.getProperty(&quot;ldap.id_field&quot;); &gt; + os_search_context = &gt; ConfigurationManager.getProperty(&quot;ldap.search_context&quot;); &gt; + os_object_context = &gt; ConfigurationManager.getProperty(&quot;ldap.object_context&quot;); &gt; + os_email_field = &gt; ConfigurationManager.getProperty(&quot;ldap.email_field&quot;); &gt; + os_givenname_field = &gt; ConfigurationManager.getProperty(&quot;ldap.givenname_field&quot;); &gt; + os_surname_field = &gt; ConfigurationManager.getProperty(&quot;ldap.surname_field&quot;); &gt; + os_phone_field = &gt; ConfigurationManager.getProperty(&quot;ldap.phone_field&quot;); &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; + * contact the ldap server and attempt to authenticate&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public DataFromLDAP ldapAuthenticate(String s_netid, String&lt;br/&gt; &gt; s_password ) throws NamingException&lt;br/&gt; &gt; + {&lt;br/&gt; &gt; + if (s_password.equals(&quot;&quot;))&lt;br/&gt; &gt; + &lt;/p&gt; { &gt; + return null; &gt; + } &lt;p&gt;&gt; + // Set up environment for creating initial context&lt;br/&gt; &gt; + Hashtable env = new Hashtable(11);&lt;br/&gt; &gt; + env.put(javax.naming.Context.INITIAL_CONTEXT_FACTORY,&lt;br/&gt; &gt; &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);&lt;br/&gt; &gt; + env.put(javax.naming.Context.PROVIDER_URL, os_provider_url);&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + // Authenticate&lt;br/&gt; &gt; + env.put(javax.naming.Context.SECURITY_AUTHENTICATION,&lt;br/&gt; &gt; &quot;simple&quot;);&lt;br/&gt; &gt; + final String s_ad_key = &quot;WINDOWS_DOMAIN:&quot;;&lt;br/&gt; &gt; + if ( os_object_context.toUpperCase ().startsWith( s_ad_key ) )&lt;br/&gt; &gt; &lt;/p&gt; { &gt; + // Active Directory bind &gt; + String s_principal = os_object_context.substring( &gt; s_ad_key.length () ) + &quot;\\&quot; + s_netid; &gt; + olog.debug( &quot;Binding principal to: &quot; + s_principal ); &gt; + env.put(javax.naming.Context.SECURITY_PRINCIPAL, &gt; s_principal ); &gt; + } &lt;p&gt; else &lt;/p&gt; { &gt; + env.put(javax.naming.Context.SECURITY_PRINCIPAL, &gt; os_id_field+&quot;=&quot;+s_netid+&quot;,&quot;+os_object_context); &gt; + } &lt;p&gt;&gt; + env.put(javax.naming.Context.SECURITY_CREDENTIALS,&lt;br/&gt; &gt; s_password);&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + DirContext ctx = new InitialDirContext(env);&lt;br/&gt; &gt; + try {&lt;br/&gt; &gt; + Attributes search_attributes = new BasicAttributes(true);&lt;br/&gt; &gt; + search_attributes.put(new BasicAttribute(os_id_field,&lt;br/&gt; &gt; s_netid));&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + String[] v_result_atts = &lt;/p&gt; {os_email_field, &gt; os_givenname_field, os_surname_field, os_phone_field} &lt;p&gt;;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + olog.debug( &quot;Searching LDAP for &quot; + os_id_field + &quot;=&quot; +&lt;br/&gt; &gt; s_netid&lt;br/&gt; &gt; + + &quot; under &quot; + os_search_context&lt;br/&gt; &gt; + );&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + NamingEnumeration answer = ctx.search(os_search_context,&lt;br/&gt; &gt; + &quot;(&quot; + os_id_field +&lt;br/&gt; &gt; &quot;=&quot; + s_netid + &quot;)&quot;,&lt;br/&gt; &gt; + new SearchControls(&lt;br/&gt; &gt; SearchControls.SUBTREE_SCOPE,&lt;br/&gt; &gt; +&lt;br/&gt; &gt; 1, 20000,&lt;br/&gt; &gt; +&lt;br/&gt; &gt; v_result_atts,&lt;br/&gt; &gt; +&lt;br/&gt; &gt; false, false&lt;br/&gt; &gt; +&lt;br/&gt; &gt; )&lt;br/&gt; &gt; + );&lt;br/&gt; &gt; + if( ! answer.hasMore()) &lt;/p&gt; { &gt; + olog.info( &quot;Able to bind as &quot; + s_netid + &quot;, but &gt; unable to find LDAP record&quot; ); &gt; + return null; &gt; + } &lt;p&gt;&gt; + // look up attributes&lt;br/&gt; &gt; + String ldapEmail = null;&lt;br/&gt; &gt; + String ldapGivenName = null;&lt;br/&gt; &gt; + String ldapSurname = null;&lt;br/&gt; &gt; + String ldapPhone = null;&lt;br/&gt; &gt; + SearchResult sr = (SearchResult)answer.next();&lt;br/&gt; &gt; + Attributes atts = sr.getAttributes();&lt;br/&gt; &gt; + Attribute att;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + if (v_result_atts&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;!=null) &lt;/p&gt; { &gt; + att = atts.get(v_result_atts[0]); &gt; + if (att != null) ldapEmail = (String)att.get(); &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + if (v_result_atts&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;!=null) {&lt;br/&gt; &gt; + att = atts.get(v_result_atts&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt; &gt; + if (att != null) &lt;/p&gt; { &gt; + ldapGivenName = (String)att.get(); &gt; + } &lt;p&gt;&gt; + }&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + if (v_result_atts&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;!=null) {&lt;br/&gt; &gt; + att = atts.get(v_result_atts&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;);&lt;br/&gt; &gt; + if (att != null) &lt;/p&gt; { &gt; + ldapSurname = (String)att.get(); &gt; + } &lt;p&gt;&gt; + }&lt;br/&gt; &gt; +&lt;br/&gt; &gt; + if (v_result_atts&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;!=null) {&lt;br/&gt; &gt; + att = atts.get(v_result_atts&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;);&lt;br/&gt; &gt; + if (att != null) &lt;/p&gt; { &gt; + ldapPhone = (String)att.get(); &gt; + } &lt;p&gt;&gt; + }&lt;br/&gt; &gt; + return new SimpleDataFromLDAP( ldapEmail, ldapGivenName,&lt;br/&gt; &gt; ldapSurname, ldapPhone, s_netid );&lt;br/&gt; &gt; + } finally {&lt;br/&gt; &gt; + // Close the context when we're done&lt;br/&gt; &gt; + try {&lt;br/&gt; &gt; + if (ctx != null) &lt;/p&gt; { &gt; + ctx.close(); &gt; + } &lt;p&gt;&gt; + } catch (NamingException e) { }&lt;br/&gt; &gt; + }&lt;br/&gt; &gt; + // Unreachable&lt;br/&gt; &gt; + }&lt;br/&gt; &gt; +}&lt;br/&gt; &gt; Index: src/main/java/org/dspace/authenticate/SimpleDataFromLDAP.java&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212;&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/SimpleDataFromLDAP.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; +++&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/SimpleDataFromLDAP.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; @@ -0,0 +1,48 @@&lt;br/&gt; &gt; +package org.dspace.authenticate;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +/**&lt;br/&gt; &gt; + * Simple implementation of DataFromLDAP&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; +public class SimpleDataFromLDAP implements DataFromLDAP {&lt;br/&gt; &gt; + /**&lt;br/&gt; &gt; + * Constructor injects all the property values&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; + public SimpleDataFromLDAP ( String s_email,&lt;br/&gt; &gt; + String s_given_name,&lt;br/&gt; &gt; + String s_surname,&lt;br/&gt; &gt; + String s_phone,&lt;br/&gt; &gt; + String s_netid&lt;br/&gt; &gt; + ) &lt;/p&gt; { &gt; + os_email = s_email; &gt; + os_given_name = s_given_name; &gt; + os_surname = s_surname; &gt; + os_phone = s_phone; &gt; + os_netid = s_netid; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + private final String os_email;&lt;br/&gt; &gt; + public String getEmail () &lt;/p&gt; { &gt; + return os_email; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + private final String os_given_name;&lt;br/&gt; &gt; + public String getGivenName () &lt;/p&gt; { &gt; + return os_given_name; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + private final String os_surname;&lt;br/&gt; &gt; + public String getSurname() &lt;/p&gt; { &gt; + return os_surname; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + private final String os_phone;&lt;br/&gt; &gt; + public String getPhone () &lt;/p&gt; { &gt; + return os_phone; &gt; + } &lt;p&gt;&gt; +&lt;br/&gt; &gt; + private final String os_netid;&lt;br/&gt; &gt; + public String getNetId () &lt;/p&gt; { &gt; + return os_netid; &gt; + } &lt;p&gt;&gt; +}&lt;br/&gt; &gt; Index: src/main/java/org/dspace/authenticate/SpeakerToLDAP.java&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212;&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/SpeakerToLDAP.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; +++&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/SpeakerToLDAP.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; @@ -0,0 +1,20 @@&lt;br/&gt; &gt; +package org.dspace.authenticate;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +import javax.naming.NamingException;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +/**&lt;br/&gt; &gt; + * Interface for LDAP interaction handler&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; +public interface SpeakerToLDAP &lt;/p&gt; { &gt; + /** &gt; + * Authenticate the given user with LDAP, &gt; + * and get some data about him/her from the directory. &gt; + * &gt; + * @param s_netid cn of the user to authenticate &gt; + * @param s_password &gt; + * @return user info &gt; + */ &gt; + public DataFromLDAP ldapAuthenticate( String s_netid, &gt; + String s_password &gt; + ) throws NamingException; &gt; +} &lt;p&gt;&gt; Index: src/main/java/org/dspace/authenticate/DataFromLDAP.java&lt;br/&gt; &gt; ===================================================================&lt;br/&gt; &gt; &amp;#8212;&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/DataFromLDAP.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; +++&lt;br/&gt; &gt; src/main/java/org/dspace/authenticate/DataFromLDAP.java (revision&lt;br/&gt; &gt; 0)&lt;br/&gt; &gt; @@ -0,0 +1,15 @@&lt;br/&gt; &gt; +package org.dspace.authenticate;&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +&lt;br/&gt; &gt; +/**&lt;br/&gt; &gt; + * POJO data bucket interface for user-data obtained during&lt;br/&gt; &gt; + * LDAP authentication&lt;br/&gt; &gt; + */&lt;br/&gt; &gt; +public interface DataFromLDAP &lt;/p&gt; { &gt; + public String getEmail (); &gt; + public String getGivenName (); &gt; + public String getSurname(); &gt; + public String getPhone (); &gt; + /** LDAP common name (cn) for the user */ &gt; + public String getNetId (); &gt; +} &lt;p&gt;&gt;&lt;br/&gt; &gt;&lt;br/&gt; &gt;&lt;br/&gt; &gt; &lt;/p&gt;</DESCRIPTION>
  <REPONAME>DSpace</REPONAME>
  <TIMEDIFFERENCEDAYS>198</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merged in test/glam7/GLAM-926 (pull request #3418) Test/glam7/GLAM-926 Approved-by: Vincenzo Mecca</MESSAGE>
    <SHA>55a895b011ba091d3fc271f5a90e45c832bf77eb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merged in task/glam7/GLAM-987 (pull request #3428) [GLAM-987] Approved-by: Giuseppe Digilio</MESSAGE>
      <SHA>60984a707df97f617ed0c970a16a3715c72afae4</SHA>
      <PATCHEDFILES>
        <FILE>dspace/etc/conftool/cris-layout-configuration.xls</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
