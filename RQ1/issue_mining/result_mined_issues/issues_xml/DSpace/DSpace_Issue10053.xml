<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>10053</ISSUENO>
  <ISSUEURL>https://github.com/DSpace/DSpace/issues/10053</ISSUEURL>
  <TITLE>COAR Notify: fixes to Request endorsement pattern implementation to fully adhere to the Notify implementation v1.0</TITLE>
  <DESCRIPTION>## Describe the bug The current implementation of COAR Notify in DSpace &gt;= 8.x for the COAR Request endorsement pattern does not fully adhere to the COAR Notify specification (https://coar-notify.net/specification/1.0.0/). Overall, the current implementation works really well, and the proposed fixes are relatively minor. The fixes have been implemented and tested in collaboration with the PCI Service (Peer Community In) which has a full Notify implementation already available, and currently being used by other repositories such as CSIC (Spain) and HAL (France). As a result, the PR associated with this issue will provide fixes to make the implementation fully adhere to Notify 1.0 specification, as well provide a workflow that supports integration with the PCI endorsement services. List of identified issues 1. The current implementation assumes communications between the repository and the endorsement service will be machine to machine (i.e. the offer notification sent by the repository has the actor hardcoded to being the repository service - see https://github.com/DSpace/DSpace/blob/fc544a830987782d90d22c747e12a42ccf9926d7/dspace/config/ldn/request-endorsement#L20) Instead, the endorsement service expects an email address id in the form **mailto:email@example.org&quot;** (e.g. the email and name of the submitter in the actor property) 2. Acknowledgement notifications: the current implementation in DSpace requires that the type property in received notifications includes both a **type (Accept, Reject, etc.)** as well as including the **coar-type (e.g. coar-type:RequestEndorsement)**. If the coar-type is not set, DSpace returns a null pointer error and notifications fails. See https://coar-notify.net/specification/1.0.0/accept/ where the type property is required and must be Accept, in the case of an Accept ack, and so on. Instead, the DSpace implementation could look for the coar-type (as it currently does), and if not present, it should look at inReplyTo property of the received notification and fetch the coar-type from the original notification (coar-type presence is required in the Offer notification, https://coar-notify.net/specification/1.0.0/request-endorsement/). If none present, then it should fail as expected. 3. Acknowledgement notifications the current DSpace implementation requires that the context property is present in received notifications, and uses this to find the associated DSpace object. The presence of context in ack notifications is optional (e.g. https://coar-notify.net/specification/1.0.0/accept/, the &quot;context&quot; property is not even mentioned for ack notifications). Therefore DSpace should follow the same approach as in 2.: if the context property is not present, then find it from the object in the associated inReplyTo notification. ## To Reproduce Steps to reproduce the behaviour: To reproduce the behaviour it is needed to set up a connection with PCI's staging/test environment ## Expected behaviour The service should allow to specify whether it requires the repository actor to be an email address, and ideally this should be done via configuration. The most simple implementation could make use of the submitter's email address and name (this approach would require less modifications to the database tables). A more flexible approach (that may not be needed) could allow the submitter to specify an email address (e.g. different to DSpace's submitter email address). The implementation should fully adhere to the current Notify implementation as per description in 2. and 3. ## Related work PR will be coming shortly</DESCRIPTION>
  <REPONAME>DSpace</REPONAME>
  <TIMEDIFFERENCEDAYS>109</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix syntax error in #10040. Env variables cannot have dashes or periods</MESSAGE>
    <SHA>fc544a830987782d90d22c747e12a42ccf9926d7</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#10053: Implement support for PCI Endorsement workflow in COAR Notify</MESSAGE>
      <SHA>16ffd016f4b2cac68c644ff0e7c8839a6616d102</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/LDNMessageConsumer.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/LDNMessageEntity.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/NotifyServiceEntity.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/dao/impl/LDNMessageDaoImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/model/NotifyRequestStatusEnum.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/processor/LDNMetadataProcessor.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/service/LDNMessageService.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/service/impl/LDNMessageServiceImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/discovery/indexobject/LDNMessageEntityIndexFactoryImpl.java</FILE>
        <FILE>dspace-api/src/main/resources/org/dspace/storage/rdbms/sqlmigration/postgres/V8.0_2024.11.09__ldn_service_external_actor.sql</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/NotifyServiceConverter.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/model/NotifyServiceRest.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/NotifyServiceRestRepository.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/patch/operation/NotifyServiceUsesActorEmailIdReplaceOperation.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/controller/LinksetRestController.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/converter/LinksetRestMessageConverter.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/model/LinksetNode.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/model/TypedLinkRest.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/processor/item/ItemDescribedbyProcessor.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/NotifyServiceAddPatchOperation.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/NotifyServiceRestRepositoryIT.java</FILE>
        <FILE>dspace/config/emails/coar_notify_rejected_resubmission</FILE>
        <FILE>dspace/config/ldn/announce-relationship</FILE>
        <FILE>dspace/config/ldn/request-endorsement</FILE>
        <FILE>dspace/config/ldn/request-endorsement-resubmission</FILE>
        <FILE>dspace/config/ldn/request-ingest</FILE>
        <FILE>dspace/config/ldn/request-review</FILE>
        <FILE>dspace/config/modules/ldn.cfg</FILE>
        <FILE>dspace/config/modules/signposting.cfg</FILE>
        <FILE>dspace/config/spring/api/ldn-coar-notify.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#10053: add missing migration file</MESSAGE>
      <SHA>b14f037742c92d0225cce311659c7c9515b81448</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/resources/org/dspace/storage/rdbms/sqlmigration/h2/V8.0_2024.11.09__ldn_service_external_actor.sql</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#10053: Fix integration tests</MESSAGE>
      <SHA>60daf7d2a848a09c014e74d87d942a088570c77b</SHA>
      <PATCHEDFILES>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/NotifyRequestStatusRestControllerIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Port #10053: Notify PCI endorsement support (DSpace 8.x)</MESSAGE>
      <SHA>28298a815501144e1eea9c00f52d920f60e3ee84</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/LDNMessageConsumer.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/LDNMessageEntity.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/action/LDNEmailAction.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/dao/impl/LDNMessageDaoImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/model/NotifyRequestStatus.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/model/NotifyRequestStatusEnum.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/model/RequestStatus.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/processor/LDNMetadataProcessor.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/service/LDNMessageService.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/service/impl/LDNMessageServiceImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/discovery/indexobject/LDNMessageEntityIndexFactoryImpl.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/controller/LinksetRestController.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/converter/LinksetRestMessageConverter.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/model/LinksetNode.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/model/TypedLinkRest.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/processor/item/ItemDescribedbyProcessor.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/NotifyServiceAddPatchOperation.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/NotifyRequestStatusRestControllerIT.java</FILE>
        <FILE>dspace/config/emails/coar_notify_rejected_resubmission</FILE>
        <FILE>dspace/config/emails/request_item.granted</FILE>
        <FILE>dspace/config/emails/request_item.rejected</FILE>
        <FILE>dspace/config/item-submission.xml</FILE>
        <FILE>dspace/config/ldn/announce-relationship</FILE>
        <FILE>dspace/config/ldn/request-endorsement</FILE>
        <FILE>dspace/config/ldn/request-endorsement-resubmission</FILE>
        <FILE>dspace/config/ldn/request-ingest</FILE>
        <FILE>dspace/config/ldn/request-review</FILE>
        <FILE>dspace/config/modules/ldn.cfg</FILE>
        <FILE>dspace/config/modules/signposting.cfg</FILE>
        <FILE>dspace/config/spring/api/ldn-coar-notify.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #10090 from amgciadev/fix-10053-b #10053: Implement support for PCI Endorsement workflow in COAR Notify</MESSAGE>
      <SHA>474becc847b01f7245781108306acd2ee616e5ef</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/LDNMessageConsumer.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/LDNMessageEntity.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/NotifyServiceEntity.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/action/LDNEmailAction.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/dao/impl/LDNMessageDaoImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/model/NotifyRequestStatusEnum.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/processor/LDNMetadataProcessor.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/service/LDNMessageService.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/service/impl/LDNMessageServiceImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/discovery/indexobject/LDNMessageEntityIndexFactoryImpl.java</FILE>
        <FILE>dspace-api/src/main/resources/org/dspace/storage/rdbms/sqlmigration/h2/V9.0_2024.11.09__ldn_service_external_actor.sql</FILE>
        <FILE>dspace-api/src/main/resources/org/dspace/storage/rdbms/sqlmigration/postgres/V9.0_2024.11.09__ldn_service_external_actor.sql</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/NotifyServiceConverter.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/model/NotifyServiceRest.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/NotifyServiceRestRepository.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/patch/operation/NotifyServiceUsesActorEmailIdReplaceOperation.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/controller/LinksetRestController.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/converter/LinksetRestMessageConverter.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/model/LinksetNode.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/model/TypedLinkRest.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/processor/item/ItemDescribedbyProcessor.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/NotifyServiceAddPatchOperation.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/LDNInboxControllerIT.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/NotifyRequestStatusRestControllerIT.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/NotifyServiceRestRepositoryIT.java</FILE>
        <FILE>dspace-server-webapp/src/test/resources/org/dspace/app/rest/ldn_ack_endorsement_reject.json</FILE>
        <FILE>dspace-server-webapp/src/test/resources/org/dspace/app/rest/ldn_ack_review_reject.json</FILE>
        <FILE>dspace/config/emails/coar_notify_rejected_resubmission</FILE>
        <FILE>dspace/config/ldn/announce-relationship</FILE>
        <FILE>dspace/config/ldn/request-endorsement</FILE>
        <FILE>dspace/config/ldn/request-endorsement-resubmission</FILE>
        <FILE>dspace/config/ldn/request-ingest</FILE>
        <FILE>dspace/config/ldn/request-review</FILE>
        <FILE>dspace/config/modules/ldn.cfg</FILE>
        <FILE>dspace/config/modules/signposting.cfg</FILE>
        <FILE>dspace/config/spring/api/ldn-coar-notify.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #10453 from amgciadev/port-10053-b [Port dspace-8_x] #10053: Implement support for PCI Endorsement workflow in COAR Notify</MESSAGE>
      <SHA>7b333f016f0eddea9c06b34e3ee858f5ef38c153</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/LDNMessageConsumer.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/LDNMessageEntity.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/action/LDNEmailAction.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/dao/impl/LDNMessageDaoImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/model/NotifyRequestStatus.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/model/NotifyRequestStatusEnum.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/model/RequestStatus.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/processor/LDNMetadataProcessor.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/service/LDNMessageService.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/app/ldn/service/impl/LDNMessageServiceImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/discovery/indexobject/LDNMessageEntityIndexFactoryImpl.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/controller/LinksetRestController.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/converter/LinksetRestMessageConverter.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/model/LinksetNode.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/model/TypedLinkRest.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/signposting/processor/item/ItemDescribedbyProcessor.java</FILE>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/submit/factory/impl/NotifyServiceAddPatchOperation.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/LDNInboxControllerIT.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/NotifyRequestStatusRestControllerIT.java</FILE>
        <FILE>dspace-server-webapp/src/test/resources/org/dspace/app/rest/ldn_ack_endorsement_reject.json</FILE>
        <FILE>dspace-server-webapp/src/test/resources/org/dspace/app/rest/ldn_ack_review_reject.json</FILE>
        <FILE>dspace/config/emails/coar_notify_rejected_resubmission</FILE>
        <FILE>dspace/config/emails/request_item.granted</FILE>
        <FILE>dspace/config/emails/request_item.rejected</FILE>
        <FILE>dspace/config/item-submission.xml</FILE>
        <FILE>dspace/config/ldn/announce-relationship</FILE>
        <FILE>dspace/config/ldn/request-endorsement</FILE>
        <FILE>dspace/config/ldn/request-endorsement-resubmission</FILE>
        <FILE>dspace/config/ldn/request-ingest</FILE>
        <FILE>dspace/config/ldn/request-review</FILE>
        <FILE>dspace/config/modules/ldn.cfg</FILE>
        <FILE>dspace/config/modules/signposting.cfg</FILE>
        <FILE>dspace/config/spring/api/ldn-coar-notify.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
