<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3116</ISSUENO>
  <ISSUEURL>https://github.com/DSpace/DSpace/issues/3116</ISSUEURL>
  <TITLE>Security issue in discovery</TITLE>
  <DESCRIPTION>**Describe the bug** Items under embargo (not the bitstreams) are exposed via Discovery. There's even an IT proving it's broken. The [item](https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/test/java/org/dspace/app/rest/DiscoveryRestControllerIT.java#L1927) has an [embargo period of 12 months](https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/test/java/org/dspace/app/rest/DiscoveryRestControllerIT.java#L1933), but is [accessible via discovery](https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/test/java/org/dspace/app/rest/DiscoveryRestControllerIT.java#L1959) as an [anonymous user](https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/test/java/org/dspace/app/rest/DiscoveryRestControllerIT.java#L1941). This implies there are security bugs: * The [SolrServiceResourceRestrictionPlugin](https://github.com/DSpace/DSpace/blob/main/dspace-api/src/main/java/org/dspace/discovery/SolrServiceResourceRestrictionPlugin.java) doesn't check for dates on permissions, causing the embargoed items to be returned * Discovery ignores the [PreAuthorize permissions check](https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/ConverterService.java#L122) which should ensure the item cannot be returned, not even when it's embedded The issue doesn't occur on the item REST endpoint. An [embargo of 6 months](https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/test/java/org/dspace/app/rest/ItemRestRepositoryIT.java#L1353) is resulting in an [unauthorized](https://github.com/DSpace/DSpace/blob/main/dspace-server-webapp/src/test/java/org/dspace/app/rest/ItemRestRepositoryIT.java#L1379) response.</DESCRIPTION>
  <REPONAME>DSpace</REPONAME>
  <TIMEDIFFERENCEDAYS>22</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #3145 from DSpace/dependabot/maven/org.apache.ant-ant-1.10.9 Bump ant from 1.9.15 to 1.10.9</MESSAGE>
    <SHA>ca0786a067e3cb384b31918b12d67bd0b231c4ca</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#3116 Security issue in discovery Fix in PreAuthorize (making sure it's not ignored)</MESSAGE>
      <SHA>7515fb2075201b2855e5059b7561ebbda75a1e9c</SHA>
      <PATCHEDFILES>
        <FILE>dspace-server-webapp/src/main/java/org/dspace/app/rest/converter/DiscoverResultConverter.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/DiscoveryRestControllerIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3116 Security issue in discovery Fix in discovery indexing</MESSAGE>
      <SHA>994062b69136911368639c6f6240c7c12cfd9186</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/java/org/dspace/discovery/SolrServiceResourceRestrictionPlugin.java</FILE>
        <FILE>dspace-server-webapp/src/test/java/org/dspace/app/rest/DiscoveryRestControllerIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
