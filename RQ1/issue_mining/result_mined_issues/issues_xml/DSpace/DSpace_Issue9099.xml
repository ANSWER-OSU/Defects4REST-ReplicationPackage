<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>9099</ISSUENO>
  <ISSUEURL>https://github.com/DSpace/DSpace/issues/9099</ISSUEURL>
  <TITLE>Deleted primary bitstream still referenced in the bundle</TITLE>
  <DESCRIPTION>**Describe the bug** Primary Bitstreams are used for Access Status calculations, but when the that bitstream is deleted, the bundle primary bitstream reference isn't changed. So, Access Status calculations will return wrong status. **To Reproduce** Steps to reproduce the behavior: 1. Create a new item 2. Upload several files into the item and fill the required data 3. Deposit the item 4. As an admin, Edit that Item and promote one bitstream to be Primary Bitstream (this will reference that bitstream at the bundle level) 5. Please take note of that bitstream's UUID 6. Delete that bitstream that we promote to primary 7. Check the database (please consider your UUID here): ``` sql SELECT * FROM bundle WHERE primary_bitstream_id='814aefff-4874-4a97-a7aa-b654172e7a40' ``` **Expected behavior** Apparently nothing changes, but the deleted bitstream is still referenced as that bundle primary bitstream. It's hoped that, when a bitstream is deleted, also that bundle's primary bitstream reference is also removed. This issue is also present in older DSpace versions (like 5.X).</DESCRIPTION>
  <REPONAME>DSpace</REPONAME>
  <TIMEDIFFERENCEDAYS>28</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #9123 from mwoodiupui/9122 Give `authority` Solr core a `_version_` field so it can be loaded</MESSAGE>
    <SHA>556be1d4c2e09aa41a04cfa5f94d9a70be4f46d4</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #9106 from paulo-graca/bugfix/issue-9099 Clear primary bistream when it's deleted- Fix issue #9099</MESSAGE>
      <SHA>9dbfa171c80ab7530e1e105eba7a9882fb7b0805</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/java/org/dspace/content/BitstreamServiceImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/content/Bundle.java</FILE>
        <FILE>dspace-api/src/main/resources/org/dspace/storage/rdbms/sqlmigration/postgres/V7.6_2023.10.12__Fix-deleted-primary-bitstreams.sql</FILE>
        <FILE>dspace-api/src/test/java/org/dspace/content/BitstreamTest.java</FILE>
        <FILE>dspace-api/src/test/java/org/dspace/content/BundleTest.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #9160 from DSpace/backport-9106-to-dspace-7_x [Port dspace-7_x] Clear primary bistream when it's deleted- Fix issue #9099</MESSAGE>
      <SHA>1ad9a097eed2b2c0e2976a958c05627fcc928cb3</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/java/org/dspace/content/BitstreamServiceImpl.java</FILE>
        <FILE>dspace-api/src/main/java/org/dspace/content/Bundle.java</FILE>
        <FILE>dspace-api/src/main/resources/org/dspace/storage/rdbms/sqlmigration/postgres/V7.6_2023.10.12__Fix-deleted-primary-bitstreams.sql</FILE>
        <FILE>dspace-api/src/test/java/org/dspace/content/BitstreamTest.java</FILE>
        <FILE>dspace-api/src/test/java/org/dspace/content/BundleTest.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
