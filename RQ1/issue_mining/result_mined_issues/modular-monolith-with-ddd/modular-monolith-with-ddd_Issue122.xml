<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>122</ISSUENO>
  <ISSUEURL>https://github.com/kgrzybek/modular-monolith-with-ddd/issues/122</ISSUEURL>
  <TITLE>SqlConnection reuse / MultipleActiveResultSets=true</TITLE>
  <DESCRIPTION>Hi, When a new `User` is created via `/userAccess/UserRegistrations`, the handlers in other modules which are subscribed to `NewUserRegisteredIntegrationEvent` throw the error below. The issue seems to be related to`SELECT`/`UPDATE` statements performed using Dapper in inbox processing (`ProcessInboxCommandHandler`) and reusing the sql connection. ``` [19:09:45 INF] [UserAccess] [OutboxMessage:cd855ef7-de09-491b-93a1-8e22e426bc8f] Publishing CompanyName.MyMeetings.Modules.UserAccess.IntegrationEvents.NewUserRegisteredIntegrationEvent [19:09:46 ERR] [Payments] [] Job DEFAULT.a5b45b20-44cf-4cda-9334-d412a7af9b9b threw an unhandled Exception: System.InvalidOperationException: The connection does not support MultipleActiveResultSets. at System.Data.SqlClient.SqlInternalConnectionTds.ValidateConnectionForExecute(SqlCommand command) at System.Data.SqlClient.SqlCommand.ValidateCommand(Boolean async, String method) at System.Data.SqlClient.SqlCommand.InternalExecuteNonQuery(TaskCompletionSource`1 completion, Boolean sendToPipe, Int32 timeout, Boolean asyncWrite, String methodName) at System.Data.SqlClient.SqlCommand.BeginExecuteNonQuery(AsyncCallback callback, Object stateObject) at System.Threading.Tasks.TaskFactory`1.FromAsyncImpl(Func`3 beginMethod, Func`2 endFunction, Action`1 endAction, Object state, TaskCreationOptions creationOptions) at System.Threading.Tasks.TaskFactory`1.FromAsync(Func`3 beginMethod, Func`2 endMethod, Object state) at System.Data.SqlClient.SqlCommand.ExecuteNonQueryAsync(CancellationToken cancellationToken) --- End of stack trace from previous location where exception was thrown --- at Dapper.SqlMapper.ExecuteImplAsync(IDbConnection cnn, CommandDefinition command, Object param) in C:\projects\dapper\Dapper\SqlMapper.Async.cs:line 678 at CompanyName.MyMeetings.Modules.Administration.Infrastructure.Configuration.Processing.Inbox.ProcessInboxCommandHandler.Handle(ProcessInboxCommand command, CancellationToken cancellationToken) in C:\Projects\dev\dotnet\tests\modular-monolith-with-ddd\src\Modules\Administration\Infrastructure\Configuration\Processing\Inbox\ProcessInboxCommandHandler.cs:line 60 at CompanyName.MyMeetings.Modules.Administration.Infrastructure.Configuration.Processing.UnitOfWorkCommandHandlerWithResultDecorator`2.Handle(T command, CancellationToken cancellationToken) in C:\Projects\dev\dotnet\tests\modular-monolith-with-ddd\src\Modules\Administration\Infrastructure\Configuration\Processing\UnitOfWorkCommandHandlerWithResultDecorator.cs:line 31 at CompanyName.MyMeetings.Modules.Administration.Infrastructure.Configuration.Processing.LoggingCommandHandlerWithResultDecorator`2.Handle(T command, CancellationToken cancellationToken) in C:\Projects\dev\dotnet\tests\modular-monolith-with-ddd\src\Modules\Administration\Infrastructure\Configuration\Processing\LoggingCommandHandlerWithResultDecorator.cs:line 35 at MediatR.Pipeline.RequestPreProcessorBehavior`2.Handle(TRequest request, CancellationToken cancellationToken, RequestHandlerDelegate`1 next) at MediatR.Pipeline.RequestPostProcessorBehavior`2.Handle(TRequest request, CancellationToken cancellationToken, RequestHandlerDelegate`1 next) at CompanyName.MyMeetings.Modules.Administration.Infrastructure.Configuration.Processing.CommandsExecutor.Execute[TResult](ICommand`1 command) in C:\Projects\dev\dotnet\tests\modular-monolith-with-ddd\src\Modules\Administration\Infrastructure\Configuration\Processing\CommandsExecutor.cs:line 24 at CompanyName.MyMeetings.Modules.Administration.Infrastructure.Configuration.Processing.Inbox.ProcessInboxJob.Execute(IJobExecutionContext context) in C:\Projects\dev\dotnet\tests\modular-monolith-with-ddd\src\Modules\Administration\Infrastructure\Configuration\Processing\Inbox\ProcessInboxJob.cs:line 11 at Quartz.Core.JobRunShell.Run(CancellationToken cancellationToken) ``` When adding `MultipleActiveResultSets=True` to the db connection string, the issue obviously disappears. I would avoid using MARS (`MultipleActiveResultSets=true`) if possible. Environment : running on Windows, with a localhost SQL Server Let me know if additional details are needed. Thanks.</DESCRIPTION>
  <REPONAME>modular-monolith-with-ddd</REPONAME>
  <TIMEDIFFERENCEDAYS>48</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add info about FrontEnd application</MESSAGE>
    <SHA>ac359f221c1589a800fc0fe8048e0cbee4c9d67b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>SqlConnection reuse / MultipleActiveResultSets=true #122</MESSAGE>
      <SHA>8e8b76e8de211ad4e704d77a245e22eaf57ae9eb</SHA>
      <PATCHEDFILES>
        <FILE>runIntegrationTests.cmd</FILE>
        <FILE>src/BuildingBlocks/EventBus/InMemoryEventBus.cs</FILE>
        <FILE>src/BuildingBlocks/EventBus/InMemoryEventBusClient.cs</FILE>
        <FILE>src/BuildingBlocks/Infrastructure/EventBus/IEventsBus.cs</FILE>
        <FILE>src/Modules/Administration/Application/Members/NewUserRegisteredIntegrationEventHandler.cs</FILE>
        <FILE>src/Modules/Administration/Infrastructure/Configuration/Processing/Inbox/ProcessInboxCommandHandler.cs</FILE>
        <FILE>src/Modules/Meetings/Application/Members/CreateMember/NewUserRegisteredIntegrationEventHandler.cs</FILE>
        <FILE>src/Modules/Meetings/Infrastructure/Configuration/Processing/Inbox/ProcessInboxCommandHandler.cs</FILE>
        <FILE>src/Modules/Payments/Application/Payers/CreatePayer/NewUserRegisteredIntegrationEventHandler.cs</FILE>
        <FILE>src/Modules/Payments/Infrastructure/Configuration/Processing/Inbox/ProcessInboxCommandHandler.cs</FILE>
        <FILE>src/Modules/UserAccess/Application/UserRegistrations/RegisterNewUser/NewUserRegisteredPublishEventHandler.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
