<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1950</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/1950</ISSUEURL>
  <TITLE>record_event task fails for view events generated by an user who accesses a dashboard using a public sharing link</TITLE>
  <DESCRIPTION>### Issue Summary If I share a dashboard and access it through the generated public URL, the worker prints an error to the log when it tries to write the view event into the events log table from the record_event task. ### Steps to Reproduce I was able to reproduce this issue by using the docker-compose.yml file provided in the repository (i.e. in a dev setup): 1. Setup a fresh instance of Redash 2. Create a new dashboard 3. Click the share button and enable public sharing 4. Copy the public sharing link (e.g. `http://localhost:5000/public/dashboards/CH6m72tekgbplwzelZuxWzdtWu3LlbsewVYVxm8J?org_slug=default`) and access it with a clean browser profile (or private window that has no redash login cookies around) ### What happens? The following error can be seen in the worker logs: ``` [2017-09-07 08:03:40,006: ERROR/MainProcess] Task redash.tasks.record_event[41674041-c67b-4659-a151-99f9e73e3301] raised unexpected: DataError('(psycopg2.DataError) invalid input syntax for integer: &quot;CH6m72tekgbplwzelZuxWzdtWu3LlbsewVYVxm8J&quot;\nLINE 1: ...id, additional_properties, created_at) VALUES (1, \'CH6m72tek...\n ^\n',) Traceback (most recent call last): File &quot;/usr/local/lib/python2.7/dist-packages/celery/app/trace.py&quot;, line 240, in trace_task R = retval = fun(*args, **kwargs) File &quot;/app/redash/worker.py&quot;, line 69, in __call__ return TaskBase.__call__(self, *args, **kwargs) File &quot;/usr/local/lib/python2.7/dist-packages/celery/app/trace.py&quot;, line 438, in __protected_call__ return self.run(*args, **kwargs) File &quot;/app/redash/tasks/general.py&quot;, line 15, in record_event models.db.session.commit() File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/scoping.py&quot;, line 157, in do return getattr(self.registry(), name)(*args, **kwargs) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py&quot;, line 874, in commit self.transaction.commit() File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py&quot;, line 461, in commit self._prepare_impl() File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py&quot;, line 441, in _prepare_impl self.session.flush() File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py&quot;, line 2137, in flush self._flush(objects) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py&quot;, line 2257, in _flush transaction.rollback(_capture_exception=True) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/langhelpers.py&quot;, line 60, in __exit__ compat.reraise(exc_type, exc_value, exc_tb) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py&quot;, line 2221, in _flush flush_context.execute() File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py&quot;, line 389, in execute rec.execute(self) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/unitofwork.py&quot;, line 548, in execute uow File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py&quot;, line 181, in save_obj mapper, table, insert) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/persistence.py&quot;, line 835, in _emit_insert_statements execute(statement, params) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 945, in execute return meth(self, multiparams, params) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py&quot;, line 263, in _execute_on_connection return connection._execute_clauseelement(self, multiparams, params) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 1053, in _execute_clauseelement compiled_sql, distilled_params File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 1189, in _execute_context context) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 1393, in _handle_dbapi_exception exc_info File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py&quot;, line 202, in raise_from_cause reraise(type(exception), exception, tb=exc_tb, cause=cause) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 1182, in _execute_context context) File &quot;/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py&quot;, line 469, in do_execute cursor.execute(statement, parameters) DataError: (psycopg2.DataError) invalid input syntax for integer: &quot;CH6m72tekgbplwzelZuxWzdtWu3LlbsewVYVxm8J&quot; LINE 1: ...id, additional_properties, created_at) VALUES (1, 'CH6m72tek... ^ [SQL: 'INSERT INTO events (org_id, user_id, action, object_type, object_id, additional_properties, created_at) VALUES (%(org_id)s, %(user_id)s, %(action)s, %(object_type)s, %(object_id)s, %(additional_properties)s, %(created_at)s) RETURNING events.id'] [parameters: {'user_id': u'CH6m72tekgbplwzelZuxWzdtWu3LlbsewVYVxm8J', 'created_at': datetime.datetime(2017, 9, 7, 8, 3, 39), 'object_type': 'dashboard', 'org_id': 1, 'object_id': 1, 'additional_properties': '{&quot;ip&quot;: &quot;172.20.0.1&quot;, &quot;public&quot;: true, &quot;referer&quot;: null, &quot;user_agent&quot;: &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:55.0) Gecko/20100101 Firefox/55.0&quot;, &quot;headless&quot;: false}', 'action': 'view'}] ``` Coincidentally, the value that fails to be set to the user_id field (`CH6m72tekgbplwzelZuxWzdtWu3LlbsewVYVxm8J`) is the token seen in the public sharing URL (`http://localhost:5000/public/dashboards/CH6m72tekgbplwzelZuxWzdtWu3LlbsewVYVxm8J?org_slug=default`) ### What should happen? The view event is properly saved to the events table and the task does not crash. ### Technical details: * Redash Version: Both stable release 2.0.0 and latest master with commit ID 2a22b98c77757f378d3a4ed1ec8eceb99f0a8b35 * How did you install Redash: Stable v2.0.0 by upgrading a previous version with the bin/upgrade script and the latest commit in master using the provided docker-compose configuration and following the developer environment setup. I believe this issue was discussed in #1238 but that lacked a proper STR to actually fix the root cause of this issue. It did had some good ideas about what could cause the bug and it indeed seems that an anonymous user causes an incorrect user_id to be included in the view event.</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>20</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #1961 from fan-t-endo/writer_encode_errors UnicodeWriter errors code to environment</MESSAGE>
    <SHA>50eb9a86c9fd1a50bbacdac28aad22bc805ae4ef</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #1950: record_event fails for api events</MESSAGE>
      <SHA>18d9b2eec92f45a67b493860b50cf055f41e8583</SHA>
      <PATCHEDFILES>
        <FILE>redash/handlers/base.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #1978 from getredash/patches Fix #1950: record_event fails for api events</MESSAGE>
      <SHA>505f338da9613a9e28bdcc9eb289c9071951caab</SHA>
      <PATCHEDFILES>
        <FILE>redash/handlers/base.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge branch 'master' of git://github.com/getredash/redash # By Arik Fraimovich (8) and others # Via GitHub (12) and others * 'master' of git://github.com/getredash/redash: (21 commits) Modernize Python 2 code to get ready for Python 3 Fixed eslint &quot;Cannot read property 'length' of undefined&quot; error Add option to set the flask-limiter storage engine Fix: don't crash query editor when there are unclosed curly brackets. Fix: error value in charts wasn't displayed if it was 0. Fix: tests entering endless loop, due to bad input. Cohort visualization: make it friendlier to use. Add missing import. Fix: Queries#all_queries was sometimes returning wrong number of queries. Fix #1950: record_event fails for api events Merged with upstream Bugfix: column.type not set by many data sources [sqlite, postgres etc] Use a different markdown library Update npm-shrinkwrap Use event.preventDefault() on EditInPlace textarea Remove magic numbers from EditInPlace() Update redirected link in README UnicodeWriter errors code to environment Hovertext length (#3) Merge/query based parameter (#2) ... Conflicts: package.json</MESSAGE>
      <SHA>85a6c5a8fe57f56bc5ea71094bb19f15f749f71e</SHA>
      <PATCHEDFILES>
        <FILE>.dockerignore</FILE>
        <FILE>README.md</FILE>
        <FILE>bin/release_manager.py</FILE>
        <FILE>client/.eslintignore</FILE>
        <FILE>client/.eslintrc.js</FILE>
        <FILE>client/app/components/app-header/index.js</FILE>
        <FILE>client/app/components/dynamic-form.js</FILE>
        <FILE>client/app/components/dynamic-table/index.js</FILE>
        <FILE>client/app/components/edit-in-place.js</FILE>
        <FILE>client/app/components/email-settings-warning/index.js</FILE>
        <FILE>client/app/components/error-messages.js</FILE>
        <FILE>client/app/components/filters.js</FILE>
        <FILE>client/app/components/footer/index.js</FILE>
        <FILE>client/app/components/overlay.js</FILE>
        <FILE>client/app/components/page-header/index.js</FILE>
        <FILE>client/app/components/paginator.js</FILE>
        <FILE>client/app/components/parameters.js</FILE>
        <FILE>client/app/components/permissions-editor/index.js</FILE>
        <FILE>client/app/components/query-link.js</FILE>
        <FILE>client/app/components/rd-tab/index.js</FILE>
        <FILE>client/app/components/rd-time-ago.js</FILE>
        <FILE>client/app/components/rd-timer.js</FILE>
        <FILE>client/app/components/route-status.js</FILE>
        <FILE>client/app/components/settings-screen.js</FILE>
        <FILE>client/app/components/sort-icon.js</FILE>
        <FILE>client/app/components/tab-nav/index.js</FILE>
        <FILE>client/app/components/visualization-name.js</FILE>
        <FILE>client/app/directives/index.js</FILE>
        <FILE>client/app/filters/datetime.js</FILE>
        <FILE>client/app/filters/index.js</FILE>
        <FILE>client/app/filters/markdown.js</FILE>
        <FILE>client/app/index.js</FILE>
        <FILE>client/app/pages/admin/index.js</FILE>
        <FILE>client/app/pages/admin/outdated-queries/index.js</FILE>
        <FILE>client/app/pages/admin/status/index.js</FILE>
        <FILE>client/app/pages/admin/tasks/cancel-query-button/index.js</FILE>
        <FILE>client/app/pages/admin/tasks/index.js</FILE>
        <FILE>client/app/pages/alert/alert-subscriptions/index.js</FILE>
        <FILE>client/app/pages/alert/index.js</FILE>
        <FILE>client/app/pages/alerts-list/index.js</FILE>
        <FILE>client/app/pages/dashboards/add-widget-dialog.js</FILE>
        <FILE>client/app/pages/dashboards/dashboard-list.js</FILE>
        <FILE>client/app/pages/dashboards/dashboard.js</FILE>
        <FILE>client/app/pages/dashboards/edit-dashboard-dialog.js</FILE>
        <FILE>client/app/pages/dashboards/index.js</FILE>
        <FILE>client/app/pages/dashboards/public-dashboard-page.js</FILE>
        <FILE>client/app/pages/dashboards/widget.js</FILE>
        <FILE>client/app/pages/data-sources/index.js</FILE>
        <FILE>client/app/pages/data-sources/list.js</FILE>
        <FILE>client/app/pages/data-sources/show.js</FILE>
        <FILE>client/app/pages/destinations/index.js</FILE>
        <FILE>client/app/pages/destinations/list.js</FILE>
        <FILE>client/app/pages/destinations/show.js</FILE>
        <FILE>client/app/pages/groups/data-sources.js</FILE>
        <FILE>client/app/pages/groups/edit-group-dialog.js</FILE>
        <FILE>client/app/pages/groups/group-name.js</FILE>
        <FILE>client/app/pages/groups/index.js</FILE>
        <FILE>client/app/pages/groups/list.js</FILE>
        <FILE>client/app/pages/groups/show.js</FILE>
        <FILE>client/app/pages/home/index.js</FILE>
        <FILE>client/app/pages/queries-list/index.js</FILE>
        <FILE>client/app/pages/queries/alert-unsaved-changes.js</FILE>
        <FILE>client/app/pages/queries/api-key-dialog.js</FILE>
        <FILE>client/app/pages/queries/embed-code-dialog.html</FILE>
        <FILE>client/app/pages/queries/embed-code-dialog.js</FILE>
        <FILE>client/app/pages/queries/index.js</FILE>
        <FILE>client/app/pages/queries/queries-search-results-page.js</FILE>
        <FILE>client/app/pages/queries/query-editor.js</FILE>
        <FILE>client/app/pages/queries/query-results-link.js</FILE>
        <FILE>client/app/pages/queries/schedule-dialog.js</FILE>
        <FILE>client/app/pages/queries/schema-browser.js</FILE>
        <FILE>client/app/pages/queries/source-view.js</FILE>
        <FILE>client/app/pages/queries/view.js</FILE>
        <FILE>client/app/pages/queries/visualization-embed.js</FILE>
        <FILE>client/app/pages/query-snippets/edit.js</FILE>
        <FILE>client/app/pages/query-snippets/index.js</FILE>
        <FILE>client/app/pages/query-snippets/list.js</FILE>
        <FILE>client/app/pages/users/index.js</FILE>
        <FILE>client/app/pages/users/list.js</FILE>
        <FILE>client/app/pages/users/new.js</FILE>
        <FILE>client/app/pages/users/show.js</FILE>
        <FILE>client/app/services/alert-dialog.js</FILE>
        <FILE>client/app/services/alert-subscription.js</FILE>
        <FILE>client/app/services/alert.js</FILE>
        <FILE>client/app/services/auth.js</FILE>
        <FILE>client/app/services/dashboard.js</FILE>
        <FILE>client/app/services/data-source.js</FILE>
        <FILE>client/app/services/destination.js</FILE>
        <FILE>client/app/services/events.js</FILE>
        <FILE>client/app/services/group.js</FILE>
        <FILE>client/app/services/keyboard-shortcuts.js</FILE>
        <FILE>client/app/services/notifications.js</FILE>
        <FILE>client/app/services/offline-listener.js</FILE>
        <FILE>client/app/services/query-result.js</FILE>
        <FILE>client/app/services/query-snippet.js</FILE>
        <FILE>client/app/services/query.js</FILE>
        <FILE>client/app/services/user.js</FILE>
        <FILE>client/app/services/widget.js</FILE>
        <FILE>client/app/visualizations/box-plot/index.js</FILE>
        <FILE>client/app/visualizations/chart/index.js</FILE>
        <FILE>client/app/visualizations/chart/plotly.js</FILE>
        <FILE>client/app/visualizations/cohort/index.js</FILE>
        <FILE>client/app/visualizations/counter/index.js</FILE>
        <FILE>client/app/visualizations/edit-visualization-dialog.js</FILE>
        <FILE>client/app/visualizations/index.js</FILE>
        <FILE>client/app/visualizations/map/index.js</FILE>
        <FILE>client/app/visualizations/pivot/index.js</FILE>
        <FILE>client/app/visualizations/sankey/index.js</FILE>
        <FILE>client/app/visualizations/sunburst/index.js</FILE>
        <FILE>client/app/visualizations/sunburst/sunburst.js</FILE>
        <FILE>client/app/visualizations/table/index.js</FILE>
        <FILE>client/app/visualizations/word-cloud/index.js</FILE>
        <FILE>migrations/0001_warning.py</FILE>
        <FILE>migrations/versions/65fc9ede4746_add_is_draft_status_to_queries_and_.py</FILE>
        <FILE>npm-shrinkwrap.json</FILE>
        <FILE>old_migrations/0003_update_data_source_config.py</FILE>
        <FILE>old_migrations/0013_update_counter_options.py</FILE>
        <FILE>old_migrations/0014_add_alert_rearm_seconds.py</FILE>
        <FILE>old_migrations/0023_add_notification_destination.py</FILE>
        <FILE>old_migrations/0026_add_access_control_tables.py</FILE>
        <FILE>package-lock.json</FILE>
        <FILE>package.json</FILE>
        <FILE>redash/__init__.py</FILE>
        <FILE>redash/cli/__init__.py</FILE>
        <FILE>redash/cli/data_sources.py</FILE>
        <FILE>redash/cli/groups.py</FILE>
        <FILE>redash/cli/organization.py</FILE>
        <FILE>redash/cli/users.py</FILE>
        <FILE>redash/handlers/base.py</FILE>
        <FILE>redash/handlers/embed.py</FILE>
        <FILE>redash/handlers/query_results.py</FILE>
        <FILE>redash/models.py</FILE>
        <FILE>redash/query_runner/athena.py</FILE>
        <FILE>redash/query_runner/big_query.py</FILE>
        <FILE>redash/query_runner/dynamodb_sql.py</FILE>
        <FILE>redash/query_runner/hive_ds.py</FILE>
        <FILE>redash/query_runner/impala_ds.py</FILE>
        <FILE>redash/query_runner/influx_db.py</FILE>
        <FILE>redash/query_runner/presto.py</FILE>
        <FILE>redash/query_runner/python.py</FILE>
        <FILE>redash/query_runner/treasuredata.py</FILE>
        <FILE>redash/settings.py</FILE>
        <FILE>redash/utils/__init__.py</FILE>
        <FILE>tests/test_cli.py</FILE>
        <FILE>webpack.config.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge branch 'master' of git://github.com/getredash/redash # By Arik Fraimovich (8) and others # Via GitHub (12) and others * 'master' of git://github.com/getredash/redash: (21 commits) Modernize Python 2 code to get ready for Python 3 Fixed eslint &quot;Cannot read property 'length' of undefined&quot; error Add option to set the flask-limiter storage engine Fix: don't crash query editor when there are unclosed curly brackets. Fix: error value in charts wasn't displayed if it was 0. Fix: tests entering endless loop, due to bad input. Cohort visualization: make it friendlier to use. Add missing import. Fix: Queries#all_queries was sometimes returning wrong number of queries. Fix #1950: record_event fails for api events Merged with upstream Bugfix: column.type not set by many data sources [sqlite, postgres etc] Use a different markdown library Update npm-shrinkwrap Use event.preventDefault() on EditInPlace textarea Remove magic numbers from EditInPlace() Update redirected link in README UnicodeWriter errors code to environment Hovertext length (#3) Merge/query based parameter (#2) ... Conflicts: package.json</MESSAGE>
      <SHA>57f422a11923fd789ac6aff4d465cd27c057e930</SHA>
      <PATCHEDFILES>
        <FILE>client/app/visualizations/pivot/index.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #1950: record_event fails for api events</MESSAGE>
      <SHA>a8937a81990a23e7d227708b6544808b7076b891</SHA>
      <PATCHEDFILES>
        <FILE>handlers/base.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
