<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>411</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/411</ISSUEURL>
  <TITLE>Add time zone support</TITLE>
  <DESCRIPTION>Right now re:dash assumes that all timestamps are in the local time zone. However, Redshift (and many other databases, depending on the configuration) default to UTC, and thus re:dash parses the data incorrectly. What's confusing is that in Highcharts also formats the data in local time, leading to this awkward display: ![image](https://cloud.githubusercontent.com/assets/963826/7282512/4c9a1d38-e8e5-11e4-9bbf-eb52707d71ff.png) Notice how the data is highlighted at the beginning of April 23 (which hasn't happened yet in GMT), but the date is showing April 22 4:00 pm (which hasn't happened yet in Pacific Standard Time). I temporarily worked around this by patching ng_highchart.js: ``` diff if (moment.isMoment(this.x)) { - var s = '&lt;b&gt;' + this.x.toDate().toLocaleString() + '&lt;/b&gt;', + var s = '&lt;b&gt;' + this.x.toDate().toISOString() + '&lt;/b&gt;', pointsCount = this.points.length; ``` resources.js: ``` diff if (angular.isNumber(v)) { columnTypes[k] = 'float'; } else if (_.isString(v) &amp;&amp; v.match(/^\d{4}-\d{2}-\d{2}T/)) { - row[k] = moment(v); + row[k] = moment.utc(v); columnTypes[k] = 'datetime'; } else if (_.isString(v) &amp;&amp; v.match(/^\d{4}-\d{2}-\d{2}/)) { - row[k] = moment(v); + row[k] = moment.utc(v); columnTypes[k] = 'date'; } else if (typeof(v) == 'object' &amp;&amp; v !== null) { row[k] = JSON.stringify(v); ``` I'd imagine there will be cases where some users have their database configured to output a specific standard time and others will use UTC. What's the best way to support this feature? Options: 1. Store the UTC offset in the `query_result` (so moment will parse the right value) 2. Allow configuration option in re:dash for time zone (e.g. UTC, America/Los_Angeles) What do you think, @arikfr?</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>180</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update AWS/GCE image links.</MESSAGE>
    <SHA>5f47689553cd55a6f2905639a8a4eef54030a117</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Improve timezone handling: 1. Load all date/datetime values with moment.utc() which doesn't apply current timezone to them. 2. Don't use toLocaleString to format strings (which was converting them to current timezone as well). Ref #411.</MESSAGE>
      <SHA>b9a0760d7e17134b0e685ee95128efd7c039169e</SHA>
      <PATCHEDFILES>
        <FILE>rd_ui/app/index.html</FILE>
        <FILE>rd_ui/app/scripts/app.js</FILE>
        <FILE>rd_ui/app/scripts/controllers/controllers.js</FILE>
        <FILE>rd_ui/app/scripts/controllers/query_source.js</FILE>
        <FILE>rd_ui/app/scripts/filters.js</FILE>
        <FILE>rd_ui/app/scripts/ng_highchart.js</FILE>
        <FILE>rd_ui/app/scripts/services/resources.js</FILE>
        <FILE>rd_ui/app/scripts/visualizations/table.js</FILE>
        <FILE>rd_ui/test/mocks/redash_mocks.js</FILE>
        <FILE>redash/handlers/static.py</FILE>
        <FILE>redash/settings.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Improve timezone handling: 1. Load all date/datetime values with moment.utc() which doesn't apply current timezone to them. 2. Don't use toLocaleString to format strings (which was converting them to current timezone as well). Ref #411.</MESSAGE>
      <SHA>a01fd91e403496c2200899c788bec7676c5f194e</SHA>
      <PATCHEDFILES>
        <FILE>handlers/static.py</FILE>
        <FILE>settings.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
