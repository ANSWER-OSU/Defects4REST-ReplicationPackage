<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6767</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/6767</ISSUEURL>
  <TITLE>A db migration does not take Query#apply_auto_limit in count</TITLE>
  <DESCRIPTION>&lt;!-- We use GitHub only for bug reports Anything else should be a discussion: https://github.com/getredash/redash/discussions/ For support, help &amp; questions use https://github.com/getredash/redash/discussions/categories/q-a For feature requests &amp; ideas use https://github.com/getredash/redash/discussions/categories/ideas **Found a security vulnerability?** Please email security@redash.io to report any security vulnerabilities. We will acknowledge receipt of your vulnerability and strive to send you regular updates about our progress. If you're curious about the status of your disclosure please feel free to email us again. If you want to encrypt your disclosure email, you can use this PGP key. --&gt; ### Issue Summary I am trying to upgrade a Redash 10.1.0 instance to the current preview version A new version is a &quot;preview&quot; docker image pushed at Feb 10th of 2024. After migration: - my queries with scheduled refreshes stopped to refresh - &quot;refresh button&quot; makes a refresh in UI but query result but after page refresh the query still do not have a query result. I've discovered that this db migration: https://github.com/getredash/redash/blob/master/migrations/versions/1038c2174f5d_make_case_insensitive_hash_of_query_text.py does not take in count the &quot;apply_auto_limit&quot; setting of Queries. So, if a Query's `options` contains `apply_auto_limit: true`, this migration converts a query hash without applying the limit. But the QueryRunner applies it as usually generates query results adding the `LIMIT 1000`. Then the result could never be associated with their queries anymore. I guess this db migration should be rewritten and use smth like this: https://github.com/getredash/redash/blob/939bec21142aeb2adc8c659ef2cbc3ad8f9df973/redash/query_runner/__init__.py#L310 ### Steps to Reproduce 1. Install 10.1.0. E.g. I've launched https://hub.docker.com/layers/redash/redash/10.1.0.b50633/images/sha256-f3e8d95656255d9684051604a586dfd50035fa1e297e68379dc1b557f1885c0f?context=explore. Or it could be pulled from github 2. Create a datasource (it could be a Redash's database as well) 3. Create and publish query, e.g. `select current_timestamp;`. 4. Set it to be refreshed once a minute. 5. Ensure the query results are refreshed by refreshing a page after a few minutes. 6. Stop the instance, update the version (use a [preview image](https://hub.docker.com/r/redash/redash/tags) or pull to the current master or whatever you should do), using the same internal Redash's database. 7. Run db migrations. 8. Run the redash. 9. Check the query after a few minutes - it wouldn't be refreshed. Not &quot;Refresh&quot; button will lead to the expected behaviour. ### Technical details: * Redash Version: preview version * Browser/OS: Mac OS/Chrome * How did you install Redash: used docker image: https://hub.docker.com/layers/redash/redash/10.1.0.b50633/images/sha256-f3e8d95656255d9684051604a586dfd50035fa1e297e68379dc1b557f1885c0f?context=explore</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>252</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Bump cryptography from 42.0.8 to 43.0.1 (#7205) Co-authored-by: dependabot[bot] &lt;49699333+dependabot[bot]@users.noreply.github.com&gt;</MESSAGE>
    <SHA>d8dde6c5443e7051f91665f58119410b926ee0bf</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixes #6767: correctly rehash queries in a migration (#7184)</MESSAGE>
      <SHA>ba973eb1fe27406f4e8cb6db74d46cc14c163778</SHA>
      <PATCHEDFILES>
        <FILE>migrations/versions/9e8c841d1a30_fix_hash.py</FILE>
        <FILE>redash/cli/queries.py</FILE>
        <FILE>redash/metrics/database.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixes #6767: correctly rehash queries in a migration (#7184)</MESSAGE>
      <SHA>e5436920b9390f4705181b90ef5744568bfcb0d1</SHA>
      <PATCHEDFILES>
        <FILE>migrations/versions/9e8c841d1a30_fix_hash.py</FILE>
        <FILE>redash/cli/queries.py</FILE>
        <FILE>redash/metrics/database.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
