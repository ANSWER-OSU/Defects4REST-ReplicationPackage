<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1979</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/1979</ISSUEURL>
  <TITLE>The API key for one query may be used to retrieve another query's results</TITLE>
  <DESCRIPTION>### Issue Summary A query's API key may be used to obtain another query's results via the REST api when including the API key in the query string. ### Steps to Reproduce 1. Create one query and execute it to obtain results (call it query A) 2. Create another query and execute it to obtain different results (call it query B) 3. Get the query's API key for query A (A_API_KEY) and the query number for query A (A_QUERY_NUMBER) 4. Get the result number from query B's most recent run (B_RESULT_NUMBER) 5. Execute the below code and you'll see that the API key for query A can get results from query B ```bash REDASH_DOMAIN='yourdomain.com' A_QUERY_NUMBER='query number for query A' A_API_KEY_A='api key for query A' B_RESULT_NUMBER='query result number for query b' # this will download query B's results using query A's access key wget \ -O query_b_results.csv \ &quot;https://$REDASH_DOMAIN/api/queries/$A_QUERY_NUMBER/results/$B_RESULT_NUMBER.csv?api_key=$A_API_KEY&quot; ``` This is a bug because one query's API key should NOT be able to access another query's results. ### Technical details: * Redash Version: 1.0.3 * Browser/OS: (Command Line) / Linux Mint 18.2 * How did you install Redash: Command line</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>34</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix: move boto3 import to the correct location</MESSAGE>
    <SHA>a3c2082b7f637aa6ba5033f58eb6824564062d71</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #1979: API key of one query could be used to get results of another one</MESSAGE>
      <SHA>ba36f7395dc7dca86c87ff25e9f497f28a11b9fe</SHA>
      <PATCHEDFILES>
        <FILE>redash/handlers/query_results.py</FILE>
        <FILE>tests/handlers/test_query_results.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #2069 from getredash/bugfixes Fix #1979: API key of one query could be used to get results of another one</MESSAGE>
      <SHA>71a235c79bcf463f4594908f2f113df8e2258c78</SHA>
      <PATCHEDFILES>
        <FILE>redash/handlers/query_results.py</FILE>
        <FILE>tests/handlers/test_query_results.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge branch 'master' of https://github.com/getredash/redash * 'master' of https://github.com/getredash/redash: (95 commits) CR3 In editing mode hide menu button and show remove button instead Fix: widget menu not visible on small widgets Fix widget auto-height behaviour Cleanup CSS CR2 CR1 getredash/redash#335 Better dashboard editor CirlceCI: Docker build for release branches. Redshift: change default SSL mode to prefer. Update v3 CHANGELOG. Add Query Results to the default query runners list. Add: data source to run queries on top of query results. Fix #1824: allow only user API key to be used with query refresh API. Disable fork button for those can't fork Fix: require full access to the data source to fork a query. Remove unused variables Fix #1979: API key of one query could be used to get results of another one Copy parameters value when forking a query Save only the query id instead of query id and name ...</MESSAGE>
      <SHA>36037458bd9c928f2b5e4584b98ec615178c5336</SHA>
      <PATCHEDFILES>
        <FILE>.gitignore</FILE>
        <FILE>CHANGELOG.md</FILE>
        <FILE>Makefile</FILE>
        <FILE>bin/docker-entrypoint</FILE>
        <FILE>circle.yml</FILE>
        <FILE>client/.eslintrc.js</FILE>
        <FILE>client/app/assets/css/superflat_redash.css</FILE>
        <FILE>client/app/components/alerts/alert-subscriptions/alert-subscriptions.html</FILE>
        <FILE>client/app/components/alerts/alert-subscriptions/index.js</FILE>
        <FILE>client/app/components/app-header/app-header.html</FILE>
        <FILE>client/app/components/app-header/index.js</FILE>
        <FILE>client/app/components/cancel-query-button/index.js</FILE>
        <FILE>client/app/components/dashboards/add-widget-dialog.html</FILE>
        <FILE>client/app/components/dashboards/add-widget-dialog.js</FILE>
        <FILE>client/app/components/dashboards/edit-dashboard-dialog.html</FILE>
        <FILE>client/app/components/dashboards/edit-dashboard-dialog.js</FILE>
        <FILE>client/app/components/dashboards/edit-text-box.html</FILE>
        <FILE>client/app/components/dashboards/widget.html</FILE>
        <FILE>client/app/components/dashboards/widget.js</FILE>
        <FILE>client/app/components/dashboards/widget.less</FILE>
        <FILE>client/app/components/dynamic-form.html</FILE>
        <FILE>client/app/components/filters.html</FILE>
        <FILE>client/app/components/filters.js</FILE>
        <FILE>client/app/components/groups/edit-group-dialog.html</FILE>
        <FILE>client/app/components/groups/edit-group-dialog.js</FILE>
        <FILE>client/app/components/groups/group-name.js</FILE>
        <FILE>client/app/components/index.js</FILE>
        <FILE>client/app/components/parameter-settings.html</FILE>
        <FILE>client/app/components/parameters.html</FILE>
        <FILE>client/app/components/parameters.js</FILE>
        <FILE>client/app/components/queries/alert-unsaved-changes.js</FILE>
        <FILE>client/app/components/queries/api-key-dialog.js</FILE>
        <FILE>client/app/components/queries/embed-code-dialog.html</FILE>
        <FILE>client/app/components/queries/embed-code-dialog.js</FILE>
        <FILE>client/app/components/queries/query-editor.js</FILE>
        <FILE>client/app/components/queries/query-results-link.js</FILE>
        <FILE>client/app/components/queries/schedule-dialog.html</FILE>
        <FILE>client/app/components/queries/schedule-dialog.js</FILE>
        <FILE>client/app/components/queries/schema-browser.html</FILE>
        <FILE>client/app/components/queries/schema-browser.js</FILE>
        <FILE>client/app/components/queries/visualization-embed.html</FILE>
        <FILE>client/app/components/queries/visualization-embed.js</FILE>
        <FILE>client/app/components/query-based-parameter.html</FILE>
        <FILE>client/app/components/settings-screen.html</FILE>
        <FILE>client/app/components/settings-screen.js</FILE>
        <FILE>client/app/config/dashboard-grid-options.js</FILE>
        <FILE>client/app/config/index.js</FILE>
        <FILE>client/app/config/styles.js</FILE>
        <FILE>client/app/directives/index.js</FILE>
        <FILE>client/app/index.js</FILE>
        <FILE>client/app/lib/pagination/index.js</FILE>
        <FILE>client/app/lib/pagination/live-paginator.js</FILE>
        <FILE>client/app/lib/pagination/paginator.js</FILE>
        <FILE>client/app/lib/sortable.js</FILE>
        <FILE>client/app/lib/visualizations/d3box.js</FILE>
        <FILE>client/app/lib/visualizations/d3sankey.js</FILE>
        <FILE>client/app/lib/visualizations/sunburst.js</FILE>
        <FILE>client/app/pages/admin/index.js</FILE>
        <FILE>client/app/pages/admin/outdated-queries/index.js</FILE>
        <FILE>client/app/pages/admin/tasks/index.js</FILE>
        <FILE>client/app/pages/alert/alert-subscriptions/index.js</FILE>
        <FILE>client/app/pages/alert/index.js</FILE>
        <FILE>client/app/pages/alerts-list/index.js</FILE>
        <FILE>client/app/pages/dashboards/add-widget-dialog.js</FILE>
        <FILE>client/app/pages/dashboards/dashboard-list.html</FILE>
        <FILE>client/app/pages/dashboards/dashboard-list.js</FILE>
        <FILE>client/app/pages/dashboards/dashboard.html</FILE>
        <FILE>client/app/pages/dashboards/dashboard.js</FILE>
        <FILE>client/app/pages/dashboards/dashboard.less</FILE>
        <FILE>client/app/pages/dashboards/index.js</FILE>
        <FILE>client/app/pages/dashboards/public-dashboard-page.html</FILE>
        <FILE>client/app/pages/dashboards/public-dashboard-page.js</FILE>
        <FILE>client/app/pages/dashboards/widget.html</FILE>
        <FILE>client/app/pages/data-sources/index.js</FILE>
        <FILE>client/app/pages/destinations/index.js</FILE>
        <FILE>client/app/pages/groups/index.js</FILE>
        <FILE>client/app/pages/groups/list.js</FILE>
        <FILE>client/app/pages/home/home.html</FILE>
        <FILE>client/app/pages/home/index.js</FILE>
        <FILE>client/app/pages/index.js</FILE>
        <FILE>client/app/pages/queries-list/index.js</FILE>
        <FILE>client/app/pages/queries/index.js</FILE>
        <FILE>client/app/pages/queries/queries-search-results-page.js</FILE>
        <FILE>client/app/pages/queries/query.html</FILE>
        <FILE>client/app/pages/queries/source-view.js</FILE>
        <FILE>client/app/pages/query-snippets/edit.html</FILE>
        <FILE>client/app/pages/query-snippets/index.js</FILE>
        <FILE>client/app/pages/query-snippets/list.js</FILE>
        <FILE>client/app/pages/users/index.js</FILE>
        <FILE>client/app/pages/users/list.js</FILE>
        <FILE>client/app/pages/users/new.html</FILE>
        <FILE>client/app/services/current-user.js</FILE>
        <FILE>client/app/services/dashboard.js</FILE>
        <FILE>client/app/services/index.js</FILE>
        <FILE>client/app/services/query-result.js</FILE>
        <FILE>client/app/services/query.js</FILE>
        <FILE>client/app/services/widget.js</FILE>
        <FILE>client/app/visualizations/box-plot/d3box.js</FILE>
        <FILE>client/app/visualizations/box-plot/index.js</FILE>
        <FILE>client/app/visualizations/chart/index.js</FILE>
        <FILE>client/app/visualizations/chart/plotly.js</FILE>
        <FILE>client/app/visualizations/edit-visualization-dialog.html</FILE>
        <FILE>client/app/visualizations/index.js</FILE>
        <FILE>client/app/visualizations/sankey/index.js</FILE>
        <FILE>client/app/visualizations/sankey/sankey-editor.html</FILE>
        <FILE>client/app/visualizations/sunburst/index.js</FILE>
        <FILE>client/app/visualizations/sunburst/sunburst-sequence-editor.html</FILE>
        <FILE>client/app/visualizations/table/index.js</FILE>
        <FILE>docker-compose.production.yml</FILE>
        <FILE>docker-compose.yml</FILE>
        <FILE>package-lock.json</FILE>
        <FILE>package.json</FILE>
        <FILE>redash/__init__.py</FILE>
        <FILE>redash/authentication/account.py</FILE>
        <FILE>redash/handlers/groups.py</FILE>
        <FILE>redash/handlers/queries.py</FILE>
        <FILE>redash/handlers/query_results.py</FILE>
        <FILE>redash/handlers/users.py</FILE>
        <FILE>redash/handlers/widgets.py</FILE>
        <FILE>redash/models.py</FILE>
        <FILE>redash/monitor.py</FILE>
        <FILE>redash/query_runner/athena.py</FILE>
        <FILE>redash/query_runner/cass.py</FILE>
        <FILE>redash/query_runner/files/redshift-ca-bundle.crt</FILE>
        <FILE>redash/query_runner/mongodb.py</FILE>
        <FILE>redash/query_runner/mssql_odbc.py</FILE>
        <FILE>redash/query_runner/mysql.py</FILE>
        <FILE>redash/query_runner/pg.py</FILE>
        <FILE>redash/query_runner/prometheus.py</FILE>
        <FILE>redash/query_runner/query_results.py</FILE>
        <FILE>redash/query_runner/treasuredata.py</FILE>
        <FILE>redash/settings.py</FILE>
        <FILE>redash/tasks/queries.py</FILE>
        <FILE>redash/worker.py</FILE>
        <FILE>requirements.txt</FILE>
        <FILE>requirements_all_ds.txt</FILE>
        <FILE>setup/ubuntu/bootstrap.sh</FILE>
        <FILE>tests/handlers/test_queries.py</FILE>
        <FILE>tests/handlers/test_query_results.py</FILE>
        <FILE>tests/models/test_permissions.py</FILE>
        <FILE>tests/query_runner/test_query_results.py</FILE>
        <FILE>webpack.config.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #1979: API key of one query could be used to get results of another one</MESSAGE>
      <SHA>e76f3a78ab406dedfd1b8dfe345cc691a2474e1e</SHA>
      <PATCHEDFILES>
        <FILE>handlers/query_results.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #2069 from getredash/bugfixes Fix #1979: API key of one query could be used to get results of another one</MESSAGE>
      <SHA>15035393a906f746698c274f1b3006a51d0783ce</SHA>
      <PATCHEDFILES>
        <FILE>handlers/query_results.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
