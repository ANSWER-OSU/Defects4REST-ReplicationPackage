<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4469</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/4469</ISSUEURL>
  <TITLE>Redash can't create user from Google with long profile_image_url</TITLE>
  <DESCRIPTION>### Redash can't create user with long profile_image_url My coworker tried to login to redash and it failed. ``` [2019-12-20 14:32:12,927] ERROR in app: Exception on /oauth/google_callback [GET] Traceback (most recent call last): File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1982, in wsgi_app response = self.full_dispatch_request() File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1614, in full_dispatch_request rv = self.handle_user_exception(e) File &quot;/usr/local/lib/python2.7/site-packages/flask_restful/__init__.py&quot;, line 271, in error_router return original_handler(e) File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1517, in handle_user_exception reraise(exc_type, exc_value, tb) File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1612, in full_dispatch_request rv = self.dispatch_request() File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1598, in dispatch_request return self.view_functions[rule.endpoint](**req.view_args) File &quot;/app/redash/authentication/google_oauth.py&quot;, line 101, in authorized user = create_and_login_user(org, profile['name'], profile['email'], picture_url) File &quot;/app/redash/authentication/__init__.py&quot;, line 257, in create_and_login_user models.db.session.commit() File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/scoping.py&quot;, line 153, in do return getattr(self.registry(), name)(*args, **kwargs) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py&quot;, line 943, in commit self.transaction.commit() File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py&quot;, line 467, in commit self._prepare_impl() File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py&quot;, line 447, in _prepare_impl self.session.flush() File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py&quot;, line 2254, in flush self._flush(objects) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py&quot;, line 2380, in _flush transaction.rollback(_capture_exception=True) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/util/langhelpers.py&quot;, line 66, in __exit__ compat.reraise(exc_type, exc_value, exc_tb) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/session.py&quot;, line 2344, in _flush flush_context.execute() File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/unitofwork.py&quot;, line 391, in execute rec.execute(self) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/unitofwork.py&quot;, line 556, in execute uow File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/persistence.py&quot;, line 181, in save_obj mapper, table, insert) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/orm/persistence.py&quot;, line 866, in _emit_insert_statements execute(statement, params) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py&quot;, line 948, in execute return meth(self, multiparams, params) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/sql/elements.py&quot;, line 269, in _execute_on_connection return connection._execute_clauseelement(self, multiparams, params) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1060, in _execute_clauseelement compiled_sql, distilled_params File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1200, in _execute_context context) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1413, in _handle_dbapi_exception exc_info File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/util/compat.py&quot;, line 265, in raise_from_cause reraise(type(exception), exception, tb=exc_tb, cause=cause) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/base.py&quot;, line 1193, in _execute_context context) File &quot;/usr/local/lib/python2.7/site-packages/sqlalchemy/engine/default.py&quot;, line 509, in do_execute cursor.execute(statement, parameters) DataError: (psycopg2.DataError) value too long for type character varying(320) [SQL: 'INSERT INTO users (updated_at, created_at, org_id, name, email, profile_image_url, password_hash, groups, api_key, disabled_at, details) VALUES (now(), now(), %(org_id)s, %(name)s, %(email)s, %(profile_image_url)s, %(password_hash)s, %(groups)s, %(api_key)s, %(disabled_at)s, %(details)s) RETURNING users.id'] [parameters: {'name': u'&lt;redacted&gt;', 'org_id': &lt;redacted&gt;, 'profile_image_url': u'https://lh3.googleusercontent.com/a-/AAuE7mCQC1y8a0Bew0vZ3zVr835IDK1pq8_J75Jy4YNUwe2TdaYqr8vJBF1eQB8k5u6kooonWTfrnVdpOjR3_Epvit-sKbkbjq12GgcW6qv1iva ... (517 characters truncated) ... JfmDWlN_ESNOyJu6JRgNKLqFN5pJQJQ44IcS0OEt5ozElvbEV35vX7sw-OBptVnBUPW4wy9cElsIhnw8ISHgp8zSqJhwQfrn5bII6fN42EMrq1_sv66KBAm-0NIit0QYWkocdT58V4PClb8?sz=40', 'disabled_at': None, 'details': '{&quot;is_invitation_pending&quot;: false}', 'groups': [2], 'api_key': '&lt;redacted&gt;', 'email': u'&lt;redacted&gt;', 'password_hash': None}] (Background on this error at: http://sqlalche.me/e/9h9h) ``` Turns out, he had basic auto-generated one letter avatar \([more info](https://gsuiteupdates.googleblog.com/2015/09/change-to-default-avatar-for-google.html)\) for which Google returns profile_image_url 815 characters long. Maybe they generate it on the fly, who knows. We changed this auto-generated avatar to a normal one and it succeeded. ### Steps to Reproduce 1. Have an user in identity provider (G suite in our case) with profile_image_url longer than 320 characters 2. Try to login first time 3. Get internal server error ### Technical details: * Redash Version: 8.0 * Browser/OS: Chrome * How did you install Redash: Helmchart</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>775</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix: don't accept password login requests if password auth is disabled (#5693)</MESSAGE>
    <SHA>12c475068483ba1cc2525e73ecd20843bf435922</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Move user profile image url into the users.details field Makes the details field a JSONB field per pg doc recommendations. Update model.all() method to work properly now that profile_image_url is not an independent field. Closes #4469</MESSAGE>
      <SHA>93d785599e83f008ae8acd31d610f0d2b8899d08</SHA>
      <PATCHEDFILES>
        <FILE>migrations/versions/fd4fc850d7ea_.py</FILE>
        <FILE>redash/models/__init__.py</FILE>
        <FILE>redash/models/users.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Move user profile image url into the users.details field (#5697) Makes the details field a JSONB field per pg doc recommendations. Update model.all() method to work properly now that profile_image_url is not an independent field. Closes #4469</MESSAGE>
      <SHA>49fe29579a56e7a8e206895586eca1736a6d210d</SHA>
      <PATCHEDFILES>
        <FILE>migrations/versions/fd4fc850d7ea_.py</FILE>
        <FILE>redash/models/__init__.py</FILE>
        <FILE>redash/models/users.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Move user profile image url into the users.details field (#5697) Makes the details field a JSONB field per pg doc recommendations. Update model.all() method to work properly now that profile_image_url is not an independent field. Closes #4469</MESSAGE>
      <SHA>522b58542f683d71ea6e906e911614d1df44cf48</SHA>
      <PATCHEDFILES>
        <FILE>migrations/versions/fd4fc850d7ea_.py</FILE>
        <FILE>redash/models/__init__.py</FILE>
        <FILE>redash/models/users.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
