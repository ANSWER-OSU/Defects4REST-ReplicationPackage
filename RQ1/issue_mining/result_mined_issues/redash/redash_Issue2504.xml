<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2504</ISSUENO>
  <ISSUEURL>https://github.com/getredash/redash/issues/2504</ISSUEURL>
  <TITLE>BUG: Google Sheets parsing does not respect guessed column type</TITLE>
  <DESCRIPTION>I have a google sheet with columns `id`, `name` and `abbreviation`. One of the rows has values: |id|name|abbreviation| |--|--|--| |...|...|...| |3569|Nantes|NAN| |...|...|...| Redash is able to query the sheet and retrieve the data. However it fails to render it in browser and returns the error: ![image](https://user-images.githubusercontent.com/14027470/39469398-e3af900c-4d2f-11e8-801b-95bdcbaa6a0f.png) Inspecting in chrome dev tools, we see a 200 response from api for `query_results` but error at `JSON.parse`: ![image](https://user-images.githubusercontent.com/14027470/39469437-12668eb4-4d30-11e8-8a4a-280b6b017866.png) Inspecting the response at position 2520006 we see the following JSON object: ```json {&quot;abbreviation&quot;: NaN, &quot;id&quot;: 3569, &quot;name&quot;: &quot;Nantes&quot;} ``` We also see that redash correctly guessed the type of column for abbreviation as `string` if we inspect the `columns` array of the response: ```json { &quot;columns&quot;: [{ &quot;friendly_name&quot;: &quot;id&quot;, &quot;type&quot;: &quot;integer&quot;, &quot;name&quot;: &quot;id&quot; }, { &quot;friendly_name&quot;: &quot;name&quot;, &quot;type&quot;: &quot;string&quot;, &quot;name&quot;: &quot;name&quot; }, { &quot;friendly_name&quot;: &quot;abbreviation&quot;, &quot;type&quot;: &quot;string&quot;, &quot;name&quot;: &quot;abbreviation&quot; }] } ``` This means that the backend is incorrectly parsing and storing the data. Looking at how the Google Sheets query runner works, it roughly does the following upon getting the data: 1. inspect some rows to determine the column type `_guess_type` https://github.com/getredash/redash/blob/3edec570f17ff3052b01abd8dd75c7c343940f90/redash/query_runner/google_spreadsheets.py#L27-L47 1. parse the data for every row https://github.com/getredash/redash/blob/3edec570f17ff3052b01abd8dd75c7c343940f90/redash/query_runner/google_spreadsheets.py#L118 https://github.com/getredash/redash/blob/3edec570f17ff3052b01abd8dd75c7c343940f90/redash/query_runner/google_spreadsheets.py#L50 `_value_eval_list` does not seem to take into account the guessed type of the column which means it parses it independently. It parses the value for each data type until it succeeds or assumes `STRING`. in Python `float(&quot;NAN&quot;)` actually returns a float `NaN`. Here's an example: https://repl.it/repls/SteelOnlyLoopfission This is tested with Python 2.7.x and redash version 3.0.0+b3134 ## Solution One solution is to refactor/rewrite the `_value_eval_list` function to take in second parameter `col_type` and update the multiple if clauses to switch on col_type for member. Pseudo code: ```python def _value_eval_list(value, col_types): value_list = [] raw_values = zip(col_types,value) for rv in raw_values: if (rv[1] == TYPE_FLOAT): value_list.append(float(rv[0])) if (rv[1] == TYPE_STRING): value_list.append(rv[0]) ... return value_list ``` Calling this function might look like (inside `parse_worksheet()` line 117-118): ```python column_types = [c['type'] for c in columns] rows = [dict(zip(column_names, _value_eval_list(row , column_types))) for row in worksheet[HEADER_INDEX + 1:]] ``` ## Further Investigation More investigation is required but I think that's the issue and solution. I have _not_ tested this in Redash v4. Based on master branch it looks like it is an issue.</DESCRIPTION>
  <REPONAME>redash</REPONAME>
  <TIMEDIFFERENCEDAYS>78</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #2499 from kocsmy/design/design-improvements Design improvements</MESSAGE>
    <SHA>44a330a4e618884bd3ae37f2584d96312ad0e849</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>getredash/redash#2504 Update value parsing for google spreadsheets source</MESSAGE>
      <SHA>61106dec14d8d2ca89691c264a31efb3257f0c90</SHA>
      <PATCHEDFILES>
        <FILE>.gitignore</FILE>
        <FILE>redash/query_runner/google_spreadsheets.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
