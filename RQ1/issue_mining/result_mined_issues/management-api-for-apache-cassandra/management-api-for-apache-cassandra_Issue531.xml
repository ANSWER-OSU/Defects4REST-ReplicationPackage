<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>531</ISSUENO>
  <ISSUEURL>https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/531</ISSUEURL>
  <TITLE>Fix DSE 6.9 UBI image agent loading</TITLE>
  <DESCRIPTION>Since the change was made to support read-only root filesystems (https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/521), the DSE 6.9 UBI images fail to start because the Management API agent is loaded twice in cassandra-env.sh ```sh # add the DSE loader JVM_OPTS=&quot;$JVM_OPTS $DSE_OPTS&quot; JVM_OPTS=&quot;$JVM_OPTS -javaagent:/opt/management-api/datastax-mgmtapi-agent.jar&quot; JVM_OPTS=&quot;$JVM_OPTS -javaagent:/opt/management-api/datastax-mgmtapi-agent.jar&quot; ``` This causes the error: ```sh ERROR [DSE main thread] 2024-09-03 20:23:28,286 DseDaemon.java:564 - Unable to start DSE server. java.lang.AssertionError: Multiple assignments to NodeOps! at com.datastax.mgmtapi.rpc.RpcRegistry.register(RpcRegistry.java:31) at com.datastax.mgmtapi.NodeOpsProvider.register(NodeOpsProvider.java:77) at com.datastax.mgmtapi.interceptors.CassandraDaemonInterceptor.intercept(CassandraDaemonInterceptor.java:54) at org.apache.cassandra.service.CassandraDaemon.start$original$keiSH0P3(CassandraDaemon.java) at org.apache.cassandra.service.CassandraDaemon.start(CassandraDaemon.java) at com.datastax.bdp.server.DseDaemon.start(DseDaemon.java:559) at org.apache.cassandra.service.CassandraDaemon.activate0(CassandraDaemon.java:830) at org.apache.cassandra.service.CassandraDaemon$3.run(CassandraDaemon.java:738) ERROR [DSE main thread] 2024-09-03 20:23:28,286 CassandraDaemon.java:959 - Exception encountered during startup java.lang.RuntimeException: java.lang.AssertionError: Multiple assignments to NodeOps! at com.datastax.bdp.server.DseDaemon.start(DseDaemon.java:567) at org.apache.cassandra.service.CassandraDaemon.activate0(CassandraDaemon.java:830) at org.apache.cassandra.service.CassandraDaemon$3.run(CassandraDaemon.java:738) Caused by: java.lang.AssertionError: Multiple assignments to NodeOps! at com.datastax.mgmtapi.rpc.RpcRegistry.register(RpcRegistry.java:31) at com.datastax.mgmtapi.NodeOpsProvider.register(NodeOpsProvider.java:77) at com.datastax.mgmtapi.interceptors.CassandraDaemonInterceptor.intercept(CassandraDaemonInterceptor.java:54) at org.apache.cassandra.service.CassandraDaemon.start$original$keiSH0P3(CassandraDaemon.java) at org.apache.cassandra.service.CassandraDaemon.start(CassandraDaemon.java) at com.datastax.bdp.server.DseDaemon.start(DseDaemon.java:559) ... 2 common frames omitted ``` This happens because the cassandra-env.sh edit that happens in the Dockerfile does not check to see if the agent has already been added to cassandra-env.sh. The reason only the DSE UBI images are affected is because they are built from the DSE 6.9 Ubuntu images as a base image, which already has the line added to load the agent. The Cassandra 4.1 UBI images do not use the 4.1 Ubuntu images as a base image, so the agent line doesn't already exist in those images. ┆Issue is synchronized with this [Jira Story](https://datastax.jira.com/browse/MAPI-61) by [Unito](https://www.unito.io) ┆Issue Number: MAPI-61</DESCRIPTION>
  <REPONAME>management-api-for-apache-cassandra</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update DSE agent in DSE images</MESSAGE>
    <SHA>16c59a7d01bbe274f3d503c25ee00264aed9cf80</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Release v0.1.85 * [FEATURE] [#523](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/523) Trust store reload functionality for DSE only (not Cassandra) * [FEATURE] [#527](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/527) Add Cassandra 4.1.6 to the build matrix * [FEATURE] [#522](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/522) Add DSE 6.9.1 to the build matrix * [FEATURE] [#529](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/529) Add DSE 6.9.2 to the build matrix * [ENHANCEMENT] [#521](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/521) Add management-api to Cassandra conf in the Dockerfile, not entrypoint for DSE 6.9, Cassandra 4.1 and Cassandra 5.0. This allows to run the container with readOnlyRootFilesystem. * [BUGFIX] [#524](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/524) Fix HintsService Hint_delays- metrics parsing and ReadCoordination metrics parsing * [BUGFIX] [#520](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/520) Update DSE 6.9.0 dependnecy * [BUGFIX] [#531](https://github.com/k8ssandra/management-api-for-apache-cassandra/issues/531) Fix DSE 6.9 UBI image agent loading</MESSAGE>
      <SHA>d68b0127be45b0570d1543d5544dc249bf44d855</SHA>
      <PATCHEDFILES>
        <FILE>CHANGELOG.md</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
