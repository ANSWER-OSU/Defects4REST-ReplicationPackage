<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>25</ISSUENO>
  <ISSUEURL>https://github.com/treasure-data/digdag/issues/25</ISSUEURL>
  <TITLE>for_each parameterization capability is limited</TITLE>
  <DESCRIPTION>`for_each&gt;` parameters can be parameterized like below by utilizing YAML anchors: ``` yaml run: +parameterized_for_each _export: foos: &amp;FOOS - 1 - 2 +parameterized_for_each: for_each&gt;: foo: *FOOS _do: sh&gt;: &quot;echo hello ${foo}&quot; ``` But it might be useful to allow for parameterizing `for_each&gt;` using actual digdag parameters. E.g. ``` yaml run: +parameterized_for_each _export: foos: - 1 - 2 +parameterized_for_each: for_each&gt;: foo: @foos _do: sh&gt;: &quot;echo hello ${foo}&quot; ``` And using parameters explicitly set by e.g. a `py&gt;` task: ``` yaml run: +main +main: +export_foos: py&gt;: tasks.export_foos +parameterized_for_each: for_each&gt;: foo: ${foos} _do: sh&gt;: &quot;echo hello ${foo}&quot; ``` ``` python import digdag def export_foos(): digdag.env.store({&quot;foos&quot;: [1, 2]}) ``` Attempting to parameterize `for_each&gt;` like this currently fails with the below error: ``` 2016-03-30 10:18:17 +0900: Digdag v0.4.2 2016-03-30 10:18:18 +0900 [WARN] (main): Reusing the last session time 2016-03-29T00:00:00+09:00. 2016-03-30 10:18:18 +0900 [INFO] (main): Using session digdag.status/20160329T000000+0900. 2016-03-30 10:18:18 +0900 [INFO] (main): Starting a new session repository id=1 workflow name=+main session_time=2016-03-29T00:00:00+09:00 2016-03-30 10:18:19 +0900 [INFO] (0020@+main+export_foos): py&gt;: tasks.export_foos 2016-03-30 10:18:19 +0900 [INFO] (0020@+main+parameterized_for_each): for_each&gt;: {foo=[1,2]} 2016-03-30 10:18:19 +0900 [ERROR] (0020@+main+parameterized_for_each): Task failed io.digdag.client.config.ConfigException: Expected array type for key 'foo' but got &quot;[1,2]&quot; (string) at io.digdag.client.config.Config.propagateConvertException(Config.java:400) at io.digdag.client.config.Config.readObject(Config.java:391) at io.digdag.client.config.Config.get(Config.java:235) at io.digdag.client.config.Config.getList(Config.java:277) at io.digdag.standards.operator.ForEachOperatorFactory$ForEachOperator.runTask(ForEachOperatorFactory.java:67) at io.digdag.standards.operator.BaseOperator.run(BaseOperator.java:49) at io.digdag.core.agent.OperatorManager.callExecutor(OperatorManager.java:238) at io.digdag.cli.Run$OperatorManagerWithSkip.callExecutor(Run.java:653) at io.digdag.core.agent.OperatorManager.runWithArchive(OperatorManager.java:193) at io.digdag.core.agent.OperatorManager.lambda$runWithHeartbeat$1(OperatorManager.java:130) at io.digdag.core.agent.CurrentDirectoryArchiveManager.withExtractedArchive(CurrentDirectoryArchiveManager.java:20) at io.digdag.core.agent.OperatorManager.runWithHeartbeat(OperatorManager.java:129) at io.digdag.core.agent.OperatorManager.run(OperatorManager.java:107) at io.digdag.cli.Run$OperatorManagerWithSkip.run(Run.java:635) at io.digdag.core.agent.LocalAgent.lambda$run$0(LocalAgent.java:61) at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) at java.util.concurrent.FutureTask.run(FutureTask.java:266) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) at java.lang.Thread.run(Thread.java:745) Caused by: com.fasterxml.jackson.databind.JsonMappingException: Can not deserialize instance of java.util.ArrayList out of VALUE_STRING token at [Source: N/A; line: -1, column: -1] at com.fasterxml.jackson.databind.JsonMappingException.from(JsonMappingException.java:148) at com.fasterxml.jackson.databind.DeserializationContext.mappingException(DeserializationContext.java:854) at com.fasterxml.jackson.databind.DeserializationContext.mappingException(DeserializationContext.java:850) at com.fasterxml.jackson.databind.deser.std.CollectionDeserializer.handleNonArray(CollectionDeserializer.java:292) at com.fasterxml.jackson.databind.deser.std.CollectionDeserializer.deserialize(CollectionDeserializer.java:227) at com.fasterxml.jackson.databind.deser.std.CollectionDeserializer.deserialize(CollectionDeserializer.java:217) at com.fasterxml.jackson.databind.deser.std.CollectionDeserializer.deserialize(CollectionDeserializer.java:25) at com.fasterxml.jackson.databind.ObjectMapper._readValue(ObjectMapper.java:3703) at com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:2072) at io.digdag.client.config.Config.readObject(Config.java:388) ... 18 common frames omitted error: * +main+parameterized_for_each: Expected array type for key 'foo' but got &quot;[1,2]&quot; (string) Task state is saved at digdag.status/20160329T000000+0900 directory. Run command with --session '2016-03-29 00:00:00' argument to retry failed tasks. ``` I'm uncertain whether the best approach would be to make `${...}` expansion more intelligent about types of parameters and not coerce everything to a string, or if it would make more sense to introduce another syntax.</DESCRIPTION>
  <REPONAME>digdag</REPONAME>
  <TIMEDIFFERENCEDAYS>190</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Remove invalid character '&gt;', '&lt;' from the comments to fix failure in publish. (#24)</MESSAGE>
    <SHA>64e9baed8b88bced9338d92c0b9daf398274dc8a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>WM-1370 Fix pagination with descending order (#25) * Fix last_id with desc. Co-authored-by: rune-chan &lt;renee.chang@treasure-data.com&gt;</MESSAGE>
      <SHA>039b90e96c01277a4d0f5fffaea45f3f32f1e00b</SHA>
      <PATCHEDFILES>
        <FILE>digdag-core/src/main/java/io/digdag/core/database/DatabaseProjectStoreManager.java</FILE>
        <FILE>digdag-core/src/main/java/io/digdag/core/repository/ProjectStore.java</FILE>
        <FILE>digdag-server/src/main/java/io/digdag/server/rs/WorkflowResource.java</FILE>
        <FILE>digdag-tests/src/test/java/acceptance/ApiWorkflowsIT.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
