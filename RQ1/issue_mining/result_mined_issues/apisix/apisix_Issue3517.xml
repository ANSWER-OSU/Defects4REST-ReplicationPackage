<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3517</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3517</ISSUEURL>
  <TITLE>[DISCUSS] add per node DNS selector</TITLE>
  <DESCRIPTION>When resolving domain, currently we take one of the DNS record randomly. When we want to do service discovery via DNS, sometimes we hope the domain resolving will return all the records. For example, with: ``` &quot;nodes&quot;: { &quot;test.consul.service&quot;: 1 } ``` We may want to get all IPs instead of a random one. So my purpose is to provide a per-node dns selector to control the behavior. For example, ``` &quot;nodes&quot;: { {&quot;host&quot;: &quot;test.consul.service&quot;, &quot;weight&quot;: 1, &quot;selector&quot;: &quot;random&quot;} } ``` is equal to previous configuration. While ``` &quot;nodes&quot;: { {&quot;host&quot;: &quot;test.consul.service&quot;, &quot;weight&quot;: 1, &quot;selector&quot;: &quot;all&quot;}, {&quot;host&quot;: &quot;1.1.1.1&quot;, &quot;weight&quot;: 1} } ``` with `test.consul.service` be resolved as `1.1.1.2` and `1.1.1.3` will get this result: ``` &quot;nodes&quot;: { {&quot;host&quot;: &quot;1.1.1.1&quot;, &quot;weight&quot;: 2}, {&quot;host&quot;: &quot;1.1.1.2&quot;, &quot;weight&quot;: 1}, {&quot;host&quot;: &quot;1.1.1.3&quot;, &quot;weight&quot;: 1}, } ``` Note that all the IPs from `test.consul.service` share the same weight. And the selector doesn't affect SRV record, which is a difference story.</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>20</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>refactor: remove unused core.http (#3555) Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>7dde426a4f78368976e959ee82b27cfe3fbf2b59</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: add dns discovery Fix #3517 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>56eb8a691d69ff103aba87abc4406b71270ac32b</SHA>
      <PATCHEDFILES>
        <FILE>apisix/core.lua</FILE>
        <FILE>apisix/core/dns/client.lua</FILE>
        <FILE>apisix/core/utils.lua</FILE>
        <FILE>apisix/discovery/dns.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/discovery.md</FILE>
        <FILE>doc/dns.md</FILE>
        <FILE>doc/zh-cn/discovery.md</FILE>
        <FILE>t/APISIX.pm</FILE>
        <FILE>t/coredns/db.test.local</FILE>
        <FILE>t/discovery/dns/mix.t</FILE>
        <FILE>t/discovery/dns/sanity.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: add dns discovery Fix #3517 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>2e66e4101baa9bbca22f65142fe7aa5b75319b7d</SHA>
      <PATCHEDFILES>
        <FILE>Makefile</FILE>
        <FILE>apisix/core.lua</FILE>
        <FILE>apisix/core/dns/client.lua</FILE>
        <FILE>apisix/core/utils.lua</FILE>
        <FILE>apisix/discovery/dns.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/discovery.md</FILE>
        <FILE>doc/dns.md</FILE>
        <FILE>doc/zh-cn/discovery.md</FILE>
        <FILE>t/APISIX.pm</FILE>
        <FILE>t/coredns/db.test.local</FILE>
        <FILE>t/discovery/dns/mix.t</FILE>
        <FILE>t/discovery/dns/sanity.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: add dns discovery Fix #3517 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>ba908a555259395a1647caf7d613903cd0a8a552</SHA>
      <PATCHEDFILES>
        <FILE>apisix/core.lua</FILE>
        <FILE>apisix/core/dns/client.lua</FILE>
        <FILE>apisix/core/utils.lua</FILE>
        <FILE>apisix/discovery/dns.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/discovery.md</FILE>
        <FILE>doc/dns.md</FILE>
        <FILE>doc/zh-cn/discovery.md</FILE>
        <FILE>t/APISIX.pm</FILE>
        <FILE>t/coredns/db.test.local</FILE>
        <FILE>t/discovery/dns/mix.t</FILE>
        <FILE>t/discovery/dns/sanity.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: add dns discovery Fix #3517 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>ec831730e34f96222d24387cc1902856d23ecb0f</SHA>
      <PATCHEDFILES>
        <FILE>Makefile</FILE>
        <FILE>apisix/core.lua</FILE>
        <FILE>apisix/core/dns/client.lua</FILE>
        <FILE>apisix/core/utils.lua</FILE>
        <FILE>apisix/discovery/dns.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/discovery.md</FILE>
        <FILE>doc/dns.md</FILE>
        <FILE>doc/zh-cn/discovery.md</FILE>
        <FILE>t/APISIX.pm</FILE>
        <FILE>t/coredns/db.test.local</FILE>
        <FILE>t/discovery/dns/mix.t</FILE>
        <FILE>t/discovery/dns/sanity.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: add dns discovery Fix #3517 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>1b6f00de20081d59d7569006395bbdc8fe46d894</SHA>
      <PATCHEDFILES>
        <FILE>Makefile</FILE>
        <FILE>apisix/core.lua</FILE>
        <FILE>apisix/core/dns/client.lua</FILE>
        <FILE>apisix/core/utils.lua</FILE>
        <FILE>apisix/discovery/dns.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/discovery.md</FILE>
        <FILE>doc/dns.md</FILE>
        <FILE>doc/zh-cn/discovery.md</FILE>
        <FILE>t/APISIX.pm</FILE>
        <FILE>t/coredns/db.test.local</FILE>
        <FILE>t/discovery/dns/mix.t</FILE>
        <FILE>t/discovery/dns/sanity.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: add dns discovery Fix #3517 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>b3c6ecfe264dcd1367db6628f9daab5e59a91596</SHA>
      <PATCHEDFILES>
        <FILE>Makefile</FILE>
        <FILE>apisix/core.lua</FILE>
        <FILE>apisix/core/dns/client.lua</FILE>
        <FILE>apisix/core/utils.lua</FILE>
        <FILE>apisix/discovery/dns.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/discovery.md</FILE>
        <FILE>doc/dns.md</FILE>
        <FILE>doc/zh-cn/discovery.md</FILE>
        <FILE>t/coredns/db.test.local</FILE>
        <FILE>t/discovery/dns/mix.t</FILE>
        <FILE>t/discovery/dns/sanity.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: add dns discovery Fix #3517 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>197f650398091929f32b0b7dfbc3eff5a0f3139d</SHA>
      <PATCHEDFILES>
        <FILE>Makefile</FILE>
        <FILE>apisix/core.lua</FILE>
        <FILE>apisix/core/dns/client.lua</FILE>
        <FILE>apisix/core/utils.lua</FILE>
        <FILE>apisix/discovery/dns.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/discovery.md</FILE>
        <FILE>doc/dns.md</FILE>
        <FILE>doc/zh-cn/discovery.md</FILE>
        <FILE>t/coredns/db.test.local</FILE>
        <FILE>t/discovery/dns/mix.t</FILE>
        <FILE>t/discovery/dns/sanity.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: add dns discovery (#3629) Fix #3517 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>2a6e2b42470d660d91f665a8b9ed1d4c708f8e64</SHA>
      <PATCHEDFILES>
        <FILE>Makefile</FILE>
        <FILE>apisix/core.lua</FILE>
        <FILE>apisix/core/dns/client.lua</FILE>
        <FILE>apisix/core/utils.lua</FILE>
        <FILE>apisix/discovery/dns.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/discovery.md</FILE>
        <FILE>doc/dns.md</FILE>
        <FILE>doc/zh-cn/discovery.md</FILE>
        <FILE>t/coredns/db.test.local</FILE>
        <FILE>t/discovery/dns/mix.t</FILE>
        <FILE>t/discovery/dns/sanity.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
