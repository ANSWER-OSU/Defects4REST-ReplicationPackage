<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4047</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/4047</ISSUEURL>
  <TITLE>bug: when a domain name exists in the upstream node configuration, roundrobin is abnormal</TITLE>
  <DESCRIPTION>### Issue description When configuring upstream, &quot;upstream.type&quot; is &quot;roundrobin&quot;. When there is a domain name in the upstream `node` (ip and domain name are mixed use/all are configuration domain names), then only the node with the largest `weight` value will be hit. When there are multiple maximum `weight` nodes, multiple nodes will be accessed in `roundrobin` mode. ### Environment * apisix version (cmd: `apisix version`): 2.5 * OS (cmd: `uname -a`): Linux * OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): nginx version: openresty/1.19.3.1 * etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): 3.4.0 * apisix-dashboard version, if have: ### Minimal test code / Steps to reproduce the issue After the request is successful, the upstream will return the corresponding port number. 1. Create a route, all nodes are domain names, and the value of `weight` is the same. ```shell curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;uris&quot;:[ &quot;/get&quot; ], &quot;name&quot;:&quot;up-test-01&quot;, &quot;upstream&quot;:{ &quot;nodes&quot;:[ { &quot;host&quot;:&quot;localhost.localdomain&quot;, &quot;port&quot;:1981, &quot;weight&quot;:1 }, { &quot;host&quot;:&quot;localhost&quot;, &quot;port&quot;:1982, &quot;weight&quot;:1 } ], &quot;type&quot;:&quot;roundrobin&quot;, &quot;pass_host&quot;:&quot;pass&quot; }, &quot;status&quot;:1 }' ``` Test: ```shell $ for i in `seq 1 10`; do curl http://127.0.0.1:9080/get; done 1981 1981 1981 1982 1981 1982 1981 1982 1982 1982 ``` 2. Create a route, all nodes are domain names, and the `localhost.localdomain` domain name node has the largest `weight`. ```shell curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;uris&quot;:[ &quot;/get&quot; ], &quot;name&quot;:&quot;up-test-01&quot;, &quot;upstream&quot;:{ &quot;nodes&quot;:[ { &quot;host&quot;:&quot;localhost.localdomain&quot;, &quot;port&quot;:1981, &quot;weight&quot;:4 }, { &quot;host&quot;:&quot;localhost&quot;, &quot;port&quot;:1982, &quot;weight&quot;:1 } ], &quot;type&quot;:&quot;roundrobin&quot;, &quot;pass_host&quot;:&quot;pass&quot; }, &quot;status&quot;:1 }' ``` Test: ```shell $ for i in `seq 1 10`; do curl http://127.0.0.1:9080/get; done 1981 1981 1981 1981 1981 1981 1981 1981 1981 1981 ``` 3. Create a route, mix ip and domain name, and `localhost.localdomain` domain name node has the largest `weight`. ```shell curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;uris&quot;:[ &quot;/get&quot; ], &quot;name&quot;:&quot;up-test-01&quot;, &quot;upstream&quot;:{ &quot;nodes&quot;:[ { &quot;host&quot;:&quot;127.0.0.1&quot;, &quot;port&quot;:1980, &quot;weight&quot;:1 }, { &quot;host&quot;:&quot;127.0.0.1&quot;, &quot;port&quot;:1981, &quot;weight&quot;:1 }, { &quot;host&quot;:&quot;localhost&quot;, &quot;port&quot;:1982, &quot;weight&quot;:4 } ], &quot;type&quot;:&quot;roundrobin&quot;, &quot;pass_host&quot;:&quot;pass&quot; }, &quot;status&quot;:1 }' ``` Test: ```shell $ for i in `seq 1 10`; do curl http://127.0.0.1:9080/get; done 1982 1982 1982 1982 1982 1982 1982 1982 1982 1982 ``` ### What's the expected result? When there is a domain name configuration in upstream and the domain name node has the maximum `weight` value, it should be able to roundrobin all nodes.</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>chore: update linguist-vendored (#4023)</MESSAGE>
    <SHA>1a2e8e06d419c8111fa1fa1189a3aa8f94423f0c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: ensure upstream with domain is cached Fix #4047 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>ce32b52ed530e08b9def9bda082c36b3d779e44c</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>t/node/route-domain.t</FILE>
        <FILE>t/node/upstream-domain.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: ensure upstream with domain is cached Fix #4047 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>90202535147d00d3cef34c818094f53f73b0f87b</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>t/node/route-domain.t</FILE>
        <FILE>t/node/upstream-domain.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: ensure upstream with domain is cached (#4061) Fix #4047 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>ce4d8fb1e55f94c03c3a641f8f0d1a62c189ceaf</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>t/node/route-domain.t</FILE>
        <FILE>t/node/upstream-domain.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
