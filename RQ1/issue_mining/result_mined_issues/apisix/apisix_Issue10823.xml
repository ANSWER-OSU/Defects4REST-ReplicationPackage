<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>10823</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/10823</ISSUEURL>
  <TITLE>bug: use secret can cause 500 stack error in some case.</TITLE>
  <DESCRIPTION>### Current Behavior When I use [secret](https://apisix.apache.org/docs/apisix/terminology/secret/), it will cause a 500 stack error when I delete the secret and send request to apisix. ### Expected Behavior After delete secret and update consumer, if send request to apisix, it will return http status 401 but not cause 500. maybe i can fix it if i have time. ### Error Logs ``` 2024/01/15 17:25:54 [error] 27990#390598690: *25233 lua entry thread aborted: runtime error: ...cuments/api7projects/opensource/apisix/apisix/secret.lua:61: attempt to index local 'v' (a boolean value) stack traceback: coroutine 0: ...cuments/api7projects/opensource/apisix/apisix/secret.lua: in function 'create_obj_fun' .../api7projects/opensource/apisix/apisix/core/lrucache.lua:95: in function 'secret_kv_lrucache' ...cuments/api7projects/opensource/apisix/apisix/secret.lua:88: in function 'secret_kv' ...cuments/api7projects/opensource/apisix/apisix/secret.lua:156: in function 'fetch_by_uri' ...cuments/api7projects/opensource/apisix/apisix/secret.lua:188: in function 'fetch' ...cuments/api7projects/opensource/apisix/apisix/secret.lua:211: in function 'fetch_secrets' ...ments/api7projects/opensource/apisix/apisix/consumer.lua:107: in function 'create_obj_fun' .../api7projects/opensource/apisix/apisix/core/lrucache.lua:95: in function 'lrucache' ...ments/api7projects/opensource/apisix/apisix/consumer.lua:116: in function 'consumers_kv' ...i7projects/opensource/apisix/apisix/plugins/key-auth.lua:88: in function 'phase_func' ...cuments/api7projects/opensource/apisix/apisix/plugin.lua:1095: in function 'run_plugin' ...Documents/api7projects/opensource/apisix/apisix/init.lua:633: in function 'http_access_phase' access_by_lua(nginx.conf:328):2: in main chunk, client: 127.0.0.1, server: _, request: &quot;GET /anything HTTP/1.1&quot;, host: &quot;127.0.0.1:9080&quot; ``` ### Steps to Reproduce ```shell $ docker run --name vault \ --cap-add=IPC_LOCK \ -e VAULT_DEV_ROOT_TOKEN_ID=&quot;root&quot; \ -e VAULT_ADDR=&quot;http://0.0.0.0:8200&quot; \ -p 8200:8200 \ vault:1.13.3 server -dev ``` ```shell docker exec -it vault /bin/sh export VAULT_TOKEN='root' vault secrets enable -path=&quot;kv-v1&quot; kv / # vault kv put kv-v1/apisix/jack auth-key=auth-one Success! Data written to: kv-v1/apisix/jack / # vault kv get kv-v1/apisix/jack ====== Data ====== Key Value --- ----- auth-key auth-one ``` ``` # 1. create secret $ curl http://127.0.0.1:9180/apisix/admin/secrets/vault/mysecret \ -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;uri&quot;: &quot;http://127.0.0.1:8200&quot;, &quot;prefix&quot;: &quot;kv-v1/apisix&quot;, &quot;token&quot;: &quot;root&quot; }' {&quot;key&quot;:&quot;/apisix/secrets/vault/mysecret&quot;,&quot;value&quot;:{&quot;id&quot;:&quot;vault/mysecret&quot;,&quot;uri&quot;:&quot;http://127.0.0.1:8200&quot;,&quot;token&quot;:&quot;root&quot;,&quot;prefix&quot;:&quot;kv-v1/apisix&quot;,&quot;create_time&quot;:1705310640,&quot;update_time&quot;:1705310640}} # 2. create consumer $ curl http://127.0.0.1:9180/apisix/admin/consumers \ -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;username&quot;: &quot;jack&quot;, &quot;plugins&quot;: { &quot;key-auth&quot;: { &quot;key&quot;: &quot;$secret://vault/mysecret/jack/auth-key&quot; } } }' {&quot;key&quot;:&quot;/apisix/consumers/jack&quot;,&quot;value&quot;:{&quot;plugins&quot;:{&quot;key-auth&quot;:{&quot;key&quot;:&quot;$secret://vault/mysecret/jack/auth-key&quot;}},&quot;username&quot;:&quot;jack&quot;,&quot;update_time&quot;:1705310647,&quot;create_time&quot;:1705310647}} # 3. create route $ curl http://127.0.0.1:9180/apisix/admin/routes/1 \ -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -i -d ' { &quot;uri&quot;: &quot;/anything&quot;, &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;nodes&quot;: { &quot;httpbin.org&quot;: 1 } }, &quot;plugins&quot;: { &quot;key-auth&quot;: {} } }' HTTP/1.1 201 Created Date: Mon, 15 Jan 2024 09:24:13 GMT Content-Type: application/json Transfer-Encoding: chunked Connection: keep-alive Server: APISIX/3.2.2 Access-Control-Allow-Origin: * Access-Control-Allow-Credentials: true Access-Control-Expose-Headers: * Access-Control-Max-Age: 3600 X-API-VERSION: v3 {&quot;key&quot;:&quot;/apisix/routes/1&quot;,&quot;value&quot;:{&quot;plugins&quot;:{&quot;key-auth&quot;:{&quot;query&quot;:&quot;apikey&quot;,&quot;hide_credentials&quot;:false,&quot;header&quot;:&quot;apikey&quot;}},&quot;status&quot;:1,&quot;id&quot;:&quot;1&quot;,&quot;uri&quot;:&quot;/anything&quot;,&quot;upstream&quot;:{&quot;pass_host&quot;:&quot;pass&quot;,&quot;nodes&quot;:{&quot;httpbin.org&quot;:1},&quot;type&quot;:&quot;roundrobin&quot;,&quot;hash_on&quot;:&quot;vars&quot;,&quot;scheme&quot;:&quot;http&quot;},&quot;priority&quot;:0,&quot;create_time&quot;:1705310653,&quot;update_time&quot;:1705310653}} # 4. send request, return 200 $ curl http://127.0.0.1:9080/anything -H &quot;apikey: auth-one&quot; -v * Uses proxy env variable no_proxy == '192.168.49.2,localhost,127.0.0.1' * Trying 127.0.0.1:9080... * Connected to 127.0.0.1 (127.0.0.1) port 9080 &gt; GET /anything HTTP/1.1 &gt; Host: 127.0.0.1:9080 &gt; User-Agent: curl/8.4.0 &gt; Accept: */* &gt; apikey: auth-one &gt; &lt; HTTP/1.1 200 OK &lt; Content-Type: application/json &lt; Content-Length: 413 &lt; Connection: keep-alive &lt; Date: Mon, 15 Jan 2024 09:25:26 GMT &lt; Access-Control-Allow-Origin: * &lt; Access-Control-Allow-Credentials: true &lt; Server: APISIX/3.2.2 &lt; { &quot;args&quot;: {}, &quot;data&quot;: &quot;&quot;, &quot;files&quot;: {}, &quot;form&quot;: {}, &quot;headers&quot;: { &quot;Accept&quot;: &quot;*/*&quot;, &quot;Apikey&quot;: &quot;auth-one&quot;, &quot;Host&quot;: &quot;127.0.0.1&quot;, &quot;User-Agent&quot;: &quot;curl/8.4.0&quot;, &quot;X-Amzn-Trace-Id&quot;: &quot;Root=1-65a4fa06-6d7a8d426c9a503a56b23c81&quot;, &quot;X-Forwarded-Host&quot;: &quot;127.0.0.1&quot; }, &quot;json&quot;: null, &quot;method&quot;: &quot;GET&quot;, &quot;origin&quot;: &quot;127.0.0.1, 58.253.51.238&quot;, &quot;url&quot;: &quot;http://127.0.0.1/anything&quot; } * Connection #0 to host 127.0.0.1 left intact # 5. delete secret $ curl http://127.0.0.1:9180/apisix/admin/secrets/vault/mysecret \ -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X DELETE {&quot;deleted&quot;:&quot;1&quot;,&quot;key&quot;:&quot;/apisix/secrets/vault/mysecret&quot;} # 6. get secret $ curl http://127.0.0.1:9180/apisix/admin/secrets/vault/mysecret \ -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X GET {&quot;message&quot;:&quot;Key not found&quot;} # 7. update consumer for refresh lrucache $ curl http://127.0.0.1:9180/apisix/admin/consumers \ -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;username&quot;: &quot;jack&quot;, &quot;plugins&quot;: { &quot;key-auth&quot;: { &quot;key&quot;: &quot;$secret://vault/mysecret/jack/auth-key&quot; } } }' {&quot;key&quot;:&quot;/apisix/consumers/jack&quot;,&quot;value&quot;:{&quot;plugins&quot;:{&quot;key-auth&quot;:{&quot;key&quot;:&quot;$secret://vault/mysecret/jack/auth-key&quot;}},&quot;username&quot;:&quot;jack&quot;,&quot;update_time&quot;:1705310750,&quot;create_time&quot;:1705310647}} # 8. send request, then return 500 $ curl http://127.0.0.1:9080/anything -H &quot;apikey: auth-one&quot; -v * Uses proxy env variable no_proxy == '192.168.49.2,localhost,127.0.0.1' * Trying 127.0.0.1:9080... * Connected to 127.0.0.1 (127.0.0.1) port 9080 &gt; GET /anything HTTP/1.1 &gt; Host: 127.0.0.1:9080 &gt; User-Agent: curl/8.4.0 &gt; Accept: */* &gt; apikey: auth-one &gt; &lt; HTTP/1.1 500 Internal Server Error &lt; Date: Mon, 15 Jan 2024 09:25:54 GMT &lt; Content-Type: text/html; charset=utf-8 &lt; Content-Length: 174 &lt; Connection: close &lt; Server: APISIX/3.2.2 &lt; &lt;html&gt; &lt;head&gt;&lt;title&gt;500 Internal Server Error&lt;/title&gt;&lt;/head&gt; &lt;body&gt; &lt;center&gt;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&lt;/center&gt; &lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt; &lt;/body&gt; &lt;/html&gt; * Closing connection ``` ### Environment - APISIX version (run `apisix version`): https://github.com/apache/apisix/tree/release/3.2 - Operating system (run `uname -a`): - OpenResty / Nginx version (run `openresty -V` or `nginx -V`): - etcd version, if relevant (run `curl http://127.0.0.1:9090/v1/server_info`): - APISIX Dashboard version, if relevant: - Plugin runner version, for issues related to plugin runners: - LuaRocks version, for installation issues (run `luarocks --version`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>36</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: Add forward-auth plugin exception configuration status_on_error (#10898)</MESSAGE>
    <SHA>3faeff6178bb7b24aa79da19878ba9607af37eb0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: when delete the secret cause 500 error #10823</MESSAGE>
      <SHA>9bc50c5aed55a490def26b59336aed78eae4f32e</SHA>
      <PATCHEDFILES>
        <FILE>apisix/secret.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: when delete the secret cause 500 error #10823</MESSAGE>
      <SHA>bdf467f86ecb1d7c95afff002c41c4a39c71f73d</SHA>
      <PATCHEDFILES>
        <FILE>apisix/secret.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
