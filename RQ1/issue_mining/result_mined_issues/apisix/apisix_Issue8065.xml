<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8065</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/8065</ISSUEURL>
  <TITLE>bug: batch_process:push method failed in 2.15.0</TITLE>
  <DESCRIPTION>### Current Behavior Method &quot;batch_process:push&quot; in batch-processor.lua report error: attempt to index a nil value. ` if prometheus and not batch_metrics and self.name and self.route_id and self.server_addr then batch_metrics = prometheus.get_prometheus():gauge(&quot;batch_process_entries&quot;, &quot;batch process remaining entries&quot;, {&quot;name&quot;, &quot;route_id&quot;, &quot;server_addr&quot;}) end` the code determine prometheus but not prometheus.get_prometheus() . ### Expected Behavior In the version 2.12, the code is different and it works. `if not batch_metrics and prometheus.get_prometheus() and self.name and self.route_id and self.server_addr then batch_metrics = prometheus.get_prometheus():gauge(&quot;batch_process_entries&quot;, &quot;batch process remaining entries&quot;, {&quot;name&quot;, &quot;route_id&quot;, &quot;server_addr&quot;}) end` The code use &quot;if not batch_metrics and **prometheus.get_prometheus()** &quot;, so it works well. ### Error Logs 2022/10/10 19:07:52 [error] 15074#0: *1109498 failed to run log_by_lua*: .../software/apisix-2.15.0/apisix/utils/batch-processor.lua:189: attempt to index a nil value stack traceback: .../software/apisix-2.15.0/apisix/utils/batch-processor.lua:189: in function 'push' ...e/apisix-2.15.0/apisix/utils/batch-processor-manager.lua:121: in function 'add_entry_to_new_processor' ### Steps to Reproduce 1.Run apisix in docker without promethus. 2.config a route with kafka-logger 3.fire a request, get the error. ### Environment - APISIX version 2.15 (run `apisix version`): - Operating system linux (run `uname -a`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: integrate grpc-client-nginx-module in APISIX (#7917)</MESSAGE>
    <SHA>9129572f6302300ddeee3f2234393445d8ead781</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: check prometheus init status before use in batch processor (#8065)</MESSAGE>
      <SHA>6f11834e8d02f2302e092f87e27970e9e18ba1f0</SHA>
      <PATCHEDFILES>
        <FILE>apisix/utils/batch-processor.lua</FILE>
        <FILE>t/plugin/kafka-logger.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: check prometheus init status before use in batch processor (#8065) (#8079)</MESSAGE>
      <SHA>df640778a1e26e1781e6a14ccb0d32c4c383f6c5</SHA>
      <PATCHEDFILES>
        <FILE>apisix/utils/batch-processor.lua</FILE>
        <FILE>t/plugin/kafka-logger.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: check prometheus init status before use in batch processor (#8065) (#8079)</MESSAGE>
      <SHA>2edf2c91008b1845381ec342cf0f8217333c39be</SHA>
      <PATCHEDFILES>
        <FILE>apisix/utils/batch-processor.lua</FILE>
        <FILE>t/plugin/kafka-logger.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
