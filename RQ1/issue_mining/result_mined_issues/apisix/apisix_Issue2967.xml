<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2967</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/2967</ISSUEURL>
  <TITLE>request help: In some plugins, directly use the code for parameter verification, we need to replace it with JSONSchema verification</TITLE>
  <DESCRIPTION>## Background In Apache APISIX Dashboard, we use a JSONSchema synchronized from APISIX for parameter verification. However, during the development and testing process, we found that there are still some plugins that directly use code for parameter verification, instead of using JSONSchema verification. Here is an example: https://github.com/apache/apisix/blob/master/apisix/plugins/jwt-auth.lua#L109-L124 ## Issues with the current solution 1. Not clear enough, many people may not know that there are special codes for parameter verification besides JSONSchema verification, and subsequent maintenance is also troublesome. 2. In the Dashboard, both the FE and `Manager API` need to synchronize these code changes, which becomes very cumbersome, and it is likely to cause problems due to missing or untimely synchronization. ## Suggested changes 1. All parameter verification should be verified with JSONSchema as much as possible, except for those that JSONSchema cannot achieve 2. Newly added plug-ins in the future should also follow this specification. ## Related plugins - [x] jwt-auth - [x] ip-restriction - [x] openid-connect - [x] redirect - [ ] response-rewrite - [ ] request-validation - [ ] cors - [ ] proxy-rewrite - [ ] proxy-cache (need to read `conf/config.yaml` in APISIX to check cache zone ) - [ ] uri-blocker (regular expression in Lua and `ngx.re`)</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>14</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>test: solve conflict between #2993 and #2943 (#2997) Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>9918efbe5ba8b367550a5ea64aa6de3f5183ca7f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: rewrite handwriting validation with jsonschema Fix #2967. Some plugins can't be rewritten, so I have to keep them. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>d2274f001ad5de896a934a2de2736356966a5449</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ip-restriction.lua</FILE>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
        <FILE>apisix/plugins/limit-count.lua</FILE>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
        <FILE>apisix/plugins/redirect.lua</FILE>
        <FILE>apisix/plugins/serverless/init.lua</FILE>
        <FILE>apisix/schema_def.lua</FILE>
        <FILE>doc/plugins/openid-connect.md</FILE>
        <FILE>doc/plugins/redirect.md</FILE>
        <FILE>doc/zh-cn/plugins/openid-connect.md</FILE>
        <FILE>doc/zh-cn/plugins/redirect.md</FILE>
        <FILE>rockspec/apisix-master-0.rockspec</FILE>
        <FILE>t/plugin/ip-restriction.t</FILE>
        <FILE>t/plugin/jwt-auth.t</FILE>
        <FILE>t/plugin/openid-connect.t</FILE>
        <FILE>t/plugin/redirect.t</FILE>
        <FILE>t/plugin/serverless.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: rewrite handwriting validation with jsonschema Fix #2967. Some plugins can't be rewritten, so I have to keep them. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>28270c88374a97f28d52a4685ca323e660268bae</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ip-restriction.lua</FILE>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
        <FILE>apisix/plugins/limit-count.lua</FILE>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
        <FILE>apisix/plugins/redirect.lua</FILE>
        <FILE>apisix/plugins/serverless/init.lua</FILE>
        <FILE>apisix/schema_def.lua</FILE>
        <FILE>doc/plugins/openid-connect.md</FILE>
        <FILE>doc/plugins/redirect.md</FILE>
        <FILE>doc/zh-cn/plugins/openid-connect.md</FILE>
        <FILE>doc/zh-cn/plugins/redirect.md</FILE>
        <FILE>rockspec/apisix-master-0.rockspec</FILE>
        <FILE>t/plugin/ip-restriction.t</FILE>
        <FILE>t/plugin/jwt-auth.t</FILE>
        <FILE>t/plugin/openid-connect.t</FILE>
        <FILE>t/plugin/redirect.t</FILE>
        <FILE>t/plugin/serverless.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: rewrite handwriting validation with jsonschema Fix #2967. Some plugins can't be rewritten, so I have to keep them. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>3a2fec84b07299150aad48b9bde64d35d1e87736</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ip-restriction.lua</FILE>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
        <FILE>apisix/plugins/limit-count.lua</FILE>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
        <FILE>apisix/plugins/redirect.lua</FILE>
        <FILE>apisix/plugins/serverless/init.lua</FILE>
        <FILE>apisix/schema_def.lua</FILE>
        <FILE>doc/plugins/openid-connect.md</FILE>
        <FILE>doc/plugins/redirect.md</FILE>
        <FILE>doc/zh-cn/plugins/openid-connect.md</FILE>
        <FILE>doc/zh-cn/plugins/redirect.md</FILE>
        <FILE>rockspec/apisix-master-0.rockspec</FILE>
        <FILE>t/plugin/ip-restriction.t</FILE>
        <FILE>t/plugin/jwt-auth.t</FILE>
        <FILE>t/plugin/openid-connect.t</FILE>
        <FILE>t/plugin/redirect.t</FILE>
        <FILE>t/plugin/serverless.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: rewrite handwriting validation with jsonschema Fix #2967. Some plugins can't be rewritten, so I have to keep them. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>7b6c3e349cdc1ba2aacd77ed2a7e5bab99ae5a2f</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ip-restriction.lua</FILE>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
        <FILE>apisix/plugins/limit-count.lua</FILE>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
        <FILE>apisix/plugins/redirect.lua</FILE>
        <FILE>apisix/plugins/serverless/init.lua</FILE>
        <FILE>apisix/schema_def.lua</FILE>
        <FILE>doc/plugins/openid-connect.md</FILE>
        <FILE>doc/plugins/redirect.md</FILE>
        <FILE>doc/zh-cn/plugins/openid-connect.md</FILE>
        <FILE>doc/zh-cn/plugins/redirect.md</FILE>
        <FILE>rockspec/apisix-master-0.rockspec</FILE>
        <FILE>t/admin/health-check.t</FILE>
        <FILE>t/admin/plugin-metadata.t</FILE>
        <FILE>t/admin/routes.t</FILE>
        <FILE>t/admin/upstream.t</FILE>
        <FILE>t/node/invalid-upstream.t</FILE>
        <FILE>t/node/route-status.t</FILE>
        <FILE>t/plugin/batch-requests.t</FILE>
        <FILE>t/plugin/ip-restriction.t</FILE>
        <FILE>t/plugin/jwt-auth.t</FILE>
        <FILE>t/plugin/limit-count.t</FILE>
        <FILE>t/plugin/openid-connect.t</FILE>
        <FILE>t/plugin/proxy-rewrite.t</FILE>
        <FILE>t/plugin/redirect.t</FILE>
        <FILE>t/plugin/serverless.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: rewrite handwriting validation with jsonschema Fix #2967. Some plugins can't be rewritten, so I have to keep them. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>9b73ddbc39228b6b79ba692ad44eea7fc0ec363e</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ip-restriction.lua</FILE>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
        <FILE>apisix/plugins/limit-count.lua</FILE>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
        <FILE>apisix/plugins/redirect.lua</FILE>
        <FILE>apisix/plugins/serverless/init.lua</FILE>
        <FILE>apisix/schema_def.lua</FILE>
        <FILE>doc/plugins/openid-connect.md</FILE>
        <FILE>doc/plugins/redirect.md</FILE>
        <FILE>doc/zh-cn/plugins/openid-connect.md</FILE>
        <FILE>doc/zh-cn/plugins/redirect.md</FILE>
        <FILE>rockspec/apisix-master-0.rockspec</FILE>
        <FILE>t/admin/health-check.t</FILE>
        <FILE>t/admin/plugin-metadata.t</FILE>
        <FILE>t/admin/routes.t</FILE>
        <FILE>t/admin/upstream.t</FILE>
        <FILE>t/node/invalid-upstream.t</FILE>
        <FILE>t/node/route-status.t</FILE>
        <FILE>t/plugin/batch-requests.t</FILE>
        <FILE>t/plugin/ip-restriction.t</FILE>
        <FILE>t/plugin/jwt-auth.t</FILE>
        <FILE>t/plugin/limit-count.t</FILE>
        <FILE>t/plugin/openid-connect.t</FILE>
        <FILE>t/plugin/proxy-rewrite.t</FILE>
        <FILE>t/plugin/redirect.t</FILE>
        <FILE>t/plugin/response-rewrite.t</FILE>
        <FILE>t/plugin/serverless.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: rewrite handwriting validation with jsonschema (#3021) Fix #2967. Some plugins can't be rewritten, so I have to keep them. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>fd2db606a96c8d6d9bb266b94e1a76ae8962e720</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/ip-restriction.lua</FILE>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
        <FILE>apisix/plugins/limit-count.lua</FILE>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
        <FILE>apisix/plugins/redirect.lua</FILE>
        <FILE>apisix/plugins/serverless/init.lua</FILE>
        <FILE>apisix/schema_def.lua</FILE>
        <FILE>doc/plugins/openid-connect.md</FILE>
        <FILE>doc/plugins/redirect.md</FILE>
        <FILE>doc/zh-cn/plugins/openid-connect.md</FILE>
        <FILE>doc/zh-cn/plugins/redirect.md</FILE>
        <FILE>rockspec/apisix-master-0.rockspec</FILE>
        <FILE>t/admin/health-check.t</FILE>
        <FILE>t/admin/plugin-metadata.t</FILE>
        <FILE>t/admin/routes.t</FILE>
        <FILE>t/admin/upstream.t</FILE>
        <FILE>t/core/schema_def.t</FILE>
        <FILE>t/node/invalid-upstream.t</FILE>
        <FILE>t/node/route-status.t</FILE>
        <FILE>t/plugin/batch-requests.t</FILE>
        <FILE>t/plugin/ip-restriction.t</FILE>
        <FILE>t/plugin/jwt-auth.t</FILE>
        <FILE>t/plugin/limit-count.t</FILE>
        <FILE>t/plugin/openid-connect.t</FILE>
        <FILE>t/plugin/proxy-rewrite.t</FILE>
        <FILE>t/plugin/redirect.t</FILE>
        <FILE>t/plugin/response-rewrite.t</FILE>
        <FILE>t/plugin/serverless.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
