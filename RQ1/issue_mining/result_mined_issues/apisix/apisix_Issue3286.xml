<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3286</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3286</ISSUEURL>
  <TITLE>bug: apisix/plugin.lua init_worker prometheus.exporter init should happen before _M.load()</TITLE>
  <DESCRIPTION>### Issue description Our custom plugins rely on `apisix.plugins.prometheus.exporter.get_prometheus()` return an initialized prometheus instance to create metrics. ### Environment * apisix version (cmd: `apisix version`): 2.2 ### What's the actual result? (including assertion message &amp; call stack if applicable) When apisix start, custom plugins init first, and `apisix.plugins.prometheus.exporter.get_prometheus()` return nil, cause error `attempt to index a nil value`. apisix/plugin.lua: ```lua function _M.init_worker() _M.load() -- some plugins need to be initialized in init* phases if ngx.config.subsystem == &quot;http&quot; then require(&quot;apisix.plugins.prometheus.exporter&quot;).init() end ...... end ```</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix(traffic-split): the header set in vars cannot have a horizontal line (#3310) fix #3306</MESSAGE>
    <SHA>a1dd370962a39be652e03978a37231660a2641b6</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>optimize: prometheus.exporter should init before plugins apache/apisix#3286 (#3296) Co-authored-by: roketyyang &lt;roketyyang@tencent.com&gt; close #3286</MESSAGE>
      <SHA>a773a8fbe9236cf2dcf2d08182144b6e7ab906f5</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugin.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
