<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3079</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3079</ISSUEURL>
  <TITLE>apisix转发流量错误</TITLE>
  <DESCRIPTION>### Issue description apisix按照如下配置时，有一定几率会转发流量错误 ### Environment * apisix version (2.1): * OS: centos7.8 ## 描述 三个域名对应三个route，假定a b c,两个上游 ，假定 x y，其中xy都只有一个节点，roundrobin,权重1，对应关系为 a-&gt;x ,b c -&gt;y, 在转发流量的过程中，当qps在&gt;50之后，约有8%-15%的流量会转发错误，即a-&gt;y,b-&gt;x，经验证x，y获取到的所有header是客户正常发送的，apisix却分派错了 ## 具体配置如下 ### upstreams： ``` &quot;action&quot;:&quot;get&quot;, &quot;node&quot;:{ &quot;nodes&quot;:[ { &quot;createdIndex&quot;:2, &quot;modifiedIndex&quot;:2, &quot;key&quot;:&quot;\/apisix\/upstreams\/333621554711626091&quot;, &quot;value&quot;:{ &quot;nodes&quot;:[ { &quot;host&quot;:&quot;172.16.27.9&quot;, &quot;port&quot;:8088, &quot;weight&quot;:1 } ], &quot;id&quot;:&quot;333621554711626091&quot;, &quot;name&quot;:&quot;ceshi-upstream&quot;, &quot;update_time&quot;:1608383542, &quot;type&quot;:&quot;roundrobin&quot;, &quot;create_time&quot;:1608383542, &quot;timeout&quot;:{ &quot;connect&quot;:6000, &quot;read&quot;:6000, &quot;send&quot;:6000 } } }, { &quot;createdIndex&quot;:3, &quot;modifiedIndex&quot;:3, &quot;key&quot;:&quot;\/apisix\/upstreams\/333621685657796971&quot;, &quot;value&quot;:{ &quot;nodes&quot;:[ { &quot;host&quot;:&quot;172.16.27.2&quot;, &quot;port&quot;:8087, &quot;weight&quot;:1 } ], &quot;id&quot;:&quot;333621685657796971&quot;, &quot;name&quot;:&quot;dz11ht-upstream&quot;, &quot;update_time&quot;:1608383620, &quot;type&quot;:&quot;roundrobin&quot;, &quot;create_time&quot;:1608383620, &quot;timeout&quot;:{ &quot;connect&quot;:6000, &quot;read&quot;:6000, &quot;send&quot;:6000 } } }, { &quot;createdIndex&quot;:4, &quot;modifiedIndex&quot;:4, &quot;key&quot;:&quot;\/apisix\/upstreams\/333621748001931627&quot;, &quot;value&quot;:{ &quot;nodes&quot;:[ { &quot;host&quot;:&quot;172.16.27.2&quot;, &quot;port&quot;:8086, &quot;weight&quot;:1 } ], &quot;id&quot;:&quot;333621748001931627&quot;, &quot;name&quot;:&quot;dz11-front-upstream&quot;, &quot;update_time&quot;:1608383657, &quot;type&quot;:&quot;roundrobin&quot;, &quot;create_time&quot;:1608383657, &quot;timeout&quot;:{ &quot;connect&quot;:6000, &quot;read&quot;:6000, &quot;send&quot;:6000 } } } ], &quot;dir&quot;:true, &quot;createdIndex&quot;:10, &quot;key&quot;:&quot;\/apisix\/upstreams&quot;, &quot;modifiedIndex&quot;:76 }, &quot;count&quot;:&quot;4&quot;, &quot;header&quot;:{ &quot;raft_term&quot;:&quot;2&quot;, &quot;member_id&quot;:&quot;10276657743932975437&quot;, &quot;revision&quot;:&quot;86&quot;, &quot;cluster_id&quot;:&quot;14841639068965178418&quot; } } ``` ### route ``` { &quot;action&quot;:&quot;get&quot;, &quot;node&quot;:{ &quot;nodes&quot;:[ { &quot;createdIndex&quot;:5, &quot;modifiedIndex&quot;:20, &quot;key&quot;:&quot;\/apisix\/routes\/333621797343723883&quot;, &quot;value&quot;:{ &quot;id&quot;:&quot;333621797343723883&quot;, &quot;vars&quot;:{ }, &quot;methods&quot;:[ &quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot; ], &quot;hosts&quot;:[ &quot;ceshi.abc.com&quot; ], &quot;uris&quot;:[ &quot;\/*&quot; ], &quot;update_time&quot;:1608384782, &quot;create_time&quot;:1608383687, &quot;upstream_id&quot;:&quot;333621554711626091&quot;, &quot;name&quot;:&quot;ceshi-route&quot; } }, { &quot;createdIndex&quot;:6, &quot;modifiedIndex&quot;:6, &quot;key&quot;:&quot;\/apisix\/routes\/333622024255570283&quot;, &quot;value&quot;:{ &quot;id&quot;:&quot;333622024255570283&quot;, &quot;vars&quot;:{ }, &quot;methods&quot;:[ &quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot; ], &quot;hosts&quot;:[ &quot;dz11ht.abc.com&quot; ], &quot;uris&quot;:[ &quot;\/*&quot; ], &quot;update_time&quot;:1608383822, &quot;create_time&quot;:1608383822, &quot;upstream_id&quot;:&quot;333621685657796971&quot;, &quot;name&quot;:&quot;dz1-route&quot; } }, { &quot;createdIndex&quot;:7, &quot;modifiedIndex&quot;:7, &quot;key&quot;:&quot;\/apisix\/routes\/333622061215777131&quot;, &quot;value&quot;:{ &quot;id&quot;:&quot;333622061215777131&quot;, &quot;vars&quot;:{ }, &quot;methods&quot;:[ &quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot; ], &quot;hosts&quot;:[ &quot;dzhtabc.com&quot; ], &quot;uris&quot;:[ &quot;\/*&quot; ], &quot;update_time&quot;:1608383844, &quot;create_time&quot;:1608383844, &quot;upstream_id&quot;:&quot;333621685657796971&quot;, &quot;name&quot;:&quot;httest-api-route&quot; } }, { &quot;createdIndex&quot;:21, &quot;modifiedIndex&quot;:21, &quot;key&quot;:&quot;\/apisix\/routes\/333623666443026795&quot;, &quot;value&quot;:{ &quot;id&quot;:&quot;333623666443026795&quot;, &quot;vars&quot;:{ }, &quot;methods&quot;:[ &quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot; ], &quot;hosts&quot;:[ &quot;test.abc.com&quot; ], &quot;uris&quot;:[ &quot;\/*&quot; ], &quot;update_time&quot;:1608384801, &quot;create_time&quot;:1608384801, &quot;upstream_id&quot;:&quot;333621554711626091&quot;, &quot;name&quot;:&quot;test-api-route&quot; } }, { &quot;createdIndex&quot;:34, &quot;modifiedIndex&quot;:35, &quot;key&quot;:&quot;\/apisix\/routes\/333627619691987307&quot;, &quot;value&quot;:{ &quot;id&quot;:&quot;333627619691987307&quot;, &quot;vars&quot;:{ }, &quot;methods&quot;:[ &quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot; ], &quot;hosts&quot;:[ &quot;dz11.abccom&quot; ], &quot;uris&quot;:[ &quot;\/*&quot; ], &quot;update_time&quot;:1608388794, &quot;create_time&quot;:1608387157, &quot;upstream_id&quot;:&quot;333621748001931627&quot;, &quot;name&quot;:&quot;dzfw-route&quot; } } ], &quot;dir&quot;:true, &quot;createdIndex&quot;:9, &quot;key&quot;:&quot;\/apisix\/routes&quot;, &quot;modifiedIndex&quot;:75 }, &quot;count&quot;:&quot;6&quot;, &quot;header&quot;:{ &quot;raft_term&quot;:&quot;2&quot;, &quot;member_id&quot;:&quot;10276657743932975437&quot;, &quot;revision&quot;:&quot;86&quot;, &quot;cluster_id&quot;:&quot;14841639068965178418&quot; } } ``` ### What's the actual result? (including assertion message &amp; call stack if applicable) ### What's the expected result?</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: validate certificate &amp; key (#3085) Fix #296 Fix #2816 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>966d68829add34d11695998af4e3035a0a473908</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: ctx being contaminated due to a new feature of openresty 1.19 (#3105) Fix #3079</MESSAGE>
      <SHA>5de99904467db5b71e8df4c1f22444eb9d4223b7</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
