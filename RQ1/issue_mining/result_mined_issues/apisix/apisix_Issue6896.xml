<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6896</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/6896</ISSUEURL>
  <TITLE>bug: mtls does not take effect</TITLE>
  <DESCRIPTION>### Current Behavior 配置 ssl 资源同时配置了 client.ca 和 client.depth 参数，在upstream配置了client_cert和client_key。使用浏览器访问时并未配置对应证书，第一次响应返回400，查看日志发现错误：client certificate was not present，此现象正常；紧接着第二次再次访问发现可以获取到后置服务正常响应。 ### Expected Behavior 期望使用浏览器在未携带对应双向认证证书时，不能正常获取到响应结果。 ### Error Logs client certificate was not present ### Steps to Reproduce 1.配置路由并添加upstream，在upstream中配置client_cert和client_key 2.配置 ssl 资源同时配置了 client.ca 和 client.depth 参数 3.使用谷歌浏览器访问，第一次响应400，第二次正常获取到结果 ### Environment - APISIX version (run `apisix version`): V2.8 - Operating system (run `uname -a`): Centos7 - OpenResty / Nginx version (run `openresty -V` or `nginx -V`): - etcd version, if relevant (run `curl http://127.0.0.1:9090/v1/server_info`): - APISIX Dashboard version, if relevant: - Plugin runner version, for issues related to plugin runners: - LuaRocks version, for installation issues (run `luarocks --version`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: update prowered-by.md (#6894)</MESSAGE>
    <SHA>d67e8921597fe77ebb87b4d855a1659251efb3d6</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set A more suitable way is to reject client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>be966df141996cae06c895145c4e90c2ad90fc5e</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set (#6906) A more suitable way is to reject the client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>bf5585a9716ce6b272bd1e8d01e4f913b3520871</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set (#6906) A more suitable way is to reject the client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>37485707a6ee8a093ac878cc7aaa83bc0694a1e0</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set (#6906) A more suitable way is to reject the client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>80b6b2d213d5f6e09e3fb3387f150d4e9bc58d2b</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set (#6906) A more suitable way is to reject the client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>83153d169272882be74c2edbfc9dd650424aad6d</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set (#6906) A more suitable way is to reject the client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>c2eff65dca402ec2e6502be3daef1c9eac52f9af</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set (#6906) A more suitable way is to reject the client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>94f798eacba0194d2f6dd50a4d77e347614fbd6f</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set (#6906) A more suitable way is to reject the client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>2b0260f3e74cb21d4719c8d62eabcca7d5fe753f</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the client verify flag might not be set (#6906) A more suitable way is to reject the client TLS handshake directly, just like what Go has done. Fix #6896 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>819278a4e5c261e8c99b348078b3fa7442c2d3ea</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/ssl/router/radixtree_sni.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
