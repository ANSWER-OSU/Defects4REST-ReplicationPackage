<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1851</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/1851</ISSUEURL>
  <TITLE>health check can't use</TITLE>
  <DESCRIPTION>环境： version: v1.4.0 路由和upstream配置： ``` curl -i --connect-timeout 1 http://127.0.0.1:9080/apisix/admin/routes/4444 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;methods&quot;: [&quot;POST&quot;, &quot;GET&quot;,&quot;DELETE&quot;], &quot;uri&quot;: &quot;/xxxx/v1/readiness&quot;, &quot;plugins&quot;: { }, &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;nodes&quot;: { &quot;10.82.4.112:10188&quot;: 1, &quot;10.82.4.112:10190&quot;: 1 }, &quot;checks&quot;: { &quot;active&quot;: { &quot;http_path&quot;: &quot;/xxxx/v1/liveness&quot;, &quot;host&quot;: &quot;health.com&quot;, &quot;healthy&quot;: { &quot;interval&quot;: 4, &quot;successes&quot;: 1 }, &quot;unhealthy&quot;: { &quot;interval&quot;: 5, &quot;http_failures&quot;: 1 } } } } }' ``` 当客户端发起访问时，报如下错误： failed to run balancer_by_lua*: /usr/local/openresty/lualib/resty/lock.lua:153: API disabled in the context of balancer_by_lua*</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>179</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ci: simplify the if condition (#3206)</MESSAGE>
    <SHA>d030d3c3235531f6aefb86e6de58d41f7aac366b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: create the health checker in `access` phase Allow to call yield function in the healthcheck. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt; Co-authored-by: YuanSheng Wang &lt;membphis@gmail.com&gt; Fix #1851 Fix #2842 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>3262623974732b8cdea2ba5045fa1260c7cd583c</SHA>
      <PATCHEDFILES>
        <FILE>apisix/balancer.lua</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>t/discovery/eureka.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: create the health checker in `access` phase Allow to call yield function in the healthcheck. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt; Co-authored-by: YuanSheng Wang &lt;membphis@gmail.com&gt; Fix #1851 Fix #2842 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>2553b65f5d17dd4ec7afcccd09b468a6c7bae780</SHA>
      <PATCHEDFILES>
        <FILE>apisix/balancer.lua</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>t/discovery/eureka.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: create the health checker in `access` phase (#3240) Allow to call yield function in the healthcheck. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt; Co-authored-by: YuanSheng Wang &lt;membphis@gmail.com&gt; Fix #1851 Fix #2842</MESSAGE>
      <SHA>079dabb359089d1378700aaf4ff9a947b2f3675d</SHA>
      <PATCHEDFILES>
        <FILE>apisix/balancer.lua</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>t/discovery/eureka.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
