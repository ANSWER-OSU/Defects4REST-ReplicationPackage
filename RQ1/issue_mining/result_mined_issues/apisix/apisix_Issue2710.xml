<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2710</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/2710</ISSUEURL>
  <TITLE>bug(hmac-auth): when the request contains escape characters, the signature verification fails</TITLE>
  <DESCRIPTION>### Issue description In different programming language environments, the escape characters of parameters in `uri` have the difference between uppercase and lowercase letters, and they all represent the same characters. In the `hmac-auth` plugin, the parameters in `uri` are uniformly escaped with `escape_uri`, which will convert lowercase letters in escaped characters to uppercase letters. Eventually, the signature in the request will be inconsistent with the signature generated by the `hmac-auth` plugin, and the signature verification will fail. I think a feasible solution: add an `enable_encode` (Boolean type) field in `schema` to control whether to enable `uri` escape. In order to maintain backward compatibility, the `escape_uri` method is used by default (`enable_encode` is true). When `enable_encode` is false, the `escape_uri` is not used. What do you think? Welcome to discuss together. ### Environment * apisix version (cmd: `apisix version`): 2.0 * OS: Example: 1.Add a line of logging code below line 204 of the `hmac-auth` plugin to print the characters escaped by `escape_uri`. ``` core.log.info(&quot;query: &quot;, escape_uri(key) .. &quot;=&quot; .. escape_uri(param)) ``` &lt;img width=&quot;759&quot; alt=&quot;截屏2020-11-11 下午5 19 10&quot; src=&quot;https://user-images.githubusercontent.com/52862365/98793152-71c35400-2442-11eb-9b7e-e553e24b5371.png&quot;&gt; 2.Add test case with lowercase letter escape characters in the `hmac-auth.t` file. ``` === TEST 35: test escape_uri --- config location /t { content_by_lua_block { local t = require(&quot;lib.test_admin&quot;).test local code, body = t('/apisix/admin/routes/1', ngx.HTTP_PUT, [[{ &quot;plugins&quot;: { &quot;hmac-auth&quot;: {} }, &quot;upstream&quot;: { &quot;nodes&quot;: { &quot;127.0.0.1:1980&quot;: 1 }, &quot;type&quot;: &quot;roundrobin&quot; }, &quot;uri&quot;: &quot;/hello&quot; }]] ) if code &gt;= 300 then ngx.status = code end ngx.say(body) } } --- request GET /t --- response_body passed --- no_error_log [error] === TEST 36: test escape_uri --- config location /t { content_by_lua_block { local t = require(&quot;lib.test_admin&quot;).test local code, body = t('/apisix/admin/consumers', ngx.HTTP_PUT, [[{ &quot;username&quot;: &quot;james&quot;, &quot;plugins&quot;: { &quot;hmac-auth&quot;: { &quot;access_key&quot;: &quot;my-access-key4&quot;, &quot;secret_key&quot;: &quot;my-secret-key4&quot; } } }]] ) if code &gt;= 300 then ngx.status = code end ngx.say(body) } } --- request GET /t --- response_body passed --- no_error_log [error] === TEST 37: The escape characters `%3e` and `%2c` with lowercase letters in the uri parameter --- config location /t { content_by_lua_block { local ngx_time = ngx.time local ngx_http_time = ngx.http_time local core = require(&quot;apisix.core&quot;) local t = require(&quot;lib.test_admin&quot;) local hmac = require(&quot;resty.hmac&quot;) local ngx_re = require(&quot;ngx.re&quot;) local ngx_encode_base64 = ngx.encode_base64 local data = {cert = &quot;ssl_cert&quot;, key = &quot;ssl_key&quot;, sni = &quot;test.com&quot;} local req_body = core.json.encode(data) req_body = req_body or &quot;&quot; local secret_key = &quot;my-secret-key4&quot; local timestamp = ngx_time() local gmt = ngx_http_time(timestamp) local access_key = &quot;my-access-key4&quot; local custom_header_a = &quot;asld$%dfasf&quot; local custom_header_b = &quot;23879fmsldfk&quot; local signing_string = { &quot;GET&quot;, &quot;/hello&quot;, &quot;name=rose%3ehello&amp;name2=james%2chello&quot;, access_key, gmt, &quot;x-custom-header-a:&quot; .. custom_header_a, &quot;x-custom-header-b:&quot; .. custom_header_b } signing_string = core.table.concat(signing_string, &quot;\n&quot;) .. &quot;\n&quot; core.log.info(&quot;signing_string:&quot;, signing_string) local signature = hmac:new(secret_key, hmac.ALGOS.SHA256):final(signing_string) core.log.info(&quot;signature:&quot;, ngx_encode_base64(signature)) local headers = {} headers[&quot;X-HMAC-SIGNATURE&quot;] = ngx_encode_base64(signature) headers[&quot;X-HMAC-ALGORITHM&quot;] = &quot;hmac-sha256&quot; headers[&quot;Date&quot;] = gmt headers[&quot;X-HMAC-ACCESS-KEY&quot;] = access_key headers[&quot;X-HMAC-SIGNED-HEADERS&quot;] = &quot;x-custom-header-a;x-custom-header-b&quot; headers[&quot;x-custom-header-a&quot;] = custom_header_a headers[&quot;x-custom-header-b&quot;] = custom_header_b local code, body = t.test('/hello?name=rose%3ehello&amp;name2=james%2chello', ngx.HTTP_GET, req_body, nil, headers ) if code &gt;= 300 then ngx.status = code end ngx.say(body) } } --- request GET /t --- response_body passed --- no_error_log [error] ``` 3.Test case execution result &lt;img width=&quot;718&quot; alt=&quot;截屏2020-11-11 下午6 02 39&quot; src=&quot;https://user-images.githubusercontent.com/52862365/98798038-5fe4af80-2448-11eb-922f-6302031cfcaf.png&quot;&gt; View log： &lt;img width=&quot;564&quot; alt=&quot;截屏2020-11-11 下午6 06 34&quot; src=&quot;https://user-images.githubusercontent.com/52862365/98798322-b8b44800-2448-11eb-96e1-54b911c7bccd.png&quot;&gt;</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: support ENV variable in configuration (#2743) Close #2675.</MESSAGE>
    <SHA>6b52811557fb9db004204acf0343c9ba455822ef</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(hmac-auth): when the request contains escape characters, the signature verification fails. fix #2710</MESSAGE>
      <SHA>f752ea4e814c27167dad10248c6aae6666dfa8c0</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/hmac-auth.lua</FILE>
        <FILE>t/plugin/hmac-auth.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(hmac-auth): when the request contains escape characters, the signature verification fails. fix #2710</MESSAGE>
      <SHA>b44f2751225192016c8975aff011e6a13553220a</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/hmac-auth.lua</FILE>
        <FILE>t/plugin/hmac-auth.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(hmac-auth): when the request contains escape characters, the signature verification fails. fix #2710</MESSAGE>
      <SHA>bd6e62fd624589e396aa0cc5de1a11228c948909</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/hmac-auth.lua</FILE>
        <FILE>t/plugin/hmac-auth.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(hmac-auth): when the request contains escape characters, the signature verification fails (#2749) fix #2710</MESSAGE>
      <SHA>a6678c33c516edb28c6fb43be218633df307ef14</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/hmac-auth.lua</FILE>
        <FILE>doc/plugins/hmac-auth.md</FILE>
        <FILE>doc/zh-cn/plugins/hmac-auth.md</FILE>
        <FILE>t/plugin/hmac-auth.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
