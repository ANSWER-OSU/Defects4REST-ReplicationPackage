<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>10352</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/10352</ISSUEURL>
  <TITLE>oidc-connect plugin, and restricting access to endpoints using `scope`</TITLE>
  <DESCRIPTION>### Description Hello, I am using the Ingress Controller and I am trying to support the following scenario using OIDC - ClientID A should have access to Endpoints A,B - ClientID B should have access to Endpoints B,C All of them should be of type &quot;**client_credentials**&quot; And on top of a test route, I have the following definition: ``` apiVersion: apisix.apache.org/v2 kind: ApisixRoute metadata: name: echoserver-multiple-apisix namespace: ${kubernetes_namespace_v1.echonamespace2.metadata.0.name} spec: http: - name: echohttp match: hosts: - echo.k8s.orb.local paths: - &quot;/echo*&quot; backends: - serviceName: echoserver2-service servicePort: 80 plugins: - name: &quot;openid-connect&quot; enable: true config: client_id: &quot;apisix2&quot; client_secret: &quot;...&quot; discovery: &quot;http://keycloak-proxy.keycloak.svc.cluster.local/realms/apisixrealm/.well-known/openid-configuration&quot; introspection_endpoint: &quot;http://keycloak-proxy.keycloak.svc.cluster.local/realms/apisixrealm/protocol/openid-connect/token/introspect&quot; realm: &quot;apisixrealm&quot; scope: &quot;route1scope&quot; ``` I am using the OIDC plugin and Keycloak as my authentication provider. Although APISIX can provide access to the endpoints, with tokens accessed **it fails to deny access to clients that don't have the required scope**. No matter what scope I put in the `scope` parameter, it always allows anyone with a valid token (but without a scope) to access the route. Perhaps this is a relevant issue: https://github.com/apache/apisix/issues/1272 Therefore, I have two questions: - For the scenario originally described, can I have multiple OIDC plugins with different client IDs and secrets on top of a route to achieve what I want? (since multiple clients must be able to access the same route) - For the issue where the scopes are not taken into account, is there something I am missing or can do differently? - How can I restrict an API to specific scopes with the openid-connect plugin?</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>34</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>chore(deps): bump actions/github-script from 6 to 7 (#10487)</MESSAGE>
    <SHA>4aeda49d853e274289792008b4c14928ebb46a5d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>adding required_scopes check. #10352</MESSAGE>
      <SHA>84e66013553814adaa72724c5197d73763caed8e</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
