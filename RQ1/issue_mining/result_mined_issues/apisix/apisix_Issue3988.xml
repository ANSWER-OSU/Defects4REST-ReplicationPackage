<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3988</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3988</ISSUEURL>
  <TITLE>bug: limit-count may prevent more requests by mistake that should access normally in High concurrency scenarios</TITLE>
  <DESCRIPTION>### Issue description { &quot;count&quot;: 4000, &quot;key&quot;: &quot;server_addr&quot;, &quot;policy&quot;: &quot;redis-cluster&quot;, &quot;redis_cluster_nodes&quot;: [], &quot;rejected_code&quot;: 500, &quot;time_window&quot;: 1 } When the threshold not reached,a few requests are prevented by the limit-count plugin. The founction incoming, ttl and incrby opreations are not atomic. Maybe can use eval() to ensure it. ### Environment * apisix version : 2.0 * OS (cmd: `uname -a`): Linux 2020 x86_64 x86_64 x86_64 GNU/Linux * OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): openresty/1.19.3.1 ### Minimal test code / Steps to reproduce the issue 压测即可复现</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>13</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: release 2.5 (#3967) Co-authored-by: Yuelin Zheng &lt;2226815922@qq.com&gt; Co-authored-by: nic-chen &lt;33000667+nic-chen@users.noreply.github.com&gt;</MESSAGE>
    <SHA>359e0906c5a3f0149c0f6a44aff927d4c4eb8c6b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix #3988</MESSAGE>
      <SHA>1e974fc1c45d268c363fc501920f4ed7e9a4ff81</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/limit-count/limit-count-redis-cluster.lua</FILE>
        <FILE>apisix/plugins/limit-count/limit-count-redis.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: add code which is removed in #3991 by mistake. Close #3988 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>36d643deec635298ec5f67011e1b6698f0dc1a72</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/limit-count/limit-count-redis.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
