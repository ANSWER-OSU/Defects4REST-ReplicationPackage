<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>11281</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/11281</ISSUEURL>
  <TITLE>feat: As a user, I want to obtain the previously validated JWT from the context, so that I can use it in my custom plugins with lower priority</TITLE>
  <DESCRIPTION>### Description I'd like to extend [jwt-auth plugin](https://github.com/apache/apisix/blob/master/apisix/plugins/jwt-auth.lua) to **store the authenticated JWT in the request context**, so that it can easily be used in a plugin which executes after (lower priority), such as a custom ACL based on JWT payload. ### Benefits These are the benefits that come to my mind: - hiding the token from headers - this allows to enable `hide_credentials` and hide the JWT from the server receiving the request, but still allows subsequent plugins to access it; - less redundant code - the following plugins do not have to import extra modules to parse _**again**_ the token, but can simply access its claims as a table. ### Example Suppose the `jwt-auth` plugin stores the decoded jwt object in request context (`jwt-auth.lua`): ```lua function _M.rewrite(conf, ctx) -- [...] ctx.jwt_obj = jwt_obj end ``` Custom plugin example (`my-acl.lua`): ```lua function _M.rewrite(conf, ctx) -- [...] if not ctx.jwt_obj then -- Technically this can only happen when the JWT plugin didn't run for this request, or the priority was lower core.log.warn(&quot;Token object not found in ctx.&quot;) return 401, {message = &quot;Missing JWT in request&quot;} end local authorized = false local roles = ctx.jwt_obj.payload.roles -- Do something with roles for i, value in ipairs(tab) do if value == &quot;admin&quot; then authorized = true end end if not authorized then core.log.warn(&quot;Request not authorized&quot;) return 403, {message = &quot;You are not allowed to access this resource&quot;} end -- [...] end ``` ### Additional Information Kong JWT Plugin stores the encoded token in context, which I find interesting but a little bit unhandy: https://github.com/Kong/kong/blob/d4ab528fa2414d996861a43e58406c02b4978157/kong/plugins/jwt/handler.lua#L146</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>285</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix #11276 + little style refactor Features: - config param &quot;key_claim_name&quot; (default = &quot;key&quot;), so for example one could use &quot;iss&quot; to check the validity of the JWT; Style: - 2 blank lines between functions; - 1 blank like before &quot;else&quot; and &quot;elseif&quot;; - jwt -&gt; JWT; - Capitalized logs and response messages; - Added description for each schema configuration parameter;</MESSAGE>
    <SHA>e393d0ccfe16b2cc97cea7486335b922ce64a8e6</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #11281 Features: - Store the JWT object in request context;</MESSAGE>
      <SHA>9c3f3a04e7cac08670a585231f8e20baff21a7f5</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #11281 Features: - Store the JWT object in request context;</MESSAGE>
      <SHA>f43cb119c6fc7ef77de37a68189925cabe8778cb</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(jwt-auth): store token in request ctx Fixes #11281 Signed-off-by: Michele Righi &lt;righi.michy@gmail.com&gt;</MESSAGE>
      <SHA>26e3a3791fe6c80a1613f22cb512763c4f08195a</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
