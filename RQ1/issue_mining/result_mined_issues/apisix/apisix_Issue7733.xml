<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>7733</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/7733</ISSUEURL>
  <TITLE>feat: support dns parse in stream subsystem</TITLE>
  <DESCRIPTION>### Current Behavior i add a stream_route with host gatorcloud-pg.postgres-system.svc.cluster.local( first i use gatorcloud-pg.postgres-system, it doesn't work too ) { &quot;server_port&quot;: 9102, &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;nodes&quot;: { &quot;gatorcloud-pg.postgres-system.svc.cluster.local:5432&quot;: 1 } } } the error log is: 2022/08/18 07:46:16 [error] 45#45: *13383 stream [lua] resolver.lua:47: parse_domain(): failed to parse domain: gatorcloud-pg.postgres-system.svc.cluster.local, error: failed to query the DNS server: dns client error: 101 empty record received while prereading client data, client: 10.233.102.128, server: 0.0.0.0:9103 2022/08/18 07:46:16 [error] 45#45: *13383 stream [lua] upstream.lua:79: parse_domain_for_nodes(): dns resolver domain: gatorcloud-pg.postgres-system.svc.cluster.local error: failed to query the DNS server: dns client error: 101 empty record received while prereading client data, client: 10.233.102.128, server: 0.0.0.0:9103 2022/08/18 07:46:16 [error] 45#45: *13383 stream [lua] init.lua:942: stream_preread_phase(): failed to set upstream: no valid upstream node while prereading client data, client: 10.233.102.128, server: 0.0.0.0:9103 the same dns for route, it is ok. { &quot;uri&quot;: &quot;/test&quot;, &quot;methods&quot;: [&quot;GET&quot;,&quot;POST&quot;,&quot;PUT&quot;,&quot;DELETE&quot;], &quot;priority&quot;: 10000112, &quot;upstream&quot;: { &quot;type&quot;: &quot;roundrobin&quot;, &quot;scheme&quot;: &quot;http&quot;, &quot;nodes&quot;: { &quot;gatorcloud-pg.postgres-system.svc.cluster.local:5432&quot;: 1 } } } 2022/08/18 07:53:31 [error] 46#46: *67040 upstream prematurely closed connection while reading response header from upstream, client: 10.233.102.128, server: _, request: &quot;GET /test HTTP/1.1&quot;, upstream: &quot;http://10.233.19.207:5432/test&quot;, host: &quot;172.30.3.230&quot; this log mean &quot;gatorcloud-pg.postgres-system.svc.cluster.local:5432&quot; resolve to 10.233.19.207:5432 in lv4. ### Expected Behavior dns resolve error ### Error Logs _No response_ ### Steps to Reproduce use stream_route with a host upstream, then dns resolve error ### Environment apache/apisix:2.14.1-alpine</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>116</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: support file-logger plugin of response body record (#8414)</MESSAGE>
    <SHA>c5fc10d9355a0c177a7532f01c77745ff0639a7f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: support resolve upstream host in stream subsystem (#8500) Fixes https://github.com/apache/apisix/issues/7733</MESSAGE>
      <SHA>ad581958dddb5f3941a7e53fce9a1e8692c31593</SHA>
      <PATCHEDFILES>
        <FILE>rockspec/apisix-master-0.rockspec</FILE>
        <FILE>t/cli/test_dns.sh</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
