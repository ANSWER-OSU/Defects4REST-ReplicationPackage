<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3964</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3964</ISSUEURL>
  <TITLE>Request help: stream_proxy(mqtt_proxy) do not support dns resolvã€‚</TITLE>
  <DESCRIPTION>### Issue description Background: This is the requirement for developer in our company. It is necessary to deploy the mqtt service inside the k8s cluster with container, the conventional practice in the past is to create loadbalancer service to expose nodeport, but it is troublesome for operation and maintenance. The current api entry is unified by apisix, and apisix also has mqtt_proxy plugin, so just to try it. During the deployment process, many problems were encountered. FIrst question: Apply the plugin of mqtt_proxy to the route through the apisix-dashboard, but it does not actually take effect ``` ./etcdctl --endpoints=10.111.9.154:2379 get /apisix/routes/348239466273440537 --prefix /apisix/routes/348239466273440537 {&quot;id&quot;:&quot;348239466273440537&quot;,&quot;create_time&quot;:1617096496,&quot;update_time&quot;:1617255551,&quot;uris&quot;:[&quot;/*&quot;],&quot;name&quot;:&quot;mqtt_test&quot;,&quot;desc&quot;:&quot;xxxxx&quot;,&quot;methods&quot;:[&quot;GET&quot;,&quot;HEAD&quot;,&quot;POST&quot;,&quot;PUT&quot;,&quot;DELETE&quot;,&quot;OPTIONS&quot;,&quot;PATCH&quot;],&quot;hosts&quot;:[&quot;mqtttest.test.com&quot;],&quot;vars&quot;:[],&quot;plugins&quot;:{&quot;mqtt-proxy&quot;:{&quot;disable&quot;:false,&quot;protocol_level&quot;:4,&quot;protocol_name&quot;:&quot;MQTT&quot;,&quot;upstream&quot;:{&quot;ip&quot;:&quot;172.20.250.158&quot;,&quot;port&quot;:1883}}},&quot;upstream&quot;:{&quot;nodes&quot;:[{&quot;host&quot;:&quot;mqtt.test.svc.cluster.local&quot;,&quot;port&quot;:8080,&quot;weight&quot;:1}],&quot;timeout&quot;:{&quot;connect&quot;:6000,&quot;read&quot;:6000,&quot;send&quot;:6000},&quot;type&quot;:&quot;roundrobin&quot;,&quot;pass_host&quot;:&quot;pass&quot;},&quot;labels&quot;:{&quot;domain&quot;:&quot;test.com&quot;},&quot;status&quot;:1} ``` Second question: Add stream_route through api, the ip field of upstream does not support domain name, ip must be used In view of this problem, it is not convenient to use it in k8s. It is well known that the service domain name can be used for calls within the cluster. ``` ./etcdctl --endpoints=10.111.9.154:2379 get /apisix/stream_routes --prefix /apisix/stream_routes/1 {&quot;id&quot;:&quot;1&quot;,&quot;plugins&quot;:{&quot;mqtt-proxy&quot;:{&quot;upstream&quot;:{&quot;ip&quot;:&quot;mqtt.test.svc.cluster.local&quot;,&quot;port&quot;:1883},&quot;protocol_name&quot;:&quot;MQTT&quot;,&quot;protocol_level&quot;:4}}} ``` apisix error_log ``` 2021/04/01 13:27:50 [warn] 2760#2760: *168 stream [lua] upstream.lua:193: set_upstream(): upstream node has been specified, cannot be set repeatedly while prereading client data, client: 10.254.6.185, server: 0.0.0.0:9100 2021/04/01 13:27:50 [error] 2760#2760: *168 stream [lua] balancer.lua:208: load_balancer(): failed to set server peer [mqtt.test.com:1883] err: no host allowed while connecting to upstream, client: 10.254.6.185, server: 0.0.0.0:9100, bytes from/to client:0/0, bytes from/to upstream:0/0 ``` ### Environment * apisix version (cmd: `apisix version`): 2.4 * OS (cmd: `uname -a`): centos &amp; k8s</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>69</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ci: use concurrency to cancel duplicate workflow (#4364) Signed-off-by: yiyiyimu &lt;wosoyoung@gmail.com&gt;</MESSAGE>
    <SHA>c61261af8d19557b77535c9c745f4f8182bb63b2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat(mqtt-proxy): support domain Fix #3964 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>88c00a6bd71a517f8f75d49676f93caedc9c1a9b</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugin.lua</FILE>
        <FILE>apisix/stream/plugins/mqtt-proxy.lua</FILE>
        <FILE>docs/en/latest/plugins/mqtt-proxy.md</FILE>
        <FILE>docs/zh/latest/plugins/mqtt-proxy.md</FILE>
        <FILE>t/stream-plugin/mqtt-proxy.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
