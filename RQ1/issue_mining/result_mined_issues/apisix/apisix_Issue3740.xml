<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3740</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3740</ISSUEURL>
  <TITLE>bug: the traffic-split plugin is invalid to bind upstream via upstream_id</TITLE>
  <DESCRIPTION>### Issue description When both the routing and traffic-split plugins use upstream_id to bind upstream, the request distribution is not accurate. 1、add route and bind plugin The upstream_id is 1, the response data is 1980, and the upstream_id is 2 the response data is 1981. ```shell curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d ' { &quot;create_time&quot;:1614743731, &quot;update_time&quot;:1614745342, &quot;uris&quot;:[ &quot;/*&quot; ], &quot;name&quot;:&quot;luarocks_cn&quot;, &quot;methods&quot;:[ &quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot; ], &quot;vars&quot;:[ ], &quot;plugins&quot;:{ &quot;proxy-rewrite&quot;:{ &quot;disable&quot;:false, &quot;scheme&quot;:&quot;http&quot; }, &quot;traffic-split&quot;:{ &quot;disable&quot;:false, &quot;rules&quot;:[ { &quot;match&quot;:[ { &quot;vars&quot;:[ [ &quot;uri&quot;, &quot;==&quot;, &quot;/hello&quot; ] ] } ], &quot;weighted_upstreams&quot;:[ { &quot;upstream_id&quot;:&quot;2&quot; } ] } ] } }, &quot;upstream_id&quot;:&quot;1&quot;, &quot;status&quot;:1 } ' ``` 2、Test plugin The vars rule passes: ```shell $ curl http://127.0.0.1:9080/hello 1981 ``` The vars rule failed： ```shell $ curl http://127.0.0.1:9080/hello12 1980 ``` The vars rule passes: ```shell $ curl http://127.0.0.1:9080/hello 1981 ``` The vars rule failed (an exception occurred)： ```shell $ curl http://127.0.0.1:9080/hello12 1981 ```</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>11</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>test: clean up malformed etcd data (#3743) Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>9885103a454d7f79a0bfbc66a20ac4db4cea62be</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: #3740</MESSAGE>
      <SHA>5b47ae299b87988850a1cef7ccde832725c38b59</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/traffic-split.lua</FILE>
        <FILE>t/plugin/traffic-split.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: the traffic-split plugin is invalid to bind upstream via upstream_id (#3758) fix #3740</MESSAGE>
      <SHA>210ca462b777ec489e3f18d543e1f83308d2b86a</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/traffic-split.lua</FILE>
        <FILE>t/plugin/traffic-split.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(traffic-split): binding upstream via upstream_id is invalid fix #3740</MESSAGE>
      <SHA>af18e6ac1d1dfff9e68d7ff4fce525ac1e155a13</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/plugins/traffic-split.lua</FILE>
        <FILE>t/plugin/traffic-split.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
