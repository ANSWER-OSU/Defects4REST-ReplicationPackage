<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3108</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/3108</ISSUEURL>
  <TITLE>bug: limit-count plugin does not take effect</TITLE>
  <DESCRIPTION>### Issue description When the `limit-count` plugin is enabled on `service` and `upstream` is the domain name. This will cause the `local key = (ctx.var[conf.key] or &quot;&quot;) .. ctx.conf_type .. ctx.conf_version` generated in the limit-count plugin to be inconsistent. When `ctx.conf_version` is deleted (`local key = (ctx.var[conf.key] or &quot;&quot;) .. ctx.conf_type`), the plug-in function returns to normal. Steps to reproduce, will be added later. ### Environment * apisix version (cmd: `apisix version`): 2.1 * OS: (cmd: `uname -a`)ï¼šcentos7 * OpenResty / Nginx version: (cmd: `nginx -V` or `openresty -V`): openresty/1.19.3.1 ### Minimal test code / Steps to reproduce the issue 1. 2. 3. ### What's the actual result? (including assertion message &amp; call stack if applicable) ### What's the expected result?</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ci: remove mac os CI (#3122) The CI is not run for long. Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>fb70133c22aea68f046153856b243ada7ed1c815</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>test: limit-count add more test cases to cover the case where the upstream is a domain name. close #3108</MESSAGE>
      <SHA>f800a20138ac5a8c8890638c23f98277bf630c1e</SHA>
      <PATCHEDFILES>
        <FILE>t/plugin/limit-count.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>test: limit-count add more test cases to cover the case where the upstream is a domain name (#3140) close #3108</MESSAGE>
      <SHA>9b5fa0b4c49c1eb1a12a21f5ced32a456c7c39f1</SHA>
      <PATCHEDFILES>
        <FILE>t/plugin/limit-count.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
