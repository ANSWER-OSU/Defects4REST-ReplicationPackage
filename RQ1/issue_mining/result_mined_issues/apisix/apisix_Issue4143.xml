<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4143</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/4143</ISSUEURL>
  <TITLE>bug: prometheus plugin ask for root premission of etcd</TITLE>
  <DESCRIPTION>### Issue description ### Environment * apisix version (cmd: `apisix version`):2.4 * OS (cmd: `uname -a`):Linux 3.10.0-1160.15.2.el7.x86_64 (Redhat 7.9) * OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`):openresty/1.19.3.1 * etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API):3.4.15 * apisix-dashboard version, if have:2.5 * luarocks version, if the issue is about installation (cmd: `luarocks --version`): ### Minimal test code / Steps to reproduce the issue 1.use etcdctl add user apisix and grant all privilege on /apisix/* 2.edit apisix/conf/config.yaml, add the user to apisix 3.run (cmd: `curl -i https://_domainname_:9443/apisix/prometheus/metrics`) ### What's the actual result? (including assertion message &amp; call stack if applicable) HTTP/1.1 500 Internal Server Error Date: Wed, 28 Apr 2021 03:07:52 GMT Content-Type: text/html; charset=utf-8 Content-Length: 174 Connection: close Server: APISIX &lt;html&gt; &lt;head&gt;&lt;title&gt;500 Internal Server Error&lt;/title&gt;&lt;/head&gt; &lt;body&gt; &lt;center&gt;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&lt;/center&gt; &lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt; &lt;/body&gt; &lt;/html&gt; ### What's the expected result? when I change the etcd user in apisix/conf/config.yaml to root, this plugin works well, like this: HTTP/1.1 200 OK Date: Wed, 28 Apr 2021 03:05:20 GMT Content-Type: text/plain; charset=utf-8 Transfer-Encoding: chunked Connection: keep-alive Server: APISIX # HELP apisix_etcd_modify_indexes Etcd modify index for APISIX keys # TYPE apisix_etcd_modify_indexes gauge apisix_etcd_modify_indexes{key=&quot;consumers&quot;} 61099 apisix_etcd_modify_indexes{key=&quot;global_rules&quot;} 60709 apisix_etcd_modify_indexes{key=&quot;max_modify_index&quot;} 62639 apisix_etcd_modify_indexes{key=&quot;prev_index&quot;} 62789 apisix_etcd_modify_indexes{key=&quot;protos&quot;} 0 apisix_etcd_modify_indexes{key=&quot;routes&quot;} 62639 apisix_etcd_modify_indexes{key=&quot;services&quot;} 0 apisix_etcd_modify_indexes{key=&quot;ssls&quot;} 2281 apisix_etcd_modify_indexes{key=&quot;stream_routes&quot;} 0 apisix_etcd_modify_indexes{key=&quot;upstreams&quot;} 61110 apisix_etcd_modify_indexes{key=&quot;x_etcd_index&quot;} 62792 # HELP apisix_etcd_reachable Config server etcd reachable from APISIX, 0 is unreachable # TYPE apisix_etcd_reachable gauge apisix_etcd_reachable 1 # HELP apisix_nginx_http_current_connections Number of HTTP connections # TYPE apisix_nginx_http_current_connections gauge apisix_nginx_http_current_connections{state=&quot;accepted&quot;} 1 apisix_nginx_http_current_connections{state=&quot;active&quot;} 1 apisix_nginx_http_current_connections{state=&quot;handled&quot;} 1 apisix_nginx_http_current_connections{state=&quot;reading&quot;} 0 apisix_nginx_http_current_connections{state=&quot;total&quot;} 1 apisix_nginx_http_current_connections{state=&quot;waiting&quot;} 0 apisix_nginx_http_current_connections{state=&quot;writing&quot;} 1 # HELP apisix_nginx_metric_errors_total Number of nginx-lua-prometheus errors # TYPE apisix_nginx_metric_errors_total counter apisix_nginx_metric_errors_total 0 # HELP apisix_node_info Info of APISIX node # TYPE apisix_node_info gauge apisix_node_info{hostname=&quot;_servername_&quot;} 1 BUT it is not correct to give apisix the root privilege. All function and other plugins works well with the apisix user of etcd. I think it is a bug for the plugin.</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ci: remove duplicate external services installation (#4115) Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>6c8db9d35cbe4347e21b1d10bced2e9605cddc7d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: deal with etcd grants permissions with a different prefix than the one used by apisix, etcd will forbidden(#4143)</MESSAGE>
      <SHA>6180958141bfdb58dd2572d6a1e49935f6932b35</SHA>
      <PATCHEDFILES>
        <FILE>apisix/core/etcd.lua</FILE>
        <FILE>t/core/etcd-auth-fail.t</FILE>
        <FILE>t/core/etcd-auth.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
