<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8682</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/8682</ISSUEURL>
  <TITLE>bug: apisix 3.x lost config cache values after etcd compacted</TITLE>
  <DESCRIPTION>### Current Behavior https://github.com/apache/apisix/blob/df1cadb27744234f2f9fe6b6bfa5ea18442fb8e6/apisix/core/config_etcd.lua#L370 Perhaps should be ```lua local dir_res, headers = res.body.node or {}, res.headers ``` #8675 has the same problem. ### Expected Behavior _No response_ ### Error Logs _No response_ ### Steps to Reproduce 1. ```bash etcdctl compact `etcdctl get -w json /apisix/upstreams/ | jq .header.revision` ``` Perhaps this command should be run multiple times. 2. do not update related keys, for example global_rules. 3. wait a moment, the global plugins not working. ### Environment - APISIX version (run `apisix version`): 3.1.0 - Operating system (run `uname -a`): - OpenResty / Nginx version (run `openresty -V` or `nginx -V`): - etcd version, if relevant (run `curl http://127.0.0.1:9090/v1/server_info`): - APISIX Dashboard version, if relevant: - Plugin runner version, for issues related to plugin runners: - LuaRocks version, for installation issues (run `luarocks --version`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>15</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix: fix fetch all service info from consul (#8651) Co-authored-by: Fabriceli &lt;li842162578@gmail.com&gt;</MESSAGE>
    <SHA>bbff579e9af19e569fc229f3b61664aa0a1d1c93</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(etcd): reloaded data may be in res.body.node (#8736) Fixes https://github.com/apache/apisix/issues/8682</MESSAGE>
      <SHA>a18573a3b8775f5a92ba92b948e8212affbf7057</SHA>
      <PATCHEDFILES>
        <FILE>apisix/core/config_etcd.lua</FILE>
        <FILE>t/core/config_etcd.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
