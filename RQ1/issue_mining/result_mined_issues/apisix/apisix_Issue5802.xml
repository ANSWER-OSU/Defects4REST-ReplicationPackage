<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5802</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/5802</ISSUEURL>
  <TITLE>bug: no connection to MQTT broker possible by using mqtt_proxy</TITLE>
  <DESCRIPTION>### Issue description By using the mqtt_proxy plugin it isn't possible to make up a connection to the mqtt broker, in this case mosquitto. All done with docker compose. ### Environment - apisix version (cmd: `apisix version`): 2.11.0 - OS (cmd: `uname -a`): Darwin Kernel Version 20.6.0 ### Steps to reproduce 1. create docker environment based on APISIX-docker with additional mosquitto service 2. configure stream_proxy in config.yaml 3. create stream_routes according to the example provided in the documentation ### Actual result mqtt pub -t test -m &quot;Hello&quot; -h 127.0.0.1 -p 1883 creates a topic test with message Hello. mqtt pub -t test -m &quot;Hello&quot; -h 127.0.0.1 -p 9100 does nothing the mqtt client is running into a timeout ### Error log 2021/12/14 09:16:03 [warn] 46#46: *4 [lua] plugin.lua:172: load(): new plugins: {&quot;zipkin&quot;:true,&quot;openid-connect&quot;:true,&quot;key-auth&quot;:true,&quot;ip-restriction&quot;:true,&quot;uri-blocker&quot;:true,&quot;batch-requests&quot;:true,&quot;fault-injection&quot;:true,&quot;basic-auth&quot;:true,&quot;request-validation&quot;:true,&quot;grpc-transcode&quot;:true,&quot;example-plugin&quot;:true,&quot;kafka-logger&quot;:true,&quot;ldap-auth&quot;:true,&quot;wolf-rbac&quot;:true,&quot;limit-req&quot;:true,&quot;consumer-restriction&quot;:true,&quot;limit-count&quot;:true,&quot;tcp-logger&quot;:true,&quot;serverless-post-function&quot;:true,&quot;serverless-pre-function&quot;:true,&quot;echo&quot;:true,&quot;client-control&quot;:true,&quot;ext-plugin-post-req&quot;:true,&quot;sls-logger&quot;:true,&quot;azure-functions&quot;:true,&quot;udp-logger&quot;:true,&quot;gzip&quot;:true,&quot;syslog&quot;:true,&quot;http-logger&quot;:true,&quot;proxy-cache&quot;:true,&quot;skywalking-logger&quot;:true,&quot;api-breaker&quot;:true,&quot;authz-casbin&quot;:true,&quot;jwt-auth&quot;:true,&quot;server-info&quot;:true,&quot;traffic-split&quot;:true,&quot;real-ip&quot;:true,&quot;proxy-mirror&quot;:true,&quot;response-rewrite&quot;:true,&quot;limit-conn&quot;:true,&quot;redirect&quot;:true,&quot;cors&quot;:true,&quot;ua-restriction&quot;:true,&quot;datadog&quot;:true,&quot;prometheus&quot;:true,&quot;ext-plugin-pre-req&quot;:true,&quot;authz-keycloak&quot;:true,&quot;proxy-rewrite&quot;:true,&quot;hmac-auth&quot;:true,&quot;referer-restriction&quot;:true,&quot;request-id&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 48#48: *3 [lua] plugin.lua:172: load(): new plugins: {&quot;zipkin&quot;:true,&quot;openid-connect&quot;:true,&quot;key-auth&quot;:true,&quot;ip-restriction&quot;:true,&quot;uri-blocker&quot;:true,&quot;batch-requests&quot;:true,&quot;fault-injection&quot;:true,&quot;basic-auth&quot;:true,&quot;request-validation&quot;:true,&quot;grpc-transcode&quot;:true,&quot;example-plugin&quot;:true,&quot;kafka-logger&quot;:true,&quot;ldap-auth&quot;:true,&quot;wolf-rbac&quot;:true,&quot;limit-req&quot;:true,&quot;consumer-restriction&quot;:true,&quot;limit-count&quot;:true,&quot;tcp-logger&quot;:true,&quot;serverless-post-function&quot;:true,&quot;serverless-pre-function&quot;:true,&quot;echo&quot;:true,&quot;client-control&quot;:true,&quot;ext-plugin-post-req&quot;:true,&quot;sls-logger&quot;:true,&quot;azure-functions&quot;:true,&quot;udp-logger&quot;:true,&quot;gzip&quot;:true,&quot;syslog&quot;:true,&quot;http-logger&quot;:true,&quot;proxy-cache&quot;:true,&quot;skywalking-logger&quot;:true,&quot;api-breaker&quot;:true,&quot;authz-casbin&quot;:true,&quot;jwt-auth&quot;:true,&quot;server-info&quot;:true,&quot;traffic-split&quot;:true,&quot;real-ip&quot;:true,&quot;proxy-mirror&quot;:true,&quot;response-rewrite&quot;:true,&quot;limit-conn&quot;:true,&quot;redirect&quot;:true,&quot;cors&quot;:true,&quot;ua-restriction&quot;:true,&quot;datadog&quot;:true,&quot;prometheus&quot;:true,&quot;ext-plugin-pre-req&quot;:true,&quot;authz-keycloak&quot;:true,&quot;proxy-rewrite&quot;:true,&quot;hmac-auth&quot;:true,&quot;referer-restriction&quot;:true,&quot;request-id&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 49#49: *1 [lua] plugin.lua:172: load(): new plugins: {&quot;zipkin&quot;:true,&quot;openid-connect&quot;:true,&quot;key-auth&quot;:true,&quot;ip-restriction&quot;:true,&quot;uri-blocker&quot;:true,&quot;batch-requests&quot;:true,&quot;fault-injection&quot;:true,&quot;basic-auth&quot;:true,&quot;request-validation&quot;:true,&quot;grpc-transcode&quot;:true,&quot;example-plugin&quot;:true,&quot;kafka-logger&quot;:true,&quot;ldap-auth&quot;:true,&quot;wolf-rbac&quot;:true,&quot;limit-req&quot;:true,&quot;consumer-restriction&quot;:true,&quot;limit-count&quot;:true,&quot;tcp-logger&quot;:true,&quot;serverless-post-function&quot;:true,&quot;serverless-pre-function&quot;:true,&quot;echo&quot;:true,&quot;client-control&quot;:true,&quot;ext-plugin-post-req&quot;:true,&quot;sls-logger&quot;:true,&quot;azure-functions&quot;:true,&quot;udp-logger&quot;:true,&quot;gzip&quot;:true,&quot;syslog&quot;:true,&quot;http-logger&quot;:true,&quot;proxy-cache&quot;:true,&quot;skywalking-logger&quot;:true,&quot;api-breaker&quot;:true,&quot;authz-casbin&quot;:true,&quot;jwt-auth&quot;:true,&quot;server-info&quot;:true,&quot;traffic-split&quot;:true,&quot;real-ip&quot;:true,&quot;proxy-mirror&quot;:true,&quot;response-rewrite&quot;:true,&quot;limit-conn&quot;:true,&quot;redirect&quot;:true,&quot;cors&quot;:true,&quot;ua-restriction&quot;:true,&quot;datadog&quot;:true,&quot;prometheus&quot;:true,&quot;ext-plugin-pre-req&quot;:true,&quot;authz-keycloak&quot;:true,&quot;proxy-rewrite&quot;:true,&quot;hmac-auth&quot;:true,&quot;referer-restriction&quot;:true,&quot;request-id&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 47#47: *2 [lua] plugin.lua:172: load(): new plugins: {&quot;zipkin&quot;:true,&quot;openid-connect&quot;:true,&quot;key-auth&quot;:true,&quot;ip-restriction&quot;:true,&quot;uri-blocker&quot;:true,&quot;batch-requests&quot;:true,&quot;fault-injection&quot;:true,&quot;basic-auth&quot;:true,&quot;request-validation&quot;:true,&quot;grpc-transcode&quot;:true,&quot;example-plugin&quot;:true,&quot;kafka-logger&quot;:true,&quot;ldap-auth&quot;:true,&quot;wolf-rbac&quot;:true,&quot;limit-req&quot;:true,&quot;consumer-restriction&quot;:true,&quot;limit-count&quot;:true,&quot;tcp-logger&quot;:true,&quot;serverless-post-function&quot;:true,&quot;serverless-pre-function&quot;:true,&quot;echo&quot;:true,&quot;client-control&quot;:true,&quot;ext-plugin-post-req&quot;:true,&quot;sls-logger&quot;:true,&quot;azure-functions&quot;:true,&quot;udp-logger&quot;:true,&quot;gzip&quot;:true,&quot;syslog&quot;:true,&quot;http-logger&quot;:true,&quot;proxy-cache&quot;:true,&quot;skywalking-logger&quot;:true,&quot;api-breaker&quot;:true,&quot;authz-casbin&quot;:true,&quot;jwt-auth&quot;:true,&quot;server-info&quot;:true,&quot;traffic-split&quot;:true,&quot;real-ip&quot;:true,&quot;proxy-mirror&quot;:true,&quot;response-rewrite&quot;:true,&quot;limit-conn&quot;:true,&quot;redirect&quot;:true,&quot;cors&quot;:true,&quot;ua-restriction&quot;:true,&quot;datadog&quot;:true,&quot;prometheus&quot;:true,&quot;ext-plugin-pre-req&quot;:true,&quot;authz-keycloak&quot;:true,&quot;proxy-rewrite&quot;:true,&quot;hmac-auth&quot;:true,&quot;referer-restriction&quot;:true,&quot;request-id&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 52#52: *5 [lua] plugin.lua:172: load(): new plugins: {&quot;zipkin&quot;:true,&quot;openid-connect&quot;:true,&quot;key-auth&quot;:true,&quot;ip-restriction&quot;:true,&quot;uri-blocker&quot;:true,&quot;batch-requests&quot;:true,&quot;fault-injection&quot;:true,&quot;basic-auth&quot;:true,&quot;request-validation&quot;:true,&quot;grpc-transcode&quot;:true,&quot;example-plugin&quot;:true,&quot;kafka-logger&quot;:true,&quot;ldap-auth&quot;:true,&quot;wolf-rbac&quot;:true,&quot;limit-req&quot;:true,&quot;consumer-restriction&quot;:true,&quot;limit-count&quot;:true,&quot;tcp-logger&quot;:true,&quot;serverless-post-function&quot;:true,&quot;serverless-pre-function&quot;:true,&quot;echo&quot;:true,&quot;client-control&quot;:true,&quot;ext-plugin-post-req&quot;:true,&quot;sls-logger&quot;:true,&quot;azure-functions&quot;:true,&quot;udp-logger&quot;:true,&quot;gzip&quot;:true,&quot;syslog&quot;:true,&quot;http-logger&quot;:true,&quot;proxy-cache&quot;:true,&quot;skywalking-logger&quot;:true,&quot;api-breaker&quot;:true,&quot;authz-casbin&quot;:true,&quot;jwt-auth&quot;:true,&quot;server-info&quot;:true,&quot;traffic-split&quot;:true,&quot;real-ip&quot;:true,&quot;proxy-mirror&quot;:true,&quot;response-rewrite&quot;:true,&quot;limit-conn&quot;:true,&quot;redirect&quot;:true,&quot;cors&quot;:true,&quot;ua-restriction&quot;:true,&quot;datadog&quot;:true,&quot;prometheus&quot;:true,&quot;ext-plugin-pre-req&quot;:true,&quot;authz-keycloak&quot;:true,&quot;proxy-rewrite&quot;:true,&quot;hmac-auth&quot;:true,&quot;referer-restriction&quot;:true,&quot;request-id&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 49#49: *1 [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 47#47: *2 [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 48#48: *3 [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 46#46: *4 [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 52#52: *5 [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 47#47: *6 stream [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 48#48: *7 stream [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 49#49: *8 stream [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 46#46: *9 stream [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* 2021/12/14 09:16:03 [warn] 52#52: *10 stream [lua] plugin.lua:222: load_stream(): new plugins: {&quot;ip-restriction&quot;:true,&quot;mqtt-proxy&quot;:true,&quot;limit-conn&quot;:true}, context: init_worker_by_lua* ### Expected result The creation of the topic test with the message Hello</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix: bump lua-resty-rocketmq to 0.2.1-3 (#5744)</MESSAGE>
    <SHA>5ae38f81f25fc58a040e30d12ba8fef33bb56f60</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(mqtt-proxy): client id can be empty Fix #5802 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>4df411b286b616b6a47aa1444d72d96620fdf7e1</SHA>
      <PATCHEDFILES>
        <FILE>apisix/stream/plugins/mqtt-proxy.lua</FILE>
        <FILE>t/stream-plugin/mqtt-proxy.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
