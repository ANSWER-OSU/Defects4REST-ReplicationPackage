<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>10967</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/10967</ISSUEURL>
  <TITLE>bug: 插件 jwt-auth 的 function get_real_payload 存在 key 和 exp 被恶意修改的可能</TITLE>
  <DESCRIPTION>### Current Behavior get_real_payload 中使用了 merge（real_payload, extra_payload）的方式来合并 payload， 但作为参数传入的 extra_payload 并未做严格检查，调用者可以任意传入 key 和 exp ，覆盖 real_payload 中的值。 ### Expected Behavior 修改代码，当传入的 payload 不为空时，采用 merge（ extra_payload， real_payload）合并，并返回 extra_payload ### Error Logs _No response_ ### Steps to Reproduce 1. 启用 jwt-auth 插件 2. 通过 public-api插件暴露 /apisix/plugin/jwt/sign 接口 3. 构造 { “key&quot;:&quot;letmein&quot;, exp: 123456} 作为 DATA 提交至上述接口 4. 检查 response 中的 JWT，可发现 payload 中的值被替换为上述 DATA ### Environment - APISIX version (run `apisix version`): 3.8.0 - Operating system (run `uname -a`): - OpenResty / Nginx version (run `openresty -V` or `nginx -V`): - etcd version, if relevant (run `curl http://127.0.0.1:9090/v1/server_info`): - APISIX Dashboard version, if relevant: - Plugin runner version, for issues related to plugin runners: - LuaRocks version, for installation issues (run `luarocks --version`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>10</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs: improve clarity for `ext-plugin-post-resp` plugin (#10972)</MESSAGE>
    <SHA>614be2a9e0031c9b95e3a97502b42b47989e2bc0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: jwt-auth plugin : real_payload was overridden by malicious payload: #10967</MESSAGE>
      <SHA>e85372ecf748e81269a1a0faf9f3a8881a2df3e2</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/jwt-auth.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>add test case for fix #10967</MESSAGE>
      <SHA>2c3a5ae43d91f41c781db20d06e909393f5afed5</SHA>
      <PATCHEDFILES>
        <FILE>t/plugin/jwt-auth4.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
