<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1667</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/1667</ISSUEURL>
  <TITLE>bug: global-rule error when enable_debug=true</TITLE>
  <DESCRIPTION>### Issue description I customized a plug-in for global rules,When I set the configuration enable_debug=true, i got the follow error: ``` 2020/06/08 11:40:56 [error] 15825#0: *330 failed to run body_filter_by_lua*: /usr/local/share/lua/5.1/apisix/plugin.lua:260: headers have already been sent stack traceback: [C]: in function 'error' /usr/local/share/lua/5.1/apisix/core/response.lua:90: in function 'set_header' /usr/local/share/lua/5.1/apisix/plugin.lua:260: in function 'filter' /usr/local/share/lua/5.1/apisix/init.lua:456: in function 'common_phase' /usr/local/share/lua/5.1/apisix/init.lua:470: in function 'http_body_filter_phase' body_filter_by_lua:2: in main chunk, client: ::1, server: , request: &quot;GET /config HTTP/1.1&quot;, host: &quot;localhost:9080&quot; ``` ### Environment * apisix version (cmd: `apisix version`): 1.2 * OS: Ubuntu 18.04 ### Minimal test code / Steps to reproduce the issue 1. config.yaml ``` apisix: enable_debug: true plugins: - my_custom_plugin ``` 2. my_custom_plugin.lua ``` local core = require(&quot;apisix.core&quot;) local plugin_name = &quot;my_custom_plugin&quot; local schema = {} local _M = { version = 0.1, priority = 0, name = plugin_name, schema = schema, } function _M.access(conf, ctx) -- core.response.exit(200, &quot;测试！！！&quot;) -- return 200, &quot;测试！！！&quot; end return _M ``` 3. set global rule: ``` curl -X PUT \ http://localhost:9080/apisix/admin/global_rules/1 \ -H 'Content-Type: application/json' \ -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' \ -d '{ &quot;plugins&quot;: { &quot;my_custom_plugin&quot;: {} } }' ``` ### What's the actual result? (including assertion message &amp; call stack if applicable) ``` ➜ ~ curl http://localhost:9080/config curl: (52) Empty reply from server ``` ### What's the expected result? ➜ ~ curl http://localhost:9080/config {&quot;error_msg&quot;:&quot;failed to match any routes&quot;}</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>193</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge remote-tracking branch 'upstream/master'</MESSAGE>
    <SHA>118b44bebf13839af1d500a53337fcfe67e07eb2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fixed: https://github.com/apache/incubator-apisix/issues/1667</MESSAGE>
      <SHA>190f71aae4dcbe28cb1ad33758ae5e50ce78c0af</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugin.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
