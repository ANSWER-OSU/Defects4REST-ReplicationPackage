<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2303</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/2303</ISSUEURL>
  <TITLE>Proposal: inptroduce traffic split plugin</TITLE>
  <DESCRIPTION>### Background I observed the Pull Request https://github.com/apache/apisix/pull/2279 adds labels for `upstream` object, which inspires me that if we attach labels for each node in `upstream`, then we can implement fancy traffic split feature. ### Design Traffic split, which means to setup several route rules and schedule requests by respecting these rules to specified upstream (or a subset nodes in a single upstream). With this feature, we can support the [Canary Release](https://martinfowler.com/bliki/CanaryRelease.html#:~:text=Canary%20release%20is%20a%20technique,making%20it%20available%20to%20everybody.), [Blue Green Release](https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html#:~:text=Blue%2Dgreen%20deployment%20is%20a,live%20and%20Green%20is%20idle.) for backend applications when they are releasing, it's useful to reduce the downtime when something fault happens. But it's not a good idea to introduce these concepts into APISIX directly, since features like Blue Green Release is closer to business, not the infrastructure, so what we can do is introducing the concept traffic split , to abstract all the business logics into the traffic split rules (route rules), and it can be implemented as a plugin. Both the Istio and [SMI](https://github.com/servicemeshinterface/smi-spec) support traffic split by `VirtualService` and `TrafficSplit` CRD respectively, although the latter is not perfect (at lease for now), we still can be aware of the similarity between them. In general, we need two parts to define a traffic split rule, match and route, the `match` defines the conditions that needed to judge wether a request is eligible to apply the `route`, for instance, a `match` might be &quot;the method of HTTP request must be `GET`, and the parameter `id` must be equal to `1006`. From APISIX's point of view, match conditions can be scoped to HTTP, TLS, so conditions can vary, like URI, method, headers, SNI and even other APISIX instance-scoped variables (hostname, env and etc). The APISIX Route already defines a fantastic match mechanism which is similar with the traffic split. But that not means we don't need to embed the match part in traffic split plugin, instead, we can reuse the match mechanism in Route as it's own match mechanism to further split requests that hit the same Route. See https://github.com/api7/lua-resty-radixtree#new for more details about Route match. The route, decides the ultimate upstream that a request will go, either specifying the upstream name or with a label selector to filter an eligible subset from that upstream. What's more, multiple upstreams can be specified, each with a non-negative weight to support probabilistic selection. For now, node in APISIX Upstream doesn't contain labels attribute, so we can implement it by the metadata map in node indirectly. ```json # route requests to the nodes that has label release=canary in fake_upstream, { &quot;route&quot;: [ { &quot;upstream_id&quot;: &quot;1&quot;, &quot;labels&quot;: { &quot;release&quot;: &quot;canary&quot; } } ] } # route 75% requests to upstream 2 and other 25% to upstream 3. { &quot;route&quot;: [ { &quot;upstream_id&quot;: &quot;2&quot;, &quot;weight&quot;: 75 }, { &quot;upstream_id&quot;: &quot;3&quot;, &quot;weight&quot;: 25 } ] } ``` The Route already contains an upstream, after introducing the traffic split plugin, this upstream will be treated as the default upstream and will be used when requests can not hit the route rules. ### Examples #### Weighted Blue Green Release Say we have two upstreams `app-blue` (id: 1) and `app-green` (id: 2), which represent the old and new releases for `app` respectively. Now we want to route 10% requests which UA is Android to `app-green`. ```json [ { &quot;match&quot;: [ { &quot;vars&quot;: [ [ &quot;http_user_agent&quot;, &quot;~~&quot;, &quot;Android&quot;] ] } ], &quot;route&quot;: [ { &quot;upstream_id&quot;: 2, &quot;weight&quot;: 10 } ] }, { &quot;route&quot;: [ { &quot;upstream_id&quot;: 1, &quot;weight&quot;: 90 } ] } ] ``` #### Canary Release in a single upstream Say we updated a node in upstream `app` (id: 3), and this node have a unique label `release=canary`, other nodes in `app` has label `release=stable`, now we want to route requests which parameter `user_id` is between [13, 133] to this node. ```json [ { &quot;match&quot;: [ { &quot;vars&quot;: [ [ &quot;arg_user_id&quot;, &quot;&gt;=&quot;, 13], [ &quot;arg_user_id&quot;, &quot;&lt;=&quot;, 133] ] } ], &quot;route&quot;: [ { &quot;upstream_id&quot;: 3, &quot;labels&quot;: &quot;release=canary&quot; } ] }, { &quot;route&quot;: [ { &quot;upstream_id&quot;: 3, &quot;labels&quot;: &quot;release=stable&quot; } ] } ] ``` ### References * VirtualService: https://istio.io/latest/docs/reference/config/networking/virtual-service * TrafficSplit: https://github.com/servicemeshinterface/smi-spec/blob/master/apis/traffic-split/v1alpha3/traffic-split.md</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>91</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix: we should check the length of input before calling memcmp (#2925) To avoid accessing memory which is out of bound.</MESSAGE>
    <SHA>33d70d17f8e073d2191c61f170f08959b3dd64c4</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: traffic split plugin. close #2303 close #2603</MESSAGE>
      <SHA>5036bc635e959283312a000c394edcf74b243a6f</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/dynamic-upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/plugins/dynamic-upstream.md</FILE>
        <FILE>doc/zh-cn/plugins/dynamic-upstream.md</FILE>
        <FILE>t/plugin/dynamic-upstream.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: traffic split plugin. close #2303 close #2603</MESSAGE>
      <SHA>bd43f90f0903ff02e7c7ffad2d6936f8d84e187f</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/dynamic-upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/plugins/dynamic-upstream.md</FILE>
        <FILE>doc/zh-cn/plugins/dynamic-upstream.md</FILE>
        <FILE>t/plugin/dynamic-upstream.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: Implement traffic splitting plugin. close #2303 close #2603</MESSAGE>
      <SHA>f51544535f77dc58b69026e5c41a63c506c27743</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/traffic-split.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/plugins/traffic-split.md</FILE>
        <FILE>doc/zh-cn/plugins/traffic-split.md</FILE>
        <FILE>t/admin/plugins.t</FILE>
        <FILE>t/debug/debug-mode.t</FILE>
        <FILE>t/plugin/traffic-split.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: traffic split plugin. close #2303 close #2603</MESSAGE>
      <SHA>4a32bb7929e7175a5ae5019a855d2c78f162b877</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/dynamic-upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/plugins/dynamic-upstream.md</FILE>
        <FILE>doc/zh-cn/plugins/dynamic-upstream.md</FILE>
        <FILE>t/plugin/dynamic-upstream.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: traffic split plugin. close #2303 close #2603</MESSAGE>
      <SHA>8a2736e29a45b72f8584ad0c9cad1134df49154d</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/dynamic-upstream.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/plugins/dynamic-upstream.md</FILE>
        <FILE>doc/zh-cn/plugins/dynamic-upstream.md</FILE>
        <FILE>t/plugin/dynamic-upstream.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: Implement traffic splitting plugin (#2935) close #2303 close #2603</MESSAGE>
      <SHA>86fa46d85b91ae2604a69aec531b87c276a9a453</SHA>
      <PATCHEDFILES>
        <FILE>README.md</FILE>
        <FILE>README_CN.md</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/plugins/traffic-split.lua</FILE>
        <FILE>conf/config-default.yaml</FILE>
        <FILE>doc/README.md</FILE>
        <FILE>doc/plugins/traffic-split.md</FILE>
        <FILE>doc/zh-cn/README.md</FILE>
        <FILE>doc/zh-cn/plugins/traffic-split.md</FILE>
        <FILE>t/admin/plugins.t</FILE>
        <FILE>t/debug/debug-mode.t</FILE>
        <FILE>t/plugin/traffic-split.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
