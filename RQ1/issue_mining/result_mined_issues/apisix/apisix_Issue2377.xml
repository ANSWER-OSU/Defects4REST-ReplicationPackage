<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2377</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/2377</ISSUEURL>
  <TITLE>bug:Use zipkin plugin and limit-req plugin together, zipkin plugin can not work when is limit</TITLE>
  <DESCRIPTION>### Issue description I use zipkin plugin and limit-req plugin together, When then service is being limit, I got this error log: ``` 2020/10/10 17:03:12 [error] 48277#0: *6990 failed to run header_filter_by_lua*: ...nts/workspace/incubator-apisix/apisix/plugins/zipkin.lua:177: attempt to index field 'proxy_span' (a nil value) stack traceback: ...nts/workspace/incubator-apisix/apisix/plugins/zipkin.lua:177: in function 'phase_func' ...ser/Documents/workspace/incubator-apisix/apisix/init.lua:150: in function 'run_plugin' ...ser/Documents/workspace/incubator-apisix/apisix/init.lua:611: in function 'common_phase' ...ser/Documents/workspace/incubator-apisix/apisix/init.lua:619: in function 'http_header_filter_phase' ``` Please confirm is this a bug? ### Environment * apisix version (cmd: `apisix version`): 1.5 * OS: ### Minimal test code / Steps to reproduce the issue 1. 2. 3. ### What's the actual result? (including assertion message &amp; call stack if applicable) ### What's the expected result?</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>19</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: support `json` encoding escape for access logs (#2269) fix #2266 .</MESSAGE>
    <SHA>f2f5ab97663805509baf3355c37336ffa557b68c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>bugfix: fix zipkin plugin error when used with limit count plugin (#2499) fix #2377</MESSAGE>
      <SHA>37a0792eb4d287057955b17877a04e6b4d592435</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/zipkin.lua</FILE>
        <FILE>t/admin/plugins.t</FILE>
        <FILE>t/debug/debug-mode.t</FILE>
        <FILE>t/plugin/zipkin.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
