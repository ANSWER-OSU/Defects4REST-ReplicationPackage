<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4197</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/4197</ISSUEURL>
  <TITLE>request help: set different Host header for different Nodes in a single Upstream?</TITLE>
  <DESCRIPTION>### Issue description APISIX supports rewriting of Host header while talking to the upstream nodes, either with the proxy-rewrite plugin or with &quot;pass_host&quot; and &quot;upstream_host&quot; attributes in Upstream configuration. However, they both rewrite host for the Upstream, not nodes - so for example if I have an upstream with nodes: ``` &quot;nodes&quot;: { &quot;host-1.com:80&quot;: 1, &quot;host-2.com:443&quot;: 1 }, ``` I can't set Host to &quot;host-1.com&quot; when the first node is picked by the balancer, and set Host to &quot;host-2.com&quot; when the second is picked. I have tried ngx.req.set_header() or set the upstream_host variable in balancer phase directly and they don't seem to work. Is it a constraint by nginx modules / openresty? ### Environment * apisix version (cmd: `apisix version`): 2.5 * OS (cmd: `uname -a`): Ubuntu 18.04 * OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): 1.19.3.1 * etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): * apisix-dashboard version, if have: * luarocks version, if the issue is about installation (cmd: `luarocks --version`):</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>perf(ext-plugin): use a better API to create byte vector (#4195) Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
    <SHA>bfd69df8a9bfe63b931be7388fbf9e421ffe5c2a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: support passing different host headers in multiple nodes Fix #2620 Fix #4197 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>46c125e35bb7e3e66c63436806184b49d60f82a0</SHA>
      <PATCHEDFILES>
        <FILE>apisix/balancer.lua</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>t/admin/upstream.t</FILE>
        <FILE>t/node/upstream.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: support passing different host headers in multiple nodes Fix #2620 Fix #4197 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>2c211154577dde720394df4f39c525985bcdf007</SHA>
      <PATCHEDFILES>
        <FILE>apisix/balancer.lua</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>t/admin/upstream.t</FILE>
        <FILE>t/node/upstream.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>feat: support passing different host headers in multiple nodes (#4208) Fix #2620 Fix #4197 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>045c35140fa5b21d1f447030be3769eea3f13e14</SHA>
      <PATCHEDFILES>
        <FILE>apisix/balancer.lua</FILE>
        <FILE>apisix/init.lua</FILE>
        <FILE>apisix/upstream.lua</FILE>
        <FILE>t/admin/upstream.t</FILE>
        <FILE>t/node/upstream.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
