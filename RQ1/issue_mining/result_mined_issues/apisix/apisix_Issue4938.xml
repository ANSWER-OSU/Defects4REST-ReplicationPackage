<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4938</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/4938</ISSUEURL>
  <TITLE>测试网关稳定性时候，出现了异常：/usr/local/apigw/apisix/core/table.lua:108: in function '_deepcopy'</TITLE>
  <DESCRIPTION>### Issue description 最近在做网关测试，路由里边设置了百度的首页网址，因为百度有做防爬限流所以会报502异常，这个理论上是正常的，问题是运行了一个晚上服务器一直报： 021/08/31 08:41:12 [error] 49#49: *17163909 lua entry thread aborted: runtime error: stack overflow stack traceback: coroutine 0: [C]: in function 'nkeys' /usr/local/apigw/apisix/core/table.lua:108: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' ..., client: 10.244.4.108, server: _, request: &quot;GET /key/auth?times=46217 HTTP/1.1&quot; 请求这个是什么原因，有什么影响呢，能否修复这个bug？是不是内存没有正常释放呢 附上路由配置： http://baidu.com ### Environment - apisix version (cmd: `apisix version`): - OS (cmd: `uname -a`): - OpenResty / Nginx version (cmd: `nginx -V` or `openresty -V`): - etcd version, if have (cmd: run `curl http://127.0.0.1:9090/v1/server_info` to get the info from server-info API): - apisix-dashboard version, if have: - luarocks version, if the issue is about installation (cmd: `luarocks --version`): ### Steps to reproduce 如上描述 ### Actual result /usr/local/apigw/apisix/core/table.lua:111: in function '_deepcopy' ### Error log 如上描述 ### Expected result 直接返回502，不应该报这个递归的copy异常</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>docs(cors): update expose_headers description (#4937)</MESSAGE>
    <SHA>a062a9c83bad20672babd0b0b64484220dcac16c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: avoid copying unwanted data when the domain's IP changed It happened when we are handling upstream with domain inside a route. Fix #4938 Fix #4941 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>75eb7a85d6ff8ee5e44d47a6287357c2cb01c189</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>t/node/upstream-node-dns.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: avoid copying unwanted data when the domain's IP changed (#4952) It happened when we are handling upstream with domain inside a route. Fix #4938 Fix #4941 Signed-off-by: spacewander &lt;spacewanderlzx@gmail.com&gt;</MESSAGE>
      <SHA>27c37b191f35da983d40dd42e5ea517105107567</SHA>
      <PATCHEDFILES>
        <FILE>apisix/init.lua</FILE>
        <FILE>t/node/upstream-node-dns.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
