<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2427</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/2427</ISSUEURL>
  <TITLE>bug: The echo plugin has problem with body handling.</TITLE>
  <DESCRIPTION>### Issue description In the scenario where the response body is transmitted in segments(trunked), the echo plugin has issues with body handling. ![image](https://user-images.githubusercontent.com/3816205/96079139-9a5d3a00-0ee6-11eb-94b1-64833f329e0c.png) If the response body is segmented, the echo plugin will return a duplicate bebore_body configuration. ![image](https://user-images.githubusercontent.com/3816205/96079325-18214580-0ee7-11eb-8840-7bdbde2a5dca.png) ### Environment * apisix version (cmd: `apisix version`): * OS: ### Minimal test code / Steps to reproduce the issue 1. 2. 3. ### What's the actual result? (including assertion message &amp; call stack if applicable) ### What's the expected result?</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>14</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>CI: move etcd cluster in docker (#2225)</MESSAGE>
    <SHA>1dfc4cdacd620e6d59c3d4c75506ff80581612eb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix(echo): modify response body correctly Fix #2427, #2554</MESSAGE>
      <SHA>96e19ddf0efd19303e43233a1387e064b01d5402</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/echo.lua</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/plugin/echo.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix(echo): modify response body correctly (#2561) Fix #2427, #2554</MESSAGE>
      <SHA>960077f2458ab4a3eba3691b9b71620f2fccb3bd</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/echo.lua</FILE>
        <FILE>t/lib/server.lua</FILE>
        <FILE>t/node/remote-addr-ipv6.t</FILE>
        <FILE>t/plugin/echo.t</FILE>
        <FILE>t/plugin/redirect.t</FILE>
        <FILE>t/router/multi-ssl-certs.t</FILE>
        <FILE>t/router/radixtree-sni.t</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
