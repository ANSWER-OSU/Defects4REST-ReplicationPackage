<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5425</ISSUENO>
  <ISSUEURL>https://github.com/apache/apisix/issues/5425</ISSUEURL>
  <TITLE>request help: How to best handle oidc providers that do not support introspection endpoints?</TITLE>
  <DESCRIPTION>### Discussed in https://github.com/apache/apisix/discussions/5416 &lt;div type='discussions-op-text'&gt; &lt;sup&gt;Originally posted by **fbartels** November 4, 2021&lt;/sup&gt; Hi, I an trying to configure openid auth for a RestAPI and we are using https://github.com/libregraph/lico as the oidc provider. Currently lico does not support introspection endpoints, so before starting to implement it I looked at it together with a developer and found that https://github.com/apache/apisix/blob/042ce5c1a6a4e040d6d6924f2d86e5534b730134/apisix/plugins/openid-connect.lua#L182 is the culprit for us. I am configuring the route in the following way: ``` curl &quot;http://127.0.0.1:9080/apisix/admin/routes/1&quot; -H &quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot; -X PUT -d ' { &quot;uri&quot;: &quot;/api/v1/*&quot;, &quot;name&quot;: &quot;Manage API&quot;, &quot;plugins&quot;: { &quot;openid-connect&quot;: { &quot;client_id&quot;: &quot;manage-api&quot;, &quot;client_secret&quot;: &quot;unconfigured&quot;, &quot;discovery&quot;: &quot;https://our-backend.local/.well-known/openid-configuration&quot;, &quot;access_token_in_authorization_header&quot;: true, &quot;bearer_only&quot;: true, &quot;use_jwks&quot;: true } }, &quot;upstream_id&quot;: &quot;1&quot; }' ``` Tracing the lua script showed that the function in https://github.com/apache/apisix/blob/042ce5c1a6a4e040d6d6924f2d86e5534b730134/apisix/plugins/openid-connect.lua#L182-L214 is setting the right headers for us, but we did not want to specify the public key in the config. Looking at the upstream library our jwks document should provide enough information to make the login succeed to we extended the if clause like this `if conf.use_jwks or conf.public_key then` along with setting `&quot;use_jwks&quot;: true` in our route configuration. This made the login succeed for us. The question is now: - do you see a better way to handle this, or should I open a pull request with our modification? I am not the biggest developer myself and hope that I have made my case clear enough. If not please let me know.&lt;/div&gt;</DESCRIPTION>
  <REPONAME>apisix</REPONAME>
  <TIMEDIFFERENCEDAYS>96</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix(admin): modify boolean parameters with PATCH (#5434)</MESSAGE>
    <SHA>cd29ba3be7e4f57e9f348838fef8242c662772d5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat(oidc): make it possible to validate tokens against provider hosted jwks document Fixes: https://github.com/apache/apisix/issues/5425 Signed-off-by: Felix Bartels &lt;felix@9wd.eu&gt;</MESSAGE>
      <SHA>f5cf028b94230fb926a2566d205db88ddc26e5f7</SHA>
      <PATCHEDFILES>
        <FILE>apisix/plugins/openid-connect.lua</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
