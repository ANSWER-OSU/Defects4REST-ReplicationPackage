<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3710</ISSUENO>
  <ISSUEURL>https://github.com/DSpace/DSpace/issues/3710</ISSUEURL>
  <TITLE>[DS-335] Minho Statistics Database Manager additions.</TITLE>
  <DESCRIPTION>&lt;i&gt;Imported from JIRA &lt;a href=&quot;https://jira.lyrasis.org/browse/DS-335&quot;&gt;[DS-335]&lt;/a&gt; created by mdiggory&lt;/i&gt; &lt;p&gt;Adding DatabaseMnager &quot;namespace&quot; support to create tables in other namespaces than the dspace default namespace&lt;/p&gt; &lt;p&gt;Modified: dspace/trunk/dspace-api/src/main/java/org/dspace/storage/rdbms/DatabaseManager.java&lt;br/&gt; ==============================================================================&lt;br/&gt; &amp;#8212; dspace/trunk/dspace-api/src/main/java/org/dspace/storage/rdbms/DatabaseManager.java (original)&lt;br/&gt; +++ dspace/trunk/dspace-api/src/main/java/org/dspace/storage/rdbms/DatabaseManager.java Sat Oct 3 02:30:56 2009&lt;br/&gt; @@ -110,7 +110,7 @@&lt;/p&gt; &lt;ul&gt; &lt;li&gt;type attacks because we are unable to determine where the input came from. Instead&lt;/li&gt; &lt;li&gt;we could pass in static integer constants which are then mapped to their sql name.&lt;br/&gt; */&lt;/li&gt; &lt;/ul&gt; &lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt; &lt;li&gt;private static final Pattern DB_SAFE_NAME = Pattern.compile(&quot;^&lt;span class=&quot;error&quot;&gt;&amp;#91;a-zA-Z_1-9&amp;#93;&lt;/span&gt;+$&quot;);&lt;br/&gt; + private static final Pattern DB_SAFE_NAME = Pattern.compile(&quot;^&lt;span class=&quot;error&quot;&gt;&amp;#91;a-zA-Z_1-9.&amp;#93;&lt;/span&gt;+$&quot;);&lt;/li&gt; &lt;/ul&gt; &lt;p&gt; /**&lt;/p&gt; &lt;ul&gt; &lt;li&gt;A map of database column information. The key is the table name, a&lt;br/&gt; @@ -1190,6 +1190,10 @@ { row.setColumn(name, results.getLong(i)); } &lt;p&gt;+ else if (jdbctype == Types.DOUBLE)&lt;br/&gt; + &lt;/p&gt; { +row.setColumn(name, results.getDouble(i)); + } &lt;p&gt; else if (jdbctype == Types.CLOB &amp;&amp; &quot;oracle&quot;.equals(dbName))&lt;br/&gt; {&lt;br/&gt; // Support CLOBs in place of TEXT columns in Oracle&lt;br/&gt; @@ -1484,6 +1488,17 @@&lt;br/&gt; try&lt;br/&gt; {&lt;br/&gt; String schema = ConfigurationManager.getProperty(&quot;db.schema&quot;);&lt;br/&gt; + String catalog = null;&lt;br/&gt; +&lt;br/&gt; + int dotIndex = table.indexOf(&quot;.&quot;);&lt;br/&gt; + if (dotIndex &gt; 0)&lt;br/&gt; + &lt;/p&gt; { +catalog = table.substring(0, dotIndex); +table = table.substring(dotIndex + 1, table.length()); +log.warn(&quot;catalog: &quot; + catalog); +log.warn(&quot;table: &quot; + table); + } &lt;p&gt;+&lt;br/&gt; connection = getConnection();&lt;/p&gt;&lt;/li&gt; &lt;/ul&gt; &lt;p&gt; DatabaseMetaData metadata = connection.getMetaData();&lt;br/&gt; @@ -1492,14 +1507,15 @@&lt;br/&gt; int max = metadata.getMaxTableNameLength();&lt;br/&gt; String tname = (table.length() &gt;= max) ? table&lt;br/&gt; .substring(0, max - 1) : table;&lt;br/&gt; -&lt;/p&gt; &lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt; &lt;li&gt;pkcolumns = metadata.getPrimaryKeys(null, schema, tname);&lt;br/&gt; +&lt;br/&gt; + pkcolumns = metadata.getPrimaryKeys(catalog, schema, tname);&lt;br/&gt; +&lt;br/&gt; Set pks = new HashSet();&lt;/li&gt; &lt;/ul&gt; &lt;p&gt; while (pkcolumns.next())&lt;br/&gt; pks.add(pkcolumns.getString(4));&lt;/p&gt; &lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt; &lt;li&gt;columns = metadata.getColumns(null, schema, tname, null);&lt;br/&gt; + columns = metadata.getColumns(catalog, schema, tname, null);&lt;/li&gt; &lt;/ul&gt; &lt;p&gt; while (columns.next())&lt;/p&gt; { Modified: dspace/trunk/dspace-api/src/main/java/org/dspace/storage/rdbms/TableRow.java ============================================================================== --- dspace/trunk/dspace-api/src/main/java/org/dspace/storage/rdbms/TableRow.java(original) +++ dspace/trunk/dspace-api/src/main/java/org/dspace/storage/rdbms/TableRow.javaSat Oct 3 02:30:56 2009 @@ -230,6 +230,47 @@ } &lt;p&gt; /**&lt;br/&gt; + * Return the double value of column.&lt;br/&gt; + *&lt;br/&gt; + * If the column's type is not an float, or the column does not exist, an&lt;br/&gt; + * IllegalArgumentException is thrown.&lt;br/&gt; + *&lt;br/&gt; + * @param column&lt;br/&gt; + * The column name (case-insensitive)&lt;br/&gt; + * @return The double value of the column, or -1 if the column is an SQL null.&lt;br/&gt; + */&lt;br/&gt; + public double getDoubleColumn(String column)&lt;br/&gt; + {&lt;br/&gt; +if (!hasColumn(column))&lt;br/&gt; +&lt;/p&gt; { + throw new IllegalArgumentException(&quot;No such column &quot; + column); +}&lt;br/&gt; +&lt;br/&gt; +String name = canonicalize(column);&lt;br/&gt; +&lt;br/&gt; +if (isColumnNull(name))&lt;br/&gt; +{ + return -1; +}&lt;br/&gt; +&lt;br/&gt; +Object value = data.get(name);&lt;br/&gt; +&lt;br/&gt; +if (value == null)&lt;br/&gt; +{ + throw new IllegalArgumentException(&quot;Column &quot; + column + + &quot; not present&quot;); +}&lt;br/&gt; +&lt;br/&gt; +if (!(value instanceof Double))&lt;br/&gt; +{ + throw new IllegalArgumentException(&quot;Value for &quot; + column + + &quot; is not a double&quot;); +}&lt;br/&gt; +&lt;br/&gt; +return ((Double) value).doubleValue();&lt;br/&gt; + }&lt;br/&gt; +&lt;br/&gt; + /**&lt;br/&gt; * Return the String value of column.&lt;br/&gt; *&lt;br/&gt; * If the column's type is not a String, or the column does not exist, an&lt;br/&gt; @@ -504,6 +545,32 @@&lt;br/&gt; }&lt;br/&gt; &lt;br/&gt; /**&lt;br/&gt; + * Set column to the double d.&lt;br/&gt; + *&lt;br/&gt; + * If the column does not exist, an IllegalArgumentException is thrown.&lt;br/&gt; + *&lt;br/&gt; + * @param column&lt;br/&gt; + * The column name (case-insensitive)&lt;br/&gt; + * @param l&lt;br/&gt; + * The double value&lt;br/&gt; + */&lt;br/&gt; + public void setColumn(String column, double d)&lt;br/&gt; + {&lt;br/&gt; +if (!hasColumn(column))&lt;br/&gt; +{+ throw new IllegalArgumentException(&quot;No such column &quot; + column);+} &lt;p&gt;+&lt;br/&gt; +String canonName = canonicalize(column);&lt;br/&gt; +Double value = new Double(d);&lt;br/&gt; +if (!value.equals(data.get(canonName)))&lt;br/&gt; +&lt;/p&gt; { + data.put(canonName, value); + changed.put(canonName, Boolean.TRUE); +} &lt;p&gt;+ }&lt;br/&gt; +&lt;br/&gt; + /**&lt;/p&gt; &lt;ul&gt; &lt;li&gt;Set column to the date d. If the date is null, the column is set to NULL&lt;/li&gt; &lt;li&gt;as well.&lt;br/&gt; *&lt;/li&gt; &lt;/ul&gt;</DESCRIPTION>
  <REPONAME>DSpace</REPONAME>
  <TIMEDIFFERENCEDAYS>46</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merged in task/main-cris/DSC-2192 (pull request #3546) Task/main cris/DSC-2192 Approved-by: Vincenzo Mecca</MESSAGE>
    <SHA>c9533e9f466fd60b9efc5bda79895029fc2a69be</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merged in task/main-cris/IIIF-180 (pull request #3710) [IIIF-180] Passed machine token to image server. Approved-by: Vincenzo Mecca</MESSAGE>
      <SHA>4b5b270e8849c2e523214dd8621ac71708a7769a</SHA>
      <PATCHEDFILES>
        <FILE>dspace/config/modules/iiifuploader.cfg</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
