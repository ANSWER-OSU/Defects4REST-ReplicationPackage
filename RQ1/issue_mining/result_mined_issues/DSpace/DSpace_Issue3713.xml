<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3713</ISSUENO>
  <ISSUEURL>https://github.com/DSpace/DSpace/issues/3713</ISSUEURL>
  <TITLE>[DS-338] Bitstream download allows caching of content that requires authorization to read</TITLE>
  <DESCRIPTION>&lt;i&gt;Imported from JIRA &lt;a href=&quot;https://jira.lyrasis.org/browse/DS-338&quot;&gt;[DS-338]&lt;/a&gt; created by lcs&lt;/i&gt; &lt;p&gt;The XMLUI requests to retrieve the contents of a Bitstream set an &quot;Expires&quot; header in the response with a very long time, which itself looks like a bug (the time is 60 hours, when the intent appears to be 1 hour). The other problem with this is that it sets &quot;Expires:&quot; even when the content is only accessible through authorization, which results in the following bug caused by aggressive browser caching: (this works best with a Bitstream that renders in the browser, such as an image or plain text)&lt;/p&gt; &lt;p&gt;1. Clear browser history (in Firefox 3, use Tools-&gt;Clear private data... dialog)&lt;br/&gt; 2. Logout of DSpace UI if logged in.&lt;br/&gt; 3. Attempt to view a Bitstream that does not have anonymous READ Â´access; you'll be redirected to the Login page.&lt;br/&gt; 4. Login, get redirected to the Bitstream. Observe that its URL is the DSpace home page, however, e.g.&lt;br/&gt; &lt;a href=&quot;http://dspace.my.edu/xmlui&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://dspace.my.edu/xmlui&lt;/a&gt;&lt;br/&gt; 5. If you check your browser's cache at this point (visit URL about:cache?device=disk in Firefox3) observe that the content of this page is cached with an expiry time of 60 hours from now.&lt;br/&gt; 6. Now go to another page such as &lt;a href=&quot;http://dspace.my.edu/xmlui/community-list&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://dspace.my.edu/xmlui/community-list&lt;/a&gt; and click &quot;Logout&quot;.&lt;br/&gt; 7. Visit the home page (without trailing /) &lt;a href=&quot;http://dspace.my.edu/xmlui&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://dspace.my.edu/xmlui&lt;/a&gt; and observe you're looking at the protected Bitstream. &lt;/p&gt; &lt;p&gt;The attached patch fixes this behavior by skipping the &quot;Expires:&quot; response header completely when the Bitstream is not anonymously readable. It also shortens the cache time to 1 hour, which will still prevent frequent reloads from loading the server.&lt;/p&gt;</DESCRIPTION>
  <REPONAME>DSpace</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merged in task/dspace-cris-2023_02_x/DSC-2226 (pull request #3761) [DSC-2226] optimize SQL queries for metadata enhancement updates Approved-by: Vincenzo Mecca</MESSAGE>
    <SHA>c576c8b80f7654d0fc29b6659c780fa6e01f5a48</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merged in task/dspace-cris-2023_02_x/DSC-2278 (pull request #3713) [DSC-2278] prevent NPE if no value-pairs has been found Approved-by: Vincenzo Mecca</MESSAGE>
      <SHA>e5334807ac1eef4f1f1dd93180880f620b295783</SHA>
      <PATCHEDFILES>
        <FILE>dspace-api/src/main/java/org/dspace/content/authority/ChoiceAuthorityServiceImpl.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
