<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>23473</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/23473</ISSUEURL>
  <TITLE>remote: run --restart=always, then wait: timeout</TITLE>
  <DESCRIPTION>``` [+0113s] not ok 110 [030] podman run --restart=always -- wait ... &lt;+ &gt; # # podman-remote run -d --restart=always --name=c_t110-iolrdtkp quay.io/libpod/testimage:20240123 false &lt;+131ms&gt; # eaa555d6a4f6dba6cdac3b177a514e853731c2bdc39ed41feb6f252be111ce66 # &lt;+009ms&gt; # # podman-remote wait c_t110-iolrdtkp &lt;+0020s&gt; # timeout: sending signal TERM to command ‘/var/tmp/go/src/github.com/containers/podman/bin/podman-remote’ &lt;+005ms&gt; # [ rc=124 (** EXPECTED 0 **) ] # *** TIMED OUT *** ``` * debian-13 : sys remote debian-13 root host sqlite [remote] * [07-31 17:52](https://api.cirrus-ci.com/v1/artifact/task/5445561392824320/html/sys-remote-debian-13-root-host-sqlite.log.html#t--00110) in [sys] [030] podman run --restart=always -- wait * fedora-40 : sys remote fedora-40 rootless host sqlite [remote] * PR #23275 * [07-31 08:24](https://api.cirrus-ci.com/v1/artifact/task/6446991591342080/html/sys-remote-fedora-40-rootless-host-sqlite.log.html#t--00089) in [sys] [030] podman run --restart=always -- wait * fedora-40-aarch64 : sys remote fedora-40-aarch64 root host sqlite [remote] * PR #23444 * [07-30 06:44](https://api.cirrus-ci.com/v1/artifact/task/4711954927845376/html/sys-remote-fedora-40-aarch64-root-host-sqlite.log.html#t--00110) in [sys] [030] podman run --restart=always -- wait * [07-22 07:48](https://api.cirrus-ci.com/v1/artifact/task/6721323668340736/html/sys-remote-fedora-40-aarch64-root-host-sqlite.log.html#t--00110) in [sys] [030] podman run --restart=always -- wait | x | x | x | x | x | x | | ---: | ---: | ---: | ---: | ---: | ---: | | sys(4) | remote(4) | fedora-40-aarch64(2) | root(3) | host(4) | sqlite(4) | | | | fedora-40(1) | rootless(1) | | | | | | debian-13(1) | | | |</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>33</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #23621 from inknos/podman-machine-fix-for-flake-23505 Fix known_hosts file clogging and remote host id</MESSAGE>
    <SHA>f456b53a0e8e3214fcb2d6c8477c06c12b39fca9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>libpod: simplify WaitForExit() The current code did several complicated state checks that simply do not work properly on a fast restarting container. It uses a special case for --restart=always but forgot to take care of --restart=on-failure which always hang for 20s until it run into the timeout. The old logic also used to call CheckConmonRunning() but synced the state before which means it may check a new conmon every time and thus misses exits. To fix the new the code is much simpler. Check the conmon pid, if it is no longer running then get then check exit file and get exit code. This is related to #23473 but I am not sure if this fixes it because we cannot reproduce. Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>8a943311db5b686af231ddc026b7a0a072eb25d2</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_api.go</FILE>
        <FILE>libpod/container_internal_linux.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
