<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>20801</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/20801</ISSUEURL>
  <TITLE>First mount of NFS volume fails with &quot;lchown... operation not permitted&quot; error</TITLE>
  <DESCRIPTION>### Issue Description I'm trying to convert some self-hosted Docker apps (nothing fancy, just a few services in a single homelab VM) to Podman, as I like the greater flexibility it provides around user namespaces. In the process, I noticed what seems to be a regression of #14766. Since that bug is locked, I figured I'd file a new one. ### Steps to reproduce the issue 1. On server `example.com`, export an NFS share at `/path` that's owned by a non-root user (e.g., 3000 in the example output below). 2. On a different machine, create an NFS volume. (Use rootful Podman to avoid issues mounting NFS as an unprivileged user.) ```$ sudo podman volume create -o type=nfs -o device=example.com:/path share``` 3. On the same machine as Step 1, run a container mounting the volume. ```$ sudo podman run --rm -v share:/mnt/share docker.io/library/alpine ls -al /mnt/share``` ### Describe the results you received The first time I run a container mounting the NFS volume, I receive the following error and the container fails to start: ``` $ sudo podman run --rm -v share:/mnt/share docker.io/library/alpine ls -al /mnt/share Error: lchown /var/lib/containers/storage/volumes/share/_data: operation not permitted ``` Subsequent `podman run` commands using the same volume run successfully and yield the expected output (e.g., listing files in the NFS share in the example above). ### Describe the results you expected I expect the container to run and list files in the mounted NFS volume. For the example above, this should look something like the following: ``` $ sudo podman run --rm -v share:/mnt/share docker.io/library/alpine ls -al /mnt/share total 5 drwxr-xr-x 2 3000 3000 2 Nov 27 20:18 . drwxr-xr-x 1 root root 4096 Nov 27 22:03 .. ``` ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.32.0 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon_2.1.6+ds1-1_amd64 path: /usr/bin/conmon version: 'conmon version 2.1.6, commit: unknown' cpuUtilization: idlePercent: 99.64 systemPercent: 0.11 userPercent: 0.26 cpus: 2 databaseBackend: boltdb distribution: codename: bookworm distribution: debian version: &quot;12&quot; eventLogger: journald freeLocks: 2047 hostname: ivy-test idMappings: gidmap: null uidmap: null kernel: 6.1.0-13-amd64 linkmode: dynamic logDriver: journald memFree: 105242624 memTotal: 2056781824 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns_1.4.0-5_amd64 path: /usr/lib/podman/aardvark-dns version: aardvark-dns 1.4.0 package: netavark_1.4.0-4_amd64 path: /usr/lib/podman/netavark version: netavark 1.4.0 ociRuntime: name: crun package: crun_1.11.1-1_amd64 path: /usr/bin/crun version: |- crun version 1.11.1 commit: 1084f9527c143699b593b44c23555fb3cc4ff2f3 rundir: /run/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt_0.0~git20231107.74e6f48-1_amd64 version: | pasta unknown version Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: true capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns_1.2.1-1_amd64 version: |- slirp4netns version 1.2.1 commit: 09e31e92fa3d2a1d3ca261adaeb012c8d75a8194 libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.4 swapFree: 1022869504 swapTotal: 1023406080 uptime: 7h 30m 33.00s (Approximately 0.29 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: {} store: configFile: /usr/share/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /var/lib/containers/storage graphRootAllocated: 15262949376 graphRootUsed: 2983059456 graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;true&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 3 runRoot: /run/containers/storage transientStore: false volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.7.2 Built: 0 BuiltTime: Wed Dec 31 18:00:00 1969 GitCommit: &quot;&quot; GoVersion: go1.21.3 Os: linux OsArch: linux/amd64 Version: 4.7.2 ``` ### Podman in a container No ### Privileged Or Rootless Privileged ### Upstream Latest Release No ### Additional environment details I'm running Debian stable (12, &quot;bookworm&quot;) with Podman packages from testing (13, &quot;trixie&quot;). This gets me Podman 4.7.2. Version 4.8.0 was just released today and isn't pacakged for Debian testing yet, but I don't see anything in the changelog to indicate this behavior has changed. Side note: Are there plans for an official Podman apt repo like Docker offers? That would be quite handy since Debian releases infrequently, and while it's possible to get newer binaries from `testing`, it seems like it'd be cleaner to have a dedicated repo. ### Additional information This bug isn't showstopper since the `NeedsChown` flag on the volume is still cleared after the first failed mount attempt, but I feel like Podman shouldn't be trying to `chown` network volumes in the first place. Maybe `NeedsChown` should always be false if a `mount` type is specified at volume creation? (When a volume creates a new directory in the host's filesystem, the initial `chown` makes sense, but when the volume just mounts an existing device, it seems unexpected.)</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #20795 from Luap99/compose-debug-leftover test/compose: remove debug leftovers</MESSAGE>
    <SHA>e4cdd4b35ad2dc617f5d33bb92abf2d433704ad4</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Use idtools.SafeChown and SafeLchown everywhere If we get an error chowning a file or directory to a UID/GID pair for something like ENOSUP or EPERM, then we should ignore as long as the UID/GID pair on disk is correct. Fixes: https://github.com/containers/podman/issues/20801 [NO NEW TESTS NEEDED] Since this is difficult to test and existing tests should be sufficient to ensure no regression. Signed-off-by: Daniel J Walsh &lt;dwalsh@redhat.com&gt;</MESSAGE>
      <SHA>c8f262fec912ed6c0d2d97b4249756f88baf552a</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal.go</FILE>
        <FILE>libpod/container_internal_common.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
