<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>16041</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/16041</ISSUEURL>
  <TITLE>SSL_CERT_FILE in podman machine's systemd environment</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** I work in an environment that uses an interception proxy, meaning I need to set the normal proxy variables as well as the SSL_CERT_FILE variable when using podman machine on my mac. In recent podman releases, the certificate file gets copied into the VM correctly and almost all of the environment variables get set correctly, except one: the SSL_CERT_FILE variable does not get set at the systemd level to point at the copied-in certificate file. As a result, I am unable to pull images when on my corporate network: ``` laptop:~ cdlueni$ env | grep -i SSL_ SSL_CERT_FILE=/Users/cdlueni/company.crt laptop:~ cdlueni$ podman machine init laptop:~ cdlueni$ podman machine start laptop:~ cdlueni$ podman pull alpine Resolved &quot;alpine&quot; as an alias (/etc/containers/registries.conf.d/000-shortnames.conf) Trying to pull docker.io/library/alpine:latest... Error: initializing source docker://alpine:latest: pinging container registry registry-1.docker.io: Get &quot;https://registry-1.docker.io/v2/&quot;: x509: certificate signed by unknown authority ``` The error on the last line is due to the proxy's certificate not being set for processes being spawned by systemd. By manually editing `/etc/systemd/system/envset-fwcfg.service` to force the SSL_CERT_FILE variable to be added to the systemd config and then restarting the podman machine I was able to successfully pull images: The changed line in `envset-fwcfg.service`: ``` ExecStart=/usr/bin/bash -c '/usr/bin/test -f ${FWCFGRAW} &amp;&amp;\ echo &quot;[Manager]\n#Got from QEMU FW_CFG\nDefaultEnvironment=$(/usr/bin/base64 -d ${FWCFGRAW} | sed -e &quot;s+|+ +g&quot;) SSL_CERT_FILE=/etc/containers/certs.d/company.crt\n&quot; &gt; ${SYSTEMD_CONF} ||\ echo &quot;[Manager]\n#Got nothing from QEMU FW_CFG\n#DefaultEnvironment=\n&quot; &gt; ${SYSTEMD_CONF}' ``` Successful pull afterward: ``` laptop:~ cdlueni$ podman machine stop laptop:~ cdlueni$ podman machine start laptop:~ cdlueni$ podman pull alpine Resolved &quot;alpine&quot; as an alias (/etc/containers/registries.conf.d/000-shortnames.conf) Trying to pull docker.io/library/alpine:latest... Getting image source signatures Copying blob sha256:9b18e9b68314027565b90ff6189d65942c0f7986da80df008b8431276885218e Copying config sha256:a6215f271958c760a2975a6765016044115dbae4b90f414eba3a448a6a26b4f6 Writing manifest to image destination Storing signatures a6215f271958c760a2975a6765016044115dbae4b90f414eba3a448a6a26b4f6 ``` It looks to me like, if the SSL_CERT_FILE variable is set on the host, then the correct path to the copy in the VM needs to be added to the systemd environment at VM boot time. **Steps to reproduce the issue:** 1. Start a podman machine on a mac with proxy and certificate variables set 2. Try to pull an image **Describe the results you received:** SSL certificate errors **Describe the results you expected:** Succesful image pull **Additional information you deem important (e.g. issue happens only occasionally):** **Output of `podman version`:** ``` Client: Podman Engine Version: 4.2.1 API Version: 4.2.1 Go Version: go1.19.1 Built: Wed Dec 31 17:00:00 1969 OS/Arch: darwin/arm64 Server: Podman Engine Version: 4.2.0 API Version: 4.2.0 Go Version: go1.18.4 Built: Thu Aug 11 08:43:11 2022 OS/Arch: linux/arm64 ``` **Output of `podman info`:** ``` (paste your output here) ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman` or `brew info podman`):** ``` port info podman podman @4.2.1_1 (sysutils) Description: Podman is a tool for running Linux containers. You can do this from a MacOS desktop as long as you have access to a linux box either running inside of a VM on the host, or available via the network. You need to install the remote client and then setup ssh connection information. Homepage: https://github.com/containers/podman Build Dependencies: go, go-md2man Runtime Dependencies: gvisor-tap-vsock, qemu Platforms: darwin, freebsd, linux License: Apache-2 Maintainers: Email: judaew@macports.org, GitHub: judaew Policy: openmaintainer ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):**</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>55</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #16498 from vrothberg/fix-16421 podman cp: fix copying with &quot;.&quot; suffix</MESSAGE>
    <SHA>94e34cc795a5a5ad2c8177a84861053eeab4cc7d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>podman machine: Propagate SSL_CERT_FILE and SSL_CERT_DIR to systemd environment. Fixes #16041. Signed-off-by: Bj√∂rn Mosler &lt;dev@bjoern.mosler.ch&gt;</MESSAGE>
      <SHA>caa2dfe01b2c2439b34b1451bdc71ad5a2e56597</SHA>
      <PATCHEDFILES>
        <FILE>pkg/machine/ignition.go</FILE>
        <FILE>pkg/machine/qemu/machine.go</FILE>
        <FILE>pkg/machine/qemu/machine_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
