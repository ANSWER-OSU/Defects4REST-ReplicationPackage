<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>16520</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/16520</ISSUEURL>
  <TITLE>Podman build http_proxy=false for remote client causes issues when using the api</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** `podman build` defaults to `http-proxy=false` [if remote](https://github.com/containers/podman/blob/main/cmd/podman/images/build.go#L172), and the behaviour seems to not be configurable in any other place than the cli flag `podman build --http-proxy` to re-enable it. This causes issues when using for example docker-compose with podman machine npipe api, which otherwise works fine, but builds are broken due to the build not having proxy variables set, and there not being any way (config files, env vars, etc.) to force the `http_proxy` option back to true, other than using plain manual podman builds with the cli flag before compose up. For now pulls (uses proxy env vars) and runs (container has proxy env vars set) work fine, but builds do not due to this special default-false option. Its unclear if this is intended behaviour, or should the behaviour be in line with the other commands? At least there could be a way to configure this somehow via env vars or a config file, since all `podman build` commands ran against a certain podman machine must include the `--http-proxy` flag. **Steps to reproduce the issue:** 1. Be behind a corporate proxy. 2. Run `podman build` from Windows for a Containerfile that has for example a `RUN yum install` step, which needs internet access and needs to go through the proxy. **Describe the results you received:** Install hangs for a while and timeouts due to the connection not using the proxy. **Describe the results you expected:** Install succeeds. **Additional information you deem important (e.g. issue happens only occasionally):** **Output of `podman version`:** ``` Client: Podman Engine Version: 4.3.0 API Version: 4.3.0 Go Version: go1.18.7 Git Commit: ad42af94903ce4f3c3cd0693e4e17e4286bf094b Built: Wed Oct 19 20:53:21 2022 OS/Arch: windows/amd64 Server: Podman Engine Version: 4.3.0 API Version: 4.3.0 Go Version: go1.18.7 Built: Fri Oct 21 11:16:35 2022 OS/Arch: linux/amd64 ``` **Output of `podman info`:** ``` host: arch: amd64 buildahVersion: 1.28.0 cgroupControllers: [] cgroupManager: cgroupfs cgroupVersion: v1 conmon: package: conmon-2.1.4-3.fc36.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.4, commit: ' cpuUtilization: idlePercent: 97.52 systemPercent: 1.16 userPercent: 1.32 cpus: 2 distribution: distribution: fedora variant: container version: &quot;36&quot; eventLogger: journald hostname: 842W6S2 idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 kernel: 5.4.72-microsoft-standard-WSL2 linkmode: dynamic logDriver: journald memFree: 2347945984 memTotal: 8346796032 networkBackend: netavark ociRuntime: name: crun package: crun-1.6-2.fc36.x86_64 path: /usr/bin/crun version: |- crun version 1.6 commit: 18cf2efbb8feb2b2f20e316520e0fd0b6c41ef4d spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: true slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-0.2.beta.0.fc36.x86_64 version: |- slirp4netns version 1.2.0-beta.0 commit: 477db14a24ff1a3de3a705e51ca2c4c1fe3dda64 libslirp: 4.6.1 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.3 swapFree: 2147483648 swapTotal: 2147483648 uptime: 5h 31m 22.00s (Approximately 0.21 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io - quay.io store: configFile: /home/user/.config/containers/storage.conf containerStore: number: 3 paused: 0 running: 3 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /home/user/.local/share/containers/storage graphRootAllocated: 269490393088 graphRootUsed: 3139219456 graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 34 runRoot: /run/user/1000/containers volumePath: /home/user/.local/share/containers/storage/volumes version: APIVersion: 4.3.0 Built: 1666340195 BuiltTime: Fri Oct 21 11:16:35 2022 GitCommit: &quot;&quot; GoVersion: go1.18.7 Os: linux OsArch: linux/amd64 Version: 4.3.0 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman` or `brew info podman`):** ``` podman-4.3.0-2.fc36.x86_64 ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** Windows WSL2 podman machine</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>23</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #16709 from vrothberg/fix-16515 kube sdnotify: run proxies for the lifespan of the service</MESSAGE>
    <SHA>6e2e9ab2273f0ec6d2a993b8968b34b045509e02</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>remote: allow --http-proxy for remote clients The remote client should be allowed to specify if the container should be run with the proxy env vars. It will still use the proxy vars from the server process and not the client. This makes podman-remote more consistent with the local version and easier to use in environments where a proxy is required. Fixes #16520 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>2dde30b93a5263e3a34d6a3797118550b9e02b23</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/common/create.go</FILE>
        <FILE>cmd/podman/images/build.go</FILE>
        <FILE>docs/source/markdown/options/http-proxy.md</FILE>
        <FILE>docs/source/markdown/podman-build.1.md.in</FILE>
        <FILE>test/e2e/build_test.go</FILE>
        <FILE>test/e2e/run_env_test.go</FILE>
        <FILE>test/system/070-build.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
