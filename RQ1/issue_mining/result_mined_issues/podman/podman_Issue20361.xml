<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>20361</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/20361</ISSUEURL>
  <TITLE>No path provided for ovmf_vars file in QEMU config with podman machine</TITLE>
  <DESCRIPTION>### Issue Description `podman machine init` on macOS (Apple Silicon, QEMU provider) results in the following line in the config: ``` &quot;file=podman-machine-default_ovmf_vars.fd,if=pflash,format=raw&quot;, ``` This then fails to start because `podman-machine-default_ovmf_vars.fd` is in `.local/share/containers/podman/machine/qemu`, which is not the working directory when qemu is launched. ``` $ podman -v podman version 4.8.0-dev ``` Commit is: b5fec41f2673f17162d0f031e29d56114c363afc ### Steps to reproduce the issue Steps to reproduce the issue 1. Run `podman machine init --now` ### Describe the results you received The command exits during the start phase with: ``` Error: qemu exited unexpectedly with exit code 1, stderr: qemu-system-aarch64: -drive file=podman-machine-default_ovmf_vars.fd,if=pflash,format=raw: Could not open 'podman-machine-default_ovmf_vars.fd': No such file or directory ``` ### Describe the results you expected The VM to start. ### podman info output ```yaml OS: darwin/arm64 provider: qemu version: 4.8.0-dev ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release Yes ### Additional environment details _No response_ ### Additional information The issue appears to be because `addArchOptions` in the qemu provider (`pkg/machine/qemu/options_darwin_arm64.go`) is called from `setNewMachineCMD` (`pkg/machine//qemu/config.go`) early on. This expects to create the option based on the path of the image file, but the path of the image file has not yet been set and is `&quot;testing&quot;`. It is set by the time that the file is created, in `prepare` and so the file is created in the correct location, it just isn't referenced with a full path. I am not sure what the right fix is here, I suspect it's either: - Set the flag in `prepare`, when the file is created. - Defer the adding arch options step until later when the image path is set. I am not quite sufficiently familiar with the structure of this code yet to make either change and be sure that I haven't broken something else.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #20391 from sstosh/nanocpu-api-test test/apiv2/20-containers.at: fix NanoCPUs tests on cgroups v1</MESSAGE>
    <SHA>02757ab20d61f6e33ef3ea73a92c9fc36bf3457c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix path for omvf vars on Darwin/arm64 On darwin arm64, we need to set the location of the ovmf vars. It should be put into the imageDir (also known as as dataDir). But because qemu determines the image path late in Init(), the image path is set something like a stream marker. Fixes #20361 [NO NEW TESTS NEEDED] Signed-off-by: Brent Baude &lt;bbaude@redhat.com&gt;</MESSAGE>
      <SHA>cad4d0ee9f356ea0fe6eeb74705557a50f12c440</SHA>
      <PATCHEDFILES>
        <FILE>pkg/machine/qemu/config.go</FILE>
        <FILE>pkg/machine/qemu/options_darwin_amd64.go</FILE>
        <FILE>pkg/machine/qemu/options_darwin_arm64.go</FILE>
        <FILE>pkg/machine/qemu/options_freebsd_amd64.go</FILE>
        <FILE>pkg/machine/qemu/options_freebsd_arm64.go</FILE>
        <FILE>pkg/machine/qemu/options_linux_amd64.go</FILE>
        <FILE>pkg/machine/qemu/options_linux_arm64.go</FILE>
        <FILE>pkg/machine/qemu/options_windows_amd64.go</FILE>
        <FILE>pkg/machine/qemu/options_windows_arm64.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
