<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15688</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15688</ISSUEURL>
  <TITLE>podman events missbehaving when there are zero events</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** podman events --stream=false is used for many test to make sure that we do not hang in the tests. However as I found out while working on https://github.com/containers/podman/pull/15673 that --events-backend=file hangs if the event log file does not exists. For --events-backend=none it also hangs for some reason? I would expect an error since there are no events. Lastly with --events-backend=journald it just errors out right away when there are no events. **Steps to reproduce the issue:** file, as rootless: ``` $ rm $XDG_RUNTIME_DIR/libpod/tmp/events/events.log $ podman events --events-backend=file --stream=false &lt;--just hangs until you create events or create the file ``` journald: first empty the journal ``` $ sudo journalctl --rotate $ sudo journalctl --vacuum-time=1s ``` ``` $ podman events --events-backend=journald --stream=false Error: failed to get journal cursor: failed to get cursor: cannot assign requested address $ podman events --events-backend=journald &lt;--same error without stream=false Error: failed to get journal cursor: failed to get cursor: cannot assign requested address ``` none: ``` $ podman events --events-backend=none --stream=false &lt;-- hangs without error $ podman events --events-backend=none &lt;-- also hangs without error ``` **Describe the results you expected:** The file backend with --stream=false should not hang as this can/will break tests. The journald backend just not fail when there are no events. The podman events with none backend should just error, there is no reason to ever run this command. **Output of `podman version`:** ``` latest main ```</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #15511 from rhatdan/codespell Fix stutters</MESSAGE>
    <SHA>5abc08df252037e2984a2b532f17ba78fdd876d4</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix hang with podman events file logger podman --events-backend file events --stream=false should never hang. The problem is that our tail library will wait for the file to be created which makes sense when we do not run with --stream=false. To fix this we can just always create the file when the logger is initialized. This would also help to report errors early on in case the file is not accessible. Fixes part one from #15688 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>c5bdb6afe741d34c32f779b6ef9508b6f1d05794</SHA>
      <PATCHEDFILES>
        <FILE>libpod/events/events_linux.go</FILE>
        <FILE>libpod/events/logfile.go</FILE>
        <FILE>libpod/runtime.go</FILE>
        <FILE>test/system/090-events.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>event backend none: return an error when reading events podman --events-backend none events should return with an error since it will never be able to actually list events. Fixes part three of #15688 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>138b09c7e28de336717191ec79c0b0bdf61b448a</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/system/events.go</FILE>
        <FILE>libpod/events/events_linux.go</FILE>
        <FILE>libpod/events/nullout.go</FILE>
        <FILE>test/system/090-events.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>event backend journald: fix problem with empty journal Currently podman events will just fail with `Error: failed to get journal cursor: failed to get cursor: cannot assign requested address` when the journal contains zero podman events. The problem is that we are using the journal accessors wrong. There is no need to call GetCursor() and compare them manually. The Next() return an integer which tells if it moved to the next or not. This means the we can remove GetCursor() which would fail when there is no entry. This also includes another bug fix. Previously the logic called Next() twice for the first entry which caused us to miss the first entry. To reproduce this issue you can run the following commands: ``` sudo journalctl --rotate sudo journalctl --vacuum-time=1s ``` Note that this will delete the full journal. Now run podman events and it fails but with this patch it works. Now generate a single event, i.e. podman pull alpine, and run podman events --until 1s. I am not sure how to get a reliable test into CI, I really do not want to delete the journal and developer or CI systems. Fixes second part of #15688 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>76980a2226278eca1c0b31224ae7bdce59d5eabb</SHA>
      <PATCHEDFILES>
        <FILE>libpod/events/journal_linux.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
