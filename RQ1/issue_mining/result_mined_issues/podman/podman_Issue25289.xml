<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>25289</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/25289</ISSUEURL>
  <TITLE>CI: new graph-based pod rm -fa flake</TITLE>
  <DESCRIPTION>New flake, most likely caused by https://github.com/containers/podman/pull/25169, so I guess it is fair to say the locking is not sound... ``` # podman-remote [options] pod rm -fa -t 0 fatal error: concurrent map writes fatal error: concurrent map writes goroutine 358 [running, locked to thread]: github.com/containers/podman/v5/libpod.removeContainerGraph.func1(0xc000791ea0, 0xc00065bc50) /var/tmp/go/src/github.com[/containers/podman/libpod/container_graph.go:483](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/container_graph.go#L483) +0x17f github.com/containers/podman/v5/libpod.traverseNodeInwards(0xc0002739f0, 0xc00047c7e0, 0x0) /var/tmp/go/src/github.com[/containers/podman/libpod/container_graph.go:356](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/container_graph.go#L356) +0x3e6 github.com/containers/podman/v5/libpod.removeContainerGraph.func2() /var/tmp/go/src/github.com[/containers/podman/libpod/container_graph.go:515](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/container_graph.go#L515) +0x1d github.com/containers/podman/v5/pkg/parallel.Enqueue.func1() /var/tmp/go/src/github.com[/containers/podman/pkg/parallel/parallel.go:67](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/parallel/parallel.go#L67) +0x182 created by github.com/containers/podman/v5/pkg/parallel.Enqueue in goroutine 336 /var/tmp/go/src/github.com[/containers/podman/pkg/parallel/parallel.go:56](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/parallel/parallel.go#L56) +0xa5 goroutine 1 [chan receive]: github.com/containers/podman/v5/pkg/api/server.(*APIServer).Serve(0xc0000ee000) /var/tmp/go/src/github.com[/containers/podman/pkg/api/server/server.go:235](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/api/server/server.go#L235) +0x168 github.com/containers/podman/v5/cmd/podman/system.restService(0xc000678c00, 0x2f3edc0, {{0x0, 0x0}, {0x0, 0x0}, 0x0, {0x7ffcf7aa7f66, 0x5f}}) /var/tmp/go/src/github.com[/containers/podman/cmd/podman/system/service_abi.go:138](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/cmd/podman/system/service_abi.go#L138) +0xbd6 github.com/containers/podman/v5/cmd/podman/system.service(0x2e70f40, {0xc0006775c0?, 0x1?, 0x3?}) /var/tmp/go/src/github.com[/containers/podman/cmd/podman/system/service.go:102](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/cmd/podman/system/service.go#L102) +0x25e github.com/spf13/cobra.(*Command).execute(0x2e70f40, {0xc0001501b0, 0x3, 0x3}) /var/tmp/go/src/github.com[/containers/podman/vendor/github.com/spf13/cobra/command.go:985](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/vendor/github.com/spf13/cobra/command.go#L985) +0xaaa github.com/spf13/cobra.(*Command).ExecuteC(0x2e590e0) /var/tmp/go/src/github.com[/containers/podman/vendor/github.com/spf13/cobra/command.go:1117](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/vendor/github.com/spf13/cobra/command.go#L1117) +0x3ff github.com/spf13/cobra.(*Command).Execute(...) /var/tmp/go/src/github.com[/containers/podman/vendor/github.com/spf13/cobra/command.go:1041](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/vendor/github.com/spf13/cobra/command.go#L1041) github.com/spf13/cobra.(*Command).ExecuteContext(...) /var/tmp/go/src/github.com[/containers/podman/vendor/github.com/spf13/cobra/command.go:1034](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/vendor/github.com/spf13/cobra/command.go#L1034) main.Execute() /var/tmp/go/src/github.com[/containers/podman/cmd/podman/root.go:119](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/cmd/podman/root.go#L119) +0xb4 main.main() /var/tmp/go/src/github.com[/containers/podman/cmd/podman/main.go:62](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/cmd/podman/main.go#L62) +0x4b2 goroutine 20 [select]: database/sql.(*DB).connectionOpener(0xc00068add0, {0x20f29f0, 0xc00059c3c0}) /usr/lib/go-1.23/src/database/sql/sql.go:1253 +0x87 created by database/sql.OpenDB in goroutine 1 /usr/lib/go-1.23/src/database/sql/sql.go:833 +0x130 goroutine 6 [chan receive]: github.com/containers/podman/v5/pkg/domain/infra.StartWatcher.func1() /var/tmp/go/src/github.com[/containers/podman/pkg/domain/infra/runtime_libpod.go:318](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/domain/infra/runtime_libpod.go#L318) +0x56 created by github.com/containers/podman/v5/pkg/domain/infra.StartWatcher in goroutine 1 /var/tmp/go/src/github.com[/containers/podman/pkg/domain/infra/runtime_libpod.go:314](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/domain/infra/runtime_libpod.go#L314) +0xa7 goroutine 25 [select]: github.com/containers/podman/v5/libpod.(*Runtime).libimageEvents.func2() /var/tmp/go/src/github.com[/containers/podman/libpod/runtime.go:747](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/runtime.go#L747) +0xda created by github.com/containers/podman/v5/libpod.(*Runtime).libimageEvents in goroutine 1 /var/tmp/go/src/github.com[/containers/podman/libpod/runtime.go:720](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/runtime.go#L720) +0xfc goroutine 5 [chan receive]: github.com/containers/common/pkg/servicereaper.reaper(0xc0002c2700) /var/tmp/go/src/github.com/containers/podman/vendor/github.com[/containers/common/pkg/servicereaper/service.go:41](https://github.com/containers/common/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/servicereaper/service.go#L41) +0x33 created by github.com/containers/common/pkg/servicereaper.Start in goroutine 1 /var/tmp/go/src/github.com/containers/podman/vendor/github.com[/containers/common/pkg/servicereaper/service.go:35](https://github.com/containers/common/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/servicereaper/service.go#L35) +0x96 goroutine 27 [chan receive]: github.com/containers/podman/v5/libpod.(*Runtime).startWorker.func1() /var/tmp/go/src/github.com[/containers/podman/libpod/runtime_worker.go:11](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/runtime_worker.go#L11) +0x6c created by github.com/containers/podman/v5/libpod.(*Runtime).startWorker in goroutine 1 /var/tmp/go/src/github.com[/containers/podman/libpod/runtime_worker.go:10](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/runtime_worker.go#L10) +0x4f goroutine 29 [syscall]: os/signal.signal_recv() /usr/lib/go-1.23/src/runtime/sigqueue.go:152 +0x29 os/signal.loop() /usr/lib/go-1.23/src/os/signal/signal_unix.go:23 +0x13 created by os/signal.Notify.func1.1 in goroutine 1 /usr/lib/go-1.23/src/os/signal/signal.go:151 +0x1f goroutine 30 [select]: github.com/containers/podman/v5/libpod/shutdown.Start.func1() /var/tmp/go/src/github.com[/containers/podman/libpod/shutdown/handler.go:56](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/shutdown/handler.go#L56) +0x87 created by github.com/containers/podman/v5/libpod/shutdown.Start in goroutine 1 /var/tmp/go/src/github.com[/containers/podman/libpod/shutdown/handler.go:55](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/shutdown/handler.go#L55) +0xe5 goroutine 51 [IO wait]: internal/poll.runtime_pollWait(0x7fae183c3650, 0x72) /usr/lib/go-1.23/src/runtime/netpoll.go:351 +0x85 internal/poll.(*pollDesc).wait(0xc000593980?, 0xe?, 0x0) /usr/lib/go-1.23/src/internal/poll/fd_poll_runtime.go:84 +0x27 internal/poll.(*pollDesc).waitRead(...) /usr/lib/go-1.23/src/internal/poll/fd_poll_runtime.go:89 internal/poll.(*FD).Accept(0xc000593980) /usr/lib/go-1.23/src/internal/poll/fd_unix.go:620 +0x295 net.(*netFD).accept(0xc000593980) /usr/lib/go-1.23/src/net/fd_unix.go:172 +0x29 net.(*UnixListener).accept(0xc0000ade30?) /usr/lib/go-1.23/src/net/unixsock_posix.go:172 +0x16 net.(*UnixListener).Accept(0xc0006abaa0) /usr/lib/go-1.23/src/net/unixsock.go:260 +0x30 net/http.(*Server).Serve(0xc0000ee000, {0x20ee880, 0xc0006abaa0}) /usr/lib/go-1.23/src/net/http/server.go:3330 +0x30c github.com/containers/podman/v5/pkg/api/server.(*APIServer).Serve.func3() /var/tmp/go/src/github.com[/containers/podman/pkg/api/server/server.go:227](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/api/server/server.go#L227) +0x32 created by github.com/containers/podman/v5/pkg/api/server.(*APIServer).Serve in goroutine 1 /var/tmp/go/src/github.com[/containers/podman/pkg/api/server/server.go:226](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/api/server/server.go#L226) +0x153 goroutine 357 [running, locked to thread]: goroutine running on other thread; stack unavailable created by github.com/containers/podman/v5/pkg/parallel.Enqueue in goroutine 336 /var/tmp/go/src/github.com[/containers/podman/pkg/parallel/parallel.go:56](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/parallel/parallel.go#L56) +0xa5 goroutine 336 [chan receive, locked to thread]: github.com/containers/podman/v5/libpod.removeContainerGraph({0x20f29b8, 0xc00065ba10}, 0xc00047c750, 0xc00065bc50, 0xc000f00748, 0x1) /var/tmp/go/src/github.com[/containers/podman/libpod/container_graph.go:524](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/container_graph.go#L524) +0x3d5 github.com/containers/podman/v5/libpod.(*Runtime).removePod(0xc000354380, {0x20f29b8, 0xc00065ba10}, 0xc00065bc50, 0x1, 0x1, 0xc000f00748) /var/tmp/go/src/github.com[/containers/podman/libpod/runtime_pod_common.go:245](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/runtime_pod_common.go#L245) +0x46a github.com/containers/podman/v5/libpod.(*Runtime).RemovePod(0xc000354380, {0x20f29b8, 0xc00065ba10}, 0xc00065bc50, 0x1, 0x1, 0xc000f00748) /var/tmp/go/src/github.com[/containers/podman/libpod/runtime_pod.go:48](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/runtime_pod.go#L48) +0x137 github.com/containers/podman/v5/pkg/api/handlers/libpod.PodDelete({0x20f0d80, 0xc00086d740}, 0xc0005ec280) /var/tmp/go/src/github.com[/containers/podman/pkg/api/handlers/libpod/pods.go:265](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/api/handlers/libpod/pods.go#L265) +0x22e github.com/containers/podman/v5/pkg/api/server.(*APIServer).apiWrapper(0xc0000ee000, 0x1e97868, {0x20f0d80, 0xc00086d740}, 0xc0005ec280, 0x0) /var/tmp/go/src/github.com[/containers/podman/pkg/api/server/handler_api.go:66](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/api/server/handler_api.go#L66) +0x9ca github.com/containers/podman/v5/pkg/api/server.(*APIServer).registerPodsHandlers.(*APIServer).APIHandler.func4({0x20f0d80?, 0xc00086d740?}, 0x1d9830c?) /var/tmp/go/src/github.com[/containers/podman/pkg/api/server/handler_api.go:26](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/api/server/handler_api.go#L26) +0x37 net/http.HandlerFunc.ServeHTTP(0xc00065b860?, {0x20f0d80?, 0xc00086d740?}, 0xc000f006c0?) /usr/lib/go-1.23/src/net/http/server.go:2220 +0x29 github.com/containers/podman/v5/pkg/api/server.newServer.referenceIDHandler.func7.1({0x20f0d80, 0xc00086d740}, 0xc0005ec280) /var/tmp/go/src/github.com[/containers/podman/pkg/api/server/handler_rid.go:40](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/api/server/handler_rid.go#L40) +0x14f net/http.HandlerFunc.ServeHTTP(0x20eec40?, {0x20f0d80?, 0xc00086d740?}, 0x0?) /usr/lib/go-1.23/src/net/http/server.go:2220 +0x29 github.com/gorilla/handlers.loggingHandler.ServeHTTP({{0x20e0220, 0x2f67840}, {0x20e1b60, 0xc0011ff4b8}, 0x1e979b0}, {0x20eec40, 0xc000eca1c0}, 0xc0005ec280) /var/tmp/go/src/github.com[/containers/podman/vendor/github.com/gorilla/handlers/logging.go:47](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/vendor/github.com/gorilla/handlers/logging.go#L47) +0xef github.com/containers/podman/v5/pkg/api/server.newServer.panicHandler.func6.1({0x20eec40?, 0xc000eca1c0?}, 0xc00065ba10?) /var/tmp/go/src/github.com[/containers/podman/pkg/api/server/handler_panic.go:31](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/api/server/handler_panic.go#L31) +0x63 net/http.HandlerFunc.ServeHTTP(0xc0005ec000?, {0x20eec40?, 0xc000eca1c0?}, 0x507609?) /usr/lib/go-1.23/src/net/http/server.go:2220 +0x29 github.com/gorilla/mux.(*Router).ServeHTTP(0xc0000ec000, {0x20eec40, 0xc000eca1c0}, 0xc0004bdb80) /var/tmp/go/src/github.com[/containers/podman/vendor/github.com/gorilla/mux/mux.go:212](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/vendor/github.com/gorilla/mux/mux.go#L212) +0x1e2 net/http.serverHandler.ServeHTTP({0xc0008306f0?}, {0x20eec40?, 0xc000eca1c0?}, 0x6?) /usr/lib/go-1.23/src/net/http/server.go:3210 +0x8e net/http.(*conn).serve(0xc000fee480, {0x20f29b8, 0xc000830630}) /usr/lib/go-1.23/src/net/http/server.go:2092 +0x5d0 created by net/http.(*Server).Serve in goroutine 51 /usr/lib/go-1.23/src/net/http/server.go:3360 +0x485 goroutine 356 [IO wait]: internal/poll.runtime_pollWait(0x7fae183c2ea8, 0x72) /usr/lib/go-1.23/src/runtime/netpoll.go:351 +0x85 internal/poll.(*pollDesc).wait(0xc00085db80?, 0xc000830701?, 0x0) /usr/lib/go-1.23/src/internal/poll/fd_poll_runtime.go:84 +0x27 internal/poll.(*pollDesc).waitRead(...) /usr/lib/go-1.23/src/internal/poll/fd_poll_runtime.go:89 internal/poll.(*FD).Read(0xc00085db80, {0xc000830701, 0x1, 0x1}) /usr/lib/go-1.23/src/internal/poll/fd_unix.go:165 +0x27a net.(*netFD).Read(0xc00085db80, {0xc000830701?, 0xc000c4f650?, 0xc000c4f660?}) /usr/lib/go-1.23/src/net/fd_posix.go:55 +0x25 net.(*conn).Read(0xc0005915c8, {0xc000830701?, 0x0?, 0x0?}) /usr/lib/go-1.23/src/net/net.go:189 +0x45 net/http.(*connReader).backgroundRead(0xc0008306f0) /usr/lib/go-1.23/src/net/http/server.go:690 +0x37 created by net/http.(*connReader).startBackgroundRead in goroutine 336 /usr/lib/go-1.23/src/net/http/server.go:686 +0xb6 goroutine 357 [running, locked to thread]: github.com/containers/podman/v5/libpod.removeContainerGraph.func1(0xc000791a40, 0xc00065bc50) /var/tmp/go/src/github.com[/containers/podman/libpod/container_graph.go:483](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/container_graph.go#L483) +0x17f github.com/containers/podman/v5/libpod.traverseNodeInwards(0xc0002739a0, 0xc00047c7e0, 0x0) /var/tmp/go/src/github.com[/containers/podman/libpod/container_graph.go:356](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/container_graph.go#L356) +0x3e6 github.com/containers/podman/v5/libpod.removeContainerGraph.func2() /var/tmp/go/src/github.com[/containers/podman/libpod/container_graph.go:515](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/libpod/container_graph.go#L515) +0x1d github.com/containers/podman/v5/pkg/parallel.Enqueue.func1() /var/tmp/go/src/github.com[/containers/podman/pkg/parallel/parallel.go:67](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/parallel/parallel.go#L67) +0x182 created by github.com/containers/podman/v5/pkg/parallel.Enqueue in goroutine 336 /var/tmp/go/src/github.com[/containers/podman/pkg/parallel/parallel.go:56](https://github.com/containers/podman/blob/74a100f542b85373bbba9e9466d86443873c0f4d/pkg/parallel/parallel.go#L56) +0xa5 ``` https://api.cirrus-ci.com/v1/artifact/task/4575829654503424/html/int-remote-debian-13-root-host-sqlite.log.html#t--Podman-kube-play-test-volumes-from-annotation-with-source-container-in-pod--1</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #25179 from Honny1/artifact-add-append Create `--append` flag to add file to existing artifact using `podman artifact add` command</MESSAGE>
    <SHA>af209f5cefe2b846ad24bf6fa6e2c20bf57d9ded</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Add SyncMap package and use it for graph stop/remove This greatly simplifies the locking around these two functions, and things end up looking a lot more elegant. This should prevent the race flakes we were seeing before. Fixes #25289 Signed-off-by: Matt Heon &lt;mheon@redhat.com&gt;</MESSAGE>
      <SHA>976ddc783cdc36072b354c2224aaed1e7c6789fe</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_graph.go</FILE>
        <FILE>pkg/syncmap/syncmap.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Add SyncMap package and use it for graph stop/remove This greatly simplifies the locking around these two functions, and things end up looking a lot more elegant. This should prevent the race flakes we were seeing before. Fixes #25289 Signed-off-by: Matt Heon &lt;mheon@redhat.com&gt;</MESSAGE>
      <SHA>6c3e36f4f98807801b50c0ca7f94db02f744b75f</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_graph.go</FILE>
        <FILE>pkg/syncmap/syncmap.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Add syncmap package and use it for graph stop/remove This greatly simplifies the locking around these two functions, and things end up looking a lot more elegant. This should prevent the race flakes we were seeing before. Fixes #25289 Signed-off-by: Matt Heon &lt;mheon@redhat.com&gt;</MESSAGE>
      <SHA>58c764d45356c0a46affee1be872a915a686aad0</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_graph.go</FILE>
        <FILE>pkg/syncmap/syncmap.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Add syncmap package and use it for graph stop/remove This greatly simplifies the locking around these two functions, and things end up looking a lot more elegant. This should prevent the race flakes we were seeing before. Fixes #25289 Signed-off-by: Matt Heon &lt;mheon@redhat.com&gt;</MESSAGE>
      <SHA>0f443f22cabf8593ec9478b8876d027166161ca9</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_graph.go</FILE>
        <FILE>pkg/syncmap/syncmap.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
