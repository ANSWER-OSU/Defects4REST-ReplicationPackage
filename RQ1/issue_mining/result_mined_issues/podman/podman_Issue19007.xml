<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>19007</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/19007</ISSUEURL>
  <TITLE>Pasta networking tests don't work on a host with multiple interfaces</TITLE>
  <DESCRIPTION>### Issue Description Running the tests in `test/system/505-networking-pasta.bats` can have a number of spurious failures if the host on which it is running has multiple IP addresses (either IPv4 or IPv6). This occurs because the &quot;default&quot; IP that pasta picks may not be the same as the one picked by the `ipv4_get_addr_global` helper in the test script. ### Steps to reproduce the issue Steps to reproduce the issue 1. Configure a host system with multiple global IP addresses 2. Build podman 3. Run `PODMAN=./bin/podman bats test/system/505-networking-pasta.bats` ### Describe the results you received A number of test failures which don't appear if the host only has a single global address. ### Describe the results you expected No test failures, or at least the same number as on a host with a single global IP address (currently I get several failures even in that case for reasons I'm still investigating). ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.31.0-dev cgroupControllers: - cpu - memory - pids cgroupManager: cgroupfs cgroupVersion: v2 conmon: package: conmon-2.1.7-2.fc38.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.7, commit: ' cpuUtilization: idlePercent: 96.97 systemPercent: 0.59 userPercent: 2.44 cpus: 20 databaseBackend: boltdb distribution: distribution: fedora version: &quot;38&quot; eventLogger: file freeLocks: 2047 hostname: zatzit idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 524288 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 524288 size: 65536 kernel: 6.3.8-200.fc38.x86_64 linkmode: dynamic logDriver: k8s-file memFree: 35564150784 memTotal: 67103375360 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.6.0-1.fc38.x86_64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.6.0 package: netavark-1.6.0-2.fc38.x86_64 path: /usr/libexec/podman/netavark version: netavark 1.6.0 ociRuntime: name: crun package: crun-1.8.5-1.fc38.x86_64 path: /usr/bin/crun version: |- crun version 1.8.5 commit: b6f80f766c9a89eb7b1440c0a70ab287434b17ed rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: &quot;&quot; package: &quot;&quot; version: &quot;&quot; remoteSocket: path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /bin/slirp4netns package: slirp4netns-1.2.0-12.fc38.x86_64 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.3 swapFree: 8589930496 swapTotal: 8589930496 uptime: 240h 47m 8.00s (Approximately 10.00 days) plugins: authorization: null log: - k8s-file - none - passthrough network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io - quay.io store: configFile: /home/dwg/.config/containers/storage.conf containerStore: number: 1 paused: 0 running: 1 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /home/dwg/.local/share/containers/storage graphRootAllocated: 1006801780736 graphRootUsed: 165972201472 graphStatus: Backing Filesystem: btrfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 1 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/dwg/.local/share/containers/storage/volumes version: APIVersion: 4.6.0-dev Built: 1687837239 BuiltTime: Tue Jun 27 13:40:39 2023 GitCommit: 3794d067e091573f2c9dcba05e0402a09351fa8c GoVersion: go1.20.5 Os: linux OsArch: linux/amd64 Version: 4.6.0-dev ``` ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release No ### Additional environment details Additional environment details ### Additional information Podman bulit from git commit `v4.5.0-rc1-874-g3794d067e`</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #18977 from jakecorrenti/move-qemu-functions-to-proper-files Re-organize hypervisor implementations</MESSAGE>
    <SHA>4dc2e086186e0a32931949fa856816b73de45d74</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>pasta: Fix pasta tests to work on hosts with multiple interfaces At various points the pasta bats tests need to know the name of the interface that pasta will use by default, and the host addresses it will use by default. Currently we use the pre-existing helper functions ether_get_name and ipv[46]_get_addr_global to retreive that. However, those just pick the first non-loopback interface or address, which may not be the one that pasta uses if there are multiple connected host interfaces. Replace those helpers with local ones which examine the routing table to more closely match pasta's internal logic about which interface to select. This allows the tests to run successfully on a host with multiple interfaces. Closes: https://github.com/containers/podman/issues/19007 Signed-off-by: David Gibson &lt;david@gibson.dropbear.id.au&gt;</MESSAGE>
      <SHA>fe8355be7f367593fe2527fb523d1830770ff66c</SHA>
      <PATCHEDFILES>
        <FILE>test/system/505-networking-pasta.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>pasta: Fix pasta tests to work on hosts with multiple interfaces At various points the pasta bats tests need to know the name of the interface that pasta will use by default, and the host addresses it will use by default. Currently we use the pre-existing helper functions ether_get_name and ipv[46]_get_addr_global to retreive that. However, those just pick the first non-loopback interface or address, which may not be the one that pasta uses if there are multiple connected host interfaces. Replace those helpers with local ones which examine the routing table to more closely match pasta's internal logic about which interface to select. This allows the tests to run successfully on a host with multiple interfaces. Closes: https://github.com/containers/podman/issues/19007 Signed-off-by: David Gibson &lt;david@gibson.dropbear.id.au&gt;</MESSAGE>
      <SHA>6feb179f40e7efce0b484512011c559d26e30a1d</SHA>
      <PATCHEDFILES>
        <FILE>test/system/505-networking-pasta.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
