<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14351</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14351</ISSUEURL>
  <TITLE>podman play --service-container : is not stopping (flake)</TITLE>
  <DESCRIPTION>Three flakes in my PR, finally passed on the fourth try: ``` # #| FAIL: Timed out waiting for container b9180307e1fd-service to enter state running=false ``` Unfortunately, #14338 (timeout bump) did not work. Sorry @vrothberg. ### [sys] 341 podman play --service-container * PR #14346 * [05-24 14:16](https://storage.googleapis.com/cirrus-ci-6707778565701632-fcae48/artifacts/containers/podman/4638046896259072/html/sys-podman-ubuntu-2110-rootless-host.log.html#t--00341) * [05-24 13:20](https://storage.googleapis.com/cirrus-ci-6707778565701632-fcae48/artifacts/containers/podman/5950318889402368/html/sys-podman-ubuntu-2110-rootless-host.log.html#t--00341) * [05-24 12:46](https://storage.googleapis.com/cirrus-ci-6707778565701632-fcae48/artifacts/containers/podman/5224984107810816/html/sys-podman-ubuntu-2110-rootless-host.log.html#t--00341)</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14334 from rhatdan/pod1 Allow podman pod create to accept name argument</MESSAGE>
    <SHA>b13184dfb4fbef640dc3fe421d32de068672d4ed</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>work queue: simplify and use a wait group Simplify the work-queue implementation by using a wait group. Once all queued work items are done, the channel can be closed. The system tests revealed a flake (i.e., #14351) which indicated that the service container does not always get stopped which suggests a race condition when queuing items. Those items are queued in a goroutine to prevent potential dead locks if the queue ever filled up too quickly. The race condition in question is that if a work item queues another, the goroutine for queuing may not be scheduled fast enough and the runtime shuts down; it seems to happen fairly easily on the slow CI machines. The wait group fixes this race and allows for simplifying the code. Also increase the queue's buffer size to 10 to make things slightly faster. [NO NEW TESTS NEEDED] as we are fixing a flake. Fixes: #14351 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>4a447a2133ac7e4cc42bcf5057c704ce07d31d6f</SHA>
      <PATCHEDFILES>
        <FILE>libpod/runtime.go</FILE>
        <FILE>libpod/runtime_worker.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>work queue: simplify and use a wait group Simplify the work-queue implementation by using a wait group. Once all queued work items are done, the channel can be closed. The system tests revealed a flake (i.e., #14351) which indicated that the service container does not always get stopped which suggests a race condition when queuing items. Those items are queued in a goroutine to prevent potential dead locks if the queue ever filled up too quickly. The race condition in question is that if a work item queues another, the goroutine for queuing may not be scheduled fast enough and the runtime shuts down; it seems to happen fairly easily on the slow CI machines. The wait group fixes this race and allows for simplifying the code. Also increase the queue's buffer size to 10 to make things slightly faster. [NO NEW TESTS NEEDED] as we are fixing a flake. Fixes: #14351 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>bb8db6a31397fe62f9d760faa5b2b61ccfd1b59d</SHA>
      <PATCHEDFILES>
        <FILE>libpod/runtime.go</FILE>
        <FILE>libpod/runtime_worker.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
