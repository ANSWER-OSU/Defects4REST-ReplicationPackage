<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>23754</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/23754</ISSUEURL>
  <TITLE>remote, parallel: mount no-dereference, symlink vanishes on container restart</TITLE>
  <DESCRIPTION>Infrequent flake, parallel only: ``` not ok 114 |060| podman mount no-dereference in 29851ms ... &lt;+059ms&gt; # # podman-remote create --mount type=glob,src=/tmp/CI_1GFt/podman_bats.Ibi3uH/test-restart/*,dst=/mountroot/,no-dereference --privileged localhost/img-t114-g3pkvpex sh -c stat -c '%N' /mountroot/link; cat /mountroot/link &lt;+126ms&gt; # 99135515cd3204c56414cea3ecbcb469565518d1d2feb957eac34e47194b9bf0 # &lt;+017ms&gt; # # podman-remote start -a 99135515cd3204c56414cea3ecbcb469565518d1d2feb957eac34e47194b9bf0 &lt;+350ms&gt; # '/mountroot/link' -&gt; 'data-2wFxS' # What we expect to see, fvjrwdh0je5kAQ3CKNH3 # &lt;+038ms&gt; # # podman-remote start -a 99135515cd3204c56414cea3ecbcb469565518d1d2feb957eac34e47194b9bf0 # #/vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv # #| FAIL: symlink is preserved, on restart # #| expected: = \'/mountroot/link\' -\&gt; \'data-2wFxS\' # #| actual: '' # #\^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ``` Unclear if it's a mount-is-missing but or output-is-missing. I will instrument test to narrow it down. * fedora-39 : sys remote fedora-39 root host boltdb [remote] * PR #23275 * [08-26 09:25](https://api.cirrus-ci.com/v1/artifact/task/4518663896694784/html/sys-remote-fedora-39-root-host-boltdb.log.html#t--00114p) in [sys] |060| podman mount no-dereference * [08-20 12:04](https://api.cirrus-ci.com/v1/artifact/task/6245624746606592/html/sys-remote-fedora-39-root-host-boltdb.log.html#t--00064p) in [sys] |060| podman mount no-dereference | x | x | x | x | x | x | | ---: | ---: | ---: | ---: | ---: | ---: | | sys(2) | remote(2) | fedora-39(2) | root(2) | host(2) | boltdb(2) |</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix races in the HTTP attach API This is very similar to commit 3280da0500, we cannot check the state then unlock to then lock again and do the action. Everything must happen under one lock. To fix this move the code into the HTTPAttach function in libpod. The locking here is a bit weird because attach blocks for the lifetime of attach which can be very long so we must unlock before performing the attach. Fixes #23757 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
    <SHA>bf74797c6906cf9c47a71c13caeff8f771639258</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>cleanup: add new --stopped-only option The podman container cleanup process runs asynchronous and by the time it gets the lock it is possible another podman process already did the cleanup and then did a new init() to start it again. If the cleanup process gets the lock there it will cause very weird things. This can be observed in the remote start API as CI flakes. Fixes #23754 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>a89fef6e2a630bb6912bdc1f308623e68a35271c</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/containers/cleanup.go</FILE>
        <FILE>libpod/container_api.go</FILE>
        <FILE>libpod/pod_api.go</FILE>
        <FILE>pkg/domain/entities/containers.go</FILE>
        <FILE>pkg/domain/infra/abi/containers.go</FILE>
        <FILE>pkg/specgenutil/util.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
