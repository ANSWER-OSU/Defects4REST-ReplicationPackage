<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14797</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14797</ISSUEURL>
  <TITLE>Using '.' for overlay mount source is broken</TITLE>
  <DESCRIPTION>/kind bug **Description** Using `.` to specify the current directory as the source for a volume breaks when marking the volume as an overlay mount. It seems to be resolving the working directory at a different time in the process and using the container's internal `userdata` directory instead. **Example:** Start (on host): ``` [core@localhost tst]$ ls -l total 0 -rw-r--r--. 1 core core 0 Jul 1 01:14 t1file [core@localhost tst]$ ``` Normal volume (correct): ``` [core@localhost tst]$ podman run --rm -it -v .:/app ubuntu root@9a0dd4274a1f:/# ls -la /app total 0 drwxr-xr-x. 2 root root 20 Jul 1 01:14 . dr-xr-xr-x. 1 root root 39 Jul 1 01:25 .. -rw-r--r--. 1 root root 0 Jul 1 01:14 t1file root@9a0dd4274a1f:/# ``` Overlay volume (broken): ``` [core@localhost tst]$ podman run --rm -it -v .:/app:O ubuntu root@80d75098d255:/# ls -la /app total 12 drwxr-xr-x. 1 root root 6 Jul 1 01:26 . dr-xr-xr-x. 1 root root 39 Jul 1 01:26 .. drwxr-xr-x. 2 root root 6 Jul 1 01:26 artifacts srwx------. 1 root root 0 Jul 1 01:26 attach -rw-r--r--. 1 root root 11728 Jul 1 01:26 config.json prw-r--r--. 1 root root 0 Jul 1 01:26 ctl drwx------. 3 root root 22 Jul 1 01:26 overlay drwxr-xr-x. 2 root root 6 Jul 1 01:26 secrets drwx------. 2 root root 6 Jul 1 01:26 shm prw-r--r--. 1 root root 0 Jul 1 01:26 winsz root@80d75098d255:/# ``` Overlay volume (workaround): ``` [core@localhost tst]$ podman run --rm -it -v $PWD:/app:O ubuntu root@e1deb4a0ffd0:/# ls -la /app total 0 drwxr-xr-x. 1 root root 6 Jul 1 01:27 . dr-xr-xr-x. 1 root root 39 Jul 1 01:27 .. -rw-r--r--. 1 root root 0 Jul 1 01:14 t1file root@e1deb4a0ffd0:/# ``` **Additional information you deem important (e.g. issue happens only occasionally):** I discovered this issue with Podman 3.4.4 on Ubuntu 22.04, but the above results are using podman machine to test a more recent version. **Output of `podman version`:** ``` Client: Podman Engine Version: 4.1.0 API Version: 4.1.0 Go Version: go1.18.2 Built: Mon May 30 16:03:28 2022 OS/Arch: linux/amd64 ``` **Output of `podman info --debug`:** ``` host: arch: amd64 buildahVersion: 1.26.1 cgroupControllers: - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.0-2.fc36.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.0, commit: ' cpuUtilization: idlePercent: 98.37 systemPercent: 1.05 userPercent: 0.58 cpus: 1 distribution: distribution: fedora variant: coreos version: &quot;36&quot; eventLogger: journald hostname: localhost.localdomain idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 kernel: 5.18.5-200.fc36.x86_64 linkmode: dynamic logDriver: journald memFree: 1068339200 memTotal: 2064637952 networkBackend: netavark ociRuntime: name: crun package: crun-1.4.5-1.fc36.x86_64 path: /usr/bin/crun version: |- crun version 1.4.5 commit: c381048530aa750495cf502ddb7181f2ded5b400 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-0.2.beta.0.fc36.x86_64 version: |- slirp4netns version 1.2.0-beta.0 commit: 477db14a24ff1a3de3a705e51ca2c4c1fe3dda64 libslirp: 4.6.1 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.3 swapFree: 0 swapTotal: 0 uptime: 35m 40.16s plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - docker.io store: configFile: /var/home/core/.config/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /var/home/core/.local/share/containers/storage graphRootAllocated: 10188992512 graphRootUsed: 1819590656 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 3 runRoot: /run/user/1000/containers volumePath: /var/home/core/.local/share/containers/storage/volumes version: APIVersion: 4.1.0 Built: 1653926608 BuiltTime: Mon May 30 16:03:28 2022 GitCommit: &quot;&quot; GoVersion: go1.18.2 Os: linux OsArch: linux/amd64 Version: 4.1.0 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` podman-4.1.0-8.fc36.x86_64 ```</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14704 from baude/machinestopped reveal machine error, ignore false state</MESSAGE>
    <SHA>01beba3667851c1dd68d3df1e0aa6bc8cb1ec0eb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>overlay,mount: convert lowerdir to absolute path for overlay mounts of path When mounting paths as overlay mounts we end up passing source as is to lowerdir options, resolve all relative paths in such cases for overlay mounts. Closes: https://github.com/containers/podman/issues/14797 Signed-off-by: Aditya R &lt;arajan@redhat.com&gt;</MESSAGE>
      <SHA>d6678adc92b77db13db557a0381beff1c7da8549</SHA>
      <PATCHEDFILES>
        <FILE>pkg/specgen/volumes.go</FILE>
        <FILE>test/e2e/run_volume_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
