<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>18751</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/18751</ISSUEURL>
  <TITLE>docker API returns 200 on push even if it fails</TITLE>
  <DESCRIPTION>### Issue Description docker API returns 200 on push even if it fails ### Steps to reproduce the issue Steps to reproduce the issue 1. try to push a image to a private repository 2. the repository has to reject the push 3. podman logs the rejection as error and retries ### Describe the results you received 4. podman confirms the push on the API with status 200 ### Describe the results you expected 4. podman should error on the API with status range reflecting the push error (e.g. 403) ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.30.0 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.7-2.fc37.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.7, commit: ' cpuUtilization: idlePercent: 97.99 systemPercent: 0.4 userPercent: 1.6 cpus: 16 databaseBackend: boltdb distribution: distribution: fedora variant: kde version: &quot;37&quot; eventLogger: journald hostname: thinkpad idMappings: gidmap: null uidmap: null kernel: 6.3.0-63.fc39.x86_64 linkmode: dynamic logDriver: journald memFree: 1388929024 memTotal: 29224398848 networkBackend: cni ociRuntime: name: crun package: crun-1.8.4-1.fc37.x86_64 path: /usr/bin/crun version: |- crun version 1.8.4 commit: 5a8fa99a5e41facba2eda4af12fa26313918805b rundir: /run/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-8.fc37.x86_64 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.3 swapFree: 7802028032 swapTotal: 8589930496 uptime: 235h 31m 12.00s (Approximately 9.79 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io - quay.io store: configFile: /usr/share/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 201769652224 graphRootUsed: 99855040512 graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 4 runRoot: /run/containers/storage transientStore: false volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.5.0 Built: 1681486976 BuiltTime: Fri Apr 14 17:42:56 2023 GitCommit: &quot;&quot; GoVersion: go1.19.7 Os: linux OsArch: linux/amd64 Version: 4.5.0 ``` Output from `journalctl -u podman` ``` May 31 11:02:12 thinkpad podman[498506]: @ - - [31/May/2023:11:02:12 +0200] &quot;POST /build?t=my.private.registry.local%2Fmy.image%2Fmessenger%3A0.0.1&amp;dockerfile=Containerfile&amp;rm=true HTTP/1.1&quot; 200 1527 &quot;&quot; &quot;Apache-HttpClient/5.0.3 (Java/17.0.6)&quot; May 31 11:02:12 thinkpad podman[498506]: time=&quot;2023-05-31T11:02:12+02:00&quot; level=warning msg=&quot;Failed, retrying in 1s ... (1/3). Error: writing blob: initiating layer upload to /v2/my.image/messenger/blobs/uploads/ in my.private.registry.local: unknown: Unable to upload into a virtual repository without default local deployment configured.&quot; May 31 11:02:14 thinkpad podman[498506]: time=&quot;2023-05-31T11:02:14+02:00&quot; level=warning msg=&quot;Failed, retrying in 1s ... (2/3). Error: writing blob: initiating layer upload to /v2/my.image/messenger/blobs/uploads/ in my.private.registry.local: unknown: Unable to upload into a virtual repository without default local deployment configured.&quot; May 31 11:02:15 thinkpad podman[498506]: time=&quot;2023-05-31T11:02:15+02:00&quot; level=warning msg=&quot;Failed, retrying in 1s ... (3/3). Error: writing blob: initiating layer upload to /v2/my.image/messenger/blobs/uploads/ in my.private.registry.local: unknown: Unable to upload into a virtual repository without default local deployment configured.&quot; May 31 11:02:17 thinkpad podman[498506]: @ - - [31/May/2023:11:02:12 +0200] &quot;POST /images/my.private.registry.local%2Fmy.image%2Fmessenger:0.0.1/push HTTP/1.1&quot; 200 671 &quot;&quot; &quot;Apache-HttpClient/5.0.3 (Java/17.0.6)&quot; May 31 11:02:17 thinkpad podman[498506]: 2023-05-31 11:02:12.320654708 +0200 CEST m=+6.087204790 image push 1d8a277aac651f36677366edc062de55ca26db8821309c6cece21710418f7df0 my.private.registry.local/my.image/messenger:0.0.1 ``` Output from `podman version` (Fedora 37): ``` [root@thinkpad hargut]# podman version Client: Podman Engine Version: 4.5.0 API Version: 4.5.0 Go Version: go1.19.7 Built: Fri Apr 14 17:42:56 2023 OS/Arch: linux/amd64 [root@thinkpad hargut]# rpm -q podman podman-4.5.0-1.fc37.x86_64 [root@thinkpad hargut]# ``` ### Podman in a container No ### Privileged Or Rootless Privileged ### Upstream Latest Release No ### Additional environment details Additional environment details ### Additional information Additional information like issue happens only occasionally or issue happens with a particular architecture or on a particular setting</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>18</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #18956 from vrothberg/fix-18951 compat API container create: handle platform parameter</MESSAGE>
    <SHA>2c8b679215747ffc8d3ebdece4148a5364e3915d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>compat API push: fix error handling Make sure that the push endpoint does not always return 200 even in case of a push failure. Some of the code had to be massaged since encoding a report implies sending a 200. Fixes: #18751 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>d5454189453052a6c50a7af3ff341983f46c7b03</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/images_push.go</FILE>
        <FILE>test/apiv2/12-imagesMore.at</FILE>
        <FILE>test/apiv2/70-short-names.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
