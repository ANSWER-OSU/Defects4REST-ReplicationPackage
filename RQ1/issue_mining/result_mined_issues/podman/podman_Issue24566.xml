<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24566</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/24566</ISSUEURL>
  <TITLE>Temporary failure in name resolution for service name when using docker compose with podman</TITLE>
  <DESCRIPTION>### Issue Description A docker-compose file that worked fine on podman 5.2.5 (and works fine again when downgrading to 5.2.5) is broken on 5.3.0 because the service gets a reproducible &quot;Temporary failure in name resolution&quot; error when trying to lookup the database container name. ### Steps to reproduce the issue Steps to reproduce the issue 1. Create docker-compose.yml ``` name: repro services: database: image: debian:bookworm init: true stop_grace_period: 0s command: [&quot;sleep&quot;, &quot;60&quot;] dnstest: image: debian:bookworm init: true stop_grace_period: 0s command: [&quot;getent&quot;, &quot;hosts&quot;, &quot;database&quot;] ``` 2. Run docker compose up --abort-on-container-exit 3. Observe getent exit with status 0 on podman 5.2.5, with status 2 (One or more supplied key could not be found in the database) on podman 5.3.0, oddly enough in both cases an IP/host combination is printed but in the usual DNS APIs this difference results in &quot;Temporary failure in name resolution&quot; 4. Cleanup with docker compose down ### Describe the results you received With DNS lookups in 5.3.0 I get an error when looking up one of the names of other services in the docker-compose.yml ### Describe the results you expected With DNS lookups in 5.2.5 I do get the hostname resolved to the IP of the container as I would expect. ### podman info output ```yaml For 5.3.0 host: arch: amd64 buildahVersion: 1.38.0 cgroupControllers: - cpu - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: app-containers/conmon-2.1.11 path: /usr/libexec/podman/conmon version: 'conmon version 2.1.11, commit: unknown' cpuUtilization: idlePercent: 93.8 systemPercent: 1.51 userPercent: 4.7 cpus: 24 databaseBackend: boltdb distribution: distribution: gentoo version: &quot;2.17&quot; eventLogger: journald freeLocks: 2039 hostname: taladardesktop idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 kernel: 6.11.7 linkmode: dynamic logDriver: journald memFree: 10312306688 memTotal: 67315314688 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: app-containers/aardvark-dns-1.12.2-r1 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.12.2 package: app-containers/netavark-1.12.2-r1 path: /usr/libexec/podman/netavark version: netavark 1.12.2 ociRuntime: name: crun package: app-containers/crun-1.17 path: /usr/bin/crun version: |- crun version 1.17 commit: 000fa0d4eeed8938301f3bcf8206405315bc1017 rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +YAJL os: linux pasta: executable: /usr/bin/pasta package: net-misc/passt-2024.09.06 version: | pasta 2024.09.06 Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: true path: /run/user/1000/podman/podman.sock rootlessNetworkCmd: pasta security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: app-containers/slirp4netns-1.2.0 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.5 swapFree: 0 swapTotal: 0 uptime: 71h 5m 6.00s (Approximately 2.96 days) variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: {} store: configFile: /home/taladar/.config/containers/storage.conf containerStore: number: 7 paused: 0 running: 4 stopped: 3 graphDriverName: overlay graphOptions: {} graphRoot: /home/taladar/.local/share/containers/storage graphRootAllocated: 214681255936 graphRootUsed: 169024409600 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;false&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 531 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/taladar/.local/share/containers/storage/volumes version: APIVersion: 5.3.0 Built: 1731596777 BuiltTime: Thu Nov 14 16:06:17 2024 GitCommit: &quot;&quot; GoVersion: go1.23.2 Os: linux OsArch: linux/amd64 Version: 5.3.0 For the 5.2.5 where the problem does not occur (after downgrade) host: arch: amd64 buildahVersion: 1.37.5 cgroupControllers: - cpu - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: app-containers/conmon-2.1.11 path: /usr/libexec/podman/conmon version: 'conmon version 2.1.11, commit: unknown' cpuUtilization: idlePercent: 93.79 systemPercent: 1.51 userPercent: 4.7 cpus: 24 databaseBackend: boltdb distribution: distribution: gentoo version: &quot;2.17&quot; eventLogger: journald freeLocks: 2039 hostname: taladardesktop idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 kernel: 6.11.7 linkmode: dynamic logDriver: journald memFree: 10394812416 memTotal: 67315314688 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: app-containers/aardvark-dns-1.12.2-r1 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.12.2 package: app-containers/netavark-1.12.2-r1 path: /usr/libexec/podman/netavark version: netavark 1.12.2 ociRuntime: name: crun package: app-containers/crun-1.17 path: /usr/bin/crun version: |- crun version 1.17 commit: 000fa0d4eeed8938301f3bcf8206405315bc1017 rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +YAJL os: linux pasta: executable: /usr/bin/pasta package: net-misc/passt-2024.09.06 version: | pasta 2024.09.06 Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: true path: /run/user/1000/podman/podman.sock rootlessNetworkCmd: pasta security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: app-containers/slirp4netns-1.2.0 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.5 swapFree: 0 swapTotal: 0 uptime: 71h 8m 55.00s (Approximately 2.96 days) variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: {} store: configFile: /home/taladar/.config/containers/storage.conf containerStore: number: 7 paused: 0 running: 4 stopped: 3 graphDriverName: overlay graphOptions: {} graphRoot: /home/taladar/.local/share/containers/storage graphRootAllocated: 214681255936 graphRootUsed: 169024729088 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;false&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 531 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/taladar/.local/share/containers/storage/volumes version: APIVersion: 5.2.5 Built: 1731597565 BuiltTime: Thu Nov 14 16:19:25 2024 GitCommit: &quot;&quot; GoVersion: go1.23.2 Os: linux OsArch: linux/amd64 Version: 5.2.5 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details _No response_ ### Additional information _No response_</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #24563 from slp/update-krunkit-0.1.4 Bump bundled krunkit to 0.1.4</MESSAGE>
    <SHA>777a99762c43702794dc0d1a7b31d19e38bd2f36</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>libpod: addHosts() prevent nil deref In theory RootlessNetnsInfo() should never return nil here. However that was actually only true when the rootless netns was set up before and wrote the right cache file with the ip addresses. Given this cache file is a new feature just added in 5.3 if you updated from 5.2 or earlier the file will not exists thus cause failures for all following started containers. The fix for this is to stop all containers and make sure the rootless-netns was removed so the next start creates it new with the proper 5.3 cache file. However as there is no way to rely on users doing that and it is also not requirement so simply handle the nil deref here. The only way to test this would be to run the old version then the new version which we cannot really do in CI. We do have upgrade test for that but they are root only and likely need a lot more work to get them going rootless but certainly worth to explore to prevent such problems in the future. Fixes: a1e6603133 (&quot;libpod: make use of new pasta option from c/common&quot;) Fixes: #24566 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>d513973237599a0e49c9d5a869af06e5f4d3bad9</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/container_internal_linux.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>libpod: addHosts() prevent nil deref In theory RootlessNetnsInfo() should never return nil here. However that was actually only true when the rootless netns was set up before and wrote the right cache file with the ip addresses. Given this cache file is a new feature just added in 5.3 if you updated from 5.2 or earlier the file will not exists thus cause failures for all following started containers. The fix for this is to stop all containers and make sure the rootless-netns was removed so the next start creates it new with the proper 5.3 cache file. However as there is no way to rely on users doing that and it is also not requirement so simply handle the nil deref here. The only way to test this would be to run the old version then the new version which we cannot really do in CI. We do have upgrade test for that but they are root only and likely need a lot more work to get them going rootless but certainly worth to explore to prevent such problems in the future. Fixes: a1e6603133 (&quot;libpod: make use of new pasta option from c/common&quot;) Fixes: #24566 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>a39a749ce3af82f4c4416e87df8d268b043f90f0</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal_common.go</FILE>
        <FILE>libpod/container_internal_linux.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
