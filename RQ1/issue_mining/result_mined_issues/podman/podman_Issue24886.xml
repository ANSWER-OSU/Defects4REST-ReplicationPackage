<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24886</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/24886</ISSUEURL>
  <TITLE>Podman REST API /libpod/containers/create &quot;r_limits&quot; is type integer &lt;uint64&gt;</TITLE>
  <DESCRIPTION>### Issue Description https://docs.podman.io/en/latest/_static/api.html#tag/containers/operation/ContainerCreateLibpod r_limits hard integer &lt;uint64&gt; Hard is the hard limit for the specified type soft integer &lt;uint64&gt; Soft is the soft limit for the specified type There is no direct reference to Ulimits. https://github.com/containers/podman/pull/19879 In PR 19879 Podman added support for passing Ulimits as -1 to mean min / max ### Steps to reproduce the issue /podman-py containers_create https://github.com/containers/podman-py/blob/main/podman/domain/containers_create.py ``` for item in args.pop(&quot;ulimits&quot;, []): params[&quot;r_limits&quot;].append( { &quot;type&quot;: item[&quot;Name&quot;], &quot;hard&quot;: item[&quot;Hard&quot;], &quot;soft&quot;: item[&quot;Soft&quot;], } ) ``` Code Example `client.containers.create(image=img, command=['/bin/bash'], ulimits=[{&quot;Name&quot;: &quot;memlock&quot;, &quot;Soft&quot;: -1, &quot;Hard&quot;: -1}])` ### Describe the results you received `podman.errors.exceptions.APIError: 500 Server Error: Internal Server Error (decode(): json: cannot unmarshal number -1 into Go struct field POSIXRlimit.r_limits.hard of type uint64)` ### Describe the results you expected Expected successful creation of container with memlock min/max set to maximum values. ### podman info output ```yaml [root@omitted]# podman info host: arch: amd64 buildahVersion: 1.33.11 cgroupControllers: - cpuset - cpu - cpuacct - blkio - memory - devices - freezer - net_cls - perf_event - net_prio - hugetlb - pids - rdma cgroupManager: systemd cgroupVersion: v1 conmon: package: conmon-2.1.10-1.module+el8.10.0+90449+0b7c8529.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.10, commit: 753128cb76d643886a978dba99fab8017289372d' cpuUtilization: idlePercent: 99.97 systemPercent: 0.01 userPercent: 0.02 cpus: 56 databaseBackend: sqlite distribution: distribution: ol variant: server version: &quot;8.3&quot; eventLogger: file freeLocks: 2047 hostname: omitted idMappings: gidmap: null uidmap: null kernel: 5.4.17-2011.7.4.el8uek.x86_64 linkmode: dynamic logDriver: k8s-file memFree: 142581444608 memTotal: 200959377408 networkBackend: cni networkBackendInfo: backend: cni dns: package: podman-plugins-4.9.4-18.0.1.module+el8.10.0+90449+0b7c8529.x86_64 path: /usr/libexec/cni/dnsname version: |- CNI dnsname plugin version: 1.4.0-dev commit: unknown CNI protocol versions supported: 0.1.0, 0.2.0, 0.3.0, 0.3.1, 0.4.0, 1.0.0 package: containernetworking-plugins-1.4.0-5.module+el8.10.0+90449+0b7c8529.x86_64 path: /usr/libexec/cni ociRuntime: name: runc package: runc-1.1.12-5.module+el8.10.0+90449+0b7c8529.x86_64 path: /usr/bin/runc version: |- runc version 1.1.12 spec: 1.0.2-dev go: go1.22.7 (Red Hat 1.22.7-1.module+el8.10.0+90426+810ab996) libseccomp: 2.5.2 os: linux pasta: executable: &quot;&quot; package: &quot;&quot; version: &quot;&quot; remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_NET_RAW,CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /bin/slirp4netns package: slirp4netns-1.2.0-2.module+el8.8.0+21045+adcb6a64.x86_64 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.4.0 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.2 swapFree: 4294963200 swapTotal: 4294963200 uptime: 1341h 26m 16.00s (Approximately 55.88 days) variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - container-registry.oracle.com - docker.io store: configFile: /etc/containers/storage.conf containerStore: number: 1 paused: 0 running: 1 stopped: 0 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 75125227520 graphRootUsed: 63892619264 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;false&quot; Supports volatile: &quot;false&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 33 runRoot: /run/containers/storage transientStore: false volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.9.4-rhel Built: 1732729681 BuiltTime: Wed Nov 27 17:48:01 2024 GitCommit: &quot;&quot; GoVersion: go1.22.7 (Red Hat 1.22.7-1.module+el8.10.0+90426+810ab996) Os: linux OsArch: linux/amd64 Version: 4.9.4-rhel ``` ### Podman in a container Yes ### Privileged Or Rootless Privileged ### Upstream Latest Release Yes ### Additional environment details Additional environment details ### Additional information Additional information like issue happens only occasionally or issue happens with a particular architecture or on a particular setting</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>129</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #25909 from baude/issue25884 Add ability to set layer media type for artifacts</MESSAGE>
    <SHA>a3e132055d8f9fd52f1bb79a57b1e3ffc9929e6d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder cannot directly handle negative values (e.g., -1) for fields of type uint64, as -1 is used to represent &quot;unlimited&quot; in POSIXRlimit. To address this, the request body is first decoded into a map to process the &quot;r_limits&quot; field separately. Logic was added to parse the &quot;soft&quot; and &quot;hard&quot; limits, converting -1 to uint64(-1) to represent &quot;unlimited&quot; while rejecting other invalid negative values. This approach ensures compatibility with the Podman CLI and remote API, which already handle -1 by converting it to uint64 (uint64(-1) equals 18446744073709551615) to signify &quot;unlimited&quot;. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>79cb00c54d11c09994527eb3cc81fbc61c8ddd07</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder cannot directly handle negative values (e.g., -1) for fields of type uint64, as -1 is used to represent &quot;unlimited&quot; in POSIXRlimit. To address this, the request body is first decoded into a map to process the &quot;r_limits&quot; field separately. Logic was added to parse the &quot;soft&quot; and &quot;hard&quot; limits, converting -1 to uint64(-1) to represent &quot;unlimited&quot; while rejecting other invalid negative values. This approach ensures compatibility with the Podman CLI and remote API, which already handle -1 by converting it to uint64 (uint64(-1) equals 18446744073709551615) to signify &quot;unlimited&quot;. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>af78d7b47d026667b9b68917a83c37877f71f823</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_inspect.go</FILE>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder cannot directly handle negative values (e.g., `-1`) for fields of type `uint64`, as `-1` is used to represent `max` in `POSIXRlimit`. To address this, the request body is first decoded into a map to process the `r_limits` field separately. Logic was added to parse the `soft` and `hard` limits, converting `-1` to `uint64(-1)` to represent `max` while rejecting other invalid negative values. This approach ensures compatibility with the Podman CLI and remote API, which already handle `-1` by converting it to `uint64` (`uint64(-1)` equals `18446744073709551615`) to signify `max`. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>828297d53f21c881a7409836af342fe48ed348e7</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_inspect.go</FILE>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder cannot directly handle negative values (e.g., `-1`) for fields of type `uint64`, as `-1` is used to represent `max` in `POSIXRlimit`. To address this, the request body is first decoded into a map to process the `r_limits` field separately. Logic was added to parse the `soft` and `hard` limits, converting `-1` to `uint64(-1)` to represent `max` while rejecting other invalid negative values. This approach ensures compatibility with the Podman CLI and remote API, which already handle `-1` by converting it to `uint64` (`uint64(-1)` equals `18446744073709551615`) to signify `max`. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>2bd55ff5474951cc8408fd4481a49e15c0de982f</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_inspect.go</FILE>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder cannot directly handle negative values (e.g., `-1`) for fields of type `uint64`, as `-1` is used to represent `max` in `POSIXRlimit`. To address this, the request body is first decoded into a map to process the `r_limits` field separately. Logic was added to parse the `soft` and `hard` limits, converting `-1` to `uint64(-1)` to represent `max` while rejecting other invalid negative values. This approach ensures compatibility with the Podman CLI and remote API, which already handle `-1` by converting it to `uint64` (`uint64(-1)` equals `18446744073709551615`) to signify `max`. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>e63d295d9090b6d9057bbf4eb32485f28e6fc88f</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_inspect.go</FILE>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder cannot directly handle negative values (e.g., `-1`) for fields of type `uint64`, as `-1` is used to represent `max` in `POSIXRlimit`. To address this, the request body is first decoded into a map to process the `r_limits` field separately. Logic was added to parse the `soft` and `hard` limits, converting `-1` to `uint64(-1)` to represent `max` while rejecting other invalid negative values. This approach ensures compatibility with the Podman CLI and remote API, which already handle `-1` by converting it to `uint64` (`uint64(-1)` equals `18446744073709551615`) to signify `max`. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>951c0d67c75d5c7a50f2637b344fb3b2aaaad8a5</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_inspect.go</FILE>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder cannot directly handle negative values (e.g., `-1`) for fields of type `uint64`, as `-1` is used to represent `max` in `POSIXRlimit`. To address this, the request body is first decoded into a map to process the `r_limits` field separately. Logic was added to parse the `soft` and `hard` limits, converting `-1` to `uint64(-1)` to represent `max` while rejecting other invalid negative values. This approach ensures compatibility with the Podman CLI and remote API, which already handle `-1` by converting it to `uint64` (`uint64(-1)` equals `18446744073709551615`) to signify `max`. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>6d4ad5a141a37d5ea9e91fa414eaf99c62aa4188</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_inspect.go</FILE>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder correctly cannot decode (overflow) negative values (e.g., `-1`) for fields of type `uint64`, as `-1` is used to represent `max` in `POSIXRlimit`. To handle this, the request body is first decoded into a map to process the `r_limits` field separately. Logic has been added to parse the `soft` and `hard` limits, casting `-1` to `uint64` to represent `max` while rejecting other invalid negative values. This approach ensures compatibility with the Podman CLI and remote API, which already handle `-1` by casting it to `uint64` (`uint64(-1)` equals `MaxUint64`) to signify `max`. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>c93267885f97d6f9231c64ab5b70f16d87ca33cf</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix handling of &quot;r_limits&quot; in Podman REST API /libpod/containers/create The JSON decoder correctly cannot decode (overflow) negative values (e.g., `-1`) for fields of type `uint64`, as `-1` is used to represent `max` in `POSIXRlimit`. To handle this, we use `tmpSpecGenerator` to decode the request body. The `tmpSpecGenerator` replaces the `POSIXRlimit` type with a `tmpRlimit` type that uses the `json.Number` type for decoding values. The `tmpRlimit` is then converted into the `POSIXRlimit` type and assigned to the `SpecGenerator`. This approach ensures compatibility with the Podman CLI and remote API, which already handle `-1` by casting it to `uint64` (`uint64(-1)` equals `MaxUint64`) to signify `max`. Fixes: https://issues.redhat.com/browse/RUN-2859 Fixes: https://github.com/containers/podman/issues/24886 Signed-off-by: Jan Rodák &lt;hony.com@seznam.cz&gt;</MESSAGE>
      <SHA>e66ff395b7c2618f58eb36e33e7324897ae54995</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/libpod/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
