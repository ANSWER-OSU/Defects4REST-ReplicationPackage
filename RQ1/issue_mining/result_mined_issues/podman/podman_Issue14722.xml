<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14722</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14722</ISSUEURL>
  <TITLE>volume `NeedsCopyUp` breaking nfs volumes</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** &lt;!-- Briefly describe the problem you are having in a few paragraphs. --&gt; Using nfs named volumes has broken recently in some cases. I think this is related to * https://github.com/containers/podman/pull/12733 The error is: ``` error listing contents of volume my-nfs-vol mountpoint when copying up from container ce4c558481a632701dbb70bafafa279ebb6cbc3bdfe7b94f2ebe3b1e7c98503c: open /var/lib/containers/storage/volumes/my-nfs-vol/_data: permission denied ``` My current theory is that the copy up routine is being performed as a user that doesn't have permission to write to the nfs share. In my case the only allowed user is `2000` so even uid `0` on the podman host won't have permission. The funny thing is that I'm not even convinced the pre-condition for NeedsCopyUp is met, because the `/var/www/html/data` directory in the container image is empty to start with. I have manually mounted the share using the same mount options, then `su`ed into user w/ uid `2000` and verified the mount works fine. Using `docker-ce` (on another fresh host), I've tested it with docker and it works as expected. **Steps to reproduce the issue:** 1. Create a named podman volume using nfs. The exposed share should be owned by a specific uid. In my case it is `2000` ``` podman volume create --driver local --opt type=nfs --opt device=nas.data.mydomain.com:/mnt/tank2/services/drive.mydomain.com --opt o=addr=nas.data.mydomain.com,vers=3,rw,proto=tcp my-nfs-vol ``` 3. Create a container using the mount: ``` # as root run: podman --log-level=debug run --volume my-nfs-vol:/var/www/html/data -d --rm --name nc-test --user 2000:2000 --sysctl net.ipv4.ip_unprivileged_port_start=0 docker.io/library/nextcloud:23 ``` **Describe the results you received:** ``` ..snip... DEBU[0005] Mounted container &quot;ce4c558481a632701dbb70bafafa279ebb6cbc3bdfe7b94f2ebe3b1e7c98503c&quot; at &quot;/var/lib/containers/storage/overlay/a92da0031413ce3b7c06105a3ba413727692b644f86e2620dc66d148830cc901/merged&quot; DEBU[0005] Going to mount named volume 96070d6349a4e557eb0235a2af44c319dcc488936da9aa7972c0747cee65227a DEBU[0005] Copying up contents from container ce4c558481a632701dbb70bafafa279ebb6cbc3bdfe7b94f2ebe3b1e7c98503c to volume 96070d6349a4e557eb0235a2af44c319dcc488936da9aa7972c0747cee65227a DEBU[0005] Going to mount named volume my-nfs-vol DEBU[0005] Volume my-nfs-vol mount count now at 18 DEBU[0005] Copying up contents from container ce4c558481a632701dbb70bafafa279ebb6cbc3bdfe7b94f2ebe3b1e7c98503c to volume my-nfs-vol DEBU[0005] Unmounted cont ...snip... EBU[0005] ExitCode msg: &quot;error listing contents of volume my-nfs-vol mountpoint when copying up from container ce4c558481a632701dbb70bafafa279ebb6cbc3bdfe7b94f2ebe3b1e7c98503c: open /var/lib/containers/storage/volumes/my-nfs-vol/_data: permission denied&quot; ``` **Describe the results you expected:** I expect the container to start and work with the mount. This works fine with docker-ce (on centos 9 stream) ``` docker volume create --driver local --opt type=nfs --opt device=nas.data.mydomain.com: /mnt/tank2/services/drive.mydomain.com --opt o=addr=nas.data.mydomain.com,vers=3,rw,proto=tcp --name my-nfs-vol docker run --volume my-nfs-vol:/var/www/html/data --rm --name nc-test --user 2000:2000 --sysctl net.ipv4.ip_unprivileged_port_start=0 docker.io/library/nextcloud:23 ``` **Additional information you deem important (e.g. issue happens only occasionally):** **`podman volume inspect my-nfs-vol`** ``` [ { &quot;Name&quot;: &quot;my-nfs-vol&quot;, &quot;Driver&quot;: &quot;local&quot;, &quot;Mountpoint&quot;: &quot;/var/lib/containers/storage/volumes/my-nfs-vol/_data&quot;, &quot;CreatedAt&quot;: &quot;2022-06-24T09:38:27.261661556Z&quot;, &quot;Labels&quot;: {}, &quot;Scope&quot;: &quot;local&quot;, &quot;Options&quot;: { &quot;device&quot;: &quot;nas.data.mydomain.com:/mnt/tank2/services/drive.mydomain.com&quot;, &quot;o&quot;: &quot;addr=nas.data.mydomain.com,vers=3,rw,proto=tcp&quot;, &quot;type&quot;: &quot;nfs&quot; }, &quot;MountCount&quot;: 18, &quot;NeedsCopyUp&quot;: true, &quot;NeedsChown&quot;: true } ] ``` **Output of `podman version`:** ``` Client: Podman Engine Version: 4.1.1 API Version: 4.1.1 Go Version: go1.17.5 Built: Wed Jun 15 16:59:06 2022 OS/Arch: linux/amd64 ``` **Output of `podman info --debug`:** ``` host: arch: amd64 buildahVersion: 1.26.1 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.2-2.el9.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.2, commit: 8b8ad6d5fea210d1d098d27339324d33c7a43179' cpuUtilization: idlePercent: 97 systemPercent: 1.15 userPercent: 1.85 cpus: 11 distribution: distribution: '&quot;centos&quot;' version: &quot;9&quot; eventLogger: journald hostname: container0.mgmt.mydomain.com idMappings: gidmap: null uidmap: null kernel: 5.14.0-78.el9.x86_64 linkmode: dynamic logDriver: journald memFree: 29379575808 memTotal: 32593039360 networkBackend: cni ociRuntime: name: crun package: crun-1.4.5-2.el9.x86_64 path: /usr/bin/crun version: |- crun version 1.4.5 commit: c381048530aa750495cf502ddb7181f2ded5b400 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_NET_RAW,CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /bin/slirp4netns package: slirp4netns-1.2.0-2.el9.x86_64 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.4.0 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.2 swapFree: 0 swapTotal: 0 uptime: 2h 28m 30.91s (Approximately 0.08 days) plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.access.redhat.com - registry.redhat.io - docker.io store: configFile: /etc/containers/storage.conf containerStore: number: 7 paused: 0 running: 6 stopped: 1 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 53675536384 graphRootUsed: 8166318080 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 10 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.1.1 Built: 1655312346 BuiltTime: Wed Jun 15 16:59:06 2022 GitCommit: &quot;&quot; GoVersion: go1.17.5 Os: linux OsArch: linux/amd64 Version: 4.1.1 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` podman-4.1.1-1.el9.x86_64 ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** kvm/qemu virtual machine running centos 9 stream</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>volume: drop TODO comment the two operations are equivalent since securejoin.SecureJoin() has solved the symlinks. Prefer the Lstat version though to make sure symlinks are never resolved and we do not end up using a path on the host. Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
    <SHA>a4094530bc8b0d5fdbd8ad4ce9a136fe15ee7cee</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>volume: new options [no]copy add two new options to the volume create command: copy and nocopy. When nocopy is specified, the files from the container image are not copied up to the volume. Closes: https://github.com/containers/podman/issues/14722 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
      <SHA>aada13f244d52dad9b6a1cfaa725e9d36d75a858</SHA>
      <PATCHEDFILES>
        <FILE>docs/source/markdown/podman-create.1.md</FILE>
        <FILE>docs/source/markdown/podman-run.1.md</FILE>
        <FILE>docs/source/markdown/podman-volume-create.1.md</FILE>
        <FILE>libpod/container_internal.go</FILE>
        <FILE>libpod/runtime_volume_linux.go</FILE>
        <FILE>libpod/volume_internal.go</FILE>
        <FILE>pkg/util/mountOpts.go</FILE>
        <FILE>test/e2e/run_volume_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
