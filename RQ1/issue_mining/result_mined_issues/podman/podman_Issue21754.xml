<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>21754</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/21754</ISSUEURL>
  <TITLE>docker 25 CLI is unable to run a container in quay.io/podman/upstream: default networking argument issue</TITLE>
  <DESCRIPTION>### Issue Description Hi, When using a Docker 25 CLI targetting a podman socket from `quay.io/podman/upstream`, it fails with: ``` docker: Error response from daemon: container create: invalid config provided: networks and static ip/mac address can only be used with Bridge mode networking. ``` The docker CLI 24 (and older) does work fine. Investigating a bit with socat the difference between the API calls, I end up with this request from docker 24 CLI (for the `POST /v1.41/containers/create` API call): ``` {&quot;Hostname&quot;:&quot;&quot;,&quot;Domainname&quot;:&quot;&quot;,&quot;User&quot;:&quot;&quot;,&quot;AttachStdin&quot;:true,&quot;AttachStdout&quot;:true,&quot;AttachStderr&quot;:true,&quot;Tty&quot;:true,&quot;OpenStdin&quot;:true,&quot;StdinOnce&quot;:true,&quot;Env&quot;:null,&quot;Cmd&quot;:null,&quot;Image&quot;:&quot;quay.io/fedora/fedora&quot;,&quot;Volumes&quot;:{},&quot;WorkingDir&quot;:&quot;&quot;,&quot;Entrypoint&quot;:null,&quot;OnBuild&quot;:null,&quot;Labels&quot;:{},&quot;HostConfig&quot;:{&quot;Binds&quot;:null,&quot;ContainerIDFile&quot;:&quot;&quot;,&quot;LogConfig&quot;:{&quot;Type&quot;:&quot;&quot;,&quot;Config&quot;:{}},&quot;NetworkMode&quot;:&quot;default&quot;,&quot;PortBindings&quot;:{},&quot;RestartPolicy&quot;:{&quot;Name&quot;:&quot;no&quot;,&quot;MaximumRetryCount&quot;:0},&quot;AutoRemove&quot;:true,&quot;VolumeDriver&quot;:&quot;&quot;,&quot;VolumesFrom&quot;:null,&quot;ConsoleSize&quot;:[26,227],&quot;CapAdd&quot;:null,&quot;CapDrop&quot;:null,&quot;CgroupnsMode&quot;:&quot;&quot;,&quot;Dns&quot;:[],&quot;DnsOptions&quot;:[],&quot;DnsSearch&quot;:[],&quot;ExtraHosts&quot;:null,&quot;GroupAdd&quot;:null,&quot;IpcMode&quot;:&quot;&quot;,&quot;Cgroup&quot;:&quot;&quot;,&quot;Links&quot;:null,&quot;OomScoreAdj&quot;:0,&quot;PidMode&quot;:&quot;&quot;,&quot;Privileged&quot;:false,&quot;PublishAllPorts&quot;:false,&quot;ReadonlyRootfs&quot;:false,&quot;SecurityOpt&quot;:null,&quot;UTSMode&quot;:&quot;&quot;,&quot;UsernsMode&quot;:&quot;&quot;,&quot;ShmSize&quot;:0,&quot;Isolation&quot;:&quot;&quot;,&quot;CpuShares&quot;:0,&quot;Memory&quot;:0,&quot;NanoCpus&quot;:0,&quot;CgroupParent&quot;:&quot;&quot;,&quot;BlkioWeight&quot;:0,&quot;BlkioWeightDevice&quot;:[],&quot;BlkioDeviceReadBps&quot;:[],&quot;BlkioDeviceWriteBps&quot;:[],&quot;BlkioDeviceReadIOps&quot;:[],&quot;BlkioDeviceWriteIOps&quot;:[],&quot;CpuPeriod&quot;:0,&quot;CpuQuota&quot;:0,&quot;CpuRealtimePeriod&quot;:0,&quot;CpuRealtimeRuntime&quot;:0,&quot;CpusetCpus&quot;:&quot;&quot;,&quot;CpusetMems&quot;:&quot;&quot;,&quot;Devices&quot;:[],&quot;DeviceCgroupRules&quot;:null,&quot;DeviceRequests&quot;:null,&quot;MemoryReservation&quot;:0,&quot;MemorySwap&quot;:0,&quot;MemorySwappiness&quot;:-1,&quot;OomKillDisable&quot;:false,&quot;PidsLimit&quot;:0,&quot;Ulimits&quot;:null,&quot;CpuCount&quot;:0,&quot;CpuPercent&quot;:0,&quot;IOMaximumIOps&quot;:0,&quot;IOMaximumBandwidth&quot;:0,&quot;MaskedPaths&quot;:null,&quot;ReadonlyPaths&quot;:null},&quot;NetworkingConfig&quot;:{&quot;EndpointsConfig&quot;:{}}} ``` and this request from docker 25 CLI: ``` {&quot;Hostname&quot;:&quot;&quot;,&quot;Domainname&quot;:&quot;&quot;,&quot;User&quot;:&quot;&quot;,&quot;AttachStdin&quot;:true,&quot;AttachStdout&quot;:true,&quot;AttachStderr&quot;:true,&quot;Tty&quot;:true,&quot;OpenStdin&quot;:true,&quot;StdinOnce&quot;:true,&quot;Env&quot;:null,&quot;Cmd&quot;:null,&quot;Image&quot;:&quot;quay.io/fedora/fedora&quot;,&quot;Volumes&quot;:{},&quot;WorkingDir&quot;:&quot;&quot;,&quot;Entrypoint&quot;:null,&quot;OnBuild&quot;:null,&quot;Labels&quot;:{},&quot;HostConfig&quot;:{&quot;Binds&quot;:null,&quot;ContainerIDFile&quot;:&quot;&quot;,&quot;LogConfig&quot;:{&quot;Type&quot;:&quot;&quot;,&quot;Config&quot;:{}},&quot;NetworkMode&quot;:&quot;default&quot;,&quot;PortBindings&quot;:{},&quot;RestartPolicy&quot;:{&quot;Name&quot;:&quot;no&quot;,&quot;MaximumRetryCount&quot;:0},&quot;AutoRemove&quot;:true,&quot;VolumeDriver&quot;:&quot;&quot;,&quot;VolumesFrom&quot;:null,&quot;ConsoleSize&quot;:[26,227],&quot;CapAdd&quot;:null,&quot;CapDrop&quot;:null,&quot;CgroupnsMode&quot;:&quot;&quot;,&quot;Dns&quot;:[],&quot;DnsOptions&quot;:[],&quot;DnsSearch&quot;:[],&quot;ExtraHosts&quot;:null,&quot;GroupAdd&quot;:null,&quot;IpcMode&quot;:&quot;&quot;,&quot;Cgroup&quot;:&quot;&quot;,&quot;Links&quot;:null,&quot;OomScoreAdj&quot;:0,&quot;PidMode&quot;:&quot;&quot;,&quot;Privileged&quot;:false,&quot;PublishAllPorts&quot;:false,&quot;ReadonlyRootfs&quot;:false,&quot;SecurityOpt&quot;:null,&quot;UTSMode&quot;:&quot;&quot;,&quot;UsernsMode&quot;:&quot;&quot;,&quot;ShmSize&quot;:0,&quot;Isolation&quot;:&quot;&quot;,&quot;CpuShares&quot;:0,&quot;Memory&quot;:0,&quot;NanoCpus&quot;:0,&quot;CgroupParent&quot;:&quot;&quot;,&quot;BlkioWeight&quot;:0,&quot;BlkioWeightDevice&quot;:[],&quot;BlkioDeviceReadBps&quot;:[],&quot;BlkioDeviceWriteBps&quot;:[],&quot;BlkioDeviceReadIOps&quot;:[],&quot;BlkioDeviceWriteIOps&quot;:[],&quot;CpuPeriod&quot;:0,&quot;CpuQuota&quot;:0,&quot;CpuRealtimePeriod&quot;:0,&quot;CpuRealtimeRuntime&quot;:0,&quot;CpusetCpus&quot;:&quot;&quot;,&quot;CpusetMems&quot;:&quot;&quot;,&quot;Devices&quot;:[],&quot;DeviceCgroupRules&quot;:null,&quot;DeviceRequests&quot;:null,&quot;MemoryReservation&quot;:0,&quot;MemorySwap&quot;:0,&quot;MemorySwappiness&quot;:-1,&quot;OomKillDisable&quot;:false,&quot;PidsLimit&quot;:0,&quot;Ulimits&quot;:[],&quot;CpuCount&quot;:0,&quot;CpuPercent&quot;:0,&quot;IOMaximumIOps&quot;:0,&quot;IOMaximumBandwidth&quot;:0,&quot;MaskedPaths&quot;:null,&quot;ReadonlyPaths&quot;:null},&quot;NetworkingConfig&quot;:{&quot;EndpointsConfig&quot;:{&quot;default&quot;:{&quot;IPAMConfig&quot;:null,&quot;Links&quot;:null,&quot;Aliases&quot;:null,&quot;MacAddress&quot;:&quot;&quot;,&quot;NetworkID&quot;:&quot;&quot;,&quot;EndpointID&quot;:&quot;&quot;,&quot;Gateway&quot;:&quot;&quot;,&quot;IPAddress&quot;:&quot;&quot;,&quot;IPPrefixLen&quot;:0,&quot;IPv6Gateway&quot;:&quot;&quot;,&quot;GlobalIPv6Address&quot;:&quot;&quot;,&quot;GlobalIPv6PrefixLen&quot;:0,&quot;DriverOpts&quot;:null,&quot;DNSNames&quot;:null}}}} ``` Using &quot;jq&quot; to pretty print it and show the differences, I ended up with this: ``` rgeissler@ncerndobedev6097:/tmp&gt; diff -u &lt;(cat docker-24|jq) &lt;(cat docker-25|jq) 7:11PM --- /proc/self/fd/12 2024-02-19 19:11:54.051981352 +0000 +++ /proc/self/fd/13 2024-02-19 19:11:54.055981487 +0000 @@ -81,7 +81,7 @@ &quot;MemorySwappiness&quot;: -1, &quot;OomKillDisable&quot;: false, &quot;PidsLimit&quot;: 0, - &quot;Ulimits&quot;: null, + &quot;Ulimits&quot;: [], &quot;CpuCount&quot;: 0, &quot;CpuPercent&quot;: 0, &quot;IOMaximumIOps&quot;: 0, @@ -90,6 +90,23 @@ &quot;ReadonlyPaths&quot;: null }, &quot;NetworkingConfig&quot;: { - &quot;EndpointsConfig&quot;: {} + &quot;EndpointsConfig&quot;: { + &quot;default&quot;: { + &quot;IPAMConfig&quot;: null, + &quot;Links&quot;: null, + &quot;Aliases&quot;: null, + &quot;MacAddress&quot;: &quot;&quot;, + &quot;NetworkID&quot;: &quot;&quot;, + &quot;EndpointID&quot;: &quot;&quot;, + &quot;Gateway&quot;: &quot;&quot;, + &quot;IPAddress&quot;: &quot;&quot;, + &quot;IPPrefixLen&quot;: 0, + &quot;IPv6Gateway&quot;: &quot;&quot;, + &quot;GlobalIPv6Address&quot;: &quot;&quot;, + &quot;GlobalIPv6PrefixLen&quot;: 0, + &quot;DriverOpts&quot;: null, + &quot;DNSNames&quot;: null + } + } } } ``` So the &quot;root cause&quot; is this new default &quot;EndpointsConfig&quot; struct, which seems all default initialized and which podman somehow interprets differently from an empty `{}` json config. I didn't check the code yet to see if there is a quick fix for this issue. Cheers, Romain ### Steps to reproduce the issue Steps to reproduce the issue 1. Start a `quay.io/podman/upstream` container start a podman server: ``` &gt; podman run -t -i --rm --privileged --name=podman-server -v /shared-volume --pull=always quay.io/podman/upstream podman system service -t 0 unix:///shared-volume/podman.sock Trying to pull quay.io/podman/upstream:latest... Getting image source signatures Copying blob sha256:b2013b443c422f98f009bfb9f930cc424428f8ccb694c84a26ebeb98891687f9 Copying blob sha256:cf73a40571609daa501dab6a62c1d08ca1665278b2355f5a36424804281c62fe Copying blob sha256:439ec636831d395b84ce0dfd6390420c60a8aa2a128a88b7dc55236a5e54c7a1 Copying blob sha256:2026b963063adee0348d722192a5761e34b449d666f6f79a687818f40a96a67f Copying blob sha256:718a00fe32127ad01ddab9fc4b7c968ab2679c92c6385ac6865ae6e2523275e4 Copying blob sha256:d2ea58b809bcf20a5fa73f3bce6c4ac3f371fbd010700dc0979f495f53b7fc76 Copying blob sha256:e16106bb651e790ca91447e2fc47c5a2f86e4824cd3bada6d63419f9801e4f93 Copying blob sha256:7323cd5de043ae967491a338060d6d1c51eed17c19bda023d76f72b326d7b5bf Copying blob sha256:39cd8764a88b128c21ab1816efa5c0179a803ed18ada3aa9c5f09d23b231787f Copying config sha256:8739df1320065867713c219a7efdb999e478796c0059e25143f10f54272fe833 Writing manifest to image destination ``` 2. Try to run a container inside the first one, using a docker 25 CLI. I used explicitly `--oom-score-adj=1000` to workaround the issue fixed by #21487: ``` &gt; podman run -t -i --rm --pull=always --volumes-from=podman-server -e DOCKER_HOST=unix:///shared-volume/podman.sock docker:25-cli docker run -t -i --rm --oom-score-adj=1000 quay.io/fedora/fedora Trying to pull docker.io/library/docker:25-cli... Getting image source signatures Copying blob sha256:f23a00be1976186eef218bb9b79ab99203e0c5b235c1b49e77f3ac3264793d78 Copying blob sha256:4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8 Copying blob sha256:1bd9561ee09aa7423609ac837068a53ad4a8fd35b8b6d51528d78cb126eb3b07 Copying blob sha256:4f4fb700ef54461cfa02571ae0db9a0dc1e0cdb5577484a6d75e68dc38e8acc1 Copying blob sha256:a48a116699ba1fe77921e9ab9fef2dc65016ac2e483b07f03921526b8a0fcf79 Copying blob sha256:41dc1292823582d19d9bc523915a590652c16d3bedc6099b345ec38efd77e6a0 Copying blob sha256:e56d49cdf5732fc93fbea227838e14f9772a369a669592554ca37cf4695be03d Copying blob sha256:b6735844810a03df9d76e5aa58d3df2f1c56f6c208093eba5f88e5806f1cda04 Copying blob sha256:49704df22e8621ca86fd75cb61b8f23ee280754df0048a7bf46cd8b96ec2551f Copying blob sha256:b0f5f50d82ecbeeeea34901bdac4b25948f5f7146f2842d8a7aeb9a730459567 Copying config sha256:e95f54c1fcc216bc7d10270705e5ce8f98504f69d2afba666d6ce12e940da2f6 Writing manifest to image destination Unable to find image 'quay.io/fedora/fedora:latest' locally 718a00fe3212: Download complete 368a084ba17d: Download complete docker: Error response from daemon: container create: invalid config provided: networks and static ip/mac address can only be used with Bridge mode networking. See 'docker run --help'. ``` 3. Doing exactly the same thing, with `docker:24-cli` instead works just fine: ``` &gt; podman run -t -i --rm --pull=always --volumes-from=podman-server -e DOCKER_HOST=unix:///shared-volume/podman.sock docker:24-cli docker run -t -i --rm --oom-score-adj=1000 quay.io/fedora/fedora Trying to pull docker.io/library/docker:24-cli... Getting image source signatures Copying blob sha256:4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8 Copying blob sha256:4f4fb700ef54461cfa02571ae0db9a0dc1e0cdb5577484a6d75e68dc38e8acc1 Copying blob sha256:1db5a4f146e2df1f17a2c0db7ffd672b18d1750d31c7e58e352a6536d4b7ad52 Copying blob sha256:248ec8ed73b325a9cff9ec3c5bbd2c249065ee96053dfc3beafb911ef652a195 Copying blob sha256:5aed6b72066db35b8929c11c552f9e827431de2b2de62b4384a1eaed88221787 Copying blob sha256:9908927dc97522b6d63aaaf9953c4095be9b24a1d080edb1ada9124d56bf41ad Copying blob sha256:d280e8e81156b63b7306ac0701738e22b333c7a26bdd96ddafb3ec8f607d2a32 Copying blob sha256:97f6ee5ccb7fa02811eb89d903666095e18e38c42a635369912f9ba0fd11e6eb Copying blob sha256:d4462dfff57f9ac45d562ae18d1ca53fef4918ae18e003d21ebf960b3ade6f94 Copying blob sha256:a474f84a4abb535fa3a05ee5a59bff31a53d0857d4d53bab82a9f2f3684c4c7c Copying config sha256:b4e4d47cb84703dc6042823b7e29e3111074beb09b50848a31cdb9cd9565ed9a Writing manifest to image destination [root@56d0c302cd66 /]# ^C [root@56d0c302cd66 /]# exit exit ``` ### Describe the results you received Podman cannot be used with docker 25 CLI (in container mode) while it was working with docker 24 CLI. ### Describe the results you expected Podman can be used with docker 25 CLI (in container mode). ### podman info output ```yaml Tried on `quay.io/podman/upstream` on an up to date x86_64 RHEL 9. ``` ### Podman in a container Yes ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details _No response_ ### Additional information Additional information like issue happens only occasionally or issue happens with a particular architecture or on a particular setting</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #21652 from Luap99/machine-http-proxy machine: implement http proxy logic for all providers</MESSAGE>
    <SHA>5a844511c878e64df49f8e55420ea90a8cc139de</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Ignore docker's end point config when the final network mode isn't bridge. Closes #21754 Signed-off-by: Romain Geissler &lt;romain.geissler@amadeus.com&gt;</MESSAGE>
      <SHA>127a8060abcfa6553b00a61848e6b42a13588d37</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Ignore docker's end point config when the final network mode isn't bridge. Closes #21754 Signed-off-by: Romain Geissler &lt;romain.geissler@amadeus.com&gt;</MESSAGE>
      <SHA>e349635c1ff17979073e7a3e5009343c00257280</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Ignore docker's end point config when the final network mode isn't bridge. Closes #21754 Signed-off-by: Romain Geissler &lt;romain.geissler@amadeus.com&gt;</MESSAGE>
      <SHA>bcf680b33ecb4271e7dfbd5231ada1ae474f4226</SHA>
      <PATCHEDFILES>
        <FILE>pkg/api/handlers/compat/containers_create.go</FILE>
        <FILE>test/apiv2/20-containers.at</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
