<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>20731</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/20731</ISSUEURL>
  <TITLE>Rolling back transaction to validate database: sql: transaction has already been committed or rolled back&quot; # Error: database graph driver &quot;&quot; does not match our graph driver &quot;overlay&quot;: database configuration mismatch</TITLE>
  <DESCRIPTION>Scary new flake seen in Debian CI: ``` # podman pod rm -t 0 --all --force --ignore time=&quot;2023-11-20T22:34:49Z&quot; level=error msg=&quot;Rolling back transaction to validate database: sql: transaction has already been committed or rolled back&quot; Error: database graph driver &quot;&quot; does not match our graph driver &quot;overlay&quot;: database configuration mismatch ``` Happened even before the first test. Once it happened, nothing else worked, system was completely hosed. (Possibly fixed by system reset? No way to know). https://api.cirrus-ci.com/v1/artifact/task/5989609746726912/html/sys-podman-debian-13-root-host-sqlite.log.html#t--00001</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>135</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #20753 from edsantiago/farmbuild_docs_cleanup Clean up farm-build miscommit</MESSAGE>
    <SHA>8e5e06096e4aee0dc12c8643b8742f39d1c36ba3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>sqlite: fix issue in ValidateDBConfig() If a transaction is started it must either be committed or rolled back. The function uses defer to call `tx.Rollback()` if there is an error returned. However it also called `tx.Commit()` and afterwards further errors can be returned which means it tries to roll back a already committed transaction which cannot work. This fix is to make sure tx.Commit() is the last call in that function. see https://github.com/containers/podman/issues/20731 [NO NEW TESTS NEEDED] Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>d7b970a4c4325fd93a0c5347b18d7f40b7a253c4</SHA>
      <PATCHEDFILES>
        <FILE>libpod/sqlite_state.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>sqlite: fix issue in ValidateDBConfig() If a transaction is started it must either be committed or rolled back. The function uses defer to call `tx.Rollback()` if there is an error returned. However it also called `tx.Commit()` and afterwards further errors can be returned which means it tries to roll back a already committed transaction which cannot work. This fix is to make sure tx.Commit() is the last call in that function. see https://github.com/containers/podman/issues/20731 [NO NEW TESTS NEEDED] Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>9c9d2fcaf5e29b489d2255b9eb2eacfe5230b537</SHA>
      <PATCHEDFILES>
        <FILE>libpod/sqlite_state.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
