<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14498</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14498</ISSUEURL>
  <TITLE>container state improper 409 - via stats endpoint for container in created state</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** - Its not possible to attach to stats API endpoint via `/container/{id}/stats` if the container is created via `/containers/create` endpoint and is in created/initialized state. Same applies for CLI (`podman stats {id}`). - Its working for Docker 20.10.13 &lt;!-- Briefly describe the problem you are having in a few paragraphs. --&gt; **Steps to reproduce the issue:** 1. `containerid=$(curl -s --unix-socket /run/podman/podman.sock -X POST -H &quot;Content-Type: application/json&quot; -d @payload.json &quot;http://d/containers/create&quot; | jq -r .Id)` 2. `curl -s --unix-socket /run/podman/podman.sock -X GET http://d/containers/$containerid/stats` **Describe the results you received:** Response from step2 `{&quot;cause&quot;:&quot;container state improper&quot;,&quot;message&quot;:&quot;container state improper&quot;,&quot;response&quot;:409}` **Describe the results you expected:** Empty stats are streamed ``` ... {&quot;read&quot;:&quot;0001-01-01T00:00:00Z&quot;,&quot;preread&quot;:&quot;0001-01-01T00:00:00Z&quot;,&quot;pids_stats&quot;:{},&quot;blkio_stats&quot;:{&quot;io_service_bytes_recursive&quot;:null,&quot;io_serviced_recursive&quot;:null,&quot;io_queue_recursive&quot;:null,&quot;io_service_time_recursive&quot;:null,&quot;io_wait_time_recursive&quot;:null,&quot;io_merged_recursive&quot;:null,&quot;io_time_recursive&quot;:null,&quot;sectors_recursive&quot;:null},&quot;num_procs&quot;:0,&quot;storage_stats&quot;:{},&quot;cpu_stats&quot;:{&quot;cpu_usage&quot;:{&quot;total_usage&quot;:0,&quot;usage_in_kernelmode&quot;:0,&quot;usage_in_usermode&quot;:0},&quot;throttling_data&quot;:{&quot;periods&quot;:0,&quot;throttled_periods&quot;:0,&quot;throttled_time&quot;:0}},&quot;precpu_stats&quot;:{&quot;cpu_usage&quot;:{&quot;total_usage&quot;:0,&quot;usage_in_kernelmode&quot;:0,&quot;usage_in_usermode&quot;:0},&quot;throttling_data&quot;:{&quot;periods&quot;:0,&quot;throttled_periods&quot;:0,&quot;throttled_time&quot;:0}},&quot;memory_stats&quot;:{},&quot;name&quot;:&quot;/pensive_sanderson&quot;,&quot;id&quot;:&quot;3fb3108ac3ed8e0d41062889e6f442bc79b03b73d78f6a93d0a469324acbdabf&quot;} {&quot;read&quot;:&quot;0001-01-01T00:00:00Z&quot;,&quot;preread&quot;:&quot;0001-01-01T00:00:00Z&quot;,&quot;pids_stats&quot;:{},&quot;blkio_stats&quot;:{&quot;io_service_bytes_recursive&quot;:null,&quot;io_serviced_recursive&quot;:null,&quot;io_queue_recursive&quot;:null,&quot;io_service_time_recursive&quot;:null,&quot;io_wait_time_recursive&quot;:null,&quot;io_merged_recursive&quot;:null,&quot;io_time_recursive&quot;:null,&quot;sectors_recursive&quot;:null},&quot;num_procs&quot;:0,&quot;storage_stats&quot;:{},&quot;cpu_stats&quot;:{&quot;cpu_usage&quot;:{&quot;total_usage&quot;:0,&quot;usage_in_kernelmode&quot;:0,&quot;usage_in_usermode&quot;:0},&quot;throttling_data&quot;:{&quot;periods&quot;:0,&quot;throttled_periods&quot;:0,&quot;throttled_time&quot;:0}},&quot;precpu_stats&quot;:{&quot;cpu_usage&quot;:{&quot;total_usage&quot;:0,&quot;usage_in_kernelmode&quot;:0,&quot;usage_in_usermode&quot;:0},&quot;throttling_data&quot;:{&quot;periods&quot;:0,&quot;throttled_periods&quot;:0,&quot;throttled_time&quot;:0}},&quot;memory_stats&quot;:{},&quot;name&quot;:&quot;/pensive_sanderson&quot;,&quot;id&quot;:&quot;3fb3108ac3ed8e0d41062889e6f442bc79b03b73d78f6a93d0a469324acbdabf&quot;} ... ``` **Additional information you deem important (e.g. issue happens only occasionally):** - Podman CLI returns: ``` podman stats $containerid Error: entities.ContainerStatsReport.Error: decode non empty interface: can not unmarshal into nil, error found in #9 byte of ...|{&quot;Error&quot;:{},&quot;Stats&quot;|..., bigger context ...|{&quot;Error&quot;:{},&quot;Stats&quot;:null} ``` **Output of `podman version`:** ``` Client: Podman Engine Version: 4.0.2 API Version: 4.0.2 Go Version: go1.18beta2 Built: Thu Mar 3 14:56:09 2022 OS/Arch: linux/amd64 ``` **Output of `podman info --debug`:** ``` (paste your output here)host: arch: amd64 buildahVersion: 1.24.1 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.0-2.fc36.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.0, commit: ' cpus: 8 distribution: distribution: fedora variant: coreos version: &quot;36&quot; eventLogger: journald hostname: ip-10-2-17-77 idMappings: gidmap: null uidmap: null kernel: 5.17.5-300.fc36.x86_64 linkmode: dynamic logDriver: journald memFree: 13253181440 memTotal: 32935444480 networkBackend: netavark ociRuntime: name: crun package: crun-1.4.4-1.fc36.x86_64 path: /usr/bin/crun version: |- crun version 1.4.4 commit: 6521fcc5806f20f6187eb933f9f45130c86da230 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-0.2.beta.0.fc36.x86_64 version: |- slirp4netns version 1.2.0-beta.0 commit: 477db14a24ff1a3de3a705e51ca2c4c1fe3dda64 libslirp: 4.6.1 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.3 swapFree: 0 swapTotal: 0 uptime: 96h 0m 0.13s (Approximately 4.00 days) plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - docker.io store: configFile: /usr/share/containers/storage.conf containerStore: number: 12 paused: 0 running: 3 stopped: 9 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 26 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.0.2 Built: 1646319369 BuiltTime: Thu Mar 3 14:56:09 2022 GitCommit: &quot;&quot; GoVersion: go1.18beta2 OsArch: linux/amd64 Version: 4.0.2 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` podman-4.0.2-1.fc36.x86_64 ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** No **Additional environment details (AWS, VirtualBox, physical, etc.):** - AWS - Fedora CoreOS 36.20220505.3.2</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>8</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>(rootful) docker-compose now updates network MTU Previously, the following network block did not update using docker-compose: ``` networks: default: driver: bridge driver_opts: mtu: 9000 ``` In the API, the network options were previously not being handled when the network was being created. I translated the docker options into podman options, and added the options to the network. When doing `podman network inspect &lt;network&gt;`, the results now contain `&quot;mtu&quot;: &quot;9000&quot;` Fixes: #14482 Signed-off-by: Jake Correnti &lt;jcorrenti13@gmail.com&gt;</MESSAGE>
    <SHA>d74f1b4dd8a1f28b5b4dfe29975ac38175805036</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Non-running containers now report stats via the `podman stats` command Previously, if a container was created and not running, the `stats` command would return an error: `Error: container state improper`. Like Docker, Podman now reports all 0s for the stats if the container is not running: ``` $ bin/podman stats --no-stream strange_robinson ID NAME CPU % MEM USAGE / LIMIT MEM % NET IO BLOCK IO PIDS CPU TIME AVG CPU % 146cd3530464 strange_robinson 0.00% 0B / 0B 0.00% 0B / 0B 0B / 0B 0 0s 0.00% ``` Closes: #14498 Signed-off-by: Jake Correnti &lt;jcorrenti13@gmail.com&gt;</MESSAGE>
      <SHA>c8d540f6abc133bd482a3cbf0f46465b0c7bfe46</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/containers/stats.go</FILE>
        <FILE>libpod/stats.go</FILE>
        <FILE>pkg/api/handlers/compat/containers_stats.go</FILE>
        <FILE>test/e2e/stats_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Non-running containers now report statistics via the `podman stats` command Previously, if a container was not running, and the user ran the `podman stats` command, an error would be reported: `Error: container state improper`. Podman now reports stats as the fields' default values for their respective type if the container is not running: ``` $ podman stats --no-stream demo ID NAME CPU % MEM USAGE / LIMIT MEM % NET IO BLOCK IO PIDS CPU TIME AVG CPU % 4b4bf8ce84ed demo 0.00% 0B / 0B 0.00% 0B / 0B 0B / 0B 0 0s 0.00% ``` Closes: #14498 Signed-off-by: Jake Correnti &lt;jcorrenti13@gmail.com&gt;</MESSAGE>
      <SHA>608ad7d1139d80093d1ddd933027d31af7fdee83</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/containers/stats.go</FILE>
        <FILE>libpod/stats.go</FILE>
        <FILE>pkg/api/handlers/compat/containers_stats.go</FILE>
        <FILE>test/e2e/pause_test.go</FILE>
        <FILE>test/e2e/stats_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Non-running containers now report statistics via the `podman stats` command Previously, if a container was not running, and the user ran the `podman stats` command, an error would be reported: `Error: container state improper`. Podman now reports stats as the fields' default values for their respective type if the container is not running: ``` $ podman stats --no-stream demo ID NAME CPU % MEM USAGE / LIMIT MEM % NET IO BLOCK IO PIDS CPU TIME AVG CPU % 4b4bf8ce84ed demo 0.00% 0B / 0B 0.00% 0B / 0B 0B / 0B 0 0s 0.00% ``` Closes: #14498 Signed-off-by: Jake Correnti &lt;jcorrenti13@gmail.com&gt;</MESSAGE>
      <SHA>96ccd6934b8f23d5af51514b136ed802647dc47a</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/containers/stats.go</FILE>
        <FILE>libpod/stats.go</FILE>
        <FILE>pkg/api/handlers/compat/containers_stats.go</FILE>
        <FILE>test/e2e/pause_test.go</FILE>
        <FILE>test/e2e/stats_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
