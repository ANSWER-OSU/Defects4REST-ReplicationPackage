<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>22109</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/22109</ISSUEURL>
  <TITLE>Podman 5.0.0 fails to build image on rootful machine</TITLE>
  <DESCRIPTION>### Issue Description I updated podman 5.0.0 today and tried to build an image on macOS(Arm64) Host, but it failed with an error message related to the pasta. ### Steps to reproduce the issue Steps to reproduce the issue 1. Create a simple Dockerfile like below: ```Dockerfile FROM fedora:39 RUN mkdir -p /usr/local/share/ca-certificates ``` 2. Run `podman build -t test .` ### Describe the results you received The build fails with the following error: ``` $ podman build -t test . STEP 1/2: FROM fedora:39 STEP 2/2: RUN mkdir -p /usr/local/share/ca-certificates error running container: did not get container start message from parent: EOF Error: building at STEP &quot;RUN mkdir -p /usr/local/share/ca-certificates&quot;: setup network: pasta failed with exit code 1: Don't run as root. Changing to nobody... No routable interface for IPv6: IPv6 is disabled Couldn't open network namespace /proc/2381/ns/net: Permission denied ``` ### Describe the results you expected The build should succeed. ### podman info output ```yaml $ podman --version podman version 5.0.0 $ podman info host: arch: arm64 buildahVersion: 1.35.0 cgroupControllers: - cpuset - cpu - io - memory - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.10-1.fc39.aarch64 path: /usr/bin/conmon version: 'conmon version 2.1.10, commit: ' cpuUtilization: idlePercent: 99.65 systemPercent: 0.15 userPercent: 0.21 cpus: 8 databaseBackend: sqlite distribution: distribution: fedora variant: coreos version: &quot;39&quot; eventLogger: journald freeLocks: 2048 hostname: localhost.localdomain idMappings: gidmap: null uidmap: null kernel: 6.7.7-200.fc39.aarch64 linkmode: dynamic logDriver: journald memFree: 3161096192 memTotal: 4088262656 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.10.0-1.20240312103946045036.main.18.g8377c0a.fc39.aarch64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.11.0-dev package: netavark-1.10.1-1.20240319111419242122.main.46.gcc3f35d.fc39.aarch64 path: /usr/libexec/podman/netavark version: netavark 1.11.0-dev ociRuntime: name: crun package: crun-1.14.4-1.20240302220834691516.main.10.g64ee22c.fc39.aarch64 path: /usr/bin/crun version: |- crun version UNKNOWN commit: feb70bc2ab11944a6443e4f5d2eb96a22f186b80 rundir: /run/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt-0^20240220.g1e6f92b-1.fc39.aarch64 version: | pasta 0^20240220.g1e6f92b-1.fc39.aarch64-pasta Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: true slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.2-1.fc39.aarch64 version: |- slirp4netns version 1.2.2 commit: 0ee2d87523e906518d34a6b423271e4826f71faf libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.3 swapFree: 0 swapTotal: 0 uptime: 0h 11m 1.00s variant: v8 plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - docker.io store: configFile: /usr/share/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 16574820352 graphRootUsed: 2911940608 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;true&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 3 runRoot: /run/containers/storage transientStore: false volumePath: /var/lib/containers/storage/volumes version: APIVersion: 5.0.0-dev-8a643c243 Built: 1710720000 BuiltTime: Mon Mar 18 09:00:00 2024 GitCommit: &quot;&quot; GoVersion: go1.21.8 Os: linux OsArch: linux/arm64 Version: 5.0.0-dev-8a643c243 ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release Yes ### Additional environment details Host Information ``` $ sw_vers -productVersion 14.4 $ uname -m arm64 ``` Above command worked on macOS(x86_64) Host. Fedora Core information ``` # cat /etc/*-release | grep PRETTY_NAME PRETTY_NAME=&quot;Fedora CoreOS 39.20240309.2.0&quot; # pasta --version | head -1 pasta 0^20240220.g1e6f92b-1.fc39.aarch64-pasta ``` ### Additional information _No response_</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #21481 from loongson-zjl/main Add LoongArch support for libpod</MESSAGE>
    <SHA>8241cd0e59293e9910730c6edeb65c4279ef9889</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix remote build isolation when server runs as root I am really not sure why the caller even should have the option to set this. We should always use the correct isolation type based on the privileges the server runs under never the client. podman-remote build seems to send the default based on its local privs which was wrong as well. To fix this I also changed the client to send the default if the isolation flag is not set. Fixes #22109 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>493179be456c880c55ca6434200a0847e337fb49</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/common/build.go</FILE>
        <FILE>pkg/api/handlers/compat/images_build.go</FILE>
        <FILE>pkg/machine/e2e/basic_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix remote build isolation when server runs as root I am really not sure why the caller even should have the option to set this. We should always use the correct isolation type based on the privileges the server runs under never the client. podman-remote build seems to send the default based on its local privs which was wrong as well. To fix this I also changed the client to send the default if the isolation flag is not set. Fixes #22109 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>bfc63cc325badeaccb0528295766edfeffcfc5ed</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/common/build.go</FILE>
        <FILE>pkg/api/handlers/compat/images_build.go</FILE>
        <FILE>pkg/machine/e2e/basic_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
