<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24735</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/24735</ISSUEURL>
  <TITLE>The Windows installer triggers a reboot when upgrading from 5.3.1 and WSL is not installed</TITLE>
  <DESCRIPTION>### Issue Description [This change](https://github.com/containers/podman/pull/24624/commits/7162c58ba24f6310a9b1fee52ce83340f4646ea9) introduced in 5.3.1 to the [`ForceReboot` action](https://learn.microsoft.com/en-us/windows/win32/msi/forcereboot-action) in the `InstallExecuteSequence` ```diff &lt;InstallExecuteSequence&gt; -- &lt;ForceReboot Before=&quot;StopServices&quot; Condition=&quot;(NOT Installed) AND ... ++ &lt;ForceReboot Before=&quot;StopServices&quot; Condition=&quot;(NOT WIX_UPGRADE_DETECTED) AND (NOT BURNMSIUNINSTALL) AND ... &lt;/InstallExecuteSequence&gt; ``` has avoided triggering a reboot when upgrading from 5.3.0 to 5.3.1. However, the reboot will be initiated in future releases when upgrading from 5.3.1. Adding back the condition `(NOT Installed)` fixes the problem for future releases. But it doesn't help if a user has already installed 5.3.1. When upgrading from 5.3.1 to a new version, current bundle features are uninstalled, and the reboot is triggered: ```log MSI (s) (84:38) [19:05:24:587]: Doing action: UnpublishFeatures Action ended 19:05:24: ProcessComponents. Return value 1. Action start 19:05:24: UnpublishFeatures. MSI (s) (84:38) [19:05:24:589]: Doing action: ForceReboot Action ended 19:05:24: UnpublishFeatures. Return value 1. Action start 19:05:24: ForceReboot. ... ``` ![Image](https://github.com/user-attachments/assets/eacf9666-16f0-4de3-82e8-39484d7176f3) **Note that when the installer is run in non-interactive mode using `.\podman-5.4.0-dev-setup.exe /install /quiet` the reboot happens automatically, without any user prompt. And that's how podman desktop, winget, scoop etc...install Podman** ### There are a few things that need to be investigated: - [ ] Can the next release installer avoid the 5.3.1 installer forcing a reboot? [Related discussion in WiX forum](https://github.com/orgs/wixtoolset/discussions/8854) and [PR to fix it](https://github.com/containers/podman/pull/24778). - [ ] How can `WSL_INSTALL=1` be true in the ForceReboot condition if `WITH_WSL` is set to zero? Is that because `ForceReboot` condition is evaluated before `&lt;SetProperty Id=&quot;WSL_INSTALL&quot;...`? - [ ] Why isn't the reboot triggered when Hyper-V isn't installed? Does the `CheckHyperV` always set `HAS_HYPERVFEATURE` to `true`, even if `vmms` is not installed? - [ ] Add automated tests to verify upgrades from `main` branch version to a future version (that we would have helped identify the problem earlier) - [ ] This problem was first spotted on [PR checks after 5.3.1 release](https://cirrus-ci.com/task/4686343773618176). But isn't WSL pre-installed on the VM where these tests run? ### Steps to reproduce the issue Steps to reproduce the issue 1. Uninstall WSL if it's locally installed 2. Install Podman version 5.3.1 3. Build the installer from main branch (run `.\winmake.ps1 podman; .\winmake.ps1 win-gvproxy; .\winmake.ps1 docs; .\winmake.ps1 installer`) 3. Update Podman (run `.\contrib\win-installer\podman-5.4.0-dev-setup.exe /install /log podman-installer.log`)</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>11</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #24774 from containers/renovate/golang.org-x-tools-0.x fix(deps): update module golang.org/x/tools to v0.28.0</MESSAGE>
    <SHA>8ff491b0d9109a293847bb6a612fa195094fd6ca</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Avoid rebooting on windows when upgrading from 5.3.1 A reboot of the machine is triggered when upgrading from 5.3.1 to a newer version on Windows, if WSL is not installed. The v5.3.1 installer is invoked to uninstall the existing package as part of the upgrade to the new version. At that point the v5.3.1 installer triggers a reboot. It doesn't seem to be a simple way to avoid it. The trick is to make the uninstallation of the 5.3.1 fail and explicitly specify to ignore such errors so that the reboot is not triggered and the upgrade continues. References: - https://github.com/orgs/wixtoolset/discussions/8854 - https://github.com/containers/podman/issues/24735 Signed-off-by: Mario Loriedo &lt;mario.loriedo@gmail.com&gt;</MESSAGE>
      <SHA>bddfb4ddb67318d80678a438e6d2aaca996ba146</SHA>
      <PATCHEDFILES>
        <FILE>contrib/win-installer/podman.wxs</FILE>
        <FILE>contrib/win-installer/test-installer.ps1</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Break v5.3.1 Windows installer upgrade to avoid reboot Change the name of the main package feature so that the uninstallation of the v5.3.1 during an upgrade fail and a reboot is not triggered. This commit explicitly specifies to ignore the uninstallation errors during upgrade so that it completes successfully. References: - https://github.com/orgs/wixtoolset/discussions/8854 - https://github.com/containers/podman/issues/24735 Signed-off-by: Mario Loriedo &lt;mario.loriedo@gmail.com&gt;</MESSAGE>
      <SHA>c2c18611e1083b7edc1d3b24ddb13184a0ba6ab3</SHA>
      <PATCHEDFILES>
        <FILE>contrib/win-installer/podman.wxs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Avoid upgrading from v5.3.1 on Windows Added a condition in the Windows WiX bundle that prevents upgrades from v5.3.1 and recommend the user to upgrade to v5.3.2 first. That's needed because version 5.3.1 of the installer had a bug that got patched in v5.3.2 only. c.f. https://github.com/containers/podman/issues/24735 Signed-off-by: Mario Loriedo &lt;mario.loriedo@gmail.com&gt;</MESSAGE>
      <SHA>3aa09dd52171440febb330a08b66b24c3fdc2b5a</SHA>
      <PATCHEDFILES>
        <FILE>contrib/cirrus/win-installer-main.ps1</FILE>
        <FILE>contrib/win-installer/burn.wxs</FILE>
        <FILE>contrib/win-installer/podman.wxs</FILE>
        <FILE>contrib/win-installer/test-installer.ps1</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Remove the option to install WSL/HyperV The Windows installer was able to automatically enable the Windows features for WSL or HyperV when they were not already enabled. This PR removes this capability. Having the installer to automatically install the right prerequiste (WSL or HyperV) was helpful as users won't have to do it manually to use Podman after the installation. But it also made the code of installer more complicated as it needed to manage the installation of these OS features and a reboot. And we weren't able to automatically test these scenarios that required a reboot. In other words the Windows installer, that merely just extracted some files in a folder, required, to support the installation of WSL and HyperV, an advanced knowledge of WiX toolkit and of the Windows Installer SDK, plus contributors-time to manually test the scenarios that require a reboot. We decided to remove this capability based on the following reasons: - We had a couple of regressions in the last month that were hard to analyse and fix (#24624 and #24735) - Podman maintainers currently have a scarce knowledge of the Windows Installer and there is no plan to invest in that - Manually installing WSL or HyperV is not hard (e.g. run `wsl --install`) and are features that admins can manage on their fleet of Windows machines - Competitors such as Docker Desktop don't automatically install these components - Podman `machine init` currently verifies if WSL and HyperV are installed and guide the user to install them when they are not Signed-off-by: Mario Loriedo &lt;mario.loriedo@gmail.com&gt;</MESSAGE>
      <SHA>37a509c32c369b041901869fd9d40e4150a2cb50</SHA>
      <PATCHEDFILES>
        <FILE>build_windows.md</FILE>
        <FILE>contrib/win-installer/burn.wxs</FILE>
        <FILE>contrib/win-installer/podman-theme.wxl</FILE>
        <FILE>contrib/win-installer/podman-theme.xml</FILE>
        <FILE>contrib/win-installer/podman.wxs</FILE>
        <FILE>contrib/win-installer/test-installer.ps1</FILE>
        <FILE>contrib/win-installer/welcome-install-dlg.wxs</FILE>
        <FILE>pkg/machine/wsl/machine.go</FILE>
        <FILE>pkg/machine/wsl/stubber.go</FILE>
        <FILE>pkg/machine/wsl/util_windows.go</FILE>
        <FILE>winmake.ps1</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Remove the option to install WSL/HyperV The Windows installer was able to automatically enable the Windows features for WSL or HyperV when they were not already enabled. This PR removes this capability. Having the installer to automatically install the right prerequiste (WSL or HyperV) was helpful as users won't have to do it manually to use Podman after the installation. But it also made the code of installer more complicated as it needed to manage the installation of these OS features and a reboot. And we weren't able to automatically test these scenarios that required a reboot. In other words the Windows installer, that merely just extracted some files in a folder, required, to support the installation of WSL and HyperV, an advanced knowledge of WiX toolkit and of the Windows Installer SDK, plus contributors-time to manually test the scenarios that require a reboot. We decided to remove this capability based on the following reasons: - We had a couple of regressions in the last month that were hard to analyse and fix (#24624 and #24735) - Podman maintainers currently have a scarce knowledge of the Windows Installer and there is no plan to invest in that - Manually installing WSL or HyperV is not hard (e.g. run `wsl --install`) and are features that admins can manage on their fleet of Windows machines - Competitors such as Docker Desktop don't automatically install these components - Podman `machine init` currently verifies if WSL and HyperV are installed and guide the user to install them when they are not Signed-off-by: Mario Loriedo &lt;mario.loriedo@gmail.com&gt;</MESSAGE>
      <SHA>247d34fb3552e24a3504fb4766708be18635d3ef</SHA>
      <PATCHEDFILES>
        <FILE>build_windows.md</FILE>
        <FILE>contrib/win-installer/burn.wxs</FILE>
        <FILE>contrib/win-installer/podman-theme.wxl</FILE>
        <FILE>contrib/win-installer/podman-theme.xml</FILE>
        <FILE>contrib/win-installer/podman.wxs</FILE>
        <FILE>contrib/win-installer/test-installer.ps1</FILE>
        <FILE>contrib/win-installer/welcome-install-dlg.wxs</FILE>
        <FILE>winmake.ps1</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Remove the option to install WSL/HyperV The Windows installer was able to automatically enable the Windows features for WSL or HyperV when they were not already enabled. This PR removes this capability. Having the installer to automatically install the right prerequiste (WSL or HyperV) was helpful as users won't have to do it manually to use Podman after the installation. But it also made the code of installer more complicated as it needed to manage the installation of these OS features and a reboot. And we weren't able to automatically test these scenarios that required a reboot. In other words the Windows installer, that merely just extracted some files in a folder, required, to support the installation of WSL and HyperV, an advanced knowledge of WiX toolkit and of the Windows Installer SDK, plus contributors-time to manually test the scenarios that require a reboot. We decided to remove this capability based on the following reasons: - We had a couple of regressions in the last month that were hard to analyse and fix (#24624 and #24735) - Podman maintainers currently have a scarce knowledge of the Windows Installer and there is no plan to invest in that - Manually installing WSL or HyperV is not hard (e.g. run `wsl --install`) and are features that admins can manage on their fleet of Windows machines - Competitors such as Docker Desktop don't automatically install these components - Podman `machine init` currently verifies if WSL and HyperV are installed and guide the user to install them when they are not Signed-off-by: Mario Loriedo &lt;mario.loriedo@gmail.com&gt;</MESSAGE>
      <SHA>91e4f6918a294ed40a1031bb431c8a8908c749fe</SHA>
      <PATCHEDFILES>
        <FILE>build_windows.md</FILE>
        <FILE>contrib/win-installer/burn.wxs</FILE>
        <FILE>contrib/win-installer/podman-theme.wxl</FILE>
        <FILE>contrib/win-installer/podman-theme.xml</FILE>
        <FILE>contrib/win-installer/podman.wxs</FILE>
        <FILE>contrib/win-installer/test-installer.ps1</FILE>
        <FILE>contrib/win-installer/welcome-install-dlg.wxs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
