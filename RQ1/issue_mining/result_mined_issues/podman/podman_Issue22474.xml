<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>22474</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/22474</ISSUEURL>
  <TITLE>e2e test do not pass locally</TITLE>
  <DESCRIPTION>``` Summarizing 5 Failures: [FAIL] Podman run [It] podman run limits test /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_test.go:723 [FAIL] Podman run with --cgroup-parent [It] no --cgroup-parent /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_cgroup_parent_test.go:45 [FAIL] Podman run with volumes [It] podman run with volumes and suid/dev/exec options /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_volume_test.go:186 [FAIL] Podman systemd [It] podman run container with systemd PID1 /home/pholzing/go/src/github.com/containers/podman/test/e2e/systemd_test.go:115 [FAIL] Podman manifest [It] authenticated push /home/pholzing/go/src/github.com/containers/podman/test/e2e/manifest_test.go:584 ``` ``` [It] podman run limits test /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_test.go:695 Timeline &gt;&gt; &gt; Enter [BeforeEach] TOP-LEVEL - /home/pholzing/go/src/github.com/containers/podman/test/e2e/common_test.go:110 @ 04/23/24 17:59:20.69 &lt; Exit [BeforeEach] TOP-LEVEL - /home/pholzing/go/src/github.com/containers/podman/test/e2e/common_test.go:110 @ 04/23/24 17:59:20.69 (0s) &gt; Enter [It] podman run limits test - /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_test.go:695 @ 04/23/24 17:59:20.69 Running: /home/pholzing/go/src/github.com/containers/podman/bin/podman --storage-opt overlay.imagestore=/tmp/ginkgo1746342866/imagecachedir --root /tmp/podman_test2653466350/root --runroot /tmp/podman_test2653466350/runroot --runtime crun --conmon /usr/bin/conmon --network-config-dir /tmp/podman_test2653466350/root/etc/networks --network-backend netavark --cgroup-manager cgroupfs --tmpdir /tmp/podman_test2653466350 --events-backend file --db-backend sqlite --storage-driver overlay run --rm --ulimit nofile=2048:2048 quay.io/libpod/systemd-image:20240124 ulimit -n 2048 Running: /home/pholzing/go/src/github.com/containers/podman/bin/podman --storage-opt overlay.imagestore=/tmp/ginkgo1746342866/imagecachedir --root /tmp/podman_test2653466350/root --runroot /tmp/podman_test2653466350/runroot --runtime crun --conmon /usr/bin/conmon --network-config-dir /tmp/podman_test2653466350/root/etc/networks --network-backend netavark --cgroup-manager cgroupfs --tmpdir /tmp/podman_test2653466350 --events-backend file --db-backend sqlite --storage-driver overlay run --rm --ulimit nofile=1024:1028 quay.io/libpod/systemd-image:20240124 ulimit -n 1024 Running: /home/pholzing/go/src/github.com/containers/podman/bin/podman --storage-opt overlay.imagestore=/tmp/ginkgo1746342866/imagecachedir --root /tmp/podman_test2653466350/root --runroot /tmp/podman_test2653466350/runroot --runtime crun --conmon /usr/bin/conmon --network-config-dir /tmp/podman_test2653466350/root/etc/networks --network-backend netavark --cgroup-manager cgroupfs --tmpdir /tmp/podman_test2653466350 --events-backend file --db-backend sqlite --storage-driver overlay run --rm --oom-score-adj=111 quay.io/libpod/systemd-image:20240124 cat /proc/self/oom_score_adj time=&quot;2024-04-23T17:59:21+02:00&quot; level=warning msg=&quot;Requested oom_score_adj=111 is lower than the current one, changing to 200&quot; 200 [FAILED] Failure recorded during attempt 1: Unexpected warnings seen on stderr: &quot;time=\&quot;2024-04-23T17:59:21+02:00\&quot; level=warning msg=\&quot;Requested oom_score_adj=111 is lower than the current one, changing to 200\&quot;&quot; In [It] at: /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_test.go:723 @ 04/23/24 17:59:21.341 ``` ``` /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_cgroup_parent_test.go:16 [It] no --cgroup-parent /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_cgroup_parent_test.go:33 Timeline &gt;&gt; &gt; Enter [BeforeEach] TOP-LEVEL - /home/pholzing/go/src/github.com/containers/podman/test/e2e/common_test.go:110 @ 04/23/24 18:00:05.407 &lt; Exit [BeforeEach] TOP-LEVEL - /home/pholzing/go/src/github.com/containers/podman/test/e2e/common_test.go:110 @ 04/23/24 18:00:05.41 (3ms) &gt; Enter [BeforeEach] Podman run with --cgroup-parent - /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_cgroup_parent_test.go:18 @ 04/23/24 18:00:05.411 &lt; Exit [BeforeEach] Podman run with --cgroup-parent - /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_cgroup_parent_test.go:18 @ 04/23/24 18:00:05.411 (0s) &gt; Enter [It] no --cgroup-parent - /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_cgroup_parent_test.go:33 @ 04/23/24 18:00:05.414 Running: /home/pholzing/go/src/github.com/containers/podman/bin/podman --storage-opt overlay.imagestore=/tmp/ginkgo1746342866/imagecachedir --root /tmp/podman_test1719858776/root --runroot /tmp/podman_test1719858776/runroot --runtime crun --conmon /usr/bin/conmon --network-config-dir /tmp/podman_test1719858776/root/etc/networks --network-backend netavark --cgroup-manager cgroupfs --tmpdir /tmp/podman_test1719858776 --events-backend file --db-backend sqlite --storage-driver overlay run --cgroupns=host quay.io/libpod/systemd-image:20240124 cat /proc/self/cgroup 0::/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/26bf5a6f6e92d8e1c90289abfae99e4f024ddf70fdb11446705b8d299fa08da4 [FAILED] Failure recorded during attempt 1: Expected &lt;string&gt;: 0::/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/26bf5a6f6e92d8e1c90289abfae99e4f024ddf70fdb11446705b8d299fa08da4 to contain substring &lt;string&gt;: /libpod_parent In [It] at: /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_cgroup_parent_test.go:45 @ 04/23/24 18:00:05.643 ``` ``` Timeline &gt;&gt; &gt; Enter [BeforeEach] TOP-LEVEL - /home/pholzing/go/src/github.com/containers/podman/test/e2e/common_test.go:110 @ 04/23/24 18:00:07.105 &lt; Exit [BeforeEach] TOP-LEVEL - /home/pholzing/go/src/github.com/containers/podman/test/e2e/common_test.go:110 @ 04/23/24 18:00:07.105 (0s) &gt; Enter [It] podman run with volumes and suid/dev/exec options - /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_volume_test.go:175 @ 04/23/24 18:00:07.105 Running: /home/pholzing/go/src/github.com/containers/podman/bin/podman --storage-opt overlay.imagestore=/tmp/ginkgo1746342866/imagecachedir --root /tmp/podman_test683346906/root --runroot /tmp/podman_test683346906/runroot --runtime crun --conmon /usr/bin/conmon --network-config-dir /tmp/podman_test683346906/root/etc/networks --network-backend netavark --cgroup-manager cgroupfs --tmpdir /tmp/podman_test683346906 --events-backend file --db-backend sqlite --storage-driver overlay run --rm -v /tmp/podman_test683346906/secrets:/unique/path:suid,dev,exec quay.io/libpod/alpine:latest grep /unique/path /proc/self/mountinfo 1356 628 0:39 /podman_test683346906/secrets /unique/path rw,nosuid,nodev - tmpfs tmpfs rw,seclabel,nr_inodes=1048576,inode64 [FAILED] Failure recorded during attempt 1: Expected &lt;string&gt;: 1356 628 0:39 /podman_test683346906/secrets /unique/path rw,nosuid,nodev - tmpfs tmpfs rw,seclabel,nr_inodes=1048576,inode64 not to contain substring &lt;string&gt;: nodev In [It] at: /home/pholzing/go/src/github.com/containers/podman/test/e2e/run_volume_test.go:186 @ 04/23/24 18:00:07.302 ``` ``` Enter [It] podman run container with systemd PID1 - /home/pholzing/go/src/github.com/containers/podman/test/e2e/systemd_test.go:78 @ 04/23/24 18:01:29.06 ... Running: /home/pholzing/go/src/github.com/containers/podman/bin/podman --storage-opt overlay.imagestore=/tmp/ginkgo1746342866/imagecachedir --root /tmp/podman_test892118442/root --runroot /tmp/podman_test892118442/runroot --runtime crun --conmon /usr/bin/conmon --network-config-dir /tmp/podman_test892118442/root/etc/networks --network-backend netavark --cgroup-manager cgroupfs --tmpdir /tmp/podman_test892118442 --events-backend file --db-backend sqlite --storage-driver overlay inspect --format='{{.State.CgroupPath}}' testSystemd '/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/df50e218c85b273ab31c0ead87a7ef09b8be8bf02989d26b8df2046feeaa2c8e/init.scope' [FAILED] Expected &lt;string&gt;: '/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/df50e218c85b273ab31c0ead87a7ef09b8be8bf02989d26b8df2046feeaa2c8e/init.scope' not to contain substring &lt;string&gt;: init.scope In [It] at: /home/pholzing/go/src/github.com/containers/podman/test/e2e/systemd_test.go:115 @ 04/23/24 18:01:35.663 ``` ``` [It] authenticated push /home/pholzing/go/src/github.com/containers/podman/test/e2e/manifest_test.go:571 Timeline &gt;&gt; &gt; Enter [BeforeEach] TOP-LEVEL - /home/pholzing/go/src/github.com/containers/podman/test/e2e/common_test.go:110 @ 04/23/24 18:00:50.353 &lt; Exit [BeforeEach] TOP-LEVEL - /home/pholzing/go/src/github.com/containers/podman/test/e2e/common_test.go:110 @ 04/23/24 18:00:50.353 (0s) &gt; Enter [It] authenticated push - /home/pholzing/go/src/github.com/containers/podman/test/e2e/manifest_test.go:571 @ 04/23/24 18:00:50.354 [FAILED] Failure recorded during attempt 1: Unexpected error: &lt;*fmt.wrapError | 0xc00149fac0&gt;: running &quot;podman-registry&quot;: : `podman-registry -i docker-archive:/var/tmp/podman/ginkgo/quay.io-libpod-registry-2.8.2.tar start` failed: (exec: &quot;podman-registry&quot;: executable file not found in $PATH) { msg: &quot;running \&quot;podman-registry\&quot;: : `podman-registry -i docker-archive:/var/tmp/podman/ginkgo/quay.io-libpod-registry-2.8.2.tar start` failed: (exec: \&quot;podman-registry\&quot;: executable file not found in $PATH)&quot;, err: &lt;*errors.errorString | 0xc0003f92e0&gt;{ s: &quot;`podman-registry -i docker-archive:/var/tmp/podman/ginkgo/quay.io-libpod-registry-2.8.2.tar start` failed: (exec: \&quot;podman-registry\&quot;: executable file not found in $PATH)&quot;, }, } occurred In [It] at: /home/pholzing/go/src/github.com/containers/podman/test/e2e/manifest_test.go:584 @ 04/23/24 18:00:50.354 ``` I don't understand enough about cgroup setup but I guess the cgroup tests somehow assume some special setup which is not the case locally. The other tests I can likely fix.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>e2e and bindings tests: fix $PATH setup Both tests need the podman-registry script in $PATH, this never worked locally as only the cirrus specific CI setup scripts configured this. To make it work correctly locally add the hack dir to $PATH for these Makefile targets. Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
    <SHA>d1bfdc790077698d16684bfed0b0bd5ec1aaf946</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>test/e2e: force systemd cgroup manager It is not clear why rootless was forced to the cgroupfs manager when systemd is the default. In any case it causes local test failures as described in the issue[1]. Using systemd manager makes them pass as expected, I don't know enough aout cgroups to know the difference and why certain tests have bad asumptions but this fixes it. [1] https://github.com/containers/podman/issues/22474 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>9a0ed6929a33d8a6490cd2962d00b6bc4ceb4cbc</SHA>
      <PATCHEDFILES>
        <FILE>test/e2e/common_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
