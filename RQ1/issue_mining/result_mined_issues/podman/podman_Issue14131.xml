<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14131</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14131</ISSUEURL>
  <TITLE>CI corner-case: Rootless testing on non-main branches</TITLE>
  <DESCRIPTION>/kind bug **Description** [This resulted in the following output](https://cirrus-ci.com/task/4752844124323840?logs=main#L13) from the 'Rootless unit on fedora-36': **Steps to reproduce the issue:** 1. Branching from `main` to `v4.1` the `$DEST_BRANCH` variable is properly updated in `.cirrus.yml` along with a change to `GIT_BASE_BRANCH ?= origin/v4.1` in the `Makefile`. This is all good and expected. 2. Run the 'Rootless unit on fedora-36' test in CI 3. When running as the rootless user, most/all Cirrus-CI env. vars. are lost by the ssh-exec. Critically, it seems `$DEST_BRANCH` defaults to main (by way of `lib.sh`). **Describe the results you received:** ``` /usr/bin/time --verbose --output=&quot;$STATS_LOGFILE&quot; $GOSRC/$SCRIPT_BASE/runner.sh ************************************************************ Runner executing unit podman-tests as rootless on fedora-35(fedora-35) Current environment VM image: fedora-c4831699639992320 ************************************************************ Re-executing runner through ssh as user 'some3201dude' ************************************************************ + exec ssh some3201dude@localhost -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o CheckHostIP=no /var/tmp/go/src/github.com/containers/podman/./contrib/cirrus/runner.sh Warning: Permanently added 'localhost' (ED25519) to the list of known hosts. ************************************************************ Runner executing unit podman-tests as rootless on fedora-35(fedora-35) Current environment VM image: fedora-c4831699639992320 ************************************************************ fatal: Not a valid object name main Exit status: 128 ``` **Describe the results you expected:** ``` /usr/bin/time --verbose --output=&quot;$STATS_LOGFILE&quot; $GOSRC/$SCRIPT_BASE/runner.sh ************************************************************ Runner executing unit podman-tests as rootless on fedora-36(fedora-36) Current environment VM image: fedora-c4955393725038592 ************************************************************ Recursively chowning $GOPATH and $GOSRC to some25741dude Re-executing runner through ssh as user 'some25741dude' ************************************************************ + exec ssh some25741dude@localhost -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o CheckHostIP=no /var/tmp/go/src/github.com/containers/podman/./contrib/cirrus/runner.sh Warning: Permanently added 'localhost' (ED25519) to the list of known hosts. ************************************************************ Runner executing unit podman-tests as rootless on fedora-36(fedora-36) Current environment VM image: fedora-c4955393725038592 ************************************************************ CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -mod=vendor -ldflags '-X ...cut... ``` **Additional information you deem important (e.g. issue happens only occasionally):** The error is coming from [_bail_if_test_can_be_skipped()](https://github.com/containers/podman/blob/3e5e0d2626145c7dad7a1de29982a2f513262a1b/contrib/cirrus/runner.sh#L390-L392). **Output of `podman version`:** ``` N/A ``` **Output of `podman info --debug`:** ``` N/A ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` N/A ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** When preparing a new branch for CI, it's unreasonable to expect developers to remember to update much more than `.cirrus.yml` and maybe the `Makefile`. We should either ensure the necessary env. vars. are passed to the rootless user or bypass the `_bail` optimization all together. Pass-through env. vars. can be set in the rootless user's environment by ensuring they get written during `setup_environment.sh`, [so they are loaded properly later](https://github.com/containers/podman/blob/3e5e0d2626145c7dad7a1de29982a2f513262a1b/contrib/cirrus/lib.sh#L37).</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14163 from Luap99/fix-14162 fix broken CI test</MESSAGE>
    <SHA>68e45555b3dfc9662ce71b6ff548b43c9ea8d50c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>test skipper: check for $DEST_BRANCH The test-skipping optimization is failing as rootless on non-main, because $DEST_BRANCH is not set. Solution: check for envariable, skip test if missing. (This was part of my original PR, but was accidentally removed in #14013) Also: DEST_BRANCH was silently being defaulted to 'main' in lib.sh. Remove that: per @cevich, it is no longer necessary. Fixes: #14131 Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>c4865767171b847a85c441ded623588d26d1588b</SHA>
      <PATCHEDFILES>
        <FILE>contrib/cirrus/lib.sh</FILE>
        <FILE>contrib/cirrus/runner.sh</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
