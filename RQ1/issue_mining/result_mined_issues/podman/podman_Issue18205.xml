<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>18205</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/18205</ISSUEURL>
  <TITLE>network resources are leaked when error happens during setup</TITLE>
  <DESCRIPTION>### Issue Description The network resources are leaked when there is a error during the initial container setup process. This effects both netavark and cni. ### Steps to reproduce the issue Make sure to not have containers running and try this as rootless 1. `podman network create test1` 2. `podman run -p 80:80 --network podman1 alpine ip a` Which correctly fails with: ``` Error: rootlessport cannot expose privileged port 80, you can add 'net.ipv4.ip_unprivileged_port_start=80' to /etc/sysctl.conf (currently 1024), or choose a larger port number (&gt;= 1024): listen tcp 0.0.0.0:80: bind: permission denied ``` 3. `ps aux` ### Describe the results you received See that aardvark-dns is still running, or dnsmasq when using CNI. ### Describe the results you expected Podman should teardown the network correctly on errors. ### podman info output ```yaml latest main branch ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release Yes ### Additional environment details _No response_ ### Additional information This seems to be the root cause why we leak so many aardvark-dns or dnsmasq processes in e2e tests in CI.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>libpod: rootlessNetNs.Cleanup() fix error message The wrong error was logged. Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
    <SHA>4f93a6eee49686b2836f15968fbb3a80c158e6fe</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>libpod: configureNetNS() tear down on errors Make sure to tear down the netns again on errors. This is needed when a later call fails and we do not have already stored the netns in the container state. [NO NEW TESTS NEEDED] My ginkgo-v2 PR will catch problem like this once merged. Fixes #18205 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>7e4cd22acb97026d35d0329a2f145de29246ea08</SHA>
      <PATCHEDFILES>
        <FILE>libpod/networking_linux.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>libpod: configureNetNS() tear down on errors Make sure to tear down the netns again on errors. This is needed when a later call fails and we do not have already stored the netns in the container state. [NO NEW TESTS NEEDED] My ginkgo-v2 PR will catch problem like this once merged. Fixes #18205 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>97ec57da5b8f9b08755afdca46be268c3c2eb2bf</SHA>
      <PATCHEDFILES>
        <FILE>libpod/networking_linux.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
