<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>21228</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/21228</ISSUEURL>
  <TITLE>podman run with --pod new: behavior</TITLE>
  <DESCRIPTION>### Issue Description If I create a container with the name 'test' and then create another container with the same name but with `--pod new:testpod`, the command understandably fails due to the conflicting container name but the pod is created nonetheless. The fact that the pod is implicitly created while the command failed with an error doesn't seem ideal in terms of user experience. Further, if the user tries to recreate the container changing the container name and not the pod name, they run into a similar issue but this time around, it has to deal with the pod with the same name already present. the ### Steps to reproduce the issue ``` $ podman run -d --name alptest alpine echo hello 1a2ad3c7f119d72c7d77a5b77ed174a4c6dc6b8d4a2b23dd85eba719bce920eb $ podman run -d --name alptest --pod new:testpod alpine sleep 100 Error: creating container storage: the container name &quot;alptest&quot; is already in use by 1a2ad3c7f119d72c7d77a5b77ed174a4c6dc6b8d4a2b23dd85eba719bce920eb. You have to remove that container to be able to reuse that name: that name is already in use, or use --replace to instruct Podman to do so. $ podman run -d --name newalptest --pod new:testpod alpine sleep 100 Error: adding pod to state: name &quot;testpod&quot; is in use: pod already exists $ podman ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 1a2ad3c7f119 docker.io/library/alpine:latest echo hello 11 seconds ago Exited (0) 11 seconds ago alptest 567641ddc3af localhost/podman-pause:4.8.3-1704326400 7 seconds ago Created 9e73bf7323a5-infra ``` ### Describe the results you received podman run command with --new:&lt;podname&gt; failed if a container with the same name already exists but the pod (and in effect, the infra container) is created and set up. So if you change the container name and try the same command, you'll run into pod already exists error. ### Describe the results you expected Perhaps not creating the pod if the container creation fails? Or alternatively emit the pod ID so there's some indication that the pod is created even though the container creation failed. ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.33.2 cgroupControllers: - cpu - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.5-2.1.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.5, commit: unknown' cpuUtilization: idlePercent: 96.61 systemPercent: 0.62 userPercent: 2.78 cpus: 16 databaseBackend: sqlite distribution: distribution: opensuse-tumbleweed version: &quot;20221226&quot; eventLogger: journald freeLocks: 2045 hostname: localhost.localdomain idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 kernel: 6.1.4-1-default linkmode: dynamic logDriver: journald memFree: 12125605888 memTotal: 50225111040 networkBackend: cni networkBackendInfo: backend: cni dns: {} package: |- cni-plugins-1.3.0-11.1.x86_64 cni-1.1.2-16.5.x86_64 path: /usr/libexec/cni ociRuntime: name: crun package: crun-1.7.2-1.1.x86_64 path: /usr/bin/crun version: |- crun version 1.7.2 commit: 0356bf4aff9a133d655dc13b1d9ac9424706cac4 rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +YAJL os: linux pasta: executable: &quot;&quot; package: &quot;&quot; version: &quot;&quot; remoteSocket: exists: false path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /etc/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /bin/slirp4netns package: slirp4netns-1.2.0-1.1.x86_64 version: |- slirp4netns version 1.2.0 commit: unknown libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 5 libseccomp: 2.5.4 swapFree: 2147811328 swapTotal: 2147811328 uptime: 166h 30m 14.00s (Approximately 6.92 days) variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.opensuse.org - registry.suse.com - docker.io store: configFile: /home/danishprakash/.config/containers/storage.conf containerStore: number: 2 paused: 0 running: 0 stopped: 2 graphDriverName: overlay graphOptions: {} graphRoot: /home/danishprakash/.local/share/containers/storage graphRootAllocated: 1021788028928 graphRootUsed: 205789212672 graphStatus: Backing Filesystem: btrfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;false&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 41 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/danishprakash/.local/share/containers/storage/volumes version: APIVersion: 4.8.3 Built: 1704326400 BuiltTime: Thu Jan 4 05:30:00 2024 GitCommit: &quot;&quot; GoVersion: go1.21.5 Os: linux OsArch: linux/amd64 Version: 4.8.3 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes ### Additional environment details Additional environment details ### Additional information Additional information like issue happens only occasionally or issue happens with a particular architecture or on a particular setting</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #21234 from edsantiago/sdnotify_race systests: kube with policies test: fix race</MESSAGE>
    <SHA>9fed92ba89e7c6b247b84ac8d6e987f53eac5ca5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>rm pod with podman run if ctr creation failed Currently, if the container creation failed with either run or create and you've used --pod with new: the pod would be created nonetheless. This change ensures the pod just created is also cleaned up in case of container creation failure Fixes #21228 Signed-off-by: danishprakash &lt;danish.prakash@suse.com&gt;</MESSAGE>
      <SHA>1c88b12204547e42396913d83d4c8c24364502db</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/containers/create.go</FILE>
        <FILE>cmd/podman/containers/run.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
