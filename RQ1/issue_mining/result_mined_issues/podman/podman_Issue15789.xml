<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15789</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15789</ISSUEURL>
  <TITLE>Failure to set workdir with overlayfs volumes</TITLE>
  <DESCRIPTION>**Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** &lt;!-- Briefly describe the problem you are having in a few paragraphs. --&gt; Podman seems to have a problem setting the workdir (via the `-w` flag) in the container when using an overlay volume on kernels that support rootless overlays through overlayfs. I Tried forcing the use of fuse-overlayfs and it didn't result in such issue. **Steps to reproduce the issue:** 1. Run the command `podman run -it --rm --volume /var:/var_ovl/:O -w /var_ovl/log docker.io/library/bash bash` on a 5.11+ kernel using the overlayfs driver. **Describe the results you received:** ``` Error: workdir &quot;/var_ovl/log&quot; does not exist on container ``` **Describe the results you expected:** Being able to set the work dir to mountpoints inside the overlay volume. **Output of `podman version`:** ``` \Client: Podman Engine Version: 4.2.1 API Version: 4.2.1 Go Version: go1.19 Git Commit: 62b324ddf718411b1d4d0ba8117c632f7f984a38-dirty Built: Thu Sep 8 08:52:54 2022 OS/Arch: linux/amd64 ``` **Output of `podman info`:** ``` host: arch: amd64 buildahVersion: 1.27.0 cgroupControllers: - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: /usr/bin/conmon is owned by conmon 1:2.1.4-1 path: /usr/bin/conmon version: 'conmon version 2.1.4, commit: bd1459a3ffbb13eb552cc9af213e1f56f31ba2ee' cpuUtilization: idlePercent: 98.73 systemPercent: 0.49 userPercent: 0.78 cpus: 16 distribution: distribution: arch version: unknown eventLogger: journald hostname: legion idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 65536 kernel: 5.19.2-arch1-1 linkmode: dynamic logDriver: journald memFree: 1696440320 memTotal: 16621641728 networkBackend: netavark ociRuntime: name: crun package: /usr/bin/crun is owned by crun 1.6-1 path: /usr/bin/crun version: |- crun version 1.6 commit: 18cf2efbb8feb2b2f20e316520e0fd0b6c41ef4d spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: path: /run/user/1000/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /etc/containers/seccomp.json selinuxEnabled: false serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: /usr/bin/slirp4netns is owned by slirp4netns 1.2.0-1 version: |- slirp4netns version 1.2.0 commit: 656041d45cfca7a4176f6b7eed9e4fe6c11e8383 libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.4 swapFree: 16565399552 swapTotal: 17179865088 uptime: 33h 38m 25.00s (Approximately 1.38 days) plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: {} store: configFile: /home/muhzi/.config/containers/storage.conf containerStore: number: 0 paused: 0 running: 0 stopped: 0 graphDriverName: overlay graphOptions: overlay.mount_program: Executable: /usr/bin/fuse-overlayfs Package: /usr/bin/fuse-overlayfs is owned by fuse-overlayfs 1.9-1 Version: |- fusermount3 version: 3.11.0 fuse-overlayfs: version 1.9 FUSE library version 3.11.0 using FUSE kernel interface version 7.31 graphRoot: /home/muhzi/.local/share/containers/storage graphRootAllocated: 279417565184 graphRootUsed: 140984487936 graphStatus: Backing Filesystem: extfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 68 runRoot: /run/user/1000/containers volumePath: /home/muhzi/.local/share/containers/storage/volumes version: APIVersion: 4.2.1 Built: 1662619974 BuiltTime: Thu Sep 8 08:52:54 2022 GitCommit: 62b324ddf718411b1d4d0ba8117c632f7f984a38-dirty GoVersion: go1.19 Os: linux OsArch: linux/amd64 Version: 4.2.1 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` Name : podman Version : 4.2.1-1 Description : Tool and library for running OCI-based containers in pods Architecture : x86_64 URL : https://github.com/containers/podman Licenses : Apache Groups : None Provides : None Depends On : catatonit conmon containers-common crun iptables libdevmapper.so=1.02-64 libgpgme.so=11-64 libseccomp.so=2-64 slirp4netns Optional Deps : apparmor: for AppArmor support btrfs-progs: support btrfs backend devices [installed] netavark: for a new container-network-stack implementation [installed] podman-compose: for docker-compose compatibility podman-docker: for Docker-compatible CLI Required By : None Optional For : None Conflicts With : None Replaces : None Installed Size : 67.28 MiB Packager : David Runge &lt;dvzrv@archlinux.org&gt; Build Date : Thu 08 Sep 2022 08:52:54 AM EET Install Date : Tue 13 Sep 2022 06:11:41 PM EET Install Reason : Explicitly installed Install Script : No Validated By : Signature ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>libpod: rename function the function checks if a path is under any mount, not just bind mounts. Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
    <SHA>92dc61d5edb1b5ce85f7e4563d400cc861a28359</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>libpod: fix lookup for subpath in volumes a subdirectory that is below a mount destination is detected as a subpath. Closes: https://github.com/containers/podman/issues/15789 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
      <SHA>14e5d1c15da82f7eb315c320765aeca69f4b58af</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_path_resolution.go</FILE>
        <FILE>libpod/container_path_resolution_test.go</FILE>
        <FILE>test/e2e/run_working_dir_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
