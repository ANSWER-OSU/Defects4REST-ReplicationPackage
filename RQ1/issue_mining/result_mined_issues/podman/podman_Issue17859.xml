<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>17859</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/17859</ISSUEURL>
  <TITLE>sqlite: database is locked</TITLE>
  <DESCRIPTION>Almost certainly related to #17858 but I will let someone else decide and possibly merge. ``` Podman start after signal kill ... podman [options] --db-backend sqlite --storage-driver vfs ps -q Error: switching journal to WAL mode: database is locked ``` Unfortunately, this is also happening a lot in `cleanup`, where for long and horrible complicated reasons my flake logger cannot detect: ``` $ podman [options] rm -fa -t 0 Error: adding container id to database: database is locked ``` https://api.cirrus-ci.com/v1/artifact/task/4709781731016704/html/int-podman-fedora-37-rootless-host-sqlite.log.html#t--netns--1 https://api.cirrus-ci.com/v1/artifact/task/6409078293921792/html/int-podman-fedora-37-rootless-host.log.html#t--Podman-start-after-signal-kill--1</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>36</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #17821 from umohnani8/detach Add service ctr cleanup to PlayKubeDown</MESSAGE>
    <SHA>d8265f07d06180bef01646bd522bf738e1764884</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>sqlite: set connection attributes on open The symptoms in #17859 indicate that setting the PRAGMAs in individual EXECs outside of a transaction can lead to concurrency issues and failures when the DB is locked. Hence set all PRAGMAs when opening the connection. Move them into individual constants to improve documentation and readability. Further make transactions exclusive as #17859 also mentions an error that the DB is locked during a transaction. [NO NEW TESTS NEEDED] - existing tests cover the code. Fixes: #17859 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>58d4b1564b23994b448c653f7e2dbcb58fb98c25</SHA>
      <PATCHEDFILES>
        <FILE>libpod/sqlite_state.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>sqlite: set connection attributes on open The symptoms in #17859 indicate that setting the PRAGMAs in individual EXECs outside of a transaction can lead to concurrency issues and failures when the DB is locked. Hence set all PRAGMAs when opening the connection. Move them into individual constants to improve documentation and readability. Further make transactions exclusive as #17859 also mentions an error that the DB is locked during a transaction. [NO NEW TESTS NEEDED] - existing tests cover the code. Fixes: #17859 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt; &lt;MH: Cherry-picked on top of my branch&gt; Signed-off-by: Matthew Heon &lt;matthew.heon@pm.me&gt;</MESSAGE>
      <SHA>0fbc325156d0c45d84e50be6b04e045363a0aebf</SHA>
      <PATCHEDFILES>
        <FILE>libpod/sqlite_state.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>sqlite: do not `Ping()` after connecting `Ping()` requires the DB lock, so we had to move it into a transaction to fix #17859. Since we try to access the DB directly afterwards, I prefer to let that fail instead of paying the cost of a transaction which would lock the DB for _all_ processes. [NO NEW TESTS NEEDED] as it's a hard to reproduce race. Fixes: #17859 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>cdb5b3e99061c9323bbdc4b2ff063262ca31a221</SHA>
      <PATCHEDFILES>
        <FILE>libpod/sqlite_state.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
