<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14207</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14207</ISSUEURL>
  <TITLE>Podman does not detect volume from the volume plugin, unlike docker</TITLE>
  <DESCRIPTION>/kind bug **Description** If volume is created out of band in the volume plugin, the volume is not detected by podman, unlike docker. This affects deployment of podman in clustered environment where the volume is created on shared storage from one node, is not detected by podman running on the other node. **Steps to reproduce the issue:** 1. Create volume using custom volume driver on shared storage. 2. The podman running on the other node, does not detect the volume, using same custom volume driver. **Describe the results you received:** Podman can detect only volumes created locally using podman create. **Describe the results you expected:** Podman should detect all the volumes seen by the volume plugin driver. **Additional information you deem important (e.g. issue happens only occasionally):** In case of docker, all the volumes seen by the volume plugin driver reflected inside &quot;docker volume ls&quot;. **Output of `podman version`:** ``` # podman version Client: Podman Engine Version: 4.0.2 API Version: 4.0.2 Go Version: go1.17.7 Built: Tue Mar 15 12:15:06 2022 OS/Arch: linux/amd64 ``` **Output of `podman info --debug`:** ``` # podman info --debug host: arch: amd64 buildahVersion: 1.24.1 cgroupControllers: - cpuset - cpu - cpuacct - blkio - memory - devices - freezer - net_cls - perf_event - net_prio - hugetlb - pids - rdma cgroupManager: systemd cgroupVersion: v1 conmon: package: conmon-2.0.29-1.module+el8.4.0+11822+6cc1e7d7.x86_64 path: /usr/bin/conmon version: 'conmon version 2.0.29, commit: ae467a0c8001179d4d0adf4ada381108a893d7ec' cpus: 8 distribution: distribution: '&quot;rhel&quot;' version: &quot;8.4&quot; eventLogger: journald hostname: eagappflx038 idMappings: gidmap: null uidmap: null kernel: 4.18.0-305.40.2.el8_4.x86_64 linkmode: dynamic logDriver: journald memFree: 49152798720 memTotal: 66800738304 networkBackend: cni ociRuntime: name: runc package: runc-1.0.0-74.rc95.module+el8.4.0+11822+6cc1e7d7.x86_64 path: /usr/bin/runc version: |- runc version spec: 1.0.2-dev go: go1.15.13 libseccomp: 2.5.1 os: linux remoteSocket: exists: true path: /run/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_AUDIT_WRITE,CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_MKNOD,CAP_NET_BIND_SERVICE,CAP_NET_RAW,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /etc/opt/veritas/flex/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /bin/slirp4netns package: slirp4netns-1.1.8-1.module+el8.4.0+11822+6cc1e7d7.x86_64 version: |- slirp4netns version 1.1.8 commit: d361001f495417b880f20329121e3aa431a8f90f libslirp: 4.3.1 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.1 swapFree: 68708425728 swapTotal: 68719472640 uptime: 140h 12m 38.68s (Approximately 5.83 days) plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local - filevol - veritas registries: docker.io: Blocked: true Insecure: false Location: docker.io MirrorByDigestOnly: false Mirrors: [] Prefix: docker.io registry.access.redhat.com: Blocked: true Insecure: false Location: registry.access.redhat.com MirrorByDigestOnly: false Mirrors: [] Prefix: registry.access.redhat.com search: - console:8443 - registry.redhat.io - docker.io store: configFile: /etc/containers/storage.conf containerStore: number: 10 paused: 0 running: 8 stopped: 2 graphDriverName: overlay graphOptions: overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 16 runRoot: /run/containers/storage volumePath: /var/lib/containers/storage/volumes version: APIVersion: 4.0.2 Built: 1647371706 BuiltTime: Tue Mar 15 12:15:06 2022 GitCommit: &quot;&quot; GoVersion: go1.17.7 OsArch: linux/amd64 Version: 4.0.2 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** ``` # rpm -q podman podman-4.0.2-1.module_el8.7.0+1106+45480ee0.x86_64 ``` **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** Physical</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>46</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>test/testvol: rework testvol binary Add 4 new subcommands to the testvol binary, instead of just serving the volume api it now also can create/list/remove plugins. This is required to test new functionality where volumes are create outside of podman in the plugin. Podman should then be able to pick up the new volumes. The new testvol commands are: - serve: serve the podman api like the the testvol command before - create: create a volume with the given name - list: list all volume names - remove: remove the volume with the given name Also make a small update to the testvol Containerfile so that it can build correctly. Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
    <SHA>6e8953abfc4693937c73e22ca6eddebf909d4d93</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>add podman volume reload to sync volume plugins Libpod requires that all volumes are stored in the libpod db. Because volume plugins can be created outside of podman, it will not show all available plugins. This podman volume reload command allows users to sync the libpod db with their external volume plugins. All new volumes from the plugin are also created in the libpod db and when a volume from the db no longer exists it will be removed if possible. There are some problems: - naming conflicts, in this case we only use the first volume we found. This is not deterministic. - race conditions, we have no control over the volume plugins. It is possible that the volumes changed while we run this command. Fixes #14207 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>2fab7d169b0714574b6620f454c1408bf8097d4f</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/volumes/reload.go</FILE>
        <FILE>docs/source/markdown/podman-volume-reload.1.md</FILE>
        <FILE>docs/source/markdown/podman-volume.1.md</FILE>
        <FILE>libpod/define/volume_inspect.go</FILE>
        <FILE>libpod/runtime_ctr.go</FILE>
        <FILE>libpod/runtime_pod_linux.go</FILE>
        <FILE>libpod/runtime_volume.go</FILE>
        <FILE>libpod/runtime_volume_linux.go</FILE>
        <FILE>pkg/domain/entities/engine_container.go</FILE>
        <FILE>pkg/domain/entities/volumes.go</FILE>
        <FILE>pkg/domain/infra/abi/volumes.go</FILE>
        <FILE>pkg/domain/infra/tunnel/volumes.go</FILE>
        <FILE>test/e2e/config.go</FILE>
        <FILE>test/e2e/volume_plugin_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>add podman volume reload to sync volume plugins Libpod requires that all volumes are stored in the libpod db. Because volume plugins can be created outside of podman, it will not show all available plugins. This podman volume reload command allows users to sync the libpod db with their external volume plugins. All new volumes from the plugin are also created in the libpod db and when a volume from the db no longer exists it will be removed if possible. There are some problems: - naming conflicts, in this case we only use the first volume we found. This is not deterministic. - race conditions, we have no control over the volume plugins. It is possible that the volumes changed while we run this command. Fixes #14207 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>b89fe870febb3a14846b356007ecb6d836486050</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/volumes/reload.go</FILE>
        <FILE>docs/source/markdown/podman-volume-reload.1.md</FILE>
        <FILE>docs/source/markdown/podman-volume.1.md</FILE>
        <FILE>libpod/define/volume_inspect.go</FILE>
        <FILE>libpod/runtime_ctr.go</FILE>
        <FILE>libpod/runtime_pod_linux.go</FILE>
        <FILE>libpod/runtime_volume.go</FILE>
        <FILE>libpod/runtime_volume_linux.go</FILE>
        <FILE>pkg/domain/entities/engine_container.go</FILE>
        <FILE>pkg/domain/entities/volumes.go</FILE>
        <FILE>pkg/domain/infra/abi/volumes.go</FILE>
        <FILE>pkg/domain/infra/tunnel/volumes.go</FILE>
        <FILE>test/e2e/config.go</FILE>
        <FILE>test/e2e/volume_plugin_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
