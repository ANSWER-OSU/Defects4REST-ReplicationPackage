<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15686</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15686</ISSUEURL>
  <TITLE>Better settings for running podman containers under systemd</TITLE>
  <DESCRIPTION>I'm interested in getting the best possible integration between systemd and podman when running containers from &quot;podman run&quot; in the ExecStart line of a systemd unit. This affects multiple things, for instance the output of `podman systemd generate --new`, the output of quadlet, and the template service unit file for play kube support. My goals are: * Make the unit file easy to read (minimal copy/paste scaffolding) * Make startup efficient (minimal number of execs, etc) * Robust shutdowns in case of races * Allow systemd maximum insight into the container So, here are a list of things I think we could do better: * Use --cgroup=split (currently unset in kube template, and set to no-conmon in systemd generate). For example, if I use systemd generate --new to create foo.service i get this from systemd-cgls: ``` -.slice ├─system.slice (#60) | | ... │ ├─foo.service (#12748) │ │ → trusted.invocation_id: 1be92eda65e44d76a51b800e1327f4a5 │ │ └─ 6720 /usr/bin/conmon --api-version 1 -c 5d476e3704141d03c898fa0d7f81e688… | ... └─machine.slice (#1022) → trusted.invocation_id: 8c0b9e872e674c41b0aa10d70c29f2d5 └─libpod-5d476e3704141d03c898fa0d7f81e688c2c64caa5d66fa2b50433ea884b6fdf3.scope … (#12822) → trusted.delegate: 1 → trusted.invocation_id: 719df90757144078b3c78349b94bc1d6 └─container (#12889) └─ 6723 sleep 100000 ``` Whereas with quadlet (that uses cgroup=split) i get: ``` -.slice ├─system.slice (#60) | | ... │ ├─quadlet-minimal.service … (#21605) │ │ → trusted.delegate: 1 │ │ → trusted.invocation_id: 80fd019d600647a1af14bf89f943e64f │ │ ├─libpod-payload-a2fb81d0d42259207831fa764c38e4e4d7f3ef345e52cf423a55596cac1b356b (#21739) │ │ │ ├─ 13365 /run/podman-init -- sleep 60 │ │ │ └─ 13387 sleep 60 │ │ └─runtime (#21672) │ │ └─ 13360 /usr/bin/conmon --api-version 1 -c a2fb81d0d42259207831fa764c38e… | ... ``` In this setup the cgroups are *inside* the systemd created cgrops which means that systemd is aware of all the processes running in the container and can properly manage them. It also means systemd-originating cgroup limits are correctly applied. For this to work properly, the systemd unit should specify Delegate=yes, as per https://systemd.io/CGROUP_DELEGATION/. * Default to --sdnotify=conmon This means that we don't report success to systemd until we actually spawn the container. This is already enabled in systemd generate, but not currently in the kubernetes template. However there needs to be a way to override this to --sdnotify=container in case your container itself supports sdnotify. * Robust shutdown No matter how the container is shut down we need things to be robust and not leave any state around that is picked up by e.g. &quot;podman ps&quot;. Systemd itself is generally not a problem here because it gets told by the kernel (via cgroups, if set up correctly) exactly what the current state is. This is what systemd generate does for this (stripped down): ``` ExecStartPre=/bin/rm -f %t/%n.ctr-id ExecStart=/usr/bin/podman run --cidfile=%t/%n.ctr-id \--rm -d fedora sleeep 999 ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id Type=notify NotifyAccess=all ``` Whereas quadlet does (stripped down): ``` ExecStartPre=-rm -f %t/%N.cid ExecStart=/usr/bin/podman run --cidfile=%t/%N.cid --name=systemd-%N --replace --rm -d fedora sleep 999 ExecStopPost=-/usr/bin/podman rm -f -i --cidfile=%t/%N.cid ExecStopPost=-rm -f %t/%N.cid KillMode=mixed Type=notify NotifyAccess=all ``` See the &quot;Robust container shutdown&quot; section in https://github.com/containers/quadlet/blob/main/docs/ContainerSetup.md for more details of why I chose to set it up like this. We can argue about the details, but one thing I'd like is for this to be less open-coded. By this I mean, we should not have to have an ExecStartPre to remove the .cid file, we should just get the right behaviour automatically by the podman run command. Same with the two StopPost commands quadlet has, it should just be combined into one command. * Logging Quadlet currently uses `--log-driver journald`, since if you are using systemd it is likely that you want to use the journal and not podman logs. However, since https://github.com/containers/podman/pull/11390 we have access to `--log-driver passthrough`, which is an even better fit, and should always be used. * Default to using --init, or at least make it easy to enable Most services actually don't properly function as pid1, and there is a large risk for things not properly reaping grandparents that die, so we collect a bunch of zombies. catatonit is really really small, having an instance of it in the container is not going to be a problem. * Various other things Set SyslogIndentifier, because the default is otherwise the main exec name, which is always &quot;podman&quot; and this is not great. Quadlet defaults to --pull=never, because it is maybe not great to start doing network pulls each time we boot. Not sure about this, it goes with the auto-update stuff. Quadlets always sets up /tmp to a per-process tmpfs to mirror what typically happens with system services. Not sure if this is generally the right thing to do either.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>726</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #15811 from giuseppe/fix-memory-stats-api stats: cap memory limit to the available memory</MESSAGE>
    <SHA>2a8df49c2a65831fa2c253afa1ad2b5e1d618b09</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>generate systemd: drop ExecStop Drop the ExecStop step to simplify the generated units a bit. The extra ExecStopPost step was added by commit e5c343294424. If the main PID (i.e., conmon) is killed, systemd will not execute ExecStop (since the main PID is already down) but only execute the *Post steps. Credits to the late Ulrich Obergfell for tracking this issue down; he is missed. The ExecStop step can safely be dropped since the Post step will take of stopping (and removing) in any case. Context: #15686 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>c20abf12c714f359c7bbb291c444530f70cb1185</SHA>
      <PATCHEDFILES>
        <FILE>pkg/systemd/generate/containers.go</FILE>
        <FILE>pkg/systemd/generate/containers_test.go</FILE>
        <FILE>pkg/systemd/generate/pods.go</FILE>
        <FILE>pkg/systemd/generate/pods_test.go</FILE>
        <FILE>test/e2e/generate_systemd_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
