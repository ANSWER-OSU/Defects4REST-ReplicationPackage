<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14456</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/14456</ISSUEURL>
  <TITLE>Timestamps in 'image list' inconsistent with 'image history'</TITLE>
  <DESCRIPTION>Reported by multiarch team in their [gitlab tracker](https://gitlab.com/cki-project/kernel-tests/-/issues/1160) On multiarch, one of the `podman image history` tests is failing: ``` [+0011s] # #/vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv [+0011s] # #| FAIL: CreatedSince and CreatedAt from image history should == image list [+0011s] # #| expected: '11 months ago--2021-06-10 18:55:50 +0000 UTC' [+0011s] # #| actual: '11 months ago--2021-06-10 18:55:51 +0000 UTC' [+0011s] # #\^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ``` Reason: that test runs `podman image list $IMAGE` and `podman image history $IMAGE`, and assumes that the first line of `history` should match the timestamp of `list`. It does not. Neither does it match the last line. Reproducer (well, not really, but a one-liner that demonstrates the problem): ```console $ iii=quay.io/libpod/testimage:20210610 $ for arch in amd64 arm64 ppc64le s390x;do echo;echo $arch;bin/podman rmi $iii &gt;/dev/null;bin/podman pull -q --arch=$arch $iii;bin/podman image list --format=&quot;list&gt; {{.CreatedAt}}&quot; $iii;bin/podman image history --format=&quot; {{.CreatedAt}} {{.CreatedBy}}&quot; $iii;done amd64 9f9ec7f2fdef9168f74e9d057f307955db14d782cff22ded51d277d74798cb2f list&gt; 2021-06-10 18:55:43 +0000 UTC 2021-06-10 18:55:43 +0000 UTC /bin/sh -c #(nop) CMD [&quot;/bin/echo&quot;, &quot;This ... 2021-06-10 18:55:43 +0000 UTC /bin/sh -c #(nop) WORKDIR /home/podman 2021-06-10 18:55:43 +0000 UTC /bin/sh -c #(nop) LABEL created_at=2021-06... 2021-06-10 18:55:43 +0000 UTC /bin/sh -c #(nop) LABEL created_by=test/sy... 2021-06-10 18:55:43 +0000 UTC /bin/sh -c #(nop) ADD multi:0ed825786ec124... 2021-06-10 18:55:42 +0000 UTC /bin/sh -c apk add busybox-extras arm64 d47f52704fad91e7a4f450ba8e31e95db186a0516005309747c888f19969fdbd list&gt; 2021-06-10 18:55:50 +0000 UTC 2021-06-10 18:55:51 +0000 UTC /bin/sh -c #(nop) CMD [&quot;/bin/echo&quot;, &quot;This ... 2021-06-10 18:55:50 +0000 UTC /bin/sh -c #(nop) WORKDIR /home/podman 2021-06-10 18:55:50 +0000 UTC /bin/sh -c #(nop) LABEL created_at=2021-06... 2021-06-10 18:55:50 +0000 UTC /bin/sh -c #(nop) LABEL created_by=test/sy... 2021-06-10 18:55:50 +0000 UTC /bin/sh -c #(nop) ADD multi:0ed825786ec124... 2021-06-10 18:55:50 +0000 UTC /bin/sh -c apk add busybox-extras ppc64le ffbfb81a72a975998e7148cc224ac095fc30c328a3cd686aefab4859e6d3a22b list&gt; 2021-06-10 18:55:59 +0000 UTC 2021-06-10 18:56:00 +0000 UTC /bin/sh -c #(nop) CMD [&quot;/bin/echo&quot;, &quot;This ... 2021-06-10 18:55:59 +0000 UTC /bin/sh -c #(nop) WORKDIR /home/podman 2021-06-10 18:55:59 +0000 UTC /bin/sh -c #(nop) LABEL created_at=2021-06... 2021-06-10 18:55:59 +0000 UTC /bin/sh -c #(nop) LABEL created_by=test/sy... 2021-06-10 18:55:59 +0000 UTC /bin/sh -c #(nop) ADD multi:0ed825786ec124... 2021-06-10 18:55:59 +0000 UTC /bin/sh -c apk add busybox-extras s390x 8ae9b542c6291490b44995965dc03fabe5f4a6305bb49ab4066645e2c25e0eb5 list&gt; 2021-06-10 18:56:07 +0000 UTC 2021-06-10 18:56:08 +0000 UTC /bin/sh -c #(nop) CMD [&quot;/bin/echo&quot;, &quot;This ... 2021-06-10 18:56:07 +0000 UTC /bin/sh -c #(nop) WORKDIR /home/podman 2021-06-10 18:56:07 +0000 UTC /bin/sh -c #(nop) LABEL created_at=2021-06... 2021-06-10 18:56:07 +0000 UTC /bin/sh -c #(nop) LABEL created_by=test/sy... 2021-06-10 18:56:07 +0000 UTC /bin/sh -c #(nop) ADD multi:0ed825786ec124... 2021-06-10 18:56:07 +0000 UTC /bin/sh -c apk add busybox-extras ``` Note that sometimes the `image list` timestamp matches the first line from `history`, and sometimes the last. Test code: https://github.com/containers/podman/blob/e60c41657b47584d99a16e5ba5bac253063c2fb4/test/system/110-history.bats#L58-L69 Questions: * Where does `podman image list` get its timestamp from? * How can we fix this test so it is reliable, not just on this image but on all future ones?</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>13</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #14470 from shanesmith/machine-force-remove-doesnt-stop Stop machine before force removing files</MESSAGE>
    <SHA>f7a54088c30dd71a625527aecd740bac8086ccdb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>image list: do not reformat `.CreatedAt` As shown in #14456, the `.CreatedAt` fields for `image list` and of `image history` can differ by one. The discussed theory is that the off-by-one is caused by rounding. Indeed, the field of `image list` is reformatted. `image history` is returning the UNIX time; just as the `.CreatedAt` field should. I am unable to create a reproducer for the issue but double-checked what the docker client does: return the UNIX time. [NO NEW TESTS NEEDED] Fixes: #14456 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>25168c558799fb68064eab36118582e97fb67f5d</SHA>
      <PATCHEDFILES>
        <FILE>cmd/podman/images/list.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>system test image: bump to 20220615 Changes: - use --timestamp option to produce 'created' stamps that can be reliably tested in the image-history test - podman now supports manifest &amp; multiarch run, so we no longer need buildah - bump up base alpine &amp; busybox images This turned out to be WAY more complicated than it should've been, because: - alpine 3.14 fixed 'date -Iseconds' to include a colon in the TZ offset (&quot;-07:00&quot;, was &quot;-0700&quot;). This is now consistent with GNU date's --iso-8601 format, yay, so we can eliminate a minor workaround. - with --timestamp, all ADDed files are set to that timestamp, including the custom-reference-timestamp file that many tests rely on. So we need to split the build into two steps. But: - ...with a two-step build I need to use --squash-all, not --squash, but: - ... (deep sigh) --squash-all doesn't work with --timestamp (#14536) so we need to alter existing tests to deal with new image layers. - And, long and sordid story relating to --rootfs. TL;DR that option only worked by a miracle relating to something special in one specific test image; it doesn't work with any other images. Fix seems to be complicated, so we're bypassing with a FIXME (#14505). And, unrelated: - remove obsolete skip and workaround in run-basic test (dating back to varlink days) - add a pause-image cleanup to avoid icky red warnings in logs Fixes: #14456 Signed-off-by: Ed Santiago &lt;santiago@redhat.com&gt;</MESSAGE>
      <SHA>0a202a9f03e3bb9c9a2f45f6e2593e60b24f794e</SHA>
      <PATCHEDFILES>
        <FILE>test/system/010-images.bats</FILE>
        <FILE>test/system/030-run.bats</FILE>
        <FILE>test/system/070-build.bats</FILE>
        <FILE>test/system/500-networking.bats</FILE>
        <FILE>test/system/build-testimage</FILE>
        <FILE>test/system/helpers.bash</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
