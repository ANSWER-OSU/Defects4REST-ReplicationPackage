<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>23467</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/23467</ISSUEURL>
  <TITLE>`--volume` with `idmap` copies with wrong owner/group</TITLE>
  <DESCRIPTION>### Issue Description If you use a volume which doesn't exist, podman will copy files from the underlying filesystem into the newly created volume. The documentation doesn't seem very clear about this but this is enabled by default. The issue is, that when you also enable `idmap` on the volume, and your container runs with `--userns=auto`, then the copied files are owned by the temporary uid/gid. ### Steps to reproduce the issue Steps to reproduce the issue 1. Make sure volume `tmp` does not exist 2. `podman run --rm -it --userns auto --volume tmp:/etc:idmap alpine:3.20 ls -lahn /etc/` 3. `ls -lahn /var/lib/containers/storage/volumes/tmp/_data/` ### Describe the results you received For Step 2, all files are owned by 65534:65534 (nobody/nogroup) within the container. For Step 3, all files are owned by a dynamic ID outside the container. ### Describe the results you expected For Step 2, all files are owned by 0:0 (root/root) within the container. For Step 3, all files are owned by 0:0 (root/root) outside the container. ### podman info output ```yaml host: arch: arm64 buildahVersion: 1.36.0 cgroupControllers: - cpuset - cpu - io - memory - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.10-1.fc40.aarch64 path: /usr/bin/conmon version: 'conmon version 2.1.10, commit: ' cpuUtilization: idlePercent: 99.74 systemPercent: 0.11 userPercent: 0.15 cpus: 8 databaseBackend: sqlite distribution: distribution: fedora variant: coreos version: &quot;40&quot; eventLogger: journald freeLocks: 2038 hostname: localhost.localdomain idMappings: gidmap: null uidmap: null kernel: 6.11.0-0.rc1.20240729gitdc1c8034e31b.16.fc41.aarch64 linkmode: dynamic logDriver: journald memFree: 13312339968 memTotal: 16716324864 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.11.0-1.fc40.aarch64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.11.0 package: netavark-1.11.0-1.fc40.aarch64 path: /usr/libexec/podman/netavark version: netavark 1.11.0 ociRuntime: name: crun package: crun-1.15-1.fc40.aarch64 path: /usr/bin/crun version: |- crun version 1.15 commit: e6eacaf4034e84185fd8780ac9262bbf57082278 rundir: /run/user/0/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt-0^20240624.g1ee2eca-1.fc40.aarch64 version: | pasta 0^20240624.g1ee2eca-1.fc40.aarch64-pasta Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: false path: /run/podman/podman.sock rootlessNetworkCmd: pasta security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.2-2.fc40.aarch64 version: |- slirp4netns version 1.2.2 commit: 0ee2d87523e906518d34a6b423271e4826f71faf libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.5 swapFree: 0 swapTotal: 0 uptime: 7h 47m 12.00s (Approximately 0.29 days) variant: v8 plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io store: configFile: /usr/share/containers/storage.conf containerStore: number: 4 paused: 0 running: 4 stopped: 0 graphDriverName: overlay graphOptions: overlay.imagestore: /usr/lib/containers/storage overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 491511971840 graphRootUsed: 373449494528 graphStatus: Backing Filesystem: btrfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;true&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 5 runRoot: /run/containers/storage transientStore: false volumePath: /var/lib/containers/storage/volumes version: APIVersion: 5.1.1 Built: 1717459200 BuiltTime: Tue Jun 4 00:00:00 2024 GitCommit: &quot;&quot; GoVersion: go1.22.3 Os: linux OsArch: linux/arm64 Version: 5.1.1 ``` ### Podman in a container No ### Privileged Or Rootless Privileged ### Upstream Latest Release Yes ### Additional environment details As you can see in `podman info`, you can see that I'm running stable fedora coreOS with a newer kernel (6.11-rc1). I did that because I use very recent rk3588 hw, but the issue was also present on the kernel which is shipped with that version of fedora). ### Additional information Additional information like issue happens only occasionally or issue happens with a particular architecture or on a particular setting</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>libpod: avoid hang on errors Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
    <SHA>61def05cd98294614a4b773274030df57fdd9684</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>libpod: fix volume copyup with idmap if idmap is specified for a volume, reverse the mappings when copying up from the container, so that the original permissions are maintained. Closes: https://github.com/containers/podman/issues/23467 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt;</MESSAGE>
      <SHA>3ae15689333ce4d1dd6f9fec70f8297ccc39f931</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>libpod: fix volume copyup with idmap if idmap is specified for a volume, reverse the mappings when copying up from the container, so that the original permissions are maintained. Closes: https://github.com/containers/podman/issues/23467 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt; (cherry picked from commit 3ae15689333ce4d1dd6f9fec70f8297ccc39f931)</MESSAGE>
      <SHA>c146fa1ae167ab0e3d3eb91c9a31bbb7024cca79</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>libpod: fix volume copyup with idmap if idmap is specified for a volume, reverse the mappings when copying up from the container, so that the original permissions are maintained. Closes: https://github.com/containers/podman/issues/23467 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt; (cherry picked from commit 3ae15689333ce4d1dd6f9fec70f8297ccc39f931)</MESSAGE>
      <SHA>b7c772695b444699c18a9a886743235670587ad2</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>libpod: fix volume copyup with idmap if idmap is specified for a volume, reverse the mappings when copying up from the container, so that the original permissions are maintained. Closes: https://github.com/containers/podman/issues/23467 Signed-off-by: Giuseppe Scrivano &lt;gscrivan@redhat.com&gt; (cherry picked from commit 3ae15689333ce4d1dd6f9fec70f8297ccc39f931)</MESSAGE>
      <SHA>941c489ec2353c28587e0db37b183eebaced93f4</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_internal.go</FILE>
        <FILE>test/system/030-run.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
