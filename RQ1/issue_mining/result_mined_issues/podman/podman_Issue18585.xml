<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>18585</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/18585</ISSUEURL>
  <TITLE>No support in podman generate systemd for pod with init container (--init-ctr)</TITLE>
  <DESCRIPTION>### Issue Description Using something like: ``` podman system reset podman pod create --name mypod podman container create --pod=mypod --name=mycontainer alpine:latest podman container create --pod=mypod --init-ctr=always --name=myinitcontainer alpine:latest podman generate systemd --new --no-header --name mypod ``` On podman 4.5.0 generates systemd files which won't work. 1. The --init-ctr flag is added to a podman container run command, which does not support it (only create does) 2. No dependencies are added between to systemd container files, so the init container may be created/started after the main container, which defeats the purpose of a init container. This is mainly an issue for me since now I don't have a nice example of how to set up systemd with a init container :) ### Steps to reproduce the issue ``` podman system reset podman pod create --name mypod podman container create --pod=mypod --name=mycontainer alpine:latest podman container create --pod=mypod --init-ctr=always --name=myinitcontainer alpine:latest podman generate systemd --new --no-header --name mypod ``` Check output for the init container systemd file. ### Describe the results you received ``` ====================================== # pod-mypod.service # autogenerated by Podman 4.5.0 # Wed May 10 10:26:48 UTC 2023 [Unit] Description=Podman pod-mypod.service Documentation=man:podman-generate-systemd(1) Wants=network-online.target After=network-online.target RequiresMountsFor=/run/containers/storage Wants=container-mycontainer.service container-myinitcontainer.service Before=container-mycontainer.service container-myinitcontainer.service [Service] Environment=PODMAN_SYSTEMD_UNIT=%n Restart=on-failure TimeoutStopSec=70 ExecStartPre=/usr/bin/podman pod create \ --infra-conmon-pidfile %t/pod-mypod.pid \ --pod-id-file %t/pod-mypod.pod-id \ --exit-policy=stop \ --name mypod \ --replace ExecStart=/usr/bin/podman pod start \ --pod-id-file %t/pod-mypod.pod-id ExecStop=/usr/bin/podman pod stop \ --ignore \ --pod-id-file %t/pod-mypod.pod-id \ -t 10 ExecStopPost=/usr/bin/podman pod rm \ --ignore \ -f \ --pod-id-file %t/pod-mypod.pod-id PIDFile=%t/pod-mypod.pid Type=forking [Install] WantedBy=default.target ====================================== # container-mycontainer.service # autogenerated by Podman 4.5.0 # Wed May 10 10:26:48 UTC 2023 [Unit] Description=Podman container-mycontainer.service Documentation=man:podman-generate-systemd(1) Wants=network-online.target After=network-online.target RequiresMountsFor=%t/containers BindsTo=pod-mypod.service After=pod-mypod.service [Service] Environment=PODMAN_SYSTEMD_UNIT=%n Restart=on-failure TimeoutStopSec=70 ExecStart=/usr/bin/podman container run \ --cidfile=%t/%n.ctr-id \ --cgroups=no-conmon \ --rm \ --pod-id-file %t/pod-mypod.pod-id \ --sdnotify=conmon \ -d \ --replace \ --name=mycontainer \ --user=2001:2001 \ --read-only alpine:latest ExecStop=/usr/bin/podman stop \ --ignore -t 10 \ --cidfile=%t/%n.ctr-id ExecStopPost=/usr/bin/podman rm \ -f \ --ignore -t 10 \ --cidfile=%t/%n.ctr-id Type=notify NotifyAccess=all [Install] WantedBy=default.target ====================================== # container-myinitcontainer.service # autogenerated by Podman 4.5.0 # Wed May 10 10:26:48 UTC 2023 [Unit] Description=Podman container-myinitcontainer.service Documentation=man:podman-generate-systemd(1) Wants=network-online.target After=network-online.target RequiresMountsFor=%t/containers BindsTo=pod-mypod.service After=pod-mypod.service [Service] Environment=PODMAN_SYSTEMD_UNIT=%n Restart=on-failure TimeoutStopSec=70 ExecStart=/usr/bin/podman container run \ --cidfile=%t/%n.ctr-id \ --cgroups=no-conmon \ --rm \ --pod-id-file %t/pod-mypod.pod-id \ --sdnotify=conmon \ -d \ --replace \ --init-ctr=always \ --name=myinitcontainer \ --user=2001:2001 \ --read-only alpine:latest ExecStop=/usr/bin/podman stop \ --ignore -t 10 \ --cidfile=%t/%n.ctr-id ExecStopPost=/usr/bin/podman rm \ -f \ --ignore -t 10 \ --cidfile=%t/%n.ctr-id Type=notify NotifyAccess=all [Install] WantedBy=default.target ``` ### Describe the results you expected Systemd files which would work correctly with a init container. ### podman info output ```yaml podman 4.5.0, I already removed the VM I tested on, but I think it doesn't matter much for the generate command right? ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release Yes ### Additional environment details - ### Additional information -</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #18583 from flouthoc/compat-pull-accept-string compat,build: pull must accept string</MESSAGE>
    <SHA>a1201843fd6a72181bf47b3df731ac1f8863195f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>generate systemd: error on init containers Init containers are currently not properly supported in generate-systemd and there are no plans to do so since all focus lies on Quadlet going forward. Hence, generate systemd should through an error. Closes: #18585 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>a576fa3f14ca86ed5992575c606e2f0b66a8b1c2</SHA>
      <PATCHEDFILES>
        <FILE>pkg/systemd/generate/containers.go</FILE>
        <FILE>pkg/systemd/generate/pods.go</FILE>
        <FILE>test/e2e/generate_systemd_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
