<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>18659</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/18659</ISSUEURL>
  <TITLE>&quot;podman image rm - concurrent with shared layers&quot; seems racy</TITLE>
  <DESCRIPTION>### Issue Description https://github.com/containers/podman/issues/18631 links to [a test failure](https://api.cirrus-ci.com/v1/artifact/task/5379214719844352/html/int-podman-fedora-38-root-host-boltdb.log.html#t--podman-image-rm-concurrent-with-shared-layers--1). AFAICS the test was added in #9266, with code that was supposed to make `podman rm` more robust against concurrent removals. But the test does not quite test _that_: it tests concurrent (build + remove). AFAICS this means that during a build, a layer can be created, and concurrently an image removal can remove that layer as dangling. (During builds, we don’t have a “reference” pointing to a created layer until an image is created pointing at a layer stack; that’s racy vs. concurrent removals.) Arguably this build-vs-`rm` race is an user-visible problem we should fix, but it’s not trivially obvious how. Meanwhile, the test is failing on something it, AFAICS, it wasn’t intended to trigger. ### Steps to reproduce the issue Steps to reproduce the issue 1. Read https://api.cirrus-ci.com/v1/artifact/task/5379214719844352/html/int-podman-fedora-38-root-host-boltdb.log.html#t--podman-image-rm-concurrent-with-shared-layers--1 2. Read the test code 3. Ponder ### Describe the results you received A test fails in the “build” phase, after at least one removal has happened. ### Describe the results you expected The test not failing ### podman info output ```yaml I guess https://api.cirrus-ci.com/v1/artifact/task/5379214719844352/html/int-podman-fedora-38-root-host-boltdb.log.html#t--podman-image-rm-concurrent-with-shared-layers--1 implicitly contains that data ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release Yes ### Additional environment details Additional environment details ### Additional information Originally discussed in https://github.com/containers/podman/issues/18631#issuecomment-1557915088 .</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #18651 from containers/renovate/requests-2.x chore(deps): update dependency requests to ~=2.31.0</MESSAGE>
    <SHA>c894a12b7492818e1aa9b611164c81c134931dd7</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>In a concurrent removal test, don't remove concurrently with builds This test is intended to test concurrent removals, so don't risk a removal breaking a build. Fixes #18659 . (The sitaution that removals can break a build WIP is a real problem that should be fixed, but that's not a target of this test.) Signed-off-by: Miloslav Trmač &lt;mitr@redhat.com&gt;</MESSAGE>
      <SHA>fb8a124905a347a37b85de014a713f6721f6e714</SHA>
      <PATCHEDFILES>
        <FILE>test/e2e/rmi_test.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
