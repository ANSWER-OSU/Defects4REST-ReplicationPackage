<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>13992</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/13992</ISSUEURL>
  <TITLE>podman cp fails on Mac opening file for writing</TITLE>
  <DESCRIPTION>&lt;!-- --------------------------------------------------- BUG REPORT INFORMATION --------------------------------------------------- Use the commands below to provide key information from your environment: You do NOT have to include this information if this is a FEATURE REQUEST **NOTE** A large number of issues reported against Podman are often found to already be fixed in more current versions of the project. Before reporting an issue, please verify the version you are running with `podman version` and compare it to the latest release documented on the top of Podman's [README.md](../README.md). If they differ, please update your version of Podman to the latest possible and retry your command before creating an issue. Also, there is a running list of known issues in the [Podman Troubleshooting Guide](https://github.com/containers/podman/blob/main/troubleshooting.md), please reference that page before opening a new issue. If you are filing a bug against `podman build`, please instead file a bug against Buildah (https://github.com/containers/buildah/issues). Podman build executes Buildah to perform container builds, and as such the Buildah maintainers are best equipped to handle these bugs. --&gt; **Is this a BUG REPORT or FEATURE REQUEST? (leave only one on its own line)** /kind bug **Description** Running `podman cp` on a Mac results in a failure to write a file due to permissions. Running the same command on Fedora 35 works. This issue breaks `opm`'s Mac support. https://github.com/operator-framework/operator-registry/issues/947 **Steps to reproduce the issue:** These are the same commands run by `opm`. Full output is at the bottom of the issue: ``` #!/usr/bin/env bash podman pull registry.redhat.io/redhat/redhat-operator-index:v4.10 CONTAINERID=&quot;$(podman create registry.redhat.io/redhat/redhat-operator-index:v4.10)&quot; echo &quot;--&gt; Created new container $CONTAINERID&quot; OUTDIR=&quot;$(mktemp -d ./bug.XXXXXX)&quot; echo &quot;--&gt; Created temp dir $OUTDIR&quot; podman cp --log-level=trace &quot;$CONTAINERID:/.&quot; &quot;$OUTDIR/&quot; ``` **Describe the results you received:** exits with error code 125 and this message: ``` error copying to host: copier: put: error creating &quot;/Users/mhrivnak/index_tmp_377180214/root/.bash_logout&quot;: copier: put: error opening file &quot;/Users/mhrivnak/index_tmp_377180214/root/.bash_logout&quot; for writing: open /Users/mhrivnak/index_tmp_377180214/root/.bash_logout: permission denied ``` **Describe the results you expected:** completes without error **Additional information you deem important (e.g. issue happens only occasionally):** I tried this on Fedora 35 with podman 4.0.3 installed, and it worked fine. In the files copied out of the container image by the podman cp command, I see the /root directory has these permissions: ``` $ ls -ld delme/root dr-xr-x---. 3 mhrivnak mhrivnak 4096 Feb 24 06:08 delme/root ``` Note the lack of write permission. On linux it doesn't seem to matter; podman can create the files within that directory anyway. But on OSX it fails to create a file within that directory, presumably because of this issue. But I don't know why the behavior is different. **Output of `podman version`:** ``` Client: Podman Engine Version: 4.0.3 API Version: 4.0.3 Go Version: go1.18 Built: Fri Apr 1 11:28:59 2022 OS/Arch: darwin/arm64 Server: Podman Engine Version: 4.0.3 API Version: 4.0.3 Go Version: go1.18 Built: Fri Apr 1 14:22:39 2022 OS/Arch: linux/arm64 ``` On Fedora 35 I tried both the default 3.4.4 and also the latest 4.0.3 from the copr repo. **Output of `podman info --debug`:** ``` host: arch: arm64 buildahVersion: 1.24.3 cgroupControllers: - cpu - io - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.0-2.fc36.aarch64 path: /usr/bin/conmon version: 'conmon version 2.1.0, commit: ' cpus: 1 distribution: distribution: fedora variant: coreos version: &quot;36&quot; eventLogger: journald hostname: localhost.localdomain idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 100000 size: 1000000 uidmap: - container_id: 0 host_id: 501 size: 1 - container_id: 1 host_id: 100000 size: 1000000 kernel: 5.17.3-300.fc36.aarch64 linkmode: dynamic logDriver: journald memFree: 648540160 memTotal: 2052624384 networkBackend: netavark ociRuntime: name: crun package: crun-1.4.4-1.fc36.aarch64 path: /usr/bin/crun version: |- crun version 1.4.4 commit: 6521fcc5806f20f6187eb933f9f45130c86da230 spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +YAJL os: linux remoteSocket: exists: true path: /run/user/501/podman/podman.sock security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: true slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.0-0.2.beta.0.fc36.aarch64 version: |- slirp4netns version 1.2.0-beta.0 commit: 477db14a24ff1a3de3a705e51ca2c4c1fe3dda64 libslirp: 4.6.1 SLIRP_CONFIG_VERSION_MAX: 3 libseccomp: 2.5.3 swapFree: 0 swapTotal: 0 uptime: 58m 13.94s plugins: log: - k8s-file - none - passthrough - journald network: - bridge - macvlan volume: - local registries: search: - docker.io store: configFile: /var/home/core/.config/containers/storage.conf containerStore: number: 4 paused: 0 running: 0 stopped: 4 graphDriverName: overlay graphOptions: {} graphRoot: /var/home/core/.local/share/containers/storage graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 1 runRoot: /run/user/501/containers volumePath: /var/home/core/.local/share/containers/storage/volumes version: APIVersion: 4.0.3 Built: 1648837359 BuiltTime: Fri Apr 1 14:22:39 2022 GitCommit: &quot;&quot; GoVersion: go1.18 OsArch: linux/arm64 Version: 4.0.3 ``` **Package info (e.g. output of `rpm -q podman` or `apt list podman`):** I did a fresh install today using `brew install` and the podman installation instructions. **Have you tested with the latest version of Podman and have you checked the Podman Troubleshooting Guide? (https://github.com/containers/podman/blob/main/troubleshooting.md)** Yes **Additional environment details (AWS, VirtualBox, physical, etc.):** The full output from the `podman cp` command looks like this: ``` Trying to pull registry.redhat.io/redhat/redhat-operator-index:v4.10... Getting image source signatures Checking if image destination supports signatures Copying blob sha256:668a5d25fac17d6152d51d43fcb2cd4621febad7c83921cc8fabc2d8e4a39cdb Copying blob sha256:bdbe613f08eba774cb8c0dac2fd55736eedd2119e410fc2091d74cbcad3012f0 Copying blob sha256:7e2a0df06931b2605c13731f2191456dbafc73c05e7f49729caed3dab58efde2 Copying blob sha256:04450d2d6a1f61a0caa5bd518407108185956216b5462d1d910bd59244d4ddb9 Copying blob sha256:46995559582b7e824c86dd7e4db8a7aa1a7be90a9a56621b80342432dad552d4 Copying blob sha256:850405e51d250d025ca5e0da83a8092d3096e3f670bfe9bd1fec32c65b5a2313 Copying config sha256:1549594957fcc8fe85aaeb492fb6588183d0b0bb02e34123004232ccb5fb0543 Writing manifest to image destination Storing signatures 1549594957fcc8fe85aaeb492fb6588183d0b0bb02e34123004232ccb5fb0543 --&gt; Created new container 06eb0834e1d6963547d2f61dfa06bd645712e5eb6b48fd124cc41d40df750584 --&gt; Created temp dir ./bug.uCvl8d INFO[0000] podman filtering at log level trace DEBU[0000] Called cp.PersistentPreRunE(podman cp --log-level=trace 06eb0834e1d6963547d2f61dfa06bd645712e5eb6b48fd124cc41d40df750584:/. ./bug.uCvl8d/) DEBU[0000] SSH Ident Key &quot;/Users/mhrivnak/.ssh/podman-machine-default&quot; SHA256:y3C5jd9A8pLDXceMA5aIZkAabLm20Artt0GH97IlFB4 ssh-ed25519 DEBU[0000] Found SSH_AUTH_SOCK &quot;/private/tmp/com.apple.launchd.mOnonmXV3U/Listeners&quot;, ssh-agent signer(s) enabled DEBU[0000] DoRequest Method: GET URI: http://d/v4.0.3/libpod/_ping DEBU[0000] DoRequest Method: GET URI: http://d/v4.0.3/libpod/containers/06eb0834e1d6963547d2f61dfa06bd645712e5eb6b48fd124cc41d40df750584/exists DEBU[0000] DoRequest Method: HEAD URI: http://d/v4.0.3/libpod/containers/06eb0834e1d6963547d2f61dfa06bd645712e5eb6b48fd124cc41d40df750584/archive DEBU[0000] DoRequest Method: GET URI: http://d/v4.0.3/libpod/containers/06eb0834e1d6963547d2f61dfa06bd645712e5eb6b48fd124cc41d40df750584/archive Error: 2 errors occurred: * error copying to host: copier: put: error creating &quot;/Users/mhrivnak/bug.uCvl8d/root/.bash_logout&quot;: copier: put: error opening file &quot;/Users/mhrivnak/bug.uCvl8d/root/.bash_logout&quot; for writing: open /Users/mhrivnak/bug.uCvl8d/root/.bash_logout: permission denied * error copying from container: io: read/write on closed pipe github.com/containers/podman/v4/pkg/errorhandling.JoinErrors /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/pkg/errorhandling/errorhandling.go:33 github.com/containers/podman/v4/cmd/podman/containers.doCopy /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/cmd/podman/containers/cp.go:117 github.com/containers/podman/v4/cmd/podman/containers.copyFromContainer /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/cmd/podman/containers/cp.go:327 github.com/containers/podman/v4/cmd/podman/containers.cp /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/cmd/podman/containers/cp.go:88 github.com/spf13/cobra.(*Command).execute /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/vendor/github.com/spf13/cobra/command.go:856 github.com/spf13/cobra.(*Command).ExecuteC /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/vendor/github.com/spf13/cobra/command.go:974 github.com/spf13/cobra.(*Command).Execute /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/vendor/github.com/spf13/cobra/command.go:902 github.com/spf13/cobra.(*Command).ExecuteContext /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/vendor/github.com/spf13/cobra/command.go:895 main.Execute /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/cmd/podman/root.go:100 main.main /private/tmp/podman-20220402-80792-14flg0w/podman-4.0.3/cmd/podman/main.go:39 runtime.main /opt/homebrew/Cellar/go/1.18/libexec/src/runtime/proc.go:250 runtime.goexit /opt/homebrew/Cellar/go/1.18/libexec/src/runtime/asm_arm64.s:1259 ```</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #13908 from n1hility/win-mounts Implement Windows volume/mount support</MESSAGE>
    <SHA>ace6672bf1a9b011a3c414783496668b5f27f3eb</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>remote: do not join user NS As noticed while debugging #13992, do not join the rootless user NS as a Linux remote client. [NO NEW TESTS NEEDED] as existing tests should continue to work. Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>c090931da4bab192959383005a2221538a07061b</SHA>
      <PATCHEDFILES>
        <FILE>pkg/rootless/rootless_linux.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
