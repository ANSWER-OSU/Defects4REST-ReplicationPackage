<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24895</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/24895</ISSUEURL>
  <TITLE>Detaching from an attached container results in an error</TITLE>
  <DESCRIPTION>### Issue Description Detaching using the detach keys (ctrl-p ,ctrl-q) from a container entered using `podman exec -it` results in an error. ### Steps to reproduce the issue 1. Create a new container `podman run --name container -d alpine sleep infinity` 2. Attach to the newly created container `podman exec -it container ash` 3. Detach from the container by pressing ctrl-p+ctrl-q ### Describe the results you received The container does detach, but it takes several seconds and gives back the following error: ``` ERRO[0005] Container 4cea188839ea3627df1226058ac9f9f97a5fdfc852f87ac6b0a70db9a7420298 exec session 182c1e4c3ded8d9f2b318bd524edcf7b41e95bcad996fc688b9efb78bac59648 error: detached from container Error: timed out waiting for file /var/home/job/.local/share/containers/storage/overlay-containers/4cea188839ea3627df1226058ac9f9f97a5fdfc852f87ac6b0a70db9a7420298/userdata/182c1e4c3ded8d9f2b318bd524edcf7b41e95bcad996fc688b9efb78bac59648/exit/4cea188839ea3627df1226058ac9f9f97a5fdfc852f87ac6b0a70db9a7420298 ``` Full terminal session: ``` fedora $ podman run --name container -d alpine sleep infinity 4cea188839ea3627df1226058ac9f9f97a5fdfc852f87ac6b0a70db9a7420298 fedora $ podman exec -it container ash / # ERRO[0005] Container 4cea188839ea3627df1226058ac9f9f97a5fdfc852f87ac6b0a70db9a7420298 exec session 182c1e4c3ded8d9f2b318bd524edcf7b41e95bcad996fc688b9efb78bac59648 error: detached from container Error: timed out waiting for file /var/home/job/.local/share/containers/storage/overlay-containers/4cea188839ea3627df1226058ac9f9f97a5fdfc852f87ac6b0a70db9a7420298/userdata/182c1e4c3ded8d9f2b318bd524edcf7b41e95bcad996fc688b9efb78bac59648/exit/4cea188839ea3627df1226058ac9f9f97a5fdfc852f87ac6b0a70db9a7420298 fedora $ ``` ### Describe the results you expected Detaching the container should not take several seconds, and should not result in an error. ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.38.0 cgroupControllers: - cpu - io - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.12-3.fc41.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.12, commit: ' cpuUtilization: idlePercent: 98.16 systemPercent: 0.49 userPercent: 1.35 cpus: 16 databaseBackend: sqlite distribution: distribution: fedora variant: silverblue version: &quot;41&quot; eventLogger: journald freeLocks: 2038 hostname: fedora idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 524288 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 524288 size: 65536 kernel: 6.12.5-200.fc41.x86_64 linkmode: dynamic logDriver: journald memFree: 6038581248 memTotal: 14477561856 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.13.1-1.fc41.x86_64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.13.1 package: netavark-1.13.1-1.fc41.x86_64 path: /usr/libexec/podman/netavark version: netavark 1.13.1 ociRuntime: name: crun package: crun-1.19.1-1.fc41.x86_64 path: /usr/bin/crun version: |- crun version 1.19.1 commit: 3e32a70c93f5aa5fea69b50256cca7fd4aa23c80 rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt-0^20241211.g09478d5-1.fc41.x86_64 version: | pasta 0^20241211.g09478d5-1.fc41.x86_64 Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: true path: /run/user/1000/podman/podman.sock rootlessNetworkCmd: pasta security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.3.1-1.fc41.x86_64 version: |- slirp4netns version 1.3.1 commit: e5e368c4f5db6ae75c2fce786e31eef9da6bf236 libslirp: 4.8.0 SLIRP_CONFIG_VERSION_MAX: 5 libseccomp: 2.5.5 swapFree: 8589930496 swapTotal: 8589930496 uptime: 0h 56m 22.00s variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io store: configFile: /var/home/job/.config/containers/storage.conf containerStore: number: 5 paused: 0 running: 3 stopped: 2 graphDriverName: overlay graphOptions: {} graphRoot: /var/home/job/.local/share/containers/storage graphRootAllocated: 1022488477696 graphRootUsed: 22809714688 graphStatus: Backing Filesystem: btrfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;false&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 6 runRoot: /run/user/1000/containers transientStore: false volumePath: /var/home/job/.local/share/containers/storage/volumes version: APIVersion: 5.3.1 Built: 1732147200 BuiltTime: Thu Nov 21 01:00:00 2024 GitCommit: &quot;&quot; GoVersion: go1.23.3 Os: linux OsArch: linux/amd64 Version: 5.3.1 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release Yes</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>41</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #25073 from Luap99/vendor vendor latest c/{common,image,storage}</MESSAGE>
    <SHA>4700d15c125552818222907a486d712e1230cbc9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Given that I could not find any existing test for the detach key functionality not even for exec I added some. This seems to reval more issues with on podman-remote. Fixes #24895 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>bd72b99d46c796a991273dc6177c10da6a05ed86</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>test/system/450-interactive.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Given that I could not find any existing test for the detach key functionality not even for exec I added some. This seems to reval more issues with on podman-remote, podman-remote run detach was broken which I fixed here as well but for podman-remote exec something bigger is needed. While I thought I fixed most problems there there was a strange raqce condition which caused the process to jung hang. Thus I skipped the remote exec test for now and filled #25089 to track that. Fixes #24895 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>6c96f9098c055a08bbc9b04e1163cf871c661c06</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>libpod/util.go</FILE>
        <FILE>pkg/api/handlers/compat/exec.go</FILE>
        <FILE>pkg/domain/infra/tunnel/containers.go</FILE>
        <FILE>test/system/450-interactive.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Given that I could not find any existing test for the detach key functionality not even for exec I added some. This seems to reveal more issues with on podman-remote, podman-remote run detach was broken which I fixed here as well but for podman-remote exec something bigger is needed. While I thought I fixed most problems there there was a strange race condition which caused the process to just hang. Thus I skipped the remote exec test for now and filled #25089 to track that. Fixes #24895 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>ba4cf6ba3eccf50f9518b3946466b84492ba5695</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>libpod/util.go</FILE>
        <FILE>pkg/api/handlers/compat/exec.go</FILE>
        <FILE>pkg/domain/infra/tunnel/containers.go</FILE>
        <FILE>test/system/450-interactive.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Given that I could not find any existing test for the detach key functionality not even for exec I added some. This seems to reveal more issues with on podman-remote, podman-remote run detach was broken which I fixed here as well but for podman-remote exec something bigger is needed. While I thought I fixed most problems there there was a strange race condition which caused the process to just hang. Thus I skipped the remote exec test for now and filled #25089 to track that. Fixes #24895 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>f8a73cc4ce0a7a94257f9ab5a85f3ef326b6347b</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>libpod/util.go</FILE>
        <FILE>pkg/api/handlers/compat/exec.go</FILE>
        <FILE>pkg/domain/infra/tunnel/containers.go</FILE>
        <FILE>test/system/450-interactive.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Given that I could not find any existing test for the detach key functionality not even for exec I added some. This seems to reveal more issues with on podman-remote, podman-remote run detach was broken which I fixed here as well but for podman-remote exec something bigger is needed. While I thought I fixed most problems there there was a strange race condition which caused the process to just hang. Thus I skipped the remote exec test for now and filled #25089 to track that. Fixes #24895 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>d0ab25ed658ffcb55f4bb3817ed84a6a6b4e2f86</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>libpod/util.go</FILE>
        <FILE>pkg/api/handlers/compat/exec.go</FILE>
        <FILE>pkg/domain/infra/tunnel/containers.go</FILE>
        <FILE>test/system/450-interactive.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Given that I could not find any existing test for the detach key functionality not even for exec I added some. This seems to reveal more issues with on podman-remote, podman-remote run detach was broken which I fixed here as well but for podman-remote exec something bigger is needed. While I thought I fixed most problems there there was a strange race condition which caused the process to just hang. Thus I skipped the remote exec test for now and filled #25089 to track that. Fixes #24895 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>61fd7a43e314dae4189936dffdca1eca13b8547c</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>libpod/util.go</FILE>
        <FILE>pkg/api/handlers/compat/exec.go</FILE>
        <FILE>pkg/domain/infra/tunnel/containers.go</FILE>
        <FILE>test/system/450-interactive.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Given that I could not find any existing test for the detach key functionality not even for exec I added some. This seems to reveal more issues with on podman-remote, podman-remote run detach was broken which I fixed here as well but for podman-remote exec something bigger is needed. While I thought I fixed most problems there there was a strange race condition which caused the process to just hang. Thus I skipped the remote exec test for now and filled #25089 to track that. Fixes #24895 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>fd2b2be77cda43ee385e975881ed342a0e0db7c6</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>libpod/util.go</FILE>
        <FILE>pkg/api/handlers/compat/exec.go</FILE>
        <FILE>pkg/domain/infra/tunnel/containers.go</FILE>
        <FILE>test/system/450-interactive.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Now I wrote automated test for both podman run and exec detach but this uncovered several larger issues: - detach sequence parsing is broken[1] - podman-remote exec detach is broken[2] - detach in general seems to be buggy/racy, seeing lot of flakes that fail to restore the terminal and get an EIO instead, i.e. &quot;Unable to restore terminal: input/output error&quot; Thus I cannot add tests for now but this commit should at least fix the obvoius case as reported by the user so I like to get this in regardless and I will work through the other issues once I have more time. Fixes #24895 [1] https://github.com/containers/common/pull/2302 [2] https://github.com/containers/podman/issues/25089 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>f0ef7918085e662341769e609eb5395ed02e1633</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>libpod/util.go</FILE>
        <FILE>pkg/api/handlers/compat/exec.go</FILE>
        <FILE>pkg/domain/infra/tunnel/containers.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>podman exec: correctly support detaching podman exec support detaching early via the detach key sequence. In that case the podman process should exit successfully but the container exec process keeps running. Now I wrote automated test for both podman run and exec detach but this uncovered several larger issues: - detach sequence parsing is broken[1] - podman-remote exec detach is broken[2] - detach in general seems to be buggy/racy, seeing lot of flakes that fail to restore the terminal and get an EIO instead, i.e. &quot;Unable to restore terminal: input/output error&quot; Thus I cannot add tests for now but this commit should at least fix the obvoius case as reported by the user so I like to get this in regardless and I will work through the other issues once I have more time. Fixes #24895 [1] https://github.com/containers/common/pull/2302 [2] https://github.com/containers/podman/issues/25089 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>9e2e7f2a77ab81fdddf101d47c2ccc7c3fb5929d</SHA>
      <PATCHEDFILES>
        <FILE>libpod/container_exec.go</FILE>
        <FILE>libpod/util.go</FILE>
        <FILE>pkg/api/handlers/compat/exec.go</FILE>
        <FILE>pkg/domain/infra/tunnel/containers.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
