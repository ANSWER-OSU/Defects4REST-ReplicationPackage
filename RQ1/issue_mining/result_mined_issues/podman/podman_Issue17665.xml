<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>17665</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/17665</ISSUEURL>
  <TITLE>podman events duplicates events after rotation</TITLE>
  <DESCRIPTION>### Issue Description When the libpod events file gets rotated in [libpod/events/logfile.go](https://github.com/containers/podman/blob/main/libpod/events/logfile.go#L165-L188), the log file gets truncated by discarding the older half of all events. But the `podman events` command reads all events again after a log rotation has occurred. Therefore, the newer half of the logs (which is not discarded) is printed again. ### Steps to reproduce the issue Steps to reproduce the issue 1. Set `events_logfile_max_size = &quot;4k&quot;` in the `[engine]` section in the `containers.conf` file 2. Watch the events with `podman events` 3. In another terminal: Generate some events (e.g. `podman run --rm hello-world`) ### Describe the results you received After the second or third `podman run` invocation, the file gets rotated and some events, which have already been printed, get printed again. ### Describe the results you expected Each event should be printed exactly once. Even after rotating the events file. ### podman info output ```yaml podman version 4.3.1, alpine 3.17, x86_64 ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release No ### Additional environment details _No response_ ### Additional information _No response_</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>14</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #17786 from Luap99/mac-helper-error podman-mac-helper: exit 1 on error</MESSAGE>
    <SHA>68bf49799d6085bcc0752e15630ad18ff4d99e19</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>events: no duplicates when streaming during a log rotation When streaming events, prevent returning duplicates after a log rotation by marking a beginning and an end for rotated events. Before starting to stream, get a timestamp while holding the event lock. The timestamp allows for detecting whether a rotation event happened while reading the log file and to skip all events between the begin and end rotation event. In an ideal scenario, we could detect rotated events by enforcing a chronological order when reading and skip those detected to not be more recent than the last read event. However, events are not always _written_ in chronological order. While this can be changed, existing event files could not be read correctly anymore. Fixes: #17665 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>408e764b945a9b3b4ebd853d0270cda0d24c48dc</SHA>
      <PATCHEDFILES>
        <FILE>libpod/events/logfile.go</FILE>
        <FILE>libpod/events/logfile_test.go</FILE>
        <FILE>test/system/090-events.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
