<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24374</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/24374</ISSUEURL>
  <TITLE>netavark: unable to append rule '-j MARK --set-xmark 0x2000/0x2000' to table 'nat'</TITLE>
  <DESCRIPTION>### Issue Description running a pod causes fails with an iptables6 error ``` netavark: unable to append rule '-j MARK --set-xmark 0x2000/0x2000' to table 'nat' ``` ``` root@core:/etc/containers/systemd# systemctl status forgejo ● forgejo.service - The sleep container Loaded: loaded (/etc/containers/systemd/forgejo.kube; generated) Drop-In: /usr/lib/systemd/system/service.d └─10-timeout-abort.conf Active: active (running) since Fri 2024-10-25 22:07:02 CEST; 9min ago Main PID: 1943 (conmon) Tasks: 1 (limit: 3970) Memory: 5.4M (peak: 24.5M) CPU: 464ms CGroup: /system.slice/forgejo.service └─1943 /usr/bin/conmon --api-version 1 -c 739b51ab8aad1294951a06a4ed70798cdd2c0f16c0a362c611f02357fb2d3e06 -u 739b51ab8aad1294951a06a4ed70798cdd2c0f16c0a362c611f02357fb2d3e06 -r /usr/bin/crun -b /var/lib/containers/storage/&gt; Oct 25 22:07:02 core forgejo[1932]: Containers: Oct 25 22:07:02 core forgejo[1932]: e830c99d45dac1888caf57e911844c3c2d04626590be79318ea0e011100ecb50 Oct 25 22:07:02 core forgejo[1932]: a27ab24731bd283b22ebd20479af1d4e3571c2f0c58f3bf00aa6114185d1761b Oct 25 22:07:02 core forgejo[1932]: starting container 2ef93257f5b1ac3fc2e57aebdf43dd7b4e90cd48a82ec33106abcb21d4f1459d: netavark: unable to append rule '-j MARK --set-xmark 0x2000/0x2000' to table 'nat': code: 2, msg: Warning: Extensi&gt; Oct 25 22:07:02 core forgejo[1932]: ip6tables v1.8.10 (nf_tables): unknown option &quot;--set-xmark&quot; Oct 25 22:07:02 core forgejo[1932]: Try `ip6tables -h' or 'ip6tables --help' for more information. Oct 25 22:07:02 core forgejo[1932]: starting container a27ab24731bd283b22ebd20479af1d4e3571c2f0c58f3bf00aa6114185d1761b: a dependency of container a27ab24731bd283b22ebd20479af1d4e3571c2f0c58f3bf00aa6114185d1761b failed to start: contain&gt; Oct 25 22:07:02 core forgejo[1932]: starting container e830c99d45dac1888caf57e911844c3c2d04626590be79318ea0e011100ecb50: a dependency of container e830c99d45dac1888caf57e911844c3c2d04626590be79318ea0e011100ecb50 failed to start: contain&gt; Oct 25 22:07:02 core forgejo[1932]: Error: failed to start 3 containers Oct 25 22:07:02 core systemd[1]: Started forgejo.service - The sleep container. ``` ### Steps to reproduce the issue Steps to reproduce the issue 1. make files mentioned in `additional information` section of the issue in /etc/containers/systemd 2. systemctl daemon-reload 3. systemctl start forgejo ### Describe the results you received systemd service is runnning, but containers are not ### Describe the results you expected containers running ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.37.3 cgroupControllers: - cpuset - cpu - io - memory - hugetlb - pids - rdma - misc cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.12-2.fc40.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.12, commit: ' cpuUtilization: idlePercent: 98.81 systemPercent: 0.74 userPercent: 0.45 cpus: 4 databaseBackend: sqlite distribution: distribution: fedora variant: server version: &quot;40&quot; eventLogger: journald freeLocks: 2035 hostname: core idMappings: gidmap: null uidmap: null kernel: 6.11.4-201.fc40.x86_64 linkmode: dynamic logDriver: journald memFree: 1889120256 memTotal: 3591000064 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.12.2-2.fc40.x86_64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.12.2 package: netavark-1.12.2-1.fc40.x86_64 path: /usr/libexec/podman/netavark version: netavark 1.12.2 ociRuntime: name: crun package: crun-1.17-1.fc40.x86_64 path: /usr/bin/crun version: |- crun version 1.17 commit: 000fa0d4eeed8938301f3bcf8206405315bc1017 rundir: /run/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt-0^20240906.g6b38f07-1.fc40.x86_64 version: | pasta 0^20240906.g6b38f07-1.fc40.x86_64-pasta Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: true path: /run/podman/podman.sock rootlessNetworkCmd: pasta security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: false seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: /usr/bin/slirp4netns package: slirp4netns-1.2.2-2.fc40.x86_64 version: |- slirp4netns version 1.2.2 commit: 0ee2d87523e906518d34a6b423271e4826f71faf libslirp: 4.7.0 SLIRP_CONFIG_VERSION_MAX: 4 libseccomp: 2.5.5 swapFree: 3590320128 swapTotal: 3590320128 uptime: 0h 17m 38.00s variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io store: configFile: /usr/share/containers/storage.conf containerStore: number: 10 paused: 0 running: 3 stopped: 7 graphDriverName: overlay graphOptions: overlay.imagestore: /usr/lib/containers/storage overlay.mountopt: nodev,metacopy=on graphRoot: /var/lib/containers/storage graphRootAllocated: 237908262912 graphRootUsed: 3781160960 graphStatus: Backing Filesystem: btrfs Native Overlay Diff: &quot;false&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;true&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;true&quot; imageCopyTmpDir: /var/tmp imageStore: number: 7 runRoot: /run/containers/storage transientStore: false volumePath: /var/lib/containers/storage/volumes version: APIVersion: 5.2.3 Built: 1727136000 BuiltTime: Tue Sep 24 02:00:00 2024 GitCommit: &quot;&quot; GoVersion: go1.22.7 Os: linux OsArch: linux/amd64 Version: 5.2.3 ``` ### Podman in a container No ### Privileged Or Rootless Privileged ### Upstream Latest Release No ### Additional environment details bare metal server ### Additional information this doesnt work with 3 services: traefik, forgejo and vaultwarden. config for forgejo /etc/containers/systemd/forgejo.kube ```ini [Unit] Description=The sleep container After=network.target [Kube] Yaml=forgejo.yaml Network=systemd-traefik [Install] WantedBy=multi-user.target default.target ``` /etc/containers/systemd/forgejo.yaml ```yaml apiVersion: v1 kind: Pod metadata: annotations: bind-mount-options: /var/run/podman/podman.sock:z creationTimestamp: &quot;2024-02-18T16:02:00Z&quot; labels: app: forgejo traefik.enable: true traefik.http.routers.forgejo.entrypoints: websecure traefik.http.routers.forgejo.rule: &quot;Host(`git.mydomain`)&quot; traefik.http.routers.forgejo.service: forgejo traefik.http.routers.forgejo.tls: true traefik.http.routers.forgejo.tls.certresolver: lets-encr-porkbun traefik.http.services.forgejo.loadbalancer.server.port: 3000 name: forgejo-pod spec: containers: - image: codeberg.org/forgejo/forgejo:8.0.3 name: forgejo env: - name: FORGEJO__database__DB_TYPE value: postgres - name: FORGEJO__database__HOST value: localhost:5432 - name: FORGEJO__database__NAME value: forgejo - name: FORGEJO__database__USER value: forgejo - name: FORGEJO__database__PASSWD value: x - name: MIN_PASSWORD_LENGTH value: 4 volumeMounts: - mountPath: /data:z name: app-data-0 readOnly: false - mountPath: /etc/localtime name: etc-localtime-2 readOnly: true - image: postgres:latest name: forgejo-db env: - name: POSTGRES_USER value: forgejo - name: POSTGRES_PASSWORD value: x - name: POSTGRES_DB value: forgejo volumeMounts: - mountPath: /var/lib/postgresql/data:z name: db-data-1 readOnly: false - mountPath: /etc/localtime name: etc-localtime-2 readOnly: true restartPolicy: Always volumes: - hostPath: path: /data/forgejo/app type: Directory name: app-data-0 - hostPath: path: /data/forgejo/db type: Directory name: db-data-1 - hostPath: path: /etc/localtime type: File name: etc-localtime-2 ``` /etc/containers/systemd/traefik.network ```ini [Network] IPv6=true ```</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #24358 from Luap99/healthcheck-startup-leak healthcheck: do not leak startup service</MESSAGE>
    <SHA>2f6fca6edc5c0d4e0a1d758a14c9de7014cd0561</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>test/system: add podman network reload test to distro gating The recent fedora kernel 6.11.4 has a problem with ipv6 networks [1]. This is not a podman bug at all but rather a kernel regession. I can reproduce the issue easily by running this test. Given many users were hit by this add it to the distro level gating which runs in the fedora openQA framework and then we should catch a bad kernel like this hopefully in the future and prevent it from going into stable. [1] https://github.com/containers/podman/issues/24374 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>848451142fb519c12fee967899f527400898fe2b</SHA>
      <PATCHEDFILES>
        <FILE>test/system/500-networking.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>test/system: add podman network reload test to distro gating The recent fedora kernel 6.11.4 has a problem with ipv6 networks [1]. This is not a podman bug at all but rather a kernel regression. I can reproduce the issue easily by running this test. Given many users were hit by this add it to the distro level gating which runs in the fedora openQA framework and then we should catch a bad kernel like this hopefully in the future and prevent it from going into stable. [1] https://github.com/containers/podman/issues/24374 Signed-off-by: Paul Holzinger &lt;pholzing@redhat.com&gt;</MESSAGE>
      <SHA>64516e1b8fea5612e9371b956415d559b36a615f</SHA>
      <PATCHEDFILES>
        <FILE>test/system/500-networking.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
