<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24045</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/24045</ISSUEURL>
  <TITLE>Rootless podman 5.2 with pasta now publishes processes which only listen on 127.0.0.1 in the container</TITLE>
  <DESCRIPTION>### Issue Description With previous rootless podman setups, having a process listen on 127.0.0.1 in the container and publishing that port to the host did not expose that process to the host. Or rather, while connection could be made, it was killed right away (Connection reset by peer when tested with curl). This was very similar to the the rootful podman behaviour (Couldn't connect to server). With podman-5.2.2-1.fc40.x86_64 with passt-0^20240906.g6b38f07-1.fc40.x86_64 I see a change of behaviour -- the process in the container is reachable on the published port on the host even if the process in the container is supposed to only listen on 127.0.0.1. ### Steps to reproduce the issue Steps to reproduce the issue 1. Have Dockerfile to get us some server where we can easily control where it listens: ``` FROM registry.fedoraproject.org/fedora RUN dnf install -y python3-django RUN django-admin startproject mysite WORKDIR /mysite ENTRYPOINT [ &quot;python3&quot;, &quot;manage.py&quot;, &quot;runserver&quot; ] ``` 2. `podman build -t localhost/django .` 3. `podman rm -f django ; podman run --name django -d -p 8000:8000 localhost/django 127.0.0.1:8000` 4. `curl -s http://127.0.0.1:8000/ | head` 5. In case the above `curl` does not show anything, `curl http://127.0.0.1:8000/` ### Describe the results you received With rootless podman-5.2.2-1.fc40.x86_64 with passt-0^20240906.g6b38f07-1.fc40.x86_64 I see ``` &lt;!doctype html&gt; &lt;html lang=&quot;en-us&quot; dir=&quot;ltr&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;utf-8&quot;&gt; &lt;title&gt;The install worked successfully! Congratulations!&lt;/title&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt; &lt;style&gt; html { ``` ### Describe the results you expected With rootless podman-4.9.4-1.fc39.x86_64 with rootlessport I see ``` curl: (56) Recv failure: Connection reset by peer ``` With rootful setup, both podman-4.9.4-1.fc39.x86_64 and podman-5.2.2-1.fc40.x86_64, I get ``` curl: (7) Failed to connect to 127.0.0.1 port 8000 after 0 ms: Couldn't connect to server ``` ### podman info output ```yaml host: arch: amd64 buildahVersion: 1.37.2 cgroupControllers: - cpu - memory - pids cgroupManager: systemd cgroupVersion: v2 conmon: package: conmon-2.1.12-2.fc40.x86_64 path: /usr/bin/conmon version: 'conmon version 2.1.12, commit: ' cpuUtilization: idlePercent: 97.84 systemPercent: 0.53 userPercent: 1.63 cpus: 2 databaseBackend: sqlite distribution: distribution: fedora version: &quot;40&quot; eventLogger: journald freeLocks: 2047 hostname: redacted.domain.com idMappings: gidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 524288 size: 65536 uidmap: - container_id: 0 host_id: 1000 size: 1 - container_id: 1 host_id: 524288 size: 65536 kernel: 6.10.10-200.fc40.x86_64 linkmode: dynamic logDriver: journald memFree: 1263239168 memTotal: 3036377088 networkBackend: netavark networkBackendInfo: backend: netavark dns: package: aardvark-dns-1.12.2-2.fc40.x86_64 path: /usr/libexec/podman/aardvark-dns version: aardvark-dns 1.12.2 package: netavark-1.12.2-1.fc40.x86_64 path: /usr/libexec/podman/netavark version: netavark 1.12.2 ociRuntime: name: crun package: crun-1.17-1.fc40.x86_64 path: /usr/bin/crun version: |- crun version 1.17 commit: 000fa0d4eeed8938301f3bcf8206405315bc1017 rundir: /run/user/1000/crun spec: 1.0.0 +SYSTEMD +SELINUX +APPARMOR +CAP +SECCOMP +EBPF +CRIU +LIBKRUN +WASM:wasmedge +YAJL os: linux pasta: executable: /usr/bin/pasta package: passt-0^20240906.g6b38f07-1.fc40.x86_64 version: | pasta 0^20240906.g6b38f07-1.fc40.x86_64 Copyright Red Hat GNU General Public License, version 2 or later &lt;https://www.gnu.org/licenses/old-licenses/gpl-2.0.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. remoteSocket: exists: false path: /run/user/1000/podman/podman.sock rootlessNetworkCmd: pasta security: apparmorEnabled: false capabilities: CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_NET_BIND_SERVICE,CAP_SETFCAP,CAP_SETGID,CAP_SETPCAP,CAP_SETUID,CAP_SYS_CHROOT rootless: true seccompEnabled: true seccompProfilePath: /usr/share/containers/seccomp.json selinuxEnabled: true serviceIsRemote: false slirp4netns: executable: &quot;&quot; package: &quot;&quot; version: &quot;&quot; swapFree: 3035623424 swapTotal: 3035623424 uptime: 0h 36m 13.00s variant: &quot;&quot; plugins: authorization: null log: - k8s-file - none - passthrough - journald network: - bridge - macvlan - ipvlan volume: - local registries: search: - registry.fedoraproject.org - registry.access.redhat.com - docker.io store: configFile: /home/test/.config/containers/storage.conf containerStore: number: 1 paused: 0 running: 1 stopped: 0 graphDriverName: overlay graphOptions: {} graphRoot: /home/test/.local/share/containers/storage graphRootAllocated: 16039018496 graphRootUsed: 2594983936 graphStatus: Backing Filesystem: xfs Native Overlay Diff: &quot;true&quot; Supports d_type: &quot;true&quot; Supports shifting: &quot;false&quot; Supports volatile: &quot;true&quot; Using metacopy: &quot;false&quot; imageCopyTmpDir: /var/tmp imageStore: number: 6 runRoot: /run/user/1000/containers transientStore: false volumePath: /home/test/.local/share/containers/storage/volumes version: APIVersion: 5.2.2 Built: 1724198400 BuiltTime: Wed Aug 21 02:00:00 2024 GitCommit: &quot;&quot; GoVersion: go1.22.6 Os: linux OsArch: linux/amd64 Version: 5.2.2 ``` ### Podman in a container No ### Privileged Or Rootless Rootless ### Upstream Latest Release No ### Additional environment details Tested with stock Fedora packages. ### Additional information Deterministic on a fresh Fedora server installation.</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>36</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #23487 from Luap99/ebpf add epbf program to trace podman cleanup errors in CI</MESSAGE>
    <SHA>af4b061f5383938a38910d81a0f637c478fc838f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>test/system: For pasta port forwarding tests don't bind socat server The various pasta port forwarding tests run a socat server inside a container, then connect to it from a socat client on the host. Currently we have the server bind to the same specific address within the container as we connect to on the host. That's not quite what we want. For &quot;tap&quot; tests where the traffic goes over pasta's L2 link to the container it's fine, though unnecessary. For &quot;loopback&quot; tests where traffic is forwarded by pasta at the L4 socket level, however, it's not quite right. In this case the address used is either 127.0.0.1 or ::. That's correct and as needed for the host side address we're connecting to. However on the container side, this only works because of an odd and arguably undesirable behaviour of pasta: we use the fact that we have an L4 socket within the container to make such &quot;spliced&quot; L4 connections appear as if they come from loopback within the container. A container will generally expect it's loopback address to be only accessible from within the container, and this odd behaviour may be changed in pasta in future. In any case, the binding of the container side server is unnecessary, so simply remove it. Link: https://github.com/containers/podman/issues/24045 Signed-off-by: David Gibson &lt;david@gibson.dropbear.id.au&gt;</MESSAGE>
      <SHA>1f2658e0eff022a745580e132909e4a656dd53a3</SHA>
      <PATCHEDFILES>
        <FILE>test/system/505-networking-pasta.bats</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
