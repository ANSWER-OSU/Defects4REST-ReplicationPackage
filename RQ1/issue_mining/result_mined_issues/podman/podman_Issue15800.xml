<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15800</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/15800</ISSUEURL>
  <TITLE>sdnotify test: podman wait: hangs</TITLE>
  <DESCRIPTION>New flake seen in [f36 rootless](https://api.cirrus-ci.com/v1/artifact/task/5520403421462528/html/sys-podman-fedora-36-rootless-host.log.html#t--00305): ``` [+1429s] not ok 305 sdnotify : play kube - with policies # (from function `run_podman' in file test/system/[helpers.bash, line 207](https://github.com/containers/podman/blob/dd53ee59988d49a892fde7a86e41ef636f9814aa/test/system/helpers.bash#L207), # in test file test/system/[260-sdnotify.bats, line 342](https://github.com/containers/podman/blob/dd53ee59988d49a892fde7a86e41ef636f9814aa/test/system/260-sdnotify.bats#L342)) # `run_podman container wait $container_a' failed # $ podman rm -t 0 --all --force --ignore # $ podman ps --all --external --format {{.ID}} {{.Names}} # $ podman images --all --format {{.Repository}}:{{.Tag}} {{.ID}} # quay.io/libpod/testimage:20220615 f26aa69bb3f3 # $ podman pull quay.io/libpod/fedora:31 # Trying to pull quay.io/libpod/fedora:31... # Getting image source signatures # Copying blob sha256:c28ace6b0c4ae099f6f81091731bdf41d9771d28bad96ae4a3507fe950560930 # Copying config sha256:a7a37f74ff864eec55891b64ad360d07020827486e30a92ea81d16459645b26a # Writing manifest to image destination # Storing signatures # a7a37f74ff864eec55891b64ad360d07020827486e30a92ea81d16459645b26a # $ podman container wait test_pod-a test_pod-b --condition=running # Error: no container with name or ID &quot;test_pod-a&quot; found: no such container # [ rc=125 ] # $ podman ps -a # CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES # 8afb597b4654 localhost/podman-pause:4.3.0-dev-1663157913 Less than a second ago Created 9cffc8377ee1-service # 6c9d131429af localhost/podman-pause:4.3.0-dev-1663157913 Less than a second ago Created 53ad1b768e5f-infra # $ podman container wait test_pod-a test_pod-b --condition=running # Error: no container with name or ID &quot;test_pod-a&quot; found: no such container # [ rc=125 ] # $ podman ps -a # CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES # 8afb597b4654 localhost/podman-pause:4.3.0-dev-1663157913 Less than a second ago Created 9cffc8377ee1-service # 6c9d131429af localhost/podman-pause:4.3.0-dev-1663157913 Less than a second ago Created 53ad1b768e5f-infra # 10dccf1282bc quay.io/libpod/fedora:31 Less than a second ago Created test_pod-a # $ podman container wait test_pod-a test_pod-b --condition=running # Error: no container with name or ID &quot;test_pod-b&quot; found: no such container # [ rc=125 ] # $ podman ps -a # CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES # 8afb597b4654 localhost/podman-pause:4.3.0-dev-1663157913 1 second ago Up Less than a second ago 9cffc8377ee1-service # 6c9d131429af localhost/podman-pause:4.3.0-dev-1663157913 1 second ago Up Less than a second ago 53ad1b768e5f-infra # 10dccf1282bc quay.io/libpod/fedora:31 1 second ago Up Less than a second ago test_pod-a # 10a2c0df9a40 quay.io/libpod/testimage:20220615 Less than a second ago Up Less than a second ago test_pod-b # $ podman container wait test_pod-a test_pod-b --condition=running # -1 # -1 # $ podman container inspect test_pod-a test_pod-b 9cffc8377ee1-service --format {{.Config.SdNotifyMode}} # container # conmon # ignore # /var/tmp/go/src/github.com/containers/podman/test/system/260-sdnotify.bats: line 326: /tmp/podman_bats.v90amR/socat.log: No such file or directory # $ podman container inspect test_pod-a --format {{.Config.SdNotifySocket}} # /var/tmp/-podman-notify-proxy.sock1715659030 # $ podman logs test_pod-a # /run/notify/notify.sock # READY # $ podman exec test_pod-a /bin/touch /stop # $ podman container inspect 9cffc8377ee1-service --format {{.State.ConmonPid}} # 100133 # $ podman container wait test_pod-a # timeout: sending signal TERM to command ‘/var/tmp/go/src/github.com/containers/podman/bin/podman’ # [ rc=124 (** EXPECTED 0 **) ] # *** TIMED OUT *** ``` That is, `podman container wait` is hanging. Code: https://github.com/containers/podman/blob/ae20f19351c03398d10ba94a31f21dcf3d86f31c/test/system/260-sdnotify.bats#L342 Looking at flake logs, first logged instance was on Monday: ### [sys] 304 sdnotify : play kube - with policies * fedora-36 : sys podman fedora-36 rootless host * PR #15753 * [09-12 22:10](https://api.cirrus-ci.com/v1/artifact/task/6085149208084480/html/sys-podman-fedora-36-rootless-host.log.html#t--00304)</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>11</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>kube play: sdnotify proxy: use a wait group Use a wait group to a) wait for all proxies in parallel b) avoid the potential for ABBA deadlocks [NO NEW TESTS NEEDED] as it is not changing functionality Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
    <SHA>1071098ee24f2764946c72065b3e422eddc47666</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>notifyproxy: don't set a read deadline The read deadline may yield the READY message to be lost in space. Instead, use a more Go-idiomatic alternative by using two goroutines; one reading from the connection, the other watching the container. [NO NEW TESTS NEEDED] since existing tests are exercising this functionality already. Fixes: #15800 Signed-off-by: Valentin Rothberg &lt;vrothberg@redhat.com&gt;</MESSAGE>
      <SHA>4a053a821aab8891498cb5dd3f01ce3437fdf0ef</SHA>
      <PATCHEDFILES>
        <FILE>pkg/systemd/notifyproxy/notifyproxy.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
