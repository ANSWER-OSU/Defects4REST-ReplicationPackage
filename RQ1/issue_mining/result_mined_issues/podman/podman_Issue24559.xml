<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24559</ISSUENO>
  <ISSUEURL>https://github.com/containers/podman/issues/24559</ISSUEURL>
  <TITLE>unable to create/run a podman machine using libkrun provider with podman 5.3.0</TITLE>
  <DESCRIPTION>### Issue Description Creating/starting a podman machine using libkrun on macOS I have the following error `Error: krunkit exited unexpectedly with exit code 1` ### Steps to reproduce the issue Steps to reproduce the issue download and install podman 5.3.0 from the releases page on macOS (sequoia 15.1) 1. CONTAINERS_MACHINE_PROVIDER=libkrun podman machine init --now my-machine ``` Looking up Podman Machine image at quay.io/podman/machine-os:5.3 to create VM Extracting compressed file: my-machine-arm64.raw: done Machine init complete Starting machine &quot;my-machine&quot; Error: krunkit exited unexpectedly with exit code 1 ``` ### Describe the results you received Error: krunkit exited unexpectedly with exit code 1 ### Describe the results you expected machine starts ### podman info output ```yaml podman info OS: darwin/arm64 provider: libkrun version: 5.3.0 Cannot connect to Podman. Please verify your connection to the Linux system using `podman system connection list`, or try `podman machine init` and `podman machine start` to manage a new Linux VM Error: unable to connect to Podman socket: failed to connect: dial tcp 127.0.0.1:63626: connect: connection refused ``` ### Podman in a container No ### Privileged Or Rootless None ### Upstream Latest Release Yes ### Additional environment details Additional environment details ### Additional information Tried with --log-leve=DEBUG and got this terminal window (and the command is hanging) ![Image](https://github.com/user-attachments/assets/05a7e4c1-78ba-48bd-af21-a6f105a4e434) ``` CONTAINERS_MACHINE_PROVIDER=libkrun podman machine --log-level=DEBUG init --now my-machine3 INFO[0000] podman filtering at log level debug DEBU[0000] Using Podman machine with `libkrun` virtualization provider DEBU[0000] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun is 56 DEBU[0000] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun is 61 DEBU[0000] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun/cache is 67 DEBU[0000] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman is 55 DEBU[0000] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/krun.json is 66 DEBU[0000] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/krun2.json is 67 DEBU[0000] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/krun3.json is 67 DEBU[0000] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine.json is 72 DEBU[0000] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine2.json is 73 DEBU[0000] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun is 56 DEBU[0000] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun is 61 DEBU[0000] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun/cache is 67 DEBU[0000] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman is 55 DEBU[0000] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.json is 73 DEBU[0000] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun/my-machine3-arm64.raw is 83 Looking up Podman Machine image at quay.io/podman/machine-os:5.3 to create VM DEBU[0000] Using registries.d directory /etc/containers/registries.d DEBU[0000] Loading registries configuration &quot;/etc/containers/registries.conf&quot; DEBU[0000] Trying to access &quot;quay.io/podman/machine-os:5.3&quot; DEBU[0000] Found credentials for quay.io/podman/machine-os in credential helper containers-auth.json in file /Users/benoitf/.config/containers/auth.json DEBU[0000] No signature storage configuration found for quay.io/podman/machine-os:5.3, using built-in default file:///Users/benoitf/.local/share/containers/sigstore DEBU[0000] Looking for TLS certificates and private keys in /etc/docker/certs.d/quay.io DEBU[0000] GET https://quay.io/v2/ DEBU[0000] Ping https://quay.io/v2/ status 401 DEBU[0000] GET https://quay.io/v2/auth?account=fbenoit&amp;scope=repository%3Apodman%2Fmachine-os%3Apull&amp;service=quay.io DEBU[0001] Increasing token expiration to: 60 seconds DEBU[0001] GET https://quay.io/v2/podman/machine-os/manifests/5.3 DEBU[0001] Content-Type from manifest GET is &quot;application/vnd.oci.image.index.v1+json&quot; DEBU[0001] found image in digest: &quot;sha256:414a851157f853ca4fc6bf6755f1acffea33a59e1cbf86116e5c0c61e2eb38e7&quot; DEBU[0001] GET https://quay.io/v2/podman/machine-os/manifests/sha256:414a851157f853ca4fc6bf6755f1acffea33a59e1cbf86116e5c0c61e2eb38e7 DEBU[0004] Content-Type from manifest GET is &quot;application/vnd.oci.image.manifest.v1+json&quot; DEBU[0004] original artifact file name: podman-machine.aarch64.applehv.raw.zst DEBU[0004] GET https://quay.io/v2/podman/machine-os/manifests/sha256:414a851157f853ca4fc6bf6755f1acffea33a59e1cbf86116e5c0c61e2eb38e7 DEBU[0004] Content-Type from manifest GET is &quot;application/vnd.oci.image.manifest.v1+json&quot; DEBU[0004] original artifact file name: podman-machine.aarch64.applehv.raw.zst DEBU[0004] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun/cache/414a851157f853ca4fc6bf6755f1acffea33a59e1cbf86116e5c0c61e2eb38e7.raw.zst is 140 DEBU[0004] cached image exists and is latest: /Users/benoitf/.local/share/containers/podman/machine/libkrun/cache/414a851157f853ca4fc6bf6755f1acffea33a59e1cbf86116e5c0c61e2eb38e7.raw.zst DEBU[0004] Detected compression format zstd Extracting compressed file: my-machine3-arm64.raw: done DEBU[0012] --&gt; imagePath is &quot;/Users/benoitf/.local/share/containers/podman/machine/libkrun/my-machine3-arm64.raw&quot; DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.ign is 72 DEBU[0012] resizing /Users/benoitf/.local/share/containers/podman/machine/libkrun/my-machine3-arm64.raw to 107374182400 bytes DEBU[0012] writing ignition file to &quot;/Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.ign&quot; DEBU[0012] writing configuration file &quot;/Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.json&quot; Machine init complete DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun is 56 DEBU[0012] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun is 61 DEBU[0012] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun/cache is 67 DEBU[0012] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman is 55 DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.json is 73 Starting machine &quot;my-machine3&quot; DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun is 56 DEBU[0012] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun is 61 DEBU[0012] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun/cache is 67 DEBU[0012] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman is 55 DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/krun.json is 66 DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/krun2.json is 67 DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/krun3.json is 67 DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine.json is 72 DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine2.json is 73 DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.json is 73 DEBU[0012] connection refused: http://localhost:63860/vm/state DEBU[0012] connection refused: http://localhost:64052/vm/state DEBU[0012] connection refused: http://localhost:64269/vm/state DEBU[0012] connection refused: http://localhost:49277/vm/state DEBU[0012] connection refused: http://localhost:65067/vm/state DEBU[0012] connection refused: http://localhost:49345/vm/state DEBU[0012] writing configuration file &quot;/Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.json&quot; DEBU[0012] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/gvproxy.pid is 67 DEBU[0012] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun is 56 DEBU[0012] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun is 61 DEBU[0012] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun/cache is 67 DEBU[0012] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman is 55 DEBU[0012] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3-api.sock is 76 DEBU[0012] socket length for /Users/benoitf/.local/share/containers/podman/machine/podman.sock is 65 DEBU[0012] {true 1500 map[forward-dest:[/run/user/501/podman/podman.sock] forward-identity:[/Users/benoitf/.local/share/containers/podman/machine/machine] forward-sock:[/var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3-api.sock] forward-user:[core]] [] map[] /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/gvproxy.log /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/gvproxy.pid 49327} DEBU[0012] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3-gvproxy.sock is 80 DEBU[0012] gvproxy command-line: /opt/podman/bin/gvproxy -debug -mtu 1500 -ssh-port 49327 -listen-vfkit unixgram:///var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3-gvproxy.sock -forward-user core -forward-identity /Users/benoitf/.local/share/containers/podman/machine/machine -forward-sock /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3-api.sock -forward-dest /run/user/501/podman/podman.sock -pid-file /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/gvproxy.pid -log-file /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/gvproxy.log DEBU[0012] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3-gvproxy.sock is 80 DEBU[0012] checking that &quot;gvproxy&quot; socket is ready DEBU[0013] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3.log is 71 DEBU[0013] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3.sock is 72 DEBU[0013] helper binary path is: /opt/podman/bin/krunkit DEBU[0013] socket length for /Users/benoitf/.local/share/containers/podman/machine/libkrun/my-machine3-ignition.sock is 87 DEBU[0013] first boot detected DEBU[0013] serving ignition file over /Users/benoitf/.local/share/containers/podman/machine/libkrun/my-machine3-ignition.sock DEBU[0013] listening for ready on: /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3.sock DEBU[0013] socket length for /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.ign is 72 DEBU[0013] reading ignition file: /Users/benoitf/.config/containers/podman/machine/libkrun/my-machine3.ign DEBU[0013] waiting for ready notification DEBU[0013] helper command-line: [/opt/podman/bin/krunkit --cpus 6 --memory 2048 --bootloader efi,variable-store=/Users/benoitf/.local/share/containers/podman/machine/libkrun/efi-bl-my-machine3,create --device virtio-blk,path=/Users/benoitf/.local/share/containers/podman/machine/libkrun/my-machine3-arm64.raw --device virtio-rng --device virtio-vsock,port=1025,socketURL=/var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3.sock,listen --device virtio-net,unixSocketPath=/var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/my-machine3-gvproxy.sock,mac=5a:94:ef:e4:0c:ee --device virtio-fs,sharedDir=/Users,mountTag=a2a0ee2c717462feb1de2f5afd59de5fd2d8 --device virtio-fs,sharedDir=/private,mountTag=71708eb255bc230cd7c91dd26f7667a7b938 --device virtio-fs,sharedDir=/var/folders,mountTag=a0bb3a2c8b0b02ba5958b0576f0d6530e104 --restful-uri tcp://localhost:49345 --device virtio-gpu,width=800,height=600 --device virtio-input,pointing --device virtio-input,keyboard --gui --device virtio-vsock,port=1024,socketURL=/Users/benoitf/.local/share/containers/podman/machine/libkrun/my-machine3-ignition.sock,listen] DEBU[0013] socket length for /var/folders/_s/rlbw3qg15vx0j6vr4l7kd1hm0000gn/T/podman/krunkit-debug.sh is 72 DEBU[0013] ignition socket device: /Users/benoitf/.local/share/containers/podman/machine/libkrun/my-machine3-ignition.sock ``` If I switch to podman v5.2.5 I'm able to create and start podman machines</DESCRIPTION>
  <REPONAME>podman</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #24321 from gaufde/main Fix for podman machine init not creating necessary JSON file when an ignition-path is passed</MESSAGE>
    <SHA>5dbb567db62d1958c8914c338e6fe214212e0ac9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Bump bundled krunkit to 0.1.4 Bump the bundled krunkit version from 0.1.3 to 0.1.4. Fixes: #24559 Signed-off-by: Sergio Lopez &lt;slp@redhat.com&gt;</MESSAGE>
      <SHA>7b41e28b95c9cb5c2f6882fb00dc360dc4710e92</SHA>
      <PATCHEDFILES>
        <FILE>contrib/pkginstaller/Makefile</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
