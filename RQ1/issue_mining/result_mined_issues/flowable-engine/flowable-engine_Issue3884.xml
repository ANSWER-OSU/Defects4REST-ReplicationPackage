<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3884</ISSUENO>
  <ISSUEURL>https://github.com/flowable/flowable-engine/issues/3884</ISSUEURL>
  <TITLE>Conditions should support more than JUEL expressions</TITLE>
  <DESCRIPTION>**Is your feature request related to a problem? Please describe.** Conditions (and other places with `FormalExpressions`) currenly ignores the `language` attribute and always assumes that the content is JUEL. Some conditions are hard or impossible to write in JUEL (i.e. &quot;is the country of one of the addresses in the US?&quot;), so it would be great to be able to use i.e. Groovy instead. **Describe the solution you'd like** `SequenceFlow`s (and `BoundaryEvents` etc.) should parse the `language` attribute of the `bpmn:condition`. `ExpressionManager.createExpression()` should use the language to load the `ScriptEngine` using `javax.script.ScriptEngineManager`, probably only accepting languages from a configurable whitelist. It looks like a fairly straightforward task, and I will be happy to supply a PR, if I can get an indication that it is likely to be merged.</DESCRIPTION>
  <REPONAME>flowable-engine</REPONAME>
  <TIMEDIFFERENCEDAYS>149</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update H2 version</MESSAGE>
    <SHA>3f8058b47c5b36eb45d01f812f02580735a974a4</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#3884 Expression language support for conditional sequence flow and conditional events</MESSAGE>
      <SHA>5da58be448e21802089b6082f23f5295ee0d3b8e</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-bpmn-converter/src/main/java/org/flowable/bpmn/converter/BaseBpmnXMLConverter.java</FILE>
        <FILE>modules/flowable-bpmn-converter/src/main/java/org/flowable/bpmn/converter/SequenceFlowXMLConverter.java</FILE>
        <FILE>modules/flowable-bpmn-converter/src/main/java/org/flowable/bpmn/converter/child/ConditionExpressionParser.java</FILE>
        <FILE>modules/flowable-bpmn-converter/src/main/java/org/flowable/bpmn/converter/child/ConditionParser.java</FILE>
        <FILE>modules/flowable-bpmn-model/src/main/java/org/flowable/bpmn/model/ConditionalEventDefinition.java</FILE>
        <FILE>modules/flowable-bpmn-model/src/main/java/org/flowable/bpmn/model/SequenceFlow.java</FILE>
        <FILE>modules/flowable-engine-common/src/main/java/org/flowable/common/engine/impl/el/DefaultExpressionManager.java</FILE>
        <FILE>modules/flowable-engine-common/src/main/java/org/flowable/common/engine/impl/el/ExpressionManager.java</FILE>
        <FILE>modules/flowable-engine-common/src/main/java/org/flowable/common/engine/impl/el/ScriptEngineExpression.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/delegate/event/FlowableConditionalEvent.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/delegate/event/impl/FlowableConditionalEventImpl.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/delegate/event/impl/FlowableEventBuilder.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/agenda/EvaluateConditionalEventsOperation.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/behavior/BoundaryConditionalEventActivityBehavior.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/behavior/IntermediateCatchConditionalEventActivityBehavior.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/parser/factory/ActivityBehaviorFactory.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/parser/factory/DefaultActivityBehaviorFactory.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/parser/handler/ConditionalEventDefinitionParseHandler.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/util/condition/ConditionUtil.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/test/TestActivityBehaviorFactory.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/bpmn/event/conditional/BoundaryConditionalEventTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/bpmn/event/conditional/ConditionalEventSubprocessTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/bpmn/sequenceflow/ConditionalSequenceFlowTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/engine/test/bpmn/event/conditional/BoundaryConditionalEventTest.testGroovyCondition.bpmn20.xml</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/engine/test/bpmn/event/conditional/ConditionalEventSubprocessTest.testGroovyCondition.bpmn20.xml</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/engine/test/bpmn/sequenceflow/ConditionalSequenceFlowTest.testGroovyExpression.bpmn20.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3884: Use ScriptCondition instead of ScriptEngineExpression</MESSAGE>
      <SHA>2bb710a8261f0a2c1f727846e0a3d907b126e8b6</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine-common/src/main/java/org/flowable/common/engine/impl/el/DefaultExpressionManager.java</FILE>
        <FILE>modules/flowable-engine-common/src/main/java/org/flowable/common/engine/impl/el/ExpressionManager.java</FILE>
        <FILE>modules/flowable-engine-common/src/main/java/org/flowable/common/engine/impl/el/ScriptEngineExpression.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/agenda/EvaluateConditionalEventsOperation.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/behavior/BoundaryConditionalEventActivityBehavior.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/scripting/ScriptCondition.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/util/condition/ConditionUtil.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3884: Move logic to ConditionUtil and leave ScriptCondition unchanged</MESSAGE>
      <SHA>9056c43180104928e4ed8755ffd52d2ef279012a</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/agenda/EvaluateConditionalEventsOperation.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/behavior/BoundaryConditionalEventActivityBehavior.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/scripting/ScriptCondition.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/util/condition/ConditionUtil.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3884: Rename sequenceFlowId to elementId. Revert whitespace-only changes.</MESSAGE>
      <SHA>e6cfdf85676cebe33af39f1bde60cc021985264a</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine-common/src/main/java/org/flowable/common/engine/impl/el/DefaultExpressionManager.java</FILE>
        <FILE>modules/flowable-engine-common/src/main/java/org/flowable/common/engine/impl/el/ExpressionManager.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/Condition.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/el/UelExpressionCondition.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/scripting/ScriptCondition.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/util/condition/ConditionUtil.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3884: Pass the id of the event definition instead of the activity</MESSAGE>
      <SHA>d201b7561e27678f83e3c9b7165c478855c2d8c3</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/behavior/BoundaryConditionalEventActivityBehavior.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3884 Expression language support for conditional sequence flow and conditional events (#3889) * #3884 Expression language support for conditional sequence flow and conditional events * #3884: Use ScriptCondition instead of ScriptEngineExpression * #3884: Move logic to ConditionUtil and leave ScriptCondition unchanged * #3884: Rename sequenceFlowId to elementId. Revert whitespace-only changes. * #3884: Pass the id of the event definition instead of the activity</MESSAGE>
      <SHA>d1a8c913a0f1f52336526073d161d67abe2177a0</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-bpmn-converter/src/main/java/org/flowable/bpmn/converter/BaseBpmnXMLConverter.java</FILE>
        <FILE>modules/flowable-bpmn-converter/src/main/java/org/flowable/bpmn/converter/SequenceFlowXMLConverter.java</FILE>
        <FILE>modules/flowable-bpmn-converter/src/main/java/org/flowable/bpmn/converter/child/ConditionExpressionParser.java</FILE>
        <FILE>modules/flowable-bpmn-converter/src/main/java/org/flowable/bpmn/converter/child/ConditionParser.java</FILE>
        <FILE>modules/flowable-bpmn-model/src/main/java/org/flowable/bpmn/model/ConditionalEventDefinition.java</FILE>
        <FILE>modules/flowable-bpmn-model/src/main/java/org/flowable/bpmn/model/SequenceFlow.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/delegate/event/FlowableConditionalEvent.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/delegate/event/impl/FlowableConditionalEventImpl.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/delegate/event/impl/FlowableEventBuilder.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/Condition.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/agenda/EvaluateConditionalEventsOperation.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/behavior/BoundaryConditionalEventActivityBehavior.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/behavior/IntermediateCatchConditionalEventActivityBehavior.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/parser/factory/ActivityBehaviorFactory.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/parser/factory/DefaultActivityBehaviorFactory.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/bpmn/parser/handler/ConditionalEventDefinitionParseHandler.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/el/UelExpressionCondition.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/scripting/ScriptCondition.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/impl/util/condition/ConditionUtil.java</FILE>
        <FILE>modules/flowable-engine/src/main/java/org/flowable/engine/test/TestActivityBehaviorFactory.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/bpmn/event/conditional/BoundaryConditionalEventTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/bpmn/event/conditional/ConditionalEventSubprocessTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/bpmn/sequenceflow/ConditionalSequenceFlowTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/engine/test/bpmn/event/conditional/BoundaryConditionalEventTest.testGroovyCondition.bpmn20.xml</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/engine/test/bpmn/event/conditional/ConditionalEventSubprocessTest.testGroovyCondition.bpmn20.xml</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/engine/test/bpmn/sequenceflow/ConditionalSequenceFlowTest.testGroovyExpression.bpmn20.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
