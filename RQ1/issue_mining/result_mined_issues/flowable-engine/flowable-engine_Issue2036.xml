<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2036</ISSUENO>
  <ISSUEURL>https://github.com/flowable/flowable-engine/issues/2036</ISSUEURL>
  <TITLE>addMultiInstanceExecution did not work as expect</TITLE>
  <DESCRIPTION>**Describe the bug** I used the following code to add a new assignee to a MultiInstance task, ```java runtimeService.addMultiInstanceExecution(&quot;miTasks&quot;, procId, CollectionUtil.singletonMap(&quot;taskUser&quot;, &quot;hr&quot;)); ``` and then complete the task of the first person, it will throw the following exception: ``` org.flowable.common.engine.api.FlowableException: Could not execute inner activity behavior of multi instance behavior at org.flowable.engine.impl.bpmn.behavior.SequentialMultiInstanceBehavior.continueSequentialMultiInstance(SequentialMultiInstanceBehavior.java:118) at org.flowable.engine.impl.bpmn.behavior.SequentialMultiInstanceBehavior.leave(SequentialMultiInstanceBehavior.java:95) at org.flowable.engine.impl.bpmn.behavior.AbstractBpmnActivityBehavior.leave(AbstractBpmnActivityBehavior.java:56) at org.flowable.engine.impl.bpmn.behavior.UserTaskActivityBehavior.trigger(UserTaskActivityBehavior.java:264) at org.flowable.engine.impl.bpmn.behavior.MultiInstanceActivityBehavior.trigger(MultiInstanceActivityBehavior.java:208) at org.flowable.engine.impl.agenda.TriggerExecutionOperation.run(TriggerExecutionOperation.java:65) at org.flowable.engine.impl.interceptor.CommandInvoker.executeOperation(CommandInvoker.java:88) at org.flowable.engine.impl.interceptor.CommandInvoker.executeOperations(CommandInvoker.java:72) at org.flowable.engine.impl.interceptor.CommandInvoker.execute(CommandInvoker.java:56) at org.flowable.engine.impl.interceptor.BpmnOverrideContextInterceptor.execute(BpmnOverrideContextInterceptor.java:25) at org.flowable.common.engine.impl.interceptor.TransactionContextInterceptor.execute(TransactionContextInterceptor.java:53) at org.flowable.common.engine.impl.interceptor.CommandContextInterceptor.execute(CommandContextInterceptor.java:72) at org.flowable.common.engine.impl.interceptor.LogInterceptor.execute(LogInterceptor.java:35) at org.flowable.common.engine.impl.cfg.CommandExecutorImpl.execute(CommandExecutorImpl.java:56) at org.flowable.common.engine.impl.cfg.CommandExecutorImpl.execute(CommandExecutorImpl.java:51) at org.flowable.engine.impl.TaskServiceImpl.complete(TaskServiceImpl.java:208) at org.flowable.engine.test.bpmn.multiinstance.DynamicMultiInstanceTest.testAddSequentialUserTaskWithCollection(DynamicMultiInstanceTest.java:53) at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:675) at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60) at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:125) at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:132) at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:124) at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:74) at org.junit.jupiter.engine.execution.ExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(ExecutableInvoker.java:115) at org.junit.jupiter.engine.execution.ExecutableInvoker.lambda$invoke$0(ExecutableInvoker.java:105) at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:104) at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:62) at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:43) at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:35) at org.junit.jupiter.engine.execution.ExecutableInvoker.invoke(ExecutableInvoker.java:104) at org.junit.jupiter.engine.execution.ExecutableInvoker.invoke(ExecutableInvoker.java:98) at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$6(TestMethodTestDescriptor.java:202) at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73) at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:198) at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:135) at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:135) at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125) at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123) at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73) at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122) at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80) at java.util.ArrayList.forEach(ArrayList.java:1257) at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:139) at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125) at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123) at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73) at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122) at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80) at java.util.ArrayList.forEach(ArrayList.java:1257) at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:139) at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125) at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135) at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123) at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73) at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122) at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80) at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:32) at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57) at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:51) at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:229) at org.junit.platform.launcher.core.DefaultLauncher.lambda$execute$6(DefaultLauncher.java:197) at org.junit.platform.launcher.core.DefaultLauncher.withInterceptedStreams(DefaultLauncher.java:211) at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:191) at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:128) at com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:69) at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47) at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242) at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70) Caused by: java.util.NoSuchElementException at java.util.Collections$1.next(Collections.java:4683) at org.flowable.engine.impl.bpmn.behavior.MultiInstanceActivityBehavior.executeOriginalBehavior(MultiInstanceActivityBehavior.java:316) at org.flowable.engine.impl.bpmn.behavior.SequentialMultiInstanceBehavior.continueSequentialMultiInstance(SequentialMultiInstanceBehavior.java:110) ... 79 more ``` **Expected behavior** I think it should add the new assignee to the child execution. **Code** Following is the test case I added to flowable-engine\modules\flowable-engine\src\test\java\org\flowable\engine\test\bpmn\multiinstance\DynamicMultiInstanceTest.java for the problem. ```xml &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;definitions id=&quot;definition&quot; xmlns=&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:activiti=&quot;http://activiti.org/bpmn&quot; targetNamespace=&quot;Examples&quot;&gt; &lt;process id=&quot;miSequentialUserTasks&quot;&gt; &lt;startEvent id=&quot;theStart&quot; /&gt; &lt;sequenceFlow id=&quot;flow1&quot; sourceRef=&quot;theStart&quot; targetRef=&quot;miTasks&quot; /&gt; &lt;userTask id=&quot;miTasks&quot; name=&quot;My Task&quot; activiti:assignee=&quot;${taskUser}&quot;&gt; &lt;multiInstanceLoopCharacteristics isSequential=&quot;true&quot;&gt; &lt;loopDataInputRef&gt;taskUserList&lt;/loopDataInputRef&gt; &lt;inputDataItem name=&quot;taskUser&quot; /&gt; &lt;/multiInstanceLoopCharacteristics&gt; &lt;/userTask&gt; &lt;boundaryEvent id=&quot;timer&quot; attachedToRef=&quot;miTasks&quot;&gt; &lt;timerEventDefinition&gt; &lt;timeDuration&gt;PT2H&lt;/timeDuration&gt; &lt;/timerEventDefinition&gt; &lt;/boundaryEvent&gt; &lt;sequenceFlow id=&quot;flow3&quot; sourceRef=&quot;timer&quot; targetRef=&quot;taskAfterTimer&quot; /&gt; &lt;userTask id=&quot;taskAfterTimer&quot; /&gt; &lt;sequenceFlow id=&quot;flow4&quot; sourceRef=&quot;miTasks&quot; targetRef=&quot;theEnd&quot; /&gt; &lt;endEvent id=&quot;theEnd&quot; /&gt; &lt;/process&gt; &lt;/definitions&gt; ``` ```java @Test @Deployment(resources = { &quot;org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.sequentialUserTasksWithCollection.bpmn20.xml&quot; }) public void testAddSequentialUserTaskWithCollection() { if (!processEngineConfiguration.isAsyncHistoryEnabled()) { String procId = runtimeService.startProcessInstanceByKey(&quot;miSequentialUserTasks&quot;, CollectionUtil.singletonMap(&quot;taskUserList&quot;, Collections.singletonList(&quot;admin&quot;))).getId(); org.flowable.task.api.Task task = taskService.createTaskQuery().singleResult(); assertEquals(&quot;My Task&quot;, task.getName()); assertEquals(&quot;admin&quot;, task.getAssignee()); runtimeService.addMultiInstanceExecution(&quot;miTasks&quot;, procId, CollectionUtil.singletonMap(&quot;taskUser&quot;, &quot;hr&quot;)); taskService.complete(task.getId()); task = taskService.createTaskQuery().singleResult(); assertEquals(&quot;My Task&quot;, task.getName()); assertEquals(&quot;hr&quot;, task.getAssignee()); taskService.complete(task.getId()); assertNull(taskService.createTaskQuery().singleResult()); assertProcessEnded(procId); } } ``` Thanks.</DESCRIPTION>
  <REPONAME>flowable-engine</REPONAME>
  <TIMEDIFFERENCEDAYS>52</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge with master</MESSAGE>
    <SHA>6d9befdf8f2ce7c136e8784f3d3a39ec8c243fd9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Implement unit test for #2036</MESSAGE>
      <SHA>a3d926ddc984eede5bd74b6d337451848c494c76</SHA>
      <PATCHEDFILES>
        <FILE>modules/flowable-engine/src/test/java/org/flowable/engine/test/bpmn/multiinstance/DynamicMultiInstanceTest.java</FILE>
        <FILE>modules/flowable-engine/src/test/resources/org/flowable/engine/test/bpmn/multiinstance/MultiInstanceTest.sequentialUserTasksWithCollection.bpmn20.xml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
