<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14981</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/14981</ISSUEURL>
  <TITLE>Empty sitemap if a taxonomy is removed</TITLE>
  <DESCRIPTION>### Issue Summary By deleting a taxonomy from the `routes.yml` file, the deleted taxonomies pages are not generated, but their respective sitemap are. They are empty, but some tools like Google Search Console warn users that their sitemap is wrong because it's empty. Example of my [website](https://www.benjaminrancourt.ca/sitemap.xml), where I've disabled the `authors` taxonomy. ```html &lt;tr&gt; &lt;td&gt; &lt;a href=&quot;https://www.benjaminrancourt.ca/sitemap-authors.xml&quot;&gt; https://www.benjaminrancourt.ca/sitemap-authors.xml &lt;/a&gt; &lt;/td&gt; &lt;td&gt;1970-01-01 00:00&lt;/td&gt; &lt;/tr&gt; ``` ![image](https://user-images.githubusercontent.com/7907713/174452395-01298c43-b958-4844-9d08-e4daeb9bff8e.png) &gt; The sitemap can be read, but it contains errors | Empty sitemap ![image](https://user-images.githubusercontent.com/7907713/174452417-ff20bcd4-ea8a-41cd-8fa3-3c7af6fcca02.png) -------------- I tried to find a way to fix this in Ghost source code, but I couldn't run a working setup on my machine (I really should install Linux... ). However, I'll paste my notes I've took while looking into this bug, in the hope that it will at least help you. **core/frontend/services/sitemap/manager.js** ```js // [Ben] The index sitemap is generated here getIndexXml() { return this.index.getXml(); } createIndexGenerator(options) { // [Ben] Solution 1: If some taxonomies are disabled, can we remove them from the options below? return new IndexMapGenerator({ types: { pages: this.pages, posts: this.posts, authors: this.authors, tags: this.tags }, maxPerPage: options.maxPerPage }); } ``` core/frontend/services/sitemap/index-generator.js ```js generateSiteMapUrlElements() { // [Ben] We iterate over each resource type here return _.map(this.types, (resourceType) =&gt; { // `|| 1` = even if there are no items we still have an empty sitemap file const noOfPages = Math.ceil(Object.keys(resourceType.nodeLookup).length / this.maxPerPage) || 1; const pages = []; for (let i = 0; i &lt; noOfPages; i++) { const page = i === 0 ? '' : `-${i + 1}`; const url = urlUtils.urlFor({relativeUrl: '/sitemap-' + resourceType.name + page + '.xml'}, true); const lastModified = resourceType.lastModified; // [Ben] Solution 2: For disabled taxonomies, I suspect their lastModified property is undefined. // Therefore, maybe we could not push this resource sitemap if it's the case? pages.push({ sitemap: [ {loc: url}, {lastmod: moment(lastModified).toISOString()} ] }); } return pages; }).flat(); } ``` Thanks to the Ghost team! ### Steps to Reproduce 1. Disable a taxonomy like `tags` or `authors` (https://ghost.org/docs/themes/routing/#removing-taxonomies) 2. Go to `/sitemap.xml` 3. The disabled taxonomies will have an empty sitemap with a `Last Modified` date of `1970-01-01 00:00` ### Ghost Version 5.2.3 ### Node.js Version v16.15.0 ### How did you install Ghost? Docker ### Database type MySQL 8 ### Browser &amp; OS version Google Chrome | Windows 10 ### Relevant log / error output _No response_ ### Code of Conduct - [X] I agree to be friendly and polite to people in this repository</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>115</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Updated ValidationEngine to support bare native class models (#15567) no issue - if a plain native class instance with tracked properties is validated against the `ValidationEngine` and it's associated validators would cause errors by assuming that the instance has a `.get()` method - updated all model access in `ValidationEngine` and the validators to use direct property access which works for both native class and `EmberObject` instances</MESSAGE>
    <SHA>786e0ac9c563eb5655c2ae5292cf8b108e6692a0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>:bug: Removed sitemaps with no content Closes #14981 - Taxonomy-specific sitemaps were invalid xml when there was no data - These invalid empty sitemaps were referenced in the index sitemap causing SEO tools to report errors</MESSAGE>
      <SHA>f5635641216b087246aefc0ef377bfafd6f188b7</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/services/sitemap/handler.js</FILE>
        <FILE>ghost/core/core/frontend/services/sitemap/index-generator.js</FILE>
        <FILE>ghost/core/test/e2e-frontend/custom_routes.test.js</FILE>
        <FILE>ghost/core/test/unit/frontend/services/sitemap/generator.test.js</FILE>
        <FILE>ghost/core/test/utils/fixtures/settings/newroutes.yaml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed sitemaps with no content (#15571) closes: https://github.com/TryGhost/Ghost/issues/14981 - Taxonomy-specific sitemaps were invalid xml when there was no data - These invalid empty sitemaps were referenced in the index sitemap causing SEO tools to report errors</MESSAGE>
      <SHA>3d44e37cbddbdb1345d641291105e8b1b666c36b</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/services/sitemap/handler.js</FILE>
        <FILE>ghost/core/core/frontend/services/sitemap/index-generator.js</FILE>
        <FILE>ghost/core/test/e2e-frontend/custom_routes.test.js</FILE>
        <FILE>ghost/core/test/unit/frontend/services/sitemap/generator.test.js</FILE>
        <FILE>ghost/core/test/utils/fixtures/settings/newroutes.yaml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed sitemaps with no content (#15571) closes: https://github.com/TryGhost/Ghost/issues/14981 - Taxonomy-specific sitemaps were invalid xml when there was no data - These invalid empty sitemaps were referenced in the index sitemap causing SEO tools to report errors</MESSAGE>
      <SHA>f98cb86f2838c37a80aa249cc8cc390749e7406c</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/services/sitemap/handler.js</FILE>
        <FILE>ghost/core/core/frontend/services/sitemap/index-generator.js</FILE>
        <FILE>ghost/core/test/e2e-frontend/custom_routes.test.js</FILE>
        <FILE>ghost/core/test/unit/frontend/services/sitemap/generator.test.js</FILE>
        <FILE>ghost/core/test/utils/fixtures/settings/newroutes.yaml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed sitemaps with no content (#15571) closes: https://github.com/TryGhost/Ghost/issues/14981 - Taxonomy-specific sitemaps were invalid xml when there was no data - These invalid empty sitemaps were referenced in the index sitemap causing SEO tools to report errors</MESSAGE>
      <SHA>2d79d4cbd5b665a062d4b2dad2362413aaa17f2a</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/frontend/services/sitemap/handler.js</FILE>
        <FILE>ghost/core/core/frontend/services/sitemap/index-generator.js</FILE>
        <FILE>ghost/core/test/e2e-frontend/custom_routes.test.js</FILE>
        <FILE>ghost/core/test/unit/frontend/services/sitemap/generator.test.js</FILE>
        <FILE>ghost/core/test/utils/fixtures/settings/newroutes.yaml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
