<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>19839</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/19839</ISSUEURL>
  <TITLE>Error updating to Ghost 5.80 from 5.23, blog down, please help</TITLE>
  <DESCRIPTION>### Issue Summary Hello, I just updated my Ghost blog from 5.23 to 5.80. After the update, I tried to restart Ghost, but it fails with this message: Ghost instance is not running! Starting... ✖ Starting Ghost A GhostError occurred. ``` Message: Ghost was able to start, but errored during boot with: insert into `collections_posts` (`collection_id`, `id`, `post_id`, `sort_order`) select '65f02f0dafb7eeb96c4c90a6' as `collection_id`, '65f02f0dafb7eeb96c4c90a8' as `id`, '637a812a81cfb759fad27265' as `post_id`, 0 as `sort_order` union all select '65f02f0dafb7eeb96c4c90a6' as `collection_id`, ... (many more rows) ... , '65314decb0c970c6a6eca545' as `post_id`, 0 as `sort_order` - SQLITE_ERROR: too many terms in compound SELECT Context: [object Object] Help: Error occurred while executing the following migration: 2023-07-10-05-16-55-add-built-in-collection-posts.js ``` Debug Information: OS: Debian GNU/Linux, v11 Node Version: v18.19.1 Ghost Version: 5.80.2 Ghost-CLI Version: 1.25.3 Environment: development Command: 'ghost restart' mysql Ver 8.0.27 for Linux on x86_64 (MySQL Community Server - GPL) ### Steps to Reproduce Start with an install of v5.23 or below 5.80 Apparently the number of posts can be a cause, so get more than 500 posts. Run ghost update and ghost restart ### Ghost Version 5.80.2 ### Node.js Version v18.19.1 ### How did you install Ghost? Command line ### Database type MySQL 5.7 ### Browser &amp; OS version Chrome, MacOS ### Relevant log / error output ```shell Ghost instance is not running! Starting... ✖ Starting Ghost A GhostError occurred. Message: Ghost was able to start, but errored during boot with: insert into `collections_posts` (`collection_id`, `id`, `post_id`, `sort_order`) select '65f03420dd3af6bb83e5ad3d' as `collection_id`, '65f03420dd3af6bb83e5ad3f' as `id`, '637a812a81cfb759fad27265' as `post_id`, 0 as `sort_order` union all select '65f03420dd3af6bb83e5ad3d' as `collection_id`, '65f03420dd3af6bb83e5ad40' as `id`, '637a812a81cfb759fad27266' as `post_id`, 0 as `sort_order` union all select '65f03420dd3af6bb83e5ad3d' as `collection_id`, '65f03420dd3af6bb83e5ad41' as `id`, '637a812a81cfb759fad27267' ... (rows ommited)... , '65f03420dd3af6bb83e5afe3' as `id`, '65314decb0c970c6a6eca545' as `post_id`, 0 as `sort_order` - SQLITE_ERROR: too many terms in compound SELECT Context: [object Object] Help: Error occurred while executing the following migration: 2023-07-10-05-16-55-add-built-in-collection-posts.js ``` ### Code of Conduct - [X] I agree to be friendly and polite to people in this repository</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>274</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fixed type errors for admin-x-activitypub We didn't catch these because ci type checks weren't running, but they are now!</MESSAGE>
    <SHA>2681e526f6c877a07e5ab45bb2a70e14d62c151f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixed migrations for SQLite database users (#19839) SQLite has limit of 500 items in a compound select statement. This limit could be hit when a complex SELECT statement was being generated as part of a batch insert statement. Lowering the batch size will have minimal impact on migration performance while improving SQLite compatibility. Ref: https://www.sqlite.org/limits.html Issue: #19839</MESSAGE>
      <SHA>db481b1f57348b180e40f87d899e5ffd56322ddd</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/data/migrations/versions/5.55/2023-07-10-05-16-55-add-built-in-collection-posts.js</FILE>
        <FILE>ghost/core/core/server/data/migrations/versions/5.65/2023-09-22-06-42-55-repopulate-built-in-featured-collection-posts.js</FILE>
        <FILE>ghost/core/core/server/data/migrations/versions/5.89/2024-07-30-19-51-06-backfill-offer-redemptions.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed migrations for SQLite database users (#19839) (#21063) refs https://github.com/TryGhost/Ghost/issues/19839 refs https://www.sqlite.org/limits.html SQLite has limit of 500 items in a compound select statement. This limit could be hit when a complex select statement was being generated as part of a batch insert statement. Lowering the batch size will have minimal impact on migration performance while improving SQLite compatibility. One of these bulk inserts is confirmed to be affected through the linked issue. I didn't confirm if the other two cases would trigger it, but the change won't hurt there either.</MESSAGE>
      <SHA>c8dcbbfbc5b91b647b58bff39f46b52ab78e6c63</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/data/migrations/versions/5.55/2023-07-10-05-16-55-add-built-in-collection-posts.js</FILE>
        <FILE>ghost/core/core/server/data/migrations/versions/5.65/2023-09-22-06-42-55-repopulate-built-in-featured-collection-posts.js</FILE>
        <FILE>ghost/core/core/server/data/migrations/versions/5.89/2024-07-30-19-51-06-backfill-offer-redemptions.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed migrations for SQLite database users (#19839) (#21063) refs https://github.com/TryGhost/Ghost/issues/19839 refs https://www.sqlite.org/limits.html SQLite has limit of 500 items in a compound select statement. This limit could be hit when a complex select statement was being generated as part of a batch insert statement. Lowering the batch size will have minimal impact on migration performance while improving SQLite compatibility. One of these bulk inserts is confirmed to be affected through the linked issue. I didn't confirm if the other two cases would trigger it, but the change won't hurt there either.</MESSAGE>
      <SHA>2d5230e6a22427cd75f4443b06c75cbf29fb5604</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/server/data/migrations/versions/5.55/2023-07-10-05-16-55-add-built-in-collection-posts.js</FILE>
        <FILE>ghost/core/core/server/data/migrations/versions/5.65/2023-09-22-06-42-55-repopulate-built-in-featured-collection-posts.js</FILE>
        <FILE>ghost/core/core/server/data/migrations/versions/5.89/2024-07-30-19-51-06-backfill-offer-redemptions.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
