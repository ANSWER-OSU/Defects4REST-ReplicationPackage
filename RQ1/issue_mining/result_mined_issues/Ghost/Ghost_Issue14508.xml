<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14508</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/14508</ISSUEURL>
  <TITLE>Impersonation tokens do signup action if no account is found</TITLE>
  <DESCRIPTION>### Issue Summary When a user is deleted it is expected that all tokens associated with that account are revoked. This is currently not the case. Creating a token before deleting a user creates the account again when pasted into the browser. ### Steps to Reproduce 1. Create an access token for an account. 2. Delete that account. 3. Paste that token into your browser. 4. User is created again. The user should NOT be created again and all tokens should be revoked when a user is deleted. ### Ghost Version 4.44.0 ### Node.js Version 16.14.2 ### How did you install Ghost? OS - Debian 11 with MariaDB 10.5.15 ### Database type MySQL 8 ### Browser &amp; OS version _No response_ ### Relevant log / error output _No response_ ### Code of Conduct - [X] I agree to be friendly and polite to people in this repository</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>169</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Removed `main` from `yarn ship` - we might not necessarily be pushing to `main`, for example, if we're doing a patch release</MESSAGE>
    <SHA>609fcb17c065182b5cf3a68a55f85a7276727b91</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Prevented member creation when logging in fixes https://github.com/TryGhost/Ghost/issues/14508 This change requires the frontend to send an explicit `emailType` when sending a magic link. We default to `subscribe` for now to remain compatible with the existing behaviour. **Problem:** When a member tries to login and that member doesn't exist, we created a new member in the past. - This caused the creation of duplicate accounts when members were guessing the email address they used. - This caused the creation of new accounts when using an old impersonation token or login link that was send before member deletion. **Fixed:** - Trying to login with an email address that doesn't exist will throw an error now. - Added new and separate rate limiting to login (to prevent user enumeration). This rate limiting has a higher default limit of 8. I think it needs a higher default limit (because it is rate limited on every call instead of per email address. And it should be configurable independent from administrator rate limiting. It also needs a lower lifetime value because it is never reset. - Updated error responses in the `sendMagicLink` endpoint to use the default error encoding middleware. - The type (`signin`, `signup` or `subscribe`) is now stored in the magic link. This is used to prevent signups with a sign in token. **Notes:** - Between tests, we truncate the database, but this is not enough for the rate limits to be truly reset. I had to add a method to the spam prevention service to reset all the instances between tests. Not resetting them caused random failures because every login in every test was hitting those spam prevention middlewares and somehow left a trace of that in those instances (even when the brute table is reset). Maybe those instances were doing some in memory caching.</MESSAGE>
      <SHA>3514d3833a8ca96d33ff8fe3c7b045753cd53bf4</SHA>
      <PATCHEDFILES>
        <FILE>errors.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/member-signin-urls.js</FILE>
        <FILE>ghost/core/core/server/services/members/middleware.js</FILE>
        <FILE>ghost/core/core/server/web/members/app.js</FILE>
        <FILE>ghost/core/core/server/web/shared/middleware/api/spam-prevention.js</FILE>
        <FILE>ghost/core/core/server/web/shared/middleware/brute.js</FILE>
        <FILE>ghost/core/core/shared/config/defaults.json</FILE>
        <FILE>ghost/core/test/e2e-api/members/__snapshots__/send-magic-link.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/members/send-magic-link.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/members/signin.test.js</FILE>
        <FILE>ghost/core/test/e2e-frontend/members.test.js</FILE>
        <FILE>ghost/core/test/utils/agents/members-api-test-agent.js</FILE>
        <FILE>ghost/core/test/utils/e2e-framework.js</FILE>
        <FILE>ghost/magic-link/lib/MagicLink.js</FILE>
        <FILE>ghost/members-api/lib/MembersAPI.js</FILE>
        <FILE>ghost/members-api/lib/controllers/router.js</FILE>
        <FILE>ghost/members-ssr/lib/MembersSSR.js</FILE>
        <FILE>ghost/portal/src/actions.js</FILE>
        <FILE>ghost/portal/src/components/pages/SigninPage.js</FILE>
        <FILE>ghost/portal/src/data-attributes.js</FILE>
        <FILE>ghost/portal/src/tests/SigninFlow.test.js</FILE>
        <FILE>ghost/portal/src/tests/SignupFlow.test.js</FILE>
        <FILE>ghost/portal/src/utils/api.js</FILE>
        <FILE>ghost/portal/src/utils/errors.js</FILE>
        <FILE>ghost/portal/src/utils/test-utils.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Prevented member creation when logging in (#15526) fixes https://github.com/TryGhost/Ghost/issues/14508 This change requires the frontend to send an explicit `emailType` when sending a magic link. We default to `subscribe` (`signin` for invite only sites) for now to remain compatible with the existing behaviour. **Problem:** When a member tries to login and that member doesn't exist, we created a new member in the past. - This caused the creation of duplicate accounts when members were guessing the email address they used. - This caused the creation of new accounts when using an old impersonation token, login link or email change link that was sent before member deletion. **Fixed:** - Trying to login with an email address that doesn't exist will throw an error now. - Added new and separate rate limiting to login (to prevent user enumeration). This rate limiting has a higher default limit of 8. I think it needs a higher default limit (because it is rate limited on every call instead of per email address. And it should be configurable independent from administrator rate limiting. It also needs a lower lifetime value because it is never reset. - Updated error responses in the `sendMagicLink` endpoint to use the default error encoding middleware. - The type (`signin`, `signup`, `updateEmail` or `subscribe`) is now stored in the magic link. This is used to prevent signups with a sign in token. **Notes:** - Between tests, we truncate the database, but this is not enough for the rate limits to be truly reset. I had to add a method to the spam prevention service to reset all the instances between tests. Not resetting them caused random failures because every login in every test was hitting those spam prevention middlewares and somehow left a trace of that in those instances (even when the brute table is reset). Maybe those instances were doing some in memory caching.</MESSAGE>
      <SHA>e7378520a0d2a5862daaa284c612268080cd0058</SHA>
      <PATCHEDFILES>
        <FILE>errors.js</FILE>
        <FILE>ghost/core/core/server/api/endpoints/member-signin-urls.js</FILE>
        <FILE>ghost/core/core/server/services/members/middleware.js</FILE>
        <FILE>ghost/core/core/server/web/members/app.js</FILE>
        <FILE>ghost/core/core/server/web/shared/middleware/api/spam-prevention.js</FILE>
        <FILE>ghost/core/core/server/web/shared/middleware/brute.js</FILE>
        <FILE>ghost/core/core/shared/config/defaults.json</FILE>
        <FILE>ghost/core/test/e2e-api/members/__snapshots__/send-magic-link.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-api/members/send-magic-link.test.js</FILE>
        <FILE>ghost/core/test/e2e-api/members/signin.test.js</FILE>
        <FILE>ghost/core/test/e2e-frontend/members.test.js</FILE>
        <FILE>ghost/core/test/utils/agents/members-api-test-agent.js</FILE>
        <FILE>ghost/core/test/utils/e2e-framework.js</FILE>
        <FILE>ghost/magic-link/lib/MagicLink.js</FILE>
        <FILE>ghost/members-api/lib/MembersAPI.js</FILE>
        <FILE>ghost/members-api/lib/controllers/router.js</FILE>
        <FILE>ghost/members-ssr/lib/MembersSSR.js</FILE>
        <FILE>ghost/portal/src/actions.js</FILE>
        <FILE>ghost/portal/src/components/pages/SigninPage.js</FILE>
        <FILE>ghost/portal/src/data-attributes.js</FILE>
        <FILE>ghost/portal/src/tests/SigninFlow.test.js</FILE>
        <FILE>ghost/portal/src/tests/SignupFlow.test.js</FILE>
        <FILE>ghost/portal/src/utils/api.js</FILE>
        <FILE>ghost/portal/src/utils/errors.js</FILE>
        <FILE>ghost/portal/src/utils/test-utils.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Bumped used Portal version to v2.14.x refs https://github.com/TryGhost/Ghost/commit/eac8fbfdfdfc5e6f2e6816d236c8b240adb73916 refs https://github.com/TryGhost/Ghost/commit/e7378520a0d2a5862daaa284c612268080cd0058 refs https://github.com/TryGhost/Ghost/issues/14508</MESSAGE>
      <SHA>e86e78fb6bb01dde8f9054745f3777e9ff1ea72e</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/core/shared/config/defaults.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
