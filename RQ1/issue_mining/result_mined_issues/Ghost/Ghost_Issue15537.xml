<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15537</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/15537</ISSUEURL>
  <TITLE>Webhook test coverage</TITLE>
  <DESCRIPTION>Webhooks have been a part of Ghost since very first versions. This area has been constantly lagging behind with solid test coverage. Having tests would add confidence to webhooks stability. Snapshot tests would be a great source of example data webhooks deliver to external integrations. To improve this situation, Ghost has introduced a special purpose Webhooks snapshot tests. These are snapshot-based tests (similar to the[ end-to-end API tests](https://github.com/TryGhost/Ghost/tree/a6c76dadc3c369d61e9e7fb3e65c42570efb9273/ghost/core/test/e2e-api/admin)) with one big difference - they test the outgoing request payload instead of API responses. To understand how end-to-end testing works at Ghost have a read through [this guide](https://ghost.notion.site/End-to-end-Testing-6a2ef073b1754b18aff42e24a632a007). The concepts applied in end-to-end API tests are very similar to ones used in webhook tests. Here is an [example of a webhook test suite](https://github.com/TryGhost/Ghost/blob/78c97d10a6f6a86c7b132534bcc71a6623688799/ghost/core/test/e2e-webhooks/posts.test.js) for for `post.published` and `post.added` events. The above suite covers two event's which Webhook events listen to. There are 29 total events Webhooks can respond to, 27 left to cover. We need help writing tests for them! Below are some pointers around what you could help us with. For the most part it's covering all of the webhook events with at least one &quot;happy path&quot; test. ## Steps to cover a webhook event listener with a test ### 1. Write a test First, find one webhook event listener to cover - search for an event that has no test coverage in the list of [all webhook event listeners](https://github.com/TryGhost/Ghost/blob/66f11d5e4548db3b3c4d9242e5e217863aac088b/ghost/core/core/server/services/webhooks/listen.js#L12-L45). &lt;details&gt; &lt;summary&gt;Copy of all events below for quick reference and ✅ for the ones with at least one test:&lt;/summary&gt; - [x] 'site.changed' (https://github.com/TryGhost/Ghost/pull/15595) - [x] 'post.added' (https://github.com/TryGhost/Ghost/commit/b536cf5d9c93dd3dde6dca05c82d6761384c2fb3) - [x] 'post.deleted' (https://github.com/TryGhost/Ghost/pull/15572) - [x] 'post.edited' (https://github.com/TryGhost/Ghost/pull/15625) - [x] 'post.published' (https://github.com/TryGhost/Ghost/commit/0f4aeaaa802738f06aed066ece39f9666f2ec1ce) - [x] 'post.published.edited' (https://github.com/TryGhost/Ghost/pull/15642) - [x] 'post.unpublished' (https://github.com/TryGhost/Ghost/pull/15628) - [x] 'post.scheduled' (https://github.com/TryGhost/Ghost/pull/15561) - [x] 'post.unscheduled' (https://github.com/TryGhost/Ghost/pull/15675) - [x] 'post.rescheduled' (https://github.com/TryGhost/Ghost/pull/15735) - [x] 'page.added' (https://github.com/TryGhost/Ghost/pull/15548) - [x] 'page.deleted' (https://github.com/TryGhost/Ghost/pull/15723) - [x] 'page.edited' (https://github.com/TryGhost/Ghost/pull/15627) - [x] 'page.published' (https://github.com/TryGhost/Ghost/pull/15724) - [x] 'page.published.edited' (https://github.com/TryGhost/Ghost/pull/15724) - [x] 'page.unpublished' (https://github.com/TryGhost/Ghost/pull/15613) - [x] 'page.scheduled' (https://github.com/TryGhost/Ghost/pull/15609) - [ ] 'page.unscheduled' (https://github.com/TryGhost/Ghost/pull/15722) - [x] 'page.rescheduled' (https://github.com/TryGhost/Ghost/pull/15736) - [x] 'tag.added' (https://github.com/TryGhost/Ghost/pull/15540) - [x] 'tag.edited' (https://github.com/TryGhost/Ghost/pull/15555) - [x] 'tag.deleted' (https://github.com/TryGhost/Ghost/pull/15553) - [x] 'member.added' (https://github.com/TryGhost/Ghost/pull/15554) - [x] 'member.deleted' (https://github.com/TryGhost/Ghost/pull/15570) - [x] 'member.edited' (https://github.com/TryGhost/Ghost/pull/15620) - [x] 'post.tag.attached' (https://github.com/TryGhost/Ghost/pull/15576) - [x] 'post.tag.detached' (https://github.com/TryGhost/Ghost/pull/15651) - [x] 'page.tag.attached' (https://github.com/TryGhost/Ghost/pull/15648) - [x] 'page.tag.detached' (https://github.com/TryGhost/Ghost/pull/15651) Before digging deep into work please double check if the list is up to date - check if there are any open or closed [Pull Requests open](https://github.com/TryGhost/Ghost/pulls) with the name of the event you are about to pick up. &lt;/details&gt; Let's pick `site.changed` event to cover with _example_ a test. Webhook tests are located in `ghost/core/test/e2e-webhooks/{model_name}.test.js` (e.g.: [test/e2e-webhooks/posts.test.js](https://github.com/TryGhost/Ghost/blob/78c97d10a6f6a86c7b132534bcc71a6623688799/ghost/core/test/e2e-webhooks/posts.test.js)). As there is no `site.test.js` suite in the [e2e-webhooks folder](https://github.com/TryGhost/Ghost/tree/a6c76dadc3c369d61e9e7fb3e65c42570efb9273/ghost/core/test/e2e-webhooks) - create a `site.test.js` file. Note, for `post.rescheduled` event, there is a `posts.test.js` test suite already. In this case, we would add test cases to existing `posts.test.js` test suite. The convention is to group test suites by common model name - `{model_name}.test.js`. Write the test in the newly created file following concepts in [end-to-end testing guide](https://ghost.notion.site/End-to-end-Testing-6a2ef073b1754b18aff42e24a632a007). For an easy start it's usually a good idea to copy a similar working test suite into your new file and tweak it. &lt;details&gt; &lt;summary&gt; Notes on Webhook test case structure &lt;/summary&gt; Webhook tests follow a setup-&gt;action-&gt;assert structure used commonly when writing other types of tests, like unit tests: 1. **Setup** - [Create a webhook](https://github.com/TryGhost/Ghost/blob/78c97d10a6f6a86c7b132534bcc71a6623688799/ghost/core/test/e2e-webhooks/posts.test.js#L69-L74) database entry 2. **Action** - Find under which conditions the event under test is triggered (usually a [result of API call(s)](https://github.com/TryGhost/Ghost/blob/78c97d10a6f6a86c7b132534bcc71a6623688799/ghost/core/test/e2e-webhooks/posts.test.js#L76-L95)). This might take a little bit of research and experimentation. If you are completely lost and did not find the pathway after searching feel free to leave a comment here for more guidance. 3. **Assertion** - [Wait for](https://github.com/TryGhost/Ghost/blob/78c97d10a6f6a86c7b132534bcc71a6623688799/ghost/core/test/e2e-webhooks/posts.test.js#L97) webhook events propagation and [write an assertion](https://github.com/TryGhost/Ghost/blob/78c97d10a6f6a86c7b132534bcc71a6623688799/ghost/core/test/e2e-webhooks/posts.test.js#L99-L115) about the expected format of the snapshot. &lt;/details&gt; ### 2. Run the test and record a snapshot Use the `yarn test:single` command inside `ghost/core` to run the test suite you've been working on: ``` yarn test:single test/e2e-webhooks/site.test.js ``` After the test run, there will be a snapshot file created with recorder webhook payload ([example](https://github.com/TryGhost/Ghost/blob/a6c76dadc3c369d61e9e7fb3e65c42570efb9273/ghost/core/test/e2e-webhooks/__snapshots__/posts.test.js.snap#L137-L324)). Check the **[Snapshot Testing](https://ghost.notioån.site/End-to-end-Testing-6a2ef073b1754b18aff42e24a632a007)** section of the end-to-end testing guide for more information about the inner workings of snapshot-based tests. ### 3. Open a PR To make sure you've not broken anything &amp; followed our code standard, run `yarn test:all`. You can also use `yarn lint` to check formatting issues. Commit and push the test suite code and the snapshot to your working branch. Open up a separate PR for each webhook even you cover. All done! we will try to review your contribution ASAP. ---- Please follow our contribution guidelines as closely as you can, particularly being sure to reference this issue in your commit. Test coverage commits should not use emojis as they are not user-facing changes. This issue is going to improve the ease of bug reproductions and will let all Ghost developers sleep better after modifying webhook-related code. This means a lot for the team and contributors! Thank you</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>27</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Removed Portal's .editorconfig file - this should no longer be needed because we have a top-level .editorconfig file</MESSAGE>
    <SHA>12aaaa6d6ec63daa816118bf66fc637147b0d819</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Added e2e tests for tag.added webhook (#15537)</MESSAGE>
      <SHA>40b89658d45e35f32ed208110053e4faff04cd0d</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/test/e2e-webhooks/__snapshots__/tags.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-webhooks/tags.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Added e2e tests for tag.added webhook (#15537)</MESSAGE>
      <SHA>4110ffaa2cb5700cc453044fe21ee3e65762626f</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/test/e2e-webhooks/__snapshots__/tags.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-webhooks/tags.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Cleaned up tags e2e webhook test refs https://github.com/TryGhost/Ghost/issues/15537 refs https://github.com/TryGhost/Ghost/commit/4110ffaa2cb5700cc453044fe21ee3e65762626f - The test had minor formatting issues not worth an extra back-forth during the PR review</MESSAGE>
      <SHA>06f6fc11a7263a92d44fd2119bc5367ddabd0d44</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/test/e2e-webhooks/tags.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>added e2e tests for members.added refs #15537</MESSAGE>
      <SHA>d0d401f8cb5ed7a2d0a04cec0d9e6bc57e97a03a</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/test/e2e-webhooks/__snapshots__/members.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-webhooks/members.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Added e2e test for `tag.deleted` webhook (#15553) refs https://github.com/TryGhost/Ghost/issues/15537 - this adds an e2e test and test snapshot for the `tag.deleted` webhook so we can prevent regressions and bugs in the future</MESSAGE>
      <SHA>426168f73d41e6b424eae4ce5971794c978914cd</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/test/e2e-webhooks/__snapshots__/tags.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-webhooks/tags.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Added e2e test for `member.added` webhook (#15554) refs https://github.com/TryGhost/Ghost/issues/15537 - this adds an e2e test and test snapshot for the `member.added` webhook so we can prevent regressions and bugs in the future</MESSAGE>
      <SHA>a0ec94fbfe825c2aecf8f820386b2f3e7d3a2cd2</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/test/e2e-webhooks/__snapshots__/members.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-webhooks/members.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Added e2e test for tag.edited webhook (#15555) refs #15537 - this adds an e2e test and test snapshot for the `tag.edited` webhook so we can prevent regressions and bugs in the future</MESSAGE>
      <SHA>95aefe8a828e9468085640e205c2a910f39bbc3f</SHA>
      <PATCHEDFILES>
        <FILE>ghost/core/test/e2e-webhooks/__snapshots__/tags.test.js.snap</FILE>
        <FILE>ghost/core/test/e2e-webhooks/tags.test.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
