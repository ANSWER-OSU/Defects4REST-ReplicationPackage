<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>16125</ISSUENO>
  <ISSUEURL>https://github.com/TryGhost/Ghost/issues/16125</ISSUEURL>
  <TITLE>Email recipient subsets can be chosen but it sometimes still sends to everyone when retrying</TITLE>
  <DESCRIPTION>### Issue Summary A grassroots group I’m part of is wanting to start sending out a newsletter but we ran into the same problems helpfully documented in #15725. As an experiment, I tried creating a label so I could send to a subset of subscribers of under 100. I’ve been trying this repeatedly as I continue to try to get it sent and I’ve found in a specific circumstance that after I complete the penultimate step it says it’s going to send to all subscribers despite me having chosen the label, like this: ![ghost-subscriber-filter-broken](https://user-images.githubusercontent.com/43280/212576117-c6803b90-aa09-4745-a2b3-c9705ad81295.gif) If I understand this correctly, it’s a UI-only problem, since the records in `email_receipients` have already been created and will be reused, so the actual subset will still be used. Thanks for all the work on this over the years ### Steps to Reproduce 1. Publish a post that includes emailing a subset of subscribers, but have the emailing fail. 2. Unpublish the post. 3. Refresh the browser. 4. Try publishing again with emailing, it will show initially that it will send only to the subset but then on the last step will show that’s emailing everyone. ### Ghost Version 5.30.0 ### Node.js Version 16.19.0 ### How did you install Ghost? Docker image served by Dokku on Ubuntu 16.04 ### Database type MySQL 8 ### Browser &amp; OS version Brave 1.41.100 (Chromium 103.0.5060.134) on macOS 13.1 ### Relevant log / error output _No response_ ### Code of Conduct - [X] I agree to be friendly and polite to people in this repository</DESCRIPTION>
  <REPONAME>Ghost</REPONAME>
  <TIMEDIFFERENCEDAYS>14</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>v5.33.0</MESSAGE>
    <SHA>829c325e51fc3c62243e26b73269a53b8cc94e39</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixed newsletter resending showing incorrect recipient data closes https://github.com/TryGhost/Ghost/issues/16125 We weren't taking into account any existing email segment set on the post. This is usually not an issue because during the publishing flow the post.emailSegment and the selectedRecipientFilter are kept in sync, but it becomes and issue when the email fails to send and is later retried - we now have an inconsistency between the two values.</MESSAGE>
      <SHA>f9f500075a0a9213ba1df07faa62dd5cd7772478</SHA>
      <PATCHEDFILES>
        <FILE>ghost/admin/app/utils/publish-options.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed newsletter resending showing incorrect recipient data closes https://github.com/TryGhost/Ghost/issues/16125 We weren't taking into account any existing email segment set on the post. This is usually not an issue because during the publishing flow the post.emailSegment and the selectedRecipientFilter are kept in sync, but it becomes and issue when the email fails to send and is later retried - we now have an inconsistency between the two values.</MESSAGE>
      <SHA>c11e79765ed8db964e8127c486a128e34cf53c63</SHA>
      <PATCHEDFILES>
        <FILE>ghost/admin/app/utils/publish-options.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed newsletter resending showing incorrect recipient data closes https://github.com/TryGhost/Ghost/issues/16125 We weren't taking into account any existing email segment set on the post. This is usually not an issue because during the publishing flow the post.emailSegment and the selectedRecipientFilter are kept in sync, but it becomes and issue when the email fails to send and is later retried - we now have an inconsistency between the two values.</MESSAGE>
      <SHA>8a8bd60d1cf382ce64125bfb340ece81c768c2fb</SHA>
      <PATCHEDFILES>
        <FILE>ghost/admin/app/utils/publish-options.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed default email recipients always being &quot;everyone&quot; rather than matching post visibility refs https://github.com/TryGhost/Ghost/issues/16125 The previous fix for incorrect recipient details being shown when re-sending a failed email introduced another bug that prevented the &quot;Match post visibility&quot; default recipients setting from working. - the server always sets `post.emailSegment` to `'all'` for new posts so the publish flow recipient filter logic that checked for `post.emailSegment` being present always defaulted to `'all'` rather than falling back to the selected default recipients setting - when a post has been published but the email failed it will have its `newsletter` value set so we can use that as a check for using the `post.emailSegment` value in place of the default recipients setting</MESSAGE>
      <SHA>13cc1c09ed2bc29ed0cf0d39c4bbc0f029f2d080</SHA>
      <PATCHEDFILES>
        <FILE>ghost/admin/app/utils/publish-options.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed default email recipients always being &quot;everyone&quot; rather than matching post visibility (#16247) refs https://github.com/TryGhost/Ghost/issues/16125 The previous fix for incorrect recipient details being shown when re-sending a failed email introduced another bug that prevented the &quot;Match post visibility&quot; default recipients setting from working. - the server always sets `post.emailSegment` to `'all'` for new posts so the publish flow recipient filter logic that checked for `post.emailSegment` being present always defaulted to `'all'` rather than falling back to the selected default recipients setting - when a post has been published but the email failed it will have its `newsletter` value set so we can use that as a check for using the `post.emailSegment` value in place of the default recipients setting</MESSAGE>
      <SHA>923a9a1cd6b4f1490e6eaf7e73797714977b9266</SHA>
      <PATCHEDFILES>
        <FILE>ghost/admin/app/utils/publish-options.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed default email recipients always being &quot;everyone&quot; rather than matching post visibility (#16247) refs https://github.com/TryGhost/Ghost/issues/16125 The previous fix for incorrect recipient details being shown when re-sending a failed email introduced another bug that prevented the &quot;Match post visibility&quot; default recipients setting from working. - the server always sets `post.emailSegment` to `'all'` for new posts so the publish flow recipient filter logic that checked for `post.emailSegment` being present always defaulted to `'all'` rather than falling back to the selected default recipients setting - when a post has been published but the email failed it will have its `newsletter` value set so we can use that as a check for using the `post.emailSegment` value in place of the default recipients setting</MESSAGE>
      <SHA>f7aefa2febd71fb270e3db9f69b4e060d1816cea</SHA>
      <PATCHEDFILES>
        <FILE>ghost/admin/app/utils/publish-options.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
