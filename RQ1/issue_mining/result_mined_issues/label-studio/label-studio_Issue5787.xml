<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5787</ISSUENO>
  <ISSUEURL>https://github.com/HumanSignal/label-studio/issues/5787</ISSUEURL>
  <TITLE>Value of &quot;collect_analytics&quot; isn't read if set via Helm</TITLE>
  <DESCRIPTION>**Describe the bug** In the Label Studio Helm chart, all environment variables are forced upper case: https://github.com/HumanSignal/charts/blob/master/heartex/label-studio/templates/app-deployment.yaml#L128 https://github.com/HumanSignal/charts/blob/master/heartex/label-studio/templates/_helpers.tpl#L338 The environment variable `collect_analytics` is searched for as lower-case, while all other environment variables are upper-case: https://github.com/HumanSignal/label-studio/blob/a9ddaa8c6fe6a8ac21f3728d03127ac656a68c9e/label_studio/core/settings/base.py#L613 **To Reproduce** Steps to reproduce the behavior: 1. Overwrite `global.extraEnvironmentVars.collect_analytics: &quot;False&quot;` in Helm 2. Install to Kubernetes with `helm install ... ` 3. Value of `COLLECT_ANALYTICS` in `base.py` will always be `True`, since Helm will set the environment variable `COLLECT_ANALYTICS` to `False` instead of `collect_analytics` 4. Default value `True` will always be used, as `collect_analytics` is never set **Expected behavior** As mentioned in the documentation, backend analytics should be disabled when the environment variable &quot;collect_analytics&quot; is set to &quot;False&quot;: https://github.com/HumanSignal/label-studio/blob/a9ddaa8c6fe6a8ac21f3728d03127ac656a68c9e/docs/source/guide/security.md#information-collected-by-label-studio **Screenshots** After setting `collect_analytics` to `&quot;False&quot;` via Helm, egress traffic to external AWS endpoints is still observed: &lt;img width=&quot;388&quot; alt=&quot;324642105-5f862c34-a5f1-40b3-bd96-5d8739b23801&quot; src=&quot;https://github.com/HumanSignal/label-studio/assets/22351542/f067fbac-baa0-4838-b906-cb62748b4502&quot;&gt; **Environment (please complete the following information):** - OS: Linux - Label Studio Version 1.12.0 **Additional context** Issue is further discussed here: https://github.com/HumanSignal/label-studio/issues/4612</DESCRIPTION>
  <REPONAME>label-studio</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>chore: LEAP-1017: bump sqlparse for security (and psycopg2 to unblock 3.12) (#5785) psycopg2 to 2.9.9 (https://www.psycopg.org/docs/news.html#what-s-new-in-psycopg-2-9-9) sqlparse to 0.5.0 (https://github.com/andialbrecht/sqlparse/blob/master/CHANGELOG) resolves #5775</MESSAGE>
    <SHA>a9ddaa8c6fe6a8ac21f3728d03127ac656a68c9e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: #5787 Support uppercased version of &quot;COLLECT_ANALYTICS&quot; env var (#5788) ### PR fulfills these requirements - [x] Commit message(s) and PR title follows the format `[fix|feat|ci|chore|doc]: TICKET-ID: Short description of change made` ex. `fix: DEV-XXXX: Removed inconsistent code usage causing intermittent errors` - [x] Tests for the changes have been added/updated (for bug fixes/features) - [x] Docs have been added/updated (for bug fixes/features) - [x] Best efforts were made to ensure docs/code are concise and coherent (checked for spelling/grammatical errors, commented out code, debug logs etc.) - [x] Self-reviewed and ran all changes on a local instance (for bug fixes/features) #### Change has impacts in these area(s) _(check all that apply)_ - [ ] Product design - [ ] Backend (Database) - [x] Backend (API) - [ ] Frontend ### Describe the reason for change _(link to issue, supportive screenshots etc.)_ https://github.com/HumanSignal/label-studio/issues/5787 #### What does this fix? _(if this is a bug fix)_ Updates `base.py` to search for `COLLECT_ANALYTICS` environment variable instead of `collect_analytics` #### What is the new behavior? _(if this is a breaking or feature change)_ #### What is the current behavior? _(if this is a breaking or feature change)_ #### What libraries were added/updated? _(list all with version changes)_ #### Does this change affect performance? _(if so describe the impacts positive or negative)_ #### Does this change affect security? _(if so describe the impacts positive or negative)_ Positive: backend analytics are properly disabled when deploying with Helm. #### What alternative approaches were there? _(briefly list any if applicable)_ #### What feature flags were used to cover this change? _(briefly list any if applicable)_ ### Does this PR introduce a breaking change? _(check only one)_ - [ ] Yes, and covered entirely by feature flag(s) - [ ] Yes, and covered partially by feature flag(s) - [ ] No - [x] Not sure (briefly explain the situation below) The environment variable name is changing to all upper-case - no impact if using Helm, as it enforces all caps. Other users who pass variables in with Docker Compose or other setup methods may already be using lower case, and their setup methods may not enforce all-caps. ### What level of testing was included in the change? _(check all that apply)_ - [ ] e2e - [ ] integration - [x] unit ### Which logical domain(s) does this change affect? _(for bug fixes/features, be as precise as possible. ex. Authentication, Annotation History, Review Stream etc.)_ Analytics / logging --------- Co-authored-by: Jo Booth &lt;jo.m.booth@gmail.com&gt;</MESSAGE>
      <SHA>a0b30e92e0d677143f85bc3c6eb8030cf1bf14d9</SHA>
      <PATCHEDFILES>
        <FILE>.github/workflows/test_migrations.yml</FILE>
        <FILE>.github/workflows/tests.yml</FILE>
        <FILE>docs/source/guide/security.md</FILE>
        <FILE>label_studio/core/settings/base.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: #5787 Support uppercased version of &quot;COLLECT_ANALYTICS&quot; env var (#5788) - [x] Commit message(s) and PR title follows the format `[fix|feat|ci|chore|doc]: TICKET-ID: Short description of change made` ex. `fix: DEV-XXXX: Removed inconsistent code usage causing intermittent errors` - [x] Tests for the changes have been added/updated (for bug fixes/features) - [x] Docs have been added/updated (for bug fixes/features) - [x] Best efforts were made to ensure docs/code are concise and coherent (checked for spelling/grammatical errors, commented out code, debug logs etc.) - [x] Self-reviewed and ran all changes on a local instance (for bug fixes/features) _(check all that apply)_ - [ ] Product design - [ ] Backend (Database) - [x] Backend (API) - [ ] Frontend _(link to issue, supportive screenshots etc.)_ https://github.com/HumanSignal/label-studio/issues/5787 _(if this is a bug fix)_ Updates `base.py` to search for `COLLECT_ANALYTICS` environment variable instead of `collect_analytics` _(if this is a breaking or feature change)_ _(if this is a breaking or feature change)_ _(list all with version changes)_ _(if so describe the impacts positive or negative)_ _(if so describe the impacts positive or negative)_ Positive: backend analytics are properly disabled when deploying with Helm. _(briefly list any if applicable)_ _(briefly list any if applicable)_ _(check only one)_ - [ ] Yes, and covered entirely by feature flag(s) - [ ] Yes, and covered partially by feature flag(s) - [ ] No - [x] Not sure (briefly explain the situation below) The environment variable name is changing to all upper-case - no impact if using Helm, as it enforces all caps. Other users who pass variables in with Docker Compose or other setup methods may already be using lower case, and their setup methods may not enforce all-caps. _(check all that apply)_ - [ ] e2e - [ ] integration - [x] unit _(for bug fixes/features, be as precise as possible. ex. Authentication, Annotation History, Review Stream etc.)_ Analytics / logging --------- Co-authored-by: Jo Booth &lt;jo.m.booth@gmail.com&gt;</MESSAGE>
      <SHA>f8e829619907b2ea57c942d2f681b55fcbcb41f7</SHA>
      <PATCHEDFILES>
        <FILE>.github/workflows/test_migrations.yml</FILE>
        <FILE>.github/workflows/tests.yml</FILE>
        <FILE>docs/source/guide/security.md</FILE>
        <FILE>label_studio/core/settings/base.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: #5787 Support uppercased version of &quot;COLLECT_ANALYTICS&quot; env var (#5788) ### PR fulfills these requirements - [x] Commit message(s) and PR title follows the format `[fix|feat|ci|chore|doc]: TICKET-ID: Short description of change made` ex. `fix: DEV-XXXX: Removed inconsistent code usage causing intermittent errors` - [x] Tests for the changes have been added/updated (for bug fixes/features) - [x] Docs have been added/updated (for bug fixes/features) - [x] Best efforts were made to ensure docs/code are concise and coherent (checked for spelling/grammatical errors, commented out code, debug logs etc.) - [x] Self-reviewed and ran all changes on a local instance (for bug fixes/features) #### Change has impacts in these area(s) _(check all that apply)_ - [ ] Product design - [ ] Backend (Database) - [x] Backend (API) - [ ] Frontend ### Describe the reason for change _(link to issue, supportive screenshots etc.)_ https://github.com/HumanSignal/label-studio/issues/5787 #### What does this fix? _(if this is a bug fix)_ Updates `base.py` to search for `COLLECT_ANALYTICS` environment variable instead of `collect_analytics` #### What is the new behavior? _(if this is a breaking or feature change)_ #### What is the current behavior? _(if this is a breaking or feature change)_ #### What libraries were added/updated? _(list all with version changes)_ #### Does this change affect performance? _(if so describe the impacts positive or negative)_ #### Does this change affect security? _(if so describe the impacts positive or negative)_ Positive: backend analytics are properly disabled when deploying with Helm. #### What alternative approaches were there? _(briefly list any if applicable)_ #### What feature flags were used to cover this change? _(briefly list any if applicable)_ ### Does this PR introduce a breaking change? _(check only one)_ - [ ] Yes, and covered entirely by feature flag(s) - [ ] Yes, and covered partially by feature flag(s) - [ ] No - [x] Not sure (briefly explain the situation below) The environment variable name is changing to all upper-case - no impact if using Helm, as it enforces all caps. Other users who pass variables in with Docker Compose or other setup methods may already be using lower case, and their setup methods may not enforce all-caps. ### What level of testing was included in the change? _(check all that apply)_ - [ ] e2e - [ ] integration - [x] unit ### Which logical domain(s) does this change affect? _(for bug fixes/features, be as precise as possible. ex. Authentication, Annotation History, Review Stream etc.)_ Analytics / logging --------- Co-authored-by: Jo Booth &lt;jo.m.booth@gmail.com&gt;</MESSAGE>
      <SHA>633c3acf111a52bf3452669cb9e2089134fc7497</SHA>
      <PATCHEDFILES>
        <FILE>.github/workflows/test_migrations.yml</FILE>
        <FILE>.github/workflows/tests.yml</FILE>
        <FILE>docs/source/guide/security.md</FILE>
        <FILE>label_studio/core/settings/base.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: #5787 Support uppercased version of &quot;COLLECT_ANALYTICS&quot; env var (#5842) Cherry-picking a0b30e9 Co-authored-by: Cameron Savage &lt;csavage5@me.com&gt; Co-authored-by: Jo Booth &lt;jo.m.booth@gmail.com&gt;</MESSAGE>
      <SHA>68931316419a2c15003cebc9d39a31c871552565</SHA>
      <PATCHEDFILES>
        <FILE>.github/workflows/test_migrations.yml</FILE>
        <FILE>.github/workflows/tests.yml</FILE>
        <FILE>docs/source/guide/security.md</FILE>
        <FILE>label_studio/core/settings/base.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
