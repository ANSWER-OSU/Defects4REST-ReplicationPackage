<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>7456</ISSUENO>
  <ISSUEURL>https://github.com/HumanSignal/label-studio/issues/7456</ISSUEURL>
  <TITLE>Bug: Audio waveform zoom/scroll generates numerous &quot;Concurrent render detected Error&quot; messages</TITLE>
  <DESCRIPTION>**Describe the bug** Zooming or scrolling within an audio file's waveform (`AudioUltraView`) triggers a large number of `Concurrent render detected Error` messages in the developer console. This issue is present in recent commits of the `develop` branch. **To Reproduce** Steps to reproduce the behavior: 1. Go to an Audio Labeling task in Label Studio. 2. Load an audio file to display the waveform. 3. Open the browser's developer console. 4. Interact with the audio waveform: * Zoom in or out. * Scroll the waveform view horizontally. 5. See `Concurrent render detected Error` messages logged repeatedly in the console during these interactions. **Expected behavior** Zooming and scrolling the audio waveform should function smoothly without generating `Concurrent render detected Error` messages in the console. **Screenshots** * Loom video demonstrating the error during zoom: https://www.loom.com/share/5188d12e20d74584b51ce475e29ec4f8 * Loom video demonstrating the error during scroll: https://www.loom.com/share/1fac3602c11a4ba2b8b61666cfe5e08a * Error Message &amp; Stack Trace: ``` Concurrent render detected Error Concurrent render detected Error Component Stack at AudioUltraView (view.tsx:24:1) at wrappedComponent (observer.js:24:1) at div (&lt;anonymous&gt;) at wrappedComponent (observer.js:24:1) at Annotation (Annotation.js:5:1) at div (&lt;anonymous&gt;) at bem.ts:212:1 at div (&lt;anonymous&gt;) at bem.ts:189:1 at div (&lt;anonymous&gt;) at bem.ts:189:1 at div (&lt;anonymous&gt;) at bem.ts:212:1 at div (&lt;anonymous&gt;) at bem.ts:189:1 at wrappedComponent (observer.js:24:1) at div (&lt;anonymous&gt;) at bem.ts:189:1 at Provider (index.mjs:41:1) at Provider (index.mjs:41:1) at CollectionProvider (index.mjs:26:1) ``` **Environment (please complete the following information):** - OS: Any - Label Studio Version: Community Edition (specifically observed on recent commits from the `develop` branch, likely present in several prior commits as well). **Additional context** * This issue was noticed after updating a local branch with recent changes from `develop`, but investigation confirms the bug exists in the `develop` branch itself (and potentially earlier commits). It wasn't introduced solely by the merge/rebase process. * The stack trace points to the `AudioUltraView` component and its MobX `observer` wrapper, suggesting a potential issue with how state updates are triggering re-renders during rapid interactions like zoom/scroll within the core codebase.</DESCRIPTION>
  <REPONAME>label-studio</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>chore: DIA-2092: add FF (#7450) Co-authored-by: hakan458 &lt;hakan@heartex.com&gt; Co-authored-by: matt-bernstein &lt;matt-bernstein@users.noreply.github.com&gt;</MESSAGE>
    <SHA>2ba6fb45d9f25a3c96d4c5d88a0a0544a3513481</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>**Fix: Prevent concurrent renders during audio waveform scroll and zoom** Closes #7456 **Problem:** Interacting with the audio waveform (specifically zooming or scrolling) in `AudioUltraView` frequently triggered &quot;Concurrent render detected&quot; errors or warnings in the console. This indicated overlapping attempts to execute the `Visualizer.draw()` method. **Root Cause:** The issue stemmed from how scroll and zoom interactions triggered drawing updates. Both actions were inadvertently causing `Visualizer.draw()` to be called twice in rapid succession: 1. **Direct Call:** The initial event handler (`handleScroll` for both wheel scroll and zoom detection) would eventually call `setScrollLeft` (for scroll) or `setZoom` (for zoom). *Before the fix*, these methods contained logic that led to an immediate, explicit call to `this.draw()`. 2. **Indirect Call via Native `scroll` Event:** Both `setScrollLeft` and `setZoom` (via the methods it calls like `centerToCurrentTime`) modify the `scrollLeft` property of the waveform's wrapper element (`this.wrapper.scrollLeft`). This DOM change triggers the browser's native `scroll` event. An event listener for this native `scroll` event was *also* calling `this.draw()` (via `_setScrollLeft`). This double `draw()` call, happening almost simultaneously, caused the internal `this.drawing` flag check within `draw()` to fail, leading to the concurrent render warning/error. **Solution:** This PR implements minimal changes to eliminate the redundant `draw()` calls during scroll and zoom: 1. **Scroll Fix:** Modified `Visualizer.setScrollLeft` so it *only* updates the DOM element's scroll position (`this.wrapper.scrollLeft`). The redundant internal call that triggered the first `draw()` was removed. The subsequent native `scroll` event listener is now solely responsible for updating the internal state and triggering the single required `draw()`. 2. **Zoom Fix:** Modified `Visualizer.setZoom` to remove its explicit call to `this.draw()`. Like the scroll fix, `setZoom` still updates the DOM `scrollLeft` (via `centerToCurrentTime` or `updatePosition` -&gt; `setScrollLeft`), allowing the native `scroll` event listener to handle the necessary state update and single `draw()` call. The call to `this.wf.invoke(&quot;zoom&quot;, ...)` was also ensured to be correctly placed within `setZoom`. **Impact:** By ensuring that both scroll and zoom actions rely consistently on the native `scroll` event listener to trigger the drawing update *after* the DOM change, we eliminate the double `draw()` calls. This resolves the &quot;Concurrent render detected&quot; warnings/errors previously observed during these specific interactions.</MESSAGE>
      <SHA>9f7bbd231ec275f235ba337902b79201fcc26f9a</SHA>
      <PATCHEDFILES>
        <FILE>web/libs/editor/src/lib/AudioUltra/Visual/Visualizer.ts</FILE>
        <FILE>web/libs/editor/src/lib/AudioUltra/react/index.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix: Resolve concurrent render warnings during audio scroll/zoom (#7456) (#7457) Co-authored-by: bmartel &lt;brandonmartel@gmail.com&gt;</MESSAGE>
      <SHA>02f01ad89ad58158b69a96b1bc874fefb02f4479</SHA>
      <PATCHEDFILES>
        <FILE>web/libs/editor/src/lib/AudioUltra/Visual/Visualizer.ts</FILE>
        <FILE>web/libs/editor/src/lib/AudioUltra/react/index.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
