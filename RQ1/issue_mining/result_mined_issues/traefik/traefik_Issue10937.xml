<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>10937</ISSUENO>
  <ISSUEURL>https://github.com/traefik/traefik/issues/10937</ISSUEURL>
  <TITLE>Internal Node IPs for NodePort services feature breaks namespace scoped Traefik deployments</TITLE>
  <DESCRIPTION>### Welcome! - [X] Yes, I've searched similar issues on [GitHub](https://github.com/traefik/traefik/issues) and didn't find any. - [X] Yes, I've searched similar issues on the [Traefik community forum](https://community.traefik.io) and didn't find any. ### What did you do? I'm running my Traefik deployments on Kubernetres in a fully name-spaced way. All Traefik RBAC permissions are configured using `Roles` and `RoleBindings`. The K8s cluster is owned by an infrastructure team and host multiple namespaces for multiple teams/clients. Until now I was able to run and configure Traefik permissions without any support from the infra team. With the [Internal Node IPs for NodePort services](https://github.com/traefik/traefik/pull/10278) feature introduced in Treafik 3.1 I no longer can do it. Traefik 3.1 requires cluster level permissions to list/watch nodes. This makes both me (as I need to ask/deploy an external team to manage/deploy my Traefik configuration) and the infrastructure team (that operate at a big scale and don't want to be bothered with an application level configurations) unhappy. As stated in the original PR comment by @rtribotte nodes are not namespaced so I fully understand why it was implemented this way. But the possibility to run Traefik in a fully namespaced way is/was a cool and useful feature that, I think, should be kept. @rtribotte are you open to refactoring the code to fetch node resources in the service namespace or other solution that will allow for fully namespaced Traefik setups? Also the documentation for [3.0 -&gt; 3.1 migration](https://doc.traefik.io/traefik/migration/v3/) is missing any information about the new permissions requirements ### What did you see instead? Traefik 3.1 can't run in Kubernetes without cluster level permissions for listing nodes ### What version of Traefik are you using? ``` traefik version Version: 3.1.0 Codename: comte Go version: go1.22.5 Built: 2024-07-15T14:44:04Z OS/Arch: linux/amd64 ``` ### What is your environment &amp; configuration? Traefik RBAC configuration: ```yaml --- apiVersion: v1 kind: ServiceAccount metadata: name: traefik namespace: {{ .Release.Namespace }} --- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: traefik-service-discovery namespace: {{ .Release.Namespace }} rules: - apiGroups: [&quot;&quot;] resources: [&quot;endpoints&quot;, &quot;pods&quot;, &quot;secrets&quot;, &quot;services&quot;,&quot;nodes&quot;] verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] - apiGroups: [&quot;extensions&quot;, &quot;networking.k8s.io&quot;] resources: [&quot;ingresses&quot;, &quot;ingressclasses&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] - apiGroups: [&quot;traefik.io&quot;, &quot;traefik.containo.us&quot;] resources: [&quot;ingressroutes&quot;, &quot;ingressroutetcps&quot;, &quot;ingressrouteudps&quot;, &quot;middlewares&quot;, &quot;middlewaretcps&quot;, &quot;tlsoptions&quot;, &quot;tlsstores&quot;, &quot;traefikservices&quot;, &quot;serverstransports&quot;, &quot;serverstransporttcps&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] - apiGroups: [&quot;discovery.k8s.io&quot;] resources: [&quot;endpointslices&quot;] verbs: [&quot;watch&quot;, &quot;list&quot;] --- kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: traefik-role-binding namespace: {{ .Release.Namespace }} subjects: - kind: ServiceAccount name: traefik namespace: {{ .Release.Namespace }} roleRef: kind: Role name: traefik-service-discovery apiGroup: rbac.authorization.k8s.io ``` ### If applicable, please paste the log output in DEBUG level _No response_</DESCRIPTION>
  <REPONAME>traefik</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>feat: forwardAuth support LogUserHeader</MESSAGE>
    <SHA>957a5f5e73f28d51023f3e294fb97256a451d5b5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix #10937: namespaced node lookups</MESSAGE>
      <SHA>f10d2c19991412210f5ad2b451875fb28648174d</SHA>
      <PATCHEDFILES>
        <FILE>pkg/provider/kubernetes/crd/client.go</FILE>
        <FILE>pkg/provider/kubernetes/crd/kubernetes_http.go</FILE>
        <FILE>pkg/provider/kubernetes/crd/kubernetes_tcp.go</FILE>
        <FILE>pkg/provider/kubernetes/crd/kubernetes_udp.go</FILE>
        <FILE>pkg/provider/kubernetes/ingress/client.go</FILE>
        <FILE>pkg/provider/kubernetes/ingress/client_mock_test.go</FILE>
        <FILE>pkg/provider/kubernetes/ingress/kubernetes.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
