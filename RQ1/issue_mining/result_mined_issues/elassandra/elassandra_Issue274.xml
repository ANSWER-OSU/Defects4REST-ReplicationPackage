<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>274</ISSUENO>
  <ISSUEURL>https://github.com/strapdata/elassandra/issues/274</ISSUEURL>
  <TITLE>Cannot create indexes in case the table has materialized views</TITLE>
  <DESCRIPTION>Hello, Using Elassandra version: `v6.2.3.12` I created a keyspace `test_keyspace` and one table that has a view: ```sql CREATE TABLE numbers(number text, account_uuid timeuuid, type int, state text, country_code text, purchase_date timestamp, release_date timestamp, status int, PRIMARY KEY(number)); CREATE MATERIALIZED VIEW numbers_by_user AS SELECT * FROM numbers WHERE number IS NOT NULL AND account_uuid IS NOT NULL PRIMARY KEY (account_uuid, number); ``` When trying to create a mapping as follow: ```sh curl -XPUT &quot;http://172.17.33.171:9200/test_numbers&quot; -H 'Content-Type: application/json' -d ' { &quot;settings&quot; : { &quot;keyspace&quot; : &quot;test_keyspace&quot; }, &quot;mappings&quot;: { &quot;numbers&quot;: { &quot;_field_names&quot;: {&quot;enabled&quot;: false}, &quot;discover&quot;: &quot;number|type|state|contry_code|status&quot; } } }' ``` I get the following error: ```json {&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;mapper_parsing_exception&quot;,&quot;reason&quot;:&quot;Multiple entries with same key: numbers_by_user=org.apache.cassandra.config.ViewDefinition@5cc77036[ksName=test_keyspace,viewName=numbers_by_user,baseTableId=7ba3ee50-5aa7-11e9-b32c-7fa424e5960d,baseTableName=numbers,includeAllColumns=true,whereClause=number IS NOT NULL AND account_uuid IS NOT NULL,metadata=org.apache.cassandra.config.CFMetaData@7429ad08[cfId=8600abe0-5aa7-11e9-b32c-7fa424e5960d,ksName=test_keyspace,cfName=numbers_by_user,flags=[COMPOUND],params=TableParams{comment=, read_repair_chance=0.0, dclocal_read_repair_chance=0.1, bloom_filter_fp_chance=0.01, crc_check_chance=1.0, gc_grace_seconds=864000, default_time_to_live=0, memtable_flush_period_in_ms=0, min_index_interval=128, max_index_interval=2048, speculative_retry=99PERCENTILE, caching={'keys' : 'ALL', 'rows_per_partition' : 'NONE'}, compaction=CompactionParams{class=org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy, options={max_threshold=32, min_threshold=4}}, compression=org.apache.cassandra.schema.CompressionParams@bbfbd591, extensions={}, cdc=false},comparator=comparator(org.apache.cassandra.db.marshal.UTF8Type),partitionColumns=[[] | [country_code purchase_date release_date state status type]],partitionKeyColumns=[account_uuid],clusteringColumns=[number],keyValidator=org.apache.cassandra.db.marshal.TimeUUIDType,columnMetadata=[number, country_code, status, purchase_date, release_date, state, type, account_uuid],droppedColumns={},triggers=[],indexes=[]]] and numbers_by_user=org.apache.cassandra.config.ViewDefinition@5cc77036[ksName=test_keyspace,viewName=numbers_by_user,baseTableId=7ba3ee50-5aa7-11e9-b32c-7fa424e5960d,baseTableName=numbers,includeAllColumns=true,whereClause=number IS NOT NULL AND account_uuid IS NOT NULL,metadata=org.apache.cassandra.config.CFMetaData@7429ad08[cfId=8600abe0-5aa7-11e9-b32c-7fa424e5960d,ksName=test_keyspace,cfName=numbers_by_user,flags=[COMPOUND],params=TableParams{comment=, read_repair_chance=0.0, dclocal_read_repair_chance=0.1, bloom_filter_fp_chance=0.01, crc_check_chance=1.0, gc_grace_seconds=864000, default_time_to_live=0, memtable_flush_period_in_ms=0, min_index_interval=128, max_index_interval=2048, speculative_retry=99PERCENTILE, caching={'keys' : 'ALL', 'rows_per_partition' : 'NONE'}, compaction=CompactionParams{class=org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy, options={max_threshold=32, min_threshold=4}}, compression=org.apache.cassandra.schema.CompressionParams@bbfbd591, extensions={}, cdc=false},comparator=comparator(org.apache.cassandra.db.marshal.UTF8Type),partitionColumns=[[] | [country_code purchase_date release_date state status type]],partitionKeyColumns=[account_uuid],clusteringColumns=[number],keyValidator=org.apache.cassandra.db.marshal.TimeUUIDType,columnMetadata=[number, country_code, status, purchase_date, release_date, state, type, account_uuid],droppedColumns={},triggers=[],indexes=[]]]&quot;}],&quot;type&quot;:&quot;mapper_parsing_exception&quot;,&quot;reason&quot;:&quot;Multiple entries with same key: numbers_by_user=org.apache.cassandra.config.ViewDefinition@5cc77036[ksName=test_keyspace,viewName=numbers_by_user,baseTableId=7ba3ee50-5aa7-11e9-b32c-7fa424e5960d,baseTableName=numbers,includeAllColumns=true,whereClause=number IS NOT NULL AND account_uuid IS NOT NULL,metadata=org.apache.cassandra.config.CFMetaData@7429ad08[cfId=8600abe0-5aa7-11e9-b32c-7fa424e5960d,ksName=test_keyspace,cfName=numbers_by_user,flags=[COMPOUND],params=TableParams{comment=, read_repair_chance=0.0, dclocal_read_repair_chance=0.1, bloom_filter_fp_chance=0.01, crc_check_chance=1.0, gc_grace_seconds=864000, default_time_to_live=0, memtable_flush_period_in_ms=0, min_index_interval=128, max_index_interval=2048, speculative_retry=99PERCENTILE, caching={'keys' : 'ALL', 'rows_per_partition' : 'NONE'}, compaction=CompactionParams{class=org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy, options={max_threshold=32, min_threshold=4}}, compression=org.apache.cassandra.schema.CompressionParams@bbfbd591, extensions={}, cdc=false},comparator=comparator(org.apache.cassandra.db.marshal.UTF8Type),partitionColumns=[[] | [country_code purchase_date release_date state status type]],partitionKeyColumns=[account_uuid],clusteringColumns=[number],keyValidator=org.apache.cassandra.db.marshal.TimeUUIDType,columnMetadata=[number, country_code, status, purchase_date, release_date, state, type, account_uuid],droppedColumns={},triggers=[],indexes=[]]] and numbers_by_user=org.apache.cassandra.config.ViewDefinition@5cc77036[ksName=test_keyspace,viewName=numbers_by_user,baseTableId=7ba3ee50-5aa7-11e9-b32c-7fa424e5960d,baseTableName=numbers,includeAllColumns=true,whereClause=number IS NOT NULL AND account_uuid IS NOT NULL,metadata=org.apache.cassandra.config.CFMetaData@7429ad08[cfId=8600abe0-5aa7-11e9-b32c-7fa424e5960d,ksName=test_keyspace,cfName=numbers_by_user,flags=[COMPOUND],params=TableParams{comment=, read_repair_chance=0.0, dclocal_read_repair_chance=0.1, bloom_filter_fp_chance=0.01, crc_check_chance=1.0, gc_grace_seconds=864000, default_time_to_live=0, memtable_flush_period_in_ms=0, min_index_interval=128, max_index_interval=2048, speculative_retry=99PERCENTILE, caching={'keys' : 'ALL', 'rows_per_partition' : 'NONE'}, compaction=CompactionParams{class=org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy, options={max_threshold=32, min_threshold=4}}, compression=org.apache.cassandra.schema.CompressionParams@bbfbd591, extensions={}, cdc=false},comparator=comparator(org.apache.cassandra.db.marshal.UTF8Type),partitionColumns=[[] | [country_code purchase_date release_date state status type]],partitionKeyColumns=[account_uuid],clusteringColumns=[number],keyValidator=org.apache.cassandra.db.marshal.TimeUUIDType,columnMetadata=[number, country_code, status, purchase_date, release_date, state, type, account_uuid],droppedColumns={},triggers=[],indexes=[]]]&quot;,&quot;caused_by&quot;:{&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;Multiple entries with same key: numbers_by_user=org.apache.cassandra.config.ViewDefinition@5cc77036[ksName=test_keyspace,viewName=numbers_by_user,baseTableId=7ba3ee50-5aa7-11e9-b32c-7fa424e5960d,baseTableName=numbers,includeAllColumns=true,whereClause=number IS NOT NULL AND account_uuid IS NOT NULL,metadata=org.apache.cassandra.config.CFMetaData@7429ad08[cfId=8600abe0-5aa7-11e9-b32c-7fa424e5960d,ksName=test_keyspace,cfName=numbers_by_user,flags=[COMPOUND],params=TableParams{comment=, read_repair_chance=0.0, dclocal_read_repair_chance=0.1, bloom_filter_fp_chance=0.01, crc_check_chance=1.0, gc_grace_seconds=864000, default_time_to_live=0, memtable_flush_period_in_ms=0, min_index_interval=128, max_index_interval=2048, speculative_retry=99PERCENTILE, caching={'keys' : 'ALL', 'rows_per_partition' : 'NONE'}, compaction=CompactionParams{class=org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy, options={max_threshold=32, min_threshold=4}}, compression=org.apache.cassandra.schema.CompressionParams@bbfbd591, extensions={}, cdc=false},comparator=comparator(org.apache.cassandra.db.marshal.UTF8Type),partitionColumns=[[] | [country_code purchase_date release_date state status type]],partitionKeyColumns=[account_uuid],clusteringColumns=[number],keyValidator=org.apache.cassandra.db.marshal.TimeUUIDType,columnMetadata=[number, country_code, status, purchase_date, release_date, state, type, account_uuid],droppedColumns={},triggers=[],indexes=[]]] and numbers_by_user=org.apache.cassandra.config.ViewDefinition@5cc77036[ksName=test_keyspace,viewName=numbers_by_user,baseTableId=7ba3ee50-5aa7-11e9-b32c-7fa424e5960d,baseTableName=numbers,includeAllColumns=true,whereClause=number IS NOT NULL AND account_uuid IS NOT NULL,metadata=org.apache.cassandra.config.CFMetaData@7429ad08[cfId=8600abe0-5aa7-11e9-b32c-7fa424e5960d,ksName=test_keyspace,cfName=numbers_by_user,flags=[COMPOUND],params=TableParams{comment=, read_repair_chance=0.0, dclocal_read_repair_chance=0.1, bloom_filter_fp_chance=0.01, crc_check_chance=1.0, gc_grace_seconds=864000, default_time_to_live=0, memtable_flush_period_in_ms=0, min_index_interval=128, max_index_interval=2048, speculative_retry=99PERCENTILE, caching={'keys' : 'ALL', 'rows_per_partition' : 'NONE'}, compaction=CompactionParams{class=org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy, options={max_threshold=32, min_threshold=4}}, compression=org.apache.cassandra.schema.CompressionParams@bbfbd591, extensions={}, cdc=false},comparator=comparator(org.apache.cassandra.db.marshal.UTF8Type),partitionColumns=[[] | [country_code purchase_date release_date state status type]],partitionKeyColumns=[account_uuid],clusteringColumns=[number],keyValidator=org.apache.cassandra.db.marshal.TimeUUIDType,columnMetadata=[number, country_code, status, purchase_date, release_date, state, type, account_uuid],droppedColumns={},triggers=[],indexes=[]]]&quot;}},&quot;status&quot;:400} ``` If there is no materialized view created it's working.</DESCRIPTION>
  <REPONAME>elassandra</REPONAME>
  <TIMEDIFFERENCEDAYS>28</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix a NPE hidding an error message when elastic env loader fails</MESSAGE>
    <SHA>54b2816832d9e9033fc538da450f2b117ad2db3e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix create indexes in case the table has materialized views #274</MESSAGE>
      <SHA>3e1d312fe1bdc62341c314d6d9e1e55d44bce008</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elassandra/cluster/SchemaManager.java</FILE>
        <FILE>server/src/test/java/org/elassandra/CqlTypesTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
