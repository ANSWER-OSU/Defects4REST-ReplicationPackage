<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>346</ISSUENO>
  <ISSUEURL>https://github.com/strapdata/elassandra/issues/346</ISSUEURL>
  <TITLE>Nested objects with inner hits query returns &quot;extracted source isn't an object or an array&quot;</TITLE>
  <DESCRIPTION>&lt;!-- Bug report --&gt; **Elassandra version**: Behavior is seen on official docker images [6.8.4.0](https://hub.docker.com/layers/strapdata/elassandra/6.8.4.0/images/sha256-1e004ecccfc506faf806464e4beed1815d3c973ee6d3bb4b88193084397d8491?context=explore) -&gt; [6.8.4.5](https://hub.docker.com/layers/strapdata/elassandra/6.8.4.5/images/sha256-1a7ff3e3c1ee0801f812aa321dfe4ae8a6f959c3ef47b0fbeaa3a4de695eff14?context=explore) **Plugins installed**: None **JVM version** (`java -version`): Docker image of 6.8.4.5 is running openjdk version &quot;1.8.0_252&quot; **OS version** (`uname -a` if on a Unix-like system): Running on a container on a host that is running 18.04.1-Ubuntu **Description of the problem including expected versus actual behavior**: I am moving from 6.2.3.28 to 6.8.4.5, and have noticed queries with inner hits on nested objects (as outlined in the steps below) are failing with the following error coming back: ``` { &quot;error&quot;: { &quot;root_cause&quot;: [ { &quot;type&quot;: &quot;illegal_state_exception&quot;, &quot;reason&quot;: &quot;extracted source isn't an object or an array&quot; } ], &quot;type&quot;: &quot;search_phase_execution_exception&quot;, &quot;reason&quot;: &quot;all shards failed&quot;, &quot;phase&quot;: &quot;query&quot;, &quot;grouped&quot;: true, &quot;failed_shards&quot;: [ { &quot;shard&quot;: 0, &quot;index&quot;: &quot;nested_data&quot;, &quot;node&quot;: &quot;5c622bfa-fef0-4dd0-b040-5a68a767beb5&quot;, &quot;reason&quot;: { &quot;type&quot;: &quot;illegal_state_exception&quot;, &quot;reason&quot;: &quot;extracted source isn't an object or an array&quot; } } ], &quot;caused_by&quot;: { &quot;type&quot;: &quot;illegal_state_exception&quot;, &quot;reason&quot;: &quot;extracted source isn't an object or an array&quot;, &quot;caused_by&quot;: { &quot;type&quot;: &quot;illegal_state_exception&quot;, &quot;reason&quot;: &quot;extracted source isn't an object or an array&quot; } } }, &quot;status&quot;: 500 } ``` **Reasons why I think this is a bug:** 1. When tested against [ES 6.8.4 docker image](https://hub.docker.com/layers/elasticsearch/library/elasticsearch/6.8.4/images/sha256-87538ba78df48470563796df1dbbf2e7bf407e97542830bfd395f912b15c07f0?context=explore) I do not see the same issue. 2. I do not see this issue on Elassandra 6.2.3.28, and assume there is backwards compatibility of query/mapping/docs on non major version releases **Other behaviors I noted:** Removing the inner_hits block of the query stops the issue, and so does turning off the source in the inner_hits block. However neither of these are desirable solutions Something else that seems to resolve the issue while I was triaging is removing `nested-object2` when inserting the data in step 2 below **Steps to reproduce**: 1. Create index at `nested_data` with the following mapping: ``` { &quot;mappings&quot;: { &quot;nested_data&quot;: { &quot;properties&quot;: { &quot;parent-nested&quot;: { &quot;type&quot;: &quot;nested&quot;, &quot;properties&quot;: { &quot;nested-object1&quot;: { &quot;type&quot;: &quot;nested&quot;, &quot;properties&quot;: { &quot;field1&quot;: { &quot;type&quot;: &quot;text&quot; }, &quot;field2&quot;: { &quot;type&quot;: &quot;text&quot;, &quot;fields&quot;: { &quot;keyword&quot;: { &quot;type&quot;: &quot;keyword&quot;, &quot;ignore_above&quot;: 256 } } } } }, &quot;nested-object2&quot;: { &quot;type&quot;: &quot;nested&quot;, &quot;properties&quot;: { &quot;field2&quot;: { &quot;type&quot;: &quot;text&quot; } } } } } } } } } ``` 2. Insert the following document in the above created index: ``` { &quot;parent-nested&quot;: [ { &quot;nested-object1&quot;: [ { &quot;field1&quot;: &quot;hello&quot; } ] }, { &quot;nested-object2&quot;: { } } ] } ``` 3. Run the following query against the index: ``` { &quot;query&quot;: { &quot;bool&quot;: { &quot;must&quot;: [ { &quot;nested&quot;: { &quot;path&quot;: &quot;parent-nested.nested-object1&quot;, &quot;inner_hits&quot;: { }, &quot;query&quot;: { &quot;bool&quot;: { &quot;should&quot;: { &quot;bool&quot;: { &quot;must&quot;: { &quot;match&quot;: { &quot;parent-nested.nested-object1.field1&quot;: &quot;hello&quot; } } } } } } } } ] } } } ``` **Please provide the following information**: * elassandra logs: ``` elassandra | Elassandra started elassandra | 2020-06-04 17:51:31,748 WARN [elasticsearch[172.18.0.2][http_server_worker][T#2]] org.elasticsearch.common.logging.DeprecationLogger.deprecated(DeprecationLogger.java:242) [types removal] The parameter include_type_name should be explicitly specified in create index requests to prepare for 7.0. In 7.0 include_type_name will default to 'false', and requests are expected to omit the type name in mapping definitions. elassandra | 2020-06-04 17:51:33,174 INFO [elasticsearch[172.18.0.2][generic][T#2]] org.elassandra.shard.CassandraShardStateListener.afterIndexShardStarted(CassandraShardStateListener.java:69) shard [nested_data][0] started elassandra | 2020-06-04 17:51:46,971 WARN [elasticsearch[172.18.0.2][search][T#1]] org.elasticsearch.rest.BytesRestResponse.build(BytesRestResponse.java:133) path: /nested_data/_search, params: {index=nested_data} elassandra | org.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed elassandra | at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:298) elassandra | at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:135) elassandra | at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:261) elassandra | at org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:100) elassandra | at org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:48) elassandra | at org.elasticsearch.action.search.InitialSearchPhase$2.lambda$onFailure$1(InitialSearchPhase.java:220) elassandra | at org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:174) elassandra | at org.elasticsearch.action.search.InitialSearchPhase.access$000(InitialSearchPhase.java:48) elassandra | at org.elasticsearch.action.search.InitialSearchPhase$2.onFailure(InitialSearchPhase.java:220) elassandra | at org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) elassandra | at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:59) elassandra | at org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:463) elassandra | at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1118) elassandra | at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1230) elassandra | at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1204) elassandra | at org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:60) elassandra | at org.elasticsearch.action.support.ChannelActionListener.onFailure(ChannelActionListener.java:56) elassandra | at org.elasticsearch.search.SearchService$2.onFailure(SearchService.java:368) elassandra | at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:362) elassandra | at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:356) elassandra | at org.elasticsearch.search.SearchService$4.doRun(SearchService.java:1114) elassandra | at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) elassandra | at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) elassandra | at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) elassandra | at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) elassandra | at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) elassandra | at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) elassandra | at java.lang.Thread.run(Thread.java:748) elassandra | Caused by: org.elasticsearch.ElasticsearchException$1: extracted source isn't an object or an array elassandra | at org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:657) elassandra | at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:133) elassandra | ... 26 common frames omitted elassandra | Caused by: java.lang.IllegalStateException: extracted source isn't an object or an array elassandra | at org.elasticsearch.search.fetch.FetchPhase.createNestedSearchHit(FetchPhase.java:340) elassandra | at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:166) elassandra | at org.elasticsearch.search.fetch.subphase.InnerHitsFetchSubPhase.hitsExecute(InnerHitsFetchSubPhase.java:69) elassandra | at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:184) elassandra | at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:424) elassandra | at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:404) elassandra | at org.elasticsearch.search.SearchService.access$100(SearchService.java:127) elassandra | at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:360) elassandra | ... 9 common frames omitted elassandra | 2020-06-04 18:06:06,393 WARN [elasticsearch[172.18.0.2][search][T#2]] org.elasticsearch.rest.BytesRestResponse.build(BytesRestResponse.java:133) path: /nested_data/_search, params: {index=nested_data} elassandra | org.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed elassandra | at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:298) elassandra | at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:135) elassandra | at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:261) elassandra | at org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:100) elassandra | at org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:48) elassandra | at org.elasticsearch.action.search.InitialSearchPhase$2.lambda$onFailure$1(InitialSearchPhase.java:220) elassandra | at org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:174) elassandra | at org.elasticsearch.action.search.InitialSearchPhase.access$000(InitialSearchPhase.java:48) elassandra | at org.elasticsearch.action.search.InitialSearchPhase$2.onFailure(InitialSearchPhase.java:220) elassandra | at org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) elassandra | at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:59) elassandra | at org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:463) elassandra | at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1118) elassandra | at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1230) elassandra | at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1204) elassandra | at org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:60) elassandra | at org.elasticsearch.action.support.ChannelActionListener.onFailure(ChannelActionListener.java:56) elassandra | at org.elasticsearch.search.SearchService$2.onFailure(SearchService.java:368) elassandra | at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:362) elassandra | at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:356) elassandra | at org.elasticsearch.search.SearchService$4.doRun(SearchService.java:1114) elassandra | at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) elassandra | at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) elassandra | at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) elassandra | at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) elassandra | at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) elassandra | at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) elassandra | at java.lang.Thread.run(Thread.java:748) elassandra | Caused by: org.elasticsearch.ElasticsearchException$1: extracted source isn't an object or an array elassandra | at org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:657) elassandra | at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:133) elassandra | ... 26 common frames omitted elassandra | Caused by: java.lang.IllegalStateException: extracted source isn't an object or an array elassandra | at org.elasticsearch.search.fetch.FetchPhase.createNestedSearchHit(FetchPhase.java:340) elassandra | at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:166) elassandra | at org.elasticsearch.search.fetch.subphase.InnerHitsFetchSubPhase.hitsExecute(InnerHitsFetchSubPhase.java:69) elassandra | at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:184) elassandra | at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:424) elassandra | at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:404) elassandra | at org.elasticsearch.search.SearchService.access$100(SearchService.java:127) elassandra | at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:360) elassandra | ... 9 common frames omitted ``` * cassandra schema: ``` CREATE KEYSPACE nested_data WITH replication = {'class': 'NetworkTopologyStrategy', 'DC1': '1'} AND durable_writes = true; CREATE TYPE nested_data.nested_data_parent_nested_nested_object1 ( field1 list&lt;text&gt;, field2 list&lt;text&gt; ); CREATE TYPE nested_data.nested_data_parent_nested_nested_object2 ( field2 list&lt;text&gt; ); CREATE TYPE nested_data.nested_data_parent_nested ( &quot;nested-object1&quot; list&lt;frozen&lt;nested_data_parent_nested_nested_object1&gt;&gt;, &quot;nested-object2&quot; list&lt;frozen&lt;nested_data_parent_nested_nested_object2&gt;&gt; ); CREATE TABLE nested_data.nested_data ( &quot;_id&quot; text PRIMARY KEY, &quot;parent-nested&quot; list&lt;frozen&lt;nested_data_parent_nested&gt;&gt; ) WITH bloom_filter_fp_chance = 0.01 AND caching = {'keys': 'ALL', 'rows_per_partition': 'NONE'} AND comment = '' AND compaction = {'class': 'org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy', 'max_threshold': '32', 'min_threshold': '4'} AND compression = {'chunk_length_in_kb': '64', 'class': 'org.apache.cassandra.io.compress.LZ4Compressor'} AND crc_check_chance = 1.0 AND dclocal_read_repair_chance = 0.1 AND default_time_to_live = 0 AND gc_grace_seconds = 864000 AND max_index_interval = 2048 AND memtable_flush_period_in_ms = 0 AND min_index_interval = 128 AND read_repair_chance = 0.0 AND speculative_retry = '99PERCENTILE'; CREATE CUSTOM INDEX elastic_nested_data_idx ON nested_data.nested_data () USING 'org.elassandra.index.ExtendedElasticSecondaryIndex'; ```</DESCRIPTION>
  <REPONAME>elassandra</REPONAME>
  <TIMEDIFFERENCEDAYS>11</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add twitter link in README</MESSAGE>
    <SHA>755a7e10d479dd9262b34039085f4bb1dd1e22f6</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #346 Nested objects with inner hits query returns &quot;extracted source isn't an object or an array&quot;</MESSAGE>
      <SHA>e0f77cc2532e460ace37742ad9395e95a7d0e47d</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elassandra/index/ElasticSecondaryIndex.java</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/mapper/ParseContext.java</FILE>
        <FILE>server/src/test/java/org/elassandra/CqlTypesTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
