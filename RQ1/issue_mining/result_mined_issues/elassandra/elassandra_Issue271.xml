<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>271</ISSUENO>
  <ISSUEURL>https://github.com/strapdata/elassandra/issues/271</ISSUEURL>
  <TITLE>Elassandra assertion error on bulk update</TITLE>
  <DESCRIPTION>**Elassandra version**: 6.2.3.10 **Plugins installed**: [] **JVM version** (`java -version`): ``` openjdk version &quot;1.8.0_181&quot; OpenJDK Runtime Environment (build 1.8.0_181-8u181-b13-2~deb9u1-b13) OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode) ``` **OS version** (`uname -a` if on a Unix-like system): Ubuntu 18.04 **Description of the problem including expected versus actual behavior**: Conditional bulk update fails in elassandra but works in elasticsearch 6.2.3 **Steps to reproduce**: 1. Create an index and add data `curl -XPOST -H 'content-type: application/json' http://172.17.0.3:9200/test_index/user -d '{&quot;projects&quot;:[&quot;p1&quot;, &quot;p2&quot;]}'` 2. Run the below command ``` curl -XPOST -H 'content-type: application/json' http://172.17.0.3:9200/_bulk -d ' {&quot;update&quot;:{&quot;_index&quot;:&quot;test_index&quot;,&quot;_type&quot;:&quot;user&quot;,&quot;_id&quot;:&quot;e8druWkBu-AlXJ3uggHp&quot;}} {&quot;script&quot;:{&quot;source&quot;: &quot;if (!ctx._source.projects.contains(params.project)) {ctx._source.projects.add(params.project)}&quot;,&quot;params&quot;:{&quot;project&quot;:&quot;p3&quot;}}} ' ' ``` 3. Curl statement never gave any response back. I checked the result in elastic seach and found that data got updated but Cassandra system.log shows an AssertionError ``` 2019-03-26 09:56:19,228 ERROR [elasticsearch[172.17.0.3][bulk][T#2]] CassandraDaemon.java:231 uncaughtException Exception in thread Thread[elasticsearch[172.17.0.3][bulk][T#2],5,main] java.lang.AssertionError: failed result should not have a sequence number at org.elasticsearch.action.bulk.TransportShardBulkAction.processUpdateResponse(TransportShardBulkAction.java:289) at org.elasticsearch.action.bulk.TransportShardBulkAction.executeUpdateRequestOnce(TransportShardBulkAction.java:393) at org.elasticsearch.action.bulk.TransportShardBulkAction.executeUpdateRequest(TransportShardBulkAction.java:419) at org.elasticsearch.action.bulk.TransportShardBulkAction.executeBulkItemRequest(TransportShardBulkAction.java:250) at org.elasticsearch.action.bulk.TransportShardBulkAction.performOnPrimary(TransportShardBulkAction.java:129) at org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:115) at org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:73) at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:1065) at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:1043) at org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:104) at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:331) at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:297) at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:284) at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:661) at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672) at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) ``` **Please provide the following information: * elassandra logs (logs/system.logs or /var/lib/cassandra/system.log) : Added above * elasticsearch cluster state (curl http://localhost:9200/_cluster/state): ``` { &quot;cluster_name&quot;: &quot;Test Cluster&quot;, &quot;compressed_size_in_bytes&quot;: 501, &quot;version&quot;: 9, &quot;state_uuid&quot;: &quot;QtmmOC9dS8SMAGeppPEduw&quot;, &quot;master_node&quot;: &quot;a8feb81e-270f-4def-8216-4f179bd1f5e2&quot;, &quot;blocks&quot;: {}, &quot;nodes&quot;: { &quot;a8feb81e-270f-4def-8216-4f179bd1f5e2&quot;: { &quot;name&quot;: &quot;172.17.0.3&quot;, &quot;status&quot;: &quot;ALIVE&quot;, &quot;ephemeral_id&quot;: &quot;a8feb81e-270f-4def-8216-4f179bd1f5e2&quot;, &quot;transport_address&quot;: &quot;172.17.0.3:9300&quot;, &quot;attributes&quot;: { &quot;rack&quot;: &quot;r1&quot;, &quot;dc&quot;: &quot;DC1&quot; } } }, &quot;metadata&quot;: { &quot;version&quot;: 2, &quot;cluster_uuid&quot;: &quot;a8feb81e-270f-4def-8216-4f179bd1f5e2&quot;, &quot;templates&quot;: {}, &quot;indices&quot;: { &quot;test_index&quot;: { &quot;state&quot;: &quot;open&quot;, &quot;settings&quot;: { &quot;index&quot;: { &quot;creation_date&quot;: &quot;1553594023962&quot;, &quot;number_of_shards&quot;: &quot;1&quot;, &quot;number_of_replicas&quot;: &quot;0&quot;, &quot;uuid&quot;: &quot;jKfz0fVyRnKTBrsNuBZeQQ&quot;, &quot;version&quot;: { &quot;created&quot;: &quot;6020399&quot; }, &quot;provided_name&quot;: &quot;test_index&quot; } }, &quot;mappings&quot;: { &quot;user&quot;: { &quot;properties&quot;: { &quot;projects&quot;: { &quot;type&quot;: &quot;text&quot;, &quot;fields&quot;: { &quot;keyword&quot;: { &quot;ignore_above&quot;: 256, &quot;type&quot;: &quot;keyword&quot; } } } } } }, &quot;aliases&quot;: [], &quot;primary_terms&quot;: { &quot;0&quot;: 0 }, &quot;in_sync_allocations&quot;: { &quot;0&quot;: [] } } }, &quot;index-graveyard&quot;: { &quot;tombstones&quot;: [] } }, &quot;routing_table&quot;: { &quot;indices&quot;: { &quot;test_index&quot;: { &quot;shards&quot;: { &quot;0&quot;: [ { &quot;state&quot;: &quot;STARTED&quot;, &quot;primary&quot;: true, &quot;node&quot;: &quot;a8feb81e-270f-4def-8216-4f179bd1f5e2&quot;, &quot;relocating_node&quot;: null, &quot;shard&quot;: 0, &quot;index&quot;: &quot;test_index&quot;, &quot;token_ranges&quot;: [ &quot;(-9223372036854775808,9223372036854775807]&quot; ], &quot;allocation_id&quot;: { &quot;id&quot;: &quot;dummy_alloc_id&quot; } } ] } } } }, &quot;routing_nodes&quot;: { &quot;unassigned&quot;: [], &quot;nodes&quot;: { &quot;a8feb81e-270f-4def-8216-4f179bd1f5e2&quot;: [ { &quot;state&quot;: &quot;STARTED&quot;, &quot;primary&quot;: true, &quot;node&quot;: &quot;a8feb81e-270f-4def-8216-4f179bd1f5e2&quot;, &quot;relocating_node&quot;: null, &quot;shard&quot;: 0, &quot;index&quot;: &quot;test_index&quot;, &quot;token_ranges&quot;: [ &quot;(-9223372036854775808,9223372036854775807]&quot; ], &quot;allocation_id&quot;: { &quot;id&quot;: &quot;dummy_alloc_id&quot; } } ] } }, &quot;snapshot_deletions&quot;: { &quot;snapshot_deletions&quot;: [] }, &quot;snapshots&quot;: { &quot;snapshots&quot;: [] }, &quot;restore&quot;: { &quot;snapshots&quot;: [] } } ``` * cassandra schema (cqlsh&gt;DESC KEYSPACE &lt;your_keyspace&gt;) ``` CREATE KEYSPACE test_index WITH replication = {'class': 'NetworkTopologyStrategy', 'DC1': '1'} AND durable_writes = true; CREATE TABLE test_index.user ( &quot;_id&quot; text PRIMARY KEY, projects list&lt;text&gt; ) WITH bloom_filter_fp_chance = 0.01 AND caching = {'keys': 'ALL', 'rows_per_partition': 'NONE'} AND comment = '' AND compaction = {'class': 'org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy', 'max_threshold': '32', 'min_threshold': '4'} AND compression = {'chunk_length_in_kb': '64', 'class': 'org.apache.cassandra.io.compress.LZ4Compressor'} AND crc_check_chance = 1.0 AND dclocal_read_repair_chance = 0.1 AND default_time_to_live = 0 AND gc_grace_seconds = 864000 AND max_index_interval = 2048 AND memtable_flush_period_in_ms = 0 AND min_index_interval = 128 AND read_repair_chance = 0.0 AND speculative_retry = '99PERCENTILE'; CREATE CUSTOM INDEX elastic_user_idx ON test_index.user () USING 'org.elassandra.index.ExtendedElasticSecondaryIndex'; ``` * cassandra gossip state (run: nodetool gossipinfo) ``` /172.17.0.3 generation:1553592898 heartbeat:1706 STATUS:55:NORMAL,-2180626626081522229 LOAD:1661:113785.0 SCHEMA:1208:ab8b61c6-d700-3c2e-ae37-51b6bc17d07b DC:8:DC1 RACK:10:r1 RELEASE_VERSION:4:3.11.3.5 INTERNAL_IP:6:172.17.0.3 RPC_ADDRESS:3:172.17.0.3 NET_VERSION:1:11 HOST_ID:2:a8feb81e-270f-4def-8216-4f179bd1f5e2 RPC_READY:67:true X1:1205:{&quot;test_index&quot;:3} X2:1210:a8feb81e-270f-4def-8216-4f179bd1f5e2/2 TOKENS:54:&lt;hidden&gt; ```</DESCRIPTION>
  <REPONAME>elassandra</REPONAME>
  <TIMEDIFFERENCEDAYS>66</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Catch exception on finish</MESSAGE>
    <SHA>0d0a2fb2a3113c4679e558a15e118523d0735dba</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#271 fix assertion error on update and add unit test</MESSAGE>
      <SHA>4ad1b16076f91eb43ed1d218939a0b2b07747182</SHA>
      <PATCHEDFILES>
        <FILE>modules/lang-painless/src/test/java/org/elassandra/painless/ScriptTests.java</FILE>
        <FILE>modules/lang-painless/src/test/resources/conf/cassandra-rackdc.properties</FILE>
        <FILE>modules/lang-painless/src/test/resources/conf/cassandra.yaml</FILE>
        <FILE>modules/lang-painless/src/test/resources/conf/logback.xml</FILE>
        <FILE>modules/lang-painless/src/test/resources/config/elasticsearch.json</FILE>
        <FILE>modules/lang-painless/src/test/resources/config/elasticsearch.yml</FILE>
        <FILE>server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
