<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>332</ISSUENO>
  <ISSUEURL>https://github.com/NatLibFi/Annif/issues/332</ISSUEURL>
  <TITLE>Eval crash on TFIDF with multiple training files</TITLE>
  <DESCRIPTION>When evaluating a TFIDF project trained on multiple files (`CombinedCorpus`) the `eval` crashes: ``` (Annif) jmminkin@lx8-9811-008:/home/local/jmminkin/git/Annif$ annif train tfidf-fi yso-cicero-finna-fi-head-500-lines.tsv yso-cicero-finna-fi-tail-500-lines.tsv creating vectorizer warning: Unknown subject URI &lt;http://www.yso.fi/onto/yso/p14645&gt; ... Backend tfidf: creating similarity index (Annif) jmminkin@lx8-9811-008:/home/local/jmminkin/git/Annif$ annif eval tfidf-fi ~/annif-projects/Annif-corpora/fulltext/kirjastonhoitaja/test/ warning: Unknown subject URI &lt;http://www.yso.fi/onto/yso/p1997&gt; ... Traceback (most recent call last): File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/bin/annif&quot;, line 11, in &lt;module&gt; load_entry_point('annif', 'console_scripts', 'annif')() File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/click/core.py&quot;, line 764, in __call__ return self.main(*args, **kwargs) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/flask/cli.py&quot;, line 586, in main return super(FlaskGroup, self).main(*args, **kwargs) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/click/core.py&quot;, line 717, in main rv = self.invoke(ctx) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/click/core.py&quot;, line 1137, in invoke return _process_result(sub_ctx.command.invoke(sub_ctx)) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/click/core.py&quot;, line 956, in invoke return ctx.invoke(self.callback, **ctx.params) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/click/core.py&quot;, line 555, in invoke return callback(*args, **kwargs) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/click/decorators.py&quot;, line 17, in new_func return f(get_current_context(), *args, **kwargs) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/flask/cli.py&quot;, line 426, in decorator return __ctx.invoke(f, *args, **kwargs) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/click/core.py&quot;, line 555, in invoke return callback(*args, **kwargs) File &quot;/home/local/jmminkin/git/Annif/annif/cli.py&quot;, line 276, in run_eval for metric, score in eval_batch.results().items(): File &quot;/home/local/jmminkin/git/Annif/annif/eval.py&quot;, line 143, in results y_true, y_pred, metrics) File &quot;/home/local/jmminkin/git/Annif/annif/eval.py&quot;, line 93, in _evaluate_samples y_true, y_pred_binary, average='samples') File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/sklearn/metrics/classification.py&quot;, line 1569, in precision_score sample_weight=sample_weight) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/sklearn/metrics/classification.py&quot;, line 1415, in precision_recall_fscore_support pos_label) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/sklearn/metrics/classification.py&quot;, line 1240, in _check_set_wise_labels present_labels = unique_labels(y_true, y_pred) File &quot;/home/jmminkin/.local/share/virtualenvs/Annif-b5vsMxU8/lib/python3.6/site-packages/sklearn/utils/multiclass.py&quot;, line 88, in unique_labels raise ValueError(&quot;Multi-label binary indicator input with &quot; ValueError: Multi-label binary indicator input with different numbers of labels ``` Also `suggest` does not seem to work with such a project (although this could be unrelated): ``` $ echo testi tekstia tassa nain | annif suggest tfidf-fi (Annif) jmminkin@lx8-9811-008:/home/local/jmminkin/git/Annif$ (no results) ``` If a fasttext project is trained on multiple files like above, `eval` works and `suggest` produces results. The `eval` crash might be due to that TFIDF backend [saves the `_index`](https://github.com/NatLibFi/Annif/blob/master/annif/backend/tfidf.py#L44) that is created in training (when its size is multiplied by the number of the input files), and then for predictions the same `_index` is loaded and used (but this is not the case for fasttext project). However, `eval` simply uses the project's vocabulary](https://github.com/NatLibFi/Annif/blob/master/annif/cli.py#L266) which does not know about the multiplied size of the `_index`, leading to [the size mismatch mentioned in the traceback](https://github.com/NatLibFi/Annif/blob/master/annif/eval.py#L93).</DESCRIPTION>
  <REPONAME>Annif</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #322 from NatLibFi/issue318-handle-missing-or-invalid-path-input-for-commands Issue318 handle missing or invalid path input for commands</MESSAGE>
    <SHA>81994c4af9accfb7d5e77ff0070b48b8f9e8e5e5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge subjects in CombinedCorpus instead of concatenating them. Fixes #332</MESSAGE>
      <SHA>e007c71b60bcbfb7ade7c0b06fc1177c66b0cad2</SHA>
      <PATCHEDFILES>
        <FILE>annif/corpus/combine.py</FILE>
        <FILE>tests/test_corpus.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
