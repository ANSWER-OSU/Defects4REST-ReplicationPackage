<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2726</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/2726</ISSUEURL>
  <TITLE>Wrong node affinity on EKS cluster</TITLE>
  <DESCRIPTION>## Problem When Drone configures affinity of pipelines' pods, it sets this chunk of code: ```yaml spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - ip-10-100-45-161.eu-west-1.compute.internal ``` Correct me if I'm wrong, but this affinity seems to be set based on pipeline's pod `spec.nodeName`. On AWS EKS, worker nodes names are tagged like `${HOST_DNS}.${AWS_REGION}.compute.internal`, but Kubernetes' label `kubernetes.io/hostname` is set to the actual host name of the EC2 instance, `${HOST_DNS}`, e.g.: ```bash kubectl get nodes -L kubernetes.io/hostname NAME STATUS ROLES AGE VERSION HOSTNAME ip-10-100-15-22.eu-west-1.compute.internal Ready &lt;none&gt; 12d v1.12.7 ip-10-100-15-22 ip-10-100-45-161.eu-west-1.compute.internal Ready &lt;none&gt; 121m v1.12.7 ip-10-100-45-161 ip-10-100-63-36.eu-west-1.compute.internal Ready &lt;none&gt; 11d v1.12.7 ip-10-100-63-36 ``` So, when the pipeline launches a new namespace to run all the steps of the pipeline, child jobs have the upper affinity, and never find a node to schedule the pod. ## Possible solution You can set your nodes label `kubernetes.io/hostname` to the node name manually, and Drone would launch pods without errors. But maybe Drone should use another type of affinity, or none affinity at all, but I assume that the affinity setting is there for a reason. Let me know if you need more information. Thank you for everything!</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[feat]: [AH-363]: made few fields public in registryReq (#2727) * [feat]: [AH-363]: made few fields public in registryReq * [feat]: [AH-363]: made few fields public in registryReq</MESSAGE>
    <SHA>dcc85d55450952a840b259e9d7a327bd94589e40</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>feat: [AH-307]: GC interface Integration, event framework; schema changes; UI changes (#2688) * fix * Merge branch 'main' into AH-307-plus-url-support-2_no_rbac * resolve PR comments * resolve PR comments * resolve PR comments * feat: [AH-346]: new api changes for version list and digest list (#2726) * feat: [AH-346]: new api changes for version list and digest list * resolve pr comments * resolve pr comments * feat: [AH-346]: new api yaml integration (#2716) * feat: [AH-346]: new api yaml integration * Merge branch 'main' of https://git0.harness.io/l7B_kbSEQD2wjrM7PShm5w/PROD/Harness_Commons/gitness into AH-307-plus-url-support-2_no_rbac * fix wire check * fix lint issues * fix: [AH-357]: migrations * changes for global artifact listing (#2708) * changes for global artifact listing * Merge branch 'main' into AH-307-plus-url-support-2_no_rbac * merged main * Merge branch 'main' into AH-307-plus-url-support-2_no_rbac * [AH-307]: Updated lint * fix comment * add new method to spacestore * feat: [AH-307]: fix after rebase with main * [AH-307]: Removing comments * [AH-307]: linting fixes * feat: [AH-286]: define proto, interface and no-op reporter implementation to publish artifact events (#2657) * feat: [AH-286]: publish artifact event - no row found is not error * feat: [AH-286]: publish artifact event - no row found is not error * feat: [AH-286]: publish artifact event - lint errors, move publishing event outside DB transaction * feat: [AH-286]: publish artifact event - review comments * feat: [AH-286]: publish artifact event - address review comments * feat: [AH-286]: publish artifact event - keep payload generic * feat: [AH-286]: publish artifact event - as sqlite locks DB, perform db operation outside goroutine publishing of events * feat: [AH-286]: publish artifact event - make publishing event async * feat: [AH-286]: publish artifact event - use api types * feat: [AH-286]: Publish event for SSCA to trigger scans - no need to export spacePathStore * feat: [AH-286]: Publish event for SSCA to trigger scans - send spacePath instead of parentID * feat: [AH-286]: Publish event for SSCA to trigger scans - rename scanner as generic reporter * feat: [AH-286]: Publish event for SSCA to trigger scans - rename scanner as generic reporter * feat: [AH-286]: publish artifact event - reuse redis.Send() * feat: [AH-286]: Publish event for SSCA to trigger scans - review comments * feat: [AH-286]: Publish event for SSCA to trigger scans - remove unused interface * feat: [AH-286]: Publish event for SSCA to trigger scans - update msg format * feat: [AH-286]: define proto, interface and no-op reporter implementation to publish artifact events * feat: [AH-286]: Publish event for SSCA to trigger scans - extract acctID/orgID/projectID from spacepathStore * feat: [AH-286]: publish artifact event - remove protobuf reference, fix lint errors * feat: [AH-286]: publish artifact event - fix msg format * feat: [AH-286]: define proto, interface and no-op reporter implementation to publish artifact events * feat: [AH-286]: define proto, interface and no-op reporter implementation to publish artifact events * feat: [AH-321]: make repo form disabled for rbac (#2687) * feat: [AH-321]: make repo form disabled for rbac * fix wire-gen * GC refactoring * feat: [AH-340]: update UI as per the product feedbacks (#2685) * feat: [AH-340]: update UI as per the product feedbacks * feat: [AH-44]: add module data while redirecting to pipeline execution page * feat: [AH-44]: add build pipeline details in overview cards * feat: [AH-44]: update view for prod and non prod tag * feat: [AH-44]: rearrange filters on artifact list apge * feat: [AH-10]: add schema for overview cards, update artifact list, add ai search input, update api for registry artifact list and update mapping for deployments table * feat: [AH-307]: add secretSpacePath in upstream password field while sending to BE (#2631) * feat: [AH-307]: add secretSpacePath in upstream password field while sending to BE * feat: [AH-299]: support new changes for artifact list page (#2630) * feat: update har service api version * feat: [AH-30]: integrate API schema for deployments list content * feat: [AH-300]: update tag colors for prod and non prod tags * feat: [AH-300]: Add Deployments table in artiface version details page * feat: [AH-299]: support new changes for artifact list page * feat: [AH-299]: support new changes for artifact list page * feat: [AH-321]: support artifact registry rbac permission on UI (#2671) * feat: [AH-321]: support artifact registry rbac permission on UI * enable rbac (#2664) * fix scope * enable rbac * feat: [AH-307]: hide code tab from version details page for both docker and helm * feat: [AH-240]: add custom handling for enterprise auth type field * Merge branch 'AH-307-plus-url-support-2_no_rbac' of https://git0.harness.io/l7B_kbSEQD2wjrM7PShm5w/PROD/Harness_Commons/gitness into AH-307-plus-url-support-2_no_rbac * feat: [AH-307]: send space_ref in query param while creating registries * lowercase rootRef * [AH-307]: updated route * [AH-307]: Added logs * [AH-307]: Added logs * feat: [AH-317]: add space_ref query param * local * Merge commit * Merge commit * Merge commit * Added comments * Revert changes * Merge commit * Merge branch 'main' of https://git0.harness.io/l7B_kbSEQD2wjrM7PShm5w/PROD/Harness_Commons/gitness into AH-307-plus-url-support-2 * Merge branch 'AH-306d' of https://git0.harness.io/l7B_kbSEQD2wjrM7PShm5w/PROD/Harness_Commons/gitness into AH-307-plus-url-support-2 * fix space path handling * Merge branch 'main' of https://git0.harness.io/l7B_kbSEQD2wjrM7PShm5w/PROD/Harness_Commons/gitness into AH-307-plus-url-support-2 * Updated URLs to support slashes with + separator * fix: [AH-306c]: fix anonymous flow * fix: [AH-306c]: fix anonymous flow * feat: [AH-307]: plus url support on UI (cherry picked from commit 3fb6add3ce03498b6668b5f8f6d547e1acedaec4) * [AH-307]: Added examples (cherry picked from commit e83e41303da536f421be333be04aed09fbf75f5f) * [AH-307]: Added Regex request rewrite support (cherry picked from commit ed7b155256bdcd1134bc228b5705556a1233add6) * fix: [AH-306c]: fix anonymous flow</MESSAGE>
      <SHA>479c9b9fe77a00d993037eb49c1fc0b2f1cce332</SHA>
      <PATCHEDFILES>
        <FILE>.local.env</FILE>
        <FILE>app/store/cache/path.go</FILE>
        <FILE>app/store/database.go</FILE>
        <FILE>app/store/database/space.go</FILE>
        <FILE>cmd/gitness/wire.go</FILE>
        <FILE>cmd/gitness/wire_gen.go</FILE>
        <FILE>registry/app/api/controller/metadata/artifact_mapper.go</FILE>
        <FILE>registry/app/api/controller/metadata/base.go</FILE>
        <FILE>registry/app/api/controller/metadata/get_artifacts.go</FILE>
        <FILE>registry/app/api/controller/metadata/get_artifacts_labels.go</FILE>
        <FILE>registry/app/api/controller/metadata/get_artifacts_versions.go</FILE>
        <FILE>registry/app/api/controller/metadata/get_registries.go</FILE>
        <FILE>registry/app/api/controller/metadata/get_registry_artifacts.go</FILE>
        <FILE>registry/app/api/controller/metadata/update_artifact.go</FILE>
        <FILE>registry/app/api/controller/metadata/utils.go</FILE>
        <FILE>registry/app/api/handler/oci/get_token.go</FILE>
        <FILE>registry/app/api/openapi/api.yaml</FILE>
        <FILE>registry/app/api/openapi/contracts/artifact/services.gen.go</FILE>
        <FILE>registry/app/api/openapi/contracts/artifact/types.gen.go</FILE>
        <FILE>registry/app/api/wire.go</FILE>
        <FILE>registry/app/driver/filesystem/driver.go</FILE>
        <FILE>registry/app/event/reporter.go</FILE>
        <FILE>registry/app/pkg/docker/app.go</FILE>
        <FILE>registry/app/pkg/docker/helpers.go</FILE>
        <FILE>registry/app/pkg/docker/manifest_service.go</FILE>
        <FILE>registry/app/pkg/docker/wire.go</FILE>
        <FILE>registry/app/store/database.go</FILE>
        <FILE>registry/app/store/database/tag.go</FILE>
        <FILE>registry/gc/garbagecollector.go</FILE>
        <FILE>registry/gc/interface.go</FILE>
        <FILE>registry/types/gc.go</FILE>
        <FILE>registry/types/tag.go</FILE>
        <FILE>web/package.json</FILE>
        <FILE>web/src/ar/MFEAppTypes.ts</FILE>
        <FILE>web/src/ar/__mocks__/components/RbacButton.tsx</FILE>
        <FILE>web/src/ar/app/GitnessApp.tsx</FILE>
        <FILE>web/src/ar/common/constants.ts</FILE>
        <FILE>web/src/ar/common/permissionTypes.ts</FILE>
        <FILE>web/src/ar/common/types.ts</FILE>
        <FILE>web/src/ar/components/AISearchInput/AISearchInput.module.scss</FILE>
        <FILE>web/src/ar/components/AISearchInput/AISearchInput.module.scss.d.ts</FILE>
        <FILE>web/src/ar/components/AISearchInput/AISearchInput.tsx</FILE>
        <FILE>web/src/ar/components/AISearchInput/types.ts</FILE>
        <FILE>web/src/ar/components/ButtonTabs/ButtonTabs.tsx</FILE>
        <FILE>web/src/ar/components/EnvironmentTypeSelector/EnvironmentTypeSelector.tsx</FILE>
        <FILE>web/src/ar/components/Form/PatternInput/PatternInput.tsx</FILE>
        <FILE>web/src/ar/components/IncludeExcludePatterns/IncludeExcludePatterns.tsx</FILE>
        <FILE>web/src/ar/components/NameDescriptionTags/index.tsx</FILE>
        <FILE>web/src/ar/components/PageTitle/ArtifactTags.tsx</FILE>
        <FILE>web/src/ar/components/TableCells/TableCells.module.scss</FILE>
        <FILE>web/src/ar/components/TableCells/TableCells.module.scss.d.ts</FILE>
        <FILE>web/src/ar/components/TableCells/TableCells.tsx</FILE>
        <FILE>web/src/ar/components/Tag/Tag.module.scss</FILE>
        <FILE>web/src/ar/components/Tag/Tag.module.scss.d.ts</FILE>
        <FILE>web/src/ar/components/Tag/Tags.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-details/components/ArtifactActions/DeleteRepository.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-details/components/ArtifactActions/EditRepository.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-details/components/ArtifactActions/SetupClient.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-details/components/ArtifactDetailsHeader/ArtifactDetailsHeaderContent.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-list/ArtifactListPage.module.scss</FILE>
        <FILE>web/src/ar/pages/artifact-list/ArtifactListPage.module.scss.d.ts</FILE>
        <FILE>web/src/ar/pages/artifact-list/ArtifactListPage.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-list/RegistryArtifactListPage.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/ArtifactListTable/ArtifactListTable.module.scss</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/ArtifactListTable/ArtifactListTable.module.scss.d.ts</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/ArtifactListTable/ArtifactListTable.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/ArtifactListTable/ArtifactListTableCell.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/ArtifactSearchInput/ArtifactSearchInput.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/ArtifactSearchInput/constants.ts</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/RegistryArtifactListTable/RegistryArtifactListTable.module.scss</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/RegistryArtifactListTable/RegistryArtifactListTable.module.scss.d.ts</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/RegistryArtifactListTable/RegistryArtifactListTable.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/RegistryArtifactListTable/RegistryArtifactListTableCell.tsx</FILE>
        <FILE>web/src/ar/pages/artifact-list/components/RegistryArtifactListTable/utils.ts</FILE>
        <FILE>web/src/ar/pages/artifact-list/constants.ts</FILE>
        <FILE>web/src/ar/pages/artifact-list/strings/strings.en.yaml</FILE>
        <FILE>web/src/ar/pages/artifact-list/utils.ts</FILE>
        <FILE>web/src/ar/pages/digest-list/components/DigestListTable/DigestListTable.module.scss</FILE>
        <FILE>web/src/ar/pages/digest-list/components/DigestListTable/DigestListTable.tsx</FILE>
        <FILE>web/src/ar/pages/digest-list/components/DigestListTable/DigestTableCells.tsx</FILE>
        <FILE>web/src/ar/pages/digest-list/strings/strings.en.yaml</FILE>
        <FILE>web/src/ar/pages/repository-details/RepositoryDetails.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/components/Actions/DeleteRepository.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/components/Actions/QuarantineRepository.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/components/Actions/RestoreRepository.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/components/Actions/ScanRepository.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/components/Actions/SetupClient.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/components/Forms/RepositoryConfigurationForm.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/components/Forms/RepositoryCreateForm.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/context/RepositoryProvider.tsx</FILE>
        <FILE>web/src/ar/pages/repository-details/hooks/useCreateRepositoryModal/useCreateRepositoryModal.tsx</FILE>
        <FILE>web/src/ar/pages/repository-list/RepositoryListPage.tsx</FILE>
        <FILE>web/src/ar/pages/repository-list/components/CreateRepository/CreateRepositoryButton.tsx</FILE>
        <FILE>web/src/ar/pages/repository-list/utils.ts</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/DockerRepository/DockerRepositoryUrlInput/DockerRepositoryUrlInput.tsx</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/components/FormContent/UpstreamProxyAuthenticationFormContent.tsx</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/components/Forms/UpstreamProxyConfigurationForm.tsx</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/components/Forms/UpstreamProxyCreateForm.tsx</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/components/Forms/utils.ts</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/components/UpstreamProxyActions/DeleteUpstreamProxy.tsx</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/components/UpstreamProxyActions/RestoreUpstreamProxy.tsx</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/components/UpstreamProxyActions/ScanUpstreamProxy.tsx</FILE>
        <FILE>web/src/ar/pages/upstream-proxy-details/hooks/useCreateUpstreamProxyModal/useCreateUpstreamProxyModal.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/DockerArtifactSSCAContent.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/DockerArtifactSecurityTestsContent.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/DockerDeploymentsContent.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/DockerVersion.module.scss</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/DockerVersion.module.scss.d.ts</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/DockerVersionType.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentOverviewCards/DeploymentOverviewCards.module.scss</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentOverviewCards/DeploymentOverviewCards.module.scss.d.ts</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentOverviewCards/DeploymentOverviewCards.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentsTable/DeploymentsTable.module.scss</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentsTable/DeploymentsTable.module.scss.d.ts</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentsTable/DeploymentsTable.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentsTable/DeploymentsTableCells.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentsTable/types.ts</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/DeploymentsTable/utils.ts</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/OverviewCards/OverviewCards.module.scss</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/OverviewCards/OverviewCards.module.scss.d.ts</FILE>
        <FILE>web/src/ar/pages/version-details/DockerVersion/components/OverviewCards/OverviewCards.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/components/DeploymentsCard/DeploymentsCard.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/components/SecurityTestsCard/SecurityItem.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/components/SupplyChainCard/SupplyChainCard.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/components/VersionDetailsTabs/VersionDetailsTab.module.scss</FILE>
        <FILE>web/src/ar/pages/version-details/components/VersionDetailsTabs/VersionDetailsTab.module.scss.d.ts</FILE>
        <FILE>web/src/ar/pages/version-details/components/VersionDetailsTabs/VersionDetailsTabs.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/components/VersionDetailsTabs/constants.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/context/VersionProvider.tsx</FILE>
        <FILE>web/src/ar/pages/version-details/strings/strings.en.yaml</FILE>
        <FILE>web/src/ar/pages/version-list/DockerVersion/VersionListTable/DockerVersionListTable.module.scss</FILE>
        <FILE>web/src/ar/pages/version-list/components/VersionListTable/VersionListCell.tsx</FILE>
        <FILE>web/src/ar/pages/version-list/components/VersionListTable/VersionListTable.module.scss</FILE>
        <FILE>web/src/ar/strings/strings.en.yaml</FILE>
        <FILE>web/src/ar/strings/types.ts</FILE>
        <FILE>web/yarn.lock</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
