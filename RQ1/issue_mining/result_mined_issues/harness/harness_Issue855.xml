<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>855</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/855</ISSUEURL>
  <TITLE>GitLab Refresh Tokens &amp; Concurrency</TITLE>
  <DESCRIPTION>When the `access_token` is refreshed GitLab also sends a new `refresh_token`. This is a perfectly valid (but optional) implementation detail: &gt; the authorization server MAY issue a new refresh token, in which case the client MUST discard the old refresh token and replace it with the new refresh token. When GitLab sends back a new `refresh_token` it also immediately expires the old `refresh_token`. This is also a perfectly valid (but optional) implementation detail: &gt; The authorization server MAY revoke the old refresh token after issuing a new refresh token to the client. This becomes problematic for systems that are making concurrent requests to the API. It is possible for two threads (or in our case goroutines) to successfully refresh an access_token around the same time. This means one thread will have an expired set of tokens that it cannot refresh. This gets more complicated because we are making these requests offline. This means if we achieve the above race condition, we could get locked out of the API forever until the user physically goes to the website and re-authenticates. There really isn't a good way to handle this in a concurrent, offline environment. We could try to implement mutexes, but even this is subject to edge cases (ie program quits un-unexpectedly) and breaks down if you have clustered servers. I believe we need to engage GitLab for this. One example of a middle ground could be providing `access_type=offline` (similar to Google) that would prevent sending a new `refresh_token` when refreshing an `access_token`. Another option would be to more closely mirror GitHub and never expire an access token. It looks like this is possible (see https://github.com/doorkeeper-gem/doorkeeper/pull/76) but I'm not sure they would be willing to make such a drastic policy change.</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>203</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>update:[code:1204]: CodeOwners Avatar to display name and email on hover (#896)</MESSAGE>
    <SHA>0a4d370676e6738a917da756ed873144866b4aa3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[CODE-1144] UI : Added author filter on PR page (#855)</MESSAGE>
      <SHA>d3fe654e2395e30cbd4b4aa30e94dcb18418c0b3</SHA>
      <PATCHEDFILES>
        <FILE>web/src/pages/PullRequests/PullRequests.tsx</FILE>
        <FILE>web/src/pages/PullRequests/PullRequestsContentHeader/PullRequestsContentHeader.tsx</FILE>
        <FILE>web/src/services/config.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
