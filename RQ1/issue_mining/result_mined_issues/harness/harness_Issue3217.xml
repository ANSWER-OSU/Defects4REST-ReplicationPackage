<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3217</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/3217</ISSUEURL>
  <TITLE>drone list at most 100 repos from gitee.com</TITLE>
  <DESCRIPTION>&lt;!-- PLEASE READ BEFORE DELETING Bugs or Issues? Please create a new topic in our Discourse forum. We are migrating all Drone repositories to Discourse for bug tracking. New GitHub issues may be automatically deleted. https://discourse.drone.io/ https://discourse.drone.io/c/bugs https://discourse.drone.io/c/ideas Failing Builds? Please do not use GitHub issues for generic support questions. Instead please use Stack Overflow: http://stackoverflow.com/questions/tagged/drone.io --&gt; # Expected Behavior After finishing configure gitee's OAuth2 for drone, drone server syncs all repos from gitee.com. # Current Behavior After finishing configure gitee's OAuth2 for drone, drone server only syncs at most 100 repos. # Context drone version: v1.12.1 # detail description After checking source code from drone/service/repo/repo.go +52: ```go repos := []*core.Repository{} opts := scm.ListOptions{Size: 100} for { result, meta, err := s.client.Repositories.List(ctx, opts) if err != nil { return nil, err } for _, src := range result { if src != nil { repos = append(repos, convertRepository(src, s.visibility, s.trusted)) } } opts.Page = meta.Page.Next opts.URL = meta.Page.NextURL if opts.Page == 0 &amp;&amp; opts.URL == &quot;&quot; { break } } ``` I find that drone actually tries to sync all repos even if there is pagination in repo api. So I check the implementation from go-scm:v1.21.1, which is the dependant version for drone, and found an error in the source from go-scm/scm/drivce/gitee/gitee.go +128: ```go func populatePageValues(req *scm.Request, resp *scm.Response) { last, totalError := strconv.Atoi(resp.Header.Get(&quot;total_page&quot;)) reqURL, err := url.Parse(req.Path) if err != nil { return } current, currentError := strconv.Atoi(reqURL.Query().Get(&quot;page&quot;)) if totalError != nil &amp;&amp; currentError != nil { return } resp.Page.First = 1 if last != 0 { resp.Page.Last = last } if current != 0 { if current &lt; resp.Page.Last { resp.Page.Next = current + 1 } else { resp.Page.Next = resp.Page.Last } if current &gt; resp.Page.First { resp.Page.Prev = current - 1 } else { resp.Page.Prev = resp.Page.First } } } ``` The Page.Next will be 2 when total_page &gt; 1 and not page option is given as drone implement, which results in only 100 repos are accessed for gitee.com # Possible Solution After upgrading go-scm from v.1.21.1 to v.1.23.0, the problem could be solved.</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>23</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix: [AH-821] fix unexpected incorrect route after creation of registry (#3225) * fix: [AH-821] fix unexpected incorrect route after creation of registry</MESSAGE>
    <SHA>03a064bdfb93739d377930e78e399136386ef48d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: [AH-578]: Fixed Sort By DownloadCount | Gitness (#3217) * fix: [AH-578]: Fixed Sort By DownloadCount * fix: [AH-578]: Fixed Sort By DownloadCount * fix: [AH-578]: Fixed Sort By DownloadCount</MESSAGE>
      <SHA>dec251e3855f6a606fa0840f5651e67737962dd5</SHA>
      <PATCHEDFILES>
        <FILE>registry/app/api/controller/metadata/utils.go</FILE>
        <FILE>registry/app/store/database/tag.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
