<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>895</ISSUENO>
  <ISSUEURL>https://github.com/harness/harness/issues/895</ISSUEURL>
  <TITLE>Store build number in database, remove sha + branch unique index</TITLE>
  <DESCRIPTION>I propose we start storing `ref` field with the commit record. This is a better way to uniquely identify commits, pull requests, branches, tags, etc. This is a pre-requisite if we want to support building, testing, and deploying tags. The commit+ref is a much better unique identifier than commit+branch: ``` cd1fed3d5344d49f1e913f9b6c03ebd2296f8855 refs/heads/master c3966b1a59b542e3337b02e05819a918d0fd444e refs/heads/matrix 4c7cd974219774b380820171e39b94f2a15da49d refs/tags/v0.2.0 55a99f1ebc45766ca31d197f6009e7a25b7e55f5 refs/tags/v0.2.1 8d6a233744a5dcacbf2605d4592a4bfe8b37320d refs/pull/877/merge ``` ### database changes We could image a database change like this: ``` diff var commitTable = ` CREATE TABLE IF NOT EXISTS commits ( commit_id INTEGER PRIMARY KEY AUTOINCREMENT ,repo_id INTEGER ,commit_status VARCHAR(255) ,commit_started INTEGER ,commit_finished INTEGER ,commit_duration INTEGER + ,commit_ref VARCHAR(255) ,commit_sha VARCHAR(255) ,commit_branch VARCHAR(255) ,commit_pr VARCHAR(255) ,commit_author VARCHAR(255) ,commit_gravatar VARCHAR(255) ,commit_timestamp VARCHAR(255) ,commit_message VARCHAR(255) ,commit_yaml BLOB ,commit_created INTEGER ,commit_updated INTEGER + ,UNIQUE(commit_sha, commit_ref, repo_id) - ,UNIQUE(commit_sha, commit_ref, repo_id) ); ` ``` **important** the actual implementation will differ from above. We will need to ensure that we can migrate older versions of Drone. Therefore we should probably `drop` and then `add` the unique index. We should also populate the `commit_ref` field for older records before adding the unique index. ### rest changes We may need to update the restful API accordingly. Let's figure out a strategy here before we proceed. I'm not quite sure how we want to represent this in the URL.</DESCRIPTION>
  <REPONAME>harness</REPONAME>
  <TIMEDIFFERENCEDAYS>49</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>UI [CODE-1216] : Fix modal close and disable side menu on comment deletion (#913)</MESSAGE>
    <SHA>b24729d608fe10c5cfa8cff7c87ff61413b90df2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[CODE-1159] UI to disable public repo creation with a flag - GITNESS_PUBLIC_RESOURCE_CREATION_ENABLED (#895)</MESSAGE>
      <SHA>cb817bf2ad064be7fb21ae004caccc247a3dc570</SHA>
      <PATCHEDFILES>
        <FILE>web/src/components/NewRepoModalButton/ImportForm/ImportForm.tsx</FILE>
        <FILE>web/src/components/NewRepoModalButton/NewRepoModalButton.tsx</FILE>
        <FILE>web/src/pages/RepositorySettings/GeneralSettingsContent/GeneralSettingsContent.tsx</FILE>
        <FILE>web/src/utils/GitUtils.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
