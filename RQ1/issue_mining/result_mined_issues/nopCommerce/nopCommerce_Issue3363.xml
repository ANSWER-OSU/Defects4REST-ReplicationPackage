<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3363</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/3363</ISSUEURL>
  <TITLE>Performance issues when having 100 items in ShoppingCart</TITLE>
  <DESCRIPTION>Hi, i'm currently building a B2B shop and some customer place pretty large order (many products), in some rare cases over 200 products but pretty much all of them is between 50-100 products. After some debugging the whole /Cart method i found 2 big performance impacts in the ShoppingCartModelFactory, and i guess both gets slow because of lazy loading. Line 372: `cartItemModel.DisableRemoval = cart.Any(item =&gt; item.Product.RequireOtherProducts &amp;&amp; _productService.ParseRequiredProductIds(item.Product).Contains(sci.ProductId));` Takes 1086 ms Line 454: `var itemWarnings = _shoppingCartService.GetShoppingCartItemWarnings( _workContext.CurrentCustomer, sci.ShoppingCartType, sci.Product, sci.StoreId, sci.AttributesXml, sci.CustomerEnteredPrice, sci.RentalStartDateUtc, sci.RentalEndDateUtc, sci.Quantity, false, sci.Id);` Takes 1132 ms Both of these are run per product, so a total of around 200+ seconds to load the /Cart page with 100 products. nopCommerce version: 4.10 Steps to reproduce the problem: 1. Clean installation 2. Create products 3. Place them all in the shopping cart 4. Visit /cart</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>158</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'develop' of https://github.com/nopSolutions/nopCommerce into develop</MESSAGE>
    <SHA>7ab77350242ac036c67ab9d5b432cd05a1f79373</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#3363 Performance optimization. Do not load attribute combinations if no attributes selected (e.g. no attributes exist)</MESSAGE>
      <SHA>3f5bdf5e5aae952ca193f20bff1b46a413108f96</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Catalog/ProductAttributeParser.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3363 Performance optimization when having many products in shopping cart (e.g. 50 or 100)</MESSAGE>
      <SHA>3451cb8fd985ce798c871311248ca7f5d1911e26</SHA>
      <PATCHEDFILES>
        <FILE>src/Presentation/Nop.Web/Controllers/ShoppingCartController.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Factories/ShoppingCartModelFactory.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3363 Performance optimization. Cache a value indicating whether a product has attributes (globally, not on a product details page only like we did before). It increases performance of the shopping cart and chekout pages</MESSAGE>
      <SHA>4ffbd11858873f44350786656144fb9ae9f0e66f</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Catalog/NopCatalogDefaults.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Catalog/ProductAttributeService.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Factories/ProductModelFactory.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Infrastructure/Cache/ModelCacheEventConsumer.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Infrastructure/Cache/NopModelCacheDefaults.cs</FILE>
        <FILE>src/Tests/Nop.Services.Tests/Catalog/ProductAttributeParserAndFormatterTests.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
