<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>80</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/80</ISSUEURL>
  <TITLE>Performance optimization. PictureService.GetPictureUrl optimization (critical if pictures are inside database)</TITLE>
  <DESCRIPTION>[AM] Below code can be skipped if a store owner enables &quot;pictures stored on file system&quot;. It's much simpler and does not require additional SQL request I was rewriting my plugin to generate feed for yandex market. And found that my plugin generates it extremely slow because PictureService.GetPictureUrl function is executing very slowly. Later I'v found that it is executed each time shop tries to render page with pictures. The problem it is so slow is that when you have your pictures in database nopcommerce will load &quot;Picture&quot; object from database table including picture binary data (that is not so small always). The idea is to skip this loading for pictures that already have thumbs generated and available for users download. This optimization should also significantly increase shop page renders (because pictures are everywhere). Changed PictureService.cs included. Changes: Added: ``` public class littlepic { public bool IsNew { get; set; } public string MimeType {get; set;} public string SeoFilename { get; set; } } ``` for selected data load from database. Function changed: ``` public virtual string GetPictureUrl(int pictureId, int targetSize = 0, bool showDefaultPicture = true, string storeLocation = null, PictureType defaultPictureType = PictureType.Entity) { //first try to get url and check if file exist. if yes then return url, if not then use slow procedure //TODO validate &quot;pictureId == 0&quot; littlepic pic = _pictureRepository.Table.Where(x =&gt; x.Id == pictureId).Select(x =&gt; new littlepic() {IsNew = x.IsNew, MimeType = x.MimeType, SeoFilename = x.SeoFilename }).FirstOrDefault(); if (pic != null &amp;&amp; !pic.IsNew &amp;&amp; targetSize == 0){ string lastPart = GetFileExtensionFromMimeType(pic.MimeType); string thumbFileName; string seoFileName = pic.SeoFilename; thumbFileName = !String.IsNullOrEmpty(seoFileName) ? string.Format(&quot;{0}_{1}.{2}&quot;, pictureId.ToString(&quot;0000000&quot;), seoFileName, lastPart) : string.Format(&quot;{0}.{1}&quot;, pictureId.ToString(&quot;0000000&quot;), lastPart); var thumbFilePath = GetThumbLocalPath(thumbFileName); if (File.Exists(thumbFilePath)) { string url = GetThumbUrl(thumbFileName, storeLocation); return url; } } var picture = GetPictureById(pictureId); return GetPictureUrl(picture, targetSize, showDefaultPicture, storeLocation, defaultPictureType); } ``` [PictureService.zip](https://github.com/nopSolutions/nopCommerce/files/90416/PictureService.zip)</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>192</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>#34 Further changes on the new product details page. &quot;LimitedToStores&quot; property was not properly set</MESSAGE>
    <SHA>6975cf843ff7f54100a5f857500204045df4a076</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#80 PictureService.GetPictureUrl optimization. Performance optimization. Avoid unnecessary loading of binary image data.</MESSAGE>
      <SHA>6e9a9ec549d25b743880d1347faf00d0d105a536</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Media/PictureService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
