<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1964</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/1964</ISSUEURL>
  <TITLE>BrowscapXmlHelper performance issue</TITLE>
  <DESCRIPTION>Intro and details: http://www.nopcommerce.com/boards/t/45428/reducing-the-memory-usage-on-startup.aspx I decided to get to the bottom of this and downloaded the trial version of dotMemory and snapshot the memory usage during the peak time memory consumption (you need to be very quick as the GC may reduce the memory at any point). It turned out the there are 500 MB ... yes 500 MB in Strings allocated in the memory heap. When investigated who allocated so much stings in the memory it turned out that it is the constructor of the BrowscapXmlHelper class. You can easily spot why this happens as there is a huge 40 MB file App_Data\browscap.xml that is being loaded in a String into the memory. Then there are several Replace methods that actually create new strings rather than modifying the existing one. By simply commenting the the Initialize method invocation in the constructor of the BrowscapXmlHelper, then I couldn't make my nopCommerce to take more than 200 MB even after several restarts. So the implementation of the BrowscapXmlHelper class needs to be corrected to ensure all nopCommerce users will run smoothly their nopCommerce websites on a shared hosting. see http://stackoverflow.com/questions/6524528/string-replace-vs-stringbuilder-replace</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>8</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>#1969 Settings for display news and blog comments per stores</MESSAGE>
    <SHA>a7084d60b97d112b6f0d123902650c961cfd3e3e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#1964 The speed of loading user agents was increased and memory usage was reduced</MESSAGE>
      <SHA>f61e692c97385c193092b5a0b42d05973c18c45d</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Helpers/BrowscapXmlParser.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Helpers/UserAgentHelper.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#1964 The ability to create a stripped-down file with user agents is added. It ll save resources on next running the nopCommerce</MESSAGE>
      <SHA>dde91cd9eb15bbfa182eab7eb8b2fd31fbd38d21</SHA>
      <PATCHEDFILES>
        <FILE>.gitignore</FILE>
        <FILE>src/Libraries/Nop.Core/Configuration/NopConfig.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Helpers/BrowscapXmlParser.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Helpers/UserAgentHelper.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Nop.Web.csproj</FILE>
        <FILE>src/Presentation/Nop.Web/Web.config</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
