<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2700</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/2700</ISSUEURL>
  <TITLE>Could not load DiscountRules.CustomerRoles.dll Access is Denied</TITLE>
  <DESCRIPTION>After running the current nop 4.00 develop branch for a few days Nop gets stuck in an infinite reboot/crash state. It usually occurs after 2 days of running without restart. First notice I get is my azure ping test fails, then if you visit the website you get the following stack trace (I have the development env flag set in azure). &gt; An error occurred while starting the application. &gt; &gt; UnauthorizedAccessException: Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED)) &gt; Unknown location &gt; &gt; FileLoadException: Could not load file or assembly 'Nop.Plugin.DiscountRules.CustomerRoles.dll' or one of its dependencies. Access is denied. &gt; System.Reflection.AssemblyName.nGetFileInformation(string s) &gt; &gt; Exception: Plugin 'Must be assigned to customer role'. Could not load file or assembly 'Nop.Plugin.DiscountRules.CustomerRoles.dll' or one of its dependencies. Access is denied. &gt; Nop.Core.Plugins.PluginManager.Initialize(ApplicationPartManager applicationPartManager, NopConfig config) in PluginManager.cs, line 622 &gt; &gt; Exception: Plugin 'Must be assigned to customer role'. Could not load file or assembly 'Nop.Plugin.DiscountRules.CustomerRoles.dll' or one of its dependencies. Access is denied. &gt; Could not load file or assembly 'Nop.Plugin.DiscountRules.CustomerRoles.dll' or one of its dependencies. Access is denied. &gt; Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED)) &gt; Nop.Core.Plugins.PluginManager.Initialize(ApplicationPartManager applicationPartManager, NopConfig config) in PluginManager.cs, line 633 &gt; &gt; UnauthorizedAccessException: Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED)) &gt; &gt; Show raw exception details &gt; FileLoadException: Could not load file or assembly 'Nop.Plugin.DiscountRules.CustomerRoles.dll' or one of its dependencies. Access is denied. &gt; System.Reflection.AssemblyName.nGetFileInformation(string s) &gt; System.Reflection.AssemblyName.GetAssemblyName(string assemblyFile) &gt; Nop.Core.Plugins.PluginManager.PerformFileDeploy(FileInfo plug, ApplicationPartManager applicationPartManager) in PluginManager.cs &gt; Nop.Core.Plugins.PluginManager.Initialize(ApplicationPartManager applicationPartManager, NopConfig config) in PluginManager.cs &gt; &gt; Show raw exception details &gt; Exception: Plugin 'Must be assigned to customer role'. Could not load file or assembly 'Nop.Plugin.DiscountRules.CustomerRoles.dll' or one of its dependencies. Access is denied. &gt; Nop.Core.Plugins.PluginManager.Initialize(ApplicationPartManager applicationPartManager, NopConfig config) in PluginManager.cs &gt; &gt; Show raw exception details &gt; Exception: Plugin 'Must be assigned to customer role'. Could not load file or assembly 'Nop.Plugin.DiscountRules.CustomerRoles.dll' or one of its dependencies. Access is denied. Could not load file or assembly 'Nop.Plugin.DiscountRules.CustomerRoles.dll' or one of its dependencies. Access is denied. Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED)) &gt; Nop.Core.Plugins.PluginManager.Initialize(ApplicationPartManager applicationPartManager, NopConfig config) in PluginManager.cs &gt; Nop.Core.Infrastructure.NopEngine.Initialize(IServiceCollection services) in NopEngine.cs &gt; Nop.Web.Framework.Infrastructure.Extensions.ServiceCollectionExtensions.ConfigureApplicationServices(IServiceCollection services, IConfigurationRoot configuration) in ServiceCollectionExtensions.cs &gt; Nop.Web.Startup.ConfigureServices(IServiceCollection services) in Startup.cs &gt; System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw() &gt; Microsoft.AspNetCore.Hosting.ConventionBasedStartup.ConfigureServices(IServiceCollection services) &gt; Microsoft.AspNetCore.Hosting.Internal.WebHost.EnsureApplicationServices() &gt; Microsoft.AspNetCore.Hosting.Internal.WebHost.BuildApplication() &gt; Restarting the webapp in the azure portal does not fix the issue. Stopping the webapp, waiting 10 seconds then starting it again fixes the issue. I am not using discount rules anywhere in my site so I have uninstalled and deleted any plugins referenced in the above stack trace. Can you see why this would occur only after 2 days of running? It appears to be a permission issue, is it possible a web crawler/robot is viewing a specific page and triggering this? Also the stack trace above does not show up in the nop error log. Do you know why this specific stack trace is not getting logged?</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>9</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Updated third-party libraries to the latest version</MESSAGE>
    <SHA>7d3b30b1419bbbe81aea109cc78c3c9b7ad73708</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#2700 Added option to load an assembly bypassing some security checks</MESSAGE>
      <SHA>47276d0bee879652178194d6e8c40b48b9e721cc</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Configuration/NopConfig.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Plugins/PluginManager.cs</FILE>
        <FILE>src/Presentation/Nop.Web/appsettings.json</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
