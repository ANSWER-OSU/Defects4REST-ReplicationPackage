<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1780</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/1780</ISSUEURL>
  <TITLE>PayPalStandard and PDT (IPN) validation</TITLE>
  <DESCRIPTION>We are having some problems with PayPalStandard plugin that I'd like to discuss and see if you've gone through something similar. In one of our NopCommerce instances we have the setting RoundPricesDuringCalculation set to FALSE. This has allowed us to solve some rounding issues and to reflect more accurate computations. In PayPalStandard PostProcessPayment method, the prices of the products, shipping, payment and taxes are rounded in each step and sent to PayPal. The RoundPricesDuringCalculation = FALSE circumstance is not checked, and precission is lost in every step. After the processing, if everything is correct PayPal will send back an mc_gross field, with the total of the order. If we assume that we're using PDTHandler (at PaymentPayPalStandardController) we can activate PdtValidateOrderTotal setting to check that the total provided by PayPal and the total stored in the database match. In my case, this validation (that is very important because it allow us to avoid some fraud cases) usually fails because there is a slight differente between the amounts: - (payPalStandardPaymentSettings.PdtValidateOrderTotal &amp;&amp; !Math.Round(total, 2).Equals(Math.Round(order.OrderTotal, 2))) - PayPal PDT. Returned order total 29,50 doesn't equal order total 29,4847 As you can see, the order total amount is perfectly valid, but the comparison fails. I'm assuming that quantities are transfered to PayPal with only two decimal places because it has to be like that. But, if it has to be like that, isn't this comparison too strict?. Shouldn't it allow a small deviation?. And also, does anybody know why this check is performed in the PDTHandler but not in the IPNHandler?. As far as I know, it seems that mc_gross is returned by PayPal in both methods. Source: http://www.nopcommerce.com/boards/t/35862/concerns-about-paypalstandard-and-rounding.aspx</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>77</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'issue-1964-BrowscapXmlHelper-performance-issue' into develop</MESSAGE>
    <SHA>7717e979ecca70c5f552cbf29fa642a530d026c4</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#1780 Properly order total validation in PayPalStandard plugin</MESSAGE>
      <SHA>8ab3464707db5ec8384c6c5195409e6fc3e0bc5e</SHA>
      <PATCHEDFILES>
        <FILE>src/Plugins/Nop.Plugin.Payments.PayPalStandard/Controllers/PaymentPayPalStandardController.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#1780 Properly order total validation related to inaccurate rounding of PayPal</MESSAGE>
      <SHA>4f09c7ed2f891f6f5450c686352d1a0bb2970857</SHA>
      <PATCHEDFILES>
        <FILE>src/Plugins/Nop.Plugin.Payments.PayPalStandard/Controllers/PaymentPayPalStandardController.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Payments.PayPalStandard/Description.txt</FILE>
        <FILE>src/Plugins/Nop.Plugin.Payments.PayPalStandard/PayPalStandardPaymentProcessor.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Payments.PayPalStandard/Views/Configure.cshtml</FILE>
        <FILE>upgradescripts/3.80-the next version/upgrade.sql</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
