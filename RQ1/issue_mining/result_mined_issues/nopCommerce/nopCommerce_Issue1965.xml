<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1965</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/1965</ISSUEURL>
  <TITLE>Tax calculation. Allow to choose which address to use &quot;Default tax address&quot; or &quot;Pickup point&quot; address</TITLE>
  <DESCRIPTION>Allow a store owner to choose which address to use to calculate tax when pickup in store option is chosen - &quot;Default tax address&quot; or &quot;Pickup point&quot; address put logic into CreateCalculateTaxRequest. Some draft is below: if (_taxSettings.UsePickupPointAddressWhenChosen &amp;&amp; _shippingSettings.AllowPickUpInStore) { var pickupPoint = customer.GetAttribute&lt;PickupPoint&gt;(SystemCustomerAttributeNames.SelectedPickupPoint, _storeContext.CurrentStore.Id); if (pickupPoint != null) { //should we do this validation? var cart = _workContext.CurrentCustomer.ShoppingCartItems .Where(sci =&gt; sci.ShoppingCartType == ShoppingCartType.ShoppingCart) .LimitPerStore(_storeContext.CurrentStore.Id) .ToList(); if (cart.RequiresShipping()) { var country = _countryService.GetCountryByTwoLetterIsoCode(pickupPoint.CountryCode); var state = _stateProvinceService.GetStateProvinceByAbbreviation(pickupPoint.StateAbbreviation); address = new Address { Address1 = pickupPoint.Address, City = pickupPoint.City, Country = country, StateProvince = state, ZipPostalCode = pickupPoint.ZipPostalCode, CreatedOnUtc = DateTime.UtcNow, }; } } }</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>63</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'issue-1806-add-description-to-message-templates' into develop</MESSAGE>
    <SHA>a178aea1c866134def36957fae4f70f4bf852e05</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#1965 Settings for using pickup point address for tax calculation</MESSAGE>
      <SHA>13022cd7d86f506507fafc43ab068b33ac0f9a25</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Domain/Tax/TaxSettings.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Installation/CodeFirstInstallationService.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Tax/TaxService.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Administration/Controllers/SettingController.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Administration/Infrastructure/Mapper/AdminMapperConfiguration.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Administration/Models/Settings/TaxSettingsModel.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Administration/Views/Setting/Tax.cshtml</FILE>
        <FILE>src/Presentation/Nop.Web/App_Data/Localization/defaultResources.nopres.xml</FILE>
        <FILE>src/Tests/Nop.Services.Tests/Orders/OrderProcessingServiceTests.cs</FILE>
        <FILE>src/Tests/Nop.Services.Tests/Orders/OrderTotalCalculationServiceTests.cs</FILE>
        <FILE>src/Tests/Nop.Services.Tests/Tax/TaxServiceTests.cs</FILE>
        <FILE>upgradescripts/3.80-the next version/upgrade.sql</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
