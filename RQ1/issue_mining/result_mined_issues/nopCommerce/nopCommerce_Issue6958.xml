<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6958</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/6958</ISSUEURL>
  <TITLE>QueuedEmails: Emails not locked while processing</TITLE>
  <DESCRIPTION>nopCommerce version: 4.60.x Steps to reproduce the problem: 1. Setup a small and slow email server (in our case a on-prem hosted exchange server from one of our customers) 2. Setup the tasks to send emails to run every minute (as per nop defaults, same for the task timeout) 3. Create a new email campaign / newsletter (about 400 recipients in our case, only customers who signed up to the newsletter this year) 4. Send the email campaign As the email tasks always fetches the first 500 not send emails, in our case, each minute, the task fetched all 400 emails. In our case the total duration to send all emails was about 25 minutes (first to last email send). The tasks scheduler spins up a new task every minute, but does not appear to shut down the previous task correctly. This means that in our case we had about 20 tasks running in parallel at some time all processing the same emails (because they are only fetched from the database while the task is booting up). This resulted in multiple of our customers being notified up to 20 times with the same campaign / newsletter email. This irritated a lot of customers of this store and made the store owner truly unhappy to notify so many customers. --- We would expect that each email that is picked up in a task is &quot;locked&quot; in some kind, so that a task starting after the current task, knows to skip all those &quot;locked&quot; emails. And while we are underway we should probably also remove the hardcoded limit of 500 emails that are fetch for each task execution.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>10</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'issue-5136-Check-availability-entities-when-get-mappings' into develop</MESSAGE>
    <SHA>bc8c9b882c11bb0b94637427d1834187e8420a67</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#6958 Added setting for control number of email which sending on one time</MESSAGE>
      <SHA>3808a56931ee7cbcb180678f2679d376d8cee72c</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Domain/Messages/EmailAccount.cs</FILE>
        <FILE>src/Libraries/Nop.Data/Migrations/UpgradeTo470/SchemaMigration.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Messages/QueuedMessagesSendTask.cs</FILE>
        <FILE>src/Presentation/Nop.Web.Framework/Migrations/UpgradeTo470/LocalizationMigration.cs</FILE>
        <FILE>src/Presentation/Nop.Web/App_Data/Localization/defaultResources.nopres.xml</FILE>
        <FILE>src/Presentation/Nop.Web/Areas/Admin/Factories/EmailAccountModelFactory.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Areas/Admin/Models/Messages/EmailAccountModel.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Areas/Admin/Validators/Messages/EmailAccountValidator.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Areas/Admin/Views/EmailAccount/_CreateOrUpdate.cshtml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#6958 Minor formatting</MESSAGE>
      <SHA>7645a42c0b1568319599be2e5a9f8e093ff5d6fd</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Domain/Messages/EmailAccount.cs</FILE>
        <FILE>src/Libraries/Nop.Data/Migrations/UpgradeTo470/SchemaMigration.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Messages/QueuedMessagesSendTask.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
