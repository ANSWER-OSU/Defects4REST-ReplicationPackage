<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1754</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/1754</ISSUEURL>
  <TITLE>Allow running AutoMapper configuration in plugins</TITLE>
  <DESCRIPTION>**Summary** We need a way to configure `AutoMapper` in plugins. I propose to push `AutoMapperConfiguration` into Nop.Core and add an `AddConfiguration()` method. **Explanation** I have just been working through upgrading our nopcommerce plugins from 3.70 to 3.80 and have run into one significant issue. Previously, we were using AutoMapper extensively to map our Entities to ViewModels etc. We ran the configuration code in an `IStartupTask` that would do all the appropriate `CreateMap` calls which worked smoothly. In the latest upgrade to AutoMapper 5.0, as I'm sure you realise, the static Mapper interface has been replaced with an instance method, and has a requirement for all configuration to be performed as part of a single initialisation method. Currently you have a `IStartupTask` that performs all the configuration in the Nop.Admin project by calling `AutoMapperConfiguration.Init()`. Somehow we need a decoupled way of providing additional configuration to the `AutoMapperConfiguration.Init` method. There's a number of ways this could work, but one possibility would be to push the static `AutoMapperConfiguration` class down the project stack and into Nop.Core. It could have a public collection of configuration methods that `IStartupTasks` can add to, or better still an `AddConfiguration(Action&lt;IMapperConfigurationAction&gt; configureAction)` method that pushes into a private list. You could then call `AutoMapperConfiguration.Init()` in `NopEngine.Initialize()` once all `IStartupTasks` have run, which will create a new `MapperConfiguration` using the provided configActions, and call `CreateMapper()`. It still feels a little messy, but I think it's possibly the cleanest solution? I'm happy to put together a pull request if you agree.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>#117 Use REST API for PayPal Direct Payment plugin</MESSAGE>
    <SHA>99d15fa81e4142c0017d0e3d228f8bed40bf82ca</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#1754 Refactoring of mapping rules (AutoMapper). Now we can multiple mappers (plugin developers can use it). Each mapper should implement IMapperConfiguration interface.</MESSAGE>
      <SHA>0080e01bfd5c05b0a6bfd6b5adbbb41757befd5f</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Infrastructure/Mapper/AutoMapperConfiguration.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Infrastructure/Mapper/IMapperConfiguration.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Infrastructure/NopEngine.cs</FILE>
        <FILE>src/Libraries/Nop.Core/Nop.Core.csproj</FILE>
        <FILE>src/Libraries/Nop.Core/packages.config</FILE>
        <FILE>src/Presentation/Nop.Web/Administration/Extensions/MappingExtensions.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Administration/Infrastructure/Mapper/AdminMapperConfiguration.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Administration/Infrastructure/Mapper/AutoMapperStartupTask.cs</FILE>
        <FILE>src/Presentation/Nop.Web/Administration/Nop.Admin.csproj</FILE>
        <FILE>src/Tests/Nop.Web.MVC.Tests/Admin/Infrastructure/AutoMapperConfigurationTest.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#1754 Further changes (source code typo fixed)</MESSAGE>
      <SHA>500c69e531a78de4909c318606b4f6e235edf107</SHA>
      <PATCHEDFILES>
        <FILE>src/Presentation/Nop.Web/Administration/Infrastructure/Mapper/AdminMapperConfiguration.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#1754 Further changes on refactoring of mapping rules (AutoMapper)</MESSAGE>
      <SHA>e987f90ae926ffa9681f6afebccc6c071b2be421</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Infrastructure/NopEngine.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
