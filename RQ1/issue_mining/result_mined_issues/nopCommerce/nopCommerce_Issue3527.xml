<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3527</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/3527</ISSUEURL>
  <TITLE>Refactoring and bug fixes for TaxService</TITLE>
  <DESCRIPTION>Nopcommerce uses the method GetProductPrice for calculation any prices. 1. IsEuConsumer (It's a big fix for store's from Europe) This method GetProductPrice uses method IsEuConsumer for each checking prices (one time for each price) It's better to save the result of first request in local cache (per request) protected virtual bool IsEuConsumer(Customer customer) { //check the cached value .... } But I think it's better to move this method to class IWorkContext and save the result of the first request for all next requests. 2. Method CreateCalculateTaxRequest a) cosmetic fix, remove this old line. it's not reasonable to use it now. var overriddenBasedOn = _taxSettings.EuVatEnabled //EU VAT enabled? &amp;&amp; product != null &amp;&amp; product.IsTelecommunicationsOrBroadcastingOrElectronicServices //telecommunications, broadcasting and electronic services? &amp;&amp; DateTime.UtcNow &gt; new DateTime(2015, 1, 1, 0, 0, 0, DateTimeKind.Utc) //January 1st 2015 passed? &amp;&amp; IsEuConsumer(customer); //Europe Union consumer? b) Big fix if we use pickup in store. var pickupPoint = _genericAttributeService.GetAttribute&lt;PickupPoint&gt;(customer, NopCustomerDefaults.SelectedPickupPointAttribute, _storeContext.CurrentStore.Id); if (pickupPoint != null) { var country = _countryService.GetCountryByTwoLetterIsoCode(pickupPoint.CountryCode); var state = _stateProvinceService.GetStateProvinceByAbbreviation(pickupPoint.StateAbbreviation, country?.Id); for each price calculation we check if customer selected PickupPoint and try to get country and state value from SQL for this PickupPoint. It's many small SQL requests (two for each price, one for country and another for state). Can we save address of each pickupPoint in static cache? c) Big fix calculateTaxRequest.Address = _addressService.GetAddressById(_taxSettings.DefaultTaxAddressId); I agree the we saved to local cache the address after first request. Can we store the result of this request in shared cache (static cache)? If we have many requests from many customers we have three SQL requests to database. d) big fix ITaxProvider LoadActiveTaxProvider(Customer customer = null) or ITaxProvider LoadTaxProviderBySystemName(string systemName) For each price calculation we try to get default TAX provider var taxProvider = LoadTaxProviderBySystemName(_taxSettings.ActiveTaxProviderSystemName) ?? LoadAllTaxProviders(customer).FirstOrDefault(); return taxProvider; We need to save it in local value of TaxService class after first request or share this local value between all customers. I think it's better. Source: https://www.nopcommerce.com/boards/t/57914/performance-optimization-very-small-and-bix-fixes-for-taxservice.aspx</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>55</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>#1647 Further changes on admin area re-design. The tax settings page had duplicated content</MESSAGE>
    <SHA>cf8950045d4db0159362990a96a0da2f3eb1c3c0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#3527 Performance optimization. Cache a country loaded by ID during HTTP request</MESSAGE>
      <SHA>89a4be42a36466cb6b2f15c2ac8817bec9f9a4dc</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Directory/CountryService.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Directory/NopDirectoryDefaults.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3527 Performance optimization. Do not load a default tax address for each HTTP request.</MESSAGE>
      <SHA>6d35444f9423b5215946a5c3b1603241d63d7262</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Tax/Cache/TaxCacheEventConsumer.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Tax/CalculateTaxRequest.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Tax/ITaxService.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Tax/NopTaxDefaults.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Tax/TaxService.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Tax.FixedOrByCountryStateZip/FixedOrByCountryStateZipTaxProvider.cs</FILE>
        <FILE>src/Plugins/Nop.Plugin.Tax.FixedOrByCountryStateZip/plugin.json</FILE>
        <FILE>src/Tests/Nop.Services.Tests/Orders/OrderProcessingServiceTests.cs</FILE>
        <FILE>src/Tests/Nop.Services.Tests/Orders/OrderTotalCalculationServiceTests.cs</FILE>
        <FILE>src/Tests/Nop.Services.Tests/Tax/TaxServiceTests.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#3527 Performance optimization. Cache loaded states and countries (previously they could be loaded multiple times during the same HTTP request)</MESSAGE>
      <SHA>b4f5b5d5cc630cea783f3124a5ab612b291987e9</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Directory/CountryService.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Directory/NopDirectoryDefaults.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Directory/StateProvinceService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
