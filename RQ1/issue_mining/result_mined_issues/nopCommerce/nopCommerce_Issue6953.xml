<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6953</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/6953</ISSUEURL>
  <TITLE>The header used to retrieve the originating client IP doesn't work</TITLE>
  <DESCRIPTION>nopCommerce version: 4.50.3 We use Cloudflare with our nopCommerce website, Cloudflare's IP address is not properly detected (when the &quot;Store IP addresses&quot; setting is enabled) I found some comments online that said I needed to change the &quot;The header used to retrieve the originating client IP&quot; setting in the &quot;Hosting configuration&quot; section of the App Settings to `CF-Connecting-IP`, which I did, restarted the app, and it is still saving Cloudflare's IP instead of the customer's IP address. I have tried with the &quot;Use proxy servers&quot; setting on and off, with the &quot;CF-Connecting-IP&quot; value saved, and neither fixed the issue. I've even added Cloudflare's IP ranges in the &quot;Addresses of known proxies&quot; and that did not fix the issue. I am seeking clarification regarding the functionality of the 'The header used to retrieve the originating client IP' setting in the 'Hosting configuration' section as even the tooltip says &quot;Specify a custom HTTP header name to determine the originating IP address (e.g., CF-Connecting-IP, X-ProxyUser-Ip).&quot;, but it is not working as described or expected. And yes, if I go to the System Information page and expand the &quot;Headers&quot;, I do see the cf-connecting-ip header. It is being sent as it should from Cloudflare, nopCommerce is just not parsing it. Source: https://www.nopcommerce.com/en/boards/topic/98317/cloudflare-issue</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>#6932 Restored interface compatibility with version 4.60.0</MESSAGE>
    <SHA>426f4d16f0b637162e1c10767ceb6431a6d7f9a6</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#6953 Fixed retrieving of the originating client IP when using proxy servers</MESSAGE>
      <SHA>bc643dd32f145bebfe94068e9cd18fea0ae2b0fc</SHA>
      <PATCHEDFILES>
        <FILE>src/Presentation/Nop.Web.Framework/Infrastructure/Extensions/ApplicationBuilderExtensions.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
