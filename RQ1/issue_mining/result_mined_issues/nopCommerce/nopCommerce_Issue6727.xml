<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6727</ISSUENO>
  <ISSUEURL>https://github.com/nopSolutions/nopCommerce/issues/6727</ISSUEURL>
  <TITLE>Connect Timeout expired. All pooled connections are in use. - large order creation.</TITLE>
  <DESCRIPTION>nopCommerce version: 4.60.3 Steps to reproduce the problem: I'm not sure what the threshold is to cause this. The order I was working with had 432 items on it. Problem is here: `src\Libraries\Nop.Services\Orders\OrderProcessingService.cs` line 1517 (1311 on develop branch) ```cs await Task.WhenAll(details.Cart.ToList().Select(sci =&gt; _shoppingCartService.DeleteShoppingCartItemAsync(sci, false))); ``` Causes threadpool starvation at some point - again, I don't know what the threshold is for it to occur, and it may even differ depending on server hardware. This 'optimization' seems unnecessary as this task seems to be pretty fast so it doesn't need to be parallelized. Especially since it doesn't work in large cart where parallelization would be most useful... I replaced the above code with: ```cs foreach (var sci in details.Cart.ToList()) { await _shoppingCartService.DeleteShoppingCartItemAsync(sci, false); } ``` No more threadpool starvation and it deleted the 432 items quickly.</DESCRIPTION>
  <REPONAME>nopCommerce</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch '4.60-bug-fixes' into develop # Conflicts: # src/Libraries/Nop.Services/Catalog/ProductExtensions.cs</MESSAGE>
    <SHA>008682e0c4f0790e16969aa9f4c1497627e0790f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>#6727 fix for threadpool starvation caused by Task.WhenAll parallel call to _shoppingCartService.DeleteShoppingCartItemAsync</MESSAGE>
      <SHA>831c05164f92cef371ae6e38e3876f2bea9dfb06</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Services/Orders/OrderProcessingService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>#6727 Performance optimization on clearing shopping cart</MESSAGE>
      <SHA>a9c70171822387aac385b5b14896769775a1aeff</SHA>
      <PATCHEDFILES>
        <FILE>src/Libraries/Nop.Core/Domain/Orders/ClearShoppingCartEvent.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Orders/IShoppingCartService.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Orders/OrderProcessingService.cs</FILE>
        <FILE>src/Libraries/Nop.Services/Orders/ShoppingCartService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
