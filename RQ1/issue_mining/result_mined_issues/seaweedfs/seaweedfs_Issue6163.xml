<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6163</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/6163</ISSUEURL>
  <TITLE>Erasure coding that fails due to tight disk space does not clean itself up and leaves the disk full.</TITLE>
  <DESCRIPTION>**Describe the bug** I have a few volume servers that look like they tried to erasure code full volumes, but ran out of disk space. The volume directory now has the 244GB .dat file along with .ec files 00 through 09 which are each 24GB. None of the other volume servers has an ec file for this volume and the volume shows in the web console as being a regular volume still. Is it safe to just delete those files to free up space? I ran volume.move on one of them and the dat file moved, but the ec## files are still there. **System Setup** `weed volume -ip=weedve4 -ip.bind=0.0.0.0 -mserver=weedmb:9333 -port=9334 -metricsPort=9331 -disk hdd -dir=/mnt/weed -dir.idx=/root/weedvol -max 14` - OS version `Linux 6.8.12-2-pve #1 SMP PREEMPT_DYNAMIC PMX 6.8.12-2 (2024-09-05T10:03Z) x86_64 Linux` - output of `weed version` `version 8000GB 3.77 b28b1a34025a2f2ed80883e245250d00783bfea7 linux amd64` **Expected behavior** The erasure coding should not start if there is not enough space. I was bulk loading data while this happened, but with pre-allocation it should have had enough space and it should not have allocated a new volume while the volume was being encoded. If it fails it should clean up the shards if it doesn't get to at least 10 and it should send shards to the other volume servers if it does. The volume is only used for seaweed storage so there are no other processes using space on the volumes. I am using a standard maintenance .toml on the master: ``` lock ec.encode -fullPercent=95 -quietFor=1h ec.rebuild -force ec.balance -force volume.deleteEmpty -quietFor=24h -force volume.balance -force volume.fix.replication s3.clean.uploads -timeAgo=24h unlock ``` Here is the directory of one of the volume servers. The problems here are volids 107, 117, 52, 53, 82 and 93: ``` total 5T drwxrwxrwx 1 nobody nobody 2.7K Oct 23 05:47 . drwxr-xr-x 3 root root 4.0K Sep 25 18:58 .. -rw-r--r-- 1 root root 24.4G Sep 26 04:08 1.ec08 -rw-r--r-- 1 root root 24.4G Sep 26 04:17 1.ec12 -rw-r--r-- 1 root root 157 Sep 26 04:17 1.vif -rw-r--r-- 1 root root 24.4G Oct 8 06:02 10.ec06 -rw-r--r-- 1 root root 24.4G Oct 8 06:08 10.ec07 -rw-r--r-- 1 root root 157 Oct 8 06:08 10.vif -rw-r--r-- 1 root root 244.2G Oct 14 01:31 107.dat -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec00 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec01 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec02 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec03 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec04 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec05 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec06 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec07 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec08 -rw-r--r-- 1 root root 780.8M Oct 16 19:49 107.ec09 -rw-r--r-- 1 root root 139 Oct 12 17:32 107.vif -rw-r--r-- 1 root root 24.4G Oct 8 15:27 11.ec06 -rw-r--r-- 1 root root 24.4G Oct 8 15:34 11.ec07 -rw-r--r-- 1 root root 157 Oct 8 15:34 11.vif -rw-r--r-- 1 root root 244.2G Oct 15 02:26 117.dat -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec00 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec01 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec02 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec03 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec04 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec05 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec06 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec07 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec08 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec09 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec10 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec11 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec12 -rw-r--r-- 1 root root 5.0G Oct 24 16:19 117.ec13 -rw-r--r-- 1 root root 139 Oct 14 03:15 117.vif -rw-r--r-- 1 root root 24.4G Sep 26 06:40 12.ec06 -rw-r--r-- 1 root root 24.4G Sep 26 06:53 12.ec10 -rw-r--r-- 1 root root 157 Sep 26 06:53 12.vif -rw-r--r-- 1 root root 24.4G Sep 29 13:17 13.ec06 -rw-r--r-- 1 root root 24.4G Sep 29 13:39 13.ec11 -rw-r--r-- 1 root root 157 Sep 29 13:39 13.vif -rw-r--r-- 1 root root 244.2G Oct 21 13:07 133.dat -rw-r--r-- 1 root root 139 Oct 15 09:08 133.vif -rw-r--r-- 1 root root 24.4G Sep 27 05:14 14.ec08 -rw-r--r-- 1 root root 24.4G Sep 27 05:33 14.ec12 -rw-r--r-- 1 root root 157 Sep 27 05:33 14.vif -rw-r--r-- 1 root root 24.4G Sep 26 18:53 15.ec08 -rw-r--r-- 1 root root 24.4G Sep 26 19:02 15.ec12 -rw-r--r-- 1 root root 157 Sep 26 19:02 15.vif -rw-r--r-- 1 root root 24.4G Sep 26 10:42 16.ec06 -rw-r--r-- 1 root root 24.4G Sep 26 10:58 16.ec10 -rw-r--r-- 1 root root 157 Sep 26 10:58 16.vif -rw-r--r-- 1 root root 24.4G Sep 29 08:58 17.ec04 -rw-r--r-- 1 root root 24.4G Sep 29 09:26 17.ec09 -rw-r--r-- 1 root root 157 Sep 29 09:26 17.vif -rw-r--r-- 1 root root 24.4G Sep 29 18:33 18.ec04 -rw-r--r-- 1 root root 24.4G Sep 29 18:56 18.ec09 -rw-r--r-- 1 root root 157 Sep 29 18:56 18.vif -rw-r--r-- 1 root root 24.4G Sep 29 01:32 19.ec05 -rw-r--r-- 1 root root 24.4G Sep 29 01:49 19.ec10 -rw-r--r-- 1 root root 157 Sep 29 01:49 19.vif -rw-r--r-- 1 root root 24.4G Oct 2 04:23 20.ec04 -rw-r--r-- 1 root root 24.4G Oct 2 04:28 20.ec05 -rw-r--r-- 1 root root 157 Oct 2 04:28 20.vif -rw-r--r-- 1 root root 24.4G Oct 8 10:08 21.ec06 -rw-r--r-- 1 root root 24.4G Oct 8 10:14 21.ec07 -rw-r--r-- 1 root root 157 Oct 8 10:14 21.vif -rw-r--r-- 1 root root 23.3G Oct 4 08:05 22.ec06 -rw-r--r-- 1 root root 23.3G Oct 4 08:12 22.ec07 -rw-r--r-- 1 root root 145 Oct 4 08:12 22.vif -rw-r--r-- 1 root root 24.4G Sep 30 18:55 23.ec06 -rw-r--r-- 1 root root 24.4G Sep 30 19:06 23.ec11 -rw-r--r-- 1 root root 157 Sep 30 19:06 23.vif -rw-r--r-- 1 root root 24.4G Oct 11 11:18 24.ec06 -rw-r--r-- 1 root root 24.4G Oct 11 11:24 24.ec07 -rw-r--r-- 1 root root 157 Oct 11 11:24 24.vif -rw-r--r-- 1 root root 24.4G Sep 30 07:55 26.ec04 -rw-r--r-- 1 root root 24.4G Sep 30 08:14 26.ec09 -rw-r--r-- 1 root root 157 Sep 30 08:15 26.vif -rw-r--r-- 1 root root 24.4G Oct 3 00:20 27.ec09 -rw-r--r-- 1 root root 24.4G Oct 3 13:41 27.ec11 -rw-r--r-- 1 root root 157 Oct 3 13:41 27.vif -rw-r--r-- 1 root root 244.2G Sep 29 12:02 28.dat -rw-r--r-- 1 root root 24.4G Oct 10 02:50 28.ec11 -rw-r--r-- 1 root root 24.4G Oct 10 02:50 28.ec12 -rw-r--r-- 1 root root 150 Oct 10 02:50 28.vif -rw-r--r-- 1 root root 24.4G Sep 30 03:26 29.ec06 -rw-r--r-- 1 root root 24.4G Sep 30 03:26 29.ec11 -rw-r--r-- 1 root root 146 Oct 4 00:07 29.vif -rw-r--r-- 1 root root 24.4G Oct 8 07:40 31.ec04 -rw-r--r-- 1 root root 24.4G Oct 8 07:45 31.ec05 -rw-r--r-- 1 root root 157 Oct 8 07:45 31.vif -rw-r--r-- 1 root root 24.4G Oct 14 21:52 32.ec05 -rw-r--r-- 1 root root 24.4G Oct 14 21:58 32.ec06 -rw-r--r-- 1 root root 150 Oct 14 21:58 32.vif -rw-r--r-- 1 root root 24.4G Oct 5 07:40 35.ec06 -rw-r--r-- 1 root root 24.4G Oct 5 08:28 35.ec13 -rw-r--r-- 1 root root 157 Oct 5 08:28 35.vif -rw-r--r-- 1 root root 24.4G Oct 4 22:20 36.ec06 -rw-r--r-- 1 root root 24.4G Oct 4 23:07 36.ec13 -rw-r--r-- 1 root root 157 Oct 4 23:07 36.vif -rw-r--r-- 1 root root 24.3G Oct 10 12:48 37.ec05 -rw-r--r-- 1 root root 24.4G Oct 11 05:24 37.ec07 -rw-r--r-- 1 root root 150 Oct 11 05:24 37.vif -rw-r--r-- 1 root root 24.4G Oct 14 23:36 38.ec06 -rw-r--r-- 1 root root 24.4G Oct 14 23:42 38.ec07 -rw-r--r-- 1 root root 150 Oct 14 23:42 38.vif -rw-r--r-- 1 root root 24.4G Oct 9 15:51 40.ec01 -rw-r--r-- 1 root root 24.4G Oct 9 16:41 40.ec08 -rw-r--r-- 1 root root 150 Oct 9 16:41 40.vif -rw-r--r-- 1 root root 24.4G Oct 17 02:19 42.ec08 -rw-r--r-- 1 root root 20.9G Oct 17 02:25 42.ec09 -rw-r--r-- 1 root root 150 Oct 17 02:19 42.vif -rw-r--r-- 1 root root 24.4G Oct 14 17:22 43.ec06 -rw-r--r-- 1 root root 24.4G Oct 14 17:29 43.ec07 -rw-r--r-- 1 root root 150 Oct 14 17:29 43.vif -rw-r--r-- 1 root root 1.2G Oct 7 03:34 45.ec04 -rw-r--r-- 1 root root 24.4G Oct 8 02:45 45.ec07 -rw-r--r-- 1 root root 150 Oct 8 02:45 45.vif -rw-r--r-- 1 root root 244.2G Oct 8 03:36 49.dat -rw-r--r-- 1 root root 24.4G Oct 12 23:09 49.ec12 -rw-r--r-- 1 root root 24.4G Oct 12 23:09 49.ec13 -rw-r--r-- 1 root root 150 Oct 12 23:09 49.vif -rw-r--r-- 1 root root 24.4G Oct 8 11:52 5.ec04 -rw-r--r-- 1 root root 24.4G Oct 8 11:58 5.ec06 -rw-r--r-- 1 root root 157 Oct 8 11:58 5.vif -rw-r--r-- 1 root root 244.2G Oct 15 16:33 52.dat -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec00 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec01 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec02 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec03 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec04 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec05 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec06 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec07 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec08 -rw-r--r-- 1 root root 5.7G Oct 23 05:45 52.ec09 -rw-r--r-- 1 root root 146 Oct 5 19:21 52.vif -rw-r--r-- 1 root root 244.2G Oct 8 10:59 53.dat -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec00 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec01 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec02 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec03 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec04 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec05 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec06 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec07 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec08 -rw-r--r-- 1 root root 21.6G Oct 15 13:07 53.ec09 -rw-r--r-- 1 root root 146 Oct 5 19:21 53.vif -rw-r--r-- 1 root root 24.4G Oct 12 18:57 56.ec03 -rw-r--r-- 1 root root 24.4G Oct 12 19:21 56.ec09 -rw-r--r-- 1 root root 150 Oct 12 19:21 56.vif -rw-r--r-- 1 root root 23.8G Oct 14 22:35 58.ec05 -rw-r--r-- 1 root root 23.8G Oct 14 22:42 58.ec06 -rw-r--r-- 1 root root 150 Oct 14 22:42 58.vif -rw-r--r-- 1 root root 0 Sep 26 01:42 6.dat -rw-r--r-- 1 root root 24.4G Sep 26 00:30 6.ec11 -rw-r--r-- 1 root root 24.4G Sep 27 01:13 6.ec12 -rw-r--r-- 1 root root 157 Sep 27 01:13 6.vif -rw-r--r-- 1 root root 24.4G Oct 15 18:48 67.ec07 -rw-r--r-- 1 root root 24.4G Oct 15 18:56 67.ec08 -rw-r--r-- 1 root root 150 Oct 15 18:56 67.vif -rw-r--r-- 1 root root 24.4G Oct 16 22:59 68.ec08 -rw-r--r-- 1 root root 24.4G Oct 16 23:06 68.ec09 -rw-r--r-- 1 root root 150 Oct 16 23:06 68.vif -rw-r--r-- 1 root root 24.4G Sep 26 15:49 7.ec07 -rw-r--r-- 1 root root 24.4G Sep 26 16:06 7.ec11 -rw-r--r-- 1 root root 157 Sep 26 16:06 7.vif -rw-r--r-- 1 root root 24.4G Oct 14 08:00 70.ec06 -rw-r--r-- 1 root root 24.4G Oct 14 08:10 70.ec12 -rw-r--r-- 1 root root 150 Oct 14 08:10 70.vif -rw-r--r-- 1 root root 24.4G Oct 1 00:44 8.ec08 -rw-r--r-- 1 root root 24.4G Oct 1 01:00 8.ec13 -rw-r--r-- 1 root root 157 Oct 1 01:00 8.vif -rw-r--r-- 1 root root 244.2G Oct 11 13:17 82.dat -rw-r--r-- 1 root root 24.4G Oct 11 22:15 82.ec10 -rw-r--r-- 1 root root 24.4G Oct 11 22:15 82.ec11 -rw-r--r-- 1 root root 24.4G Oct 11 22:15 82.ec12 -rw-r--r-- 1 root root 24.4G Oct 11 22:15 82.ec13 -rw-r--r-- 1 root root 150 Oct 11 22:15 82.vif -rw-r--r-- 1 root root 6.7G Oct 10 06:10 87.dat -rw-r--r-- 1 root root 139 Oct 10 05:51 87.vif -rw-r--r-- 1 root root 24.4G Sep 30 00:17 9.ec04 -rw-r--r-- 1 root root 24.4G Sep 30 00:38 9.ec09 -rw-r--r-- 1 root root 157 Sep 30 13:13 9.vif -rw-r--r-- 1 root root 244.2G Oct 11 15:30 93.dat -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec00 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec01 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec02 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec03 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec04 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec05 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec06 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec07 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec08 -rw-r--r-- 1 root root 2.0G Oct 21 05:06 93.ec09 -rw-r--r-- 1 root root 139 Oct 10 07:24 93.vif -rw-r--r-- 1 root root 36 Sep 25 19:03 vol_dir.uuid ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>adjust output format</MESSAGE>
    <SHA>8d6189bcc514b48b792deca65d4dd8efc3e0c3f9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>correcting free volume count, factor it during ec encoding to ensure enough disk space available fix https://github.com/seaweedfs/seaweedfs/issues/6163</MESSAGE>
      <SHA>6e388e29c9251ffd4559f5e3d441a96cd556f79a</SHA>
      <PATCHEDFILES>
        <FILE>weed/shell/command_ec_encode.go</FILE>
        <FILE>weed/topology/disk.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
