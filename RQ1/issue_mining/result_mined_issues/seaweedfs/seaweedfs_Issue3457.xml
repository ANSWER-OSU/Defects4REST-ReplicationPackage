<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3457</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3457</ISSUEURL>
  <TITLE>weedfs-3.22 S3 reports a directory as a file</TITLE>
  <DESCRIPTION>**Describe the bug** we run weedfs to set up an S3 service, used by Aapche Flink, replace the former Minio. when upgrade to weedfs-3.22, flink jobmanager start up fail, and report s3://flink/recovery/flink/blob is a file !!! But actually It is a directory. ![image](https://user-images.githubusercontent.com/3582423/185061458-661565ff-9b70-4df9-a762-06798b574bf8.png) Roll back to weedfs-3.19, everything is OK `Caused by: org.apache.hadoop.fs.FileAlreadyExistsException: Path is a file: s3://flink/recovery/flink/blob at org.apache.hadoop.fs.s3a.S3AFileSystem.innerMkdirs(S3AFileSystem.java:2042) ~[?:?] at org.apache.hadoop.fs.s3a.S3AFileSystem.mkdirs(S3AFileSystem.java:2007) ~[?:?] at org.apache.hadoop.fs.FileSystem.mkdirs(FileSystem.java:2275) ~[hadoop-common-3.3.4.jar:?] at org.apache.flink.fs.s3hadoop.common.HadoopFileSystem.mkdirs(HadoopFileSystem.java:183) ~[?:?] at org.apache.flink.core.fs.PluginFileSystemFactory$ClassLoaderFixingFileSystem.mkdirs(PluginFileSystemFactory.java:162) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.blob.FileSystemBlobStore.&lt;init&gt;(FileSystemBlobStore.java:64) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.blob.BlobUtils.createFileSystemBlobStore(BlobUtils.java:98) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.blob.BlobUtils.createBlobStoreFromConfig(BlobUtils.java:76) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.highavailability.HighAvailabilityServicesUtils.createHighAvailabilityServices(HighAvailabilityServicesUtils.java:115) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.entrypoint.ClusterEntrypoint.createHaServices(ClusterEntrypoint.java:338) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.entrypoint.ClusterEntrypoint.initializeServices(ClusterEntrypoint.java:296) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.entrypoint.ClusterEntrypoint.runCluster(ClusterEntrypoint.java:224) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.entrypoint.ClusterEntrypoint.lambda$startCluster$1(ClusterEntrypoint.java:178) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at java.security.AccessController.doPrivileged(Native Method) ~[?:?] at javax.security.auth.Subject.doAs(Unknown Source) ~[?:?] at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1878) ~[hadoop-common-3.3.4.jar:?] at org.apache.flink.runtime.security.contexts.HadoopSecurityContext.runSecured(HadoopSecurityContext.java:41) ~[flink-dist_2.11-1.12.4.jar:1.12.4] at org.apache.flink.runtime.entrypoint.ClusterEntrypoint.startCluster(ClusterEntrypoint.java:175) ~[flink-dist_2.11-1.12.4.jar:1.12.4] ... 2 more` **System Setup** Linux CentOS 7 weedfs version 30GB 3.22 fa4d0093e17f710c3da00545022646cb96a6fd98 linux amd64 weed -v 1 server -volume.port 38080 -dir=/data/seaweedfs/data -s3 -s3.config /data/seaweedfs/config.json</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix: TestCommandEcBalanceSmall Unit test fails when CommandEnv is nil (#3497)</MESSAGE>
    <SHA>911475526cc41ba40436c1a0accabd2ba5aad68e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>s3: report http.StatusOK if the directory is explicitly created fix https://github.com/seaweedfs/seaweedfs/issues/3457</MESSAGE>
      <SHA>9fce75607dd4be000c5d316c0e32bdbb0935a147</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/s3_constants/header.go</FILE>
        <FILE>weed/s3api/s3api_object_handlers.go</FILE>
        <FILE>weed/server/filer_server_handlers_read.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>s3: report http.StatusOK if the directory is explicitly created fix https://github.com/seaweedfs/seaweedfs/issues/3457</MESSAGE>
      <SHA>75e27948094308a64f68704383f926846600052c</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/s3_constants/header.go</FILE>
        <FILE>weed/s3api/s3api_object_handlers.go</FILE>
        <FILE>weed/server/filer_server_handlers_read.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
