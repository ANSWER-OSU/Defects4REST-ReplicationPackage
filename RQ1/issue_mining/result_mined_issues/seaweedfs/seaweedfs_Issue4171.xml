<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4171</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/4171</ISSUEURL>
  <TITLE>[shell] volume.check.disk loop on sync partially deleted files</TITLE>
  <DESCRIPTION>**Describe the bug** log script ``` volume.check.disk -v -syncDeleted -force: load collection bucket volume 2457 index size 1866976 from fast-volume-2:8080 ... load collection bucket volume 2457 index size 1874768 from fast-volume-0:8080 ... volume 2457 fast-volume-0:8080 has 110346 entries, fast-volume-2:8080 missed 0 and partially deleted 0 entries volume 2457 fast-volume-2:8080 has 110345 entries, fast-volume-0:8080 missed 0 and partially deleted 722 entries delete 2457,2a7a38009492a9ea00000000 fast-volume-2.:8080 =&gt; fast-volume-0.:8080 delete 2457,2a7a380094928a8900000000 fast-volume-2.:8080 =&gt; fast-volume-0.:8080 delete 2457,2a7a38009492823200000000 fast-volume-2.:8080 =&gt; fast-volume-0.:8080 delete 2457,2a7a380094925b5f00000000 fast-volume-2.:8080 =&gt; fast-volume-0.:8080 delete 2457,2a7a380094922d9c00000000 fast-volume-2.:8080 =&gt; fast-volume-0.:8080 delete 2457,2a7a38009492047a00000000 fast-volume-2.:8080 =&gt; fast-volume-0.:8080 ... load collection trendyol-parser-bucket volume 2457 index size 1866976 from fast-volume-2:8080 ... load collection trendyol-parser-bucket volume 2457 index size 1874768 from fast-volume-0:8080 ... **System Setup** ``` weed v3.35 ``` **Expected behavior** Synchronize once</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>254</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'shell_vlm_chk_disk_fast' into stage</MESSAGE>
    <SHA>81757f973cf5f492c9ffc9940b58c1ef0225deb9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid loop on sync partially deleted files https://github.com/seaweedfs/seaweedfs/issues/4171</MESSAGE>
      <SHA>e36b8f498155f5e3ee1449e81d4eccd4843f3975</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/volume_grpc_batch_delete.go</FILE>
        <FILE>weed/shell/command_volume_check_disk.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>print delete result https://github.com/seaweedfs/seaweedfs/issues/4171</MESSAGE>
      <SHA>30b13eea9b2077cbe091e14f6810e72946ca9bbe</SHA>
      <PATCHEDFILES>
        <FILE>weed/shell/command_volume_check_disk.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix has changes false if deleted result size eq zero https://github.com/seaweedfs/seaweedfs/issues/4171</MESSAGE>
      <SHA>6f1f9b326ae396a3fe1bd0fa2fb15a45670aaa15</SHA>
      <PATCHEDFILES>
        <FILE>weed/shell/command_volume_check_disk.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix change respos status 202 to 304 if the file has already been deleted https://github.com/seaweedfs/seaweedfs/issues/4171</MESSAGE>
      <SHA>dab291e2660e40e3d4010e665d44c5e6344295b9</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/volume_grpc_batch_delete.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix delete if set apply changes https://github.com/seaweedfs/seaweedfs/issues/4171</MESSAGE>
      <SHA>8857ed85c4d431affc4a621c9a5b5bcce1b2b1db</SHA>
      <PATCHEDFILES>
        <FILE>weed/shell/command_volume_check_disk.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix has changes false if deleted result size eq zero (#4909) * fix has changes false if deleted result size eq zero https://github.com/seaweedfs/seaweedfs/issues/4171 * fix change respos status 202 to 304 if the file has already been deleted https://github.com/seaweedfs/seaweedfs/issues/4171 * fix delete if set apply changes https://github.com/seaweedfs/seaweedfs/issues/4171 --------- Co-authored-by: Konstantin Lebedev &lt;9497591+kmlebedev@users.noreply.github.co&gt;</MESSAGE>
      <SHA>edee91ef0eb7f7612ae961ac1d1ace2afbd92b87</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/volume_grpc_batch_delete.go</FILE>
        <FILE>weed/shell/command_volume_check_disk.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix has changes false if deleted result size eq zero (#4909) * fix has changes false if deleted result size eq zero https://github.com/seaweedfs/seaweedfs/issues/4171 * fix change respos status 202 to 304 if the file has already been deleted https://github.com/seaweedfs/seaweedfs/issues/4171 * fix delete if set apply changes https://github.com/seaweedfs/seaweedfs/issues/4171 --------- Co-authored-by: Konstantin Lebedev &lt;9497591+kmlebedev@users.noreply.github.co&gt;</MESSAGE>
      <SHA>05011e8c12daa4310445404ac45a07b8c19bd0d4</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/volume_grpc_batch_delete.go</FILE>
        <FILE>weed/shell/command_volume_check_disk.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
