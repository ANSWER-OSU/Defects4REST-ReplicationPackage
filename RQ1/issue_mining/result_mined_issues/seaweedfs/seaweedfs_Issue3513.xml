<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3513</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3513</ISSUEURL>
  <TITLE>[volume] DATA RACE on MaybeAdjustVolumeMax</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` volume_1 | ================== volume_1 | WARNING: DATA RACE volume_1 | Read at 0x00c00018b180 by goroutine 143: volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Store).MaybeAdjustVolumeMax() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/store.go:542 +0x13c volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).doHeartbeat() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_grpc_client_to_master.go:214 +0x1c19 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).heartbeat() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_grpc_client_to_master.go:69 +0x449 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.NewVolumeServer.func1() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_server.go:123 +0x39 volume_1 | volume_1 | Previous write at 0x00c00018b180 by goroutine 165: volume_1 | github.com/seaweedfs/seaweedfs/weed/storage.(*Store).MaybeAdjustVolumeMax() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/storage/store.go:551 +0x209 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).doHeartbeat.func1() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_grpc_client_to_master.go:135 +0x2c6 volume_1 | volume_1 | Goroutine 143 (running) created at: volume_1 | github.com/seaweedfs/seaweedfs/weed/server.NewVolumeServer() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_server.go:123 +0x104b volume_1 | github.com/seaweedfs/seaweedfs/weed/command.VolumeServerOptions.startVolumeServer() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/command/volume.go:235 +0x1646 volume_1 | github.com/seaweedfs/seaweedfs/weed/command.runVolume() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/command/volume.go:133 +0x432 volume_1 | main.main() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/weed.go:81 +0x943 volume_1 | volume_1 | Goroutine 165 (running) created at: volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).doHeartbeat() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_grpc_client_to_master.go:114 +0x7d9 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.(*VolumeServer).heartbeat() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_grpc_client_to_master.go:69 +0x449 volume_1 | github.com/seaweedfs/seaweedfs/weed/server.NewVolumeServer.func1() volume_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/volume_server.go:123 +0x39 volume_1 | ================== s3tests_1 | s3tests_boto3.functional.test_s3.test_bucket_list_empty ... ok volume_1 | I0825 10:40:32.912680 store.go:143 In dir /data adds volume:1 collection:yournamehere-ndnlnnt6gnh6x06j-2 replicaPlacement:000 ttl: volume_1 | I0825 10:40:32.913928 volume_loading.go:140 loading memory index /data/yournamehere-ndnlnnt6gnh6x06j-2_1.idx to memory volume_1 | I0825 10:40:32.917846 store.go:147 add volume 1 volume_1 | I0825 10:40:32.918257 volume_grpc_client_to_master.go:172 volume server volume:8080 adds volume 1 master_1 | I0825 10:40:32.920073 volume_layout.go:391 Volume 1 becomes writable master_1 | I0825 10:40:32.920163 volume_growth.go:245 Created Volume 1 on topo:DefaultDataCenter:DefaultRack:volume:8080 s3tests_1 | s3tests_boto3.functiona ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>add target dev_race to MakeFile (#3522)</MESSAGE>
    <SHA>913a5d0dd475e029f08d7e60f383bc9304a872dc</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid race conditions for diskLocation.MaxVolumeCount https://github.com/seaweedfs/seaweedfs/issues/3513</MESSAGE>
      <SHA>0b410cb7fac3c348e10cb7c54ce1fcd6372bbd1b</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/disk_location.go</FILE>
        <FILE>weed/storage/store.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
