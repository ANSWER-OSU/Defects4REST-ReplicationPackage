<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2952</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2952</ISSUEURL>
  <TITLE>weed fuse mount hangs.</TITLE>
  <DESCRIPTION>**Describe the bug** Fuse mount/filer hangs after high load from a restic restore. ``` [root@mouse-r13 ~]# sh -x /home/tdavis/home-backup.sh + RESTIC_PASSWORD=badbadbadjuju + export RESTIC_PASSWORD + RESTIC_REPOSITORY=s3:http://mouse-r11:8333/homes + export RESTIC_REPOSITORY + restic backup /home repository 7192c674 opened successfully, password is correct using parent snapshot 2e42bd8f Files: 231 new, 29 changed, 1201279 unmodified Dirs: 22 new, 43 changed, 203382 unmodified Added to the repo: 130.694 MiB processed 1201539 files, 233.310 GiB in 54:39 snapshot 02dacef4 saved [root@mouse-r13 ~]# ``` this is the snapshot to restore from. 1.2 million files, 233 GB.. ``` mkdir /weed/ weed mount -dir /weed -filer mouse-r11:8889 ``` this runs for a while, creates all the directories.. starts to restore, then hangs. ``` mkdir home cd home restic restore latest --target . ``` The repo is the s3 based repo from above backup. **System Setup** 3ea, AMD 8/32 CPU, 64Gb of ram, 10GB/bonded interfaces, NVME/m2 2TB storage. The S3 storage is 5 nodes, 2x1G ethernet, fanless Zotac ci329's, 8gb ram, 4 core intel celeron @ 1.10Ghz, 8TB SSD Micron 5100 Pro SATA (it's for disaster recovery) A restic restore from those 5 nodes to the local nvme drive is capable of doing 1.5Gb/sec easily - see: ``` [root@mouse-r13 restore]# time restic restore latest --target . repository 7192c674 opened successfully, password is correct restoring &lt;Snapshot 02dacef4 of [/home] at 2022-04-21 12:07:27.565531555 -0700 PDT by root@mouse-r13&gt; to . real 17m17.017s user 32m43.975s sys 9m46.551s [root@mouse-r13 restore]# ``` The same restore to the seaweedfs fuse mount hangs after several minutes. If I do a systemctl restart seaweedfs-filer/kill -9 the filer, it restarts, the restore restarts, and then hangs again.. ``` [root@mouse-r11 system]# weed version version 30GB 2.99 8e98d7326b8cbd715033ec5a0e602732a4034850 linux amd64 [root@mouse-r11 system]# ``` ``` [root@mouse-r11 system]# uname -a Linux mouse-r11 5.16.11-200.fc35.x86_64 #1 SMP PREEMPT Wed Feb 23 17:08:49 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux [root@mouse-r11 system]# ``` OS is Fedora 35 Server, selinux disabled. systemd service files: [seaweedfs-volume.service.txt](https://github.com/chrislusf/seaweedfs/files/8535084/seaweedfs-volume.service.txt) [seaweedfs-s3.service.txt](https://github.com/chrislusf/seaweedfs/files/8535085/seaweedfs-s3.service.txt) [seaweedfs-master.service.txt](https://github.com/chrislusf/seaweedfs/files/8535087/seaweedfs-master.service.txt) [seaweedfs-filer.service.txt](https://github.com/chrislusf/seaweedfs/files/8535088/seaweedfs-filer.service.txt) - List the command line to start &quot;weed master&quot;, &quot;weed volume&quot;, &quot;weed filer&quot;, &quot;weed s3&quot;, &quot;weed mount&quot;. - OS version - output of `weed version` - if using filer, show the content of `filer.toml` filer.toml is empty. ``` [root@mouse-r11 system]# weed shell master: localhost:9333 filers: [mouse-r11:8889] &gt; fs.configure { &quot;locations&quot;: [ { &quot;locationPrefix&quot;: &quot;/backup/&quot;, &quot;replication&quot;: &quot;001&quot;, &quot;diskType&quot;: &quot;ssd&quot; }, { &quot;locationPrefix&quot;: &quot;/buckets/&quot;, &quot;replication&quot;: &quot;001&quot;, &quot;diskType&quot;: &quot;ssd&quot; }, { &quot;locationPrefix&quot;: &quot;/home/&quot;, &quot;replication&quot;: &quot;001&quot;, &quot;diskType&quot;: &quot;nvme&quot; } ] } &gt; ``` **Expected behavior** not hangs, restore finishes. **Additional context** weed mount reports this when I crash and restart the filer: ``` 2022/04/20 23:47:05 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:06 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:07 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:08 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:09 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:12 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:12 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:12 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:12 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:15 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:15 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/20 23:47:20 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT E0421 08:53:54 70094 weedfs_file_sync.go:168] fh flush create /home/home/boverhof/collectors/modbus/pollmb/logs/b59-ups1.log: CreateEntry: rpc error: code = Unavailable desc = error reading from server: EOF I0421 08:53:54 70094 wfs_filer_client.go:29] WithFilerClient 0 mouse-r11:18889: fh flush create /home/home/boverhof/collectors/modbus/pollmb/logs/b59-ups1.log: CreateEntry: rpc error: code = Unavailable desc = error reading from server: EOF E0421 08:53:54 70094 weedfs_file_sync.go:182] /home/home/boverhof/collectors/modbus/pollmb/logs/b59-ups1.log fh 0 flush: fh flush create /home/home/boverhof/collectors/modbus/pollmb/logs/b59-ups1.log: CreateEntry: rpc error: code = Unavailable desc = error reading from server: EOF I0421 08:53:54 70094 wfs_filer_client.go:29] WithFilerClient 0 mouse-r11:18889: rpc error: code = Unavailable desc = error reading from server: EOF E0421 08:53:54 70094 meta_cache_subscribe.go:63] follow metadata updates: subscribing filer meta change: rpc error: code = Unavailable desc = error reading from server: EOF I0421 08:53:54 70094 weedfs_write.go:36] assign volume failure count:1 path:&quot;/home/home/tdavis/go/pkg/dep/sources/https---go.googlesource.com-crypto/.git/hooks/prepare-commit-msg.sample&quot;: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.84.2:18889: connect: connection refused&quot; I0421 08:53:54 70094 retry.go:25] retry assignVolume: err: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.84.2:18889: connect: connection refused&quot; I0421 08:53:55 70094 weedfs_write.go:36] assign volume failure count:1 path:&quot;/home/home/tdavis/go/pkg/dep/sources/https---go.googlesource.com-crypto/.git/hooks/prepare-commit-msg.sample&quot;: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.84.2:18889: connect: connection refused&quot; I0421 08:53:55 70094 retry.go:25] retry assignVolume: err: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.84.2:18889: connect: connection refused&quot; I0421 08:53:57 70094 weedfs_write.go:36] assign volume failure count:1 path:&quot;/home/home/tdavis/go/pkg/dep/sources/https---go.googlesource.com-crypto/.git/hooks/prepare-commit-msg.sample&quot;: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.84.2:18889: connect: connection refused&quot; I0421 08:53:57 70094 retry.go:25] retry assignVolume: err: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.84.2:18889: connect: connection refused&quot; I0421 08:53:59 70094 weedfs_write.go:36] assign volume failure count:1 path:&quot;/home/home/tdavis/go/pkg/dep/sources/https---go.googlesource.com-crypto/.git/hooks/prepare-commit-msg.sample&quot;: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.84.2:18889: connect: connection refused&quot; I0421 08:53:59 70094 retry.go:25] retry assignVolume: err: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp 192.168.84.2:18889: connect: connection refused&quot; I0421 08:54:02 70094 retry.go:19] retry assignVolume successfully 2022/04/21 08:54:03 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/21 08:54:03 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/21 08:54:03 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/21 08:54:03 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT 2022/04/21 08:54:03 writer: Write/Writev failed, err: 2=no such file or directory. opcode: INTERRUPT ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>120</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>add a comment</MESSAGE>
    <SHA>746092a60b3cefbe9617fe5f7e5a9a8d61fb8d13</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>mount: file handle locks entry better related to https://github.com/chrislusf/seaweedfs/issues/2952</MESSAGE>
      <SHA>d65bb2c6df1a21ff2833717a16e549de971316b7</SHA>
      <PATCHEDFILES>
        <FILE>weed/mount/dirty_pages_chunked.go</FILE>
        <FILE>weed/mount/filehandle.go</FILE>
        <FILE>weed/mount/filehandle_read.go</FILE>
        <FILE>weed/mount/weedfs.go</FILE>
        <FILE>weed/mount/weedfs_attr.go</FILE>
        <FILE>weed/mount/weedfs_file_sync.go</FILE>
        <FILE>weed/mount/weedfs_xattr.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
