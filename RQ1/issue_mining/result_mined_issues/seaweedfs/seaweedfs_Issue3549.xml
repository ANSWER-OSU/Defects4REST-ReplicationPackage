<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3549</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3549</ISSUEURL>
  <TITLE>[filer] DATA RACE on uploadReaderToChunks</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` s3_1 | I0830 06:23:24.797198 auth_credentials.go:225 v4 auth type s3_1 | I0830 06:23:24.798512 auth_credentials.go:254 user name: some_admin_user actions: [Admin Read List Tagging Write], action: Write s3_1 | I0830 06:23:24.799422 s3api_object_multipart_handlers.go:248 PutObjectPartHandler registry 8d57564b4de275ffb5f210d3e8143dbef8607349 0004 s3_1 | I0830 06:23:24.800860 filer_server_handlers_write_upload.go:67 received byte buffer 1 s3_1 | I0830 06:23:24.819558 filer_server_handlers_write_upload.go:115 uploaded 0001.part chunk 3 to 3,01ba893a4fc9 [20971520,25165824) s3_1 | I0830 06:23:24.822147 filer_server_handlers_write_upload.go:67 received byte buffer 4 s3_1 | I0830 06:23:24.878356 filer_server_handlers_write_upload.go:60 waiting for byte buffer 4 s3_1 | I0830 06:23:25.164557 filer_server_handlers_write_upload.go:67 received byte buffer 2 s3_1 | I0830 06:23:25.570195 filer_server_handlers_write_upload.go:67 received byte buffer 3 s3_1 | I0830 06:23:26.185096 filer_server_handlers_write_upload.go:115 uploaded 0001.part chunk 4 to 5,01b675b06671 [8388608,12582912) s3_1 | I0830 06:23:26.185448 filer_server_handlers_write_upload.go:67 received byte buffer 4 s3_1 | I0830 06:23:26.336514 filer_server_handlers_write_upload.go:60 waiting for byte buffer 4 s3_1 | I0830 06:23:26.439257 filer_server_handlers_write_upload.go:115 uploaded 0001.part chunk 5 to 4,01b9e55cf059 [16777216,20971520) s3_1 | I0830 06:23:26.439486 filer_server_handlers_write_upload.go:67 received byte buffer 4 s3_1 | ================== s3_1 | WARNING: DATA RACE s3_1 | Read at 0x00c00013a120 by goroutine 735: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func1() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:108 +0x22e s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks.func3() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:117 +0x47 s3_1 | s3_1 | Previous write at 0x00c00013a120 by goroutine 455: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:80 +0x1324 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:108 +0x224 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() s3_1 | &lt;autogenerated&gt;:1 +0x57 s3_1 | net/http.HandlerFunc.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d s3_1 | net/http.(*ServeMux).ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 s3_1 | net/http.serverHandler.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 s3_1 | net/http.(*conn).serve() s3_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 s3_1 | net/http.(*Server).Serve.func3() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 s3_1 | s3_1 | Goroutine 735 (running) created at: s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).uploadReaderToChunks() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_upload.go:99 +0xf7d s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).doPutAutoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:108 +0x224 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).autoChunk() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write_autochunk.go:46 +0x31c s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).PostHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers_write.go:103 +0xe6a s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server_handlers.go:84 +0x1168 s3_1 | github.com/seaweedfs/seaweedfs/weed/server.(*FilerServer).filerHandler-fm() s3_1 | &lt;autogenerated&gt;:1 +0x57 s3_1 | net/http.HandlerFunc.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2109 +0x4d s3_1 | net/http.(*ServeMux).ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2487 +0xc5 s3_1 | net/http.serverHandler.ServeHTTP() s3_1 | /usr/local/go/src/net/http/server.go:2947 +0x641 s3_1 | net/http.(*conn).serve() s3_1 | /usr/local/go/src/net/http/server.go:1991 +0xbe4 s3_1 | net/http.(*Server).Serve.func3() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x58 s3_1 | s3_1 | Goroutine 455 (running) created at: s3_1 | net/http.(*Server).Serve() s3_1 | /usr/local/go/src/net/http/server.go:3102 +0x837 s3_1 | github.com/seaweedfs/seaweedfs/weed/command.(*FilerOptions).startFiler.func3() s3_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/command/filer.go:308 +0x1b1 s3_1 | ================== s3_1 | I0830 06:23:26.936048 filer_server_handlers_write_upload.go:115 uploaded 0001.part chunk 6 to 5,01b8993d1b57 [12582912,16777216) s3_1 | I0830 06:23:27.339330 filer_server_handlers_write_upload.go:115 uploaded 0004.part chunk 1 to 7,01bf74910830 [8388608,11026957) s3_1 | I0830 06:23:29.096974 filer_server_handlers_write_upload.go:115 uploaded 0004.part chunk 2 to 6,01bd1224517f [0,4194304) s3_1 | I0830 06:23:29.101658 filer_server_handlers_write_upload.go:115 uploaded 0004.part chunk 3 to 7,01be0b9c5e5d [4194304,8388608) s3_1 | I0830 06:23:29.107207 filer_server_handlers_write_upload.go:115 uploaded 0001.part chunk 7 to 2,01c092dabc91 [29360128,33554432) s3_1 | I0830 06:23:29.109798 filer_server_handlers_write_autochunk.go:192 saving /buckets/registry/.uploads/8d57564b4de275ffb5f210d3e8143dbef8607349/0004.part s3_1 | I0830 06:23:29.111580 filer.go:222 find uncached directory: /buckets/registry/.uploads/8d57564b4de275ffb5f210d3e8143dbef8607349 s3_1 | I0830 06:23:29.116899 filer_server_handlers_write_upload.go:115 uploaded 0001.part chunk 8 to 4,01bcab96b00a [25165824,29360128) s3_1 | I0830 06:23:29.116795 filer.go:186 InsertEntry /buckets/registry/.uploads/8d57564b4de275ffb5f210d3e8143dbef8607349/0004.part: new entry: 0004.part s3_1 | I0830 06:23:29.123204 filer_server_handlers_write_autochunk.go:192 saving /buckets/registry/.uploads/5898b95e46514183a7a0f0bc6419ec8460ee54e5/0001.part s3_1 | I0830 06:23:29.124379 filer.go:196 UpdateEntry /buckets/registry/.uploads/5898b95e46514183a7a0f0bc6419ec8460ee54e5/0001.part: old entry: 0001.part s3_1 | I0830 06:23:29.127061 filer.go:207 CreateEntry /buckets/registry/.uploads/8d57564b4de275ffb5f210d3e8143dbef8607349/0004.part: created s3_1 | I0830 06:23:29.128978 filer.go:207 CreateEntry /buckets/registry/.uploads/5898b95e46514183a7a0f0bc6419ec8460ee54e5/0001.part: created s3_1 | I0830 06:23:29.129031 error_handler.go:85 status 200 : s3_1 | I0830 06:23:29.140007 error_handler.go:85 status 200 application/xml: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; s3_1 | &lt;CopyPartResult&gt;&lt;LastModified&gt;2022-08-30T06:23:29.1327331Z&lt;/LastModified&gt;&lt;ETag&gt;db384c993ba5c934e18377726f9d6c29&lt;/ETag&gt;&lt;/CopyPartResult&gt; s3_1 | I0830 06:23:29.151712 auth_credentials.go:225 v4 auth type s3_1 | I0830 06:23:29.153330 auth_credentials.go:225 v4 auth type s3_1 | I0830 06:23:29.154036 auth_credentials.go:254 user name: some_admin_user actions: [Admin Read List Tagging Write], action: Write s3_1 | I0830 06:23:29.155906 auth_credentials.go:254 user name: some_admin_user actions: [Admin Read List Tagging Write], action: Write s3_1 | I0830 06:23:29.156030 s3api_object_handlers.go:49 PutObjectHandler registry /docker/registry/v2/repositories/minio/_uploads/1abe4c43-6164-4080-adac-ca0fcdb18c6e/hashstates/sha256/42484237 s3_1 | I0830 06:23:29.160032 fi ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ensure memory alignment on different CPUs</MESSAGE>
    <SHA>570b4885722ae08c92651d6f38918429ac39bd22</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid data race access to uploadErr https://github.com/seaweedfs/seaweedfs/issues/3549</MESSAGE>
      <SHA>bb6cd2ff2bc52f8f9f8c900597dd3cd59bd70017</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>avoid data race access to uploadReaderToChunks.uploadErr (#3550) avoid data race access to uploadErr https://github.com/seaweedfs/seaweedfs/issues/3549</MESSAGE>
      <SHA>105702ebe0e1cf7b36ddb075d4cde22b4b3f1bbe</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/filer_server_handlers_write_upload.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
