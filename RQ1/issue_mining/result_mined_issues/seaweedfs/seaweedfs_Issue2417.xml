<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2417</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2417</ISSUEURL>
  <TITLE>S3 using IAM action Write does not work properly</TITLE>
  <DESCRIPTION>**Describe the bug** I have followed the documentation to enable S3 IAM identities but it seems that the Write action for an identity does not allow to actually create files using S3. **System Setup** - Running seaweedfs from Docker, config below ``` docker_container: name: seaweedfs image: chrislusf/seaweedfs state: started restart_policy: unless-stopped pull: true user: nobody:20000 command: server -dir=&quot;/data&quot; -volume.max=0 -master.volumePreallocate=false -master.volumeSizeLimitMB=1024 -s3 -s3.config=/etc/seaweedfs-s3-config.json comparisons: image: strict ports: - &quot;127.0.0.1:28080:8080&quot; - &quot;127.0.0.1:18080:18080&quot; - &quot;127.0.0.1:8333:8333&quot; volumes: - &quot;/etc/seaweedfs-s3-config.json:/etc/seaweedfs-s3-config.json:ro&quot; - &quot;/var/lib/seaweedfs-data:/data&quot; ``` - `version 30GB 2.76 1b90d607 linux amd64` - Using `rclone` for file operations **Expected behavior** I would expect that the `Write` permission allow to create a file in a bucket, otherwise I have to grant `Admin` which is not very granular. **IAM config**: ``` { &quot;identities&quot;: [ { &quot;name&quot;: &quot;admin&quot;, &quot;credentials&quot;: [ { &quot;accessKey&quot;: &quot;admin_access&quot;, &quot;secretKey&quot;: &quot;admin_secret&quot; } ], &quot;actions&quot;: [ &quot;Admin&quot;, &quot;Read&quot;, &quot;List&quot;, &quot;Tagging&quot;, &quot;Write&quot; ] }, { &quot;name&quot;: &quot;rclone&quot;, &quot;credentials&quot;: [ { &quot;accessKey&quot;: &quot;rclone_access&quot;, &quot;secretKey&quot;: &quot;rclone_secret&quot; } ], &quot;actions&quot;: [ &quot;Read&quot;, &quot;Write&quot;, &quot;List&quot; ] } ] } ``` **rclone config**: ``` [weed] type = s3 provider = Other access_key_id = rclone_access secret_access_key = rclone_secret endpoint = http://127.0.0.1:8333 acl = private [weedAdmin] type = s3 provider = Other access_key_id = admin_access secret_access_key = admin_secret endpoint = http://127.0.0.1:8333 acl = private ``` **Using rclone with low-priv user**: ``` #Bucket listing works # rclone lsd weed: -1 2021-11-02 15:11:23 -1 photos_staging_dir #File listing works # rclone ls weed:photos_staging_dir #Creating a file fails # rclone touch weed:photos_staging_dir/fstab 2021/11/02 16:06:26 ERROR : Attempt 1/3 failed with 1 errors and: failed to touch (create): AccessDenied: Access Denied. status code: 403, request id: 1635869186380983481, host id: 2021/11/02 16:06:26 ERROR : Attempt 2/3 failed with 1 errors and: failed to touch (create): AccessDenied: Access Denied. status code: 403, request id: 1635869186384910685, host id: 2021/11/02 16:06:26 ERROR : Attempt 3/3 failed with 1 errors and: failed to touch (create): AccessDenied: Access Denied. status code: 403, request id: 1635869186388820806, host id: 2021/11/02 16:06:26 Failed to touch: failed to touch (create): AccessDenied: Access Denied. status code: 403, request id: 1635869186388820806, host id: ``` Creating empty file with admin identity: ``` rclone touch weedAdmin:photos_staging_dir/fstab ``` Created file can now be written/deleted by low-priv identity: ``` # rclone copy /etc/fstab weed:photos_staging_dir/ # rclone ls weed:photos_staging_dir/ 881 fstab #rclone delete weed:photos_staging_dir/fstab ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>s3: skip permission checking for creating bucket if the bucket already exists fix https://github.com/chrislusf/seaweedfs/issues/2417 Rclone was trying to create the bucket even though the bucket already exists.</MESSAGE>
    <SHA>b25661c6df5ac23110e2ae29315554d3511edacd</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>s3: adjust permission for HEAD bucket operation fix https://github.com/chrislusf/seaweedfs/issues/2417#issuecomment-958391856</MESSAGE>
      <SHA>e1ab8b01d06b8f1d2606651a8035a0565c9cfd30</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/s3api_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
