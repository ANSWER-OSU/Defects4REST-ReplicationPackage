<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2243</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2243</ISSUEURL>
  <TITLE>gRpc connection error on filer when no volume left</TITLE>
  <DESCRIPTION>After uploading a file by mounted volume when no more volumes can be created, the filer start to report multiple gRpc connection error and randomly error &quot;volume X not found&quot;. **System Setup** **OS:** CentOS 7 - WSL2 on Windows 10 **Master**: /usr/sbin/weed master -mdir=/home/trogo/seaweed/masterData -volumeSizeLimitMB=10 -port=9333 -defaultReplication=000 **Volume**: /usr/sbin/weed volume -dir=/home/trogo/seaweed/volumeData -max=6 -mserver=127.0.0.1:9333 **Filer**: /usr/sbin/weed filer -port=8888 -master=127.0.0.1:9333 **MountPoint:** weed mount -filer=127.0.0.1:8888 -dir=/home/trogo/seaweed/filerMount This is the starting situation: only 1 volume has available space left (vol. 2) and no more volumes can be allocated. The volume 2 is &quot;crowded&quot;. ``` &gt; volume.list Topology volumeSizeLimit:10 MB hdd(volume:6/6 active:6 free:0 remote:0) DataCenter DefaultDataCenter hdd(volume:6/6 active:6 free:0 remote:0) Rack DefaultRack hdd(volume:6/6 active:6 free:0 remote:0) DataNode 192.168.225.128:8080 hdd(volume:6/6 active:6 free:0 remote:0) Disk hdd(volume:6/6 active:6 free:0 remote:0) volume id:1 size:10618872 file_count:12 delete_count:1 deleted_byte_count:1048594 version:3 modified_at_second:1628351965 volume id:2 size:9468216 file_count:14 version:3 compact_revision:1 modified_at_second:1628353537 volume id:3 size:10597896 file_count:17 delete_count:2 deleted_byte_count:1091827 version:3 modified_at_second:1628353500 volume id:4 size:10531264 file_count:13 delete_count:4 deleted_byte_count:3145857 version:3 modified_at_second:1628353500 volume id:5 size:10515352 file_count:8 delete_count:2 deleted_byte_count:3145765 version:3 modified_at_second:1628351976 volume id:6 size:11638272 file_count:11 delete_count:2 deleted_byte_count:3145764 version:3 modified_at_second:1628351655 Disk hdd total size:63369872 file_count:75 deleted_file:11 deleted_bytes:11577807 DataNode 192.168.225.128:8080 total size:63369872 file_count:75 deleted_file:11 deleted_bytes:11577807 Rack DefaultRack total size:63369872 file_count:75 deleted_file:11 deleted_bytes:11577807 DataCenter DefaultDataCenter total size:63369872 file_count:75 deleted_file:11 deleted_bytes:11577807 total size:63369872 file_count:75 deleted_file:11 deleted_bytes:11577807 ``` Trying to upload a new file result in an error even if there is available space in existing volume. When we try to upload by filer WebUI i can't upload, but no other error. When we try to create a new file in mounted folder (with &quot;weed mount&quot;), we have an error same as above, but the filer service start to log continuous error: ``` 0809 09:01:08 21 masterclient.go:121] filer masterClient failed to receive from 127.0.0.1:9333: rpc error: code = Canceled desc = grpc: the client connection is closing I0809 09:01:08 19 master_grpc_server.go:265] - client filer@127.0.0.1:8888 I0809 09:01:09 19 master_grpc_server.go:249] + client filer@127.0.0.1:8888 I0809 09:01:11 21 masterclient.go:121] filer masterClient failed to receive from 127.0.0.1:9333: rpc error: code = Canceled desc = grpc: the client connection is closing I0809 09:01:11 19 master_grpc_server.go:265] - client filer@127.0.0.1:8888 I0809 09:01:12 19 master_grpc_server.go:249] + client filer@127.0.0.1:8888 I0809 09:01:14 21 masterclient.go:121] filer masterClient failed to receive from 127.0.0.1:9333: rpc error: code = Canceled desc = grpc: the client connection is closing I0809 09:01:14 19 master_grpc_server.go:265] - client filer@127.0.0.1:8888 I0809 09:01:15 19 master_grpc_server.go:249] + client filer@127.0.0.1:8888 ``` After this error we start having randomly error on access existing files by HTTP: `E0809 09:13:23 21 filer_server_handlers_read.go:168] failed to stream content /01.png: volume 6 not found`</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>5</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>rename</MESSAGE>
    <SHA>8126ab4b5d7204ffcba364e14e857c498e4afe55</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>gRpc connection error on filer when no volume left #2243 fix https://github.com/chrislusf/seaweedfs/issues/2243 grpc do not cache connections only when connection problem happens. Normal error results should not close the shared grpc connection.</MESSAGE>
      <SHA>4909bd968405e33b0250a582081586d804a190a4</SHA>
      <PATCHEDFILES>
        <FILE>weed/pb/grpc_client_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
