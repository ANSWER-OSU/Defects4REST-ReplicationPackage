<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1064</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/1064</ISSUEURL>
  <TITLE>seaweed s3 list_buckets</TITLE>
  <DESCRIPTION>Sponsors SeaweedFS via Patreon https://www.patreon.com/seaweedfs **Describe the bug** I'm using s3 gateway and python boto3 and while trying to list all buckets I'm getting the error: ``` &gt;&gt;&gt; kwrgs = {'endpoint_url': 'http://seaweedfs-s3.default.svc.cluster.local:8333', 'aws_access_key_id': 'accessKey1', 'aws_secret_access_key': 'secretKey1'} &gt;&gt;&gt; import boto3 &gt;&gt;&gt; cli = boto3.client('s3', **kwrgs) &gt;&gt;&gt; cli.list_buckets() Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt; File &quot;/usr/local/lib/python3.7/site-packages/botocore/client.py&quot;, line 357, in _api_call return self._make_api_call(operation_name, kwargs) File &quot;/usr/local/lib/python3.7/site-packages/botocore/client.py&quot;, line 661, in _make_api_call raise error_class(parsed_response, operation_name) botocore.exceptions.ClientError: An error occurred (InternalError) when calling the ListBuckets operation (reached max retries: 4): We encountered an internal error, please try again. ``` I Found only Errors in the s3 gateway: ``` I0916 09:49:36 1 config.go:25] Reading security.toml from I0916 09:49:36 1 config.go:28] Reading : Config File &quot;security&quot; Not Found in &quot;[/ /root/.seaweedfs /etc/seaweedfs]&quot; I0916 09:49:36 1 s3.go:92] Start Seaweed S3 API Server 30GB 1.43 at http port 8333 I0916 09:50:58 1 filer_util.go:89] read directory: directory:&quot;/buckets&quot; limit:2147483647 I0916 09:51:18 1 s3api_handlers.go:78] status 500 application/xml: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;Error&gt;&lt;Code&gt;InternalError&lt;/Code&gt;&lt;Message&gt;We encountered an internal error, please try again.&lt;/Message&gt;&lt;Resource&gt;/&lt;/Resource&gt;&lt;RequestId&gt;1568627478252701334&lt;/RequestId&gt;&lt;/Error&gt; I0916 09:51:19 1 filer_util.go:89] read directory: directory:&quot;/buckets&quot; limit:2147483647 I0916 09:51:39 1 s3api_handlers.go:78] status 500 application/xml: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;Error&gt;&lt;Code&gt;InternalError&lt;/Code&gt;&lt;Message&gt;We encountered an internal error, please try again.&lt;/Message&gt;&lt;Resource&gt;/&lt;/Resource&gt;&lt;RequestId&gt;1568627499203098406&lt;/RequestId&gt;&lt;/Error&gt; I0916 09:51:40 1 filer_util.go:89] read directory: directory:&quot;/buckets&quot; limit:2147483647 I0916 09:52:00 1 s3api_handlers.go:78] status 500 application/xml: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;Error&gt;&lt;Code&gt;InternalError&lt;/Code&gt;&lt;Message&gt;We encountered an internal error, please try again.&lt;/Message&gt;&lt;Resource&gt;/&lt;/Resource&gt;&lt;RequestId&gt;1568627520693419381&lt;/RequestId&gt;&lt;/Error&gt; I0916 09:52:02 1 filer_util.go:89] read directory: directory:&quot;/buckets&quot; limit:2147483647 I0916 09:52:22 1 s3api_handlers.go:78] status 500 application/xml: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;Error&gt;&lt;Code&gt;InternalError&lt;/Code&gt;&lt;Message&gt;We encountered an internal error, please try again.&lt;/Message&gt;&lt;Resource&gt;/&lt;/Resource&gt;&lt;RequestId&gt;1568627542703114894&lt;/RequestId&gt;&lt;/Error&gt; I0916 09:52:30 1 filer_util.go:89] read directory: directory:&quot;/buckets&quot; limit:2147483647 I0916 09:52:50 1 s3api_handlers.go:78] status 500 application/xml: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;Error&gt;&lt;Code&gt;InternalError&lt;/Code&gt;&lt;Message&gt;We encountered an internal error, please try again.&lt;/Message&gt;&lt;Resource&gt;/&lt;/Resource&gt;&lt;RequestId&gt;1568627570429772055&lt;/RequestId&gt;&lt;/Error ``` FYI : The ```weed shell``` can return the ```colletion.list``` and ```fs.tree``` without any issue The s3cmd can't list buckets too put file is working: ```cli.put_object(Bucket='test', Key='test', Body='test')```. output: ``` {'ResponseMetadata': {'RequestId': '1568620869872887033', 'HostId': '', 'HTTPStatusCode': 200, 'HTTPHeaders': {'accept-ranges': 'bytes', 'etag': '&quot;098f6bcd4621d373cade4e832627b4f6&quot;', 'x-amz-request-id': '1568620869872887033', 'date': 'Mon, 16 Sep 2019 08:01:09 GMT', 'content-length': '0'}, 'RetryAttempts': 0}, 'ETag': '&quot;098f6bcd4621d373cade4e832627b4f6&quot;'} ``` **System Setup** - List the command line to start &quot;weed master&quot;, &quot;weed volume&quot;, &quot;weed filer&quot;, &quot;weed s3&quot;, &quot;weed mount&quot;: ``` /usr/bin/weed -v=4 s3 -port=8333 -filer.dir.buckets=/buckets -filer=seaweedfs-filer.default:8888 /usr/bin/weed -v=4 master -port=9333 -mdir=/data -ip.bind=0.0.0.0 -volumeSizeLimitMB=30000 -defaultReplication=000 -ip=seaweedfs-master-0.seaweedfs-master -peers=seaweedfs-master-0.seaweedfs-master:9333 /usr/bin/weed -v=4 volume -port=8080 -dir=/data -max=1000 -ip.bind=0.0.0.0 -read.redirect=true -ip=10.244.83.158 -mserver=seaweedfs-master-0.seaweedfs-master:9333 /usr/bin/weed -v=4 filer -port=8888 -dirListLimit=100000 -ip=10.244.83.155 -master=seaweedfs-master-0.seaweedfs-master:9333 ``` - OS version: ```Ubuntu 18.04.2 LTS``` - output of `weed version`: ```version 30GB 1.43 linux amd64``` - if using filer, show the content of `filer.toml` ``` # A sample TOML config file for SeaweedFS filer store # Used with &quot;weed filer&quot; or &quot;weed server -filer&quot; [memory] # local in memory, mostly for testing purpose enabled = false [leveldb] # local on disk, mostly for simple single-machine setup, fairly scalable enabled = false dir = &quot;/data&quot; # directory to store level db files [leveldb2] # local on disk, mostly for simple single-machine setup, fairly scalable enabled = true dir = &quot;/data/filerldb2&quot; # directory to store level db 2 files #################################################### # multiple filers on shared storage, fairly scalable #################################################### [mysql] # CREATE TABLE IF NOT EXISTS filemeta ( # dirhash BIGINT COMMENT 'first 64 bits of MD5 hash value of directory field', # name VARCHAR(1000) COMMENT 'directory or file name', # directory TEXT COMMENT 'full path to parent directory', # meta BLOB, # PRIMARY KEY (dirhash, name) # ) DEFAULT CHARSET=utf8; enabled = false hostname = &quot;localhost&quot; port = 3306 username = &quot;root&quot; password = &quot;&quot; database = &quot;&quot; # create or use an existing database connection_max_idle = 2 connection_max_open = 100 [postgres] # CREATE TABLE IF NOT EXISTS filemeta ( # dirhash BIGINT, # name VARCHAR(65535), # directory VARCHAR(65535), # meta bytea, # PRIMARY KEY (dirhash, name) # ); enabled = false hostname = &quot;localhost&quot; port = 5432 username = &quot;postgres&quot; password = &quot;&quot; database = &quot;&quot; # create or use an existing database sslmode = &quot;disable&quot; connection_max_idle = 100 connection_max_open = 100 [cassandra] # CREATE TABLE filemeta ( # directory varchar, # name varchar, # meta blob, # PRIMARY KEY (directory, name) # ) WITH CLUSTERING ORDER BY (name ASC); enabled = false keyspace=&quot;seaweedfs&quot; hosts=[ &quot;localhost:9042&quot;, ] [redis] enabled = false address = &quot;localhost:6379&quot; password = &quot;&quot; db = 0 [redis_cluster] enabled = false addresses = [ &quot;localhost:30001&quot;, &quot;localhost:30002&quot;, &quot;localhost:30003&quot;, &quot;localhost:30004&quot;, &quot;localhost:30005&quot;, &quot;localhost:30006&quot;, ] ``` **Expected behavior** List all buckets when has only 1 bucket using python boto3</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>tweaking data types</MESSAGE>
    <SHA>ad3efbb19796b796b3eafe5af66efa5749059d02</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>add logs add logs for https://github.com/chrislusf/seaweedfs/issues/1064</MESSAGE>
      <SHA>20ae55943758afea7b6d464e058c88d6886ab861</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/filer_util.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
