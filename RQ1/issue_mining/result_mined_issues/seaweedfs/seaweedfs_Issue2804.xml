<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2804</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2804</ISSUEURL>
  <TITLE>[bug:master] change of leader each time to the one who last started/restarted</TITLE>
  <DESCRIPTION>change of leader each time to the one who last started/restarted version ``` 2.90 ``` weed master run cmd: ``` /usr/bin/weed -logtostderr=true \ -v=1 \ master \ -mdir /data \ -port &quot;9333&quot; \ -defaultReplication=&quot;100&quot; \ -metricsPort=9090 \ -volumeSizeLimitMB=1000 \ -resumeState=true \ -ip.bind=0.0.0.0 \ -ip ${POD_NAME}.$NAMESPACE-${SEAWEEDFS_FULLNAME}-master-direct.service.dc1.consul \ -peers sw-master-0.s3-sw-master-direct.service.dc1.consul:9333,sw-master-0.s3-sw-master-direct.service.dc2.consul:9333,sw-master-0.s3-sw-master-direct.service.dc3.consul:9333 ``` logs: ``` I0324 14:37:48 1 config.go:44] Reading security.toml from /etc/seaweedfs/security.toml I0324 14:37:48 1 config.go:44] Reading master.toml from /etc/seaweedfs/master.toml I0324 14:37:48 1 file_util.go:23] Folder /data Permission: -rwxrwxr-x I0324 14:37:48 1 master.go:187] current: sw-master-0.s3-sw-master-direct.service.dc1.consul:9333 peers:sw-master-0.s3-sw-master-direct.service.dc1.consul:9333,sw-master-0.s3-sw-master-direct.service.dc2.consul:9333,sw-master-0.s3-sw-master-direct.service.dc3.consul:9333 I0324 14:37:48 1 master_server.go:289] [master.sequencer.type] : [memory] I0324 14:37:48 1 master_server.go:122] Volume Size Limit is 1000 MB I0324 14:37:48 1 master.go:133] Start Seaweed Master 30GB 2.90 497ebbbd at 0.0.0.0:9333 I0324 14:37:48 1 raft_server.go:82] Starting RaftServer with sw-master-0.s3-sw-master-direct.service.dc1.consul:9333 I0324 14:37:48 1 raft_server.go:61] Recovery raft state {MaxVolumeId:208} I0324 14:37:48 1 raft_server.go:143] current cluster leader: I0324 14:38:03 1 master_server.go:165] leader change event: =&gt; sw-master-0.s3-sw-master-direct.service.dc1.consul:9333 I0324 14:38:03 1 master_server.go:168] [ sw-master-0.s3-sw-master-direct.service.dc1.consul:9333 ] sw-master-0.s3-sw-master-direct.service.dc1.consul:9333 becomes leader. I0324 14:38:03 1 cluster_commands.go:28] max volume id 208 ==&gt; 209 I0324 14:38:03 1 cluster_commands.go:28] max volume id 209 ==&gt; 210 I0324 14:38:03 1 cluster_commands.go:28] max volume id 210 ==&gt; 211 I0324 14:38:03 1 cluster_commands.go:28] max volume id 211 ==&gt; 212 I0324 14:38:03 1 cluster_commands.go:28] max volume id 212 ==&gt; 213 I0324 14:38:03 1 cluster_commands.go:28] max volume id 213 ==&gt; 214 I0324 14:38:03 1 cluster_commands.go:28] max volume id 214 ==&gt; 215 I0324 14:38:03 1 cluster_commands.go:28] max volume id 215 ==&gt; 216 I0324 14:38:03 1 cluster_commands.go:28] max volume id 216 ==&gt; 217 I0324 14:38:03 1 cluster_commands.go:28] max volume id 217 ==&gt; 218 I0324 14:38:03 1 cluster_commands.go:28] max volume id 218 ==&gt; 219 I0324 14:38:06 1 master_server.go:175] [ sw-master-0.s3-sw-master-direct.service.dc1.consul:9333 ] sw-master-0.s3-sw-master-direct.service.dc1.consul:9333 is the leader. I0324 14:38:06 1 master.go:165] Start Seaweed Master 30GB 2.90 497ebbbd grpc server at 0.0.0.0:19333 ``` ![Снимок экрана 2022-03-24 в 19 52 04](https://user-images.githubusercontent.com/9497591/159943871-3af8a3f7-c484-4f4a-8e21-20725a57d911.png) ![Снимок экрана 2022-03-24 в 19 57 52](https://user-images.githubusercontent.com/9497591/159945223-773e97aa-4743-4caf-be28-0f0d54f7b0f8.png)</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>20</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #2759 from kmlebedev/skip_wait_cancelled_request Need to exit waiting if request is was canceled</MESSAGE>
    <SHA>89d84e275bfef82b9de0090eb3052ec98b23493d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>always clear previous log to avoid server is promotable https://github.com/chrislusf/seaweedfs/issues/2804</MESSAGE>
      <SHA>fa2ff0e2a0216da72a4c0340d21075354603251d</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/raft_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>always clear previous log to avoid server is promotable https://github.com/chrislusf/seaweedfs/issues/2804</MESSAGE>
      <SHA>c1450bf9fe59d304e94a7dee8051d8c02670edc4</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/raft_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix remove deleted peers of raft server https://github.com/chrislusf/seaweedfs/issues/2804</MESSAGE>
      <SHA>ddd3945c26e6fe505697434d5d2d1cba909c8e29</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/raft_server.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
