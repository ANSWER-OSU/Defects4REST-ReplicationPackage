<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2642</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2642</ISSUEURL>
  <TITLE>[Bug]- weed couldn't estimate the free space of destination disks for transferring ec shards even after adjusting &quot;Max&quot; option to 0</TITLE>
  <DESCRIPTION>Hi, @chrislusf Based on our conversation about [this issue](https://github.com/chrislusf/seaweedfs/issues/2606), I reconfigure my cluster config and I adjust the &quot;Max &quot; option to &quot;0&quot; and weed examined the best number for it based on the disk size, for example, my disk has 7.3 TB of space and weed adjusted max parameter to 73 It's good but in some disks, with the same amount of space it sets the max number to 218 or even more for example weed-volume-005.local:8082 has 7.3TB but weed adjust 218 caused an error for transferring shards. This is because of the count of volumes that were in that specific disks This will cause problems in encoding volumes to ec shards and even concurrency about some volumes of a collection (because volumes of that collection are not filled to weed create a new one and disk is full and weed couldn't accept more objects and files to save on volumes) ![image](https://user-images.githubusercontent.com/43205944/152804414-8f6154cb-2d01-4448-a2cb-b363ac09bd15.png) I test ec.encode again and I got the error about it: weed-volume-005.local:8082 is the one that has 218 volume and cause the following error: ``` &gt; ec.encode -collection 'Channel_20' -volumeId &quot;811&quot; -parallelCopy false markVolumeReadonly 811 on weed-volume-002.local:8085 ... markVolumeReadonly 811 on weed-volume-001.local:8080 ... generateEcShards Channel_20 811 on weed-volume-002.local:8085 ... parallelCopyEcShardsFromSource 811 weed-volume-002.local:8085 allocate 811.[4] weed-volume-002.local:8085 =&gt; weed-volume-028.local:8082 copy 811.[4] weed-volume-002.local:8085 =&gt; weed-volume-028.local:8082 allocate 811.[11] weed-volume-002.local:8085 =&gt; weed-volume-004.local:8083 copy 811.[11] weed-volume-002.local:8085 =&gt; weed-volume-004.local:8083 allocate 811.[10] weed-volume-002.local:8085 =&gt; weed-volume-013.local:8082 copy 811.[10] weed-volume-002.local:8085 =&gt; weed-volume-013.local:8082 allocate 811.[9] weed-volume-002.local:8085 =&gt; weed-volume-001.local:8083 copy 811.[9] weed-volume-002.local:8085 =&gt; weed-volume-001.local:8083 allocate 811.[0] weed-volume-002.local:8085 =&gt; weed-volume-009.local:8081 copy 811.[0] weed-volume-002.local:8085 =&gt; weed-volume-009.local:8081 allocate 811.[3] weed-volume-002.local:8085 =&gt; weed-volume-006.local:8081 copy 811.[3] weed-volume-002.local:8085 =&gt; weed-volume-006.local:8081 allocate 811.[5] weed-volume-002.local:8085 =&gt; weed-volume-005.local:8082 copy 811.[5] weed-volume-002.local:8085 =&gt; weed-volume-005.local:8082 allocate 811.[13] weed-volume-002.local:8085 =&gt; weed-volume-009.local:8080 allocate 811.[8] weed-volume-002.local:8085 =&gt; weed-volume-014.local:8082 allocate 811.[1] weed-volume-002.local:8085 =&gt; weed-volume-016.local:8086 allocate 811.[2] weed-volume-002.local:8085 =&gt; weed-volume-003.local:8086 allocate 811.[6] weed-volume-002.local:8085 =&gt; weed-volume-006.local:8085 allocate 811.[7] weed-volume-002.local:8085 =&gt; weed-volume-007.local:8080 copy 811.[13] weed-volume-002.local:8085 =&gt; weed-volume-009.local:8080 allocate 811.[12] weed-volume-002.local:8085 =&gt; weed-volume-004.local:8080 copy 811.[12] weed-volume-002.local:8085 =&gt; weed-volume-004.local:8080 copy 811.[8] weed-volume-002.local:8085 =&gt; weed-volume-014.local:8082 copy 811.[1] weed-volume-002.local:8085 =&gt; weed-volume-016.local:8086 copy 811.[2] weed-volume-002.local:8085 =&gt; weed-volume-003.local:8086 copy 811.[6] weed-volume-002.local:8085 =&gt; weed-volume-006.local:8085 copy 811.[7] weed-volume-002.local:8085 =&gt; weed-volume-007.local:8080 mount 811.[4] on weed-volume-028.local:8082 I0207 17:36:36 11508 command_ec_common.go:95] weed-volume-002.local:8085 ec volume 811 deletes shards [4] unmount 811.[5] from weed-volume-005.local:8082 delete 811.[5] from weed-volume-005.local:8082 remove aborted shards 811.[5] on weed-volume-005.local:8082: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[6] from weed-volume-006.local:8085 delete 811.[6] from weed-volume-006.local:8085 remove aborted shards 811.[6] on weed-volume-006.local:8085: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[7] from weed-volume-007.local:8080 delete 811.[7] from weed-volume-007.local:8080 remove aborted shards 811.[7] on weed-volume-007.local:8080: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[8] from weed-volume-014.local:8082 delete 811.[8] from weed-volume-014.local:8082 remove aborted shards 811.[8] on weed-volume-014.local:8082: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[9] from weed-volume-001.local:8083 delete 811.[9] from weed-volume-001.local:8083 remove aborted shards 811.[9] on weed-volume-001.local:8083: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[10] from weed-volume-013.local:8082 delete 811.[10] from weed-volume-013.local:8082 remove aborted shards 811.[10] on weed-volume-013.local:8082: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[11] from weed-volume-004.local:8083 delete 811.[11] from weed-volume-004.local:8083 remove aborted shards 811.[11] on weed-volume-004.local:8083: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[12] from weed-volume-004.local:8080 delete 811.[12] from weed-volume-004.local:8080 remove aborted shards 811.[12] on weed-volume-004.local:8080: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[13] from weed-volume-009.local:8080 delete 811.[13] from weed-volume-009.local:8080 remove aborted shards 811.[13] on weed-volume-009.local:8080: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[0] from weed-volume-009.local:8081 delete 811.[0] from weed-volume-009.local:8081 remove aborted shards 811.[0] on weed-volume-009.local:8081: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[1] from weed-volume-016.local:8086 delete 811.[1] from weed-volume-016.local:8086 remove aborted shards 811.[1] on weed-volume-016.local:8086: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[2] from weed-volume-003.local:8086 delete 811.[2] from weed-volume-003.local:8086 remove aborted shards 811.[2] on weed-volume-003.local:8086: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[3] from weed-volume-006.local:8081 delete 811.[3] from weed-volume-006.local:8081 remove aborted shards 811.[3] on weed-volume-006.local:8081: rpc error: code = Internal desc = grpc: error while marshaling: proto: Marshal called with nil unmount 811.[4] from weed-volume-028.local:8082 delete 811.[4] from weed-volume-028.local:8082 error: spread ec shards for volume 811 from weed-volume-002.local:8085: copy 811.[5] weed-volume-002.local:8085 =&gt; weed-volume-005.local:8082 : rpc error: code = Unknown des c = no space left ``` Why weed is trying to transfer shards to a volume with max number of 218 and is filled with 218 volumes? Isn't better for weed to estimate the free space of destination based on the actual free space, not just the count of volumes?</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>test checking ec distribution</MESSAGE>
    <SHA>13f6ec1c4e7737c1e6aaa486a80247b7cabf0448</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>ec.encode: calculate free ec slots based on (maxVolumeCount-volumeCount) fix https://github.com/chrislusf/seaweedfs/issues/2642</MESSAGE>
      <SHA>21aaa4c1f1c85486b5148605f8cb15db3f870be2</SHA>
      <PATCHEDFILES>
        <FILE>weed/shell/command_ec_common.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
