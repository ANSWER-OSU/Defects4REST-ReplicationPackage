<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6217</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/6217</ISSUEURL>
  <TITLE>Helm chart creates wrong match label selector for S3 ServiceMonitor</TITLE>
  <DESCRIPTION>**Describe the bug** ServiceMonitor labels in the helm chart for the S3 service are created with the wrong `matchLabels`. With S3 enabled, and the following global values set: ```yaml global: monitoring: enabled: true ``` The helm chart sets the following selector for the S3 ServiceMonitor: ```yaml spec: selector: matchLabels: app: seaweedfs component: s3 ``` The following labels are applied to the S3 service created by the helm chart: ```yaml labels: app.kubernetes.io/component: s3 app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: seaweedfs argocd.argoproj.io/instance: seaweedfs helm.sh/chart: seaweedfs-4.0.379 ``` This results in the ServiceMonitor never picking up the target for metrics. **System Setup** - I tried the following chart versions and they were all affected - 4.0.377 - 4.0.379 **Expected behavior** The expected selector setting is below: ```yaml spec: selector: matchLabels: app.kubernetes.io/component: s3 app.kubernetes.io/name: seaweedfs ``` This would match the applied labels for the S3 service and pickup the endpoint with the name `seaweedfs`. **Additional context** Removing the non-fully-qualified version of the labels and adding in the fully qualified labels manually through a `kubectl edit` does allow the metrics endpoint to be picked up. I am using `IngoreDifferences` in ArgoCD to keep the manually applied labels for now. Other servicemonitors from the helm chart are created with fully qualified labels for selectors. The following work fine: - seaweedfs-filer - seaweedfs-master - seaweedfs-volume</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>remove the direct_io flag, as it is not well-supported on macOS</MESSAGE>
    <SHA>113c9ce6a83e0554e73aa881a6eb94690a05a0a7</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[helm] fix s3 servicemonitor label matching Fixes issue #6217</MESSAGE>
      <SHA>9ac4adf3730c831dba1d7e3b1d01a7038d7bb885</SHA>
      <PATCHEDFILES>
        <FILE>k8s/charts/seaweedfs/templates/s3-servicemonitor.yaml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
