<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2169</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2169</ISSUEURL>
  <TITLE>Running `npm install` in a nodejs project may result in lost data or &quot;Unknown system error -116&quot;</TITLE>
  <DESCRIPTION>### Describe the bug When running `npm install` in a NodeJS project that is on a SeaweedFS Fuse mount, unexpected behavior happens. Either it fails with something like the following. One thing to note is that it fails on a different modules. ``` npm ERR! code Unknown system error -116 npm ERR! syscall rename npm ERR! path /mnt/seaweedfs/tmp/my-app/node_modules/@types/.uglify-js.DELETE/node_modules/source-map npm ERR! dest /mnt/seaweedfs/tmp/my-app/node_modules/@types/uglify-js/node_modules/source-map npm ERR! errno -116 npm ERR! Unknown system error -116: Unknown system error -116, rename '/mnt/seaweedfs/tmp/my-app/node_modules/@types/.uglify-js.DELETE/node_modules/source-map' -&gt; '/mnt/seaweedfs/tmp/my-app/node_modules/@types/uglify-js/node_modules/source-map' ``` Or it results in **the entire contents of the folder that it was working in being deleted. In one case, it even lost the entire parent folder.** ### Reproduction Instructions The following will download NodeJS, and try to create a react application, during that process it runs `npm install` ``` cd /mnt/seaweedfs mkdir tmp cd tmp wget https://nodejs.org/dist/v14.17.1/node-v14.17.1-linux-x64.tar.xz tar xf node-v14.17.1-linux-x64.tar.xz export PATH=$PATH:`pwd`/node-v14.17.1-linux-x64/bin npx create-react-app my-app ``` Alternative reproduction (with nodejs still being on the PATH): ``` cd /tmp npx create-react-app my-app2 rm -rf my-app/node_modules mv my-app2 /mnt/seaweedfs/tmp/ cd /mnt/seaweedfs/tmp/my-app2 npm install ``` ### System Setup 3 machines with single master and 3 volume servers. `version 30GB 2.56 a2979aa linux amd64` Master: - `/srv/seaweedfs/weed master -mdir=&quot;/srv/seaweedfs/metadata&quot;` - `/srv/seaweedfs/weed volume -max=30 -mserver=localhost:9333 -dir=/srv/seaweedfs/volumes` - `/srv/seaweedfs/weed filer -s3 -s3.config=/srv/seaweedfs/s3.config.json -master=localhost:9333` - `/srv/seaweedfs/weed mount -umask=000 -dir=/mnt/seaweedfs -collection=storage -filer=localhost:8888` - filer.toml: ``` [leveldb2] enabled = true dir = &quot;/srv/seaweedfs/filer&quot; ``` Volume Servers: - `/srv/seaweedfs/weed volume -max=30 -mserver=10.10.10.22:9333 -dir=/srv/seaweedfs/volumes` - `/srv/seaweedfs/weed mount -umask=000 -dir=/mnt/seaweedfs -collection=storage -filer=10.10.10.22:8888` ### Expected behavior `npm install` should finish without any errors and the folder contents should stay where they are in any case. ### Additional Context The following lines appear in the error log on the master. This was collected during the reproduction run when the entire /mnt/seaweedfs/tmp folder was lost. ``` E0630 11:59:59 48653 dir.go:583] UpdateEntry dir /tmp/my-app2/node_modules/.staging/acorn-globals-146eb470: rpc error: code = Unknown desc = not found /tmp/my-app2/node_modules/.staging/acorn-globals-146eb470: filer: no entry is found in filer store E0630 12:00:05 48653 dir.go:583] UpdateEntry dir /tmp/my-app2/node_modules/.staging/@types/webpack-sources-6888de33/lib: rpc error: code = Unknown desc = not found /tmp/my-app2/node_modules/.staging/@types/webpack-sources-6888de33/lib: filer: no entry is found in filer store E0630 12:00:05 48653 meta_cache_subscribe.go:95] subscribing filer meta change: rpc error: code = Canceled desc = grpc: the client connection is closing E0630 12:00:32 48653 dir.go:583] UpdateEntry dir /tmp/my-app2/node_modules/.staging/@types/babel__traverse-25d577b5/ts4.1: rpc error: code = Unknown desc = not found /tmp/my-app2/node_modules/.staging/@types/babel__traverse-25d577b5/ts4.1: filer: no entry is found in filer store ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>45</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>volume: address &quot;unaligned 64-bit atomic operation&quot; fix https://github.com/chrislusf/seaweedfs/issues/2177</MESSAGE>
    <SHA>8fe75692ee9adaae3c2fc0a735ae4d8a172d97ae</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>mount: rename also recursively move file handles related to https://github.com/chrislusf/seaweedfs/issues/2169</MESSAGE>
      <SHA>fa0dab60299e73acfb8bca72b50184722db8e3ab</SHA>
      <PATCHEDFILES>
        <FILE>weed/filesys/dir_rename.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
