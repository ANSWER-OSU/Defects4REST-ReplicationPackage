<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>2075</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/2075</ISSUEURL>
  <TITLE>Corrupt upload using AWS Java SDK</TITLE>
  <DESCRIPTION>**Describe the bug** Client upload using AWS SDK 1.11.745 fails with data integrity error: ``` Unable to verify integrity of data upload. Client calculated content hash (contentMD5: DyYDJ6odjkGLkn0zZ7ojjA== in base 64) didn't match hash (etag: 3df389e4041f77e0a9557d486d6e9fcf in hex) calculated by Amazon S3. You may need to delete the data stored in Amazon S3. (metadata.contentMD5: null, md5DigestStream: com.amazonaws.services.s3.internal.MD5DigestCalculatingInputStream@341308f5, bucketName: foo, key: path/to/key.jar) ``` A partial file is uploaded. Upon download the file is obviously corrupt: ``` $ unzip -l file.jar Archive: file.jar error: End-of-centdir-64 signature not where expected (prepended bytes?) (attempting to process anyway) warning [file.jar]: 230757 extra bytes at beginning or within zipfile (attempting to process anyway) error [file.jar]: start of central directory not found; zipfile corrupt. (please check that you have transferred or created the zipfile in the appropriate BINARY mode and that you have compiled UnZip properly) ``` Example Java SDK usage: ``` if (!amazonS3Client.doesObjectExist(s3Bucket, keyName)) { try { Resource resource = new UrlResource(&quot;path/to/resource&quot;); ObjectMetadata metadata = new ObjectMetadata(); metadata.setContentLength(resource.contentLength()); metadata.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE); PutObjectRequest request = new PutObjectRequest(s3Bucket, keyName, resource.getInputStream(), metadata); amazonS3Client.putObject(request); ``` **System Setup** - `weed master -volumeSizeLimitMB=1000` - `weed volume -dir=/data -mserver=seaweedfs-master:9333 -max=1000 -port=8080` - `weed filer -s3 -master=seaweedfs-master:9333 port=8888` - Docker container chrislusf/seaweedfs:2.48 - output of `weed version` ``` # weed version version 30GB 2.48 45a76222 linux amd64 ``` - if using filer, show the content of `filer.toml` None - using defaults from docker image **Expected behavior** The full file should be uploaded. **Additional context** Uploads using the aws CLI command and the AWS golang API do not have the same issue.</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>organize a bit better for temp file directory</MESSAGE>
    <SHA>2f136a04a1805799bcb9fb9d0cec009084977760</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>s3: add errors if requests are signed by no authentication is setup fix https://github.com/chrislusf/seaweedfs/issues/2075</MESSAGE>
      <SHA>431684798b97d52ccde0bcf2f4749704c5b46455</SHA>
      <PATCHEDFILES>
        <FILE>weed/s3api/s3api_object_handlers.go</FILE>
        <FILE>weed/s3api/s3err/s3api_errors.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
