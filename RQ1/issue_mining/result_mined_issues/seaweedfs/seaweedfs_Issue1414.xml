<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1414</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/1414</ISSUEURL>
  <TITLE>Volume servers don't notice master change</TITLE>
  <DESCRIPTION>We have a constant bug in low load cluster when volume servers don't notice master change. **Our setup** SeaweedFS version - we tryed 1.56 and 1.87 Three hosts 192.168.50.{71,72,73}. There are one master on port 9333 and three volume servers on ports 8081, 8082 8083 per host. All volume servers are in the same DC but are formed in three racks, one rack per host. Commands to start are identical on every host: ``` /bin/weed -v 0 volume -index=leveldbMedium -dataCenter=dc1 -rack=rack1 -dir=/data/swfs/volume1 -max=300 -ip=192.168.50.71 -port=8081 -port.public=8181 -publicUrl=http://192.168.50.71:8181 -mserver=192.168.50.71:9333,192.168.50.72:9333,192.168.50.73:9333 /bin/weed -v 0 volume -index=leveldbMedium -dataCenter=dc1 -rack=rack1 -dir=/data/swfs/volume3 -max=300 -ip=192.168.50.71 -port=8083 -port.public=8183 -publicUrl=http://192.168.50.71:8183 -mserver=192.168.50.71:9333,192.168.50.72:9333,192.168.50.73:9333 /bin/weed -v 0 volume -index=leveldbMedium -dataCenter=dc1 -rack=rack1 -dir=/data/swfs/volume2 -max=300 -ip=192.168.50.71 -port=8082 -port.public=8182 -publicUrl=http://192.168.50.71:8182 -mserver=192.168.50.71:9333,192.168.50.72:9333,192.168.50.73:9333 /bin/weed -v 0 master -volumeSizeLimitMB=50 -defaultReplication=011 -mdir=/data/swfs/master -ip=192.168.50.71 -port=9333 -peers=192.168.50.71:9333,192.168.50.72:9333,192.168.50.73:9333 ``` **Problem** When master changed all volume servers sometimes don't notice new master and keep connection with old one. As a result new master know nothing about volume servers. Cluster status: ``` { &quot;Leader&quot;: &quot;192.168.50.73:9333&quot;, &quot;Peers&quot;: [ &quot;192.168.50.73:9333&quot;, &quot;192.168.50.72:9333&quot; ] } ``` Log from master where we can see new master election: ``` I0806 00:58:45 24607 master_server.go:142] event: &amp;{typ:leaderChange source:0xc0001fa360 value: prevValue:192.168.50.72:9333} I0806 00:58:46 24607 master_server.go:148] state change: &amp;{typ:stateChange source:0xc0001fa360 value:leader prevValue:candidate} I0806 00:58:46 24607 master_server.go:142] event: &amp;{typ:leaderChange source:0xc0001fa360 value:192.168.50.71:9333 prevValue:} I0806 00:58:46 24607 master_server.go:144] [ 192.168.50.71:9333 ] 192.168.50.71:9333 becomes leader. I0806 01:02:16 24607 master_server.go:148] state change: &amp;{typ:stateChange source:0xc0001fa360 value:follower prevValue:leader} I0806 01:02:20 24607 master_server.go:142] event: &amp;{typ:leaderChange source:0xc0001fa360 value:192.168.50.73:9333 prevValue:} I0806 01:02:20 24607 master_server.go:144] [ 192.168.50.71:9333 ] 192.168.50.73:9333 becomes leader. I0806 01:03:48 24607 master_server.go:142] event: &amp;{typ:leaderChange source:0xc0001fa360 value: prevValue:192.168.50.73:9333} I0806 01:03:48 24607 master_server.go:142] event: &amp;{typ:leaderChange source:0xc0001fa360 value:192.168.50.73:9333 prevValue:} I0806 01:03:48 24607 master_server.go:144] [ 192.168.50.71:9333 ] 192.168.50.73:9333 becomes leader. ``` Connections list on the host of old master: ``` ESTAB 0 0 192.168.50.71:60000 192.168.50.71:19333 users:((&quot;weed&quot;,pid=24607,fd=14)) ESTAB 0 0 192.168.50.71:39154 192.168.50.73:18081 users:((&quot;weed&quot;,pid=24607,fd=42)) ESTAB 0 0 192.168.50.71:36896 192.168.50.73:19333 users:((&quot;weed&quot;,pid=24607,fd=22)) ESTAB 0 0 192.168.50.71:41148 192.168.50.71:19333 users:((&quot;weed&quot;,pid=24265,fd=66)) ESTAB 0 0 192.168.50.71:47516 192.168.50.71:18081 users:((&quot;weed&quot;,pid=24607,fd=43)) ESTAB 0 0 192.168.50.71:44232 192.168.50.72:19333 users:((&quot;weed&quot;,pid=24607,fd=20)) ESTAB 0 0 192.168.50.71:54940 192.168.50.72:18082 users:((&quot;weed&quot;,pid=24607,fd=38)) ESTAB 0 0 192.168.50.71:41146 192.168.50.71:19333 users:((&quot;weed&quot;,pid=24264,fd=34)) ESTAB 0 0 192.168.50.71:44190 192.168.50.72:19333 users:((&quot;weed&quot;,pid=24607,fd=13)) ESTAB 0 0 192.168.50.71:39816 192.168.50.72:9333 users:((&quot;weed&quot;,pid=24607,fd=923)) ESTAB 0 0 192.168.50.71:36858 192.168.50.73:19333 users:((&quot;weed&quot;,pid=24607,fd=18)) ESTAB 0 0 192.168.50.71:36884 192.168.50.73:19333 users:((&quot;weed&quot;,pid=24607,fd=21)) ESTAB 0 0 192.168.50.71:60398 192.168.50.71:9333 users:((&quot;weed&quot;,pid=24262,fd=58)) ESTAB 0 0 192.168.50.71:50170 192.168.50.72:18081 users:((&quot;weed&quot;,pid=24607,fd=35)) ESTAB 0 0 192.168.50.71:48738 192.168.50.73:19333 users:((&quot;weed&quot;,pid=24607,fd=24)) ESTAB 0 0 192.168.50.71:41150 192.168.50.71:19333 users:((&quot;weed&quot;,pid=24262,fd=41)) ESTAB 0 0 192.168.50.71:44188 192.168.50.72:19333 users:((&quot;weed&quot;,pid=24607,fd=16)) ESTAB 0 0 192.168.50.71:33368 192.168.50.73:18082 users:((&quot;weed&quot;,pid=24607,fd=41)) ESTAB 0 0 192.168.50.71:48946 192.168.50.71:18082 users:((&quot;weed&quot;,pid=24607,fd=36)) ESTAB 0 0 192.168.50.71:50564 192.168.50.73:18083 users:((&quot;weed&quot;,pid=24607,fd=40)) ESTAB 0 0 192.168.50.71:50906 192.168.50.72:18083 users:((&quot;weed&quot;,pid=24607,fd=39)) ESTAB 0 0 192.168.50.71:33506 192.168.50.73:9333 users:((&quot;weed&quot;,pid=24607,fd=26)) ESTAB 0 0 192.168.50.71:54044 192.168.50.71:18083 users:((&quot;weed&quot;,pid=24607,fd=37)) ESTAB 0 0 192.168.50.71:35770 192.168.50.73:9333 users:((&quot;weed&quot;,pid=24607,fd=931)) ESTAB 0 0 192.168.50.71:36860 192.168.50.73:19333 users:((&quot;weed&quot;,pid=24607,fd=19)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.73]:40678 users:((&quot;weed&quot;,pid=24607,fd=17)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.73]:49992 users:((&quot;weed&quot;,pid=24607,fd=28)) ESTAB 0 0 [::ffff:192.168.50.71]:9333 [::ffff:192.168.50.71]:60398 users:((&quot;weed&quot;,pid=24607,fd=51)) ESTAB 0 0 [::ffff:192.168.50.71]:18082 [::ffff:192.168.50.71]:48946 users:((&quot;weed&quot;,pid=24265,fd=67)) ESTAB 0 0 [::ffff:192.168.50.71]:18081 [::ffff:192.168.50.73]:49072 users:((&quot;weed&quot;,pid=24262,fd=44)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.73]:52480 users:((&quot;weed&quot;,pid=24607,fd=46)) ESTAB 0 0 [::ffff:192.168.50.71]:9333 [::ffff:192.168.50.73]:52468 users:((&quot;weed&quot;,pid=24607,fd=58)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.72]:42828 users:((&quot;weed&quot;,pid=24607,fd=31)) ESTAB 0 0 [::ffff:192.168.50.71]:9333 [::ffff:192.168.50.72]:37546 users:((&quot;weed&quot;,pid=24607,fd=33)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.71]:41148 users:((&quot;weed&quot;,pid=24607,fd=48)) ESTAB 0 0 [::ffff:192.168.50.71]:18083 [::ffff:192.168.50.71]:54044 users:((&quot;weed&quot;,pid=24264,fd=37)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.72]:42830 users:((&quot;weed&quot;,pid=24607,fd=32)) ESTAB 0 0 [::ffff:192.168.50.71]:9333 [::ffff:192.168.50.73]:43658 users:((&quot;weed&quot;,pid=24607,fd=34)) ESTAB 0 0 [::ffff:192.168.50.71]:9333 [::ffff:192.168.50.73]:59592 users:((&quot;weed&quot;,pid=24607,fd=27)) ESTAB 0 0 [::ffff:192.168.50.71]:9333 [::ffff:192.168.50.72]:46924 users:((&quot;weed&quot;,pid=24607,fd=44)) ESTAB 0 0 [::ffff:192.168.50.71]:18083 [::ffff:192.168.50.73]:38330 users:((&quot;weed&quot;,pid=24264,fd=38)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.72]:33472 users:((&quot;weed&quot;,pid=24607,fd=11)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.72]:42826 users:((&quot;weed&quot;,pid=24607,fd=30)) ESTAB 0 0 [::ffff:192.168.50.71]:18082 [::ffff:192.168.50.73]:42020 users:((&quot;weed&quot;,pid=24265,fd=68)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.73]:49994 users:((&quot;weed&quot;,pid=24607,fd=29)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.73]:49990 users:((&quot;weed&quot;,pid=24607,fd=25)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.71]:60000 users:((&quot;weed&quot;,pid=24607,fd=15)) ESTAB 0 0 [::ffff:192.168.50.71]:18081 [::ffff:192.168.50.71]:47516 users:((&quot;weed&quot;,pid=24262,fd=43)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.71]:41146 users:((&quot;weed&quot;,pid=24607,fd=47)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.71]:41150 users:((&quot;weed&quot;,pid=24607,fd=49)) ESTAB 0 0 [::ffff:192.168.50.71]:19333 [::ffff:192.168.50.72]:45288 users:((&quot;weed&quot;,pid=24607,fd=45)) ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>volume: report Content-MD5 in response header</MESSAGE>
    <SHA>4ecfa9879d8f7c70b4515ac31440a111ae274dc3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>volume: the variable for the master node may be stale? related to https://github.com/chrislusf/seaweedfs/issues/1414</MESSAGE>
      <SHA>93ea0801ea65375c16f148c9e77056e6c145f770</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/master_grpc_server.go</FILE>
        <FILE>weed/server/volume_grpc_client_to_master.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
