<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1037</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/1037</ISSUEURL>
  <TITLE>panic: runtime error: invalid memory address or nil pointer dereference</TITLE>
  <DESCRIPTION>we run a 3 nodes cluster, the filer crashed with the logs below: ` I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.8:8086/356,1ceface4bc067f11 I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.9:8083/358,1ceface561ee49ac E0810 09:30:20 50306 filer_server_handlers_write.go:220] failing to connect to volume server /buckets/flying/city_77accf10-de57-4b2a-9290-c454b74855bb_2450ce47-fa12-4675-9178-1a420758a7f4_2019-08-10-09-30-20?collection=flying: Put http://10.1.1.9:8083/358,1cefad550f83e29a: EOF, PUT I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.9:8083/358,1ceface3c9c41095 I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.8:8084/357,1cefaceebf43bfd6 I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.9:8083/358,1cefacec70d021cb I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.9:8083/358,1cefacea2dc550fc I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.10:8086/355,1cefacf1c7d2c9fc I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.8:8084/357,1cefad18509228e2 I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.8:8086/356,1cefacf9cbb94966 I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.10:8088/359,1cefad141ac736e7 I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.10:8088/359,1cefad26a6f3862d I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.8:8084/357,1cefad3a7c0259cc I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.9:8083/358,1cefad1a7570d893 I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.10:8088/359,1cefaced3a003efa I0810 09:30:20 50306 filer_server_handlers_read.go:110] retrieving from http://10.1.1.9:8083/358,1cefad72b0d58766 panic: runtime error: invalid memory address or nil pointer dereference [signal SIGSEGV: segmentation violation code=0x1 addr=0x10 pc=0x5ddc4f] goroutine 1891459290 [running]: bufio.(*Writer).Available(...) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/bufio/bufio.go:607 bufio.(*Writer).WriteString(0x0, 0x18c2de7, 0x19, 0x10100c00ecbd498, 0x0, 0x8000) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/bufio/bufio.go:688 +0x7f net/http.(*expectContinueReader).Read(0xc00905c1e0, 0xc00a722000, 0x8000, 0x8000, 0xc0130e2c20, 0x44409c, 0x8000) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/net/http/server.go:890 +0x13b net/http.transferBodyReader.Read(0xc00eb29cc0, 0xc00a722000, 0x8000, 0x8000, 0x0, 0x2a19e00, 0xc011385ea8) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/net/http/transfer.go:62 +0x56 io.copyBuffer(0x7f97ebea0388, 0xc00f992df0, 0x1bd4440, 0xc00eb29cc0, 0xc00a722000, 0x8000, 0x8000, 0x3, 0x1, 0xc0130e2d01) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/io/io.go:402 +0x122 io.Copy(...) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/io/io.go:364 net/http.(*transferWriter).writeBody(0xc00eb29cc0, 0x1bce700, 0xc0101f65c0, 0x2, 0x2) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/net/http/transfer.go:358 +0x16b net/http.(*Request).write(0xc004719500, 0x1bce700, 0xc0101f65c0, 0x0, 0x0, 0xc00cf8d280, 0x0, 0x0) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/net/http/request.go:655 +0x721 net/http.(*persistConn).writeLoop(0xc00003d320) /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/net/http/transport.go:1979 +0x1b8 created by net/http.(*Transport).dialConn /home/travis/.gimme/versions/go1.12.6.linux.amd64/src/net/http/transport.go:1358 +0xb0d`</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>80</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>volume: fail the volume deletion if compaction is in progress fix https://github.com/chrislusf/seaweedfs/issues/1035</MESSAGE>
    <SHA>e40634e6b49e8ab20720c7b8625b9333bf2bab37</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>volume: protect against nil needle map fix @mastak reported nil problem in https://github.com/chrislusf/seaweedfs/issues/1037</MESSAGE>
      <SHA>d829df4f5964e6c0397fcba30554f7b5e4875ea8</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/needle_map_metric.go</FILE>
        <FILE>weed/storage/store.go</FILE>
        <FILE>weed/storage/volume.go</FILE>
        <FILE>weed/storage/volume_backup.go</FILE>
        <FILE>weed/storage/volume_read_write.go</FILE>
        <FILE>weed/storage/volume_vacuum.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
