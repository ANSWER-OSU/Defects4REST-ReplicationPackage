<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4175</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/4175</ISSUEURL>
  <TITLE>[shell] SIGSEV of the command filer.remote.sync on a S3 cloud mount</TITLE>
  <DESCRIPTION>**Describe the bug** The command `weed filer.remote.sync -dir=/media -filer localhost:8889` crash with a SIGSEV signal each time it's run. **System Setup** The system consists of 2 VM: - 1 weed master on the server1 - 2 weed volume on server1 and server 2 - 2 filer on server 1 and 2 - The filers use leveldb2 - the filers are replicated - Use of the Cloud drive functionality on /media, to synchronise files to an S3 storage - The remote storage is a S3 store by OVH The 2 servers run on Ubuntu 20.04, with the same patch level, updated 1 week ago Seaweed Version: version 30GB 3.40 2885ba0e508075762d732468334890c51f419aed linux amd64 The filer is configured from the command line without a file: `weed filer -port 8889 -ip.bind 0.0.0.0 -ip X.X.X.X -s3 -master X.X.X.X:9333 -dataCenter=XXXX -rack=XXX -metricsPort=9328` **Expected behavior** When using the command `weed filer.remote.sync -dir=/media -filer localhost:8889` the files were continuously synchronised to the S3 storage. This was working for 4 months I had to stop the sync process for a maintenance, when restarted the same command, it started to crash with SIGSEV, This is the output of the crash: ``` I0202 00:10:34.936962 filer_remote_sync_dir.go:193 create ovhMedia/media-prod/ged/b7b3/d9a0/CI_1-KKVQ2M_20230131102343081.b8ce.jpg I0202 00:10:34.946589 filer_remote_sync_dir.go:193 create ovhMedia/media-prod/ged/5cf2/4dc9/CR_CAM23004904_001.5402.pdf panic: runtime error: invalid memory address or nil pointer dereference [signal SIGSEGV: segmentation violation code=0x1 addr=0x28 pc=0x102f023] goroutine 444 [running]: github.com/seaweedfs/seaweedfs/weed/filer.(*ChunkStreamReader).prepareBufferFor(0x3c6d3a0?, 0xc000f7da08?) /github/workspace/weed/filer/stream.go:305 +0x43 github.com/seaweedfs/seaweedfs/weed/filer.(*ChunkStreamReader).ReadAt(0xc000a0e000, {0xc000fd8000, 0x2000, 0x2000}, 0x0) /github/workspace/weed/filer/stream.go:241 +0xc8 io.(*SectionReader).Read(0xc000ac8900, {0xc000fd8000?, 0xc000f7da30?, 0x3?}) /usr/local/go/src/io/io.go:513 +0x54 github.com/aws/aws-sdk-go/aws/request.(*offsetReader).Read(0x3c094c0?, {0xc000fd8000?, 0xc0006cfc00?, 0x7f3e7a30ba80?}) /go/pkg/mod/github.com/aws/aws-sdk-go@v1.44.175/aws/request/offset_reader.go:47 +0x129 io.discard.ReadFrom({}, {0x7f3e7a34e130, 0xc00013d6e0}) /usr/local/go/src/io/io.go:611 +0x72 io.copyBuffer({0x2a18380, 0x3c6a420}, {0x7f3e7a34e130, 0xc00013d6e0}, {0x0, 0x0, 0x0}) /usr/local/go/src/io/io.go:413 +0x14b io.Copy(...) /usr/local/go/src/io/io.go:386 net/http.(*transferWriter).doBodyCopy(0xc000001720, {0x2a18380?, 0x3c6a420?}, {0x7f3e7a34e130?, 0xc00013d6e0?}) /usr/local/go/src/net/http/transfer.go:412 +0x4d net/http.(*transferWriter).writeBody(0xc000001720, {0x2a0a420, 0xc0006eccc0}) /usr/local/go/src/net/http/transfer.go:375 +0x418 net/http.(*Request).write(0xc00047b500, {0x2a0a420, 0xc0006eccc0}, 0x0, 0xc000f519b0, 0x0) /usr/local/go/src/net/http/request.go:701 +0xb46 net/http.(*persistConn).writeLoop(0xc0004ed680) /usr/local/go/src/net/http/transport.go:2395 +0x174 created by net/http.(*Transport).dialConn /usr/local/go/src/net/http/transport.go:1752 +0x1791 ``` When launching the command a second time, it seems to continue to process new files, but then crash later: ``` I0202 00:14:25.445717 filer_remote_sync_dir.go:193 create ovhMedia/media-prod/ged/f7ba/7a16/CI_1-KBIVC9_20230131091836485.0dcd.jpg I0202 00:14:25.455761 filer_remote_sync_dir.go:193 create ovhMedia/media-prod/ged/ae0b/37cc/CI_1-KCQ2RK_20230131155422324.89c4.jpg I0202 00:14:25.475629 filer_remote_sync_dir.go:193 create ovhMedia/media-prod/ged/4feb/dc60/CI_1-KCQ2RK_20230131155458711.2f07.jpg panic: runtime error: invalid memory address or nil pointer dereference [signal SIGSEGV: segmentation violation code=0x1 addr=0x28 pc=0x102f023] goroutine 454 [running]: github.com/seaweedfs/seaweedfs/weed/filer.(*ChunkStreamReader).prepareBufferFor(0x3c6d3a0?, 0xc000fb3a08?) /github/workspace/weed/filer/stream.go:305 +0x43 github.com/seaweedfs/seaweedfs/weed/filer.(*ChunkStreamReader).ReadAt(0xc000e66480, {0xc000836000, 0x2000, 0x2000}, 0x0) /github/workspace/weed/filer/stream.go:241 +0xc8 io.(*SectionReader).Read(0xc000f42510, {0xc000836000?, 0xc000fb3a30?, 0x3?}) /usr/local/go/src/io/io.go:513 +0x54 github.com/aws/aws-sdk-go/aws/request.(*offsetReader).Read(0x3c094c0?, {0xc000836000?, 0xc000d6a000?, 0x7fc4ccd0aa18?}) /go/pkg/mod/github.com/aws/aws-sdk-go@v1.44.175/aws/request/offset_reader.go:47 +0x129 io.discard.ReadFrom({}, {0x7fc4ccd4ba50, 0xc000f46140}) /usr/local/go/src/io/io.go:611 +0x72 io.copyBuffer({0x2a18380, 0x3c6a420}, {0x7fc4ccd4ba50, 0xc000f46140}, {0x0, 0x0, 0x0}) /usr/local/go/src/io/io.go:413 +0x14b io.Copy(...) /usr/local/go/src/io/io.go:386 net/http.(*transferWriter).doBodyCopy(0xc0005686e0, {0x2a18380?, 0x3c6a420?}, {0x7fc4ccd4ba50?, 0xc000f46140?}) /usr/local/go/src/net/http/transfer.go:412 +0x4d net/http.(*transferWriter).writeBody(0xc0005686e0, {0x2a0a420, 0xc000b182c0}) /usr/local/go/src/net/http/transfer.go:375 +0x418 net/http.(*Request).write(0xc000547000, {0x2a0a420, 0xc000b182c0}, 0x0, 0xc0008af890, 0x0) /usr/local/go/src/net/http/request.go:701 +0xb46 net/http.(*persistConn).writeLoop(0xc0003b9b00) /usr/local/go/src/net/http/transport.go:2395 +0x174 created by net/http.(*Transport).dialConn /usr/local/go/src/net/http/transport.go:1752 +0x1791 ``` The command crash after synchronising multiples files. The number of files synchronised before the crash is not constant, sometimes it's 2 or 3 more or less than the last run.</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch 'master' of https://github.com/seaweedfs/seaweedfs</MESSAGE>
    <SHA>0932437a1c772226d430018ae908be866ae8ef8b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix filer.remote.sync on a S3 cloud mount fix https://github.com/seaweedfs/seaweedfs/issues/4175</MESSAGE>
      <SHA>84e9934bf9143076fba5cbe0e2251a6628576202</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/stream.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
