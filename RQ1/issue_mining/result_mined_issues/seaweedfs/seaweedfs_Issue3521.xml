<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3521</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3521</ISSUEURL>
  <TITLE>[master] panic if use hashicorp with -race detect</TITLE>
  <DESCRIPTION>``` master branch cd docker; make hashicorp_raft with -race ``` ``` master2_1 | master2_1 | goroutine 1 [running]: master2_1 | runtime.throw({0x334f6b4?, 0x26ed401?}) master2_1 | /usr/local/go/src/runtime/panic.go:1047 +0x5d fp=0xc0008c6f88 sp=0xc0008c6f58 pc=0x47205d master2_1 | runtime.checkptrAlignment(0x4aa339?, 0x4840a5?, 0x5865a28?) master2_1 | /usr/local/go/src/runtime/checkptr.go:26 +0x6c fp=0xc0008c6fa8 sp=0xc0008c6f88 pc=0x43e7ac master2_1 | github.com/boltdb/bolt.(*Bucket).write(0xc0008c7140) master2_1 | /go/pkg/mod/github.com/boltdb/bolt@v1.3.1/bucket.go:626 +0x211 fp=0xc0008c7038 sp=0xc0008c6fa8 pc=0x26f13f1 master2_1 | github.com/boltdb/bolt.(*Bucket).CreateBucket(0xc000872018, {0x5865a28, 0x4, 0x4}) master2_1 | /go/pkg/mod/github.com/boltdb/bolt@v1.3.1/bucket.go:188 +0x3e9 fp=0xc0008c7228 sp=0xc0008c7038 pc=0x26ed409 master2_1 | github.com/boltdb/bolt.(*Bucket).CreateBucketIfNotExists(0x0?, {0x5865a28, 0x4, 0x4}) master2_1 | /go/pkg/mod/github.com/boltdb/bolt@v1.3.1/bucket.go:206 +0x4f fp=0xc0008c7278 sp=0xc0008c7228 pc=0x26ed6cf master2_1 | github.com/boltdb/bolt.(*Tx).CreateBucketIfNotExists(...) master2_1 | /go/pkg/mod/github.com/boltdb/bolt@v1.3.1/tx.go:115 master2_1 | github.com/hashicorp/raft-boltdb.(*BoltStore).initialize(0xc000012360) master2_1 | /go/pkg/mod/github.com/hashicorp/raft-boltdb@v0.0.0-20220329195025-15018e9b97e0/bolt_store.go:100 +0xeb fp=0xc0008c7320 sp=0xc0008c7278 pc=0x270f3eb master2_1 | github.com/hashicorp/raft-boltdb.New({{0xc0006cc3f0, 0x14}, 0x0, 0x0}) master2_1 | /go/pkg/mod/github.com/hashicorp/raft-boltdb@v0.0.0-20220329195025-15018e9b97e0/bolt_store.go:83 +0x19c fp=0xc0008c73a8 sp=0xc0008c7320 pc=0x270f23c master2_1 | github.com/hashicorp/raft-boltdb.NewBoltStore(...) master2_1 | /go/pkg/mod/github.com/hashicorp/raft-boltdb@v0.0.0-20220329195025-15018e9b97e0/bolt_store.go:62 master2_1 | github.com/seaweedfs/seaweedfs/weed/server.NewHashicorpRaftServer(0xc0008c7bf0) master2_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/server/raft_hashicorp.go:131 +0x8b8 fp=0xc0008c77f8 sp=0xc0008c73a8 pc=0x27b8b98 master2_1 | github.com/seaweedfs/seaweedfs/weed/command.startMaster({0xc000672ac8, 0xc000672af8, 0xc0004f0cc0, 0xc0004f0ce0, 0xc0004f0cf0, 0xc0004f0d10, 0xc000672bd8, 0xc000672c1f, 0xc0004f0d20, 0xc000672c48, ...}, ...) master2_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/command/master.go:170 +0x999 fp=0xc0008c7c60 sp=0xc0008c77f8 pc=0x2cb4099 master2_1 | github.com/seaweedfs/seaweedfs/weed/command.runMaster(0x5927b58?, {0xc000000170?, 0x7?, 0x7?}) master2_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/command/master.go:122 +0x4b0 fp=0xc0008c7e40 sp=0xc0008c7c60 pc=0x2cb3650 master2_1 | main.main() master2_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/weed.go:81 +0x944 fp=0xc0008c7f80 sp=0xc0008c7e40 pc=0x2cd6504 master2_1 | runtime.main() master2_1 | /usr/local/go/src/runtime/proc.go:250 +0x212 fp=0xc0008c7fe0 sp=0xc0008c7f80 pc=0x4748b2 master2_1 | runtime.goexit() master2_1 | /usr/local/go/src/runtime/asm_amd64.s:1594 +0x1 fp=0xc0008c7fe8 sp=0xc0008c7fe0 pc=0x4a8ba1 master2_1 | master2_1 | goroutine 2 [force gc (idle)]: master2_1 | runtime.gopark(0x0?, 0x0?, 0x0?, 0x0?, 0x0?) master2_1 | /usr/local/go/src/runtime/proc.go:363 +0xd6 fp=0xc000070fb0 sp=0xc000070f90 pc=0x474c76 master2_1 | runtime.goparkunlock(...) master2_1 | /usr/local/go/src/runtime/proc.go:369 master2_1 | runtime.forcegchelper() master2_1 | /usr/local/go/src/runtime/proc.go:302 +0xad fp=0xc000070fe0 sp=0xc000070fb0 pc=0x474b0d master2_1 | runtime.goexit() master2_1 | /usr/local/go/src/runtime/asm_amd64.s:1594 +0x1 fp=0xc000070fe8 sp=0xc000070fe0 pc=0x4a8ba1 master2_1 | created by runtime.init.6 master2_1 | /usr/local/go/src/runtime/proc.go:290 +0x25 master2_1 | master2_1 | goroutine 18 [GC sweep wait]: master2_1 | runtime.gopark(0x1?, 0x0?, 0x0?, 0x0?, 0x0?) master2_1 | /usr/local/go/src/runtime/proc.go:363 +0xd6 fp=0xc00006c790 sp=0xc00006c770 pc=0x474c76 master2_1 | runtime.goparkunlock(...) master2_1 | /usr/local/go/src/runtime/proc.go:369 master2_1 | runtime.bgsweep(0x0?) master2_1 | /usr/local/go/src/runtime/mgcsweep.go:297 +0xd7 fp=0xc00006c7c8 sp=0xc00006c790 pc=0x45ee97 master2_1 | runtime.gcenable.func1() master2_1 | /usr/local/go/src/runtime/mgc.go:178 +0x26 fp=0xc00006c7e0 sp=0xc00006c7c8 pc=0x453b06 master2_1 | runtime.goexit() master2_1 | /usr/local/go/src/runtime/asm_amd64.s:1594 +0x1 fp=0xc00006c7e8 sp=0xc00006c7e0 pc=0x4a8ba1 master2_1 | created by runtime.gcenable master2_1 | /usr/local/go/src/runtime/mgc.go:178 +0x6b master2_1 | master2_1 | goroutine 19 [GC scavenge wait]: master2_1 | runtime.gopark(0xc00010e000?, 0x46ba538?, 0x0?, 0x0?, 0x0?) master2_1 | /usr/local/go/src/runtime/proc.go:363 +0xd6 fp=0xc00006cf70 sp=0xc00006cf50 pc=0x474c76 master2_1 | runtime.goparkunlock(...) master2_1 | /usr/local/go/src/runtime/proc.go:369 master2_1 | runtime.(*scavengerState).park(0x5944e40) master2_1 | /usr/local/go/src/runtime/mgcscavenge.go:389 +0x53 fp=0xc00006cfa0 sp=0xc00006cf70 pc=0x45cf13 master2_1 | runtime.bgscavenge(0x0?) master2_1 | /usr/local/go/src/runtime/mgcscavenge.go:622 +0x65 fp=0xc00006cfc8 sp=0xc00006cfa0 pc=0x45d4e5 master2_1 | runtime.gcenable.func2() master2_1 | /usr/local/go/src/runtime/mgc.go:179 +0x26 fp=0xc00006cfe0 sp=0xc00006cfc8 pc=0x453aa6 master2_1 | runtime.goexit() master2_1 | /usr/local/go/src/runtime/asm_amd64.s:1594 +0x1 fp=0xc00006cfe8 sp=0xc00006cfe0 pc=0x4a8ba1 master2_1 | created by runtime.gcenable master2_1 | /usr/local/go/src/runtime/mgc.go:179 +0xaa master2_1 | master2_1 | goroutine 3 [finalizer wait]: master2_1 | runtime.gopark(0xc000007860?, 0x0?, 0x0?, 0x6?, 0xc000070770?) master2_1 | /usr/local/go/src/runtime/proc.go:363 +0xd6 fp=0xc000070628 sp=0xc000070608 pc=0x474c76 master2_1 | runtime.goparkunlock(...) master2_1 | /usr/local/go/src/runtime/proc.go:369 master2_1 | runtime.runfinq() master2_1 | /usr/local/go/src/runtime/mfinal.go:180 +0x145 fp=0xc0000707e0 sp=0xc000070628 pc=0x452c25 master2_1 | runtime.goexit() master2_1 | /usr/local/go/src/runtime/asm_amd64.s:1594 +0x1 fp=0xc0000707e8 sp=0xc0000707e0 pc=0x4a8ba1 master2_1 | created by runtime.createfing master2_1 | /usr/local/go/src/runtime/mfinal.go:157 +0x45 master2_1 | master2_1 | goroutine 4 [chan receive]: master2_1 | runtime.gopark(0xc000064f00?, 0xc0001b4008?, 0x9?, 0x61?, 0xc000074c00?) master2_1 | /usr/local/go/src/runtime/proc.go:363 +0xd6 fp=0xc0000716b8 sp=0xc000071698 pc=0x474c76 master2_1 | runtime.chanrecv(0xc0001b0000, 0xc000071798, 0x1) master2_1 | /usr/local/go/src/runtime/chan.go:583 +0x42c fp=0xc000071748 sp=0xc0000716b8 pc=0x43df8c master2_1 | runtime.chanrecv2(0x6fc23ac00?, 0x0?) master2_1 | /usr/local/go/src/runtime/chan.go:447 +0x18 fp=0xc000071770 sp=0xc000071748 pc=0x43db38 master2_1 | github.com/seaweedfs/seaweedfs/weed/glog.(*loggingT).flushDaemon(0x0?) master2_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/glog/glog.go:882 +0x8b fp=0xc0000717c0 sp=0xc000071770 pc=0xc75b0b master2_1 | github.com/seaweedfs/seaweedfs/weed/glog.init.0.func1() master2_1 | /go/src/github.com/seaweedfs/seaweedfs/weed/glog/glog.go:410 +0x3a fp=0xc0000717e0 sp=0xc0000717c0 pc=0xc72b7a ``` https://github.com/seaweedfs/seaweedfs/issues/3507</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>avoid race conditions access to SuperBlock.Version (#3539) * avoid race conditions access to SuperBlock.Version https://github.com/seaweedfs/seaweedfs/issues/3515 * superBlockAccessLock replace to sync.Mutex</MESSAGE>
    <SHA>ade94b0d0a71db7db117454c075dc93f839e1c9c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>migrate from boltdb to bbolt https://github.com/seaweedfs/seaweedfs/issues/3521 https://github.com/hashicorp/raft/issues/521</MESSAGE>
      <SHA>43a92d10e5a2bcb2931b6d6b4bdd49a82d5323fc</SHA>
      <PATCHEDFILES>
        <FILE>go.mod</FILE>
        <FILE>go.sum</FILE>
        <FILE>weed/server/raft_hashicorp.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
