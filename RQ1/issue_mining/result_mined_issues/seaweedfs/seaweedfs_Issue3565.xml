<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3565</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3565</ISSUEURL>
  <TITLE>[filer] DATA RACE on doSubscribeToOneFiler</TITLE>
  <DESCRIPTION>https://github.com/seaweedfs/seaweedfs/issues/3507 ``` ================== WARNING: DATA RACE Read at 0x00c0000004f4 by goroutine 2579: github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).doSubscribeToOneFiler.func4() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:197 +0x124 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcFilerClient.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:264 +0x88 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:149 +0x248 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcFilerClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:262 +0xc9 github.com/seaweedfs/seaweedfs/weed/pb.WithFilerClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:256 +0x85e github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).doSubscribeToOneFiler() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:194 +0x41 github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).loopSubscribeToOneFiler() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:97 +0x2fe github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).OnPeerUpdate.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:61 +0xce Previous write at 0x00c0000004f4 by goroutine 2578: github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).doSubscribeToOneFiler.func4() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:197 +0x144 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcFilerClient.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:264 +0x88 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:149 +0x248 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcFilerClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:262 +0xc9 github.com/seaweedfs/seaweedfs/weed/pb.WithFilerClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:256 +0x85e github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).doSubscribeToOneFiler() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:194 +0x41 github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).loopSubscribeToOneFiler() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:97 +0x2fe github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).OnPeerUpdate.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:61 +0xce Goroutine 2579 (running) created at: github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).OnPeerUpdate() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:61 +0x404 github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).OnPeerUpdate-fm() &lt;autogenerated&gt;:1 +0x72 github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryConnectToMaster.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:250 +0x203b github.com/seaweedfs/seaweedfs/weed/pb.WithMasterClient.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:209 +0x88 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:149 +0x248 github.com/seaweedfs/seaweedfs/weed/pb.WithMasterClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:207 +0xd1 github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryConnectToMaster() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:173 +0x27e github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryAllMasters() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:164 +0x10e github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).KeepConnectedToMaster() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:128 +0x129 github.com/seaweedfs/seaweedfs/weed/filer.(*Filer).KeepMasterClientConnected() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/filer.go:146 +0x45 github.com/seaweedfs/seaweedfs/weed/server.NewFilerServer.func4() /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server.go:131 +0x39 Goroutine 2578 (running) created at: github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).OnPeerUpdate() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/meta_aggregator.go:61 +0x404 github.com/seaweedfs/seaweedfs/weed/filer.(*MetaAggregator).OnPeerUpdate-fm() &lt;autogenerated&gt;:1 +0x72 github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryConnectToMaster.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:250 +0x203b github.com/seaweedfs/seaweedfs/weed/pb.WithMasterClient.func1() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:209 +0x88 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:149 +0x248 github.com/seaweedfs/seaweedfs/weed/pb.WithMasterClient() /go/src/github.com/seaweedfs/seaweedfs/weed/pb/grpc_client_server.go:207 +0xd1 github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryConnectToMaster() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:173 +0x27e github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).tryAllMasters() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:164 +0x10e github.com/seaweedfs/seaweedfs/weed/wdclient.(*MasterClient).KeepConnectedToMaster() /go/src/github.com/seaweedfs/seaweedfs/weed/wdclient/masterclient.go:128 +0x129 github.com/seaweedfs/seaweedfs/weed/filer.(*Filer).KeepMasterClientConnected() /go/src/github.com/seaweedfs/seaweedfs/weed/filer/filer.go:146 +0x45 github.com/seaweedfs/seaweedfs/weed/server.NewFilerServer.func4() /go/src/github.com/seaweedfs/seaweedfs/weed/server/filer_server.go:131 +0x39 ================== ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>upload_content: upload close response.Body</MESSAGE>
    <SHA>4a4ef3cc3c24d0c86defe82445448a567316cc36</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid data race on doSubscribeToOneFiler/ma.filer.UniqueFilerEpoch https://github.com/seaweedfs/seaweedfs/issues/3565</MESSAGE>
      <SHA>281e666113a8b72fcdace9b370b2342e3bd1783e</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/meta_aggregator.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>avoid data race on doSubscribeToOneFiler/ma.filer.UniqueFilerEpoch (#3566) https://github.com/seaweedfs/seaweedfs/issues/3565</MESSAGE>
      <SHA>803ca3c9589ce11d1799ded47bce25c58f179d85</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/meta_aggregator.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
