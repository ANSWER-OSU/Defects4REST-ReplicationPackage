<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3384</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3384</ISSUEURL>
  <TITLE>Support Locking via FUSE Mount</TITLE>
  <DESCRIPTION>**Describe the bug** When running the `linuxserver/plex:latest` [Docker image](https://hub.docker.com/r/linuxserver/plex) with its `/config` folder mapped to a collection mounted via FUSE (weed mount), the Plex internal SQLite3 DB gets corrupted constantly **System Setup** - List the command line to start &quot;weed master&quot;, &quot;weed volume&quot;, &quot;weed filer&quot;, &quot;weed s3&quot;, &quot;weed mount&quot;. - OS version Ubuntu 22.04 arm64 - output of `weed version` version 30GB 3.18 475185fb linux arm64 - if using filer, show the content of `filer.toml` ``` [leveldb3] enabled = true dir = &quot;/filer&quot; ``` **Expected behavior** This used to work well in the past but now it renders Plex unusable right after it starts. According to the Plex Docker documentation `Note: the underlying filesystem needs to support file locking. This is known to not be default enabled on remote filesystems like NFS, SMB, and many many others. The 9PFS filesystem used by FreeNAS Corral is known to work but the vast majority will result in database corruption. Use a network share at your own risk.` Expected behaviour is that Plex can use a seaweedfs fuse mount to store its `/config` folder where it stores all its configs and internal SQLite3 DB. **Additional context** I have a full cluster running on top of Nomad using the `seaweedfs-csi-driver` and all applications are working just fine, except for Plex. A way to reproduce this is just by mounting a seaweedfs collection via `weed mount` and when running the docker container passing the `-v /local/path/of/the/mounted/volume:/config`. Plex will output DB crashes on its stderr logging output right after trying to startup.</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>add piknik</MESSAGE>
    <SHA>e134570a9ceac1084f01a6b223891262a6628ab9</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>truncate: don't drop chunk where truncate aligns with chunk length Fixes: https://github.com/seaweedfs/seaweedfs/issues/3384 Fixes: https://github.com/seaweedfs/seaweedfs/issues/2609 Before: Chunk `3,577c823253` is dropped when truncate sets file length to 4096: ``` I0806 19:42:26.236780 weedfs_file_sync.go:151 /file set chunks: 2 I0806 19:42:26.236790 weedfs_file_sync.go:153 /file chunks 0: 3,577c823253 [0,5120) I0806 19:42:26.236798 weedfs_file_sync.go:153 /file chunks 1: 6,58be291f0e [0,4096) I0806 19:42:26.237150 weedfs_attr.go:53 /file setattr set size=4096 filersize=5120 chunks=2 I0806 19:42:26.237171 weedfs_attr.go:66 truncated chunk 3,577c823253 from 5120 to 4096 I0806 19:42:26.237411 weedfs_file_sync.go:102 doFlush /file fh 0 I0806 19:42:26.237430 weedfs_file_sync.go:151 /file set chunks: 1 I0806 19:42:26.237439 weedfs_file_sync.go:153 /file chunks 0: 3,577c823253 [0,4096) ``` After, secondary chunk is retailed: ``` I0806 19:40:51.755588 weedfs_file_sync.go:151 /file set chunks: 2 I0806 19:40:51.755598 weedfs_file_sync.go:153 /file chunks 0: 6,54a83ba23d [0,5120) I0806 19:40:51.755605 weedfs_file_sync.go:153 /file chunks 1: 7,556020bbeb [0,4096) I0806 19:40:51.756049 weedfs_attr.go:53 /file setattr set size=4096 chunks=2 I0806 19:40:51.756066 weedfs_attr.go:65 truncated chunk 6,54a83ba23d from 5120 to 4096 I0806 19:40:51.756077 weedfs_attr.go:65 truncated chunk 7,556020bbeb from 4096 to 4096 I0806 19:40:51.756109 weedfs_file_sync.go:102 doFlush /file fh 0 I0806 19:40:51.756127 weedfs_file_sync.go:151 /file set chunks: 2 I0806 19:40:51.756137 weedfs_file_sync.go:153 /file chunks 0: 6,54a83ba23d [0,4096) I0806 19:40:51.756145 weedfs_file_sync.go:153 /file chunks 1: 7,556020bbeb [0,4096) ```</MESSAGE>
      <SHA>b638ee92a76d52eb2d4ecb7ab62dc262a37a11a2</SHA>
      <PATCHEDFILES>
        <FILE>weed/mount/weedfs_attr.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
