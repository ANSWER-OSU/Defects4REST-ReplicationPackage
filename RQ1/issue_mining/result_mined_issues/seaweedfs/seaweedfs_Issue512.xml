<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>512</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/512</ISSUEURL>
  <TITLE>多master模式不工作</TITLE>
  <DESCRIPTION>Hi Chris Lu: 发现多master模式下，停掉leader后，剩下的master没能选出leader，从而volume server连接master失败； 版本：0.76 环境：一台windows，ip为10.0.0.95，一台centos，IP为10.0.0.163 步骤： 1.windows上启动master weed master -mdir=master -ip=10.0.0.95 ip.bind=10.0.0.95 2.centos上启动另一个master weed master -mdir=master -peers=10.0.0.95:9333 -ip=10.0.0.163 ip.bind=10.0.0.163 3.window上启动一个volume server weed.exe volume -dir=data -port=&quot;8081&quot; -mserver=10.0.0.95:9333 -ip=10.0.0.95 ip.bind=10.0.0.95 启动成功后，上传一个文件1.jpg http://10.0.0.163:9333/submit 通过http://10.0.0.95:9333/和http://10.0.0.163:9333/均能正常访问文件 4. 停掉leader 95，仍然通过http://10.0.0.163:9333/submit上传文件，返回失败： { &quot;error&quot;: &quot;Raft Server not initialized!&quot; } # **95上master的log如下：** weed master -mdir=master -ip=10.0.0.95 ip.bind=10.0.0.95 I0615 17:27:50 5980 file_util.go:20] Folder master Permission: -rwxrwxrwx I0615 17:27:50 5980 master_server.go:62] Volume Size Limit is 30000 MB I0615 17:27:50 5980 master.go:87] Start Seaweed Master 0.76 at 0.0.0.0:9333 I0615 17:27:50 5980 raft_server.go:56] Peers Change: [10.0.0.163:9333 10.0.0.95:9333] =&gt; [] I0615 17:27:50 5980 raft_server.go:98] Initializing new cluster I0615 17:27:50 5980 master_server.go:95] [ 10.0.0.95:9333 ] I am the leader! I0615 17:27:55 5980 raft_server_handlers.go:16] Processing incoming join. Current Leader 10.0.0.95:9333 Self 10.0.0.95:9333 Peers map[] I0615 17:27:55 5980 raft_server_handlers.go:20] Command:{&quot;name&quot;:&quot;10.0.0.163:9333&quot;,&quot;connectionString&quot;:&quot;http://10.0.0.163:9333&quot;} I0615 17:27:55 5980 raft_server_handlers.go:27] join command from Name 10.0.0.163:9333 Connection http://10.0.0.163:9333 I0615 17:28:08 5980 node.go:223] topo adds child DefaultDataCenter I0615 17:28:08 5980 node.go:223] topo:DefaultDataCenter adds child DefaultRack I0615 17:28:08 5980 node.go:223] topo:DefaultDataCenter:DefaultRack adds child 10.0.0.95:8081 I0615 17:28:08 5980 master_grpc_server.go:36] added volume server 10.0.0.95:8081 # **95上的volume log如下：** weed.exe volume -dir=data -port=&quot;8081&quot; -mserver=10.0.0.95:9333 -ip=10.0.0.95 ip.bind=10.0.0.95 I0615 17:28:08 10076 file_util.go:20] Folder data Permission: -rwxrwxrwx I0615 17:28:08 10076 volume_loading.go:73] loading index data/6.idx to memory readonly false I0615 17:28:08 10076 volume_loading.go:73] loading index data/1.idx to memory readonly false I0615 17:28:08 10076 volume_loading.go:73] loading index data/5.idx to memory readonly false I0615 17:28:08 10076 volume_loading.go:73] loading index data/4.idx to memory readonly false I0615 17:28:08 10076 volume_loading.go:73] loading index data/2.idx to memory readonly false I0615 17:28:08 10076 disk_location.go:56] data file data/6.dat, replicaPlacement=000 v=2 size=8 ttl= I0615 17:28:08 10076 volume_loading.go:73] loading index data/7.idx to memory readonly false I0615 17:28:08 10076 disk_location.go:56] data file data/7.dat, replicaPlacement=000 v=2 size=8 ttl= I0615 17:28:08 10076 disk_location.go:56] data file data/2.dat, replicaPlacement=000 v=2 size=639800 ttl= I0615 17:28:08 10076 disk_location.go:56] data file data/1.dat, replicaPlacement=000 v=2 size=8 ttl= I0615 17:28:08 10076 disk_location.go:56] data file data/5.dat, replicaPlacement=000 v=2 size=8 ttl= I0615 17:28:08 10076 disk_location.go:56] data file data/4.dat, replicaPlacement=000 v=2 size=8 ttl= I0615 17:28:08 10076 volume_loading.go:73] loading index data/3.idx to memory readonly false I0615 17:28:08 10076 disk_location.go:56] data file data/3.dat, replicaPlacement=000 v=2 size=8 ttl= I0615 17:28:08 10076 disk_location.go:106] Store started on dir: data with 7 volumes max 7 I0615 17:28:08 10076 volume.go:143] Start Seaweed volume server 0.76 at 0.0.0.0:8081 I0615 17:28:08 10076 volume_grpc_client.go:17] Volume server bootstraps with master 10.0.0.95:9333 I0615 17:28:08 10076 volume_grpc_client.go:52] Heartbeat to 10.0.0.95:9333 2017/06/15 17:29:14 transport: http2Client.notifyError got notified that the client transport was broken read tcp 10.0.0.95:12367-&gt;10.0.0.95:9333: wsarecv: An existing connection was forcibly closed by the remote host.. I0615 17:29:14 10076 volume_grpc_client.go:95] Volume Server heart beat stops with rpc error: code = Internal desc = transport is closing I0615 17:29:14 10076 volume_grpc_client.go:25] heartbeat error: rpc error: code = Internal desc = transport is closing 2017/06/15 17:29:14 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = &quot;transport: Error while dialing dial tcp 10.0.0.95:9333: operation was canceled&quot;; Reconnecting to {10.0.0.95:9333 &lt;nil&gt;} 2017/06/15 17:29:14 grpc: addrConn.transportMonitor exits due to: grpc: the connection is closing I0615 17:29:19 10076 store.go:35] Resetting master nodes: nodes:[10.0.0.163:9333 10.0.0.95:9333 10.0.0.95:9333], leader: I0615 17:29:21 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:29:28 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:29:35 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:29:42 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:29:49 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:29:56 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:03 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:10 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:17 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:24 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:31 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:38 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:45 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:52 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! I0615 17:30:59 10076 volume_grpc_client.go:25] heartbeat error: No master found: No master node available! # **163上的master log如下** weed master -mdir=master -peers=10.0.0.95:9333 -ip=10.0.0.163 ip.bind=10.0.0.163 I0615 17:28:01 9904 file_util.go:20] Folder master Permission: -rwxrwxr-x I0615 17:28:01 9904 master_server.go:62] Volume Size Limit is 30000 MB I0615 17:28:01 9904 master.go:87] Start Seaweed Master 0.76 at 0.0.0.0:9333 I0615 17:28:01 9904 raft_server.go:56] Peers Change: [10.0.0.163:9333 10.0.0.95:9333] =&gt; [10.0.0.95:9333] I0615 17:28:01 9904 raft_server.go:78] Joining cluster: 10.0.0.95:9333 I0615 17:28:02 9904 raft_server.go:166] Attempting to connect to: http://10.0.0.95:9333/cluster/join I0615 17:28:02 9904 raft_server.go:211] Post returned status: 200</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>skip bytes cache</MESSAGE>
    <SHA>a5cc85e77c3d252810aa017b727f7bffd4814a72</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>301 is reported as 404 for http post fix https://github.com/chrislusf/seaweedfs/issues/512</MESSAGE>
      <SHA>1fb74dff6d3ee18a36cb2fe389c3668b18ead065</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/raft_server.go</FILE>
        <FILE>weed/server/raft_server_handlers.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
