<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5195</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/5195</ISSUEURL>
  <TITLE>[filer_sync] DATA RACE AddSyncJob</TITLE>
  <DESCRIPTION>**Describe the bug** steps: ``` make 2mount CGO_ENABLED=1 go build -race ./weed -v=4 filer.sync -a=127.0.0.1:8888 -b=127.0.0.1:7888 -a.debug -b.debug docker exec -it seaweedfs-mount1-1 sh -c &quot;for i in $(seq 1 100); do echo &quot;test$i&quot; &gt; /mnt/test_$i &amp; done&quot; ``` trace: ``` WARNING: DATA RACE Write at 0x00c00013e660 by goroutine 119: github.com/seaweedfs/seaweedfs/weed/command.doSubscribeFilerMetaChanges.genProcessFunction.func4() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:446 +0x718 github.com/seaweedfs/seaweedfs/weed/command.doSubscribeFilerMetaChanges.func1() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:270 +0x198 github.com/seaweedfs/seaweedfs/weed/command.(*MetadataProcessor).AddSyncJob.func1.1() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync_jobs.go:45 +0x50 github.com/seaweedfs/seaweedfs/weed/util.Retry() /Users/whitefox/GolandProjects/seaweedfs/weed/util/retry.go:16 +0xa0 github.com/seaweedfs/seaweedfs/weed/command.(*MetadataProcessor).AddSyncJob.func1() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync_jobs.go:44 +0x6c Previous read at 0x00c00013e660 by goroutine 71: github.com/seaweedfs/seaweedfs/weed/pb/filer_pb.IsUpdate() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/filer_pb/filer_pb_helper.go:161 +0x490 github.com/seaweedfs/seaweedfs/weed/command.extractPathsFromMetadata() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync_jobs.go:139 +0x57c github.com/seaweedfs/seaweedfs/weed/command.shouldWaitFor() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync_jobs.go:86 +0x4c github.com/seaweedfs/seaweedfs/weed/command.(*MetadataProcessor).conflictsWith() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync_jobs.go:75 +0x1f4 github.com/seaweedfs/seaweedfs/weed/command.(*MetadataProcessor).AddSyncJob() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync_jobs.go:38 +0x11c github.com/seaweedfs/seaweedfs/weed/command.doSubscribeFilerMetaChanges.func2() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:281 +0x34 github.com/seaweedfs/seaweedfs/weed/command.doSubscribeFilerMetaChanges.AddOffsetFunc.func5() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/filer_pb_tail.go:112 +0x5c github.com/seaweedfs/seaweedfs/weed/pb.FollowMetadata.makeSubscribeMetadataFunc.func1() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/filer_pb_tail.go:86 +0x4f0 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcFilerClient.func1() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/grpc_client_server.go:262 +0x94 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcClient() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/grpc_client_server.go:155 +0x2a0 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcFilerClient() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/grpc_client_server.go:260 +0x9c github.com/seaweedfs/seaweedfs/weed/pb.WithFilerClient() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/grpc_client_server.go:254 +0x8c github.com/seaweedfs/seaweedfs/weed/pb.FollowMetadata() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/filer_pb_tail.go:41 +0x3c github.com/seaweedfs/seaweedfs/weed/command.doSubscribeFilerMetaChanges() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:306 +0xa0c github.com/seaweedfs/seaweedfs/weed/command.runFilerSynchronize.func1() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:154 +0x5e8 Goroutine 119 (running) created at: github.com/seaweedfs/seaweedfs/weed/command.(*MetadataProcessor).AddSyncJob() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync_jobs.go:42 +0x314 github.com/seaweedfs/seaweedfs/weed/command.doSubscribeFilerMetaChanges.func2() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:281 +0x34 github.com/seaweedfs/seaweedfs/weed/command.doSubscribeFilerMetaChanges.AddOffsetFunc.func5() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/filer_pb_tail.go:112 +0x5c github.com/seaweedfs/seaweedfs/weed/pb.FollowMetadata.makeSubscribeMetadataFunc.func1() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/filer_pb_tail.go:86 +0x4f0 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcFilerClient.func1() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/grpc_client_server.go:262 +0x94 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcClient() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/grpc_client_server.go:155 +0x2a0 github.com/seaweedfs/seaweedfs/weed/pb.WithGrpcFilerClient() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/grpc_client_server.go:260 +0x9c github.com/seaweedfs/seaweedfs/weed/pb.WithFilerClient() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/grpc_client_server.go:254 +0x8c github.com/seaweedfs/seaweedfs/weed/pb.FollowMetadata() /Users/whitefox/GolandProjects/seaweedfs/weed/pb/filer_pb_tail.go:41 +0x3c github.com/seaweedfs/seaweedfs/weed/command.doSubscribeFilerMetaChanges() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:306 +0xa0c github.com/seaweedfs/seaweedfs/weed/command.runFilerSynchronize.func1() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:154 +0x5e8 Goroutine 71 (running) created at: github.com/seaweedfs/seaweedfs/weed/command.runFilerSynchronize() /Users/whitefox/GolandProjects/seaweedfs/weed/command/filer_sync.go:144 +0x54c main.main() /Users/whitefox/GolandProjects/seaweedfs/weed/weed.go:80 +0x73c ================== ``` **System Setup** ``` master branch ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>fix: compose 2mount with sync</MESSAGE>
    <SHA>ff25aed126e11bbc4d79f7f05388ec214ab46ce0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix: DATA RACE https://github.com/seaweedfs/seaweedfs/issues/5194 https://github.com/seaweedfs/seaweedfs/issues/5195</MESSAGE>
      <SHA>013f5992518c74beaf0b30989eef748a9b185133</SHA>
      <PATCHEDFILES>
        <FILE>docker/compose/local-sync-mount-compose.yml</FILE>
        <FILE>weed/command/filer_remote_gateway_buckets.go</FILE>
        <FILE>weed/command/filer_remote_sync_dir.go</FILE>
        <FILE>weed/command/filer_sync.go</FILE>
        <FILE>weed/command/filer_sync_jobs.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix filer sync set offset (#5197) * fix: compose 2mount with sync * fix: DATA RACE https://github.com/seaweedfs/seaweedfs/issues/5194 https://github.com/seaweedfs/seaweedfs/issues/5195</MESSAGE>
      <SHA>1169f943103684ded4d67edac686fd94e8e78ccc</SHA>
      <PATCHEDFILES>
        <FILE>docker/compose/local-sync-mount-compose.yml</FILE>
        <FILE>weed/command/filer_remote_gateway_buckets.go</FILE>
        <FILE>weed/command/filer_remote_sync_dir.go</FILE>
        <FILE>weed/command/filer_sync.go</FILE>
        <FILE>weed/command/filer_sync_jobs.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
