<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5456</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/5456</ISSUEURL>
  <TITLE>Master panic: runtime error: invalid memory address or nil pointer dereference</TITLE>
  <DESCRIPTION>**Describe the bug** Master crushed after running for 10 hours. I run seaweedfs in docker [using docker-compose like this](https://github.com/seaweedfs/seaweedfs/blob/master/docker/seaweedfs-compose.yml). Logs: _Master_: ```go I0330 07:59:37.912270 volume_growth.go:245 Created Volume 122218 on topo:DefaultDataCenter:DefaultRack:volume:8080 I0330 07:59:37.912410 volume_layout.go:406 Volume 122218 becomes writable I0330 07:59:37.912458 volume_growth.go:258 Registered Volume 122218 on topo:DefaultDataCenter:DefaultRack:volume:8080 I0330 07:59:37.920959 volume_growth.go:245 Created Volume 122219 on topo:DefaultDataCenter:DefaultRack:volume:8080 I0330 07:59:37.921033 volume_layout.go:406 Volume 122219 becomes writable I0330 07:59:37.921053 volume_growth.go:258 Registered Volume 122219 on topo:DefaultDataCenter:DefaultRack:volume:8080 I0330 07:59:37.933584 volume_growth.go:245 Created Volume 122220 on topo:DefaultDataCenter:DefaultRack:volume:8080 I0330 07:59:37.933643 volume_layout.go:406 Volume 122220 becomes writable I0330 07:59:37.933698 volume_growth.go:258 Registered Volume 122220 on topo:DefaultDataCenter:DefaultRack:volume:8080 I0330 07:59:37.965262 volume_growth.go:245 Created Volume 122221 on topo:DefaultDataCenter:DefaultRack:volume:8080 I0330 07:59:38.109072 data_node.go:80 Deleting volume id: 122218 I0330 07:59:38.125827 data_node.go:80 Deleting volume id: 122219 I0330 07:59:38.128064 data_node.go:80 Deleting volume id: 122220 I0330 07:59:38.129798 data_node.go:80 Deleting volume id: 122221 I0330 07:59:38.273993 topology.go:276 removing volume info: Id:122218, Size:0, ReplicaPlacement:000, Collection:bucket-name, Version:3, FileCount:0, DeleteCount:0, DeletedByteCount:0, ReadOnly:false from volume:8080 I0330 07:59:38.275046 volume_layout.go:225 volume 122218 does not have enough copies I0330 07:59:38.275073 volume_layout.go:230 volume 122218 remove from writable I0330 07:59:38.275082 volume_layout.go:393 Volume 122218 becomes unwritable I0330 07:59:38.275102 topology.go:276 removing volume info: Id:122219, Size:0, ReplicaPlacement:000, Collection:bucket-name, Version:3, FileCount:0, DeleteCount:0, DeletedByteCount:0, ReadOnly:false from volume:8080 I0330 07:59:38.275147 volume_layout.go:225 volume 122219 does not have enough copies I0330 07:59:38.275155 volume_layout.go:230 volume 122219 remove from writable I0330 07:59:38.275162 volume_layout.go:393 Volume 122219 becomes unwritable I0330 07:59:38.275173 topology.go:276 removing volume info: Id:122220, Size:0, ReplicaPlacement:000, Collection:bucket-name, Version:3, FileCount:0, DeleteCount:0, DeletedByteCount:0, ReadOnly:false from volume:8080 I0330 07:59:38.275191 volume_layout.go:225 volume 122220 does not have enough copies I0330 07:59:38.275199 volume_layout.go:230 volume 122220 remove from writable I0330 07:59:38.275205 volume_layout.go:393 Volume 122220 becomes unwritable I0330 07:59:38.275213 topology.go:276 removing volume info: Id:122221, Size:0, ReplicaPlacement:000, Collection:bucket-name, Version:3, FileCount:0, DeleteCount:0, DeletedByteCount:0, ReadOnly:false from volume:8080 I0330 07:59:38.275226 volume_layout.go:225 volume 122221 does not have enough copies I0330 07:59:38.275233 volume_layout.go:230 volume 122221 remove from writable I0330 07:59:38.275256 master_grpc_server.go:203 master see deleted volume 122218 from volume:8080 I0330 07:59:38.275270 master_grpc_server.go:203 master see deleted volume 122219 from volume:8080 I0330 07:59:38.275275 master_grpc_server.go:203 master see deleted volume 122220 from volume:8080 I0330 07:59:38.275280 master_grpc_server.go:203 master see deleted volume 122221 from volume:8080 I0330 07:59:38.275315 volume_layout.go:225 volume 122221 does not have enough copies panic: runtime error: invalid memory address or nil pointer dereference [signal SIGSEGV: bucker-name code=0x1 addr=0x0 pc=0x1938a9c] goroutine 63079999 [running]: github.com/seaweedfs/seaweedfs/weed/topology.(*VolumeLayout).isAllWritable(0x3f86300?, 0x1dd6d) /go/src/github.com/seaweedfs/seaweedfs/weed/topology/volume_layout.go:236 +0x3c github.com/seaweedfs/seaweedfs/weed/topology.(*VolumeLayout).ensureCorrectWritables(0xc003de6480, 0x1dd6d) /go/src/github.com/seaweedfs/seaweedfs/weed/topology/volume_layout.go:227 +0x1a5 github.com/seaweedfs/seaweedfs/weed/topology.(*VolumeLayout).EnsureCorrectWritables(0xc003de6480, 0xc0019b78f8) /go/src/github.com/seaweedfs/seaweedfs/weed/topology/volume_layout.go:215 +0x77 github.com/seaweedfs/seaweedfs/weed/topology.(*Topology).RegisterVolumeLayout(0xc000d1a3c0, {0x1dd6d, 0x0, 0xc007592000, 0x3feb658, {0x0, 0x0}, {0xc004906010, 0x9}, 0x3, ...}, ...) /go/src/github.com/seaweedfs/seaweedfs/weed/topology/topology.go:273 +0x94 github.com/seaweedfs/seaweedfs/weed/topology.(*VolumeGrowth).grow(0xc000d1a3c0?, {0x2bea520, 0xc00019b878}, 0xc000d1a3c0, 0x1dd6d, 0xc004ae4000, {0xc006aaa068, 0x1, 0x0?}) /go/src/github.com/seaweedfs/seaweedfs/weed/topology/volume_growth.go:257 +0x7ee github.com/seaweedfs/seaweedfs/weed/topology.(*VolumeGrowth).findAndGrow(0xc00082ada0, {0x2bea520, 0xc00019b878}, 0xc000d1a3c0, 0xc004ae4000) /go/src/github.com/seaweedfs/seaweedfs/weed/topology/volume_growth.go:115 +0xbf github.com/seaweedfs/seaweedfs/weed/topology.(*VolumeGrowth).GrowByCountAndType(0xc00082ada0, {0x2bea520, 0xc00019b878}, 0x7, 0xc004ae4000, 0xc000d1a3c0) /go/src/github.com/seaweedfs/seaweedfs/weed/topology/volume_growth.go:96 +0x1b9 github.com/seaweedfs/seaweedfs/weed/topology.(*VolumeGrowth).AutomaticGrowByType(0xc00082ada0?, 0xc004ae4000, {0x2bea520?, 0xc00019b878?}, 0xc000d1a3c0?, 0xc000141e90?) /go/src/github.com/seaweedfs/seaweedfs/weed/topology/volume_growth.go:85 +0x8b github.com/seaweedfs/seaweedfs/weed/server.(*MasterServer).ProcessGrowRequest.func1.2() /go/src/github.com/seaweedfs/seaweedfs/weed/server/master_grpc_server_volume.go:55 +0xe9 created by github.com/seaweedfs/seaweedfs/weed/server.(*MasterServer).ProcessGrowRequest.func1 in goroutine 108 /go/src/github.com/seaweedfs/seaweedfs/weed/server/master_grpc_server_volume.go:52 +0x1e5 ``` _Volume_: ```go I0330 07:59:37.911957 volume_grpc_client_to_master.go:179 volume server volume:8080 adds volume 122218 I0330 07:59:37.912847 store.go:166 In dir /data adds volume:122219 collection:bucket-name replicaPlacement:000 ttl: I0330 07:59:37.920284 volume_loading.go:142 loading memory index /data/bucket-name_122219.idx to memory I0330 07:59:37.920790 store.go:170 add volume 122219 I0330 07:59:37.920832 volume_grpc_client_to_master.go:179 volume server volume:8080 adds volume 122219 I0330 07:59:37.921325 store.go:166 In dir /data adds volume:122220 collection:bucket-name replicaPlacement:000 ttl: I0330 07:59:37.932998 volume_loading.go:142 loading memory index /data/bucket-name_122220.idx to memory I0330 07:59:37.933446 store.go:170 add volume 122220 I0330 07:59:37.933483 volume_grpc_client_to_master.go:179 volume server volume:8080 adds volume 122220 I0330 07:59:37.934153 store.go:166 In dir /data adds volume:122221 collection:bucket-name replicaPlacement:000 ttl: I0330 07:59:37.964371 volume_loading.go:142 loading memory index /data/bucket-name_122221.idx to memory I0330 07:59:37.965020 store.go:170 add volume 122221 I0330 07:59:37.965087 volume_grpc_client_to_master.go:179 volume server volume:8080 adds volume 122221 I0330 07:59:38.321696 volume_grpc_client_to_master.go:71 heartbeat to master:9333 error: rpc error: code = Unavailable desc = error reading from server: EOF I0330 07:59:43.324408 volume_grpc_client_to_master.go:106 SendHeartbeat to master:9333: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp: lookup master on 127.0.0.11:53: server misbehaving&quot; I0330 07:59:43.324527 volume_grpc_client_to_master.go:71 heartbeat to master:9333 error: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp: lookup master on 127.0.0.11:53: server misbehaving&quot; I0330 07:59:48.328150 volume_grpc_client_to_master.go:106 SendHeartbeat to master:9333: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp: lookup master on 127.0.0.11:53: server misbehaving&quot; I0330 07:59:48.328267 volume_grpc_client_to_master.go:71 heartbeat to master:9333 error: rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing: dial tcp: lookup master on 127.0.0.11:53: server misbehaving&quot; ``` _S3_: ```go I0328 19:12:05.348781 s3.go:206 wait to connect to filer filer:8888 grpc address filer:18888 I0328 19:12:06.350729 s3.go:206 wait to connect to filer filer:8888 grpc address filer:18888 I0328 19:12:07.355579 s3.go:202 S3 read filer buckets dir: /buckets I0328 19:12:07.355607 s3.go:209 connected to filer filer:8888 grpc address filer:18888 I0328 19:12:07.357890 s3api_circuit_breaker.go:35 s3 circuit breaker not configured I0328 19:12:07.365203 s3.go:354 Start Seaweed S3 API Server 8000GB 3.64 b74e8082b at http port 8333 E0330 07:59:38.323736 s3api_object_handlers.go:519 upload to filer error: rpc error: code = Unavailable desc = error reading from server: read tcp 172.27.0.4:33092-&gt;172.27.0.2:19333: read: connection reset by peer E0330 07:59:38.323743 s3api_object_handlers.go:519 upload to filer error: rpc error: code = Unavailable desc = error reading from server: read tcp 172.27.0.4:33092-&gt;172.27.0.2:19333: read: connection reset by peer ``` _filer.toml_: ```go [leveldb2] enabled = true dir = &quot;/data/filerldb2&quot; ``` _webdav is removed from docker-compose_ **System Setup** - Host OS: Ubuntu 22.04.1 LTS - Inside docker-compose, all images (master, volume, filer, s3) are chrislusf/seaweedfs:3.64_large_disk - `weed version`: version 8000GB 3.64 b74e8082b linux amd64 - Content of `filer.toml` - default, see above **Additional context** It works fine after restarting docker-compose</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>chore(deps): bump github.com/schollz/progressbar/v3 from 3.14.1 to 3.14.2 (#5453)</MESSAGE>
    <SHA>94008a84a492ed784dc90df48eada545d748f8a8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix panic https://github.com/seaweedfs/seaweedfs/issues/5456</MESSAGE>
      <SHA>4c1a78a32c5acab0e4092ddd7900eb4e76b8500d</SHA>
      <PATCHEDFILES>
        <FILE>weed/topology/volume_layout.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix panic at isAllWritable (#5457) fix panic https://github.com/seaweedfs/seaweedfs/issues/5456</MESSAGE>
      <SHA>d5d8b8e2aef278fc5ca61b0140841c3909c1a5e8</SHA>
      <PATCHEDFILES>
        <FILE>weed/topology/volume_layout.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
