<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1353</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/1353</ISSUEURL>
  <TITLE>Volume server hangs</TITLE>
  <DESCRIPTION>**Describe the bug** The volume server http interface is unresponsive. The process is not dead as it is still logging lines like this: ``` Jun 07 12:08:13 dn-379 weed[38923]: I0607 12:08:13 38923 disk.go:11] read disk size: dir:&quot;/mnt/data-small/data&quot; all:100000802516992 used:2829158424576 free:97171644092416 percent_free:97.17087 percent_used:2.8291357 Jun 07 12:08:34 dn-379 weed[38923]: I0607 12:08:34 38923 disk.go:11] read disk size: dir:&quot;/mnt/data-small/data&quot; all:100000802516992 used:2829158424576 free:97171644092416 percent_free:97.17087 percent_used:2.8291357 ``` **System Setup** Same setup as : https://github.com/chrislusf/seaweedfs/issues/1346 5x masters and 5x volume servers: ``` root 38923 31.5 0.8 11695928 578576 ? Ssl Jun05 770:25 /usr/local/bin/weed -logtostderr -v=1 volume -compactionMBps=50 -port=8080 -mserver=10.1.14.110:9333,10.1.14.111:9333,10.1.14.112:9333,10.1.14.113:9333,10.1.14.114:9333 -dir=/mnt/data-small/data -index leveldb -max 0 -ip 10.1.14.112 -rack dn-379 root 39048 0.4 0.0 5329596 19068 ? Ssl Jun05 11:41 /usr/local/bin/weed -logtostderr master -mdir=/mnt/data-small/meta -ip=10.1.14.112 -defaultReplication=010 -volumePreallocate -volumeSizeLimitMB 30000 -garbageThreshold 0.3 -pulseSeconds 5 -peers=10.1.14.110:9333,10.1.14.111:9333,10.1.14.112:9333,10.1.14.113:9333,10.1.14.114:9333 ``` **Expected behavior** Normal operation **Additional context** The only thing we changed was pulseSeconds from 10 to 5, but now I'm constantly restarting volume servers that hangs. Could it be that the volume server is waiting for replication to go through? I've seen some log lines related to replication failing. This is roughly 30 mins prior to all transfers stopping to the cluster: ``` Jun 05 21:01:14 dn-379 weed[38923]: I0605 21:01:14 38923 upload_content.go:214] failing to upload to http://10.1.14.110:8080/5172,0e86755ae4c78708?ts=1591383674&amp;ttl=&amp;type=replicate Post http://10.1.14.110:8080/5172,0e86755ae4c78708?ts=1591383674&amp;ttl=&amp;type=replicate: read tcp 10.1.14.112:38402-&gt;10.1.14.110:8080: read: connection reset by peer Jun 05 21:01:14 dn-379 weed[38923]: I0605 21:01:14 38923 store_replicate.go:87] failed to write to replicas for volume 5172: [10.1.14.110:8080]: Post http://10.1.14.110:8080/5172,0e86755ae4c78708?ts=1591383674&amp;ttl=&amp;type=replicate: read tcp 10.1.14.112:38402-&gt;10.1.14.110:8080: read: connection reset by peer Jun 05 21:01:14 dn-379 weed[38923]: I0605 21:01:14 38923 upload_content.go:214] failing to upload to http://10.1.14.110:8080/5172,0e867549195ab81e?ts=1591383674&amp;ttl=&amp;type=replicate Post http://10.1.14.110:8080/5172,0e867549195ab81e?ts=1591383674&amp;ttl=&amp;type=replicate: read tcp 10.1.14.112:38396-&gt;10.1.14.110:8080: read: connection reset by peer Jun 05 21:01:14 dn-379 weed[38923]: I0605 21:01:14 38923 store_replicate.go:87] failed to write to replicas for volume 5172: [10.1.14.110:8080]: Post http://10.1.14.110:8080/5172,0e867549195ab81e?ts=1591383674&amp;ttl=&amp;type=replicate: read tcp 10.1.14.112:38396-&gt;10.1.14.110:8080: read: connection reset by peer ```</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>1.80</MESSAGE>
    <SHA>b8e346cc86e4e2b23110bb3fd106567c2ea8686d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>volume server: add a fix for dead lock https://github.com/chrislusf/seaweedfs/issues/1353</MESSAGE>
      <SHA>bdbe5ddbe9cd46ec7a931407e0bc33a2f8d0c9b1</SHA>
      <PATCHEDFILES>
        <FILE>weed/storage/volume_read_write.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
