<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1808</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/1808</ISSUEURL>
  <TITLE>Jwt issue - wrong jwt</TITLE>
  <DESCRIPTION>**Describe the bug** Getting wrong jwt code from master. ``` C:\Users\lennie&gt;curl -i &quot;http://172.16.100.1:9351/dir/lookup?volumeId=1,18ee7f3466&amp;read=yes&quot; HTTP/1.1 200 OK Authorization: BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWQiOiIiLCJleHAiOjE2MTM1MTI0NDN9.AxGUN17e_RZ5g4tSZLFWfzqnIuYQqxDCMBPTxvnFpdk Content-Type: application/json Date: Tue, 16 Feb 2021 21:52:03 GMT Content-Length: 90 {&quot;volumeId&quot;:&quot;1&quot;,&quot;locations&quot;:[{&quot;url&quot;:&quot;172.16.100.1:9831&quot;,&quot;publicUrl&quot;:&quot;172.16.100.1:9831&quot;}]} ``` And then volume query. ``` C:\Users\lennie&gt;curl -i &quot;http://172.16.100.1:9831/1,18ee7f3466&quot; -H &quot;Authorization: BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWQiOiIiLCJleHAiOjE2MTM1MTI0NDN9.AxGUN17e_RZ5g4tSZLFWfzqnIuYQqxDCMBPTxvnFpdk&quot; HTTP/1.1 401 Unauthorized Content-Type: application/json Server: SeaweedFS Volume 30GB 2.26 Date: Tue, 16 Feb 2021 21:52:27 GMT Content-Length: 21 {&quot;error&quot;:&quot;wrong jwt&quot;} ``` I Have read issue https://github.com/chrislusf/seaweedfs/issues/1399 But i only have one server and the time is correct on the system. When i do some request to the master to get the jwt token i can se this. ``` curl -i &quot;http://172.16.100.1:9351/dir/lookup?volumeId=1,18ee7f3466&amp;read=yes&quot; ``` Jwt response. ``` Authorization: BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWQiOiIiLCJleHAiOjE2MTM1MTM2MTN9.VfbCVHEhBMHMxWZrTpzOTYSU8DqWtKGs5_vaopdLiwY Authorization: BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWQiOiIiLCJleHAiOjE2MTM1MTM2MTd9.9yPL3dNuW3J4p68KARMWIAp_XlqDYkAN-NHHnYUrY4Q Authorization: BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWQiOiIiLCJleHAiOjE2MTM1MTM2MjB9.crUaZYFBCEDu57dOKAE-rJPw5nS-fpJP11Oz6Bv0Pok Authorization: BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmaWQiOiIiLCJleHAiOjE2MTM1MTM2MjF9.mRJQ0WtXu5JNfPAKIGiJP0CGrodiM_i8tOws9H7PRdA ``` There should not be underscore or dash in the base64 encoded values? So the question is. Why do I get underscores? I am running: OS: Ubuntu 18.04.4 LTS And weed version : version 30GB 2.26 b9b5b932 linux amd64 The Master is starting whit this command. ``` weed master -mdir=&quot;/home/raid6/seaweed/mastershare&quot; -ip=&quot;172.16.100.1&quot; -ip.bind=&quot;172.16.100.1&quot; -port=9351 ``` Log ``` I0216 22:42:56 19422 file_util.go:23] Folder /home/raid6/seaweed/mastershare Permission: -rwxr-xr-x I0216 22:42:56 19422 master.go:168] current: 172.16.100.1:9351 peers: I0216 22:42:56 19422 master_server.go:107] Volume Size Limit is 30000 MB I0216 22:42:56 19422 master_server.go:192] adminScripts: I0216 22:42:56 19422 master.go:122] Start Seaweed Master 30GB 2.26 b9b5b932 at 172.16.100.1:9351 I0216 22:42:56 19422 raft_server.go:70] Starting RaftServer with 172.16.100.1:9351 I0216 22:42:56 19422 raft_server.go:129] current cluster leader: I0216 22:42:56 19422 master.go:146] Start Seaweed Master 30GB 2.26 b9b5b932 grpc server at 172.16.100.1:19351 I0216 22:42:57 19422 masterclient.go:78] No existing leader found! I0216 22:42:57 19422 raft_server.go:154] Initializing new cluster I0216 22:42:57 19422 master_server.go:141] leader change event: =&gt; 172.16.100.1:9351 I0216 22:42:57 19422 master_server.go:143] [ 172.16.100.1:9351 ] 172.16.100.1:9351 becomes leader. I0216 22:43:00 19422 master_grpc_server.go:252] + client filer@172.16.100.1:8888 I0216 22:43:01 19422 masterclient.go:126] redirected to leader 172.16.100.1:9351 I0216 22:43:01 19422 master_grpc_server.go:252] + client master@172.16.100.1:37496 I0216 22:43:04 19422 node.go:322] topo adds child soder I0216 22:43:04 19422 node.go:322] topo:soder adds child r1u1 I0216 22:43:04 19422 node.go:322] topo:soder:r1u1 adds child 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:71] added volume server 172.16.100.1:9831 I0216 22:43:04 19422 volume_layout.go:354] Volume 13 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 10 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 8 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 7 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 6 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 3 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 1 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 11 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 2 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 12 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 5 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 4 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 9 becomes writable I0216 22:43:04 19422 volume_layout.go:354] Volume 14 becomes writable I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 13 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 10 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 8 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 7 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 6 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 3 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 1 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 11 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 2 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 12 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 5 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 4 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 9 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:112] master see new volume 14 from 172.16.100.1:9831 I0216 22:43:04 19422 master_grpc_server.go:157] master send to filer@172.16.100.1:8888: url:&quot;172.16.100.1:9831&quot; public_url:&quot;172.16.100.1:9831&quot; new_vids:13 new_vids:10 new_vids:8 new_vids:7 new_vids:6 new_vids:3 new_vids:1 new_vids:11 new_vids:2 new_vids:12 new_vids:5 new_vids:4 new_vids:9 new_vids:14 data_center:&quot;soder&quot; I0216 22:43:04 19422 master_grpc_server.go:157] master send to master@172.16.100.1:37496: url:&quot;172.16.100.1:9831&quot; public_url:&quot;172.16.100.1:9831&quot; new_vids:13 new_vids:10 new_vids:8 new_vids:7 new_vids:6 new_vids:3 new_vids:1 new_vids:11 new_vids:2 new_vids:12 new_vids:5 new_vids:4 new_vids:9 new_vids:14 data_center:&quot;soder&quot; ``` The volume is starting whit this command. ``` root@spinky:/home/raid6/seaweed# weed volume -max=100 -ip=&quot;172.16.100.1&quot; -ip.bind=&quot;172.16.100.1&quot; -port=9831 -mserver=&quot;172.16.100.1:9351&quot; -dir=&quot;/home/raid6/seaweed/voltesting&quot; -dataCenter=&quot;soder&quot; -rack=&quot;r1u1&quot; ``` Log ``` I0216 22:25:09 9983 file_util.go:23] Folder /home/raid6/seaweed/voltesting Permission: -rwxr-xr-x I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/2.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/filestorage_12.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/5.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/3.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/1.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/7.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/6.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/4.idx to memory I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/2.dat, replicaPlacement=000 v=3 size=8 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/3.dat, replicaPlacement=000 v=3 size=8 ttl= I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/filestorage_10.idx to memory I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/7.dat, replicaPlacement=000 v=3 size=8 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/filestorage_12.dat, replicaPlacement=000 v=3 size=1864 ttl= I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/filestorage_13.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/filestorage_11.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/filestorage_8.idx to memory I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/filestorage_14.idx to memory I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/4.dat, replicaPlacement=000 v=3 size=8 ttl= I0216 22:25:09 9983 volume_loading.go:127] loading index /home/raid6/seaweed/voltesting/filestorage_9.idx to memory I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/1.dat, replicaPlacement=000 v=3 size=112 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/5.dat, replicaPlacement=000 v=3 size=104 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/6.dat, replicaPlacement=000 v=3 size=8 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/filestorage_10.dat, replicaPlacement=000 v=3 size=7900832 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/filestorage_13.dat, replicaPlacement=000 v=3 size=720 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/filestorage_9.dat, replicaPlacement=000 v=3 size=8 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/filestorage_11.dat, replicaPlacement=000 v=3 size=664 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/filestorage_8.dat, replicaPlacement=000 v=3 size=1600 ttl= I0216 22:25:09 9983 disk_location.go:133] data file /home/raid6/seaweed/voltesting/filestorage_14.dat, replicaPlacement=000 v=3 size=30789912 ttl= I0216 22:25:09 9983 disk_location.go:175] Store started on dir: /home/raid6/seaweed/voltesting with 14 volumes max 100 I0216 22:25:09 9983 disk_location.go:178] Store started on dir: /home/raid6/seaweed/voltesting with 0 ec shards I0216 22:25:09 9983 volume_grpc_client_to_master.go:52] Volume server start with seed master nodes: [172.16.100.1:9351] I0216 22:25:09 9983 volume.go:351] Start Seaweed volume server 30GB 2.26 b9b5b932 at 172.16.100.1:9831 I0216 22:25:09 9983 volume_grpc_client_to_master.go:114] Heartbeat to: 172.16.100.1:9351 ``` This is the Log in volume when wrong jwt ``` I0216 22:27:26 9983 common.go:53] response method:GET URL:/1,18ee7f3466 with httpStatus:401 and JSON:{&quot;error&quot;:&quot;wrong jwt&quot;} I0216 22:27:27 9983 common.go:53] response method:GET URL:/1,18ee7f3466 with httpStatus:401 and JSON:{&quot;error&quot;:&quot;wrong jwt&quot;} I0216 22:28:32 9983 common.go:53] response method:GET URL:/1,18ee7f3466 with httpStatus:401 and JSON:{&quot;error&quot;:&quot;wrong jwt&quot;} I0216 22:28:34 9983 common.go:53] response method:GET URL:/1,18ee7f3466 with httpStatus:401 and JSON:{&quot;error&quot;:&quot;wrong jwt&quot;} ``` Security.toml file syntax: ``` # Put this file to one of the location, with descending priority # ./security.toml # $HOME/.seaweedfs/security.toml # /etc/seaweedfs/security.toml # this file is read by master, volume server, and filer # the jwt signing key is read by master and volume server. # a jwt defaults to expire after 10 seconds. [jwt.signing] key = &quot;NotShownToThePublic&quot; expires_after_seconds = 120 # seconds 10 default # jwt for read is only supported with master+volume setup. Filer does not support this mode. [jwt.signing.read] key = &quot;NotShownToThePublic&quot; expires_after_seconds = 120 # seconds # volume server also uses grpc that should be secured. # all grpc tls authentications are mutual # the values for the following ca, cert, and key are paths to the PERM files. # the host name is not checked, so the PERM files can be shared. [grpc] ca = &quot;/home/certstrap/certstrap/out/smtCertAuth.crt&quot; [grpc.volume] cert = &quot;/home/certstrap/certstrap/out/volume01.crt&quot; key = &quot;/home/certstrap/certstrap/out/volume01.key&quot; [grpc.master] cert = &quot;/home/certstrap/certstrap/out/master01.crt&quot; key = &quot;/home/certstrap/certstrap/out/master01.key&quot; [grpc.filer] cert = &quot;/home/certstrap/certstrap/out/filer01.crt&quot; key = &quot;/home/certstrap/certstrap/out/filer01.key&quot; # use this for any place needs a grpc client # i.e., &quot;weed backup|benchmark|filer.copy|filer.replicate|mount|s3|upload&quot; [grpc.client] cert = &quot;/home/certstrap/certstrap/out/client01.crt&quot; key = &quot;/home/certstrap/certstrap/out/client01.key&quot; ``` If I turn of the security (jwt). The server is working perfect. I can save, show, delete object</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update .travis.yml</MESSAGE>
    <SHA>790252a9796ca3f973ddf5b7e7f3ccea832faf8f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>skip JWT if fileId is empty related to https://github.com/chrislusf/seaweedfs/issues/1808</MESSAGE>
      <SHA>cd866664a85d8ea8969c7982262ac26a69825c39</SHA>
      <PATCHEDFILES>
        <FILE>weed/server/master_server_handlers.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
