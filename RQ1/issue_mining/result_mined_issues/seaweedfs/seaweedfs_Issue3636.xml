<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>3636</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/3636</ISSUEURL>
  <TITLE>S3 connection to Cloudflare R2 generates error when attempting to sync from SeaweedFS to R2</TITLE>
  <DESCRIPTION>Sponsors SeaweedFS via Patreon https://www.patreon.com/seaweedfs Report issues here. Ask questions here https://stackoverflow.com/questions/tagged/seaweedfs Please ask questions in https://github.com/seaweedfs/seaweedfs/discussions example of a good issue report: https://github.com/seaweedfs/seaweedfs/issues/1005 example of a bad issue report: https://github.com/seaweedfs/seaweedfs/issues/1008 **Describe the bug** S3 connection to Cloudflare R2 generates error when attempting to sync from SeaweedFS to R2 because of &quot;Header 'x-amz-storage-class' with value '' not implemented&quot; R2 api does not support x-amz-storage-class as per https://developers.cloudflare.com/r2/platform/s3-compatibility/api/ **System Setup** - Command to start is 'weed server -dir=/seaweed -s3 -volume.max=50' - OS version: Debian 11 x64 - output of `weed version` version 30GB 3.26 c07ab9c060eafe26cc0b4246d507d5b33f32f317 linux amd64 - if using filer, show the content of `filer.toml` Just the blank filer.toml, I have not customized this for the limited test. **Expected behavior** The ability to use the s3 api for r2 or to create a new option like we have for b2 for remote config for cloud storage. **Screenshots** If applicable, add screenshots to help explain your problem. **Additional context** Example of error output from issuing filer sync E0909 19:55:09.629338 filer_sync_jobs.go:47 process directory:&quot;/buckets/cloudflare1/.uploads/9893f4f49e373ee7f2dc110590bb758de0cc84bb&quot; event_notification:{new_entry:{name:&quot;0038.part&quot; chunks:{file_id:&quot;9,249792ab3c60&quot; size:4194304 mtime:1662778272520053410 e_tag:&quot;HRVX+lxnmBczayn2mTB1GA==&quot; fid:{volume_id:9 file_key:9367 cookie:2460695648}} chunks:{file_id:&quot;9,24a9e4b6e2fb&quot; offset:4194304 size:4194304 mtime:1662778273015395623 e_tag:&quot;g+nJ6OX2HoX14OtlGcL88w==&quot; fid:{volume_id:9 file_key:9385 cookie:3837190907}} chunks:{file_id:&quot;9,24ab42fa6467&quot; offset:8388608 size:2097152 mtime:1662778273440090068 e_tag:&quot;77DHnTJcz1Nctg2rfOPGYA==&quot; fid:{volume_id:9 file_key:9387 cookie:1123705959}} attributes:{file_size:10485760 mtime:1662778273 file_mode:432 crtime:1662778273 md5:&quot;\x97\xd0J\xdag\t9ÇŠw\xbe\xb4_H\xc5\xea&quot;}} delete_chunks:true new_parent_path:&quot;/buckets/cloudflare1/.uploads/9893f4f49e373ee7f2dc110590bb758de0cc84bb&quot; signatures:-1336353119} ts_ns:1662778273440178234: upload to cloudflare1/testbucket/.uploads/9893f4f49e373ee7f2dc110590bb758de0cc84bb/0038.part: NotImplemented: Header 'x-amz-storage-class' with value '' not implemented</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>volume.balance: default to balance ALL_COLLECTIONS</MESSAGE>
    <SHA>fc4208d128ee042e50edc3dca607173d81d10cbd</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>avoid sync s3 multipart objects https://github.com/seaweedfs/seaweedfs/issues/3636</MESSAGE>
      <SHA>9de9b37dfef5cf67972e444fcbd05537b7d3dd07</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer_sync_jobs.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>skip directories under &quot;.uploads&quot; directory related to https://github.com/seaweedfs/seaweedfs/issues/3636 skipping all directories under &quot;.uploads&quot; directory.</MESSAGE>
      <SHA>205ecb5d0311ec4b37ecae7c43617f931191f59a</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer_remote_sync_dir.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>override amz storage class, None to delete https://github.com/seaweedfs/seaweedfs/issues/3636</MESSAGE>
      <SHA>725ead6f3ec690778c1b021f26eb23f6b2566ce0</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer_remote_sync.go</FILE>
        <FILE>weed/command/filer_remote_sync_dir.go</FILE>
        <FILE>weed/command/filer_sync_jobs.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[sync] override amz storage class, None to delete (#3639) * override amz storage class, None to delete https://github.com/seaweedfs/seaweedfs/issues/3636 * use empty string to delete * without nil check</MESSAGE>
      <SHA>b64674018a618ea6a46137fd50fd687e8f72957f</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer_remote_sync.go</FILE>
        <FILE>weed/command/filer_remote_sync_dir.go</FILE>
        <FILE>weed/command/filer_sync_jobs.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>fix delete key panic of remote sync dir https://github.com/seaweedfs/seaweedfs/issues/3636#issuecomment-1264239200</MESSAGE>
      <SHA>ee2a90a4dc63aa9b524c325949db689e3874ede3</SHA>
      <PATCHEDFILES>
        <FILE>weed/command/filer_remote_sync_dir.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
