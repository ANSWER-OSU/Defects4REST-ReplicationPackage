<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>1726</ISSUENO>
  <ISSUEURL>https://github.com/seaweedfs/seaweedfs/issues/1726</ISSUEURL>
  <TITLE>memory related bugs of rocksdb implementation</TITLE>
  <DESCRIPTION>Sponsors SeaweedFS via Patreon https://www.patreon.com/seaweedfs Hi Chris, I maintained my own rocksdb branch previously, happy to find out it's now offically supported. Here's some small suggestions for the current implementation. 1. Option objects created from `NewDefaultOptions` `NewDefaultReadOptions` `NewDefaultWriteOptions` contain cgo pointers need to be released explicitly. 2. rocksdb_store.go#L96 `entry.FullPath` leads to nil pointer dereference. 3. Rocksdb iterator related keys &amp; values will be freed automatically upon iterator's destruction, so `iter.Close()` ensures no memory leak without `key.Free()` or `value.Free()`. Other possible improvements: 1. Reuse default options when possible. 2. Use `db.Get`(and free by hand) instead of `db.GetBytes` to avoid memory copy when bytes are read only. Gorocksdb `charToByte` use reflect tricks by creating byte slice with underlying C char array to avoid char* to go []byte copy, while `C.GoBytes` performs memory copy.</DESCRIPTION>
  <REPONAME>seaweedfs</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>2.19</MESSAGE>
    <SHA>2ce86f308ea4836cf534e50dc1388932253b5cd5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix #1726</MESSAGE>
      <SHA>40b3207f18d7b1a5f04c0333c970a42527d16df0</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/rocksdb/rocksdb_store.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #1727 from qieqieplus/rocksdb fix #1726</MESSAGE>
      <SHA>9fa2d20357fb319d88ed99af50bfc927ecf0656b</SHA>
      <PATCHEDFILES>
        <FILE>weed/filer/rocksdb/rocksdb_store.go</FILE>
        <FILE>weed/filer/rocksdb/rocksdb_store_kv.go</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
