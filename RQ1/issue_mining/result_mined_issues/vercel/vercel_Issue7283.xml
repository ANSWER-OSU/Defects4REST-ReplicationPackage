<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>7283</ISSUENO>
  <ISSUEURL>https://github.com/vercel/vercel/issues/7283</ISSUEURL>
  <TITLE>[CLI] When &quot;vercel dev&quot; proxies a request to a framework, its queries are not original ones and will result in errors for Vite.</TITLE>
  <DESCRIPTION>When Vite plugins processing a Vue Single File Component(SFC) file, it will transform its style tag into a js file with a url like `/foo/bar/AComponent.vue?vue&amp;type=style&amp;index=0&amp;lang.css`. Then it was used as a js module in the page. However when Vercel CLI dev server proxying it to frontend dev server, the cli doesn't use original url but generates a new one. Generated one is like: `/foo/bar/AComponent.vue?vue=&amp;type=style&amp;index=0&amp;lang.css=`, which is not a valid css url that can be recognized by Vite. Its content is not processed by css plugins of Vite, but it's still used as a js module. Because of that, when running &quot;vercel dev&quot;, if you write some css rules in the style tag of a Vue SFC file, the page will become blank and throw errors in browser console. It's very inconvenient for Vue developers if we can't use style tag in SFC. Cause is at: https://github.com/vercel/vercel/blob/bae26cc0178ff49c3050ceaf5db00969e510cc6b/packages/cli/src/util/dev/server.ts#L1703-L1707 Here it deletes original querystring (`origUrl.search`), and generates a new one together with pathname (`url.format(origUrl)`), which is the one with additional &quot;=&quot;. (`url.format()` internally uses `querystring.stringify()` that will add &quot;=&quot; for empty fields in the object). In my local repo, I deleted L1704 &amp; L1706 then it worked as expected. `url.format()` now uses original search string, so additional &quot;=&quot;s are gone. But I don't know if it will impact other frameworks.</DESCRIPTION>
  <REPONAME>vercel</REPONAME>
  <TIMEDIFFERENCEDAYS>214</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[cli] Fix &quot;now-dev-next&quot; and &quot;now-dev-static-build-routing&quot; unit tests (#7824) These two tests have been problematic on MacOS for a long time, but now that we've re-introduced `@vercel/next` into this repo, they've started to fail on Linux/Windows as well. So the idea is to use the `devCommand` property so that `@vercel/next` Builder doesn't get invoked at all. Since the `devCommand` property was not yet being unit tested, some logic in `vc build` needed to be adjusted in order to properly shut down the dev command (via `tree-kill` module) when the process was being stopped in order to cleanly shut down.</MESSAGE>
    <SHA>e3c4435606bf0e3708b2cd7eeb4cb2be0b84009a</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix Vite request proxying Resolves #7283</MESSAGE>
      <SHA>be32c57ea5e84747a1b408489232c4ad58483c7d</SHA>
      <PATCHEDFILES>
        <FILE>packages/cli/src/util/dev/server.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[cli] Fix dev query string merging (#8183) Since `vercel dev` performs query string merging with `vercel.json` routes and the requested url, there is sometimes a slight difference between the request that the browser sends and the request that the upstream dev server receives. Most servers treat the query string key with &quot;empty&quot; value the same as undefined value. Meaning, these two URLs should be equivalent because each has empty values: - `http://example.com/src/App.vue?vue&amp;type=style&amp;index=0&amp;lang.css` - `http://example.com/src/App.vue?vue=&amp;type=style&amp;index=0&amp;lang.css=` However, `vite dev` handles these two URLs differently because of [string comparisons](https://github.com/vitejs/vite/blob/2289d04af5398791c3a01c9e597dc976e593c852/packages/plugin-vue/src/handleHotUpdate.ts#L98-L99) instead of URL parsing, which causes requests from `vercel dev` to fail. Thus, this PR changes from Node.js native URL parsing to a custom implementation in order to handle this corner case and preserve the difference between `?a=` and `?a`. Ideally this would be [fixed in vite](https://github.com/vitejs/vite/pull/9589), however we might run into other dev servers that also fail in the same way in the future. - Fixes https://github.com/vercel/vercel/issues/7283 - Closes https://github.com/vitejs/vite/pull/9589 - Related to https://github.com/nodejs/node/issues/9500</MESSAGE>
      <SHA>6e1ee7a7d606874e32630bd41793e591e9a84686</SHA>
      <PATCHEDFILES>
        <FILE>packages/cli/src/util/dev/parse-query-string.ts</FILE>
        <FILE>packages/cli/src/util/dev/router.ts</FILE>
        <FILE>packages/cli/src/util/dev/server.ts</FILE>
        <FILE>packages/cli/src/util/dev/types.ts</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/.gitignore</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/index.html</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/package.json</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/public/favicon.ico</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/src/App.vue</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/src/assets/logo.png</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/src/components/HelloWorld.vue</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/src/main.js</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/vite.config.js</FILE>
        <FILE>packages/cli/test/dev/fixtures/vite-dev/yarn.lock</FILE>
        <FILE>packages/cli/test/dev/integration-1.test.ts</FILE>
        <FILE>packages/cli/test/unit/util/dev/parse-query-string.test.ts</FILE>
        <FILE>packages/cli/test/unit/util/dev/router.test.ts</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
