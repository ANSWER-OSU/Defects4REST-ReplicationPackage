<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8545</ISSUENO>
  <ISSUEURL>https://github.com/OrchardCMS/OrchardCore/issues/8545</ISSUEURL>
  <TITLE>PostgreSQL database issue with latest</TITLE>
  <DESCRIPTION>### Describe the bug Error occurs on Postgresql when enabling our Hackathon feature. Works fine with SQLite but with postgresql, the site completely crashes. ### To Reproduce Create a tenant with a long enough name to go over the 64 character limit for table names on postgresql ### Expected behavior Migrations to execute without crashing the site. ### Screenshots ```bash fail: OrchardCore.Data.Migration.DataMigrationManager[0] =&gt; SpanId:332116e92b5d7a4f, TraceId:d4cacbf54ed6af418a87fa58e897948c, ParentId:0000000000000000 =&gt; ConnectionId:0HM6C8V30N54S =&gt; RequestPath:/tj5ogvh/Admin/Features RequestId:0HM6C8V30N54S:00000016 Error while running migration version 0 for 'OrchardCore.Workflows'. System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---&gt; Npgsql.PostgresException (0x80004005): 42P07: relation &quot;tj5ogvh_IDX_WorkflowBlockingActivitiesIndex_DocumentId_Activity&quot; already exists at Npgsql.NpgsqlConnector.&lt;ReadMessage&gt;g__ReadMessageLong|194_0(NpgsqlConnector connector, Boolean async, DataRowLoadingMode dataRowLoadingMode, Boolean readingNotifications, Boolean isReadingPrependedMessage) at Npgsql.NpgsqlDataReader.NextResult(Boolean async, Boolean isConsuming, CancellationToken cancellationToken) at Npgsql.NpgsqlDataReader.NextResult() at Npgsql.NpgsqlCommand.ExecuteReader(CommandBehavior behavior, Boolean async, CancellationToken cancellationToken) at Npgsql.NpgsqlCommand.ExecuteReader(CommandBehavior behavior, Boolean async, CancellationToken cancellationToken) at Npgsql.NpgsqlCommand.ExecuteNonQuery(Boolean async, CancellationToken cancellationToken) at Npgsql.NpgsqlCommand.ExecuteNonQuery() at Dapper.SqlMapper.ExecuteCommand(IDbConnection cnn, CommandDefinition&amp; command, Action`2 paramReader) in /_/Dapper/SqlMapper.cs:line 2813 at Dapper.SqlMapper.ExecuteImpl(IDbConnection cnn, CommandDefinition&amp; command) in /_/Dapper/SqlMapper.cs:line 572 at YesSql.Sql.SchemaBuilder.Execute(IEnumerable`1 statements) at YesSql.Sql.SchemaBuilder.AlterTable(String name, Action`1 table) at YesSql.Sql.SchemaBuilder.AlterIndexTable(Type indexType, Action`1 table, String collection) at YesSql.Sql.SchemaBuilderExtensions.AlterIndexTable[T](ISchemaBuilder builder, Action`1 table, String collection) at OrchardCore.Workflows.Migrations.Create() Exception data: Severity: ERROR SqlState: 42P07 MessageText: relation &quot;tj5ogvh_IDX_WorkflowBlockingActivitiesIndex_DocumentId_Activity&quot; already exists File: index.c Line: 884 Routine: index_create --- End of inner exception stack trace --- at System.RuntimeMethodHandle.InvokeMethod(Object target, Object[] arguments, Signature sig, Boolean constructor, Boolean wrapExceptions) at OrchardCore.Data.Migration.DataMigrationManager.UpdateAsync(String featureId) fail: OrchardCore.Data.Migration.DataMigrationManager[0] =&gt; SpanId:332116e92b5d7a4f, TraceId:d4cacbf54ed6af418a87fa58e897948c, ParentId:0000000000000000 =&gt; ConnectionId:0HM6C8V30N54S =&gt; RequestPath:/tj5ogvh/Admin/Features RequestId:0HM6C8V30N54S:00000016 Error while running migration version 0 for 'StatCan.OrchardCore.Hackathon'. System.ObjectDisposedException: The CancellationTokenSource has been disposed. at System.Threading.CancellationTokenSource.ThrowObjectDisposedException() at System.Threading.CancellationTokenSource.CancelAfter(Int32 millisecondsDelay) at System.Threading.CancellationTokenSource.CancelAfter(TimeSpan delay) at Npgsql.Util.ResettableCancellationTokenSource.Stop() at Npgsql.NpgsqlReadBuffer.&lt;Ensure&gt;g__EnsureLong|40_0(NpgsqlReadBuffer buffer, Int32 count, Boolean async, Boolean readingNotifications) at Npgsql.NpgsqlConnector.&lt;ReadMessage&gt;g__ReadMessageLong|194_0(NpgsqlConnector connector, Boolean async, DataRowLoadingMode dataRowLoadingMode, Boolean readingNotifications, Boolean isReadingPrependedMessage) at Npgsql.NpgsqlDataReader.NextResult(Boolean async, Boolean isConsuming, CancellationToken cancellationToken) at Npgsql.NpgsqlDataReader.Consume(Boolean async) at Npgsql.NpgsqlDataReader.Close(Boolean connectionClosing, Boolean async, Boolean isDisposing) at Npgsql.NpgsqlConnector.CloseOngoingOperations(Boolean async, CancellationToken cancellationToken) at Npgsql.NpgsqlTransaction.Dispose(Boolean disposing) at YesSql.Session.ReleaseTransaction() at YesSql.Session.Cancel() at YesSql.Services.DefaultQuery.Query`1.FirstOrDefaultImpl() at OrchardCore.Data.Documents.DocumentStore.GetOrCreateMutableAsync[T](Func`1 factoryAsync) at OrchardCore.Documents.DocumentManager`1.GetOrCreateMutableAsync(Func`1 factoryAsync) at OrchardCore.Queries.Services.QueryManager.SaveQueryAsync(String name, Query query) at OrchardCore.Queries.Recipes.QueryStep.ExecuteAsync(RecipeExecutionContext context) at OrchardCore.Recipes.Services.RecipeExecutor.&lt;&gt;c__DisplayClass7_0.&lt;&lt;ExecuteStepAsync&gt;b__0&gt;d.MoveNext() --- End of stack trace from previous location --- at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute, Boolean activateShell) at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteStepAsync(RecipeExecutionContext recipeStep) at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) at OrchardCore.Recipes.Services.RecipeMigrator.ExecuteAsync(String recipeFileName, IDataMigration migration) at StatCan.OrchardCore.Hackathon.HackathonMigrations.CreateAsync() in C:\repos\statcan\StatCan.OrchardCore\src\Modules\StatCan.OrchardCore.Hackathon\HackathonMigrations.cs:line 31 at OrchardCore.Data.Migration.DataMigrationManager.UpdateAsync(String featureId) Unhandled exception. Npgsql.NpgsqlException (0x80004005): Received backend message ReadyForQuery while expecting CommandCompleteMessage. Please file a bug. at Npgsql.NpgsqlConnector.ExecuteInternalCommand(Byte[] data, Boolean async, CancellationToken cancellationToken) at Npgsql.NpgsqlConnector.Rollback(Boolean async, CancellationToken cancellationToken) at Npgsql.NpgsqlTransaction.Rollback() at Npgsql.NpgsqlTransaction.Dispose(Boolean disposing) at YesSql.Session.ReleaseTransaction() at YesSql.Session.Cancel() at YesSql.Session.FlushAsync() at YesSql.Services.DefaultQuery.Query`1.ListImpl() at StatCan.OrchardCore.Hackathon.Indexes.IndexMigrations.CreateHackathonUsersIndex() in C:\repos\statcan\StatCan.OrchardCore\src\Modules\StatCan.OrchardCore.Hackathon\Indexes\Migrations.cs:line 80 at System.Threading.Tasks.Task.&lt;&gt;c.&lt;ThrowAsync&gt;b__140_1(Object state) at System.Threading.QueueUserWorkItemCallback.&lt;&gt;c.&lt;.cctor&gt;b__6_0(QueueUserWorkItemCallback quwi) at System.Threading.ExecutionContext.RunForThreadPoolUnsafe[TState](ExecutionContext executionContext, Action`1 callback, TState&amp; state) at System.Threading.QueueUserWorkItemCallback.Execute() at System.Threading.ThreadPoolWorkQueue.Dispatch() ``` I will add to this issue when I find more information. Just investigating right now.</DESCRIPTION>
  <REPONAME>OrchardCore</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix WorkflowBlockingActivitiesIndex table indices name length for PostgreSQL.</MESSAGE>
    <SHA>f2f05dc5074be9d4eca0c210acfef4a3600a939e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge branch 'dev' into skrypt/#8545</MESSAGE>
      <SHA>1b83cdd705344b803a5708261d7df3964fd8f848</SHA>
      <PATCHEDFILES>
        <FILE>.github/workflows/functional_all_db.yml</FILE>
        <FILE>.github/workflows/pr_ci.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
