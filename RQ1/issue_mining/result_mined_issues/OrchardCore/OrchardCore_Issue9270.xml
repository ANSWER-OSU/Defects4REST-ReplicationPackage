<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>9270</ISSUENO>
  <ISSUEURL>https://github.com/OrchardCMS/OrchardCore/issues/9270</ISSUEURL>
  <TITLE>Prevent DI Deadlock</TITLE>
  <DESCRIPTION>So the pattern that may fail is - When injecting a service from a **constructor** that injects an `IOptions&lt;T&gt;` accessor and gets its `Value` in its constructor, so the `Configure()` of a related `IConfigureOptions&lt;&gt;` is executed, and when this `Configure()` calls an async method e.g. `GetSettingsAsync().GetAwaiter().GetResult()`. And if this `GetSettingsAsync()` does an async call, not `DoAsync().GetAwaiter().GetResult()`, but `await DoAsync()` making IO operations, **this before resolving lazily a service, in that case the DI fall down in a dead lock**. - This is not directly due to the `DocumentManager` that we made a singleton, but then our code was using the above failing pattern. We fixed it by caching the service that we lazily resolve, it works because there was no real async call before the first resolution, but as i saw (will try it) if we use the `DocumentManager` with a distributed cache, a first async call may be still done before this only one resolution, and then it will still fail. - One solution i planned to do is to add to the `IDocumentManager` a non async version at least for getting an immutable document, so that in that case we would not do any async operation before resolving lazily a service, and in a `IConfigureOptions` we could e.g. call `GetSettings()` in place of `GetSettingsAsync().GetAwaiter().GetResult()`. Notice that, when using the failing pattern, even if we prevent a DI dead lock with the `DocumentManager`, this doesn't prevent a dead lock with another service, here a simple repro of the failing pattern using fake services / options. Related issue in the aspnetcore repo https://github.com/dotnet/aspnetcore/issues/19315#issuecomment-594349496 public class TestOptions { public bool Test; } public class TestSettings { public bool Test; } public class Scoped1 { public Scoped1(IOptions&lt;TestOptions&gt; options) { var test = options.Value; } } public class Scoped2 { } public class Singleton1 { private readonly IHttpContextAccessor _httpContextAccessor; public Singleton1(IHttpContextAccessor httpContextAccessor) { _httpContextAccessor = httpContextAccessor; } public Task Test1Async() =&gt; Task.Delay(100); public Task Test2Async() { Task.Delay(100).GetAwaiter().GetResult(); return Task.CompletedTask; } public async Task&lt;TestSettings&gt; GetSettingsAsync() { // Here the async call before resolving a service lazily. await Test1Async(); // Doesn't fail if we use 'Test2Async()', see above. // Here the dead lock _httpContextAccessor.HttpContext.RequestServices.GetRequiredService&lt;Scoped2&gt;(); return new TestSettings(); } } public class ConfigureTestOptions : IConfigureOptions&lt;TestOptions&gt; { private readonly Singleton1 _singleton1; public ConfigureTestOptions(Singleton1 singleton1) =&gt; _singleton1 = singleton1; public void Configure(TestOptions options) { // This is a common pattern that we use, and that involves 'IDocumentManager' most of the time var document = _singleton1.GetSettingsAsync().GetAwaiter().GetResult(); options.Test = document.Test; } } public class TestSartup : StartupBase { public override void ConfigureServices(IServiceCollection services) { services.AddScoped&lt;Scoped1&gt;(); services.AddScoped&lt;Scoped2&gt;(); services.AddSingleton&lt;Singleton1&gt;(); services.AddTransient&lt;IConfigureOptions&lt;TestOptions&gt;, ConfigureTestOptions&gt;(); } } // Injecting scoped1 here, just for testing public class RecipeEnvironmentSuperUserProvider : IRecipeEnvironmentProvider { ... public RecipeEnvironmentSuperUserProvider( Scoped1 scoped1, ... ...) { ... } A more simple repro being public class RecipeEnvironmentSuperUserProvider : IRecipeEnvironmentProvider { ... public RecipeEnvironmentSuperUserProvider( IServiceProvider serviceProvider, ... ...) { ... TestAsync(serviceProvider).GetAwaiter().GetResult(); } private async Task TestAsync(IServiceProvider services) { await Task.Delay(100); var test = _serviceProvider.GetRequiredService&lt;Scoped2&gt;(); // Here the DI dead lock. }</DESCRIPTION>
  <REPONAME>OrchardCore</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Admin Module Resource TagHelpers for favicon (#9263)</MESSAGE>
    <SHA>c141b02d43e1b96e9c04516d06c3153675f996e0</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixes #9270 DI Deadlock</MESSAGE>
      <SHA>924ea29de731ef664a41316739a1c0d707e83668</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore/OrchardCore.Infrastructure/Documents/DocumentManager.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixes #9270 DI Deadlock (#9272)</MESSAGE>
      <SHA>48d596a85c311436650380d746e0c423d6c8d2e5</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore/OrchardCore.Infrastructure/Documents/DocumentManager.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
