<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>11617</ISSUENO>
  <ISSUEURL>https://github.com/OrchardCMS/OrchardCore/issues/11617</ISSUEURL>
  <TITLE>Using Redis with sentinels</TITLE>
  <DESCRIPTION>We use Redis distributed cache with 3 sentinels: 1Master + 1 sentinel in first PC 1Replica + 2 sentinels in second PC Connection configuration: ```&quot;OrchardCore&quot;: { &quot;OrchardCore_Redis&quot;: { &quot;Configuration&quot;: &quot;localhost:26379,password=somePassword,serviceName=redis-orchard,allowAdmin=true&quot;, &quot;InstancePrefix&quot;: &quot;orchard&quot; // Optional prefix allowing a Redis instance to be shared by different applications. } ``` For using this configuration, we use main branch https://github.com/StackExchange/StackExchange.Redis (previous versions, include last release [2.5.61], throw error about getting information about replica). ``` &lt;Project Sdk=&quot;Microsoft.NET.Sdk&quot;&gt; &lt;PropertyGroup&gt; &lt;RootNamespace&gt;OrchardCore.Redis&lt;/RootNamespace&gt; &lt;!-- NuGet properties--&gt; &lt;Title&gt;OrchardCore Redis Abstractions&lt;/Title&gt; &lt;Description&gt;$(OCFrameworkDescription) Abstractions for Redis.&lt;/Description&gt; &lt;PackageTags&gt;$(PackageTags) OrchardCoreFramework Abstractions&lt;/PackageTags&gt; &lt;/PropertyGroup&gt; &lt;ItemGroup&gt; &lt;FrameworkReference Include=&quot;Microsoft.AspNetCore.App&quot; /&gt; &lt;/ItemGroup&gt; &lt;ItemGroup&gt; &lt;PackageReference Include=&quot;Microsoft.AspNetCore.DataProtection.StackExchangeRedis&quot; /&gt; &lt;PackageReference Include=&quot;Microsoft.Extensions.Caching.StackExchangeRedis&quot; Version=&quot;5.0.1&quot; /&gt; &lt;PackageReference Include=&quot;StackExchange.Redis&quot; Version=&quot;2.6.34-gc83443aaaf&quot; /&gt; &lt;/ItemGroup&gt; &lt;ItemGroup&gt; &lt;ProjectReference Include=&quot;..\OrchardCore.Abstractions\OrchardCore.Abstractions.csproj&quot; /&gt; &lt;/ItemGroup&gt; &lt;/Project&gt; ``` Steps to reproduce the behavior: 1. Configure OrchardCore_OrchardCore_Redis 2. Enable feature OrchardCore.Redis.Cache (feature OrchardCore.Redis is enabled as dependency) 3. Error is thrown: &quot;Sentinel: The ConnectionMultiplexer is not a Sentinel connection. Detected as: Stanalone&quot; How it works in code: 1. OrchardCore.Redis.Startup ConfigureServices(IServiceCollection services) configures RedisOption from configuration[&quot;OrchardCore_Redis:Configuration&quot;]. 2. When OrchardCore.Redis is started OrchardCore.Redis.Services.RedisServer connects to Redis with ConnectAsync(_options.Value.ConfigurationOptions) (use configured in step 1) 3. When StackExchange.Redis connecting to localhost:26379 (sentinel service), ConfigurationOptions is changing because sentinel service reports about master and replica servers. 4. After connection ConfigurationOptions is set as &quot;[1.1.1.1:6379,2.2.2.2:6379],password=somePassword,serviceName=redis-orchard,allowAdmin=true&quot;. This action changes RedisOption.ConfigurationOptions too. 5. When OrchardCore.Redis.Cache is started AddStackExchangeRedisCache use RedisCacheOptionsSetup for connection to Redis. 6. RedisCacheOptionsSetup uses RedisOption.ConfigurationOptions (now it is [1.1.1.1:6379,2.2.2.2:6379],password=somePassword,serviceName=redis-orchard,allowAdmin=true) and when StackExchange.Redis start connection it get first EndPoint (1.1.1.1:6379) 7. Because ConfigurationOptions contains serviceName=redis-orchard, StackExchange.Redis defines connection how sentinel but ServerSelectionStrategy.ServerType (by EndPoint) is Standalone and error is thrown. My propose: RedisCacheOptions and RedisOption should be distinct. 1. OrchardCore.Redis.Options.RedisCacheOptionsSetup should be deleted. 2. RedisCacheStartup should configure RedisCacheOptions from configuretion. ``` [Feature(&quot;OrchardCore.Redis.Cache&quot;)] public class RedisCacheStartup : StartupBase { private readonly string _tenant; private readonly IShellConfiguration _configuration; private readonly ILogger _logger; public RedisCacheStartup(ShellSettings shellSettings, IShellConfiguration configuration, ILogger&lt;Startup&gt; logger) { _tenant = shellSettings.Name; _configuration = configuration; _logger = logger; } public override void ConfigureServices(IServiceCollection services) { if (services.Any(d =&gt; d.ServiceType == typeof(IRedisService))) { try { var configurationOptions = ConfigurationOptions.Parse(_configuration[&quot;OrchardCore_Redis:Configuration&quot;]); var instancePrefix = _configuration[&quot;OrchardCore_Redis:InstancePrefix&quot;]; services.Configure&lt;RedisCacheOptions&gt;(options =&gt; { options.ConfigurationOptions = configurationOptions; options.InstanceName = instancePrefix; }); } catch (Exception e) { _logger.LogError(&quot;'Redis.Cache' features are not active on tenant '{TenantName}' as the 'Configuration' string is missing or invalid: &quot; + e.Message, _tenant); return; } services.AddStackExchangeRedisCache(o =&gt; { }); services.AddScoped&lt;ITagCache, RedisTagCache&gt;(); } } } ``` In this case all works as expected.</DESCRIPTION>
  <REPONAME>OrchardCore</REPONAME>
  <TIMEDIFFERENCEDAYS>11</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>libraries</MESSAGE>
    <SHA>219270423a566b8d9f9de39f97932b5e1d7213ae</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Using Redis with sentinels #11617</MESSAGE>
      <SHA>9e20859f20cb34d5019c9bc5e82f17c44280e012</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore.Modules/OrchardCore.Redis/Startup.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore.Redis.Abstractions/RedisOptions.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Using Redis with sentinels #11617</MESSAGE>
      <SHA>6af7f1738113718dd7649f0aa733ad67f726c2eb</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore.Modules/OrchardCore.Redis/Startup.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Using Redis with sentinels #11617 (cosmetic change)</MESSAGE>
      <SHA>29502d65f5c55aecde3f1a049270f8fb18a5db0d</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore/OrchardCore.Redis.Abstractions/RedisOptions.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Using Redis with sentinels #11617 (#11637)</MESSAGE>
      <SHA>e5d42545ab4295da1669956d5fab8273fe431a31</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore.Modules/OrchardCore.Redis/Startup.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore.Redis.Abstractions/RedisOptions.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
