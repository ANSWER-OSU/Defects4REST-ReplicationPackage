<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5233</ISSUENO>
  <ISSUEURL>https://github.com/OrchardCMS/OrchardCore/issues/5233</ISSUEURL>
  <TITLE>Lucene index creation from a recipe, in a module: SQLite Error 6: 'database schema is locked: main'.</TITLE>
  <DESCRIPTION>Hi all, I'm having an issue when I try t o run a recipe that contains the instructions to create a Lucene's index. I'm working on dev branch and after lasts commit I have seen some news in the Lucene's index creation code inside the recipe. I have updated my recipes inside my modules like this: ``` { &quot;name&quot;: &quot;lucene-index&quot;, &quot;Indices&quot;: [ { &quot;BoxLinks&quot;: { &quot;AnalyzerName&quot;: &quot;standardanalyzer&quot;, &quot;IndexLatest&quot;: false, &quot;IndexedContentTypes&quot;: [ &quot;BoxLink&quot; ] } } ] } ``` But when I try to setup a new site I receive this error: ``` OrchardCore.Data.Migration.DataMigrationManager|ERROR|Error while running migration version 0 for '...BoxLink'. Microsoft.Data.Sqlite.SqliteException (0x80004005): SQLite Error 6: 'database schema is locked: main'. at Microsoft.Data.Sqlite.SqliteException.ThrowExceptionForRC(Int32 rc, sqlite3 db) at Microsoft.Data.Sqlite.SqliteCommand.PrepareAndEnumerateStatements(Stopwatch timer)+MoveNext() at Microsoft.Data.Sqlite.SqliteCommand.GetStatements(Stopwatch timer)+MoveNext() at Microsoft.Data.Sqlite.SqliteDataReader.NextResult() at Microsoft.Data.Sqlite.SqliteCommand.ExecuteReader(CommandBehavior behavior) at Microsoft.Data.Sqlite.SqliteCommand.ExecuteReader() at Microsoft.Data.Sqlite.SqliteCommand.ExecuteNonQuery() at Microsoft.Data.Sqlite.SqliteConnectionExtensions.ExecuteNonQuery(SqliteConnection connection, String commandText, SqliteParameter[] parameters) at Microsoft.Data.Sqlite.SqliteTransaction..ctor(SqliteConnection connection, IsolationLevel isolationLevel) at Microsoft.Data.Sqlite.SqliteConnection.BeginTransaction(IsolationLevel isolationLevel) at Microsoft.Data.Sqlite.SqliteConnection.BeginDbTransaction(IsolationLevel isolationLevel) at System.Data.Common.DbConnection.BeginTransaction(IsolationLevel isolationLevel) at YesSql.Session.DemandAsync() at YesSql.Services.DefaultQuery.Query`1.FirstOrDefaultImpl() at OrchardCore.Lucene.LuceneIndexSettingsService.LoadDocumentAsync(ISession session) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore.Modules\OrchardCore.Lucene\Services\LuceneIndexSettingsService.cs:line 121 at OrchardCore.Lucene.LuceneIndexSettingsService.UpdateIndexAsync(LuceneIndexSettings settings) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore.Modules\OrchardCore.Lucene\Services\LuceneIndexSettingsService.cs:line 95 at OrchardCore.Lucene.LuceneIndexingService.CreateIndexAsync(LuceneIndexSettings indexSettings) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore.Modules\OrchardCore.Lucene\Services\LuceneIndexingService.cs:line 243 at OrchardCore.Lucene.Recipes.LuceneIndexStep.ExecuteAsync(RecipeExecutionContext context) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore.Modules\OrchardCore.Lucene\Recipes\LuceneIndexStep.cs:line 46 at OrchardCore.Recipes.Services.RecipeExecutor.&lt;&gt;c__DisplayClass12_0.&lt;&lt;ExecuteStepAsync&gt;b__0&gt;d.MoveNext() in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 175 --- End of stack trace from previous location where exception was thrown --- at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Abstractions\Shell\Scope\ShellScope.cs:line 195 at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteStepAsync(RecipeExecutionContext recipeStep) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 156 at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 100 at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 118 at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 146 at OrchardCore.Recipes.Services.RecipeMigrator.ExecuteAsync(String recipeFileName, IDataMigration migration) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeMigrator.cs:line 41 at It.Csc.OrchardCorePA.Content.BoxLink.Migrations.CreateAsync() in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCorePA\Modules\It.Csc.OrchardCorePA.Content.BoxLink\Migrations.cs:line 33 at OrchardCore.Data.Migration.DataMigrationManager.UpdateAsync(String featureId) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Data\Migration\DataMigrationManager.cs:line 207 at Microsoft.Data.Sqlite.SqliteException.ThrowExceptionForRC(Int32 rc, sqlite3 db) at Microsoft.Data.Sqlite.SqliteCommand.PrepareAndEnumerateStatements(Stopwatch timer)+MoveNext() at Microsoft.Data.Sqlite.SqliteCommand.GetStatements(Stopwatch timer)+MoveNext() at Microsoft.Data.Sqlite.SqliteDataReader.NextResult() at Microsoft.Data.Sqlite.SqliteCommand.ExecuteReader(CommandBehavior behavior) at Microsoft.Data.Sqlite.SqliteCommand.ExecuteReader() at Microsoft.Data.Sqlite.SqliteCommand.ExecuteNonQuery() at Microsoft.Data.Sqlite.SqliteConnectionExtensions.ExecuteNonQuery(SqliteConnection connection, String commandText, SqliteParameter[] parameters) at Microsoft.Data.Sqlite.SqliteTransaction..ctor(SqliteConnection connection, IsolationLevel isolationLevel) at Microsoft.Data.Sqlite.SqliteConnection.BeginTransaction(IsolationLevel isolationLevel) at Microsoft.Data.Sqlite.SqliteConnection.BeginDbTransaction(IsolationLevel isolationLevel) at System.Data.Common.DbConnection.BeginTransaction(IsolationLevel isolationLevel) at YesSql.Session.DemandAsync() at YesSql.Services.DefaultQuery.Query`1.FirstOrDefaultImpl() at OrchardCore.Lucene.LuceneIndexSettingsService.LoadDocumentAsync(ISession session) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore.Modules\OrchardCore.Lucene\Services\LuceneIndexSettingsService.cs:line 121 at OrchardCore.Lucene.LuceneIndexSettingsService.UpdateIndexAsync(LuceneIndexSettings settings) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore.Modules\OrchardCore.Lucene\Services\LuceneIndexSettingsService.cs:line 95 at OrchardCore.Lucene.LuceneIndexingService.CreateIndexAsync(LuceneIndexSettings indexSettings) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore.Modules\OrchardCore.Lucene\Services\LuceneIndexingService.cs:line 243 at OrchardCore.Lucene.Recipes.LuceneIndexStep.ExecuteAsync(RecipeExecutionContext context) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore.Modules\OrchardCore.Lucene\Recipes\LuceneIndexStep.cs:line 46 at OrchardCore.Recipes.Services.RecipeExecutor.&lt;&gt;c__DisplayClass12_0.&lt;&lt;ExecuteStepAsync&gt;b__0&gt;d.MoveNext() in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 175 --- End of stack trace from previous location where exception was thrown --- at OrchardCore.Environment.Shell.Scope.ShellScope.UsingAsync(Func`2 execute) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Abstractions\Shell\Scope\ShellScope.cs:line 195 at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteStepAsync(RecipeExecutionContext recipeStep) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 156 at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 100 at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 118 at OrchardCore.Recipes.Services.RecipeExecutor.ExecuteAsync(String executionId, RecipeDescriptor recipeDescriptor, Object environment, CancellationToken cancellationToken) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeExecutor.cs:line 146 at OrchardCore.Recipes.Services.RecipeMigrator.ExecuteAsync(String recipeFileName, IDataMigration migration) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Recipes.Core\Services\RecipeMigrator.cs:line 41 at It.Csc.OrchardCorePA.Content.BoxLink.Migrations.CreateAsync() in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCorePA\Modules\It.Csc.OrchardCorePA.Content.BoxLink\Migrations.cs:line 33 at OrchardCore.Data.Migration.DataMigrationManager.UpdateAsync(String featureId) in D:\lavoro\.net_core\OrchardCore-GIT\OrchardCore\src\OrchardCore\OrchardCore.Data\Migration\DataMigrationManager.cs:line 207 ``` Hope this can be an useful report. I'm trying to understand what is going wrong, but I miss some OC's meetings in the Christmas time and I believe to have lost something important .</DESCRIPTION>
  <REPONAME>OrchardCore</REPONAME>
  <TIMEDIFFERENCEDAYS>26</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Use StringLocalizer in SelectListItem (#5407)</MESSAGE>
    <SHA>e8c953a13e758097c86eda59da542757ace71689</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixes #5233 database locking issue</MESSAGE>
      <SHA>ca35299e7e94eb59f866d1c57264a515d8c4d69c</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore.Modules/OrchardCore.Lucene/Services/LuceneIndexSettingsService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixes #5233 database locking issue (#5411)</MESSAGE>
      <SHA>ac33a35b3d68c9d7502f07119babf71372d0c08f</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore.Modules/OrchardCore.Lucene/Services/LuceneIndexManager.cs</FILE>
        <FILE>src/OrchardCore.Modules/OrchardCore.Lucene/Services/LuceneIndexSettingsService.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
