<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>15411</ISSUENO>
  <ISSUEURL>https://github.com/OrchardCMS/OrchardCore/issues/15411</ISSUEURL>
  <TITLE>Restarting instance of a workflow starting with the Content Created event fails with InvalidCastException</TITLE>
  <DESCRIPTION>### Describe the bug Restarting instance of a workflow starting with the Content Created event fails with `InvalidCastException`. It doesn't matter what else happens in the workflow (I initially tested with a real-world use-case, not just an event without actions). ### To Reproduce 1. Set up fresh site using any recipe, I tested with Blank and Blog. 2. Enable the Workflows feature and create a workflow with the Content Created event. Select all content types for the event and set it as the Startup task. 3. Create a content item of any type, observe that the workflow instance runs successfully. 4. Go to the list of workflow instances and restart the instance. 5. The following exception is thrown: ``` `InvalidCastException: Unable to cast object of type 'System.Collections.Generic.Dictionary`2[System.String,System.Object]' to type 'OrchardCore.ContentManagement.IContent'.` ``` Call stack: ``` OrchardCore.Workflows.Helpers.DictionaryExtensions.GetValue&lt;TValue&gt;(IDictionary&lt;string, object&gt; dictionary, string key) in DictionaryExtensions.cs 24. return (TValue)value; OrchardCore.Contents.Workflows.Activities.ContentActivity.GetContentAsync(WorkflowExecutionContext workflowContext) in ContentActivity.cs 138. content = workflowContext.Input.GetValue&lt;IContent&gt;(ContentEventConstants.ContentItemInputKey) OrchardCore.Contents.Workflows.Activities.ContentEvent.CanExecuteAsync(WorkflowExecutionContext workflowContext, ActivityContext activityContext) in ContentEvent.cs 30. var content = await GetContentAsync(workflowContext); OrchardCore.Workflows.Services.WorkflowManager.RestartWorkflowAsync(WorkflowType workflowType, IDictionary&lt;string, object&gt; input, string correlationId) in WorkflowManager.cs 335. if (!await activityContext.Activity.CanExecuteAsync(workflowContext, activityContext)) OrchardCore.Workflows.Controllers.WorkflowController.Restart(long id) in WorkflowController.cs 287. await _workflowManager.RestartWorkflowAsync(workflow, workflowType); OrchardCore.Workflows.Controllers.WorkflowController.Restart(long id) in WorkflowController.cs 290. } ``` ### Expected behavior The instance is restarted and runs without error.</DESCRIPTION>
  <REPONAME>OrchardCore</REPONAME>
  <TIMEDIFFERENCEDAYS>85</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Cleanup IContentManager (#16077) --------- Co-authored-by: Hisham Bin Ateya &lt;hishamco_2007@yahoo.com&gt; Co-authored-by: Zoltán Lehóczky &lt;zoltan.lehoczky@lombiq.com&gt;</MESSAGE>
    <SHA>77c69c6201e1b7e932c6fc2af263ec7b4387f44d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix casting during workflow instance restart Fix #15411</MESSAGE>
      <SHA>0e3421c0b10da38fbaa17557d259577e1ed09882</SHA>
      <PATCHEDFILES>
        <FILE>src/OrchardCore.Modules/OrchardCore.Contents/Workflows/Activities/ContentActivity.cs</FILE>
        <FILE>src/OrchardCore/OrchardCore.Workflows.Abstractions/Helpers/DictionaryExtensions.cs</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
