<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>23822</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/23822</ISSUEURL>
  <TITLE>Theorical stock calculation error</TITLE>
  <DESCRIPTION>### Bug Good morning, I think there is an oversight in the load_stats_command function of the product.class.php file in the htdocs/products/class/ folder In theorical stock management, if the DECREASE_ONLY_UNINVOICEDPRODUCTS option is on, we have a compensation. But in the SQL query of this part, we do not make the difference between an invoice (stock that we no longer have) and a credit note (stock that we recover). In this query, we just sum all quantities without distinction, invoice quantities are counted as positive. I therefore suggest modifying the SELECT with this proposal: SELECT SUM(IF(f.type=2,-1,1)*fd.qty) as count The goal is that if the type of invoice is a credit (type=2) to multiply by -1 to have a negative quantity otherwise to multiply by 1 and that does not change anything for an invoice. Thank you in advance for your feedback because maybe I'm wrong :) Good day, ### Environment Version 16.0.0 ### Environment OS Ubuntu 18.04.6 LTS ### Environment Web server HTTP/2 - Apache - Nginx/1.20.2 ### Environment PHP 7.4.33 ### Environment Database MySQL 5.7.41 ### Environment URL(s) _No response_ ### Expected and actual behavior _No response_ ### Steps to reproduce the behavior _No response_ ### Attached files _No response_</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>128</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #25053 from atm-maxime/fix_warehouse_backtopage Fix #23946 : wrong backtopage from warehouse to product</MESSAGE>
    <SHA>d1bc7a59f0f2d00de127a5c61c1c0bea2354301f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #23822 virtualstock calculation with credit note</MESSAGE>
      <SHA>87ead82db0099e5098a63757ddf364279bf1a0bd</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/product/class/product.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #25058 from atm-maxime/fix_virtualstock_calculation_with_creditnote Fix #23822 virtualstock calculation with credit note</MESSAGE>
      <SHA>4c681cb501dbb3d6d0241c47cd9c7488df0ec990</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/product/class/product.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
