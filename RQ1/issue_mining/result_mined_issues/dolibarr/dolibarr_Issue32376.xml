<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>32376</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/32376</ISSUEURL>
  <TITLE>[20.0.2][pgsql] SQL error when transferring lines from selling journal to accountancy.</TITLE>
  <DESCRIPTION>### Bug SQL error when transferring lines from selling journal to accountancy, making the transfer fails, when running on postgresql database. ### Dolibarr Version 19.0.3 - 20.0.2 ### Environment PHP 8.2 ### Environment Database Postgresql 15 ### Steps to reproduce the behavior and expected behavior - Same base as https://github.com/Dolibarr/dolibarr/issues/32375#issue-2740746018, ie: - Create a thirdparty client - Create an invoice - Pay the invoice - Transfer the customer invoice (it somehow says it fails to add every lines) - Reload PCG plan, ensure every accounts are setup - transfer to accountancy In practice, I also reproduce on production while trying to transfer to accountancy, after the upgrade to dolibarr 19.0.3. ### Attached files ``` Error ERROR: 42804: argument of CASE/WHEN must be type boolean, not type integer LINE 1: ...k, tl2.fk_doc FROM ( SELECT DISTINCT (CASE WHEN tll.fk_fac... ^ LOCATION: coerce_to_boolean, parse_coerce.c:1176 ``` Happens since 19.0.3, reproduced on 20.0.2. Dolibarr logs: ``` Dec 15 16:27:20 dolibarr[125]: 33 BEGIN Transaction Dec 15 16:27:20 dolibarr[125]: 33 BookKeeping::create Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT date_start, date_end FROM llx_accounting_fiscalyear WHERE entity = 1 AND statut = 0 Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT count(*) as nb FROM llx_accounting_bookkeeping WHERE doc_type = 'customer_invoice' AND fk_doc = 8 AND numero_compte = '411' AND label_operation = 'test - F010001 - Compte auxiliaire' AND entity = 1 Dec 15 16:27:20 dolibarr[125]: 33 BookKeeping:: create sqlnum=SELECT piece_num FROM llx_accounting_bookkeeping WHERE doc_type = 'customer_invoice' AND fk_doc = 8 AND doc_ref = 'F010001' AND entity = 1 Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT piece_num FROM llx_accounting_bookkeeping WHERE doc_type = 'customer_invoice' AND fk_doc = 8 AND doc_ref = 'F010001' AND entity = 1 Dec 15 16:27:20 dolibarr[125]: 33 BookKeeping::create this-&gt;piece_num= Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT MAX(piece_num)+1 as maxpiecenum FROM llx_accounting_bookkeeping WHERE entity = 1 Dec 15 16:27:20 dolibarr[125]: 33 BookKeeping:: create now this-&gt;piece_num= Dec 15 16:27:20 dolibarr[125]: 33 sql=INSERT INTO llx_accounting_bookkeeping (doc_date, date_lim_reglement, doc_type, doc_ref, fk_doc, fk_docdet, thirdparty_code, subledger_account, subledger_label, numero_compte, label_compte, label_operation, debit, credit, montant, sens, fk_user_author, date_creation, code_journal, journal_label, piece_num, entity) VALUES ('2024-12-01 00:00:00', '2024-12-31 00:00:00', 'customer_invoice', 'F010001', 8, 0, 'C000001', 'C000001', 'test', '411', 'Clients', 'test - F010001 - Compte auxiliaire', 7247.1, 0, 7247.1, 'D', '2', '2024-12-15 16:27:20', 'VT', 'Ventes', 1, 1) Dec 15 16:27:20 dolibarr[125]: 33 Lettering::getLinkedLines - Get all bookkeeping lines Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT DISTINCT ab.doc_type, ab.fk_doc FROM llx_accounting_bookkeeping AS ab WHERE ab.entity IN (1) AND ab.fk_doc &gt; 0 AND EXISTS ( SELECT rowid FROM llx_accounting_bookkeeping AS pn WHERE pn.entity IN (1) AND pn.rowid IN (4) AND pn.piece_num = ab.piece_num ) AND ab.subledger_account != '' Dec 15 16:27:20 dolibarr[125]: 33 Lettering::getLinkedDocumentByGroup - Get document lines Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT DISTINCT tl2.fk_paiement AS fk_link, tl2.fk_facture AS fk_doc FROM llx_paiement_facture AS tl LEFT JOIN llx_paiement_facture AS tl2 ON tl2.fk_paiement = tl.fk_paiement WHERE tl.fk_facture IN (8) Dec 15 16:27:20 dolibarr[125]: 33 Lettering::getLinkedDocumentByGroup - Get document lines Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT DISTINCT tl2.fk_link, tl2.fk_doc FROM ( SELECT DISTINCT (CASE WHEN tll.fk_facture THEN tll.fk_facture ELSE tl.fk_facture END) AS fk_link, tl.fk_facture_source AS fk_doc FROM llx_societe_remise_except AS tl LEFT JOIN llx_facturedet AS tll ON tll.rowid = tl.fk_facture_line) AS tl LEFT JOIN ( SELECT DISTINCT (CASE WHEN tll.fk_facture THEN tll.fk_facture ELSE tl.fk_facture END) AS fk_link, tl.fk_facture_source AS fk_doc FROM llx_societe_remise_except AS tl LEFT JOIN llx_facturedet AS tll ON tll.rowid = tl.fk_facture_line) AS tl2 ON tl2.fk_link = tl.fk_link WHERE tl.fk_doc IN (8) AND tl2.fk_doc IS NOT NULL Dec 15 16:27:20 dolibarr[125]: 33 DoliDBPgsql::query SQL Error message: ERROR: 42804: argument of CASE/WHEN must be type boolean, not type integer Dec 15 16:27:20 dolibarr[125]: LINE 1: ...k, tl2.fk_doc FROM ( SELECT DISTINCT (CASE WHEN tll.fk_fac... Dec 15 16:27:20 dolibarr[125]: ^ Dec 15 16:27:20 dolibarr[125]: LOCATION: coerce_to_boolean, parse_coerce.c:1176 (DB_ERROR_42804) Dec 15 16:27:20 dolibarr[125]: 33 DoliDBPgsql::query SQL Error usesavepoint = 0 Dec 15 16:27:20 dolibarr[125]: 33 AccountingAccount::fetch rowid=0 account_number=707002 Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT a.rowid as rowid, a.datec, a.tms, a.fk_pcg_version, a.pcg_type, a.account_number, a.account_parent, a.label, a.labelshort, a.fk_accounting_category, a.fk_user_author, a.fk_user_modif, a.active, a.reconcilable, ca.label as category_label FROM llx_accounting_account as a LEFT JOIN llx_c_accounting_category as ca ON a.fk_accounting_category = ca.rowid WHERE a.account_number = '707002' AND a.entity = 1 AND a.fk_pcg_version IN (SELECT pcg_version FROM llx_accounting_system WHERE rowid = 2) Dec 15 16:27:20 dolibarr[125]: 33 AccountingAccount::fetch rowid= account_number=445712 Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT a.rowid as rowid, a.datec, a.tms, a.fk_pcg_version, a.pcg_type, a.account_number, a.account_parent, a.label, a.labelshort, a.fk_accounting_category, a.fk_user_author, a.fk_user_modif, a.active, a.reconcilable, ca.label as category_label FROM llx_accounting_account as a LEFT JOIN llx_c_accounting_category as ca ON a.fk_accounting_category = ca.rowid WHERE a.account_number = '445712' AND a.entity = 1 AND a.fk_pcg_version IN (SELECT pcg_version FROM llx_accounting_system WHERE rowid = 2) Dec 15 16:27:20 dolibarr[125]: 33 BookKeeping::create Dec 15 16:27:20 dolibarr[125]: 33 sql=SELECT count(*) as nb FROM llx_accounting_bookkeeping WHERE doc_type = 'customer_invoice' AND fk_doc = 8 AND numero_compte = '445712' AND label_operation = 'test - F010001 - Taxes 20 %' AND entity = 1 Dec 15 16:27:20 dolibarr[125]: 33 BookKeeping::create Error ERROR: 42804: argument of CASE/WHEN must be type boolean, not type integer Dec 15 16:27:20 dolibarr[125]: LINE 1: ...k, tl2.fk_doc FROM ( SELECT DISTINCT (CASE WHEN tll.fk_fac... Dec 15 16:27:20 dolibarr[125]: ^ Dec 15 16:27:20 dolibarr[125]: LOCATION: coerce_to_boolean, parse_coerce.c:1176 Dec 15 16:27:20 dolibarr[125]: 33 ROLLBACK Transaction ``` ![image](https://github.com/user-attachments/assets/0db515a1-1b0f-4948-86a0-86ad46af55dd)</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix parsing input date for eldy calendar when using short year</MESSAGE>
    <SHA>65f9e7f172b2b0c6a56c43e5d9d617f8a4c59ef7</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>FIX #32376: lettering: fix ifsql() called with invalid $check parameter The $check is supposed to be a check retuning a boolean. By being an `if (value)` check instead of being an `if (value IS NOT NULL)` check, postgresql complains the types are not correct: Error ERROR: 42804: argument of CASE/WHEN must be type boolean, not type integer LINE 1: ...k, tl2.fk_doc FROM ( SELECT DISTINCT (CASE WHEN tll.fk_fac... ^ LOCATION: coerce_to_boolean, parse_coerce.c:1176 Regression from commit cfc162a31d6f2a3570cacad3d3fef5cd8e756767.</MESSAGE>
      <SHA>45f6905bae7e0d770154180f40a8b84117cabe7b</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/accountancy/class/lettering.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #32376: lettering: fix ifsql() called with invalid $check parameter The $check is supposed to be a check retuning a boolean. By being an `if (value)` check instead of being an `if (value IS NOT NULL)` check, postgresql complains the types are not correct: Error ERROR: 42804: argument of CASE/WHEN must be type boolean, not type integer LINE 1: ...k, tl2.fk_doc FROM ( SELECT DISTINCT (CASE WHEN tll.fk_fac... ^ LOCATION: coerce_to_boolean, parse_coerce.c:1176 Regression from commit cfc162a31d6f2a3570cacad3d3fef5cd8e756767.</MESSAGE>
      <SHA>958ab9be915f36c282d6f0d9e09d0d3e380ac86d</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/accountancy/class/lettering.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #32378 from alexandre-janniaux/fix-32376-lettering-issue FIX #32376: lettering: fix ifsql() called with invalid $check parameter</MESSAGE>
      <SHA>10c29023be1abc6e9bc8bc002cd44286f8786e3e</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/accountancy/class/lettering.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
