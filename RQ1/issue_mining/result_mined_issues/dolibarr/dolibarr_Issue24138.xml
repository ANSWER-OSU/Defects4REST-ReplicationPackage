<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>24138</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/24138</ISSUEURL>
  <TITLE>Migration issue 15.0.4 -&gt; 17.0.0: SQL error on &quot;birthday for this month&quot;</TITLE>
  <DESCRIPTION>### Bug After migrating from 15.0.4 to 17.0.0, the following error happens in the birthday panel (in french &quot;anniversaire de ce mois&quot;). ``` ERROR: 0A000: invalid UNION/INTERSECT/EXCEPT ORDER BY clause LINE 1: ...te_format( u.dateemployment, '%c') = '3' ORDER BY DAY(datea)... ^ DETAIL: Only result column names can be used, not expressions or functions. HINT: Add the expression/function to every SELECT, or move the UNION into a FROM clause. LOCATION: transformSetOperationStmt, analyze.c:1776 sql=SELECT u.rowid, u.firstname, u.lastname, u.birth as datea, 'birth' as typea,â€¦ ``` There were no errors in 15.0.4. ### Environment Version 17.0.0 ### Environment OS Debian bullseye ### Environment Web server Nginx ### Environment PHP PHP 7.4 ### Environment Database Postgres Scaleway ### Environment URL(s) _No response_ ### Expected and actual behavior Expected : no birthday this month Actual behaviour: SQL error message ### Steps to reproduce the behavior Install a 15.0.4 instance, upgrade to 17.0.0 with `php upgrade.php / upgrade2.php 15.0.4 17.0.0`. I can produce such instance in a few days to ensure it can be reproduced from scratch, and share database anyway. ### Attached files In 15.0.4: ![image](https://user-images.githubusercontent.com/413037/223069421-93b1c754-966c-4674-a9aa-36cb23d4b650.png) In 17.0.0: ![image](https://user-images.githubusercontent.com/413037/223069325-11441485-d1f8-4458-a795-4c766e18e795.png)</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>11</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch '17.0' of git@github.com:Dolibarr/dolibarr.git into 17.0</MESSAGE>
    <SHA>33744f74da1a5c20f8aa9950018ab4e549e00205</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>FIX #24138 Fix box_birthdays SQL for postgres</MESSAGE>
      <SHA>fd0c6fa1441605eff4c485e667fd7ac303d763d5</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/core/boxes/box_birthdays.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #24138 Fix box_birthdays SQL for postgres PR #21631's implementation causes issues with PostgreSQL and potentially other stricter RDBMSes, indeed doing an ORDER BY using a function is not supported. In this fix we're computing the day of each user birthday and employment day in the SELECT columns, and use those columns as a sorting key.</MESSAGE>
      <SHA>f136cee0f20beec0eea84958bf3bb7c589ef70d3</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/core/boxes/box_birthdays.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #24138 FIX #24238</MESSAGE>
      <SHA>1a89a7ea5c4f09d95213836bd3d1af69ae5c13ea</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/core/boxes/box_birthdays.php</FILE>
        <FILE>htdocs/core/boxes/box_birthdays_members.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #24238 from lastmikoi/issue-24138-birthday-sql-error FIX #24138 Fix box_birthdays SQL for postgres</MESSAGE>
      <SHA>2ebf15288408fc1e586dce22d17d3d2910e324aa</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/core/boxes/box_birthdays.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #24138 Fix box_birthdays SQL for postgres PR #21631's implementation causes issues with PostgreSQL and potentially other stricter RDBMSes, indeed doing an ORDER BY using a function is not supported. In this fix we're computing the day of each user birthday and employment day in the SELECT columns, and use those columns as a sorting key.</MESSAGE>
      <SHA>59b02a9f49a16a119c7ad6c7696587ddd36e8882</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/core/boxes/box_birthdays.php</FILE>
        <FILE>htdocs/core/boxes/box_birthdays_members.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
