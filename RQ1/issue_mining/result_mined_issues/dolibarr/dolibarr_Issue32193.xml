<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>32193</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/32193</ISSUEURL>
  <TITLE>Stored CSRF via Uploaded HTML File in User Account Document Section</TITLE>
  <DESCRIPTION>### Bug The application allows normal users (e.g.,test.test) to upload files in their user account under the /user/document.php path. However, there are no restrictions preventing the upload of .html files, which can contain CSRF payloads. When an admin user later inspects the user's account, downloads, and opens the file in their browser, the CSRF payload automatically logs them out. This vulnerability exposes administrators to potential session disruption and indicates a lack of filtering for potentially executable file uploads. ### Dolibarr Version Dolibarr 21.0.0-alpha ### Environment PHP _No response_ ### Environment Database _No response_ ### Steps to reproduce the behavior and expected behavior - **Log in as an admin** user and create a new user account (test.test) with permissions to modify their data. - **Log in as test.test** and navigate to card option then open linked files https://preview2.dolibarr.org/user/document.php?userid=&lt;user_id&gt; - **Upload a crafted .html file** containing the logout CSRF payload. - **Log back in as the admin** user and open the user list. - **Inspect the test.test user account**. You will see a notification or link indicating that a file has been uploaded by the user. - **To check the uploaded file by user, click on the file,** it will be downloaded automatically. - **Open the downloaded file in a browser** to check its contents. Observe that the CSRF payload automatically logs out the admin. - **Expected Result** - The application should restrict uploads of potentially dangerous files (like .html) to prevent CSRF attacks and ensure that uploaded files cannot execute scripts that impact admin sessions. - **Actual Result** - The application allows the upload of .html files, which can contain executable scripts. When viewed or downloaded by an admin, these scripts execute in the adminâ€™s session, logging them out or performing other actions via CSRF. ### Attached files https://github.com/user-attachments/assets/c7278ded-f65b-4644-b63f-26b2a5357dc7</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>35</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix regression</MESSAGE>
    <SHA>e72f23895b5a609f2088fc851120893ee4fa2bc2</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #32193 Add verification on extension file for upload</MESSAGE>
      <SHA>b71b8e5e4f60c397b60d6c121ef58f2edb2e40c7</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/admin/security_file.php</FILE>
        <FILE>htdocs/core/lib/files.lib.php</FILE>
        <FILE>htdocs/langs/en_US/admin.lang</FILE>
        <FILE>htdocs/langs/en_US/errors.lang</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge branch 'develop' into Fix-#32193</MESSAGE>
      <SHA>46134ff5c6d2237e8b691708e82b55e0860310df</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/admin/index.php</FILE>
        <FILE>htdocs/admin/mails.php</FILE>
        <FILE>htdocs/core/class/extrafields.class.php</FILE>
        <FILE>htdocs/core/lib/functions.lib.php</FILE>
        <FILE>htdocs/core/modules/modAccounting.class.php</FILE>
        <FILE>htdocs/core/tpl/objectline_view.tpl.php</FILE>
        <FILE>htdocs/langs/en_US/main.lang</FILE>
        <FILE>htdocs/langs/fr_FR/main.lang</FILE>
        <FILE>htdocs/theme/eldy/global.inc.php</FILE>
        <FILE>htdocs/theme/md/style.css.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge branch 'develop' into Fix-#32193</MESSAGE>
      <SHA>7661d52ba1d2fcba41e487d097549e272fa4e6ea</SHA>
      <PATCHEDFILES>
        <FILE>build/phpstan/phpstan-baseline.neon</FILE>
        <FILE>htdocs/adherents/class/adherent.class.php</FILE>
        <FILE>htdocs/blockedlog/admin/blockedlog_list.php</FILE>
        <FILE>htdocs/blockedlog/class/blockedlog.class.php</FILE>
        <FILE>htdocs/compta/facture/list.php</FILE>
        <FILE>htdocs/core/actions_massactions.inc.php</FILE>
        <FILE>htdocs/core/class/html.formfile.class.php</FILE>
        <FILE>htdocs/core/tpl/list_print_total.tpl.php</FILE>
        <FILE>htdocs/cron/class/cronjob.class.php</FILE>
        <FILE>htdocs/langs/en_US/admin.lang</FILE>
        <FILE>htdocs/langs/en_US/blockedlog.lang</FILE>
        <FILE>htdocs/langs/en_US/errors.lang</FILE>
        <FILE>htdocs/langs/en_US/mails.lang</FILE>
        <FILE>htdocs/projet/tasks.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Merge pull request #32337 from Hystepik/Fix-#32193 Fix #32193 Add verification on extension file for upload</MESSAGE>
      <SHA>6312b646b5f1e39895ebaf7f7a38bff02e4a50d5</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/admin/security_file.php</FILE>
        <FILE>htdocs/core/lib/files.lib.php</FILE>
        <FILE>htdocs/langs/en_US/admin.lang</FILE>
        <FILE>htdocs/langs/en_US/errors.lang</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
