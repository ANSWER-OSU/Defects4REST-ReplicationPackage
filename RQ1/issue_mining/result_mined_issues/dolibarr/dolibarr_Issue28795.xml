<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>28795</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/28795</ISSUEURL>
  <TITLE>forgeSQLFromUniversalSearchCriteria breaking forms in v18 file: core/lib/functions.lib.php</TITLE>
  <DESCRIPTION>### Bug forgeSQLFromUniversalSearchCriteria breaking many company and project select2 inputs in my application. file: core/lib/functions.lib.php ### Dolibarr Version 18.0 ### Environment PHP PHP 7.x ### Environment Database 10.11.3-MariaDB-1 - Debian 12 ### Steps to reproduce the behavior and expected behavior Attempt to use the &quot;Form::select_company&quot; function with multiple conditions OR simply use a conditions such as the following and the &quot;Bad syntax of the search string&quot; error occurs. `&quot;((s.client = 1 OR s.client = 2 OR s.client = 3) AND s.status=1)'&quot;` `&quot;( s.client IN (1,2,3) )&quot; ` Also, try doing a project select2 input field with filter &quot;fk_soc=1234&quot; and the same error occurs. `//Do not display projects until a thirdparty is selected : start here` `$thirdparty_soc_id = isset( $socid ) &amp;&amp; ! empty ( $socid ) ? $socid : '0000';` `if (isset($object-&gt;fields['fk_project'], $thirdparty_soc_id)) {` ` $object-&gt;fields['fk_project'] = array('type'=&gt;'integer:Project:projet/class/project.class.php:1:fk_soc='.$thirdparty_soc_id, 'label'=&gt;'Project', 'picto'=&gt;'project', 'enabled'=&gt;'$conf- &gt;project-&gt;enabled', 'position'=&gt;52, 'notnull'=&gt;-1, 'visible'=&gt;-1, 'index'=&gt;1, 'css'=&gt;'maxwidth500 widthcentpercentminusxx', 'validate'=&gt;'1',);` `}//Do not display projects until a thirdparty is selected : end here ` &lt;img width=&quot;928&quot; alt=&quot;Screenshot 2024-03-12 at 3 01 18 PM&quot; src=&quot;https://github.com/Dolibarr/dolibarr/assets/445543/0ad45279-191c-4362-9022-97417f8727cf&quot;&gt; Company search produces SQL Error due to query condition &quot;AND (Filter syntax error - Bad syntax of the search string) &quot; inserted into the query. &lt;img width=&quot;1118&quot; alt=&quot;Screenshot 2024-03-12 at 3 04 19 PM&quot; src=&quot;https://github.com/Dolibarr/dolibarr/assets/445543/a98e679b-8d1c-4a51-90e2-ffa3d57f4a9c&quot;&gt; ### Attached files I am using version 18.x and found issues when trying to use &quot;Form::select_thirdparty_list&quot; with ajax select2. print img_picto('', '').$form-&gt;select_company('', 'socid', '((s.client = 1 OR s.client = 2 OR s.client = 3) AND s.status=1)', 'SelectThirdParty', 0, 0, null, 0, 'minwidth175 maxwidth500 widthcentpercentminusxx'); Search produces the following error: &quot;Bad syntax of the search string&quot; I tried updating the filter to &quot;( s.client IN (1,2,3) )&quot; and get the same error. I see two(2) issues here: A. The function does not allow for more than one condition. B. The function is rejecting perfectly functional filters. There is a pull request that reports the issue is fixed below. However, I am on the latest for v.18 and do not see the change. v.18 The issue reported in the following is still present. https://github.com/Dolibarr/dolibarr/pull/26921</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>377</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge branch '17.0' of git@github.com:Dolibarr/dolibarr.git into 18.0</MESSAGE>
    <SHA>aa10a32d4f06662098e2d9b1f200b46d85a66081</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Update functions.lib.php #28795 Promote modification from Pull request #26921 to v18 to resolve issues related to Issue breaking project and third-party dropdowns with reasonably acceptable filters that fail this test.</MESSAGE>
      <SHA>6b5641aef1b4124165f30f69cb8619c97042f4ea</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/core/lib/functions.lib.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
