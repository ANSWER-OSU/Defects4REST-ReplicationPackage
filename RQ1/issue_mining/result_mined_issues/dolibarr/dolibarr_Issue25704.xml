<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>25704</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/25704</ISSUEURL>
  <TITLE>Critical Bug: Bugfix for Taxes Deleted from Vendor Invoices</TITLE>
  <DESCRIPTION>### Bug In Spain, we use the field localtax2 for a type of tax (IRPF) that needs to be withheld and accounted for in some vendor invoices. The tax is properly applied to vendor invoices, but is then deleted from these invoices if the &quot;Label&quot; field of vendor invoices is added or edited after the invoice has been validated. ### Environment Version 17.0.3 ### Environment OS _No response_ ### Environment Web server Version Apache/2.4.41 (Ubuntu) ### Environment PHP 7.4.33 and 8.1 (tested both) ### Environment Database MariaDB 5.5.5-10.3.38 ### Environment URL(s) dolibarr/fourn/facture/card.php ### Expected and actual behavior When creating or editing a label of a vendor invoice, that field should be edited without any other change to existing invoice. What actually happens is that &quot;localtax2&quot; **taxes are deleted from invoice.** We have **fixed the error** by doing the following: Find line 437 of the file: htdocs/fourm/facture/card.php `} elseif ($action == 'setlabel' &amp;&amp; $usercancreate){ $object-&gt;fetch($id);` And add the following code right after the above line to correct the issue: `$object-&gt;localtax2=$object-&gt;total_localtax2;` The problem seems to be that when the page is loaded for editing, the variable localtax does not load any value (NULL) and instead the following nonexisting variable is used: **total_localtax2**. The update of the field is actually carried out in the database field localtal2, not with **total_localtax2** as Dolibarr is wrongly using. If our analysis is wrong or if you find a more elegant way to solve it, we are all ears. We would appreciate it if our fix or a better one could be included in future releases as wrong taxes are a total showstopper. ### Steps to reproduce the behavior Edit any vendor invoice that has localtax2 taxes after it has been validated. ### Attached files _No response_</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>29</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>FIX #25853 Thirdparty Massaction</MESSAGE>
    <SHA>de25cae7077a596e4608aacf9d6d1d28c0e11c0f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>FIX #25704 Taxes Deleted from Vendor Invoices</MESSAGE>
      <SHA>d08190d424476756d9cafd839f3a9f821568aeb4</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/fourn/class/fournisseur.facture.class.php</FILE>
        <FILE>htdocs/fourn/facture/card.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #25704 Taxes Deleted from Vendor Invoices</MESSAGE>
      <SHA>ce5ab25cce61c6a9be741b3e7aeaf63043a48426</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/fourn/class/fournisseur.facture.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #25704 Taxes Deleted from Vendor Invoices</MESSAGE>
      <SHA>ac92a06e804b9e1282593755671a9f65e42e8654</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/fourn/class/fournisseur.facture.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>FIX #25853 Thirdparty Massaction (#25868) * FIX #25853 Thirdparty Massaction * FIX #25704 Taxes Deleted from Vendor Invoices * FIX #25704 Taxes Deleted from Vendor Invoices * FIX #25704 Taxes Deleted from Vendor Invoices * Update fournisseur.facture.class.php --------- Co-authored-by: Juanjo Menent &lt;jmenent@2byte.es&gt; Co-authored-by: Laurent Destailleur &lt;eldy@destailleur.fr&gt;</MESSAGE>
      <SHA>5eb5033aba0a477221d00ad34e72c9cdd3e11047</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/fourn/class/fournisseur.facture.class.php</FILE>
        <FILE>htdocs/fourn/facture/card.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
