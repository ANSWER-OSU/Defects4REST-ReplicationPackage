<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>30161</ISSUENO>
  <ISSUEURL>https://github.com/Dolibarr/dolibarr/issues/30161</ISSUEURL>
  <TITLE>Ticket API endpoints are not working - getByRef and getByTrackID</TITLE>
  <DESCRIPTION>### Bug API Endpoints for the ticket module `getByRef` and `getByTrackId` are not working at all. They always returns a specimen ticket even when provided a known ref or track_id. The problem lies in the `api_tickets.class.php` file, in the `getCommon` function and its calls: ```php private function getCommon($id = 0, $track_id = '', $ref = '') { if (!DolibarrApiAccess::$user-&gt;hasRight('ticket', 'read')) { throw new RestException(403); } if (($id &lt; 0) &amp;&amp; !$track_id &amp;&amp; !$ref) { throw new RestException(400, 'Wrong parameters'); } if ($id == 0) { $result = $this-&gt;ticket-&gt;initAsSpecimen(); } else { $result = $this-&gt;ticket-&gt;fetch($id, $ref, $track_id); } if (!$result) { throw new RestException(404, 'Ticket not found'); } ``` ```php public function getByRef($ref) { return $this-&gt;getCommon(0, '', $ref); } public function getByTrackId($track_id) { return $this-&gt;getCommon(0, $track_id, ''); } ``` Since `id` is always 0, the condition `id == 0` is always true in these cases and never try to fetch the ticket with the provided property. The condition should check for the lack of ref and track_id in order to return a specimen ticket. ```diff -if ($id == 0) { +if ($id == 0 &amp;&amp; empty($ref) &amp;&amp; empty($track_id)) { ``` ### Dolibarr Version 19.0.2 ### Environment PHP _No response_ ### Environment Database _No response_ ### Steps to reproduce the behavior and expected behavior 1. With the ticket module and API module enabled 2. Create one or more tickets 3. Open the API Explorer 4. Try the endpoints with - An existing ref - An non existing ref ### Attached files _No response_</DESCRIPTION>
  <REPONAME>dolibarr</REPONAME>
  <TIMEDIFFERENCEDAYS>61</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Update api_subscriptions.class.php with pagination (#30759) * Update api_subscriptions.class.php with pagination * Update api_subscriptions.class.php * Update api_subscriptions.class.php</MESSAGE>
    <SHA>49af57d39a1578b5a5122680f27e827e57b24f09</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #30161 (#30760)</MESSAGE>
      <SHA>7d4800c1f9db1423a61fd5bd5ffdb525393d3937</SHA>
      <PATCHEDFILES>
        <FILE>htdocs/ticket/class/api_tickets.class.php</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
