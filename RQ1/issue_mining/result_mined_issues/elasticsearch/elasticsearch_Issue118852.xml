<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>118852</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/118852</ISSUEURL>
  <TITLE>ESQL lookup join with lookup index results in duplicate set of rows.</TITLE>
  <DESCRIPTION>Performing a lookup join between 2 distinct lookup indices results in duplicated set of rows in result set: ``` ~ ᐅ curl -XPOST &quot;${ES_URL}/_query?format=txt&quot; -H 'Content-Type: application/json' -d'{&quot;query&quot;: &quot;FROM languages&quot;}' code | code.keyword | language |language.keyword ---------------+---------------+---------------+---------------- en |en |English |English es |es |Spanish |Spanish fr |fr |French |French ~ ᐅ curl -XPOST &quot;${ES_URL}/_query?format=txt&quot; -H 'Content-Type: application/json' -d'{&quot;query&quot;: &quot;FROM countries&quot;}' code | code.keyword | countries |countries.keyword ---------------+---------------+---------------+----------------- en |en |England |England es |es |Spain |Spain fr |fr |France |France ~ ᐅ curl -XPOST &quot;${ES_URL}/_query?format=txt&quot; -H 'Content-Type: application/json' -d'{&quot;query&quot;: &quot;FROM countries | LOOKUP JOIN languages ON code&quot;}' code | countries |countries.keyword| code.keyword | language |language.keyword ---------------+---------------+-----------------+---------------+---------------+---------------- en |null |null |en |English |English es |null |null |es |Spanish |Spanish fr |null |null |fr |French |French en |England |England |en |English |English es |Spain |Spain |es |Spanish |Spanish fr |France |France |fr |French |French ```</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>15</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ES|QL: skip to_upper/lower tests before v 8.12.x (#119448) (#119451)</MESSAGE>
    <SHA>c6d4d7a83ac148aad73d8a8d1567b63071ee6a03</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>ESQL: Fix repeated rows in LOOKUP JOIN with a lookup index in the FROM (#119350) Fixes https://github.com/elastic/elasticsearch/issues/118852</MESSAGE>
      <SHA>461d7b258360696489444f413b3c7adbb79047e5</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/esql/qa/server/mixed-cluster/src/javaRestTest/java/org/elasticsearch/xpack/esql/qa/mixed/MixedClusterEsqlSpecIT.java</FILE>
        <FILE>x-pack/plugin/esql/qa/server/multi-clusters/src/javaRestTest/java/org/elasticsearch/xpack/esql/ccq/MultiClusterSpecIT.java</FILE>
        <FILE>x-pack/plugin/esql/qa/server/src/main/java/org/elasticsearch/xpack/esql/qa/rest/RequestIndexFilteringTestCase.java</FILE>
        <FILE>x-pack/plugin/esql/qa/testFixtures/src/main/resources/lookup-join.csv-spec</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/planner/PlannerUtils.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/CsvTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/AnalyzerTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/ParsingTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/VerifierTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/optimizer/LogicalPlanOptimizerTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/optimizer/PhysicalPlanOptimizerTests.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/session/IndexResolverFieldNamesTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
