<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>119112</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/119112</ISSUEURL>
  <TITLE>[CI] EsqlClientYamlAsyncIT test {p0=esql/190_lookup_join/basic} failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-intake #14823 / part3](https://gradle-enterprise.elastic.co/s/ddrddxkn6sroe) - [elasticsearch-intake #14778 / part3](https://gradle-enterprise.elastic.co/s/ioqzsmyta4dio) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:esql:qa:server:single-node:yamlRestTest&quot; --tests &quot;org.elasticsearch.xpack.esql.qa.single_node.EsqlClientYamlAsyncIT.test {p0=esql/190_lookup_join/non-lookup index}&quot; -Dtests.seed=83CEE7668FC7BBA -Dtests.locale=eo-Latn-001 -Dtests.timezone=Europe/Nicosia -Druntime.java=23 ``` **Applicable branches:** 8.x **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.esql.qa.single_node.EsqlClientYamlAsyncIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(test%20%7Bp0%3Desql%2F190_lookup_join%2Fbasic%7D),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: Failure at [esql/190_lookup_join:23]: expected [2xx] status code but api [indices.create] returned [400 Bad Request] [{&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2&quot;,&quot;stack_trace&quot;:&quot;org.elasticsearch.ElasticsearchException$1: index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:706)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.ElasticsearchException.generateFailureXContent(ElasticsearchException.java:634)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.build(RestResponse.java:201)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.&lt;init&gt;(RestResponse.java:160)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.&lt;init&gt;(RestResponse.java:121)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.rest.action.RestActionListener.onFailure(RestActionListener.java:54)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener$3.onFailure(ActionListener.java:410)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.tasks.TaskManager$1.onFailure(TaskManager.java:215)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.DelegatingActionListener.onFailure(DelegatingActionListener.java:32)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations$RunBeforeActionListener.onFailure(ActionListenerImplementations.java:346)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener$3.onFailure(ActionListener.java:410)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.DelegatingActionListener.onFailure(DelegatingActionListener.java:32)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations$RunBeforeActionListener.onFailure(ActionListenerImplementations.java:346)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener$3.onFailure(ActionListener.java:410)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.lambda$doStart$2(TransportMasterNodeAction.java:235)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations$DelegatingResponseActionListener.acceptException(ActionListenerImplementations.java:188)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations$DelegatingResponseActionListener.onFailure(ActionListenerImplementations.java:193)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.DelegatingActionListener.onFailure(DelegatingActionListener.java:32)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.DelegatingActionListener.onFailure(DelegatingActionListener.java:32)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.routing.allocation.allocator.AllocationActionListener.lambda$notifyListenerFailed$1(AllocationActionListener.java:53)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.routing.allocation.allocator.AllocationActionListener.executeInContext(AllocationActionListener.java:59)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.routing.allocation.allocator.AllocationActionListener.notifyListenerFailed(AllocationActionListener.java:53)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.routing.allocation.allocator.AllocationActionListener$1.onFailure(AllocationActionListener.java:85)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.AckedClusterStateUpdateTask.onFailure(AckedClusterStateUpdateTask.java:94)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService$1.onFailure(MetadataCreateIndexService.java:337)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$ExecutionResult.notifyFailure(MasterService.java:1009)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$ExecutionResult.onClusterStateUnchanged(MasterService.java:972)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService.executeAndPublishBatch(MasterService.java:258)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$BatchingTaskQueue$Processor.lambda$run$2(MasterService.java:1691)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener.run(ActionListener.java:452)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$BatchingTaskQueue$Processor.run(MasterService.java:1688)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$5.lambda$doRun$0(MasterService.java:1283)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener.run(ActionListener.java:452)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$5.doRun(MasterService.java:1262)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:1044)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:27)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\n\tat java.base/java.lang.Thread.run(Thread.java:1575)\nCaused by: java.lang.IllegalArgumentException: index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.index.IndexMode$4.validateWithOtherSettings(IndexMode.java:322)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.index.IndexSettings$3.validate(IndexSettings.java:723)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.index.IndexSettings$3.validate(IndexSettings.java:717)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.settings.Setting.get(Setting.java:563)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.settings.Setting.get(Setting.java:535)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.settings.Setting.get(Setting.java:694)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.settings.AbstractScopedSettings.get(AbstractScopedSettings.java:747)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.index.IndexSettings.&lt;init&gt;(IndexSettings.java:969)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.indices.IndicesService.createIndexService(IndicesService.java:739)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.indices.IndicesService.withTempIndexService(IndicesService.java:711)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexWithTemporaryService(MetadataCreateIndexService.java:500)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexRequestWithV1Templates(MetadataCreateIndexService.java:623)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexRequest(MetadataCreateIndexService.java:448)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService$1.execute(MetadataCreateIndexService.java:327)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$UnbatchedExecutor.execute(MasterService.java:574)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService.innerExecuteTasks(MasterService.java:1075)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:1038)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService.executeAndPublishBatch(MasterService.java:245)\n\t... 11 more\n&quot;}],&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2&quot;,&quot;stack_trace&quot;:&quot;java.lang.IllegalArgumentException: index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.index.IndexMode$4.validateWithOtherSettings(IndexMode.java:322)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.index.IndexSettings$3.validate(IndexSettings.java:723)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.index.IndexSettings$3.validate(IndexSettings.java:717)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.settings.Setting.get(Setting.java:563)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.settings.Setting.get(Setting.java:535)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.settings.Setting.get(Setting.java:694)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.settings.AbstractScopedSettings.get(AbstractScopedSettings.java:747)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.index.IndexSettings.&lt;init&gt;(IndexSettings.java:969)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.indices.IndicesService.createIndexService(IndicesService.java:739)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.indices.IndicesService.withTempIndexService(IndicesService.java:711)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexWithTemporaryService(MetadataCreateIndexService.java:500)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexRequestWithV1Templates(MetadataCreateIndexService.java:623)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexRequest(MetadataCreateIndexService.java:448)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.metadata.MetadataCreateIndexService$1.execute(MetadataCreateIndexService.java:327)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$UnbatchedExecutor.execute(MasterService.java:574)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService.innerExecuteTasks(MasterService.java:1075)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:1038)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService.executeAndPublishBatch(MasterService.java:245)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$BatchingTaskQueue$Processor.lambda$run$2(MasterService.java:1691)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener.run(ActionListener.java:452)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$BatchingTaskQueue$Processor.run(MasterService.java:1688)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$5.lambda$doRun$0(MasterService.java:1283)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener.run(ActionListener.java:452)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.cluster.service.MasterService$5.doRun(MasterService.java:1262)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:1044)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:27)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\n\tat java.base/java.lang.Thread.run(Thread.java:1575)\n&quot;},&quot;status&quot;:400}] ``` **Issue Reasons:** - [8.x] 2 failures in test test {p0=esql/190_lookup_join/basic} (1.4% fail rate in 141 executions) - [8.x] 2 failures in step part3 (8.0% fail rate in 25 executions) - [8.x] 2 failures in pipeline elasticsearch-intake (8.0% fail rate in 25 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.xpack.esql.qa.single_node.EsqlClientYamlAsyncIT test {p0=esql/190_lookup_join/non-lookup index} #119111</MESSAGE>
    <SHA>7c50256a68eb54bc1896372d789739699ab191a8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.esql.qa.single_node.EsqlClientYamlAsyncIT test {p0=esql/190_lookup_join/basic} #119112</MESSAGE>
      <SHA>e6253c8ea02bac8362670490ab02be43ad5d06f6</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Unmute 8.x lookup YAML tests (#119122) Problem fixed in https://github.com/elastic/elasticsearch/pull/119069 Fixes https://github.com/elastic/elasticsearch/issues/119035 Fixes https://github.com/elastic/elasticsearch/issues/119036 Fixes https://github.com/elastic/elasticsearch/issues/119111 Fixes https://github.com/elastic/elasticsearch/issues/119112</MESSAGE>
      <SHA>2f865a6e5e0ecfd8936e5cf8b5fbe08b93f4014b</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
