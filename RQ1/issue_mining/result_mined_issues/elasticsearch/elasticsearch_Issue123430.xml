<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>123430</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/123430</ISSUEURL>
  <TITLE>ClassCastException in EsqlFunctionRegistry</TITLE>
  <DESCRIPTION>I encountered a ClassCastException within LinkedHashMap used by ESQL. ``` Caused by: java.lang.ClassCastException: class java.util.LinkedHashMap$Entry cannot be cast to class java.util.HashMap$TreeNode (java.util.LinkedHashMap$Entry and java.util.HashMap$TreeNode are in module java.base of loader 'bootstrap') at java.base/java.util.HashMap$TreeNode.moveRootToFront(HashMap.java:1995) at java.base/java.util.HashMap$TreeNode.treeify(HashMap.java:2111) at java.base/java.util.HashMap.treeifyBin(HashMap.java:779) at java.base/java.util.HashMap.putVal(HashMap.java:651) at java.base/java.util.HashMap.put(HashMap.java:619) at org.elasticsearch.xpack.esql.expression.function.EsqlFunctionRegistry.buildDataTypesForStringLiteralConversion(EsqlFunctionRegistry.java:718) at org.elasticsearch.xpack.esql.expression.function.EsqlFunctionRegistry.&lt;init&gt;(EsqlFunctionRegistry.java:234) ``` See https://gradle-enterprise.elastic.co/s/fwqg4ibahnj4s/console-log/task/:x-pack:plugin:esql:internalClusterTest?page=1 I wonder if this is due to concurrent modification?</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add missing APM agent entitlements (#123575) Add missing APM agent entitlements</MESSAGE>
    <SHA>32826974e49e082f6448cdfb550d89b10c4077d1</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>ESQL: Fix function registry concurrency issues on constructor (#123492) Fixes https://github.com/elastic/elasticsearch/issues/123430 There were 2 problems here: - We were filling a static field (used to auto-cast string literals) within a constructor, which is also called in multiple places - The field was only filled with non-snapshot functions, so snapshot function auto-casting wasn't possible Fixed both bugs by making the field non-static instead, and a fix to use the snapshot registry (if available) in the string casting rule.</MESSAGE>
      <SHA>ca5d2518077024f467027ea22c7798170783531b</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/123492.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/util/Delay.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Fix function registry concurrency issues on constructor (#123492) Fixes https://github.com/elastic/elasticsearch/issues/123430 There were 2 problems here: - We were filling a static field (used to auto-cast string literals) within a constructor, which is also called in multiple places - The field was only filled with non-snapshot functions, so snapshot function auto-casting wasn't possible Fixed both bugs by making the field non-static instead, and a fix to use the snapshot registry (if available) in the string casting rule.</MESSAGE>
      <SHA>59fdcb7771bc8139ed5c50beda338689f22d8733</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/123492.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/util/Delay.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Fix function registry concurrency issues on constructor (#123492) Fixes https://github.com/elastic/elasticsearch/issues/123430 There were 2 problems here: - We were filling a static field (used to auto-cast string literals) within a constructor, which is also called in multiple places - The field was only filled with non-snapshot functions, so snapshot function auto-casting wasn't possible Fixed both bugs by making the field non-static instead, and a fix to use the snapshot registry (if available) in the string casting rule.</MESSAGE>
      <SHA>1ce561e5cfaad485f712b74c07691c7e28a736e7</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/123492.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/util/Delay.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Fix function registry concurrency issues on constructor (#123492) (#123584) Fixes https://github.com/elastic/elasticsearch/issues/123430 There were 2 problems here: - We were filling a static field (used to auto-cast string literals) within a constructor, which is also called in multiple places - The field was only filled with non-snapshot functions, so snapshot function auto-casting wasn't possible Fixed both bugs by making the field non-static instead, and a fix to use the snapshot registry (if available) in the string casting rule.</MESSAGE>
      <SHA>321c3c34041f2722ea6364212f81aee3bcf9d7e7</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/123492.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/util/Delay.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Fix function registry concurrency issues on constructor (#123492) (#123583) Fixes https://github.com/elastic/elasticsearch/issues/123430 There were 2 problems here: - We were filling a static field (used to auto-cast string literals) within a constructor, which is also called in multiple places - The field was only filled with non-snapshot functions, so snapshot function auto-casting wasn't possible Fixed both bugs by making the field non-static instead, and a fix to use the snapshot registry (if available) in the string casting rule.</MESSAGE>
      <SHA>c05841757d033f688ad0f2108602e1542cb86878</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/123492.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/scalar/util/Delay.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
