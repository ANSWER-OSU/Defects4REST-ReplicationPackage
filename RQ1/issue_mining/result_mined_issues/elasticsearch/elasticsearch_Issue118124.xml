<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>118124</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/118124</ISSUEURL>
  <TITLE>[CI] ResolveClusterDataStreamIT testClusterResolveWithDataStreamsUsingAlias failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #5213 / ubuntu-2004-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/ioronk44b63nm) - [elasticsearch-pull-request #44985 / part-1](https://gradle-enterprise.elastic.co/s/4olxa2qomr7h4) - [elasticsearch-pull-request #44920 / part-1](https://gradle-enterprise.elastic.co/s/5rbkzbrcycbce) **Reproduction Line:** ``` ./gradlew &quot;:modules:data-streams:internalClusterTest&quot; --tests &quot;org.elasticsearch.datastreams.ResolveClusterDataStreamIT.testClusterResolveWithDataStreamsUsingAlias&quot; -Dtests.seed=762151479ED679B5 -Dtests.locale=fr-RE -Dtests.timezone=Antarctica/DumontDUrville -Druntime.java=23 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.datastreams.ResolveClusterDataStreamIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testClusterResolveWithDataStreamsUsingAlias),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: java.util.concurrent.ExecutionException: java.lang.RuntimeException: java.lang.NullPointerException: Cannot read field &quot;enabled&quot; because the return value of &quot;java.util.HashMap.get(Object)&quot; is null ``` **Issue Reasons:** - [main] 3 failures in test testClusterResolveWithDataStreamsUsingAlias (1.8% fail rate in 165 executions) - [main] 2 failures in step part-1 (3.0% fail rate in 67 executions) - [main] 2 failures in pipeline elasticsearch-pull-request (2.7% fail rate in 73 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add link to Tasks experimental issue (#118117)</MESSAGE>
    <SHA>e67856895b5a11837ec6c759364177ea23b9000e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.datastreams.ResolveClusterDataStreamIT testClusterResolveWithDataStreamsUsingAlias #118124</MESSAGE>
      <SHA>dc443524e4397d1514d73f13b676d090d40065be</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[TEST] Work around race condition when starting clusters in parallel With #117820 we are starting clusters in parallel in CCS related tests. There is a race condition when calling RandomizedTest#isNightly, which is called as part of `InternalTestCluster#beforeTest`. See https://github.com/randomizedtesting/randomizedtesting/issues/311. Until this is fixed upstream, we can simply call isNightly before forking, which is going to trigger the lazy initialization of the inner map that causes the race. From then on, all threads will have a consistent view of it. Closes #118124</MESSAGE>
      <SHA>b8a83e12c769f526894d9d000331957705412f68</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
        <FILE>test/framework/src/main/java/org/elasticsearch/test/AbstractMultiClustersTestCase.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[TEST] Work around race condition when starting clusters in parallel (#118145) With #117820 we are starting clusters in parallel in CCS related tests. There is a race condition when calling RandomizedTest#isNightly, which is called as part of `InternalTestCluster#beforeTest`. See https://github.com/randomizedtesting/randomizedtesting/issues/311. Until this is fixed upstream, we can simply call isNightly before forking, which is going to trigger the lazy initialization of the inner map that causes the race. From then on, all threads will have a consistent view of it. Closes #118124</MESSAGE>
      <SHA>2619149bc677fec18376fb36c5a54aa3d260431d</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
        <FILE>test/framework/src/main/java/org/elasticsearch/test/AbstractMultiClustersTestCase.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
