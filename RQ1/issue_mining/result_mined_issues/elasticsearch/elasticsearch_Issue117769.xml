<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>117769</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/117769</ISSUEURL>
  <TITLE>Elasticsearch CA certificates are rejected by Python 3.13</TITLE>
  <DESCRIPTION>### Elasticsearch Version 8.16.1 ### Installed Plugins _No response_ ### Java Version _bundled_ ### OS Version Darwin arm64 ### Problem Description Python 3.13 (released in October 2024) [enabled by default the VERIFY_X509_STRICT](https://github.com/python/cpython/issues/107361) flag for improved RFC 5280 compliance. This setting maps to the [X509_V_FLAG_X509_STRICT OpenSSL flag](https://docs.openssl.org/1.1.1/man3/X509_VERIFY_PARAM_set_flags/#verification-flags) documented as: &gt; The `X509_V_FLAG_X509_STRICT` flag disables workarounds for some broken certificates and makes the verification strictly apply `X509` rules. The CA certificates generated by Elasticsearch (either by default on startup) or by elasticsearch-certutil are not compliant, at least because they're missing the key usage extension. ### Steps to Reproduce Run Elasticsearch: ``` $ docker run --name es01 -p 9200:9200 -it -m 1GB docker.elastic.co/elasticsearch/elasticsearch:8.16.1 ... wait for startup $ docker container cp es01:/usr/share/elasticsearch/config/certs/http_ca.crt . ``` Try connecting to it using the Elasticsearch Python client: ```python from elasticsearch import Elasticsearch client = Elasticsearch( &quot;https://localhost:9200&quot;, ca_certs=&quot;http_ca.crt&quot;, basic_auth=(&quot;elastic&quot;, &quot;...&quot;) ) print(client.info()) ``` This fails with: ```python ssl.SSLCertVerificationError: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: CA cert does not include key usage extension (_ssl.c:1020) ``` Alternatively, you can inspect the `http_ca.crt` file: ```bash $ openssl x509 -in http_ca.crt -text -noout Certificate: Data: Version: 3 (0x2) Serial Number: a4:50:12:ea:89:c9:78:fe:9e:9a:4b:7c:64:18:e0:13:04:d6:fb:58 Signature Algorithm: sha256WithRSAEncryption Issuer: CN=Elasticsearch security auto-configuration HTTP CA Validity Not Before: Nov 29 14:07:47 2024 GMT Not After : Nov 29 14:07:47 2027 GMT Subject: CN=Elasticsearch security auto-configuration HTTP CA Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (4096 bit) Modulus: [...]] Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: F4:BC:A2:F5:ED:8B:FD:93:F2:AE:76:82:A2:58:9E:EE:58:82:B9:BC X509v3 Authority Key Identifier: F4:BC:A2:F5:ED:8B:FD:93:F2:AE:76:82:A2:58:9E:EE:58:82:B9:BC X509v3 Basic Constraints: critical CA:TRUE Signature Algorithm: sha256WithRSAEncryption Signature Value: [...] ``` In `X509v3 extensions`, you can see that the `Key Usage` extension is missing. If by contrast, I'm looking at the test CA certificate generated by [trustme](https://trustme.readthedocs.io/en/latest/) and used in the Python client: ``` $ openssl x509 -in .buildkite/certs/ca.crt -text -noout Certificate: Data: Version: 3 (0x2) Serial Number: 21:80:a5:61:65:e2:4e:c0:7c:68:ca:c4:10:ca:f3:76:b9:39:ac:eb Signature Algorithm: ecdsa-with-SHA256 Issuer: O=trustme v1.2.0, OU=Testing CA #biw1Wc10lpqCFQL5 Validity Not Before: Jan 1 00:00:00 2000 GMT Not After : Jan 1 00:00:00 3000 GMT Subject: O=trustme v1.2.0, OU=Testing CA #biw1Wc10lpqCFQL5 Subject Public Key Info: Public Key Algorithm: id-ecPublicKey Public-Key: (256 bit) pub: [...] ASN1 OID: prime256v1 NIST CURVE: P-256 X509v3 extensions: X509v3 Subject Key Identifier: 2A:C6:19:C3:BD:BF:45:00:59:2B:03:F7:73:FF:C7:63:13:36:22:5B X509v3 Basic Constraints: critical CA:TRUE, pathlen:9 X509v3 Key Usage: critical Digital Signature, Certificate Sign, CRL Sign Signature Algorithm: ecdsa-with-SHA256 Signature Value: [...] ``` You can see that `Key Usage` is included, and indeed connections to Python 3.13 work. ### Logs (if relevant) _No response_</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>129</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Throw nicer exception in SpanBooleanQueryRewriteWithMaxClause (#126387) Throw an ElasticsearchStatusException with a RestStatus.BAD_REQUEST code instead of a generic RuntimeException.</MESSAGE>
    <SHA>47e352fda0567a682687fe926927cee3f631ea24</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Set `keyUsage` for generated HTTP certificates and self-signed CA (#126376) The `elasticsearch-certutil http` command, and security auto-configuration, generate the HTTP certificate and CA without setting the `keyUsage` extension. This PR fixes this by setting (by default): - `keyCertSign` and `cRLSign` for self-signed CAs - `digitalSignature` and `keyEncipherment` for HTTP certificates and CSRs These defaults can be overridden when running `elasticsearch-certutil http` command. The user will be prompted to change them as they wish. For `elasticsearch-certutil ca`, the default value can be overridden by passing the `--keysage` option, e.g. ``` elasticsearch-certutil ca --keyusage &quot;digitalSignature,keyCertSign,cRLSign&quot; -pem ``` Fixes #117769</MESSAGE>
      <SHA>284121ad9f9175059c06d5cd857d6f3b34a2f56e</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/126376.yaml</FILE>
        <FILE>docs/reference/elasticsearch/command-line-tools/certutil.md</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/AutoConfigureNode.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertGenUtils.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateGenerateTool.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommand.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/AutoConfigureNodeTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertGenUtilsTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertificateGenerateToolTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertificateToolTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommandTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Set `keyUsage` for generated HTTP certificates and self-signed CA (#126376) The `elasticsearch-certutil http` command, and security auto-configuration, generate the HTTP certificate and CA without setting the `keyUsage` extension. This PR fixes this by setting (by default): - `keyCertSign` and `cRLSign` for self-signed CAs - `digitalSignature` and `keyEncipherment` for HTTP certificates and CSRs These defaults can be overridden when running `elasticsearch-certutil http` command. The user will be prompted to change them as they wish. For `elasticsearch-certutil ca`, the default value can be overridden by passing the `--keysage` option, e.g. ``` elasticsearch-certutil ca --keyusage &quot;digitalSignature,keyCertSign,cRLSign&quot; -pem ``` Fixes #117769</MESSAGE>
      <SHA>86467fa3a157edc767c4ce8cda44fd4caaae92c9</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/126376.yaml</FILE>
        <FILE>docs/reference/elasticsearch/command-line-tools/certutil.md</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/AutoConfigureNode.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertGenUtils.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateGenerateTool.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommand.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/AutoConfigureNodeTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertGenUtilsTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertificateGenerateToolTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertificateToolTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommandTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Set `keyUsage` for generated HTTP certificates and self-signed CA (#126376) The `elasticsearch-certutil http` command, and security auto-configuration, generate the HTTP certificate and CA without setting the `keyUsage` extension. This PR fixes this by setting (by default): - `keyCertSign` and `cRLSign` for self-signed CAs - `digitalSignature` and `keyEncipherment` for HTTP certificates and CSRs These defaults can be overridden when running `elasticsearch-certutil http` command. The user will be prompted to change them as they wish. For `elasticsearch-certutil ca`, the default value can be overridden by passing the `--keysage` option, e.g. ``` elasticsearch-certutil ca --keyusage &quot;digitalSignature,keyCertSign,cRLSign&quot; -pem ``` Fixes #117769 (cherry picked from commit 284121ad9f9175059c06d5cd857d6f3b34a2f56e) # Conflicts: # docs/reference/elasticsearch/command-line-tools/certutil.md</MESSAGE>
      <SHA>12c39e514049ca5a1dfa405e4724ff4717eaa92f</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/126376.yaml</FILE>
        <FILE>docs/reference/commands/certutil.asciidoc</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/AutoConfigureNode.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertGenUtils.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateGenerateTool.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommand.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/AutoConfigureNodeTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertGenUtilsTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertificateGenerateToolTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertificateToolTests.java</FILE>
        <FILE>x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommandTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
