<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>119747</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/119747</ISSUEURL>
  <TITLE>Refreshing S3 web identity token fails due to missing socket permission</TITLE>
  <DESCRIPTION>In https://github.com/elastic/elasticsearch/pull/104135, we added support for refreshing web identity credentials when the relevant file on disk is changed. However, the refresh call is not issued with sufficient permissions and it leads to the refresh call failing with: ``` [2024-11-23T04:27:32,004][WARN ][o.e.w.FileWatcher ] [...] cannot notify file changes listener com.amazonaws.AmazonClientException: java.security.AccessControlException: access denied (&quot;java.net.SocketPermission&quot; &quot;1.2.3.4:443&quot; &quot;connect,resolve&quot;) at com.amazonaws.auth.RefreshableTask.refreshValue(RefreshableTask.java:303) at com.amazonaws.auth.RefreshableTask.forceGetValue(RefreshableTask.java:208) at com.amazonaws.auth.STSAssumeRoleWithWebIdentitySessionCredentialsProvider.refresh(STSAssumeRoleWithWebIdentitySessionCredentialsProvider.java:135) at org.elasticsearch.repositories.s3.S3Service$CustomWebIdentityTokenCredentialsProvider$1.onFileChanged(S3Service.java:419) at org.elasticsearch.server@8.15.2/org.elasticsearch.watcher.FileWatcher$FileObserver.onFileChanged(FileWatcher.java:367) at org.elasticsearch.server@8.15.2/org.elasticsearch.watcher.FileWatcher$FileObserver.checkAndNotify(FileWatcher.java:196) at org.elasticsearch.server@8.15.2/org.elasticsearch.watcher.FileWatcher.doCheckAndNotify(FileWatcher.java:79) ``` The current workaround is to restart the affected nodes. The refresh support was added in 8.13.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Hash functions (#118938) (#119769) This change adds md5, sha1 and sha256 hash functions.</MESSAGE>
    <SHA>b398448848b12b842086bdf6c2dd988566f4ca0c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Issue S3 web identity token refresh call with sufficient permissions (#119748) Closes #119747</MESSAGE>
      <SHA>3b9fcef8b20fdea30e4d9d3da99b1ba48f5e95bc</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119748.yaml</FILE>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Issue S3 web identity token refresh call with sufficient permissions (#119748) Closes #119747</MESSAGE>
      <SHA>d18e3293ebbb00ebdb111c6d1228e2d904f967b8</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119748.yaml</FILE>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Issue S3 web identity token refresh call with sufficient permissions (#119748) (#119840) Closes #119747 Co-authored-by: Felix Barnsteiner &lt;felixbarny@users.noreply.github.com&gt;</MESSAGE>
      <SHA>61e16d4b2781bcaa7f375a50c95d7d5149083879</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119748.yaml</FILE>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Issue S3 web identity token refresh call with sufficient permissions (#119748) Closes #119747</MESSAGE>
      <SHA>75d85cffb1a648cd0f1c06a17f9d1dd3c4e069cd</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119748.yaml</FILE>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Issue S3 web identity token refresh call with sufficient permissions (#119748) Closes #119747</MESSAGE>
      <SHA>01e820cee3a52c465b924f4133f7446449280ad3</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119748.yaml</FILE>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Issue S3 web identity token refresh call with sufficient permissions (#119748) (#119929) Closes #119747</MESSAGE>
      <SHA>eb6c6fdb609e59828ad3055b37b63e8d86c27783</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119748.yaml</FILE>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Issue S3 web identity token refresh call with sufficient permissions (#119748) (#119931) Closes #119747</MESSAGE>
      <SHA>978eb1c950039b4a0882780c8f602de204744b91</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119748.yaml</FILE>
        <FILE>modules/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
