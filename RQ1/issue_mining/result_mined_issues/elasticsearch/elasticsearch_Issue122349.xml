<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>122349</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/122349</ISSUEURL>
  <TITLE>[CI] Netty4WriteThrottlingHandlerTests testThrottleLargeCompositeMessage failing</TITLE>
  <DESCRIPTION>### CI Link https://gradle-enterprise.elastic.co/s/jsxipcu4fdofg/tests/task/:modules:transport-netty4:test/details/org.elasticsearch.transport.netty4.Netty4WriteThrottlingHandlerTests/testThrottleLargeCompositeMessage?top-execution=1 ### Repro line ./gradlew &quot;:modules:transport-netty4:test&quot; --tests &quot;org.elasticsearch.transport.netty4.Netty4WriteThrottlingHandlerTests.testThrottleLargeCompositeMessage&quot; -Dtests.seed=4F09C67841D50E8C -Dtests.locale=zh-HK -Dtests.timezone=Portugal -Druntime.java=23 ### Does it reproduce? Yes ### Applicable branches main ### Failure history _No response_ ### Failure excerpt ```REPRODUCE WITH: ./gradlew &quot;:modules:transport-netty4:test&quot; --tests &quot;org.elasticsearch.transport.netty4.Netty4WriteThrottlingHandlerTests.testThrottleLargeCompositeMessage&quot; -Dtests.seed=4F09C67841D50E8C -Dtests.locale=zh-HK -Dtests.timezone=Portugal -Druntime.java=23 Netty4WriteThrottlingHandlerTests &gt; testThrottleLargeCompositeMessage FAILED java.lang.AssertionError: Expected: a collection with size one of {&lt;9&gt;, &lt;10&gt;} but: collection size was &lt;11&gt; at __randomizedtesting.SeedInfo.seed([4F09C67841D50E8C:51F6A42ACBCF3D34]:0) at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18) at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:6) at org.elasticsearch.test.ESTestCase.assertThat(ESTestCase.java:2625) at org.elasticsearch.transport.netty4.Netty4WriteThrottlingHandlerTests.testThrottleLargeCompositeMessage(Netty4WriteThrottlingHandlerTests.java:123)```</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.entitlement.qa.EntitlementsDeniedNonModularIT org.elasticsearch.entitlement.qa.EntitlementsDeniedNonModularIT #122569</MESSAGE>
    <SHA>1bcb68d03f0d3d8cf24365bb705a44d4febafd1b</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>[Test] Fix assertion for number of message chunks Depending on the position of the split and the size of the extra chunk, the test may send out one more chunk than the assertion expects. This PR ensures the assertoin is more accurate to count for this scenario. Resolves: #122349</MESSAGE>
      <SHA>ebb8a4075e953bf508c46b4fd0a2faffc44a7f0e</SHA>
      <PATCHEDFILES>
        <FILE>modules/transport-netty4/src/test/java/org/elasticsearch/transport/netty4/Netty4WriteThrottlingHandlerTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[Test] Fix assertion for number of message chunks (#122571) Depending on the position of the split and the size of the extra chunk, the test may send out one more chunk than the assertion expects. This PR ensures the assertoin is more accurate to count for this scenario. Resolves: #122349</MESSAGE>
      <SHA>65643730318aa9763a8092b3051df424a9973ed5</SHA>
      <PATCHEDFILES>
        <FILE>modules/transport-netty4/src/test/java/org/elasticsearch/transport/netty4/Netty4WriteThrottlingHandlerTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[Test] Fix assertion for number of message chunks (#122571) Depending on the position of the split and the size of the extra chunk, the test may send out one more chunk than the assertion expects. This PR ensures the assertoin is more accurate to count for this scenario. Resolves: #122349</MESSAGE>
      <SHA>8a9ae471b30e479a541713ccef63d567187029a7</SHA>
      <PATCHEDFILES>
        <FILE>modules/transport-netty4/src/test/java/org/elasticsearch/transport/netty4/Netty4WriteThrottlingHandlerTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[Test] Fix assertion for number of message chunks (#122571) (#122717) Depending on the position of the split and the size of the extra chunk, the test may send out one more chunk than the assertion expects. This PR ensures the assertoin is more accurate to count for this scenario. Resolves: #122349</MESSAGE>
      <SHA>0cf22ae956f1ba5ce2daeef8aef9ac64e35a9fd3</SHA>
      <PATCHEDFILES>
        <FILE>modules/transport-netty4/src/test/java/org/elasticsearch/transport/netty4/Netty4WriteThrottlingHandlerTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
