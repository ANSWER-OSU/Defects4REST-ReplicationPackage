<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>117405</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/117405</ISSUEURL>
  <TITLE>ESQL: Improve license checks</TITLE>
  <DESCRIPTION>In some cases, certain functionality (functions, commands, etc..) requires certain licensing before submitting the query. Currently this is implemented through Function#checkLicense which unfortunately restricts this checks to functions only. This can be improved by adding a specialized interface that relevant Functions, command, etc.. can implement when needed: ``` public interface LicenseAware { boolean licenseCheck(XPackLicenseState state) {} } ``` Furthermore the relevant check can be early, right after parsing to avoid unnecessary index calls.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>26</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.smoketest.SmokeTestMultiNodeClientYamlTestSuiteIT org.elasticsearch.smoketest.SmokeTestMultiNodeClientYamlTestSuiteIT #118955</MESSAGE>
    <SHA>461ea39dc7cd444af60b71a7d34a058e1b6d3957</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>ESQL: Add a LicenseAware interface for licensed Nodes (#118931) This adds a new interface that elements that require a proper license state can implement to enforce the license requirement. This can be now applied to any node or node property. The check still happens in the Verifier, since the plan needs to be analysed first and the check still only happens if no other verification faults exist already. Fixes #117405</MESSAGE>
      <SHA>0463c36bef20dca6c8b707cf13c14296513ea452</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/118931.yaml</FILE>
        <FILE>x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/function/Function.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/LicenseAware.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Verifier.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/SpatialAggregateFunction.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/CheckLicenseTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Add a LicenseAware interface for licensed Nodes (#118931) This adds a new interface that elements that require a proper license state can implement to enforce the license requirement. This can be now applied to any node or node property. The check still happens in the Verifier, since the plan needs to be analysed first and the check still only happens if no other verification faults exist already. Fixes #117405</MESSAGE>
      <SHA>5f293f34f77a8621752f4817609d14aaf916ccb5</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/118931.yaml</FILE>
        <FILE>x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/function/Function.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/LicenseAware.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Verifier.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/SpatialAggregateFunction.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/CheckLicenseTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Add a LicenseAware interface for licensed Nodes (#118931) (#119099) This adds a new interface that elements that require a proper license state can implement to enforce the license requirement. This can be now applied to any node or node property. The check still happens in the Verifier, since the plan needs to be analysed first and the check still only happens if no other verification faults exist already. Fixes #117405</MESSAGE>
      <SHA>afb72ceb50d3c2f1c2ce1a2f1affae04368d08ed</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/118931.yaml</FILE>
        <FILE>x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/function/Function.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/LicenseAware.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Verifier.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/SpatialAggregateFunction.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/CheckLicenseTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Add a LicenseAware interface for licensed Nodes (#118931) This adds a new interface that elements that require a proper license state can implement to enforce the license requirement. This can be now applied to any node or node property. The check still happens in the Verifier, since the plan needs to be analysed first and the check still only happens if no other verification faults exist already. Fixes #117405</MESSAGE>
      <SHA>255a725fb01914f3e1306bb698fdef9c9db9baab</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/118931.yaml</FILE>
        <FILE>x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/function/Function.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/LicenseAware.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Verifier.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/SpatialAggregateFunction.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/CheckLicenseTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
