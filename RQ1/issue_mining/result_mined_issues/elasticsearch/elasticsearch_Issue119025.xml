<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>119025</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/119025</ISSUEURL>
  <TITLE>Server error while parsing ESQL query</TITLE>
  <DESCRIPTION>### Elasticsearch Version 9.0 ### Installed Plugins _No response_ ### Java Version _bundled_ ### OS Version all ### Problem Description The following error was observed. Unfortunately the query that leads to this is not known (the author was experimenting and does not remember what it was), it is possible that it is an invalid query. In that case this error should not be a server error but a client error. ``` java.util.EmptyStackException at org.antlr.v4.runtime.Lexer.popMode(Lexer.java:192) at org.antlr.v4.runtime.atn.LexerPopModeAction.execute(LexerPopModeAction.java:58) at org.antlr.v4.runtime.atn.LexerActionExecutor.execute(LexerActionExecutor.java:168) at org.antlr.v4.runtime.atn.LexerATNSimulator.accept(LexerATNSimulator.java:366) at org.antlr.v4.runtime.atn.LexerATNSimulator.failOrAccept(LexerATNSimulator.java:299) at org.antlr.v4.runtime.atn.LexerATNSimulator.execATN(LexerATNSimulator.java:230) at org.antlr.v4.runtime.atn.LexerATNSimulator.match(LexerATNSimulator.java:114) at org.antlr.v4.runtime.Lexer.nextToken(Lexer.java:141) at org.elasticsearch.xpack.esql.parser.EsqlParser$ParametrizedTokenSource.nextToken(EsqlParser.java:169) at org.antlr.v4.runtime.BufferedTokenStream.fetch(BufferedTokenStream.java:169) at org.antlr.v4.runtime.BufferedTokenStream.sync(BufferedTokenStream.java:152) at org.antlr.v4.runtime.BufferedTokenStream.consume(BufferedTokenStream.java:136) at org.antlr.v4.runtime.atn.ParserATNSimulator.execATN(ParserATNSimulator.java:515) at org.antlr.v4.runtime.atn.ParserATNSimulator.adaptivePredict(ParserATNSimulator.java:371) at org.elasticsearch.xpack.esql.parser.EsqlBaseParser.booleanExpression(EsqlBaseParser.java:912) at org.elasticsearch.xpack.esql.parser.EsqlBaseParser.whereCommand(EsqlBaseParser.java:695) at org.elasticsearch.xpack.esql.parser.EsqlBaseParser.processingCommand(EsqlBaseParser.java:547) at org.elasticsearch.xpack.esql.parser.EsqlBaseParser.query(EsqlBaseParser.java:347) at org.elasticsearch.xpack.esql.parser.EsqlBaseParser.singleStatement(EsqlBaseParser.java:230) at org.elasticsearch.xpack.esql.parser.EsqlParser.invokeParser(EsqlParser.java:100) at org.elasticsearch.xpack.esql.parser.EsqlParser.createStatement(EsqlParser.java:63) at org.elasticsearch.xpack.esql.session.EsqlSession.parse(EsqlSession.java:269) at org.elasticsearch.xpack.esql.session.EsqlSession.execute(EsqlSession.java:154) at org.elasticsearch.xpack.esql.execution.PlanExecutor.esql(PlanExecutor.java:80) at org.elasticsearch.xpack.esql.plugin.TransportEsqlQueryAction.innerExecute(TransportEsqlQueryAction.java:186) at org.elasticsearch.xpack.esql.plugin.TransportEsqlQueryAction.lambda$execute$1(TransportEsqlQueryAction.java:156) at org.elasticsearch.server@9.0.0/org.elasticsearch.action.ActionListener.run(ActionListener.java:452) at org.elasticsearch.xpack.esql.plugin.TransportEsqlQueryAction.execute(TransportEsqlQueryAction.java:156) at org.elasticsearch.xpack.esql.plugin.TransportEsqlQueryAction.execute(TransportEsqlQueryAction.java:56) at org.elasticsearch.xpack.esql.core.async.AsyncTaskManagementService.asyncExecute(AsyncTaskManagementService.java:188) at org.elasticsearch.xpack.esql.plugin.TransportEsqlQueryAction.doExecuteForked(TransportEsqlQueryAction.java:140) at org.elasticsearch.xpack.esql.plugin.TransportEsqlQueryAction.lambda$doExecute$0(TransportEsqlQueryAction.java:132) at org.elasticsearch.server@9.0.0/org.elasticsearch.action.ActionRunnable$4.doRun(ActionRunnable.java:101) at org.elasticsearch.server@9.0.0/org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:27) at org.elasticsearch.server@9.0.0/org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:34) at org.elasticsearch.server@9.0.0/org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:1023) at org.elasticsearch.server@9.0.0/org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:27) at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144) at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642) at java.base/java.lang.Thread.run(Thread.java:1575) ``` ### Steps to Reproduce N/A ### Logs (if relevant) _No response_</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>87</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.lucene.spatial.CartesianCentroidCalculatorTests testAddDifferentDimensionalType #124609</MESSAGE>
    <SHA>49f7cfb22f15ea59e19e97606eda80dfc2a1e65c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>ESQL: Catch parsing exception When an invalid popMode occurs (due to an invalid query), ANTLR throws an out-of-channel exception, bypassing the existing checks. This PR extends the checks and properly reports the error back to the user Fix #119025</MESSAGE>
      <SHA>fb7e40a7a89c0e1a21f6f0f66a2f718ee155b5cf</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/parser/EsqlParser.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/parser/StatementParserTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Catch parsing exception When an invalid popMode occurs (due to an invalid query), ANTLR throws an out-of-channel exception, bypassing the existing checks. This PR extends the checks and properly reports the error back to the user Fix #119025</MESSAGE>
      <SHA>a07a5146c79a078d2750bd1de015f17bd3cdbb16</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/parser/EsqlParser.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/parser/StatementParserTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Catch parsing exception (#124958) When an invalid popMode occurs (due to an invalid query), ANTLR throws an out-of-channel exception, bypassing the existing checks. This PR extends the checks and properly reports the error back to the user Fix #119025</MESSAGE>
      <SHA>dc15462ca4f97cf622a284afa8ac0e797f02f8f1</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/124958.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/parser/EsqlParser.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/parser/StatementParserTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
