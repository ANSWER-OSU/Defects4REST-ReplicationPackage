<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>125445</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/125445</ISSUEURL>
  <TITLE>Deprecation logger rejects new entries after upgrade to 9.0 unless deprecation log data stream is rolled over</TITLE>
  <DESCRIPTION>### Elasticsearch Version 9.0 ### Problem Description In #117933, we changed the name of the dataset for the deprecation log data stream from `deprecation.elasticsearch` to `elasticsearch.deprecation`. If you had data in that data stream in 8.x or earlier, then when you upgrade to 9.0, if the deprecation logger is called the deprecations will be rejected. You will see entries like this in your (non-deprecation) logs: ``` Caused by: java.lang.IllegalArgumentException: [constant_keyword] field [data_stream.dataset] only accepts values that are equal to the value defined in the mappings [deprecation.elasticsearch], but got [elasticsearch.deprecation] ``` ``` [instance-0000000005] Bulk write of deprecation logs encountered some failures: [[4VK3j5UBamJ0EqvgUJmJ org.elasticsearch.index.mapper.DocumentParsingException: [1:87] failed to parse field [data_stream.dataset] of type [constant_keyword] in document with id '4VK3j5UBamJ0EqvgUJmJ'. Preview of field's value: 'elasticsearch.deprecation']] ``` The problem continues until you roll over the deprecation log data stream (`.logs-deprecation.default`). We discussed a couple of options to fix this: 1. A one-off service that gets started with a node from the deprecation xpack module. It would wait in a new feature in the cluster, and once that feature is available (so once all nodes are 9.0+), force a rollover of the `.logs-deprecation.default` datastream. Then the service would shut itself down. 2. Change the mapping of the [`dataset` field](https://github.com/elastic/elasticsearch/blob/main/x-pack/plugin/core/template-resources/src/main/resources/deprecation/deprecation-indexing-mappings.json#L27) to be a `keyword` rather than a `constant_keyword`, since that field is no longer a constant in this data stream (it is a constant in any backing index, but across the data stream it can now have two different values). ### Steps to Reproduce Start a cluster in 8.x. Do something that causes a deprecation message to be logged. Upgrade to 9.0. Do something that causes a deprecation message to be logged.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>ESQL - date nanos range bug? (#125345) Fixes #125439 We were incorrectly formatting nanosecond dates when building lucene queries. We had missed this in our testing because none of the CSV tests were running against Lucene. This happened because the date nanos test data includes multivalue fields. Our warning behavior for multivalue fields is inconsistent between queries run in Lucene and queries run in pure ES|QL without pushdown. Our warning tests, however, require that the specified warnings be present in all execution paths. When we first built the date nanos CSV tests, we worked around this by always using an MV function to unpack the multivalue fields. But we forgot that using an MV function prevents the entire query from being pushed down to Lucene, and thus that path wasn't being tested. In this PR, I've duplicated many of the tests to have a version that doesn't use the MV function, and uses warningRegex instead of warning. The regex version does not fail if the header is absent, so it's safe to use in both modes. Rewriting the tests this way revealed several situations in which this bug can manifest, all of which are fixed in this PR. I cannot be confidant that there aren't more paths that can trigger this bug and aren't covered by these tests, but I haven't found any yet. I've left some trace level logging that I found helpful while debugging this. --------- Co-authored-by: elasticsearchmachine &lt;infra-root+elasticsearchmachine@elastic.co&gt;</MESSAGE>
    <SHA>30a56d6e2cff00591a0812a7138f732b56215e84</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Rename deprecation index template The dataset name for the deprecation logs index was previously renamed from `deprecation.elasticsearch` to `elasticsearch.deprecation` in order to follow the pattern of `product.group`. The deprecation index template, however, was not updated. This causes indexing errors once upgraded to 9.0 due to the dataset name having changed on a constant_keyword field. In order to avoid that mismatch, this commit renames the deprecation indexing datastream to match the dataset name. The old template is kept in place, but marked as deprecated, so that any deprecation logs written during upgrading to 9.x will continue to be indexed into the old datastream. closes #125445</MESSAGE>
      <SHA>d3d9714ec667c63cb23e6628ad135109926dda43</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/core/template-resources/src/main/resources/deprecation/deprecation-indexing-template.json</FILE>
        <FILE>x-pack/plugin/deprecation/qa/common/src/main/java/org/elasticsearch/xpack/deprecation/DeprecationTestUtils.java</FILE>
        <FILE>x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingAppender.java</FILE>
        <FILE>x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingComponent.java</FILE>
        <FILE>x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingTemplateRegistry.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
