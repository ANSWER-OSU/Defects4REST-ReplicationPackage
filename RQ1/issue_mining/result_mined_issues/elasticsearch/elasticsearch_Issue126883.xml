<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>126883</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/126883</ISSUEURL>
  <TITLE>CollectionUtils.uniquify is incorrect in some cases</TITLE>
  <DESCRIPTION>### Elasticsearch Version main ### Installed Plugins _No response_ ### Java Version _bundled_ ### OS Version -- ### Problem Description `CollectionUtils.uniquify(new ArrayList&lt;&gt;(List.of(1, 20, 20, 30, 30, 50)), Comparator.naturalOrder())` produces `[1, 20, 30, 30, 50]` but should produce `[1, 20, 30, 50]`. ### Steps to Reproduce This test when added to `CollectionUtilsTests` fails. ``` public void testUniquifyTwoRuns() { assertUniquify(List.of(1, 20, 20, 30, 30, 50), Comparator.naturalOrder(), 4); } ``` ### Logs (if relevant) _No response_</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.xpack.test.rest.XPackRestIT test {p0=ml/inference_crud/Test delete given unused trained model} #126881</MESSAGE>
    <SHA>85cb5f9a23ffed97c8f2165bf2fded6ebd6a8b09</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Rework uniquify to not use iterators CollectionUtils.uniquify is based on C++ std::unique. However, C++ iterators are not quite the same as Java iterators. In particular, advancing them only allows grabbing the value once. This commit reworks uniquify to be based on list indices instead of iterators. closes #126883</MESSAGE>
      <SHA>7ef595c7b9391d198c67ea8ed82214bbd1ba4508</SHA>
      <PATCHEDFILES>
        <FILE>server/src/main/java/org/elasticsearch/common/util/CollectionUtils.java</FILE>
        <FILE>server/src/test/java/org/elasticsearch/common/util/CollectionUtilsTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
