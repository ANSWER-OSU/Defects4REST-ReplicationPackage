<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>121553</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/121553</ISSUEURL>
  <TITLE>[Ingest Node] Add `type` with default `data_stream.type` to reroute processor</TITLE>
  <DESCRIPTION>### Description ### What? The `reroute` ingest pipeline processor has options for only 2 of the 3 Elastic Agent data stream naming convention pieces, which are `dataset` and `namespace`. We need to add the third one, `type` that populates the `data_stream.type`. Related documentation - https://www.elastic.co/guide/en/elasticsearch/reference/current/reroute-processor.html - https://www.elastic.co/guide/en/fleet/8.17/data-streams.html#data-streams-naming-scheme - https://www.elastic.co/guide/en/ecs/current/ecs-data_stream.html A new ingest pipeline option may be like this | Name | Required | Default | Description | |---------|--------------|---------|-------------| | type | no | {{data_stream.type}} | Field references or a static value for the type part of the data stream name. In addition to the criteria for [index names](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html#indices-create-api-path-params), cannot contain - and ..... Valid values are `logs`, `metrics`, .... | Current workarounds include using the `destination` option. Another option is to set the topic dynamically using [Fleet topic settings](https://www.elastic.co/guide/en/fleet/8.16/kafka-output-settings.html#_topics_settings), which is documented in [Deploying Elastic Agent with Confluent Cloud's Elasticsearch Connector](https://www.elastic.co/observability-labs/blog/deploying-elastic-agent-with-confluent-clouds-elasticsearch-connector) as well. ### Why? In an ingest architecture that is ``` Elastic Agent -&gt; Kafka -&gt; Kafka Elasticsearch sink -&gt; Elasticsearch ``` The easiest configuration option is to send both the Logs and Metrics to a single Kafka topic as there is only one output defined at the Agent policy and Integration policy level. Therefore, it would be helpful if the `reroute` processor could be used to update the index name and subsequently use the new index's default ingest pipeline to properly handle the data source.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>15</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix handling of auto expand replicas for stateless indices (#122365) Auto expand replicas is meant to be entirely disabled for stateless indices. The only scenario where a change needs to be applied is when the number of replicas is initialized to 0, in which case 0 needs to be turned into 1. Otherwise, no changes should be applied in stateless indices despite auto expand replicas is used. The current handling for this was missing an early exit of the indices loop in the case where 0 shoudl be turned into 1, that leads to a potentially higher number of copies being allocated (effectively auto-expand gets applied by mistake).</MESSAGE>
    <SHA>8f28bc2febe0c850baf21809c29dd7984187ae48</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Allow setting the `type` in the reroute processor This allows configuring the `type` from within the ingest `reroute` processor. Similar to `dataset` and `namespace`, the type defaults to the value extracted from the index name. This means that documents sent to `logs-mysql.access.default` will have a default value of `logs` for the type. Resolves #121553</MESSAGE>
      <SHA>e5d98b96cdb6e7e5d8c67ab4768c221930048b00</SHA>
      <PATCHEDFILES>
        <FILE>docs/reference/ingest/processors/reroute.asciidoc</FILE>
        <FILE>modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/RerouteProcessor.java</FILE>
        <FILE>modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/RerouteProcessorFactoryTests.java</FILE>
        <FILE>modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/RerouteProcessorTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Allow setting the `type` in the reroute processor (#122409) * Allow setting the `type` in the reroute processor This allows configuring the `type` from within the ingest `reroute` processor. Similar to `dataset` and `namespace`, the type defaults to the value extracted from the index name. This means that documents sent to `logs-mysql.access.default` will have a default value of `logs` for the type. Resolves #121553 * Update docs/changelog/122409.yaml</MESSAGE>
      <SHA>2ae80c799daac539f46008f8cf70be18a328bf67</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/122409.yaml</FILE>
        <FILE>docs/reference/ingest/processors/reroute.asciidoc</FILE>
        <FILE>modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/RerouteProcessor.java</FILE>
        <FILE>modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/RerouteProcessorFactoryTests.java</FILE>
        <FILE>modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/RerouteProcessorTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
