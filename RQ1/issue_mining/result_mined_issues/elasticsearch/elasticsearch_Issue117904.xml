<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>117904</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/117904</ISSUEURL>
  <TITLE>[CI] SparseVectorQueryBuilderTests testToQuery failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic #5207 / encryption-at-rest](https://gradle-enterprise.elastic.co/s/nerl3mmyxmlro) - [elasticsearch-periodic-platform-support #5185 / ubuntu-2004_platform-support-unix](https://gradle-enterprise.elastic.co/s/6y43xxu5jkkkk) - [elasticsearch-periodic-platform-support #5185 / rocky-9_platform-support-unix](https://gradle-enterprise.elastic.co/s/pv5pqlyawro2s) - [elasticsearch-periodic-platform-support #5185 / ubuntu-1804_platform-support-unix](https://gradle-enterprise.elastic.co/s/k3za7ywco6zia) - [elasticsearch-periodic-platform-support #5185 / opensuse-leap-15_platform-support-unix](https://gradle-enterprise.elastic.co/s/rm5gteknjeoo6) - [elasticsearch-periodic #5207 / release-tests](https://gradle-enterprise.elastic.co/s/t74kxplxh6l7k) - [elasticsearch-periodic-platform-support #5185 / oraclelinux-8_platform-support-unix](https://gradle-enterprise.elastic.co/s/ykmuc2gasbjbc) - [elasticsearch-periodic-platform-support #5185 / rhel-7_platform-support-unix](https://gradle-enterprise.elastic.co/s/wsjbolhy2cra4) - [elasticsearch-periodic-platform-support #5185 / amazonlinux-2_platform-support-aws](https://gradle-enterprise.elastic.co/s/cn3l5wsiy7a56) - [elasticsearch-periodic-platform-support #5185 / sles-15_platform-support-unix](https://gradle-enterprise.elastic.co/s/waroqrdvq2byq) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:core:test&quot; --tests &quot;org.elasticsearch.xpack.core.ml.search.SparseVectorQueryBuilderTests.testToQuery&quot; -Dtests.seed=EEBFEF162D2032F4 -Dtests.locale=mk-MK -Dtests.timezone=America/Indiana/Petersburg -Druntime.java=23 ``` **Applicable branches:** 8.x **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.core.ml.search.SparseVectorQueryBuilderTests),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testToQuery),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: null ``` **Issue Reasons:** - [8.x] 6 consecutive failures in test testToQuery - [8.x] 3 consecutive failures in step oraclelinux-8_platform-support-unix - [8.x] 3 consecutive failures in step amazonlinux-2_platform-support-aws - [8.x] 2 consecutive failures in step sles-15_platform-support-unix - [8.x] 3 consecutive failures in step rhel-9_platform-support-unix - [8.x] 63 failures in test testToQuery (47.0% fail rate in 134 executions) - [8.x] 2 failures in step encryption-at-rest (66.7% fail rate in 3 executions) - [8.x] 2 failures in step rocky-9_platform-support-unix (66.7% fail rate in 3 executions) - [8.x] 2 failures in step opensuse-leap-15_platform-support-unix (66.7% fail rate in 3 executions) - [8.x] 2 failures in step release-tests (50.0% fail rate in 4 executions) - [8.x] 2 failures in step ubuntu-2004-aarch64_checkpart2_platform-support-arm (66.7% fail rate in 3 executions) - [8.x] 7 failures in step part2 (41.2% fail rate in 17 executions) - [8.x] 3 failures in step oraclelinux-8_platform-support-unix (100.0% fail rate in 3 executions) - [8.x] 2 failures in step rhel-7_platform-support-unix (66.7% fail rate in 3 executions) - [8.x] 3 failures in step amazonlinux-2_platform-support-aws (100.0% fail rate in 3 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix BWC for ES|QL cluster request (#117865) We identified a BWC bug in the cluster computer request. Specifically, the indices options were not properly selected for requests from an older querying cluster. This caused the search_shards API on the remote cluster to use restricted indices options, leading to failures when resolving wildcard index patterns. Our tests didn't catch this issue because the current BWC tests for cross-cluster queries only cover one direction: the querying cluster on the current version and the remote cluster on a compatible version. This PR fixes the issue and expands BWC tests to support both directions: the querying cluster on the current version with the remote cluster on a compatible version, and vice versa.</MESSAGE>
    <SHA>267dc1a41d49b11c6470ae1f83091debfc49e95f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.core.ml.search.SparseVectorQueryBuilderTests testToQuery #117904</MESSAGE>
      <SHA>00a1222f10a6bc605f67aee67d4053c5ba0557e8</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
