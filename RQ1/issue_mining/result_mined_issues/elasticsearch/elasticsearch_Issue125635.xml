<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>125635</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/125635</ISSUEURL>
  <TITLE>Highlight of SourceConfirmedTextQuery can throw NPE</TITLE>
  <DESCRIPTION>``` Caused by: java.lang.NullPointerException: Cannot invoke \&quot;org.apache.lucene.search.ScorerSupplier.get(long)\&quot; because the return value of \&quot;org.elasticsearch.index.mapper.extras.SourceConfirmedTextQuery$2.scorerSupplier(org.apache.lucene.index.LeafReaderContext)\&quot; is null \tat org.elasticsearch.mapper.extras@9.1.0/org.elasticsearch.index.mapper.extras.SourceConfirmedTextQuery$2.matches(SourceConfirmedTextQuery.java:324) \tat org.apache.lucene.core@10.1.0/org.apache.lucene.search.DisjunctionMaxQuery$DisjunctionMaxWeight.matches(DisjunctionMaxQuery.java:125) \tat org.apache.lucene.highlighter@10.1.0/org.apache.lucene.search.uhighlight.FieldOffsetStrategy.createOffsetsEnumsWeightMatcher(FieldOffsetStrategy.java:147) \tat org.apache.lucene.highlighter@10.1.0/org.apache.lucene.search.uhighlight.FieldOffsetStrategy.createOffsetsEnumFromReader(FieldOffsetStrategy.java:74) \tat org.apache.lucene.highlighter@10.1.0/org.apache.lucene.search.uhighlight.MemoryIndexOffsetStrategy.getOffsetsEnum(MemoryIndexOffsetStrategy.java:117) \tat org.apache.lucene.highlighter@10.1.0/org.apache.lucene.search.uhighlight.FieldHighlighter.highlightFieldForDoc(FieldHighlighter.java:83) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.lucene.search.uhighlight.CustomFieldHighlighter.highlightFieldForDoc(CustomFieldHighlighter.java:75) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.lucene.search.uhighlight.CustomUnifiedHighlighter.highlightField(CustomUnifiedHighlighter.java:152) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.search.fetch.subphase.highlight.DefaultHighlighter.highlight(DefaultHighlighter.java:87) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.search.fetch.subphase.highlight.HighlightPhase$1.process(HighlightPhase.java:70) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.search.fetch.FetchPhase$1.nextDoc(FetchPhase.java:188) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.search.fetch.FetchPhaseDocsIterator.iterate(FetchPhaseDocsIterator.java:90) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.search.fetch.FetchPhase.buildSearchHits(FetchPhase.java:205) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:85) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.search.SearchService.lambda$executeFetchPhase$13(SearchService.java:1028) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.action.ActionRunnable$3.accept(ActionRunnable.java:79) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.action.ActionRunnable$3.accept(ActionRunnable.java:76) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.action.ActionRunnable$4.doRun(ActionRunnable.java:101) \tat org.elasticsearch.server@9.1.0/org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:27) ```</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>34</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Return 400 BAD_REQUEST when a field scorer references a missing field (#127229) Currently it returns 5xx, when it's entirely an error in the request</MESSAGE>
    <SHA>83300ea1f180f17d5be9ec147bc9cb38ae49a5ae</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix npe when using source confirmed text query against missing field (#127414) We should check for the field and statistics actually existing when checking matches and explanation with `match_only_text` fields closes: https://github.com/elastic/elasticsearch/issues/125635</MESSAGE>
      <SHA>3d67e0e7ca6860fdb2856fa071c0d275ef7bb2f0</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/127414.yaml</FILE>
        <FILE>modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/extras/SourceConfirmedTextQuery.java</FILE>
        <FILE>modules/mapper-extras/src/test/java/org/elasticsearch/index/mapper/extras/SourceConfirmedTextQueryTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix npe when using source confirmed text query against missing field (#127414) We should check for the field and statistics actually existing when checking matches and explanation with `match_only_text` fields closes: https://github.com/elastic/elasticsearch/issues/125635 (cherry picked from commit 3d67e0e7ca6860fdb2856fa071c0d275ef7bb2f0)</MESSAGE>
      <SHA>e85f93cf86d122e472e31a97194a164c7b5f06fb</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/127414.yaml</FILE>
        <FILE>modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/extras/SourceConfirmedTextQuery.java</FILE>
        <FILE>modules/mapper-extras/src/test/java/org/elasticsearch/index/mapper/extras/SourceConfirmedTextQueryTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix npe when using source confirmed text query against missing field (#127414) (#127526) We should check for the field and statistics actually existing when checking matches and explanation with `match_only_text` fields closes: https://github.com/elastic/elasticsearch/issues/125635 (cherry picked from commit 3d67e0e7ca6860fdb2856fa071c0d275ef7bb2f0)</MESSAGE>
      <SHA>9aba430373dfcc293a49b734e035af25a82b5269</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/127414.yaml</FILE>
        <FILE>modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/extras/SourceConfirmedTextQuery.java</FILE>
        <FILE>modules/mapper-extras/src/test/java/org/elasticsearch/index/mapper/extras/SourceConfirmedTextQueryTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
