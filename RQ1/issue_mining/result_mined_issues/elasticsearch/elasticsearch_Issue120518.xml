<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>120518</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/120518</ISSUEURL>
  <TITLE>Clean up of the `.snapshot-blob-cache*` index not working on an upgraded 8.x cluster</TITLE>
  <DESCRIPTION>### Elasticsearch Version 8.x ### Installed Plugins _No response_ ### Java Version _bundled_ ### OS Version all ### Problem Description If a 7.x cluster has the `.snapshot-blob-cache*` system index (used for caching header/footer values of Lucene files when mounting searchable snapshot indices), and it is upgrade to 8.x, the clean up of the entries of this index doesn't seem to work anymore. These clean ups are done automatically periodically e.g. when the relevant searchable snapshot indices are removed (and after a configurable period). Deletion also doesn't seem to work if one would create new searchable snapshot indices (which write to this system index) and remove them. In other words, after upgrade the `.snapshot-blob-cache*` system index seems to only grow. As a work-around, you can remove the `.snapshot-blob-cache*` system index (which requires `[delete_index,manage,all]` privileges). Note that this work-around essentially wipes the cache (which is what this system index is). ### Steps to Reproduce 1. Start a 7.x node. 2. create an index, take a snapshot and remove the index. 3. Mount the index as a partially mounted searchable snapshot. 4. Upgrade to 8.x. 5. Remove the searchable snapshot index. 6. The `.snapshot-blob-cache*` index is not cleaned up after the configured retention period and periodic clean up interval. ### Logs (if relevant) _No response_</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>7</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[ML] Add default Elastic Inference Service chat completion endpoint (#120847) * Starting new auth class implementation * Fixing some tests * Working tests * Refactoring * Addressing feedback and pull main</MESSAGE>
    <SHA>1fa1ba79a2f7618249a27cbbe15c8b0d83781ce3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Use the system index descriptor in the snapshot blob cache cleanup task (#120937) Clean up of the `.snapshot-blob-cache*` system index is done only on the node that hosts the primary of the shard 0 of that index. When the index is migrated as part of an upgrade test e.g. v7 -&gt; v8, the index is reindexed to a new index `.snapshot-blob-cache-reindexed-for-9`. The code scheduling this clean up task is not able to locate the shard and would never trigger a clean up after the upgrade. This change uses the system index descriptor to find the matching shard and would work for future versions too. Closes https://github.com/elastic/elasticsearch/issues/120518</MESSAGE>
      <SHA>06664626895d1b8defbaa68b4480a40afacfced7</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/120937.yaml</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/internalClusterTest/java/org/elasticsearch/xpack/searchablesnapshots/cache/blob/SearchableSnapshotsBlobStoreCacheMaintenanceIntegTests.java</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshots.java</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/blob/BlobStoreCacheMaintenanceService.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Use the system index descriptor in the snapshot blob cache cleanup task (#120937) Clean up of the `.snapshot-blob-cache*` system index is done only on the node that hosts the primary of the shard 0 of that index. When the index is migrated as part of an upgrade test e.g. v7 -&gt; v8, the index is reindexed to a new index `.snapshot-blob-cache-reindexed-for-9`. The code scheduling this clean up task is not able to locate the shard and would never trigger a clean up after the upgrade. This change uses the system index descriptor to find the matching shard and would work for future versions too. Closes https://github.com/elastic/elasticsearch/issues/120518</MESSAGE>
      <SHA>0747610902856fe366e1230eaff1e3fea5fd069b</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/120937.yaml</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/internalClusterTest/java/org/elasticsearch/xpack/searchablesnapshots/cache/blob/SearchableSnapshotsBlobStoreCacheMaintenanceIntegTests.java</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshots.java</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/blob/BlobStoreCacheMaintenanceService.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Use the system index descriptor in the snapshot blob cache cleanup task (#120937) (#121053) Clean up of the `.snapshot-blob-cache*` system index is done only on the node that hosts the primary of the shard 0 of that index. When the index is migrated as part of an upgrade test e.g. v7 -&gt; v8, the index is reindexed to a new index `.snapshot-blob-cache-reindexed-for-9`. The code scheduling this clean up task is not able to locate the shard and would never trigger a clean up after the upgrade. This change uses the system index descriptor to find the matching shard and would work for future versions too. Closes https://github.com/elastic/elasticsearch/issues/120518</MESSAGE>
      <SHA>604c01530566ae62a30781b98f0808aeebb235af</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/120937.yaml</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/internalClusterTest/java/org/elasticsearch/xpack/searchablesnapshots/cache/blob/SearchableSnapshotsBlobStoreCacheMaintenanceIntegTests.java</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshots.java</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/blob/BlobStoreCacheMaintenanceService.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
