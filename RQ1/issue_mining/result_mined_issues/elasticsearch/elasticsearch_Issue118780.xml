<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>118780</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/118780</ISSUEURL>
  <TITLE>ESQL: LOOKUP JOIN should warn when join keys are multi-valued</TITLE>
  <DESCRIPTION>The current implementation of LOOKUP JOIN is treats multivalued join keys very leniently and just matches rows whenever any value in the left hand join key matches any value in the right hand join key (c.f. [tests here](https://github.com/elastic/elasticsearch/blob/693bb794bce43eb20d07b08ceba5e796ded6efbd/x-pack/plugin/esql/qa/testFixtures/src/main/resources/lookup-join.csv-spec#L199-L227)). That might not be the desired behavior long-term. Let's at least issue a warning in this case, and maybe also change the lookup operator(s) to not consider any multivalues as matching.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>57</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Move migrate APIs to rest-api-spec indices namespace (#120580)</MESSAGE>
    <SHA>455e0627f698c57100d663639e4b0dafc498c694</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>ESQL: Skip multivalues in LOOKUP JOIN matches (#120519) Fixes https://github.com/elastic/elasticsearch/issues/118780 To follow the same logics of the `==` operator (Doesn't match or work at all on multivalues or nulls), we're removing the Lucene matching currently being indirectly used by LOOKUP JOIN.</MESSAGE>
      <SHA>9c192684520f4138ddc606e3b26bdf8d010f7153</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/operator/lookup/QueryList.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/test/java/org/elasticsearch/compute/operator/lookup/EnrichQuerySourceOperatorTests.java</FILE>
        <FILE>x-pack/plugin/esql/qa/testFixtures/src/main/resources/lookup-join.csv-spec</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/enrich/LookupFromIndexService.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/planner/PlannerUtils.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Ignore multivalued key columns in lookup index on JOIN (#120726) Fixes https://github.com/elastic/elasticsearch/issues/118780 Second part of https://github.com/elastic/elasticsearch/pull/120519 In the first PR, we avoid matching multivalue keys in lookup when they come from the query. Now, we avoid matching multivalues when the lookup index has multivalues in the key column.</MESSAGE>
      <SHA>8c3d9e19985f5d5d47f90d7680e18920b27ff560</SHA>
      <PATCHEDFILES>
        <FILE>x-pack/plugin/esql/compute/src/main/java/module-info.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/operator/lookup/QueryList.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/querydsl/query/SingleValueMatchQuery.java</FILE>
        <FILE>x-pack/plugin/esql/compute/src/test/java/org/elasticsearch/compute/operator/lookup/EnrichQuerySourceOperatorTests.java</FILE>
        <FILE>x-pack/plugin/esql/qa/testFixtures/src/main/resources/lookup-join.csv-spec</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/querydsl/query/SingleValueQuery.java</FILE>
        <FILE>x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/querydsl/query/SingleValueMathQueryTests.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
