<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>119036</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/119036</ISSUEURL>
  <TITLE>[CI] EsqlClientYamlIT test {p0=esql/190_lookup_join/non-lookup index} failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #5441 / ubuntu-2404_platform-support-unix](https://gradle-enterprise.elastic.co/s/q4pznwjioeuvk) - [elasticsearch-periodic-platform-support #5441 / opensuse-leap-15_platform-support-unix](https://gradle-enterprise.elastic.co/s/df3qr5pmnnxti) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:esql:qa:server:multi-node:yamlRestTest&quot; --tests &quot;org.elasticsearch.xpack.esql.qa.multi_node.EsqlClientYamlIT.test {p0=esql/190_lookup_join/non-lookup index}&quot; -Dtests.seed=7633F1619AC73E9C -Dtests.locale=hi-IN -Dtests.timezone=America/Monterrey -Druntime.java=23 ``` **Applicable branches:** 8.x **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.esql.qa.multi_node.EsqlClientYamlIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(test%20%7Bp0%3Desql%2F190_lookup_join%2Fnon-lookup%20index%7D),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: Failure at [esql/190_lookup_join:23]: expected [2xx] status code but api [indices.create] returned [400 Bad Request] [{&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2&quot;,&quot;stack_trace&quot;:&quot;org.elasticsearch.ElasticsearchException$1: index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:706)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.ElasticsearchException.generateFailureXContent(ElasticsearchException.java:634)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.build(RestResponse.java:201)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.&lt;init&gt;(RestResponse.java:160)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.&lt;init&gt;(RestResponse.java:121)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.rest.action.RestActionListener.onFailure(RestActionListener.java:54)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener$3.onFailure(ActionListener.java:410)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.tasks.TaskManager$1.onFailure(TaskManager.java:215)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.DelegatingActionListener.onFailure(DelegatingActionListener.java:32)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations$RunBeforeActionListener.onFailure(ActionListenerImplementations.java:346)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener$3.onFailure(ActionListener.java:410)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.DelegatingActionListener.onFailure(DelegatingActionListener.java:32)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations$RunBeforeActionListener.onFailure(ActionListenerImplementations.java:346)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeAcceptException(ActionListenerImplementations.java:64)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListenerImplementations.safeOnFailure(ActionListenerImplementations.java:75)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.ActionListener$3.onFailure(ActionListener.java:410)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$1.handleException(TransportMasterNodeAction.java:278)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1510)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundHandler.doHandleException(InboundHandler.java:476)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundHandler.handleException(InboundHandler.java:463)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundHandler.handlerResponseError(InboundHandler.java:454)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundHandler.executeResponseHandler(InboundHandler.java:148)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundHandler.messageReceived(InboundHandler.java:125)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundHandler.inboundMessage(InboundHandler.java:98)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.TcpTransport.inboundMessage(TcpTransport.java:822)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundPipeline.forwardFragments(InboundPipeline.java:125)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundPipeline.doHandleBytes(InboundPipeline.java:97)\n\tat org.elasticsearch.server@8.18.0-SNAPSHOT/org.elasticsearch.transport.InboundPipeline.handleBytes(InboundPipeline.java:62)\n\tat org.elasticsearch.transport.netty4@8.18.0-SNAPSHOT/org.elasticsearch.transport.netty4.Netty4MessageInboundHandler.channelRead(Netty4MessageInboundHandler.java:55)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n\tat io.netty.codec@4.1.115.Final/io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:107)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1357)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:868)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:689)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:652)\n\tat io.netty.transport@4.1.115.Final/io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\n\tat io.netty.common@4.1.115.Final/io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\n\tat io.netty.common@4.1.115.Final/io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat java.base/java.lang.Thread.run(Thread.java:1575)\nCaused by: java.lang.IllegalArgumentException: index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2\n\tat org.elasticsearch.index.IndexMode$4.validateWithOtherSettings(IndexMode.java:322)\n\tat org.elasticsearch.index.IndexSettings$3.validate(IndexSettings.java:723)\n\tat org.elasticsearch.index.IndexSettings$3.validate(IndexSettings.java:717)\n\tat org.elasticsearch.common.settings.Setting.get(Setting.java:563)\n\tat org.elasticsearch.common.settings.Setting.get(Setting.java:535)\n\tat org.elasticsearch.common.settings.Setting.get(Setting.java:694)\n\tat org.elasticsearch.common.settings.AbstractScopedSettings.get(AbstractScopedSettings.java:747)\n\tat org.elasticsearch.index.IndexSettings.&lt;init&gt;(IndexSettings.java:969)\n\tat org.elasticsearch.indices.IndicesService.createIndexService(IndicesService.java:739)\n\tat org.elasticsearch.indices.IndicesService.withTempIndexService(IndicesService.java:711)\n\tat org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexWithTemporaryService(MetadataCreateIndexService.java:500)\n\tat org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexRequestWithV1Templates(MetadataCreateIndexService.java:623)\n\tat org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexRequest(MetadataCreateIndexService.java:448)\n\tat org.elasticsearch.cluster.metadata.MetadataCreateIndexService$1.execute(MetadataCreateIndexService.java:327)\n\tat org.elasticsearch.cluster.service.MasterService$UnbatchedExecutor.execute(MasterService.java:574)\n\tat org.elasticsearch.cluster.service.MasterService.innerExecuteTasks(MasterService.java:1075)\n\tat org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:1038)\n\tat org.elasticsearch.cluster.service.MasterService.executeAndPublishBatch(MasterService.java:245)\n\tat org.elasticsearch.cluster.service.MasterService$BatchingTaskQueue$Processor.lambda$run$2(MasterService.java:1691)\n\tat org.elasticsearch.action.ActionListener.run(ActionListener.java:452)\n\tat org.elasticsearch.cluster.service.MasterService$BatchingTaskQueue$Processor.run(MasterService.java:1688)\n\tat org.elasticsearch.cluster.service.MasterService$5.lambda$doRun$0(MasterService.java:1283)\n\tat org.elasticsearch.action.ActionListener.run(ActionListener.java:452)\n\tat org.elasticsearch.cluster.service.MasterService$5.doRun(MasterService.java:1262)\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:1044)\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:27)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\n\tat java.lang.Thread.run(Thread.java:1575)\n&quot;}],&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2&quot;,&quot;stack_trace&quot;:&quot;java.lang.IllegalArgumentException: index with [lookup] mode must have [index.number_of_shards] set to 1 or unset; provided 2\n\tat org.elasticsearch.index.IndexMode$4.validateWithOtherSettings(IndexMode.java:322)\n\tat org.elasticsearch.index.IndexSettings$3.validate(IndexSettings.java:723)\n\tat org.elasticsearch.index.IndexSettings$3.validate(IndexSettings.java:717)\n\tat org.elasticsearch.common.settings.Setting.get(Setting.java:563)\n\tat org.elasticsearch.common.settings.Setting.get(Setting.java:535)\n\tat org.elasticsearch.common.settings.Setting.get(Setting.java:694)\n\tat org.elasticsearch.common.settings.AbstractScopedSettings.get(AbstractScopedSettings.java:747)\n\tat org.elasticsearch.index.IndexSettings.&lt;init&gt;(IndexSettings.java:969)\n\tat org.elasticsearch.indices.IndicesService.createIndexService(IndicesService.java:739)\n\tat org.elasticsearch.indices.IndicesService.withTempIndexService(IndicesService.java:711)\n\tat org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexWithTemporaryService(MetadataCreateIndexService.java:500)\n\tat org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexRequestWithV1Templates(MetadataCreateIndexService.java:623)\n\tat org.elasticsearch.cluster.metadata.MetadataCreateIndexService.applyCreateIndexRequest(MetadataCreateIndexService.java:448)\n\tat org.elasticsearch.cluster.metadata.MetadataCreateIndexService$1.execute(MetadataCreateIndexService.java:327)\n\tat org.elasticsearch.cluster.service.MasterService$UnbatchedExecutor.execute(MasterService.java:574)\n\tat org.elasticsearch.cluster.service.MasterService.innerExecuteTasks(MasterService.java:1075)\n\tat org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:1038)\n\tat org.elasticsearch.cluster.service.MasterService.executeAndPublishBatch(MasterService.java:245)\n\tat org.elasticsearch.cluster.service.MasterService$BatchingTaskQueue$Processor.lambda$run$2(MasterService.java:1691)\n\tat org.elasticsearch.action.ActionListener.run(ActionListener.java:452)\n\tat org.elasticsearch.cluster.service.MasterService$BatchingTaskQueue$Processor.run(MasterService.java:1688)\n\tat org.elasticsearch.cluster.service.MasterService$5.lambda$doRun$0(MasterService.java:1283)\n\tat org.elasticsearch.action.ActionListener.run(ActionListener.java:452)\n\tat org.elasticsearch.cluster.service.MasterService$5.doRun(MasterService.java:1262)\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:1044)\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:27)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\n\tat java.lang.Thread.run(Thread.java:1575)\n&quot;},&quot;status&quot;:400}] ``` **Issue Reasons:** - [8.x] 2 consecutive failures in test test {p0=esql/190_lookup_join/non-lookup index} - [8.x] 2 failures in test test {p0=esql/190_lookup_join/non-lookup index} (2.4% fail rate in 83 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>4</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.xpack.esql.qa.single_node.EsqlClientYamlIT test {p0=esql/190_lookup_join/basic} #119035</MESSAGE>
    <SHA>75a87961619e06f12e055307bc78fabd76afbd38</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.esql.qa.single_node.EsqlClientYamlIT test {p0=esql/190_lookup_join/non-lookup index} #119036</MESSAGE>
      <SHA>0b4937f8a34f568168f7ee80cc5335db60b7bbc1</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
