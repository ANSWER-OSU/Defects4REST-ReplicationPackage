<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>120444</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/120444</ISSUEURL>
  <TITLE>[CI] Netty4IncrementalRequestHandlingIT testOversizedChunkedEncoding failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #5930 / rocky-8_platform-support-unix](https://gradle-enterprise.elastic.co/s/d3k6niyna3qok) - [elasticsearch-periodic-platform-support #5920 / rhel-7_platform-support-unix](https://gradle-enterprise.elastic.co/s/cjuumemy4ssls) - [elasticsearch-periodic-platform-support #5915 / rocky-8_platform-support-unix](https://gradle-enterprise.elastic.co/s/qzzhkm3opqvqo) - [elasticsearch-periodic-platform-support #5915 / oraclelinux-8_platform-support-unix](https://gradle-enterprise.elastic.co/s/hvahe2v5ksvmq) - [elasticsearch-periodic-platform-support #5915 / rhel-7_platform-support-unix](https://gradle-enterprise.elastic.co/s/4yvc6krjzk73e) - [elasticsearch-periodic-platform-support #5905 / rhel-7_platform-support-unix](https://gradle-enterprise.elastic.co/s/efaygairty4j2) - [elasticsearch-periodic-platform-support #5905 / amazonlinux-2023_platform-support-aws](https://gradle-enterprise.elastic.co/s/h3nw7iwj5bdvk) - [elasticsearch-periodic #5910 / single-processor-node-tests](https://gradle-enterprise.elastic.co/s/evunsifizeikw) - [elasticsearch-periodic-platform-support #5900 / sles-12_platform-support-unix](https://gradle-enterprise.elastic.co/s/g2fzumxsjejra) - [elasticsearch-periodic-platform-support #5900 / rhel-7_platform-support-unix](https://gradle-enterprise.elastic.co/s/yuggwmrbug47a) **Reproduction Line:** ``` ./gradlew &quot;:modules:transport-netty4:pooledInternalClusterTest&quot; --tests &quot;org.elasticsearch.http.netty4.Netty4IncrementalRequestHandlingIT.testOversizedChunkedEncoding&quot; -Dtests.seed=719D1FB9F6972461 -Dtests.locale=es-PY -Dtests.timezone=Asia/Calcutta -Druntime.java=23 ``` **Applicable branches:** 8.x **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.http.netty4.Netty4IncrementalRequestHandlingIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testOversizedChunkedEncoding),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: cannot request next chunk on closing stream ``` **Issue Reasons:** - [8.x] 13 failures in test testOversizedChunkedEncoding (2.5% fail rate in 510 executions) - [8.x] 2 failures in step rocky-8_platform-support-unix (28.6% fail rate in 7 executions) - [8.x] 2 failures in step sles-12_platform-support-unix (28.6% fail rate in 7 executions) - [8.x] 4 failures in step rhel-7_platform-support-unix (57.1% fail rate in 7 executions) - [8.x] 6 failures in pipeline elasticsearch-periodic-platform-support (75.0% fail rate in 8 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Delete persisted cold cache index if created in the future (#120465) The Lucene index used to store cold cache files information (to persist the cold cache across node restarts) is upgraded at node startup, before the cluster is formed. This upgrade can become an issue if the node cannot join the cluster: an attempt to downgrade the node back to the previous version will likely fail due to this Lucene index being already upgraded. Ideally we would prefer to upgrade the Lucene index after the node joined the cluster, but it requires more work as this Lucene index can be queried concurrently during shard allocation (see TransportSearchableSnapshotCacheStoresAction). Instead of doing a more involved fix, this change deletes the persistent cache index from disk if it detects that the Lucene index has been upgraded. It assumes that we are already in a best effort downgrading procedure, so losing persistent cache is acceptable in order to allow downgrading the node.</MESSAGE>
    <SHA>a578608204b0b60bb4fe55de86cdd95c3820e5c3</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.http.netty4.Netty4IncrementalRequestHandlingIT testOversizedChunkedEncoding #120444</MESSAGE>
      <SHA>c05b23e442427d6064d55ffa5110285eaca0ac1a</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
