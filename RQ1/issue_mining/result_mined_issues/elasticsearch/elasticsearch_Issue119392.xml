<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>119392</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/119392</ISSUEURL>
  <TITLE>[CI] ES818HnswBinaryQuantizedVectorsFormatTests testRandomExceptions failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-periodic-platform-support #5623 / almalinux-8-aarch64_checkpart1_platform-support-arm](https://gradle-enterprise.elastic.co/s/rzpifgtnmhhrk) - [elasticsearch-periodic #5619 / openjdk21_checkpart1_java-matrix](https://gradle-enterprise.elastic.co/s/kfqt4gir6yscw) **Reproduction Line:** ``` null ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.index.codec.vectors.es818.ES818HnswBinaryQuantizedVectorsFormatTests),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testRandomExceptions),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still 1 open files: {_15_ES818HnswBinaryQuantizedVectorsFormat_0.veb_temp_42.tmp=1} ``` **Issue Reasons:** - [main] 2 failures in test testRandomExceptions (1.4% fail rate in 145 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>8</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Mute org.elasticsearch.xpack.esql.optimizer.LocalPhysicalPlanOptimizerTests testSingleMatchOperatorFilterPushdownWithStringValues {default} #119721</MESSAGE>
    <SHA>59e9391a8211477dbc21888f7d0323368aba67d4</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix bbq_hnsw merge file cleanup on random IO exceptions (#119691) Since we open two temporary files during quantized vector merging, its possible that the second file fails to be created. In that case, we should ensure the previously created temporary files are removed. closes https://github.com/elastic/elasticsearch/issues/119392</MESSAGE>
      <SHA>8edcdd45639d5be83b3eced086cd6b87e8a03194</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119691.yaml</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/codec/vectors/es818/ES818BinaryQuantizedVectorsWriter.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix bbq_hnsw merge file cleanup on random IO exceptions (#119691) Since we open two temporary files during quantized vector merging, its possible that the second file fails to be created. In that case, we should ensure the previously created temporary files are removed. closes https://github.com/elastic/elasticsearch/issues/119392</MESSAGE>
      <SHA>20b1b3a29359d94c244c50ed7ecef5db4d8e1e18</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119691.yaml</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/codec/vectors/es818/ES818BinaryQuantizedVectorsWriter.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix bbq_hnsw merge file cleanup on random IO exceptions (#119691) (#119763) Since we open two temporary files during quantized vector merging, its possible that the second file fails to be created. In that case, we should ensure the previously created temporary files are removed. closes https://github.com/elastic/elasticsearch/issues/119392</MESSAGE>
      <SHA>95c87fddcbdf42e1b88d5c7d9924fb5ae6162db0</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/119691.yaml</FILE>
        <FILE>server/src/main/java/org/elasticsearch/index/codec/vectors/es818/ES818BinaryQuantizedVectorsWriter.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
