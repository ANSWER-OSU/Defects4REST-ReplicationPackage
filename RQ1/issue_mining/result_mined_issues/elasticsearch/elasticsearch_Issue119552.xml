<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>119552</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/119552</ISSUEURL>
  <TITLE>org.elasticsearch.xpack.logsdb.LogsdbIndexModeSettingsProvider#newIndexHasSyntheticSourceUsage uses more than 1/3 of index creation CPU time</TITLE>
  <DESCRIPTION>`org.elasticsearch.xpack.logsdb.LogsdbIndexModeSettingsProvider#newIndexHasSyntheticSourceUsage` is one of the big contributors to the many shards benchmarks regressions we're seeing. The reason for that is that it does a redundant mapping merge exactly like the one we do anyway. We need to find a more efficient solution here, this is severely impacting at least the productivity of working with the many-shards benchmarks but also has production impact on master node stability during mass index rollover events and the like. See below profile (note this is 30% of CPU overall, including JIT and GC which are quite heavy here): &lt;img width=&quot;1718&quot; alt=&quot;Image&quot; src=&quot;https://github.com/user-attachments/assets/8165c5da-9736-41cf-8c50-3e080d459fe8&quot; /&gt;</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>16</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>[Profiling] Add os.type mapping to profiling-hosts (#120187)</MESSAGE>
    <SHA>91b6a213e8f887aa0b84794839ebb4a0f27bbf5f</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Optimize loading mappings in logsdb index settings provider Optimize mapping service usages in when determining synthetic source usage and assessing whether host.name field can be used for index sorting. This is done by excluding the part of the mapping we're not interested in. This replaces #119935 and addresses the problem differently, by just loading the parts of the mapping LogsdbIndexModeSettingsProvider is interested in and by this lowering the overhead of parsing/merging mappings that has been reported via #119552.</MESSAGE>
      <SHA>430c9fa00fc79ee862afb1ebb785db31632bad09</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/120055.yaml</FILE>
        <FILE>x-pack/plugin/logsdb/src/main/java/org/elasticsearch/xpack/logsdb/LogsdbIndexModeSettingsProvider.java</FILE>
        <FILE>x-pack/plugin/logsdb/src/yamlRestTest/resources/rest-api-spec/test/30_logsdb_default_mapping.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Optimize loading mappings in logsdb index settings provider Optimize mapping service usages in when determining synthetic source usage and assessing whether host.name field can be used for index sorting. This is done by excluding the part of the mapping we're not interested in. This replaces #119935 and addresses the problem differently, by just loading the parts of the mapping LogsdbIndexModeSettingsProvider is interested in and by this lowering the overhead of parsing/merging mappings that has been reported via #119552.</MESSAGE>
      <SHA>ea574a35759db0ac3d052a9c379d9bcb71227a45</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/120055.yaml</FILE>
        <FILE>x-pack/plugin/logsdb/src/main/java/org/elasticsearch/xpack/logsdb/LogsdbIndexModeSettingsProvider.java</FILE>
        <FILE>x-pack/plugin/logsdb/src/yamlRestTest/resources/rest-api-spec/test/30_logsdb_default_mapping.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Optimize loading mappings in logsdb index settings provider (#120221) Optimize mapping service usages in when determining synthetic source usage and assessing whether host.name field can be used for index sorting. This is done by excluding the part of the mapping we're not interested in. This replaces #119935 and addresses the problem differently, by just loading the parts of the mapping LogsdbIndexModeSettingsProvider is interested in and by this lowering the overhead of parsing/merging mappings that has been reported via #119552.</MESSAGE>
      <SHA>460ce87777ba31a772d0720e3d218b53103e70e6</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/120055.yaml</FILE>
        <FILE>x-pack/plugin/logsdb/src/main/java/org/elasticsearch/xpack/logsdb/LogsdbIndexModeSettingsProvider.java</FILE>
        <FILE>x-pack/plugin/logsdb/src/yamlRestTest/resources/rest-api-spec/test/30_logsdb_default_mapping.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
