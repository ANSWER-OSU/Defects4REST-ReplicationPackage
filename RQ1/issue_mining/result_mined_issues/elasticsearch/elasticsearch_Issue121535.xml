<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>121535</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/121535</ISSUEURL>
  <TITLE>ES|QL &quot;ROW a=null | SORT a&quot; crashes with AssertionError</TITLE>
  <DESCRIPTION>### Elasticsearch Version 9.0.0 ### Installed Plugins _No response_ ### Java Version n/a ### OS Version n/a ### Problem Description Executing the ES|QL command ``` ROW a=null | SORT a ``` crashes on main with the following assertion error: ``` [2025-02-03T15:33:10,801][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [runTask-0] fatal error in thread [elasticsearch[runTask-0][search][T#1]], exiting java.lang.AssertionError: estimated row size [0] wasn't set at org.elasticsearch.xpack.esql.planner.LocalExecutionPlanner.planTopN(LocalExecutionPlanner.java:362) (...) ``` Note: this doesn't occur in production, because assertions are disabled. ### Steps to Reproduce spin up ES, Kibana, go to discover, ES|QL mode, enter &quot;ROW a=null | SORT a&quot; ### Logs (if relevant) _No response_</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>28</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Skip internal logging in compat check (#123940) (#123951) The stable API compatibility checks ensure public jars don't change their APIs in incompatible ways. Yet the logging jar has an internal package which can change arbitrarily. This commit adds a temporary workaround to skip the internal logging package until the compat check can be made to look at module-info.</MESSAGE>
    <SHA>e540f865d470a5db60e0e2a6e9fbc5d3537be36c</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>ESQL: Ensure non-zero row size in `EstimatesRowSize` (#122762) Closes #121535</MESSAGE>
      <SHA>8ce0d6c7687439c570f430fbe33ce41d926ac02a</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/122762.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/EsqlActionIT.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/AggregateExec.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/TopNExec.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Ensure non-zero row size in `EstimatesRowSize` (#122762) Closes #121535</MESSAGE>
      <SHA>4d2cb53ed759480640043e446002e478e71c534f</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/122762.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/EsqlActionIT.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/AggregateExec.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/TopNExec.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Ensure non-zero row size in `EstimatesRowSize` (#122762) Closes #121535 (cherry picked from commit 4d2cb53ed759480640043e446002e478e71c534f)</MESSAGE>
      <SHA>476073fa23dc7288c5657947f94357d032713004</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/122762.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/EsqlActionIT.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/AggregateExec.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/TopNExec.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Ensure non-zero row size in `EstimatesRowSize` (#122762) (#123958) Closes #121535 Co-authored-by: kanoshiou &lt;73424326+kanoshiou@users.noreply.github.com&gt;</MESSAGE>
      <SHA>8e409d64d2b1b3c1e4608f31da3deb7f21b64497</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/122762.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/EsqlActionIT.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/AggregateExec.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/TopNExec.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Ensure non-zero row size in `EstimatesRowSize` (#122762) Closes #121535</MESSAGE>
      <SHA>176015cacb67d6522416186dc048c6f307f83f8d</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/122762.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/EsqlActionIT.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/AggregateExec.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/TopNExec.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>ESQL: Ensure non-zero row size in `EstimatesRowSize` (#122762) Closes #121535</MESSAGE>
      <SHA>5e3f34fb20a2aef6fd0e108bd96efd94b38db5dd</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/122762.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/EsqlActionIT.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/AggregateExec.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/TopNExec.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>[8.x] ESQL: Ensure non-zero row size in `EstimatesRowSize` (#122762) (#123959) * ESQL: Ensure non-zero row size in `EstimatesRowSize` (#122762) Closes #121535 (cherry picked from commit 4d2cb53ed759480640043e446002e478e71c534f) * Removed getFirst() usages --------- Co-authored-by: kanoshiou &lt;73424326+kanoshiou@users.noreply.github.com&gt; Co-authored-by: Costin Leau &lt;costin@users.noreply.github.com&gt; Co-authored-by: Iván Cea Fontenla &lt;ivancea96@outlook.com&gt; Co-authored-by: Iván Cea Fontenla &lt;ivan.cea@elastic.co&gt;</MESSAGE>
      <SHA>ca45080ba800867a2d3b52ae8202259d7feb8c2f</SHA>
      <PATCHEDFILES>
        <FILE>docs/changelog/122762.yaml</FILE>
        <FILE>x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/EsqlActionIT.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/AggregateExec.java</FILE>
        <FILE>x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/physical/TopNExec.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
