<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>121642</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/121642</ISSUEURL>
  <TITLE>[CI] UpgradeClusterClientYamlTestSuiteIT test {p0=mixed_cluster/110_enrich/Enrich stats query smoke test for mixed cluster} failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-intake #17194 / 9.0.0_bwc-snapshots](https://gradle-enterprise.elastic.co/s/uum4u2zrfn3ru) - [elasticsearch-pull-request #54825 / 9.0.0_bwc-snapshots](https://gradle-enterprise.elastic.co/s/lsx6jyeqi324y) - [elasticsearch-pull-request #54812 / 8.19.0_bwc-snapshots](https://gradle-enterprise.elastic.co/s/kovqf4jwxrjqm) - [elasticsearch-pull-request #54811 / 8.19.0_bwc-snapshots](https://gradle-enterprise.elastic.co/s/xibybi4mpqvgg) - [elasticsearch-pull-request #54780 / 8.19.0_bwc-snapshots](https://gradle-enterprise.elastic.co/s/npg7zqhurdr5o) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:qa:rolling-upgrade:v9.0.0#twoThirdsUpgradedTest&quot; -Dtests.class=&quot;org.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT&quot; -Dtests.method=&quot;test {p0=mixed_cluster/110_enrich/Enrich stats query smoke test for mixed cluster}&quot; -Dtests.seed=68B1B51BE52BA06E -Dtests.bwc=true -Dtests.locale=mk -Dtests.timezone=America/Indiana/Petersburg -Druntime.java=23 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(test%20%7Bp0%3Dmixed_cluster%2F110_enrich%2FEnrich%20stats%20query%20smoke%20test%20for%20mixed%20cluster%7D),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: Failure at [mixed_cluster/110_enrich:7]: expected [2xx] status code but api [enrich.stats] returned [500 Internal Server Error] [{&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;e_o_f_exception&quot;,&quot;reason&quot;:null,&quot;stack_trace&quot;:&quot;org.elasticsearch.ElasticsearchException$1\n\tat org.elasticsearch.server@9.0.0-SNAPSHOT/org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:725)\n\tat org.elasticsearch.server@9.0.0-SNAPSHOT/org.elasticsearch.ElasticsearchException.generateFailureXContent(ElasticsearchException.java:639)\n\tat org.elasticsearch.server@9.0.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.build(RestResponse.java:202)\n\tat org.elasticsearch.server@9.0.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.&lt;init&gt;(RestResponse.java:161)\n\tat org.elasticsearch.server@9.0.0-SNAPSHOT/org.elasticsearch.rest.RestResponse.&lt;init&gt;(RestResponse.java:122)\n\tat org.elasticsearch.server@9.0.0-SNAPSHOT/org.elasticsearch.rest.action.RestActionListener.onFailure(Res [truncated] ``` **Issue Reasons:** - [main] 5 failures in test test {p0=mixed_cluster/110_enrich/Enrich stats query smoke test for mixed cluster} (1.0% fail rate in 492 executions) - [main] 2 failures in step 9.0.0_bwc-snapshots (1.4% fail rate in 144 executions) - [main] 3 failures in step 8.19.0_bwc-snapshots (2.0% fail rate in 153 executions) - [main] 4 failures in pipeline elasticsearch-pull-request (3.4% fail rate in 118 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>1</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>`DeprecationInfoAction` refactoring (#121181) This refactoring was motivated by the following issues with the current state of the code: - The `TransformDeprecationChecker` is listed as plugin checker, but later we remove is from the `plugin_settings` and add it to the `cluster_settings`. This made me consider that the checker might be dealing with transform deprecation warnings but if they are listed under the `cliuster_settings`, it fits better to be part of `ClusterDeprecationChecker`. - The `DeprecationInfo` is a data class, but it has a method `from` which constructs an `DeprecationInfo.Response` instance. However, this is not a simple factory class but it actually runs all the checks and it also tries to assert that it is not executed on a transport thread. Considering this, I thought it might fit better to the `TransportDeprecationInfoAction`, this way all the logic is in one place and all the checkers are wired and used in the same class. - Constructing the node settings deprecation issues requires to merge the deprecation warnings of the individual nodes. We considered bringing together the execution of the remote request and the construction of the response in a new class called `NodeDeprecationChecker` that resembles the patterns of the other Checker classes. - Reinstated the `PLUGIN_CHECKERS` even if we have only one check, so other developers can easier add their plugin checks. - Finally, we noticed that the way we synthesise the remote requests is difficult to read and maintain because each call is nested under the previous one. We propose in this PR a different pattern that uses the `RefCountingListener` to combine the different remote calls and store their results in a container class named `PrecomputedData` - **Bonus**: Removed the `LegacyIndexTemplateDeprecationChecker.java` which was not used.</MESSAGE>
    <SHA>95c9b4b855f2a3688d10bf33f7f5feb6485dc360</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT test {p0=mixed_cluster/110_enrich/Enrich stats query smoke test for mixed cluster} #121642</MESSAGE>
      <SHA>12a71666f62b6c085d5d20c0ec8ec3d7620fc3fa</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT test {p0=mixed_cluster/110_enrich/Enrich stats query smoke test for mixed cluster} #121642</MESSAGE>
      <SHA>f5760f70f097eabd4f2a58e6ea97a4970a8d99b6</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
