<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>121927</ISSUENO>
  <ISSUEURL>https://github.com/elastic/elasticsearch/issues/121927</ISSUEURL>
  <TITLE>[CI] FrozenSearchableSnapshotsIntegTests testCreateAndRestorePartialSearchableSnapshot failing</TITLE>
  <DESCRIPTION>**Build Scans:** - [elasticsearch-intake #17464 / part2](https://gradle-enterprise.elastic.co/s/vqlu2pstuqh5y) - [elasticsearch-pull-request #55441 / part-2](https://gradle-enterprise.elastic.co/s/3litr7jgb22lw) - [elasticsearch-pull-request #55167 / part-2](https://gradle-enterprise.elastic.co/s/phwoc2k2eguww) - [elasticsearch-pull-request #55140 / part-2](https://gradle-enterprise.elastic.co/s/6skpoqsqy4asq) - [elasticsearch-pull-request #55022 / part-2](https://gradle-enterprise.elastic.co/s/7f3evtd7xu44w) - [elasticsearch-pull-request #54300 / part-2](https://gradle-enterprise.elastic.co/s/kd3qxylqtvude) **Reproduction Line:** ``` ./gradlew &quot;:x-pack:plugin:searchable-snapshots:internalClusterTest&quot; --tests &quot;org.elasticsearch.xpack.searchablesnapshots.FrozenSearchableSnapshotsIntegTests.testCreateAndRestorePartialSearchableSnapshot&quot; -Dtests.seed=9630F989C34893C7 -Dtests.locale=ln -Dtests.timezone=Europe/Nicosia -Druntime.java=23 ``` **Applicable branches:** main **Reproduces locally?:** N/A **Failure History:** [See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&amp;_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.searchablesnapshots.FrozenSearchableSnapshotsIntegTests),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!(testCreateAndRestorePartialSearchableSnapshot),title:'Test',type:optionsListControl))))) **Failure Message:** ``` java.lang.AssertionError: Searchable snapshot directory does not support the operation [createOutput(corrupted_01O7EZodStSA2E5d8Tz6GQ, IOContext[context=DEFAULT, mergeInfo=null, flushInfo=null, readAdvice=RANDOM])], current directory files: _0.cfe,_0.cfs,_0.si,_1.cfe,_1.cfs,_1.si,segments_3 ``` **Issue Reasons:** - [main] 6 failures in test testCreateAndRestorePartialSearchableSnapshot (0.6% fail rate in 971 executions) - [main] 5 failures in step part-2 (1.4% fail rate in 350 executions) - [main] 5 failures in pipeline elasticsearch-pull-request (1.4% fail rate in 353 executions) **Note:** This issue was created using new test triage automation. Please report issues or feedback to es-delivery.</DESCRIPTION>
  <REPONAME>elasticsearch</REPONAME>
  <TIMEDIFFERENCEDAYS>3</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Remove scoring enabled assumptions in ES|QL match test (#121393) * Remove scoring enabled assumptions in ES|QL match test --------- Co-authored-by: elasticsearchmachine &lt;infra-root+elasticsearchmachine@elastic.co&gt;</MESSAGE>
    <SHA>0c8f5f8f00db3948f7df24da3ea5139a8453b952</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Mute org.elasticsearch.xpack.searchablesnapshots.FrozenSearchableSnapshotsIntegTests testCreateAndRestorePartialSearchableSnapshot #121927</MESSAGE>
      <SHA>7c186a1af04cf2f08a823153adf0d68080a29568</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Make CacheService.get() throws AlreadyClosedException when service is stopped This is caught thanks to #121210: if shard files are verified/checksumed while the node is stopping, an IllegalStateException is throw by CacheService.get() when it attempts to read data from the cache. This exception later caused the verification to fail and then the Lucene index to be marked as corrupted (which nows fails for searchable snapshots shards that are read-only and should not be corrupted at all). This pull request changes ensureLifecycleStarted(), which is called during CacheService.get(), to throw an AlreadyClosedException when the service is stopped (note that ACE extends IllegalStateException, which is convenient here). This ACE will be later specially handlded in the checksumIndex method to not mark the shard as corrupted (see #121210). Closes #121927</MESSAGE>
      <SHA>1a946e4375b66ea2d9410606b091c184afa721a5</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/full/CacheService.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Make CacheService.get() throws AlreadyClosedException when service is stopped (#122006) This is caught thanks to #121210: if shard files are verified/checksumed while the node is stopping, an IllegalStateException is throw by CacheService.get() when it attempts to read data from the cache. This exception later caused the verification to fail and then the Lucene index to be marked as corrupted (which nows fails for searchable snapshots shards that are read-only and should not be corrupted at all). This pull request changes ensureLifecycleStarted(), which is called during CacheService.get(), to throw an AlreadyClosedException when the service is stopped (note that ACE extends IllegalStateException, which is convenient here). This ACE will be later specially handlded in the checksumIndex method to not mark the shard as corrupted (see #121210). Closes #121927</MESSAGE>
      <SHA>26f6acf20c1bea79addc75309fbdfbeb78a30ad3</SHA>
      <PATCHEDFILES>
        <FILE>muted-tests.yml</FILE>
        <FILE>x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/full/CacheService.java</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
