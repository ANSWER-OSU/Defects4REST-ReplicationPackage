<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5381</ISSUENO>
  <ISSUEURL>https://github.com/louislam/uptime-kuma/issues/5381</ISSUEURL>
  <TITLE>MariaDB Error: &quot;LIMIT &amp; IN/ALL/ANY/SOME subquery&quot; Not Supported</TITLE>
  <DESCRIPTION>### I have found these related issues/pull requests I have checked, but couldn’t find anything similar. ### ️ Security Policy - [X] I agree to have read this project [Security Policy](https://github.com/louislam/uptime-kuma/security/policy) ### Description While executing a `DELETE` query on the `heartbeat` table, the following error occurs: This version of MariaDB doesn't yet support 'LIMIT &amp; IN/ALL/ANY/SOME subquery' ### Query ```sql DELETE FROM heartbeat WHERE monitor_id = 1 AND important = 0 AND time &lt; DATE_ADD(NOW(), INTERVAL -24 HOUR) AND id NOT IN ( SELECT id FROM heartbeat WHERE monitor_id = 1 ORDER BY time DESC LIMIT 100 ) ``` ### Error Details - **Error Code:** ER_NOT_SUPPORTED_YET - **SQL State:** 42000 - **MySQL Version:** MariaDB 11.6.2 ### Stack Trace ```log Error at Packet.asError (/app/node_modules/mysql2/lib/packets/packet.js:738:17) ``` The current version of MariaDB does not support combining `LIMIT` with `IN/ALL/ANY/SOME` subqueries, which causes this error. ### Suggested Fix Modify the query to avoid using `LIMIT` inside the `IN` clause. Example suggestion: ```sql DELETE FROM heartbeat WHERE monitor_id = 1 AND important = 0 AND time &lt; DATE_ADD(NOW(), INTERVAL -24 HOUR) AND id NOT IN ( SELECT id FROM ( SELECT id FROM heartbeat WHERE monitor_id = 1 ORDER BY time DESC LIMIT 100 ) AS limited_ids ) ``` This structure ensures compatibility by avoiding the direct use of `LIMIT` in the outer `IN` clause. ### Reproduction steps ```docker-compose.yml --- networks: uptime-kuma-beta_net: attachable: false internal: false external: false name: uptime-kuma-beta driver: bridge ipam: driver: default config: - subnet: 172.20.3.0/24 ip_range: 172.20.3.0/24 gateway: 172.20.3.1 driver_opts: com.docker.network.bridge.default_bridge: &quot;false&quot; com.docker.network.bridge.enable_icc: &quot;true&quot; com.docker.network.bridge.enable_ip_masquerade: &quot;true&quot; com.docker.network.bridge.host_binding_ipv4: &quot;0.0.0.0&quot; com.docker.network.bridge.name: &quot;uptime-kuma&quot; com.docker.network.driver.mtu: &quot;1500&quot; labels: com.uptime-kuma-beta.network.description: &quot;is an isolated bridge network.&quot; services: uptime-kuma-beta_db: restart: unless-stopped logging: driver: &quot;json-file&quot; options: max-size: &quot;1M&quot; max-file: &quot;2&quot; stop_grace_period: 1m container_name: uptime-kuma-beta_db image: mariadb:latest pull_policy: if_not_present volumes: - /docker/uptime-kuma-beta/db:/var/lib/mysql environment: PUID: &quot;1000&quot; PGID: &quot;1000&quot; TZ: Europe/Amsterdam MYSQL_ROOT_PASSWORD: &quot;ThisIsADemoRootPassword&quot; MYSQL_DATABASE: &quot;uptime_kuma_db&quot; MYSQL_USER: &quot;uptime-kuma&quot; MYSQL_PASSWORD: &quot;ThisIsADemoPassword&quot; command: [ &quot;--transaction-isolation=READ-COMMITTED&quot;, &quot;--log-bin=binlog&quot;, &quot;--binlog-format=ROW&quot;, ] hostname: uptime-kuma-beta_db networks: uptime-kuma-beta_net: ipv4_address: 172.20.3.2 security_opt: - no-new-privileges:true labels: com.uptime-kuma-beta.db.description: &quot;is an MySQL database.&quot; healthcheck: disable: true uptime-kuma-beta_app: restart: unless-stopped logging: driver: &quot;json-file&quot; options: max-size: &quot;1M&quot; max-file: &quot;2&quot; stop_grace_period: 1m container_name: uptime-kuma-beta image: louislam/uptime-kuma:2.0.0-beta.0 pull_policy: if_not_present depends_on: uptime-kuma-beta_db: condition: service_started links: - uptime-kuma-beta_db volumes: - /docker/uptime-kuma-beta/app:/app/data - /var/run/docker.sock:/var/run/docker.sock:ro - /usr/local/share/ca-certificates:/app/data/docker-tls environment: PUID: &quot;1000&quot; PGID: &quot;1000&quot; TZ: Europe/Amsterdam # This is a certificate authority for demonstration purposes. # NODE_EXTRA_CA_CERTS: /app/data/docker-tls/root_ca_demo_cert.pem MYSQL_HOST: &quot;uptime-kuma-beta_db&quot; MYSQL_PORT: 3306 MYSQL_NAME: &quot;uptime_kuma_db&quot; MYSQL_USER: &quot;uptime-kuma&quot; MYSQL_PASSWORD: &quot;ThisIsADemoPassword&quot; domainname: status.local hostname: status networks: uptime-kuma-beta_net: ipv4_address: 172.20.3.3 ports: - &quot;3001:3001/tcp&quot; # HTTP - &quot;3001:3001/udp&quot; # HTTP security_opt: - no-new-privileges:true labels: com.docker.compose.project: &quot;uptime-kuma-beta&quot; com.uptime-kuma-beta.description: &quot;is an self-hosted monitoring tool that allows you to monitor uptime, status, and notifications for various services and domains.&quot; healthcheck: disable: true ``` ### Expected behavior The query should execute successfully, deleting older entries from the `heartbeat` table while keeping the most recent 100 entries. ### Actual Behavior The query fails due to the unsupported subquery syntax in MariaDB. ### Uptime-Kuma Version 2.0.0-beta.0 ### Operating System and Arch Ubuntu Server 24.04.1 LTS (GNU/Linux 6.8.0-49-generic x86_64) ### Browser Brave Version 1.73.91 Chromium: 131.0.6778.85 (Official Build) (64-bit) ### ️ Deployment Environment - **Runtime:** Docker version 26.1.0, build 9714adc - **Runtime:** docker-compose version 1.29.2, build unknown - **Runtime:** Portainer Business Edition version 2.21.4 - **Runtime:** MariaDB 11.6.2 - **Database:** (external) - **Filesystem used for the database:** Linux/ext4 on an SSD - **Number of monitors:** 92 ### Relevant log output ```shell Trace: Error: DELETE FROM heartbeat WHERE monitor_id = 1 AND important = 0 AND time &lt; DATE_ADD(NOW(), INTERVAL -24 HOUR) AND id NOT IN ( SELECT id FROM heartbeat WHERE monitor_id = 1 ORDER BY time DESC LIMIT 100 ) - This version of MariaDB doesn't yet support 'LIMIT &amp; IN/ALL/ANY/SOME subquery' at Packet.asError (/app/node_modules/mysql2/lib/packets/packet.js:738:17) at Query.execute (/app/node_modules/mysql2/lib/commands/command.js:29:26) at Connection.handlePacket (/app/node_modules/mysql2/lib/connection.js:481:34) at PacketParser.onPacket (/app/node_modules/mysql2/lib/connection.js:97:12) at PacketParser.executeStart (/app/node_modules/mysql2/lib/packet_parser.js:75:16) at Socket.&lt;anonymous&gt; (/app/node_modules/mysql2/lib/connection.js:104:25) at Socket.emit (node:events:519:28) at addChunk (node:internal/streams/readable:559:12) at readableAddChunkPushByteMode (node:internal/streams/readable:510:3) at Readable.push (node:internal/streams/readable:390:5) { code: 'ER_NOT_SUPPORTED_YET', errno: 1235, sqlState: '42000', sqlMessage: &quot;This version of MariaDB doesn't yet support 'LIMIT &amp; IN/ALL/ANY/SOME subquery'&quot;, sql: '\n' + ' DELETE FROM heartbeat\n' + ' WHERE monitor_id = 1\n' + ' AND important = 0\n' + ' AND time &lt; DATE_ADD(NOW(), INTERVAL -24 HOUR)\n' + ' AND id NOT IN (\n' + ' SELECT id\n' + ' FROM heartbeat\n' + ' WHERE monitor_id = 1\n' + ' ORDER BY time DESC\n' + ' LIMIT 100\n' + ' )\n' + ' ' } at process.unexpectedErrorHandler (/app/server/server.js:1872:13) at process.emit (node:events:519:28) at emitUnhandledRejection (node:internal/process/promises:250:13) at throwUnhandledRejectionsMode (node:internal/process/promises:385:19) at processPromiseRejections (node:internal/process/promises:470:17) at process.processTicksAndRejections (node:internal/process/task_queues:96:32) If you keep encountering errors, please report to https://github.com/louislam/uptime-kuma/issues ```</DESCRIPTION>
  <REPONAME>uptime-kuma</REPONAME>
  <TIMEDIFFERENCEDAYS>15</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Fix the save bar of the maintenance menu (#5385) Co-authored-by: Frank Elsinga &lt;frank@elsinga.de&gt;</MESSAGE>
    <SHA>c0fe669cd8f8dcb4a7d3aefae834c7a70bc692db</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix #5381</MESSAGE>
      <SHA>af51508aae77d9697ebafd522d65cd02b9856976</SHA>
      <PATCHEDFILES>
        <FILE>package-lock.json</FILE>
        <FILE>server/database.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix #5381 Co-authored-by: GJS &lt;homelab.api@gmail.com&gt;</MESSAGE>
      <SHA>397411bd271f5b300f2bd008fb2adfc0dbb5e9e3</SHA>
      <PATCHEDFILES>
        <FILE>package-lock.json</FILE>
        <FILE>server/database.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
