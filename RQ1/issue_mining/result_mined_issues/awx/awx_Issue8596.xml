<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>8596</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/8596</ISSUEURL>
  <TITLE>[ui_next] [Meta-issue] Failed to execute 'Send' on Websocket: Still in CONNECTING state.</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY Multiple ways to trigger Failed to execute 'Send' on Websocket: Still in CONNECTING state. 1. Toggling between Job Output and Detail causes invalidstateerror. 2. Relaunching Jobs ##### ENVIRONMENT * AWX version: 10664d1931d789c281e2c9d3d2f14c0a69cb9e13 ##### STEPS TO REPRODUCE 1. Launch a Job 2. Navigate to the Output Page and toggle between Details and Output tabs ##### EXPECTED RESULTS No errors ##### ACTUAL RESULTS Unhandled error ##### ADDITIONAL INFORMATION ![Screen Recording 2020-11-17 at 08 50 37 AM](https://user-images.githubusercontent.com/12446869/99398198-17971880-28b2-11eb-8ba4-c798a90fe95c.gif)</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>203</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #10334 from mabashian/outdated-revision Adds ability to refresh project revision on sync'd rows in the project list SUMMARY This PR also adds the revision to the project details view as well as handles updating the revision on the project details view when the project is done syncing. Since the project revision is not included in the websocket payload, when a project is done syncing the displayed revision may be out of date. As such, we wanted to expose that information to the user and give them the ability to &quot;refresh&quot; and fetch the new revision. Here's what that flow looks like: When a particular row finishes syncing the user should see this in place of the revision: Clicking on that refresh button goes out and fetches the updated project (and with it the potentially updated revision). We don't do this automatically on the projects list (and force the user to click on the refresh button) is due to issues we've had in the past with the UI triggering API calls based on websocket events. The flow when a user is on the project details view is a little different because I wasn't as worried about spamming the API with requests. When a project finishes syncing and the user is viewing the details I do go ahead and automatically refresh the project data (and with it, the revision). Here's what that looks like: A few other notes: @tiagodread @akus062381 @one-t I'm almost certain this is going to break some tests because I removed the ClipboardCopyButton in favor of PF's ClipboardCopy component. This component looks and behaves slightly differently from our home grown solution. Additionally, the PF ClipboardCopy button does not expose the ouiaId prop so I had to add a data-cy on that component. You'll likely have to use that identifier to then grab the button inside in order to test out the clipboard copy functionality. Source Control Revision is a net-new detail in the project details. I think this was simply missed on our initial build of this page. Here are the identifiers on the various bits: Note that the identifiers on the project rows have the id of the project appended to them for uniqueness. ISSUE TYPE Feature Pull Request COMPONENT NAME UI Reviewed-by: Jake McDermott &lt;yo@jakemcdermott.me&gt; Reviewed-by: Michael Abashian &lt;None&gt; Reviewed-by: Sarah Akus &lt;sarah.akus@gmail.com&gt;</MESSAGE>
    <SHA>ac5b53b13c15eb8b0fe679f8c0c5a10366edcc1e</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #10339 from mabashian/8596-websocket-connecting-state Only attempt to reconnect socket if connection wasn't closed cleanly SUMMARY link #8596 After some investigation, I believe that this error is caused by the reconnect logic that we have. When the component that references the ws hook unmounts, we disconnect the socket. There's some logic in the onclose method that attempts to reconnect the socket but if we've disconnected cleanly we shouldn't try to reconnect (because we probably meant to disconnect in the first place). This should clean up the console errors that we've been seeing about the socket already being in a connected state since we won't have timers running past the lifecycle of the component. cc @keithjgrant does this sound good to you? Here's the spec for the disconnect event https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent#properties ISSUE TYPE Bugfix Pull Request COMPONENT NAME UI Reviewed-by: Keith Grant &lt;keithjgrant@gmail.com&gt; Reviewed-by: Tiago GÃ³es &lt;tiago.goes2009@gmail.com&gt;</MESSAGE>
      <SHA>66a9ffc3766cbf2b2d14cef0b3e60e9b7ff40316</SHA>
      <PATCHEDFILES>
        <FILE>awx/ui_next/src/util/useWebsocket.js</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
