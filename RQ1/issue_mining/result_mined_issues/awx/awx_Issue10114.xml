<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>10114</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/10114</ISSUEURL>
  <TITLE>Container Registry credentials don't work with Container Groups</TITLE>
  <DESCRIPTION>&lt;!-- Issues are for **concrete, actionable bugs and feature requests** only - if you're just asking for debugging help or technical support, please use: - http://webchat.freenode.net/?channels=ansible-awx - https://groups.google.com/forum/#!forum/awx-project We have to limit this because of limited volunteer time to respond to issues! --&gt; ##### ISSUE TYPE - Bug Report ##### SUMMARY This is a reopen of #9928. #9928 was closed stating #9623 addresses the issue and would be resolved in the next release. However #9623 was included in release 19.1.0 and the issue still persists. Execution environments can't be pulled from private registries as the authentication credentials are not being passed to the pod spec. ##### ENVIRONMENT * AWX version: 19.1.0 * AWX install method: minikube * Ansible version: ? * Operating System: Debian * Web Browser: Chrome ##### STEPS TO REPRODUCE ![image](https://user-images.githubusercontent.com/1826947/117161065-a11ea200-ad8f-11eb-8b4f-a4e465224873.png) ![image](https://user-images.githubusercontent.com/1826947/117161122-a976dd00-ad8f-11eb-9aa3-6bbddf4c5c5c.png) ![image](https://user-images.githubusercontent.com/1826947/117161147-b0055480-ad8f-11eb-9a97-15d0a9b1af0c.png) ``` # kubectl describe pod awx-job-53-cvh88 Name: awx-job-53-cvh88 Namespace: default Priority: 0 Node: minikube/192.168.49.2 Start Time: Wed, 05 May 2021 14:06:06 +0000 Labels: ansible-awx=f34e7217-6215-41db-b716-970e1b09be7d ansible-awx-job-id=53 Annotations: &lt;none&gt; Status: Pending IP: 172.17.0.6 IPs: IP: 172.17.0.6 Containers: worker: Container ID: Image: gitlab.example.com:5443/myproject/ansible-runner Image ID: Port: &lt;none&gt; Host Port: &lt;none&gt; Args: ansible-runner worker --private-data-dir=/runner State: Waiting Reason: ImagePullBackOff Ready: False Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from default-token-qfwv8 (ro) Conditions: Type Status Initialized True Ready False ContainersReady False PodScheduled True Volumes: default-token-qfwv8: Type: Secret (a volume populated by a Secret) SecretName: default-token-qfwv8 Optional: false QoS Class: BestEffort Node-Selectors: &lt;none&gt; Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300s Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 44m default-scheduler Successfully assigned default/awx-job-53-cvh88 to minikube Normal Pulling 43m (x4 over 44m) kubelet Pulling image &quot;gitlab.example.com:5443/myproject/ansible-runner&quot; Warning Failed 43m (x4 over 44m) kubelet Failed to pull image &quot;gitlab.example.com:5443/myproject/ansible-runner&quot;: rpc error: code = Unknown desc = Error response from daemon: Head https://gitlab.example.com:5443/v2/myproject/ansible-runner/manifests/latest: denied: access forbidden Warning Failed 43m (x4 over 44m) kubelet Error: ErrImagePull Normal BackOff 9m25s (x155 over 44m) kubelet Back-off pulling image &quot;gitlab.example.com:5443/myproject/ansible-runner&quot; Warning Failed 4m25s (x177 over 44m) kubelet Error: ImagePullBackOff ``` ##### EXPECTED RESULTS Image to download &amp; run successfully ##### ACTUAL RESULTS Image download responds with `access forbidden` because of lack of credentials. ##### ADDITIONAL INFORMATION &lt;!-- Include any links to sosreport, database dumps, screenshots or other information. --&gt;</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>261</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #10248 from AlexSCorey/updatedPF Updates PF SUMMARY This is a dependency bump for PF so that I can get an update that fixes a validation bug in pf date picker. E2E test have been triggered ISSUE TYPE dep bump COMPONENT NAME UI AWX VERSION ADDITIONAL INFORMATION Reviewed-by: Jake McDermott &lt;yo@jakemcdermott.me&gt; Reviewed-by: Tiago GÃ³es &lt;tiago.goes2009@gmail.com&gt;</MESSAGE>
    <SHA>d2d62adcb9b1b252a67e0d8e152e8610c2e84fdf</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #10204 from rooftopcellist/container-groups-registry-creds Container groups registry creds SUMMARY Fixes #10114 In VM-based installs, the user provides image pull creds to us, then we put them in an authfile and give it to podman via --authfile. This is not so simple with ContainerGroups because we need to use the k8s API to apply a podspec to create containers in this paradigm. Currently, the EE pod gets created, but errors when pulling the custom EE in from the private repo: This work will modify the init() for the AWXReceptorJob class to create a k8s secret in the given namespace, then specify that secret name in the pod-spec as an imagePullSecret Also, the imagePullPolicy was not being enforced when running JT's in EE's using container groups, this is because the imagePullPolicy nevery got set on the pod spec. ISSUE TYPE Bugfix Pull Request COMPONENT NAME API AWX VERSION devel ADDITIONAL INFORMATION Issues that this solves: Image pull secret now gets created in the cluster namespace specified by the user for that container group. imagePullSecret name gets set on the pod spec If the pull secret already exists in the namespace, delete it, then create it. (kube_api.replace_namespaced_secret did not work for this case...) Enforce imagePullPolicy for EE's in container groups Basic error handling Reviewed-by: Alan Rominger &lt;arominge@redhat.com&gt; Reviewed-by: Christian Adams &lt;rooftopcellist@gmail.com&gt; Reviewed-by: Jeff Bradberry &lt;None&gt; Reviewed-by: Shane McDonald &lt;me@shanemcd.com&gt; Reviewed-by: Chris Meyers &lt;None&gt;</MESSAGE>
      <SHA>2b4732f07bee28b22624890e5291ba9703eda6b5</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/scheduler/kubernetes.py</FILE>
        <FILE>awx/main/tasks.py</FILE>
        <FILE>awx/main/utils/external_logging.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
