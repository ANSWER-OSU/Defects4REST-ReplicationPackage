<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>6532</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/6532</ISSUEURL>
  <TITLE>AWX Job not started</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY I have AWX running inside kubernetes. The components (web and task) connects to postgresql. All of them are containers running as kubernetes pods. For 2 months that setup is running fine without connection issues between the pods. web (pod) --&gt; postgres (pod) task(pod) --&gt; postgres (pod) Due to lack of persistent storage in kubernetes cluster for postgres, I decided to move postgresql outside of kubernetes so it will be now a traditional virtual machine (1 master and 1 slave) instead of a container. Then I deployed pgpool inside kubernetes and remove the postgres pod. The current setup now is: web (pod) --&gt; pgpool (pod) --&gt; postgres master/slave (virtual machine) task (pod) --&gt; pgpool (pod) --&gt; postgres master/slave (virtual machine) During that setup, I encounter connection issues such as some SQL statements are not sent properly to backend postgres. I notice that scenario when I encounter this error from the task pod: ``` File &quot;/var/lib/awx/venv/awx/lib64/python3.6/site-packages/django/db/models/manager.py&quot;, line 82, in manager_method return getattr(self.get_queryset(), name)(*args, **kwargs) File &quot;/var/lib/awx/venv/awx/lib64/python3.6/site-packages/django/db/models/query.py&quot;, line 408, in get self.model._meta.object_name awx.main.models.jobs.Job.DoesNotExist: Job matching query does not exist. ``` I looked closely and found out that seems some SQL queries are not being handled by pgpool. In effect, the queries never reached the backend postgres servers. Here an image of the missed job in AWX that corresponds to the missed SQL query. From the image job 2214 is successful and ran, job 2216 is missed, job 2217 is successful, and so on. ![image](https://user-images.githubusercontent.com/28911125/78198898-b3f3e280-74bc-11ea-9a02-2e93eff82144.png) If we open the blank job, it will look like this. ![image](https://user-images.githubusercontent.com/28911125/78199128-6330b980-74bd-11ea-9ec7-69b68e570d98.png) And it will never run. To cleanup I just needed to delete them. Checking the pgpool logs, I see the job ID 2217 is there. ``` ➜ ~ ☿ kubectl logs dev-pgpool-77949cf588-mx25h | egrep '2020-03-31' | grep dev_execute_command | egrep 'INSERT INTO &quot;main_activitystream&quot;' | egrep '&quot;id&quot;: 2217' 2020-03-31 05:04:28: pid 36: LOG: statement: INSERT INTO &quot;main_activitystream&quot; (&quot;actor_id&quot;, &quot;operation&quot;, &quot;timestamp&quot;, &quot;changes&quot;, &quot;deleted_actor&quot;, &quot;action_node&quot;, &quot;object_relationship_type&quot;, &quot;object1&quot;, &quot;object2&quot;, &quot;setting&quot;) VALUES (NULL, 'create', '2020-03-31T05:04:28.282003+00:00'::timestamptz, '{&quot;name&quot;: &quot;dev_execute_command&quot;, &quot;description&quot;: &quot;&quot;, &quot;job_type&quot;: &quot;run&quot;, &quot;inventory&quot;: &quot;awx-playbooks-dev-1&quot;, &quot;project&quot;: &quot;awx-playbooks-6&quot;, &quot;playbook&quot;: &quot;playbooks/execute_command.yaml&quot;, &quot;scm_branch&quot;: &quot;&quot;, &quot;forks&quot;: 0, &quot;limit&quot;: &quot;&quot;, &quot;verbosity&quot;: 0, &quot;extra_vars&quot;: &quot;{\&quot;command\&quot;: \&quot;date\&quot;}&quot;, &quot;job_tags&quot;: &quot;&quot;, &quot;force_handlers&quot;: false, &quot;skip_tags&quot;: &quot;&quot;, &quot;start_at_task&quot;: &quot;&quot;, &quot;timeout&quot;: 0, &quot;use_fact_cache&quot;: false, &quot;job_template&quot;: &quot;dev_execute_command-18&quot;, &quot;allow_simultaneous&quot;: false, &quot;instance_group&quot;: null, &quot;diff_mode&quot;: false, &quot;job_slice_number&quot;: 0, &quot;job_slice_count&quot;: 1, &quot;id&quot;: 2217, &quot;credentials&quot;: [], &quot;labels&quot;: []}', NULL, 'awx', '', 'job', '', '{}') RETURNING &quot;main_activitystream&quot;.&quot;id&quot; ➜ ~ ☿ ``` But job id 2216 is not there. ``` ➜ ~ ☿ kubectl logs dev-pgpool-77949cf588-mx25h | egrep '2020-03-31' | grep dev_execute_command | egrep 'INSERT INTO &quot;main_activitystream&quot;' | egrep '&quot;id&quot;: 2216' ➜ ~ ☿ ``` Even though this is probably related to the pgpool setup I made, I want to ask for some insights specially on how awx sends SQL queries to destination postgres endpoint. I'm thinking if there are some settings that I can tweak on AWX side. ##### ENVIRONMENT * AWX version: 7.0.0 * AWX install method: kubernetes * Ansible version: 2.9.1 * Operating System: CentOS Linux release 7.7.1908 (Core) * Web Browser: Chrome 80.0.3987.149 * Pgpool: 4.1.1 ##### STEPS TO REPRODUCE 1. Setup master/slave postgres with streaming replication 2. Setup pgpool infront of postgres cluster 3. Point AWX web and tasks to pgpool IP ##### EXPECTED RESULTS All jobs must run as expected on schedule. ##### ACTUAL RESULTS Some jobs where not run. ##### ADDITIONAL INFORMATION I also submitted issue on pgpool bug tracker which may help. https://www.pgpool.net/mantisbt/view.php?id=601</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Pin ansible-runner (#6533)</MESSAGE>
    <SHA>f99e2107d602b582043859cfe73b9edd67319da5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Correctly handle case where unpartitioned table does not exist (#14648) (#6532)</MESSAGE>
      <SHA>dd63b69fa8813d873c7b2add9e434d9b525be923</SHA>
      <PATCHEDFILES>
        <FILE>awx/api/views/__init__.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
