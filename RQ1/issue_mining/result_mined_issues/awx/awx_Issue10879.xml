<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>10879</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/10879</ISSUEURL>
  <TITLE>Errors caused by Social Auth Organization and Team Mapping; Users unable to login</TITLE>
  <DESCRIPTION>### Please confirm the following - [X] I agree to follow this project's [code of conduct](http://docs.ansible.com/ansible/latest/community/code_of_conduct.html). - [X] I have checked the [current issues](https://github.com/ansible/awx/issues) for duplicates. - [X] I understand that AWX is open source software provided for free and that I am not entitled to status updates or other assurances. ### Summary Attempting to configure Social Organization/Team Mapping prevents social-auth users from logging in. `awx-web` and postgres show errors. If ORGANIZATION_MAP and TEAM_MAP are reverted to default/empty, user is able to login. ### AWX version 19.2.2 ### Installation method kubernetes ### Modifications yes ### Ansible version _No response_ ### Operating system _No response_ ### Web browser Chrome ### Steps to reproduce 1. Fresh AWX 19.2.2 installation via awx-operator (0.12.0) with `create_preload_data: 'false'` 2. Log in as Admin; Configure Github Organization OAuth2 Social Auth ( do not configure org/team maps ) ```json { &quot;SOCIAL_AUTH_GITHUB_ORG_CALLBACK_URL&quot;: &quot;https://my-awx-install.com/sso/complete/github-org/&quot;, &quot;SOCIAL_AUTH_GITHUB_ORG_KEY&quot;: &quot;&lt;redacted&gt;&quot;, &quot;SOCIAL_AUTH_GITHUB_ORG_SECRET&quot;: &quot;$encrypted$&quot;, &quot;SOCIAL_AUTH_GITHUB_ORG_ORGANIZATION_MAP&quot;: null, &quot;SOCIAL_AUTH_GITHUB_ORG_TEAM_MAP&quot;: null } ``` 3. Validate Step 2 configs by logging in via Github Org Social Auth 4. Log out. 5. Login as Admin; Configure Org/Team Maps (I tried this in both the Global and GitHub Org specific configs) ```json { &quot;SOCIAL_AUTH_GITHUB_ORG_CALLBACK_URL&quot;: &quot;https://my-awx-install.com/sso/complete/github-org/&quot;, &quot;SOCIAL_AUTH_GITHUB_ORG_KEY&quot;: &quot;&lt;redacted&gt;&quot;, &quot;SOCIAL_AUTH_GITHUB_ORG_SECRET&quot;: &quot;$encrypted$&quot;, &quot;SOCIAL_AUTH_GITHUB_ORG_NAME&quot;: &quot;MyOrg&quot;, &quot;SOCIAL_AUTH_GITHUB_ORG_ORGANIZATION_MAP&quot;: { &quot;MyOrg&quot;: { &quot;users&quot;: [ &quot;me@example.com&quot; ], &quot;admins&quot;: [ &quot;admin@example.com&quot; ], &quot;remove_users&quot;: true, &quot;remove_admins&quot;: true } }, &quot;SOCIAL_AUTH_GITHUB_ORG_TEAM_MAP&quot;: { &quot;operations-team&quot;: { &quot;remove&quot;: true, &quot;organization&quot;: &quot;MyOrg&quot;, &quot;users&quot;: [ &quot;me@example.com&quot; ] } } } ``` 6. Attempt to login as user; Get redirected to login page; Observe error awx-web and postgres error logs ### Expected results Organizations specified by valid Social Auth Org map(s) are created automatically Teams specified by valid Social Auth Team map(s) are created automatically Users are able to login as specified by Social Auth Org/Team maps ### Actual results User was not able to login following Org/Map configuration. Organization and Teams were not created on our behalf. `postgres` errors ```bash 2021-08-13 21:39:42.438 UTC [2886] STATEMENT: INSERT INTO &quot;main_organizationgalaxycredentialmembership&quot; (&quot;organization_id&quot;, &quot;credential_id&quot;, &quot;position&quot;) VALUES (1, NULL, NULL) RETURNING &quot;main_organizationgalaxycredentialmembership&quot;.&quot;id&quot; 2021-08-13 21:39:42.438 UTC [2886] ERROR: null value in column &quot;credential_id&quot; violates not-null constraint 2021-08-13 21:39:42.438 UTC [2886] DETAIL: Failing row contains (1, null, null, 1). ``` `awx-web` errors ``` 2021-08-13 21:39:42,440 ERROR [c6496ec03db747d3a7800f653acd316b] social null value in column &quot;credential_id&quot; violates not-null constraint DETAIL: Failing row contains (1, null, null, 1). . ``` ### Additional information * Installed via awx-operator with `create_preload_data: false` * Prior to opening this issue, I've also attempted this against 19.3.0 to no success.</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>55</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add verify_ssl to container_auth_data params</MESSAGE>
    <SHA>3f65570e1c18d06a83ef2495f1258d6727cf55f5</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fixed Org mapping behavior with SAML when Ansible Galaxy cred does not exist - Fixes #10879 - Fixes ansible/tower#5061 Signed-off-by: Hideki Saito &lt;saito@fgrep.org&gt;</MESSAGE>
      <SHA>892a48604a6c35fa8c02bffae360e4f1a269d1d9</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/models/organization.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fixed Org mapping behavior with SAML when Ansible Galaxy cred does not exist - Fixes #10879 - Fixes ansible/tower#5061 Signed-off-by: Hideki Saito &lt;saito@fgrep.org&gt;</MESSAGE>
      <SHA>a417486144b6aaaad1d7d0f8d3e328123334b544</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/models/organization.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
