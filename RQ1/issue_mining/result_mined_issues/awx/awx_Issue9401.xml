<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>9401</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/9401</ISSUEURL>
  <TITLE>Redis Dump Permissions Error Cause AWX Exceptions</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY On a fresh install of AWX 17.0.1, Redis returns an exception preventing most functionality, including job execution after an uptime of a few minutes. ##### ENVIRONMENT * AWX version: 17.0.1 * AWX install method: Ansible playbook into Kubernetes cluster * Ansible version: 2.9.17 * Operating System: Debian Linux * Web Browser: Firefox ##### STEPS TO REPRODUCE Ansible-playbook install to Kubernetes cluster only modifying the cluster information, ingress, and credential values as required. Postgres was setup through the playbook using Helm. One sign in, credentials were changed, Gitlab credential added, Gitlab Project added, all project sync jobs fail with no Output display and status of &quot;Failed&quot;. Relaunching the job provides and error with `POST /api/v2/projects/6/update/ 500` Restart the AWX deployment and jobs are successful for a few minutes until Redis errors occur after approximately 5 minutes when background saving starts. ##### EXPECTED RESULTS Project sync job to execute successfully ##### ACTUAL RESULTS All jobs fail, some settings cannot be configured, various errors throughout all of AWX ##### ADDITIONAL INFORMATION Based on search results for the error relating to Redis, in redis-cli the command `config set stop-writes-on-bgsave-error no` should be executed since there isn't the need for data persistence for AWX. **awx-redis** ``` 1:M 23 Feb 2021 22:22:41.003 * 100 changes in 300 seconds. Saving... 1:M 23 Feb 2021 22:22:41.004 * Background saving started by pid 524 524:C 23 Feb 2021 22:22:41.005 # Failed opening the RDB file dump.rdb (in server root dir /data) for saving: Permission denied 1:M 23 Feb 2021 22:22:41.106 # Background saving error ``` **awx-task** ``` 2021-02-23 22:39:20,203 ERROR awx.main.commands.run_callback_receiver encountered an error communicating with redis Traceback (most recent call last): File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/dispatch/worker/callback.py&quot;, line 56, in read res = self.redis.blpop(settings.CALLBACK_QUEUE, timeout=1) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/redis/client.py&quot;, line 1865, in blpop return self.execute_command('BLPOP', *keys) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/redis/client.py&quot;, line 878, in execute_command return self.parse_response(conn, command_name, **options) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/redis/client.py&quot;, line 892, in parse_response response = connection.read_response() File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/redis/connection.py&quot;, line 752, in read_response raise response redis.exceptions.ResponseError: MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commands that may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error. ``` **awx-web** ``` 2021-02-23 22:40:07,246 ERROR django.request Internal Server Error: /api/v2/projects/6/update/ Traceback (most recent call last): File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/core/handlers/exception.py&quot;, line 34, in inner response = get_response(request) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/core/handlers/base.py&quot;, line 115, in _get_response response = self.process_exception_by_middleware(e, request) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/core/handlers/base.py&quot;, line 113, in _get_response response = wrapped_callback(request, *callback_args, **callback_kwargs) File &quot;/usr/lib64/python3.6/contextlib.py&quot;, line 52, in inner return func(*args, **kwds) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/db/transaction.py&quot;, line 284, in __exit__ connection.set_autocommit(True) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/db/backends/base/base.py&quot;, line 410, in set_autocommit self.run_and_clear_commit_hooks() File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/django/db/backends/base/base.py&quot;, line 636, in run_and_clear_commit_hooks func() File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/models/unified_jobs.py&quot;, line 1264, in &lt;lambda&gt; connection.on_commit(lambda: self._websocket_emit_status(status)) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/models/unified_jobs.py&quot;, line 1254, in _websocket_emit_status emit_channel_notification('jobs-status_changed', status_data) File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/consumers.py&quot;, line 236, in emit_channel_notification &quot;text&quot;: payload_dumped File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/main/consumers.py&quot;, line 211, in run_sync event_loop.run_until_complete(func) File &quot;/usr/lib64/python3.6/asyncio/base_events.py&quot;, line 484, in run_until_complete return future.result() File &quot;/var/lib/awx/venv/awx/lib/python3.6/site-packages/channels_redis/core.py&quot;, line 650, in group_send key, min=0, max=int(time.time()) - self.group_expiry aioredis.errors.ReplyError: MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commands that may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error. ```</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>13</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #9169 from rooftopcellist/version-1101 Bump version to 17.0.1 &amp; update changelog Reviewed-by: https://github.com/apps/softwarefactory-project-zuul</MESSAGE>
    <SHA>aa4ca300f51781028517397b259319293cd664f8</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>resolve a permissions error related to redis see: https://github.com/ansible/awx/issues/9401</MESSAGE>
      <SHA>bfb0b790757cd3861fc8cf1794b28dcc476b122c</SHA>
      <PATCHEDFILES>
        <FILE>installer/roles/kubernetes/templates/deployment.yml.j2</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>resolve a permissions error related to redis see: https://github.com/ansible/awx/issues/9401</MESSAGE>
      <SHA>3358e568b575674448c80272fae1d4423a27a899</SHA>
      <PATCHEDFILES>
        <FILE>installer/roles/kubernetes/templates/deployment.yml.j2</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
