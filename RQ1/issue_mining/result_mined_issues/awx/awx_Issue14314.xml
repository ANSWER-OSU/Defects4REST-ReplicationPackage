<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>14314</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/14314</ISSUEURL>
  <TITLE>AWX DB migration gets in loop and upgrade never ends</TITLE>
  <DESCRIPTION>### Please confirm the following - [X] I agree to follow this project's [code of conduct](https://docs.ansible.com/ansible/latest/community/code_of_conduct.html). - [X] I have checked the [current issues](https://github.com/ansible/awx/issues) for duplicates. - [X] I understand that AWX is open source software provided for free and that I might not receive a timely response. - [X] I am **NOT** reporting a (potential) security vulnerability. (These should be emailed to `security@ansible.com` instead.) ### Bug Summary When upgrading from 22.3 to 22.5, we noticed that the upgrade took much longer than expected, was stuck in the DB migration process, and didn't allow AWX to start. This upgrade included one of the [database migration tasks](https://github.com/ansible/awx/blob/devel/awx/main/migrations/0185_move_JSONBlob_to_JSONField.py). This issue happened because of a bug in AWX DB migration logic. When we upgrade AWX, the AWX operator starts the DB migration. The [following script](https://github.com/ansible/awx/blob/7e4cf859f59aaa865985ade13a51a37e3c41e8f6/tools/ansible/roles/dockerfile/files/wait-for-migrations#L8) is responsible for the retry mechanism. The script makes a total of 30 retries to check the status of AWX migration. It will wait for a maximum of 60 seconds (TIMEOUT=60) for each attempt. However, an exponential backoff strategy dynamically calculates the waiting time between attempts. The next_sleep function calculates the waiting time before the next attempt. It starts with MIN_SLEEP (0.5 seconds) and doubles the value with each attempt until it reaches MAX_SLEEP (30 seconds). So, the waiting times between attempts will be as follows: _______ Attempt 1: 0.5 seconds Attempt 2: 1 second Attempt 3: 2 seconds Attempt 4: 4 seconds Attempt 5: 8 seconds Attempt 6: 16 seconds Attempt 7: 30 seconds (maximum reached) Attempt 8 and beyond: 30 seconds (maximum reached) ______ After the 7th attempt, the waiting time will remain constant at 30 seconds since it has reached the maximum configured value. Suppose none of the attempts succeeds within the specified TIMEOUT period (60 seconds). In that case, the script will fail with an error message &quot;ERROR: Database migrations not applied&quot; and return with exit code 1 and stop the migration task. It means that if we have a large DB that requires more time to finish the particular migration task, the migration will never be finished since it will be stuck in a loop. **The workaround:** To resolve this issue, we found a workaround with the AWX community and implemented it. To go with a workaround, you should do the following actions: 1. In the K8s deployments in the AWX namespace: Scale in **awx-operator-controller-manager** replicas to 0 Scale in **awx-task** replicas to 0 Scale in **awx-web** replicas to 0 2. In awx-task deployment, find the following section: &gt; - name: awx-task &gt; image: pegasus-docker.artifactory.cyberng.com/pegasus-awx:22.5.0 &gt; args: &gt; - /usr/bin/launch_awx_task.sh &gt; env: &gt; - name: AWX_COMPONENT &gt; value: task &gt; - name: SUPERVISOR_CONFIG_PATH &gt; value: /etc/supervisord_task.conf &gt; - name: AWX_SKIP_MIGRATIONS &gt; value: '1' &gt; - name: MY_POD_UID &gt; valueFrom: &gt; fieldRef: &gt; apiVersion: v1 &gt; fieldPath: metadata.uid And replace the args section with &gt; - name: awx-task &gt; image: pegasus-docker.artifactory.cyberng.com/pegasus-awx:22.5.0 &gt; args: &gt; - awx-manage &gt; - migrate &gt; - --noinput &gt; env: &gt; - name: AWX_COMPONENT &gt; value: task &gt; - name: SUPERVISOR_CONFIG_PATH &gt; value: /etc/supervisord_task.conf &gt; - name: AWX_SKIP_MIGRATIONS &gt; value: '1' &gt; - name: MY_POD_UID &gt; valueFrom: &gt; fieldRef: &gt; apiVersion: v1 &gt; fieldPath: metadata.uid 3. Scale-out awx-task deployment to 1 replica. You should see the following message in the task container logs: &lt;img width=&quot;1178&quot; alt=&quot;image&quot; src=&quot;https://github.com/ansible/awx/assets/79839819/d10fb37c-59b3-42ed-b3e8-300d625369ed&quot;&gt; 4. Wait till the migration is finished. The pod should finish running, and you should see the following log, which shows that the migration is finished: &lt;img width=&quot;1175&quot; alt=&quot;image&quot; src=&quot;https://github.com/ansible/awx/assets/79839819/cc4b051e-d598-4f9b-b248-bc83c2f0643d&quot;&gt; 5. Scale out the **awx-operator-controller-manager** deployment to 1 replica. It will automatically delete the task you modified and scale out the AWX deployments. ### AWX version 22.5 ### Select the relevant components - [ ] UI - [ ] UI (tech preview) - [X] API - [ ] Docs - [ ] Collection - [X] CLI - [X] Other ### Installation method kubernetes ### Modifications no ### Ansible version _No response_ ### Operating system _No response_ ### Web browser _No response_ ### Steps to reproduce Upgrade the AWX with the large database from 22.3 to 22.5 ### Expected results DB migration task is running without interruption ### Actual results DB migration task is interrupted with the pod restart ### Additional information _No response_</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>71</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Add customizable batch_size for cleanup_activitystream and cleanup_jobs (#14412) Signed-off-by: Daniel Gon√ßalves &lt;daniel.gonc@lves.fr&gt;</MESSAGE>
    <SHA>56878b49106e778c3371dce9448c31b787c75801</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Make wait-for-migrations wait forever fixes https://github.com/ansible/awx/issues/14314</MESSAGE>
      <SHA>1f341c1fb436c180a548b255b11af5ffeed687e3</SHA>
      <PATCHEDFILES>
        <FILE>tools/ansible/roles/dockerfile/files/launch_awx_web.sh</FILE>
        <FILE>tools/ansible/roles/dockerfile/files/wait-for-migrations</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Make wait-for-migrations wait forever fixes https://github.com/ansible/awx/issues/14314</MESSAGE>
      <SHA>e4e93522774f1489ffd61a86d170cef5ca3112c2</SHA>
      <PATCHEDFILES>
        <FILE>tools/ansible/roles/dockerfile/files/launch_awx_web.sh</FILE>
        <FILE>tools/ansible/roles/dockerfile/files/wait-for-migrations</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Make wait-for-migrations wait forever fixes https://github.com/ansible/awx/issues/14314</MESSAGE>
      <SHA>bea3d31f892de687828a47cdd14473efd637c63d</SHA>
      <PATCHEDFILES>
        <FILE>tools/ansible/roles/dockerfile/files/wait-for-migrations</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Make wait-for-migrations wait forever fixes https://github.com/ansible/awx/issues/14314 Removing retry attempt limit when waiting for migration to complete.</MESSAGE>
      <SHA>b5f95c4d0abac7feb8be943bcf9906b999ec4bea</SHA>
      <PATCHEDFILES>
        <FILE>tools/ansible/roles/dockerfile/files/wait-for-migrations</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
