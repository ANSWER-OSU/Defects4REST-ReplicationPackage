<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5717</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/5717</ISSUEURL>
  <TITLE>awx cli schedules create cannot create schedule if the user is of type Normal User with required permissions.</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY awx cli schedules create cannot create schedule if the user is of type Normal User with required permissions on the object or even with Organization admin role. Currently the user needs to be a System Administrator type to create the schedule. From the UI the Normal User with permission can create the schedule. POST at the /api/v2/schedules/ endpoint is only available for the user with System Administrator type which is the endpoint used by awx schedules create command. ##### ENVIRONMENT * AWX version: Tower 3.6.2 * AWX install method: Tower 3.6.2 cluster installed with online installer * Ansible version: 2.9.1 * Operating System: RHEL 8 * Web Browser: Chrome 79 ##### STEPS TO REPRODUCE * Create a normal user: * Assign permission to a job template or set the user role as Organization admin. * Try to create the schedule for the job template using awx cli. ``` awx --conf.host https://tower.ishwar.io --conf.username test --conf.password 'PASSWORD' schedules create --name=test --unified_job_template=111 --rrule=&quot;DTSTART;TZID=America/New_York:20180208T221500 RRULE:FREQ=MONTHLY;INTERVAL=1;BYDAY=TH;BYSETPOS=3&quot; -vvv ``` * Change the user type to system administrator and rerun the command. ##### EXPECTED RESULTS ``` DEBUG:urllib3.connectionpool:Starting new HTTPS connection (1): tower.ishwar.io:443 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/ HTTP/1.1&quot; 200 188 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/&quot; elapsed: 0:00:00.208793 DEBUG:awxkit.api.registry:Retrieved &lt;class 'awxkit.api.pages.api.ApiV2'&gt; by url: /api/v2/ DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/v2/ HTTP/1.1&quot; 200 1688 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/v2/&quot; elapsed: 0:00:00.047443 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/ HTTP/1.1&quot; 200 188 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/&quot; elapsed: 0:00:00.052170 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;POST /api/login/ HTTP/1.1&quot; 302 0 DEBUG:awxkit.api.client:&quot;POST https://tower.ishwar.io/api/login/&quot; elapsed: 0:00:00.247407 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/ HTTP/1.1&quot; 200 188 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/&quot; elapsed: 0:00:00.080558 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/ HTTP/1.1&quot; 200 188 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/&quot; elapsed: 0:00:00.084587 DEBUG:awxkit.api.registry:Retrieved &lt;class 'awxkit.api.pages.schedules.Schedules'&gt; by url: /api/v2/schedules/ DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;OPTIONS /api/v2/schedules/ HTTP/1.1&quot; 200 13449 DEBUG:awxkit.api.client:&quot;OPTIONS https://tower.ishwar.io/api/v2/schedules/&quot; elapsed: 0:00:00.101736 DEBUG:awxkit.api.registry:Retrieved &lt;class 'awxkit.api.pages.schedules.Schedules'&gt; by url: /api/v2/schedules/ DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;OPTIONS /api/v2/schedules/1/ HTTP/1.1&quot; 200 7915 DEBUG:awxkit.api.client:&quot;OPTIONS https://tower.ishwar.io/api/v2/schedules/1/&quot; elapsed: 0:00:00.120726 awx: unrecognized arguments: -vvv DEBUG:awxkit.api.registry:Retrieved &lt;class 'awxkit.api.pages.schedules.Schedules'&gt; by url: /api/v2/schedules/ DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;POST /api/v2/schedules/ HTTP/1.1&quot; 201 1552 DEBUG:awxkit.api.client:&quot;POST https://tower.ishwar.io/api/v2/schedules/&quot; elapsed: 0:00:00.156802 DEBUG:awxkit.api.registry:Retrieved &lt;class 'awxkit.api.pages.schedules.Schedules'&gt; by url: /api/v2/schedules/ { &quot;rrule&quot;: &quot;DTSTART;TZID=America/New_York:20180208T221500 RRULE:FREQ=MONTHLY;INTERVAL=1;BYDAY=TH;BYSETPOS=3&quot;, &quot;id&quot;: 14, &quot;type&quot;: &quot;schedule&quot;, &quot;url&quot;: &quot;/api/v2/schedules/14/&quot;, &quot;summary_fields&quot;: { &quot;unified_job_template&quot;: { &quot;id&quot;: 111, &quot;name&quot;: &quot;test-schedule&quot;, &quot;description&quot;: &quot;&quot;, &quot;unified_job_type&quot;: &quot;job&quot; }, &quot;created_by&quot;: { &quot;id&quot;: 121, &quot;username&quot;: &quot;test&quot;, &quot;first_name&quot;: &quot;test&quot;, &quot;last_name&quot;: &quot;test&quot; }, &quot;modified_by&quot;: { &quot;id&quot;: 121, &quot;username&quot;: &quot;test&quot;, &quot;first_name&quot;: &quot;test&quot;, &quot;last_name&quot;: &quot;test&quot; }, &quot;user_capabilities&quot;: { &quot;edit&quot;: true, &quot;delete&quot;: true }, &quot;inventory&quot;: { &quot;id&quot;: 29, &quot;name&quot;: &quot;Demo Inventory&quot;, &quot;description&quot;: &quot;&quot;, &quot;has_active_failures&quot;: false, &quot;total_hosts&quot;: 1, &quot;hosts_with_active_failures&quot;: 0, &quot;total_groups&quot;: 0, &quot;groups_with_active_failures&quot;: 0, &quot;has_inventory_sources&quot;: false, &quot;total_inventory_sources&quot;: 0, &quot;inventory_sources_with_failures&quot;: 0, &quot;organization_id&quot;: 1, &quot;kind&quot;: &quot;&quot;, &quot;insights_credential_id&quot;: null } }, &quot;created&quot;: &quot;2020-01-21T07:31:19.312383Z&quot;, &quot;modified&quot;: &quot;2020-01-21T07:31:19.312398Z&quot;, &quot;name&quot;: &quot;test&quot;, &quot;description&quot;: &quot;&quot;, &quot;extra_data&quot;: {}, &quot;inventory&quot;: null, &quot;scm_branch&quot;: null, &quot;job_type&quot;: null, &quot;job_tags&quot;: null, &quot;skip_tags&quot;: null, &quot;limit&quot;: null, &quot;diff_mode&quot;: null, &quot;verbosity&quot;: null, &quot;unified_job_template&quot;: 111, &quot;enabled&quot;: true, &quot;dtstart&quot;: &quot;2018-02-16T03:15:00Z&quot;, &quot;dtend&quot;: null, &quot;next_run&quot;: &quot;2020-02-21T03:15:00Z&quot;, &quot;timezone&quot;: &quot;America/New_York&quot;, &quot;until&quot;: &quot;&quot; } ``` ##### ACTUAL RESULTS ``` DEBUG:urllib3.connectionpool:Starting new HTTPS connection (1): tower.ishwar.io:443 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/ HTTP/1.1&quot; 200 188 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/&quot; elapsed: 0:00:00.173558 DEBUG:awxkit.api.registry:Retrieved &lt;class 'awxkit.api.pages.api.ApiV2'&gt; by url: /api/v2/ DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/v2/ HTTP/1.1&quot; 200 1688 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/v2/&quot; elapsed: 0:00:00.046141 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/ HTTP/1.1&quot; 200 188 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/&quot; elapsed: 0:00:00.050566 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;POST /api/login/ HTTP/1.1&quot; 302 0 DEBUG:awxkit.api.client:&quot;POST https://tower.ishwar.io/api/login/&quot; elapsed: 0:00:00.247518 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/ HTTP/1.1&quot; 200 188 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/&quot; elapsed: 0:00:00.088723 DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;GET /api/ HTTP/1.1&quot; 200 188 DEBUG:awxkit.api.client:&quot;GET https://tower.ishwar.io/api/&quot; elapsed: 0:00:00.081436 DEBUG:awxkit.api.registry:Retrieved &lt;class 'awxkit.api.pages.schedules.Schedules'&gt; by url: /api/v2/schedules/ DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;OPTIONS /api/v2/schedules/ HTTP/1.1&quot; 200 11598 DEBUG:awxkit.api.client:&quot;OPTIONS https://tower.ishwar.io/api/v2/schedules/&quot; elapsed: 0:00:00.088985 DEBUG:awxkit.api.registry:Retrieved &lt;class 'awxkit.api.pages.schedules.Schedules'&gt; by url: /api/v2/schedules/ DEBUG:urllib3.connectionpool:https://tower.ishwar.io:443 &quot;OPTIONS /api/v2/schedules/1/ HTTP/1.1&quot; 200 6065 DEBUG:awxkit.api.client:&quot;OPTIONS https://tower.ishwar.io/api/v2/schedules/1/&quot; elapsed: 0:00:00.112443 usage: awx schedules [-h] action ... positional arguments: action list get modify delete optional arguments: -h, --help show this help message and exit awx schedules: argument action: invalid choice: 'create' (choose from 'list', 'get', 'modify', 'delete') ```</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>49</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #6152 from ryanpetrello/venv-realpath respect home directory symlinks for BASE_VENV_PATH Reviewed-by: Bill Nottingham https://github.com/wenottingham</MESSAGE>
    <SHA>e34e88549f384f88150bdedffb12e0e1187c89dd</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>fix a bug in OPTIONS /api/v2/schedules/ a side effect of this bug is that `awx schedules create` doesn't work properly for non-admin users (i.e., users who have execute access for a JT) see: https://github.com/ansible/awx/issues/5717</MESSAGE>
      <SHA>cd1ff6b16a0d4583e0a05a4e136efa81b26d0ac2</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/access.py</FILE>
        <FILE>awx/main/tests/functional/api/test_schedules.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
