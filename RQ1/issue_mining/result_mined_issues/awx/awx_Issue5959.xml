<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>5959</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/5959</ISSUEURL>
  <TITLE>command module has not applied the become: true flag</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY Become flag on playbook and task does not appear to take effect. Command is run without sudo privileges ##### ENVIRONMENT * AWX version: 9.2.0 (also seen on 9.1.0) * AWX install method: docker on linux * Ansible version: 2.9.3 * Operating System: Centos * Web Browser: Chrome 80.0.3987.106 ##### STEPS TO REPRODUCE playbook.yml: ``` --- - name: Check that this is only run once hosts: all become: true gather_facts: false tasks: - name: Have we run before when: _deploy_common_has_run is not defined import_role: name: role_ansible_prereqs - name: install Docker based Oracle hosts: all become: true tasks: - name: Have we run before when: _deploy_common_has_run is not defined block: - import_role: name: role_ca_certificates ``` role_ca_certificates/tasks/linux.yml ``` --- - name: Load OS Family specific defaults include_vars: &quot;defaults-{{ ansible_os_family }}.yml&quot; - name: Install CA Certificates package become: true package: name: ca-certificates state: present - name: Enable Cert Management (RHEL 6) when: - ansible_os_family | lower == 'redhat' - ansible_distribution_major_version | int == 6 or ansible_distribution_major_version | int == 7 block: - name: &quot;Check CA Trust Expansion state&quot; become: true command: &quot;/usr/bin/update-ca-trust check&quot; check_mode: false changed_when: false register: result ... ``` User has been created with: PRIVILEGE ESCALATION METHOD: sudo PRIVILEGE ESCALATION USERNAME: &lt;set&gt; PRIVILEGE ESCALATION PASSWORD: &lt;set&gt; Target VM is a Centos7 based machine. ##### EXPECTED RESULTS &lt;!-- What did you expect to happen when running the steps above? --&gt; /usr/bin/update-ca-trust check should operate without issue. ##### ACTUAL RESULTS &lt;!-- What actually happened? --&gt; The Check CA Trust Expansion state stage fails due to permission denied. There is no evidence that the stage was run with escalated privileges. ``` { &quot;changed&quot;: false, &quot;end&quot;: &quot;2020-02-17 17:12:16.558452&quot;, &quot;stdout&quot;: &quot;&quot;, &quot;cmd&quot;: [ &quot;/usr/bin/update-ca-trust&quot;, &quot;check&quot; ], &quot;delta&quot;: &quot;0:00:00.746504&quot;, &quot;stderr&quot;: &quot;p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt: Permission denied\np11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem: Permission denied\np11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/email-ca-bundle.pem: Permission denied\np11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/objsign-ca-bundle.pem: Permission denied\np11-kit: couldn't create file: /etc/pki/ca-trust/extracted/java/cacerts: Permission denied&quot;, &quot;rc&quot;: 1, &quot;invocation&quot;: { &quot;module_args&quot;: { &quot;creates&quot;: null, &quot;executable&quot;: null, &quot;_uses_shell&quot;: false, &quot;strip_empty_ends&quot;: true, &quot;_raw_params&quot;: &quot;/usr/bin/update-ca-trust check&quot;, &quot;removes&quot;: null, &quot;argv&quot;: null, &quot;warn&quot;: true, &quot;chdir&quot;: null, &quot;stdin_add_newline&quot;: true, &quot;stdin&quot;: null } }, &quot;start&quot;: &quot;2020-02-17 17:12:15.811948&quot;, &quot;msg&quot;: &quot;non-zero return code&quot;, &quot;stdout_lines&quot;: [], &quot;stderr_lines&quot;: [ &quot;p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt: Permission denied&quot;, &quot;p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem: Permission denied&quot;, &quot;p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/email-ca-bundle.pem: Permission denied&quot;, &quot;p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/objsign-ca-bundle.pem: Permission denied&quot;, &quot;p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/java/cacerts: Permission denied&quot; ], &quot;_ansible_no_log&quot;: false } ``` I know that I can run the command with sudo and it will work: ``` [dev@jm5_vm1 ~]$ /usr/bin/update-ca-trust check p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt: Permission denied p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem: Permission denied p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/email-ca-bundle.pem: Permission denied p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/pem/objsign-ca-bundle.pem: Permission denied p11-kit: couldn't create file: /etc/pki/ca-trust/extracted/java/cacerts: Permission denied [dev@jm5_vm1 ~]$ sudo /usr/bin/update-ca-trust check [sudo] password for dev: [dev@jm5_vm1 ~]$ ``` So why does AWX not run command and obey the become: true flag ##### ADDITIONAL INFORMATION &lt;!-- Include any links to sosreport, database dumps, screenshots or other information. --&gt;</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>2</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #5955 from ansible/5938-4.2-RemovesTower Removes references to Tower in favor of Controller</MESSAGE>
    <SHA>33fcd9d416d581e5fcb1635372bb1deabeeb3e22</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #5959 from kdelee/backport_metrics_500_421 [4.2.z] Backport fixes for metrics 500 to release 4.2</MESSAGE>
      <SHA>4d5433e32b4365de3c441a0b81b266d9d295948d</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/analytics/subsystem_metrics.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
