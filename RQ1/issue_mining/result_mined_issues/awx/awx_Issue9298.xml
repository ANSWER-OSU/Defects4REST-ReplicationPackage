<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>9298</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/9298</ISSUEURL>
  <TITLE>custom_venvs fails in kubernetes due to cryptography dependency</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY When using custom_venvs in kubernetes, the initcontainer fails to install ansible. This is because pip cannot install the cryptography module which is due to a change in the cryptography module requiring rust. (see https://github.com/pyca/cryptography/issues/5771) ##### ENVIRONMENT * AWX version: 17.0.1 * AWX install method: Kubernetes * Ansible version: * Operating System: * Web Browser: ##### STEPS TO REPRODUCE custom_venvs: - name: techops python: python3 python_modules: - pyvmomi - mysql-connector - argparse - apypie python_ansible_version: 2.9.17 ##### EXPECTED RESULTS Build completes ##### ACTUAL RESULTS Traceback (most recent call last): File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt; File &quot;/tmp/pip-build-ud_ezxyu/cryptography/setup.py&quot;, line 14, in &lt;module&gt; from setuptools_rust import RustExtension ModuleNotFoundError: No module named 'setuptools_rust' ##### ADDITIONAL INFORMATION This can be fixed by upgrading pip in the file awx-17.0.1/installer/roles/kubernetes/templates.deployment.yml.j2 --- deployment.yml.j2 2021-02-12 14:03:25.353805414 +0000 +++ deployment-new.yml.j2 2021-02-12 14:56:47.389720404 +0000 @@ -150,6 +150,7 @@ virtualenv -p {{ custom_venv.python | default(custom_venvs_python) }} \ {{ custom_venvs_path }}/{{ custom_venv.name }} &amp;&amp; source {{ custom_venvs_path }}/{{ custom_venv.name }}/bin/activate &amp;&amp; + {{ custom_venvs_path }}/{{ custom_venv.name }}/bin/pip install {{ trusted_hosts }} -U psutil --upgrade pip &amp;&amp; {{ custom_venvs_path }}/{{ custom_venv.name }}/bin/pip install {{ trusted_hosts }} -U psutil \ &quot;ansible=={{ custom_venv.python_ansible_version }}&quot; &amp;&amp; {% if custom_venv.python_modules is defined %}</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #9284 from sean-m-sullivan/fix-awx_collection-docs Fix awx collection docs Reviewed-by: https://github.com/apps/softwarefactory-project-zuul</MESSAGE>
    <SHA>949c77754677d3b4e17d76e4724ef6003a6b10ad</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #9300 from darrenjones24/devel Fix #9298 by upgrading pip allowing use of custom_venvs Reviewed-by: https://github.com/apps/softwarefactory-project-zuul</MESSAGE>
      <SHA>2e179609d9cafac277f9fee889d79c7a9e9ac9e6</SHA>
      <PATCHEDFILES>
        <FILE>installer/roles/kubernetes/templates/deployment.yml.j2</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
