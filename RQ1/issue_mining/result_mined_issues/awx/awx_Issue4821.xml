<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>4821</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/4821</ISSUEURL>
  <TITLE>AWX install fails due to libselinux-python error</TITLE>
  <DESCRIPTION>##### ISSUE TYPE - Bug Report ##### SUMMARY I'm trying to install Ansible AWX on my local environment (RHEL 7 Maipo). But during the install run, it fails with the &quot;libselinux-python&quot; error. ##### ENVIRONMENT * AWX version: 7.0.0 * AWX install method: docker on linux, * Ansible version: 2.8.5 * Operating System: RHEL 7.5 (Maipo). Kernel 3.10.0-957.27.2.el7.x86_64 * Web Browser: Chrome Version 76.0.3809.132 ##### STEPS TO REPRODUCE 1) Install Python 36 packages (System already had Python 2.7 but was having difficulties with Python Pip and wheel). Hence the need to install Python 36. rh-python36-python-libs-3.6.3-7.el7.x86_64 rh-python36-runtime-2.0-1.el7.x86_64 rh-python36-python-setuptools-36.5.0-1.el7.noarch rh-python36-python-pip-9.0.1-2.el7.noarch rh-python36-python-devel-3.6.3-7.el7.x86_64 rh-python36-python-3.6.3-7.el7.x86_64 rh-python36-python-virtualenv-15.1.0-2.el7.noarch 2) Create a virtualenv &quot;awxenv. 3) Using pip install the below packages --&gt;pip -V pip 19.2.3 from /usr/mware/pythonApps/awxenv/lib/python3.6/site-packages/pip (python 3.6) --&gt;pip list Package Version ---------------- --------- ansible 2.8.5 asn1crypto 0.24.0 bcrypt 3.1.7 cached-property 1.5.1 certifi 2019.9.11 cffi 1.12.3 chardet 3.0.4 cryptography 2.7 docker 3.7.3 docker-compose 1.24.1 docker-pycreds 0.4.0 dockerpty 0.4.1 docopt 0.6.2 idna 2.7 Jinja2 2.10.1 jsonschema 2.6.0 MarkupSafe 1.1.1 paramiko 2.6.0 pip 19.2.3 pycparser 2.19 PyNaCl 1.3.0 PyYAML 3.13 requests 2.20.1 setuptools 28.8.0 six 1.12.0 texttable 0.9.1 urllib3 1.24.3 websocket-client 0.56.0 wheel 0.29.0 4) Cloned AWX Git repo. 5) Went inside the installer directory. Updated &quot;inventory&quot; to use python3 localhost ansible_connection=local ansible_python_interpreter=&quot;/usr/bin/env python3&quot; 6) Ran the below command ansible-playbook -i inventory install.yml 7) Returned the error TASK [local_docker : Create Docker Compose Configuration] ***************************************************************************************************************************** failed: [localhost] (item=environment.sh) =&gt; {&quot;ansible_loop_var&quot;: &quot;item&quot;, &quot;changed&quot;: false, &quot;checksum&quot;: &quot;e369ef7b0186eef5f38dc16027878a3a6a0d9f0c&quot;, &quot;item&quot;: &quot;environment.sh&quot;, &quot;msg&quot;: &quot;Aborting, target uses selinux but python bindings (libselinux-python) aren't installed!&quot;} failed: [localhost] (item=credentials.py) =&gt; {&quot;ansible_loop_var&quot;: &quot;item&quot;, &quot;changed&quot;: false, &quot;checksum&quot;: &quot;9d8c48ec0e65f6cc2aa8d1e2720f826b0f65551a&quot;, &quot;item&quot;: &quot;credentials.py&quot;, &quot;msg&quot;: &quot;Aborting, target uses selinux but python bindings (libselinux-python) aren't installed!&quot;} failed: [localhost] (item=docker-compose.yml) =&gt; {&quot;ansible_loop_var&quot;: &quot;item&quot;, &quot;changed&quot;: false, &quot;checksum&quot;: &quot;35538f46d9cb24e817a8754db4c4f2431c126ec3&quot;, &quot;item&quot;: &quot;docker-compose.yml&quot;, &quot;msg&quot;: &quot;Aborting, target uses selinux but python bindings (libselinux-python) aren't installed!&quot;} PLAY RECAP **************************************************************************************************************************************************************************** localhost : ok=6 changed=0 unreachable=0 failed=1 skipped=78 rescued=0 ignored=0 8) Verified that the selinux packages are already installed. --&gt;rpm -qa |grep selinux libselinux-2.5-14.1.el7.x86_64 selinux-policy-3.13.1-229.el7_6.6.noarch container-selinux-2.77-1.el7_6.noarch libselinux-python-2.5-14.1.el7.x86_64 libselinux-utils-2.5-14.1.el7.x86_64 selinux-policy-targeted-3.13.1-229.el7_6.6.noarch ##### EXPECTED RESULTS I expected the playbook to complete the setup of docker image, bring up the container and run awx instance. ##### ACTUAL RESULTS Playbok failed to complete the run and threw the below error. TASK [local_docker : Create /tmp/awxcompose directory] ******************************************************************************************************************************** ok: [localhost] TASK [local_docker : Create Docker Compose Configuration] ***************************************************************************************************************************** failed: [localhost] (item=environment.sh) =&gt; {&quot;ansible_loop_var&quot;: &quot;item&quot;, &quot;changed&quot;: false, &quot;checksum&quot;: &quot;e369ef7b0186eef5f38dc16027878a3a6a0d9f0c&quot;, &quot;item&quot;: &quot;environment.sh&quot;, &quot;msg&quot;: &quot;Aborting, target uses selinux but python bindings (libselinux-python) aren't installed!&quot;} failed: [localhost] (item=credentials.py) =&gt; {&quot;ansible_loop_var&quot;: &quot;item&quot;, &quot;changed&quot;: false, &quot;checksum&quot;: &quot;9d8c48ec0e65f6cc2aa8d1e2720f826b0f65551a&quot;, &quot;item&quot;: &quot;credentials.py&quot;, &quot;msg&quot;: &quot;Aborting, target uses selinux but python bindings (libselinux-python) aren't installed!&quot;} failed: [localhost] (item=docker-compose.yml) =&gt; {&quot;ansible_loop_var&quot;: &quot;item&quot;, &quot;changed&quot;: false, &quot;checksum&quot;: &quot;35538f46d9cb24e817a8754db4c4f2431c126ec3&quot;, &quot;item&quot;: &quot;docker-compose.yml&quot;, &quot;msg&quot;: &quot;Aborting, target uses selinux but python bindings (libselinux-python) aren't installed!&quot;} PLAY RECAP **************************************************************************************************************************************************************************** localhost : ok=6 changed=0 unreachable=0 failed=1 skipped=78 rescued=0 ignored=0 ##### ADDITIONAL INFORMATION 1) I tried restoring the &quot;inventory&quot; file to default to use the OS default Python (Python 2.7). Did not work. 2) Tried updating system python to Python3 by adding python3 to &quot;/usr/local/sbin/python&quot;. Did not work. 3) Tried changing /usr/bin/python to point to python3 but that broke my OS (yum failed and other issues.) 2 things that I noticed i) installing &quot;libselinux-python-2.5-14.1.el7.x86_64&quot; package creates a &quot;selinux&quot; folder under &quot;/usr/lib64/python2.7/site-packages&quot; but not under &quot;/opt/rh/rh-python36/root/usr/lib64/python3.6/site-packages/ &quot; (which is the python3 installation location). This is despite the fact that python3 is the default python as explained above (Addition Information section). ii) Python virtualenv does not have &quot;selinux&quot; module installed. If I install it, it causes virtualenv to crash. Ansible commands fail until I remove &quot;selinux&quot; python module. Error I get is --&gt;ansible Traceback (most recent call last): File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt; AttributeError: module 'site' has no attribute 'getsitepackages' ERROR! Unexpected Exception, this is probably a bug: Command '['/usr/bin/python3', '-c', 'import json, site; print(json.dumps(site.getsitepackages()))']' returned non-zero exit status 1. the full traceback was: Traceback (most recent call last): File &quot;/usr/mware/pythonApps/awxenv/bin/ansible&quot;, line 90, in &lt;module&gt; mycli = getattr(__import__(&quot;ansible.cli.%s&quot; % sub, fromlist=[myclass]), myclass) File &quot;/usr/mware/pythonApps/awxenv/lib/python3.6/site-packages/ansible/cli/__init__.py&quot;, line 25, in &lt;module&gt; from ansible.parsing.dataloader import DataLoader File &quot;/usr/mware/pythonApps/awxenv/lib/python3.6/site-packages/ansible/parsing/dataloader.py&quot;, line 17, in &lt;module&gt; from ansible.module_utils.basic import is_executable File &quot;/usr/mware/pythonApps/awxenv/lib/python3.6/site-packages/ansible/module_utils/basic.py&quot;, line 74, in &lt;module&gt; import selinux File &quot;/usr/mware/pythonApps/awxenv/lib/python3.6/site-packages/selinux/__init__.py&quot;, line 91, in &lt;module&gt; check_system_sitepackages() File &quot;/usr/mware/pythonApps/awxenv/lib/python3.6/site-packages/selinux/__init__.py&quot;, line 81, in check_system_sitepackages system_sitepackages = get_system_sitepackages() File &quot;/usr/mware/pythonApps/awxenv/lib/python3.6/site-packages/selinux/__init__.py&quot;, line 71, in get_system_sitepackages &quot;import json, site; print(json.dumps(site.getsitepackages()))&quot; File &quot;/opt/rh/rh-python36/root/usr/lib64/python3.6/subprocess.py&quot;, line 336, in check_output **kwargs).stdout File &quot;/opt/rh/rh-python36/root/usr/lib64/python3.6/subprocess.py&quot;, line 418, in run output=stdout, stderr=stderr) subprocess.CalledProcessError: Command '['/usr/bin/python3', '-c', 'import json, site; print(json.dumps(site.getsitepackages()))']' returned non-zero exit status 1. Selinux Python module is selinux 0.1.6 Any help would be really appreciated. Thanks, Shemlik</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>0</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #4827 from chrismeyersfsu/3_8_2-bump-foreman 3 8 2 bump foreman</MESSAGE>
    <SHA>89646095e4a96da31b0aeeef935d7832f45ab24d</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Merge pull request #4821 from chrismeyersfsu/backport_3_8_2-analytics-cleanup removed unused analytics metrics</MESSAGE>
      <SHA>ab338f6b2447bc56120550480069d07ff92fc2c2</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/analytics/collectors.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
