<?xml version="1.0" ?>
<ISSUE>
  <ISSUENO>13301</ISSUENO>
  <ISSUEURL>https://github.com/ansible/awx/issues/13301</ISSUEURL>
  <TITLE>ValueError: Duplicated timeseries in CollectorRegistry</TITLE>
  <DESCRIPTION>### Please confirm the following - [X] I agree to follow this project's [code of conduct](https://docs.ansible.com/ansible/latest/community/code_of_conduct.html). - [X] I have checked the [current issues](https://github.com/ansible/awx/issues) for duplicates. - [X] I understand that AWX is open source software provided for free and that I might not receive a timely response. ### Bug Summary While upgrading my AWX system from 21.5.0 to 21.10.0 the following error occurred: ``` tools_awx_1 | ValueError: Duplicated timeseries in CollectorRegistry: {'awx01_example_com_messages_received'} tools_awx_1 | 2022-12-07 16:21:09,927 INFO exited: wsbroadcast (exit status 1; not expected) tools_awx_1 | 2022-12-07 16:21:09,927 INFO exited: wsbroadcast (exit status 1; not expected) ``` It seems that the wsbroadcast process is dying with this error and finally the tools_awx_1 container dies as well. Changing the required *prometheus-client* back to 0.7.1 fixes (or workarounds) this error. ``` --- a/requirements/requirements.txt +++ b/requirements/requirements.txt @@ -253,7 +253,7 @@ pexpect==4.7.0 # ansible-runner pkgconfig==1.5.5 # via -r /awx_devel/requirements/requirements.in -prometheus-client==0.15.0 +prometheus-client==0.7.1 # via -r /awx_devel/requirements/requirements.in psutil==5.9.4 # via -r /awx_devel/requirements/requirements.in ``` This might be related to: https://github.com/prometheus/client_python/issues/815 ### AWX version 21.10.0 ### Select the relevant components - [ ] UI - [X] API - [ ] Docs - [ ] Collection - [ ] CLI - [ ] Other ### Installation method docker development environment ### Modifications no ### Ansible version 2.12.2 ### Operating system Debian 11 ### Web browser Firefox ### Steps to reproduce I have a setup with two controller nodes, awx01.example.com and awx02.example.com. The error message mentions always the other node. To reproduce the problem at least two controller nodes are needed, I guess. ### Expected results The Prometheus client is registering the nodes properly. ### Actual results ``` tools_awx_1 | Adding {'awx01.example.com'} to websocket broadcast list tools_awx_1 | Traceback (most recent call last): tools_awx_1 | File &quot;/usr/local/bin/awx-manage&quot;, line 8, in &lt;module&gt; tools_awx_1 | sys.exit(manage()) tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/awx/__init__.py&quot;, line 201, in manage tools_awx_1 | execute_from_command_line(sys.argv) tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/django/core/management/__init__.py&quot;, line 419, in execute_from_command_line tools_awx_1 | utility.execute() tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/django/core/management/__init__.py&quot;, line 413, in execute tools_awx_1 | self.fetch_command(subcommand).run_from_argv(self.argv) tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv tools_awx_1 | self.execute(*args, **cmd_options) tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/django/core/management/base.py&quot;, line 398, in execute tools_awx_1 | output = self.handle(*args, **options) tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/awx/main/management/commands/run_wsbroadcast.py&quot;, line 170, in handle tools_awx_1 | loop.run_until_complete(task) tools_awx_1 | File &quot;/usr/lib64/python3.9/asyncio/base_events.py&quot;, line 647, in run_until_complete tools_awx_1 | return future.result() tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/awx/main/wsbroadcast.py&quot;, line 198, in run_per_host_websocket tools_awx_1 | stats = self.stats_mgr.new_remote_host_stats(h) tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/awx/main/analytics/broadcast_websocket.py&quot;, line 76, in new_remote_host_stats tools_awx_1 | self._stats[remote_hostname] = BroadcastWebsocketStats(self._local_hostname, remote_hostname) tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/awx/main/analytics/broadcast_websocket.py&quot;, line 124, in __init__ tools_awx_1 | self._messages_received = Gauge( tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/prometheus_client/metrics.py&quot;, line 365, in __init__ tools_awx_1 | super().__init__( tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/prometheus_client/metrics.py&quot;, line 143, in __init__ tools_awx_1 | registry.register(self) tools_awx_1 | File &quot;/var/lib/awx/venv/awx/lib64/python3.9/site-packages/prometheus_client/registry.py&quot;, line 43, in register tools_awx_1 | raise ValueError( tools_awx_1 | ValueError: Duplicated timeseries in CollectorRegistry: {'awx01_example_com_messages_received'} ``` ### Additional information _No response_</DESCRIPTION>
  <REPONAME>awx</REPONAME>
  <TIMEDIFFERENCEDAYS>6</TIMEDIFFERENCEDAYS>
  <BUGGYCOMMIT>
    <MESSAGE>Merge pull request #13296 from AlanCoding/signing_bug Fix bug, sign work based signing, not verification</MESSAGE>
    <SHA>a0b8215c06918260c4f3d0c481fb1adac6fa2613</SHA>
  </BUGGYCOMMIT>
  <PATCHCOMMITS>
    <COMMIT>
      <MESSAGE>Fix duped stats name and Redis for wsbroadcast This fixes several things related to our wsbroadcast stats handling. This was found during the ongoing wsrelay work. There are really three fixes here: - Logging was not actually enabled for the analytics.broadcast_websocket module, so that has been added to our loggers config. - analytics.broadcast_websocket was not actually able to connect to Redis due to 68614b83c00982259be18b0e6e22550f8dd0449a as part of the work in #13187. But there was no easy way to know this because the logging issue meant no exceptions showed up anywhere reasonable. - Relatedly, and also as part of #13187, we jumped from `prometheus-client` 0.7.1 up to 0.15.0. This included a breaking change where a `Counter` ending with `_total` will clash with a `Gauge` of the same name but without `_total`. I am not 100% sure of the reasoning here, other than &quot;OpenMetrics compatibility&quot;. Refs #13301 Refs #13187 Signed-off-by: Rick Elrod &lt;rick@elrod.me&gt;</MESSAGE>
      <SHA>98fae4ecc519c1b2d39358ecff48fd6a9e7cb782</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/analytics/broadcast_websocket.py</FILE>
        <FILE>awx/main/wsbroadcast.py</FILE>
        <FILE>awx/settings/defaults.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
    <COMMIT>
      <MESSAGE>Fix duped stats name and Redis for wsbroadcast This fixes several things related to our wsbroadcast stats handling. This was found during the ongoing wsrelay work. There are really three fixes here: - Logging was not actually enabled for the analytics.broadcast_websocket module, so that has been added to our loggers config. - analytics.broadcast_websocket was not actually able to connect to Redis due to 68614b83c00982259be18b0e6e22550f8dd0449a as part of the work in #13187. But there was no easy way to know this because the logging issue meant no exceptions showed up anywhere reasonable. - Relatedly, and also as part of #13187, we jumped from `prometheus-client` 0.7.1 up to 0.15.0. This included a breaking change where a `Counter` ending with `_total` will clash with a `Gauge` of the same name but without `_total`. I am not 100% sure of the reasoning here, other than &quot;OpenMetrics compatibility&quot;. Refs #13301 Refs #13187 Signed-off-by: Rick Elrod &lt;rick@elrod.me&gt;</MESSAGE>
      <SHA>ef29589940bb071b802671f090158f0916f9c260</SHA>
      <PATCHEDFILES>
        <FILE>awx/main/analytics/broadcast_websocket.py</FILE>
        <FILE>awx/main/wsbroadcast.py</FILE>
        <FILE>awx/settings/defaults.py</FILE>
      </PATCHEDFILES>
    </COMMIT>
  </PATCHCOMMITS>
</ISSUE>
