issue_no,repo,issue_url,title,description,patched_file_types,text_for_topic_modeling,prediction,confidence
26882,supabase,https://github.com/supabase/supabase/issues/26882,Use additional API keys is not working like in the documentation,"# Bug report - [x] I confirm this is a bug with Supabase, not with my own application. - [x] I confirm I have searched the [Docs](https://docs.supabase.com), GitHub [Discussions](https://github.com/supabase/supabase/discussions), and [Discord](https://discord.supabase.com). ## Describe the bug In this [documentation at additional api keys](https://supabase.com/docs/guides/api/securing-your-api?queryGroups=database-method&database-method=sql&queryGroups=pre-request&pre-request=use-additional-api-key#examples), for the function you have to set definer as the permissions for the function, and in the documentation says to use `current_role` to check if is `anon` or other, but, it will always be `postgres` because that is the user that defined the function ## To Reproduce Follow the steps from the documentation ## Expected behavior To work as described in the docs ## Screenshots Here is the values of the headers, jwt and current role when calling the api with anon and authenticated user js { status: 403, current_role: 'postgres', jwt: null, headers: { 'x-forwarded-path': '/rest/v1/users_info', 'x-forwarded-proto': 'http', accept: 'application/vnd.pgrst.object+json', 'accept-profile': 'public', 'x-forwarded-for': '192.168.65.1', 'x-real-ip': '192.168.65.1', authorization: 'Bearer ', 'x-forwarded-port': '8000', 'x-client-info': 'postgrest-js/1.15.2', 'x-forwarded-host': '127.0.0.1', connection: 'keep-alive', apikey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0', 'x-forwarded-prefix': '/rest/v1/', host: ':3000' } }  This is how the function looks like sql CREATE OR REPLACE FUNCTION public.request_security_check() RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $function$declare api_key text := current_setting('request.headers', true)::json->>'x-api-key'; is_api_key_registered boolean; begin select true into is_api_key_registered from security.db_api_keys where key = api_key limit 1; if is_api_key_registered is true then return; end if; raise sqlstate '45000' using message = json_build_object( 'message', 'No registered API key found.'), detail = json_build_object( 'status', 403, 'current_role', current_role, 'jwt', current_setting('request.jwt', true)::json, 'headers', current_setting('request.headers', true)::json); end;$function$ ;  ## System information - OS: macOS - Version of supabase-js: 1.15.2 - Version of Node.js: 22.2.0",other-file,"Use additional API keys is not working like in the documentation # Bug report - [x] I confirm this is a bug with Supabase, not with my own application. - [x] I confirm I have searched the [Docs](https://docs.supabase.com), GitHub [Discussions](https://github.com/supabase/supabase/discussions), and [Discord](https://discord.supabase.com). ## Describe the bug In this [documentation at additional api keys](https://supabase.com/docs/guides/api/securing-your-api?queryGroups=database-method&database-method=sql&queryGroups=pre-request&pre-request=use-additional-api-key#examples), for the function you have to set definer as the permissions for the function, and in the documentation says to use `current_role` to check if is `anon` or other, but, it will always be `postgres` because that is the user that defined the function ## To Reproduce Follow the steps from the documentation ## Expected behavior To work as described in the docs ## Screenshots Here is the values of the headers, jwt and current role when calling the api with anon and authenticated user js { status: 403, current_role: 'postgres', jwt: null, headers: { 'x-forwarded-path': '/rest/v1/users_info', 'x-forwarded-proto': 'http', accept: 'application/vnd.pgrst.object+json', 'accept-profile': 'public', 'x-forwarded-for': '192.168.65.1', 'x-real-ip': '192.168.65.1', authorization: 'Bearer ', 'x-forwarded-port': '8000', 'x-client-info': 'postgrest-js/1.15.2', 'x-forwarded-host': '127.0.0.1', connection: 'keep-alive', apikey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0', 'x-forwarded-prefix': '/rest/v1/', host: ':3000' } }  This is how the function looks like sql CREATE OR REPLACE FUNCTION public.request_security_check() RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $function$declare api_key text := current_setting('request.headers', true)::json->>'x-api-key'; is_api_key_registered boolean; begin select true into is_api_key_registered from security.db_api_keys where key = api_key limit 1; if is_api_key_registered is true then return; end if; raise sqlstate '45000' using message = json_build_object( 'message', 'No registered API key found.'), detail = json_build_object( 'status', 403, 'current_role', current_role, 'jwt', current_setting('request.jwt', true)::json, 'headers', current_setting('request.headers', true)::json); end;$function$ ;  ## System information - OS: macOS - Version of supabase-js: 1.15.2 - Version of Node.js: 22.2.0 other-file",bug,0.9
