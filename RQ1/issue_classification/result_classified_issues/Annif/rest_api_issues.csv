issue_no,repo,issue_url,title,description,buggy_msg,patch_msgs,patched_files,patched_file_types,text_for_topic_modeling,prediction,confidence
459,Annif,https://github.com/NatLibFi/Annif/issues/459,Limit parameter is not passed to MauiServer,"Maui backend gives at most 10 suggestions even if a larger `limit` value is set in Annif. At training time [only `id` and `lang` parameters are passed to MauiServer](https://github.com/NatLibFi/Annif/blob/98bde2375abe17a6a1d368fd9acae6f2edf09c00/annif/backend/maui.py#L82), and [the default value of 10](https://github.com/NatLibFi/MauiServer/blob/master/src/main/java/org/topbraid/mauiserver/tagger/TaggerConfiguration.java#L36) is always used for `max_topics_per_document`. ``` # http://localhost:8080/mauiserver/tmp-maui-fi/config id | ""tmp-maui-fi"" -- | -- title | ""tmp-maui-fi"" description | null lang | ""fi"" stemmer_class | null stopwords_class | null cross_validation_passes | 10 max_topics_per_document | 10 probability_threshold | 0 ``` When Maui backend is used in an ensemble project, getting more suggestions would be advantageous.",Merge pull request #458 from NatLibFi/nn-ensemble-tweaks2 Improved handling of source weights in NN ensemble,Pass limit parameter to Maui Server (as max_topics_per_document) during train. Fixes #459,annif/backend/maui.py | tests/test_backend_maui.py,source-file | test-file,"Limit parameter is not passed to MauiServer Maui backend gives at most 10 suggestions even if a larger `limit` value is set in Annif. At training time [only `id` and `lang` parameters are passed to MauiServer](https://github.com/NatLibFi/Annif/blob/98bde2375abe17a6a1d368fd9acae6f2edf09c00/annif/backend/maui.py#L82), and [the default value of 10](https://github.com/NatLibFi/MauiServer/blob/master/src/main/java/org/topbraid/mauiserver/tagger/TaggerConfiguration.java#L36) is always used for `max_topics_per_document`. ``` # http://localhost:8080/mauiserver/tmp-maui-fi/config id | ""tmp-maui-fi"" -- | -- title | ""tmp-maui-fi"" description | null lang | ""fi"" stemmer_class | null stopwords_class | null cross_validation_passes | 10 max_topics_per_document | 10 probability_threshold | 0 ``` When Maui backend is used in an ensemble project, getting more suggestions would be advantageous. Merge pull request #458 from NatLibFi/nn-ensemble-tweaks2 Improved handling of source weights in NN ensemble Pass limit parameter to Maui Server (as max_topics_per_document) during train. Fixes #459",bug,0.9
208,Annif,https://github.com/NatLibFi/Annif/issues/208,Robustness issues in HTTP backend,"These issues are similar enough that I'm only opening a single issue. When using the `arto-fi` data set to train a PAV model, I got this exception: ``` File ""/srv/Annif/annif/backend/pav.py"", line 69, in _analyze_train_corpus hits = source_project.analyze(doc.text) File ""/srv/Annif/annif/project.py"", line 158, in analyze hits_from_backends = self._analyze_with_backends(text, backend_params) File ""/srv/Annif/annif/project.py"", line 109, in _analyze_with_backends hits = backend.analyze(text, project=self, params=beparams) File ""/srv/Annif/annif/backend/backend.py"", line 53, in analyze return self._analyze(text, project, params=beparams) File ""/srv/Annif/annif/backend/http.py"", line 17, in _analyze req = requests.post(params['endpoint'], data=data) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/api.py"", line 116, in post return request('post', url, data=data, json=json, **kwargs) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/api.py"", line 60, in request return session.request(method=method, url=url, **kwargs) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/sessions.py"", line 533, in request resp = self.send(prep, **send_kwargs) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/sessions.py"", line 646, in send r = adapter.send(request, **kwargs) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/adapters.py"", line 498, in send raise ConnectionError(err, request=request) requests.exceptions.ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) ``` When training a PAV model with the `jyu-fin` data set, I got this: ``` File ""/srv/Annif/annif/backend/pav.py"", line 80, in _create_pav_model scores, true = self._analyze_train_corpus(source_project, corpus) File ""/srv/Annif/annif/backend/pav.py"", line 69, in _analyze_train_corpus hits = source_project.analyze(doc.text) File ""/srv/Annif/annif/project.py"", line 158, in analyze hits_from_backends = self._analyze_with_backends(text, backend_params) File ""/srv/Annif/annif/project.py"", line 109, in _analyze_with_backends hits = backend.analyze(text, project=self, params=beparams) File ""/srv/Annif/annif/backend/backend.py"", line 53, in analyze return self._analyze(text, project, params=beparams) File ""/srv/Annif/annif/backend/http.py"", line 26, in _analyze for h in results File ""/srv/Annif/annif/backend/http.py"", line 27, in <listcomp> if h['score'] > 0.0], TypeError: string indices must be integers ``` In both cases the problem is that HTTP exceptions and other error conditions are not properly handled by the HTTP backend.",Use errors=replace for more robust handling of text corpus files. Fixes #207,Handle HTTP exceptions and error codes in http backend. Part of #208 | Handle case where JSON decoding fails in HTTP backend. Part of #208 | Handle unexpected JSON data in HTTP backend. Part of #208,annif/backend/http.py | tests/test_backend_http.py | annif/backend/http.py | tests/test_backend_http.py | annif/backend/http.py | tests/test_backend_http.py,source-file | test-file | source-file | test-file | source-file | test-file,"Robustness issues in HTTP backend These issues are similar enough that I'm only opening a single issue. When using the `arto-fi` data set to train a PAV model, I got this exception: ``` File ""/srv/Annif/annif/backend/pav.py"", line 69, in _analyze_train_corpus hits = source_project.analyze(doc.text) File ""/srv/Annif/annif/project.py"", line 158, in analyze hits_from_backends = self._analyze_with_backends(text, backend_params) File ""/srv/Annif/annif/project.py"", line 109, in _analyze_with_backends hits = backend.analyze(text, project=self, params=beparams) File ""/srv/Annif/annif/backend/backend.py"", line 53, in analyze return self._analyze(text, project, params=beparams) File ""/srv/Annif/annif/backend/http.py"", line 17, in _analyze req = requests.post(params['endpoint'], data=data) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/api.py"", line 116, in post return request('post', url, data=data, json=json, **kwargs) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/api.py"", line 60, in request return session.request(method=method, url=url, **kwargs) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/sessions.py"", line 533, in request resp = self.send(prep, **send_kwargs) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/sessions.py"", line 646, in send r = adapter.send(request, **kwargs) File ""/srv/Annif/.venv/lib/python3.6/site-packages/requests/adapters.py"", line 498, in send raise ConnectionError(err, request=request) requests.exceptions.ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) ``` When training a PAV model with the `jyu-fin` data set, I got this: ``` File ""/srv/Annif/annif/backend/pav.py"", line 80, in _create_pav_model scores, true = self._analyze_train_corpus(source_project, corpus) File ""/srv/Annif/annif/backend/pav.py"", line 69, in _analyze_train_corpus hits = source_project.analyze(doc.text) File ""/srv/Annif/annif/project.py"", line 158, in analyze hits_from_backends = self._analyze_with_backends(text, backend_params) File ""/srv/Annif/annif/project.py"", line 109, in _analyze_with_backends hits = backend.analyze(text, project=self, params=beparams) File ""/srv/Annif/annif/backend/backend.py"", line 53, in analyze return self._analyze(text, project, params=beparams) File ""/srv/Annif/annif/backend/http.py"", line 26, in _analyze for h in results File ""/srv/Annif/annif/backend/http.py"", line 27, in <listcomp> if h['score'] > 0.0], TypeError: string indices must be integers ``` In both cases the problem is that HTTP exceptions and other error conditions are not properly handled by the HTTP backend. Use errors=replace for more robust handling of text corpus files. Fixes #207 Handle HTTP exceptions and error codes in http backend. Part of #208 Handle case where JSON decoding fails in HTTP backend. Part of #208 Handle unexpected JSON data in HTTP backend. Part of #208",bug,0.9
27,Annif,https://github.com/NatLibFi/Annif/issues/27,Support Problem JSON in Swagger spec and REST API,Our REST responses in error situations should follow [RFC 7807](https://tools.ietf.org/html/rfc7807). Some concrete guidance can be found in the [Zalando RESTful API guidelines](https://zalando.github.io/restful-api-guidelines/#176),Merge pull request #117 from NatLibFi/issue89-rest-tests Implement REST API tests using swagger-tester. Fixes #89,Use Problem JSON (RFC 7807) to report errors in REST API. Fixes #27 | Merge pull request #118 from NatLibFi/issue27-rest-problem-json Use Problem JSON (RFC 7807) to report errors in REST API. Fixes #27,annif/rest.py | swagger/annif.yaml | annif/rest.py | swagger/annif.yaml,source-file | documentation-file | source-file | documentation-file,Support Problem JSON in Swagger spec and REST API Our REST responses in error situations should follow [RFC 7807](https://tools.ietf.org/html/rfc7807). Some concrete guidance can be found in the [Zalando RESTful API guidelines](https://zalando.github.io/restful-api-guidelines/#176) Merge pull request #117 from NatLibFi/issue89-rest-tests Implement REST API tests using swagger-tester. Fixes #89 Use Problem JSON (RFC 7807) to report errors in REST API. Fixes #27 Merge pull request #118 from NatLibFi/issue27-rest-problem-json Use Problem JSON (RFC 7807) to report errors in REST API. Fixes #27,bug,0.85
556,Annif,https://github.com/NatLibFi/Annif/issues/556,vocabulary in SKOS (Turtle serialization) should be loaded even in case of lacking language tags,"Hi! I've noticed some potentially inconsistent behaviour of the annif loadvoc command when loading voacabulary in ttl SKOS without language tags. We've currently switched in our project from simple tsv vocabulary format to SKOS. I assumed that since we do not provide any information about language in tsv file, we don't necessarily have to add appropriate language tags in SKOS either. But it turned out, that loading vocabulary in SKOS without language tags prevents annif from creating the subject index (though original ttl file is being copied and gzipped file is being dumped). It seems, that when annif converts tsv to SKOS, it adds language tags (they're based upon language configuration in projects.cfg), but when it loads vocabulary directly from SKOS format, it checks if language tag for a label is the same as language code in projects.cfg, and when it's not **or if there is no language tag at all** it skips the whole concept: ``` def get_concept_labels(self, concept, label_types, language): return [str(label) for label_type in label_types for label in self.graph.objects(concept, label_type) if label.language == language] ``` ``` @property def subjects(self): for concept in self.concepts: labels = self.get_concept_labels( concept, [SKOS.prefLabel, RDFS.label], self.language) notation = self.graph.value(concept, SKOS.notation, None, any=True) if not labels: continue label = labels[0] if notation is not None: notation = str(notation) yield Subject(uri=str(concept), label=label, notation=notation, text=None) ``` I think, that maybe it would be safer to assume, that when there is no explicit information about the language in SKOS file (there is a label without the language tag), its language corresponds with the language defined in projects.cfg and skip a concept (or label from the concept) only when the language tag truly exists and is not equal to the language from projects.cfg. If this change is not possible for some reasons, it would be nice to provide some information about this behaviour in annif wiki (it took me some time to find this ""bug""). Maciej Sagata, National Library of Poland",Merge pull request #594 from NatLibFi/upgrade-simplemma-0.7 Upgrade Simplemma to version 0.7,Include labels without language tag and concepts without labels in vocabulary. Fixes #556 | Include labels without language tag and concepts without labels in vocabulary. Fixes #556,annif/corpus/skos.py | tests/test_vocab_skos.py | annif/corpus/skos.py | tests/test_vocab_skos.py,source-file | test-file | source-file | test-file,"vocabulary in SKOS (Turtle serialization) should be loaded even in case of lacking language tags Hi! I've noticed some potentially inconsistent behaviour of the annif loadvoc command when loading voacabulary in ttl SKOS without language tags. We've currently switched in our project from simple tsv vocabulary format to SKOS. I assumed that since we do not provide any information about language in tsv file, we don't necessarily have to add appropriate language tags in SKOS either. But it turned out, that loading vocabulary in SKOS without language tags prevents annif from creating the subject index (though original ttl file is being copied and gzipped file is being dumped). It seems, that when annif converts tsv to SKOS, it adds language tags (they're based upon language configuration in projects.cfg), but when it loads vocabulary directly from SKOS format, it checks if language tag for a label is the same as language code in projects.cfg, and when it's not **or if there is no language tag at all** it skips the whole concept: ``` def get_concept_labels(self, concept, label_types, language): return [str(label) for label_type in label_types for label in self.graph.objects(concept, label_type) if label.language == language] ``` ``` @property def subjects(self): for concept in self.concepts: labels = self.get_concept_labels( concept, [SKOS.prefLabel, RDFS.label], self.language) notation = self.graph.value(concept, SKOS.notation, None, any=True) if not labels: continue label = labels[0] if notation is not None: notation = str(notation) yield Subject(uri=str(concept), label=label, notation=notation, text=None) ``` I think, that maybe it would be safer to assume, that when there is no explicit information about the language in SKOS file (there is a label without the language tag), its language corresponds with the language defined in projects.cfg and skip a concept (or label from the concept) only when the language tag truly exists and is not equal to the language from projects.cfg. If this change is not possible for some reasons, it would be nice to provide some information about this behaviour in annif wiki (it took me some time to find this ""bug""). Maciej Sagata, National Library of Poland Merge pull request #594 from NatLibFi/upgrade-simplemma-0.7 Upgrade Simplemma to version 0.7 Include labels without language tag and concepts without labels in vocabulary. Fixes #556 Include labels without language tag and concepts without labels in vocabulary. Fixes #556",bug,0.85
470,Annif,https://github.com/NatLibFi/Annif/issues/470,NN ensemble may return scores above 1.0,"The NN ensemble doesn't always return scores in the range 0.0-1.0. For example, the `yso-sv` model currently available in Finto AI returns this for the input text `historia`: ```js { ""results"": [ { ""label"": ""historia"", ""notation"": null, ""score"": 1.3140300512313843, ""uri"": ""http://www.yso.fi/onto/yso/p1780"" }, [...] } ``` This should be avoided, for example by capping the scores to 1.0.",Bump version: 0.51.0 → 0.52.0-dev,Make sure NN ensemble scores are in the range 0.0-1.0. Fixes #470 | Make sure suggestion scores are in the range 0.0-1.0. Fixes #470,annif/backend/nn_ensemble.py | annif/suggestion.py | tests/test_suggestion.py,source-file | source-file | test-file,"NN ensemble may return scores above 1.0 The NN ensemble doesn't always return scores in the range 0.0-1.0. For example, the `yso-sv` model currently available in Finto AI returns this for the input text `historia`: ```js { ""results"": [ { ""label"": ""historia"", ""notation"": null, ""score"": 1.3140300512313843, ""uri"": ""http://www.yso.fi/onto/yso/p1780"" }, [...] } ``` This should be avoided, for example by capping the scores to 1.0. Bump version: 0.51.0 → 0.52.0-dev Make sure NN ensemble scores are in the range 0.0-1.0. Fixes #470 Make sure suggestion scores are in the range 0.0-1.0. Fixes #470",bug,0.9
187,Annif,https://github.com/NatLibFi/Annif/issues/187,Improved error handling,"There are many ways to trigger an error using Annif. These include * defining a project with missing settings (e.g. vocab is now practically mandatory) * trying to load documents before loading a vocabulary * trying to analyze documents before loading a vocabulary or training the model Some of these may also be triggered via the REST API, especially the last one. In these situations Annif should output a helpful error message instead of crashing with a traceback.",remove unused class variables,"Handle some error scenarios using a custom exception class. Part of #187 | Handle the error when no vocab has been set for a project. Part of #187 | Error handling for missing vocabulary case. Part of #187 | Handle error when tfidf similarity index doesn't exist. Part of #187 | Catch and report exceptions in analyzedir, eval and optimize CLI commands. Part of #187 | Handle errors in REST API. Part of #187",annif/backend/fasttext.py | annif/cli.py | annif/exception.py | annif/project.py | annif/cli.py | annif/exception.py | annif/project.py | annif/cli.py | annif/project.py | annif/vocab.py | annif/backend/tfidf.py | annif/cli.py | annif/rest.py | swagger/annif.yaml,source-file | source-file | source-file | source-file | source-file | source-file | source-file | source-file | source-file | source-file | source-file | source-file | source-file | documentation-file,"Improved error handling There are many ways to trigger an error using Annif. These include * defining a project with missing settings (e.g. vocab is now practically mandatory) * trying to load documents before loading a vocabulary * trying to analyze documents before loading a vocabulary or training the model Some of these may also be triggered via the REST API, especially the last one. In these situations Annif should output a helpful error message instead of crashing with a traceback. remove unused class variables Handle some error scenarios using a custom exception class. Part of #187 Handle the error when no vocab has been set for a project. Part of #187 Error handling for missing vocabulary case. Part of #187 Handle error when tfidf similarity index doesn't exist. Part of #187 Catch and report exceptions in analyzedir, eval and optimize CLI commands. Part of #187 Handle errors in REST API. Part of #187",bug,0.8
389,Annif,https://github.com/NatLibFi/Annif/issues/389,Annif breaks when MauiServer returns malformed URIs for topic IDs,"### Steps to reproduce ``` annif loadvoc rula-maui-en Annif-corpora/vocab/lcsh/lcsh.ttl annif train rula-maui-en Annif-corpora/fulltext/rula/validate/ ``` https://github.com/mjsuhonos/Annif-corpora/blob/master/vocab/lcsh/lcsh.ttl https://github.com/mjsuhonos/Annif-corpora/tree/master/fulltext/rula/validate ``` annif eval rula-maui-en Annif-corpora/fulltext/rula/test/ -v DEBUG ``` ```python … warning: Unknown subject URI <http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450> Traceback (most recent call last): File ""/usr/local/bin/annif"", line 11, in <module> load_entry_point('annif', 'console_scripts', 'annif')() File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 764, in __call__ return self.main(*args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/flask/cli.py"", line 586, in main return super(FlaskGroup, self).main(*args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 717, in main rv = self.invoke(ctx) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 1137, in invoke return _process_result(sub_ctx.command.invoke(sub_ctx)) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 956, in invoke return ctx.invoke(self.callback, **ctx.params) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 555, in invoke return callback(*args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/click/decorators.py"", line 17, in new_func return f(get_current_context(), *args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/flask/cli.py"", line 426, in decorator return __ctx.invoke(f, *args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 555, in invoke return callback(*args, **kwargs) File ""/Annif/annif/cli.py"", line 305, in run_eval results = project.suggest(doc.text, backend_params) File ""/Annif/annif/project.py"", line 161, in suggest hits = self._suggest_with_backend(text, backend_params) File ""/Annif/annif/project.py"", line 105, in _suggest_with_backend hits = self.backend.suggest(text, beparams) File ""/Annif/annif/backend/backend.py"", line 67, in suggest return self._suggest(text, params=beparams) File ""/Annif/annif/backend/maui.py"", line 155, in _suggest return self._response_to_result(response) File ""/Annif/annif/backend/maui.py"", line 150, in _response_to_result self.project.subjects) File ""/Annif/annif/suggestion.py"", line 169, in create_from_index subject = subject_index[subject_index.by_uri(hit.uri)] File ""/Annif/annif/corpus/subject.py"", line 55, in __getitem__ return (self._uris[subject_id], self._labels[subject_id], TypeError: list indices must be integers or slices, not NoneType ``` ### Malformed response Document source (1126 bytes) > Key findings: The survey results for both countries were similar in terms of the percentage of respondents who reported working in smaller newsrooms and working longer hours compared to two years ago Respondents in both countries said that the perception of local newspapers as a dying industry deters advertisers and makes it challenging to recruit new staff Use of metrics to measure engagement and shape the production of stories is about the same in both countries Respondents in Canada and the United States both reported that few employers provided training courses to assist with learning about new technologies While approximately half of the participants in both surveys felt slightly or very secure in their jobs, almost twice as many Canadians felt slightly or very insecure in their jobs American respondents overall tended to be more positive about the future of local newspapers Respondents from American newspapers were more likely to use video reporting, live video and **and podcasts than their Canadian counterparts Researchers who compare the state of local journalism across** ```json { ""title"": ""10 recommendations from rula-maui-en"", ""topics"": [ { ""id"": ""http://id.loc.gov/authorities/subjects/sh85004368"", ""label"": ""American newspapers"", ""probability"": 0.06058101652075777 }, { ""id"": ""http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450"", ""label"": ""http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450"", ""probability"": 0.03634347847356808 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85143204"", ""label"": ""Video recordings"", ""probability"": 0.02480501693510654 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85070585"", ""label"": ""Job security"", ""probability"": 0.022298487879186563 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2007001518"", ""label"": ""Podcasts"", ""probability"": 0.021532180099457447 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2006006472"", ""label"": ""Podcasting"", ""probability"": 0.021532180099457447 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2012001802"", ""label"": ""Podcasters"", ""probability"": 0.021532180099457447 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85091588"", ""label"": ""Newspapers"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh99001641"", ""label"": ""Newspapers"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2007008878"", ""label"": ""First responders"", ""probability"": 0.01622784151074123 } ] } ``` ### Correct response Document source (1126 bytes) > Key findings: The survey results for both countries were similar in terms of the percentage of respondents who reported working in smaller newsrooms and working longer hours compared to two years ago Respondents in both countries said that the perception of local newspapers as a dying industry deters advertisers and makes it challenging to recruit new staff Use of metrics to measure engagement and shape the production of stories is about the same in both countries Respondents in Canada and the United States both reported that few employers provided training courses to assist with learning about new technologies While approximately half of the participants in both surveys felt slightly or very secure in their jobs, almost twice as many Canadians felt slightly or very insecure in their jobs American respondents overall tended to be more positive about the future of local newspapers Respondents from American newspapers were more likely to use video reporting, live video and **common questions revealed two notable differences between the countries. The first had to do with sentiments** ```json { ""title"": ""10 recommendations from rula-maui-en"", ""topics"": [ { ""id"": ""http://id.loc.gov/authorities/subjects/sh85004368"", ""label"": ""American newspapers"", ""probability"": 0.06058101652075777 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85143204"", ""label"": ""Video recordings"", ""probability"": 0.02480501693510654 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85070585"", ""label"": ""Job security"", ""probability"": 0.022298487879186563 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85091588"", ""label"": ""Newspapers"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh99001641"", ""label"": ""Newspapers"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2007008878"", ""label"": ""First responders"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh93009373"", ""label"": ""Advertisers"", ""probability"": 0.01382364849909128 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85001086"", ""label"": ""Advertising"", ""probability"": 0.01382364849909128 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2001009077"", ""label"": ""Supplementary employment"", ""probability"": 0.01382364849909128 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2005004875"", ""label"": ""Employability"", ""probability"": 0.01382364849909128 } ] } ``` ### Suspected cause This vocabulary contains two `skos:prefLabel` statements with identical object literals: ``` <http://id.loc.gov/authorities/genreForms/gf2011026450> <http://www.w3.org/2004/02/skos/core#prefLabel> ""Podcasts""@en . <http://id.loc.gov/authorities/subjects/sh2007001518> <http://www.w3.org/2004/02/skos/core#prefLabel> ""Podcasts""@en . ``` It seems plausible that due to its lexical approach, Maui uses the object literal as a unique value, which would match two topic URIs, given the above statements. The (albeit strangely truncated) concatenation of these two URI values are then returned in the response. This theory is currently being tested. ### Proposed resolution Ideally, Annif could extract valid URIs from the invalid response, but this may be too much overhead if each response URI must be validated. At a minimum, Annif should ignore the malformed response and continue with eg. a warning statement on STDERR.",Modify unit test to exercise all code paths,Robustness fix: Don't break if Maui returns an unknown URI. Fixes #389,annif/suggestion.py | tests/test_backend_maui.py,source-file | test-file,"Annif breaks when MauiServer returns malformed URIs for topic IDs ### Steps to reproduce ``` annif loadvoc rula-maui-en Annif-corpora/vocab/lcsh/lcsh.ttl annif train rula-maui-en Annif-corpora/fulltext/rula/validate/ ``` https://github.com/mjsuhonos/Annif-corpora/blob/master/vocab/lcsh/lcsh.ttl https://github.com/mjsuhonos/Annif-corpora/tree/master/fulltext/rula/validate ``` annif eval rula-maui-en Annif-corpora/fulltext/rula/test/ -v DEBUG ``` ```python … warning: Unknown subject URI <http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450> Traceback (most recent call last): File ""/usr/local/bin/annif"", line 11, in <module> load_entry_point('annif', 'console_scripts', 'annif')() File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 764, in __call__ return self.main(*args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/flask/cli.py"", line 586, in main return super(FlaskGroup, self).main(*args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 717, in main rv = self.invoke(ctx) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 1137, in invoke return _process_result(sub_ctx.command.invoke(sub_ctx)) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 956, in invoke return ctx.invoke(self.callback, **ctx.params) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 555, in invoke return callback(*args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/click/decorators.py"", line 17, in new_func return f(get_current_context(), *args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/flask/cli.py"", line 426, in decorator return __ctx.invoke(f, *args, **kwargs) File ""/usr/local/lib/python3.7/site-packages/click/core.py"", line 555, in invoke return callback(*args, **kwargs) File ""/Annif/annif/cli.py"", line 305, in run_eval results = project.suggest(doc.text, backend_params) File ""/Annif/annif/project.py"", line 161, in suggest hits = self._suggest_with_backend(text, backend_params) File ""/Annif/annif/project.py"", line 105, in _suggest_with_backend hits = self.backend.suggest(text, beparams) File ""/Annif/annif/backend/backend.py"", line 67, in suggest return self._suggest(text, params=beparams) File ""/Annif/annif/backend/maui.py"", line 155, in _suggest return self._response_to_result(response) File ""/Annif/annif/backend/maui.py"", line 150, in _response_to_result self.project.subjects) File ""/Annif/annif/suggestion.py"", line 169, in create_from_index subject = subject_index[subject_index.by_uri(hit.uri)] File ""/Annif/annif/corpus/subject.py"", line 55, in __getitem__ return (self._uris[subject_id], self._labels[subject_id], TypeError: list indices must be integers or slices, not NoneType ``` ### Malformed response Document source (1126 bytes) > Key findings: The survey results for both countries were similar in terms of the percentage of respondents who reported working in smaller newsrooms and working longer hours compared to two years ago Respondents in both countries said that the perception of local newspapers as a dying industry deters advertisers and makes it challenging to recruit new staff Use of metrics to measure engagement and shape the production of stories is about the same in both countries Respondents in Canada and the United States both reported that few employers provided training courses to assist with learning about new technologies While approximately half of the participants in both surveys felt slightly or very secure in their jobs, almost twice as many Canadians felt slightly or very insecure in their jobs American respondents overall tended to be more positive about the future of local newspapers Respondents from American newspapers were more likely to use video reporting, live video and **and podcasts than their Canadian counterparts Researchers who compare the state of local journalism across** ```json { ""title"": ""10 recommendations from rula-maui-en"", ""topics"": [ { ""id"": ""http://id.loc.gov/authorities/subjects/sh85004368"", ""label"": ""American newspapers"", ""probability"": 0.06058101652075777 }, { ""id"": ""http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450"", ""label"": ""http://id.loc.gov/authorities/subjects/http://id.loc.gov/authorities/genreForms/gf2011026450"", ""probability"": 0.03634347847356808 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85143204"", ""label"": ""Video recordings"", ""probability"": 0.02480501693510654 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85070585"", ""label"": ""Job security"", ""probability"": 0.022298487879186563 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2007001518"", ""label"": ""Podcasts"", ""probability"": 0.021532180099457447 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2006006472"", ""label"": ""Podcasting"", ""probability"": 0.021532180099457447 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2012001802"", ""label"": ""Podcasters"", ""probability"": 0.021532180099457447 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85091588"", ""label"": ""Newspapers"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh99001641"", ""label"": ""Newspapers"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2007008878"", ""label"": ""First responders"", ""probability"": 0.01622784151074123 } ] } ``` ### Correct response Document source (1126 bytes) > Key findings: The survey results for both countries were similar in terms of the percentage of respondents who reported working in smaller newsrooms and working longer hours compared to two years ago Respondents in both countries said that the perception of local newspapers as a dying industry deters advertisers and makes it challenging to recruit new staff Use of metrics to measure engagement and shape the production of stories is about the same in both countries Respondents in Canada and the United States both reported that few employers provided training courses to assist with learning about new technologies While approximately half of the participants in both surveys felt slightly or very secure in their jobs, almost twice as many Canadians felt slightly or very insecure in their jobs American respondents overall tended to be more positive about the future of local newspapers Respondents from American newspapers were more likely to use video reporting, live video and **common questions revealed two notable differences between the countries. The first had to do with sentiments** ```json { ""title"": ""10 recommendations from rula-maui-en"", ""topics"": [ { ""id"": ""http://id.loc.gov/authorities/subjects/sh85004368"", ""label"": ""American newspapers"", ""probability"": 0.06058101652075777 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85143204"", ""label"": ""Video recordings"", ""probability"": 0.02480501693510654 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85070585"", ""label"": ""Job security"", ""probability"": 0.022298487879186563 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85091588"", ""label"": ""Newspapers"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh99001641"", ""label"": ""Newspapers"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2007008878"", ""label"": ""First responders"", ""probability"": 0.01622784151074123 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh93009373"", ""label"": ""Advertisers"", ""probability"": 0.01382364849909128 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh85001086"", ""label"": ""Advertising"", ""probability"": 0.01382364849909128 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2001009077"", ""label"": ""Supplementary employment"", ""probability"": 0.01382364849909128 }, { ""id"": ""http://id.loc.gov/authorities/subjects/sh2005004875"", ""label"": ""Employability"", ""probability"": 0.01382364849909128 } ] } ``` ### Suspected cause This vocabulary contains two `skos:prefLabel` statements with identical object literals: ``` <http://id.loc.gov/authorities/genreForms/gf2011026450> <http://www.w3.org/2004/02/skos/core#prefLabel> ""Podcasts""@en . <http://id.loc.gov/authorities/subjects/sh2007001518> <http://www.w3.org/2004/02/skos/core#prefLabel> ""Podcasts""@en . ``` It seems plausible that due to its lexical approach, Maui uses the object literal as a unique value, which would match two topic URIs, given the above statements. The (albeit strangely truncated) concatenation of these two URI values are then returned in the response. This theory is currently being tested. ### Proposed resolution Ideally, Annif could extract valid URIs from the invalid response, but this may be too much overhead if each response URI must be validated. At a minimum, Annif should ignore the malformed response and continue with eg. a warning statement on STDERR. Modify unit test to exercise all code paths Robustness fix: Don't break if Maui returns an unknown URI. Fixes #389",bug,0.9
