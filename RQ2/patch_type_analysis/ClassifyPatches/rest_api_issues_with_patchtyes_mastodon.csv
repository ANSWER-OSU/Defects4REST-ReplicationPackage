issue_no,repo,issue_url,title,description,patched_file_types
29127,mastodon,https://github.com/mastodon/mastodon/issues/29127,Possible to create domain blocks when a stricter limit already exists in Admin UI,"Steps to reproduce the problem 1. Go to `/admin/instances?limited=1` to manage federation 2. Add a domain block for `example` (noop/none severity) 3. Using the API try to create a domain block for `test.example` observe that an error is returned 4. Go back to the admin UI and create a domain block for `test.example` observe that no error is returned and the block is successfully created.  Expected behaviour Both methods for creating domain blocks should have same behaviour  Actual behaviour The API failed whilst the Admin UI succeeded  Detailed description This bug affects IFTAS FediCheck, where we weren't observing the same logic as `DomainBlock.rule_for` when attempting to create a domain block, which meant an existing block of `example` would fail the block creation of `test.example` leaving us out of sync with the Mastodon server (we also weren't handling the error response from the API correctly.  Mastodon instance _No response_  Mastodon version main  Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: v 3.2.3 - Node.js version: v20.11.0",source-file
28233,mastodon,https://github.com/mastodon/mastodon/issues/28233,"LinkCrawlWorker throws a NoMethodError `[]` for `nilClass` because Link Oembed json resolves to ""null""","This is mostly a reproducibility report for a certain bug that'll cause `LinkCrawlWorker`s to pile up in the dead queue. Given a status which contains the following link; - https://www.fimfiction.net/oembed\?url\=https%3A%2F%2Fwww.fimfiction.net%2Fblog%2F1027689%2Fasking-for-help It'll eventually crash a `LinkCrawlWorker` with the following error; `NoMethodError: undefined method '[]' for nil:NilClass` Because of the following backtrace; <details> <summary>Backtrace</summary>  live/app/services/fetch_oembed_service.rb:103:in `validate' live/app/services/fetch_oembed_service.rb:88:in `fetch!' live/app/services/fetch_oembed_service.rb:19:in `call' live/app/services/fetch_link_card_service.rb:107:in `attempt_oembed' live/app/services/fetch_link_card_service.rb:42:in `process_url' live/app/services/fetch_link_card_service.rb:28:in `block in call' live/app/models/concerns/lockable.rb:12:in `block (2 levels) in with_redis_lock' live/vendor/bundle/ruby/3.0.0/gems/mario-redis-lock-1.2.1/lib/redis_lock.rb:44:in `acquire' live/app/models/concerns/lockable.rb:10:in `block in with_redis_lock' live/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:110:in `block (2 levels) in with' live/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:109:in `handle_interrupt' live/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:109:in `block in with' live/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:106:in `handle_interrupt' live/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:106:in `with' live/app/lib/redis_configuration.rb:10:in `with' live/app/models/concerns/redisable.rb:9:in `with_redis' live/app/models/concerns/lockable.rb:9:in `with_redis_lock' live/app/services/fetch_link_card_service.rb:26:in `call' live/app/workers/link_crawl_worker.rb:9:in `perform'  </details> Because `body` on the following line will become the string `""null""`; https://github.com/mastodon/mastodon/blob/89a8e6e6227eb901b5811d8417d81dc8ab1427a9/app/services/fetch_oembed_service.rb#L84",source-file
28381,mastodon,https://github.com/mastodon/mastodon/issues/28381,/api/v1/directory returning 500 on Mastodon 4.1.11,"Steps to reproduce the problem On a Mastodon 4.1.11 instance: 1. Go to `your-domain.tld/directory` on a browser. A `GET` request is made to `/api/v1/directory?order=active&local=false&limit=20` 2. Check the mastodon-web logs and the database logs  Expected behaviour The `/directory` page shows some profiles  Actual behaviour The `/directory` page loads, but doesn't show any profile  Detailed description The API call to `/api/v1/directory?order=active&local=false&limit=20` gives a `500` error mastodon-web logs:  [3f261ece-7921-40e8-83a1-15a7577819f0] ActiveRecord::StatementInvalid (PG::AmbiguousColumn: ERROR: column reference ""last_status_at"" is ambiguous LINE 1:  NULL AND ""accounts"".""discoverable"" = $2 ORDER BY last_statu ^ ): [3f261ece-7921-40e8-83a1-15a7577819f0] [3f261ece-7921-40e8-83a1-15a7577819f0] app/controllers/api/v1/directories_controller.rb:8:in `show' [3f261ece-7921-40e8-83a1-15a7577819f0] app/controllers/concerns/localized.rb:11:in `set_locale' [3f261ece-7921-40e8-83a1-15a7577819f0] lib/mastodon/rack_middleware.rb:9:in `call' [3f261ece-7921-40e8-83a1-15a7577819f0] lib/public_file_server_middleware.rb:18:in `call'  Postgres logs:  2023-12-15T12:11:50.926973550+01:00 2023-12-15 11:11:50.926 UTC [789030] ERROR: column reference ""last_status_at"" is ambiguous at character 2689 2023-12-15T12:11:50.927009728+01:00 2023-12-15 11:11:50.926 UTC [789030] STATEMENT: SELECT ""accounts"".""username"" AS t0_r0, ""accounts"".""domain"" AS t0_r1, ""accounts"".""private_key"" AS t0_r2, ""accounts"".""public_key"" AS t0_r3, ""accounts"".""created_at"" AS t0_r4, ""accounts"".""updated_at"" AS t0_r5, ""accounts"".""note"" AS t0_r6, ""accounts"".""display_name"" AS t0_r7, ""accounts"".""uri"" AS t0_r8, ""accounts"".""url"" AS t0_r9, ""accounts"".""avatar_file_name"" AS t0_r10, ""accounts"".""avatar_content_type"" AS t0_r11, ""accounts"".""avatar_file_size"" AS t0_r12, ""accounts"".""avatar_updated_at"" AS t0_r13, ""accounts"".""header_file_name"" AS t0_r14, ""accounts"".""header_content_type"" AS t0_r15, ""accounts"".""header_file_size"" AS t0_r16, ""accounts"".""header_updated_at"" AS t0_r17, ""accounts"".""avatar_remote_url"" AS t0_r18, ""accounts"".""locked"" AS t0_r19, ""accounts"".""header_remote_url"" AS t0_r20, ""accounts"".""last_webfingered_at"" AS t0_r21, ""accounts"".""inbox_url"" AS t0_r22, ""accounts"".""outbox_url"" AS t0_r23, ""accounts"".""shared_inbox_url"" AS t0_r24, ""accounts"".""followers_url"" AS t0_r25, ""accounts"".""protocol"" AS t0_r26, ""accounts"".""id"" AS t0_r27, ""accounts"".""memorial"" AS t0_r28, ""accounts"".""moved_to_account_id"" AS t0_r29, ""accounts"".""featured_collection_url"" AS t0_r30, ""accounts"".""fields"" AS t0_r31, ""accounts"".""actor_type"" AS t0_r32, ""accounts"".""discoverable"" AS t0_r33, ""accounts"".""also_known_as"" AS t0_r34, ""accounts"".""silenced_at"" AS t0_r35, ""accounts"".""suspended_at"" AS t0_r36, ""accounts"".""hide_collections"" AS t0_r37, ""accounts"".""avatar_storage_schema_version"" AS t0_r38, ""accounts"".""header_storage_schema_version"" AS t0_r39, ""accounts"".""devices_url"" AS t0_r40, ""accounts"".""sensitized_at"" AS t0_r41, ""accounts"".""suspension_origin"" AS t0_r42, ""accounts"".""trendable"" AS t0_r43, ""accounts"".""reviewed_at"" AS t0_r44, ""accounts"".""requested_review_at"" AS t0_r45, ""account_stats_accounts"".""id"" AS t1_r0, ""account_stats_accounts"".""account_id"" AS t1_r1, ""account_stats_accounts"".""statuses_count"" AS t1_r2, ""account_stats_accounts"".""following_count"" AS t1_r3, ""account_stats_accounts"".""followers_count"" AS t1_r4, ""account_stats_accounts"".""created_at"" AS t1_r5, ""account_stats_accounts"".""updated_at"" AS t1_r6, ""account_stats_accounts"".""last_status_at"" AS t1_r7 FROM ""accounts"" LEFT OUTER JOIN ""users"" ON ""users"".""account_id"" = ""accounts"".""id"" LEFT OUTER JOIN ""account_stats"" ON ""account_stats"".""account_id"" = ""accounts"".""id"" LEFT OUTER JOIN ""account_stats"" ""account_stats_accounts"" ON ""account_stats_accounts"".""account_id"" = ""accounts"".""id"" WHERE (""accounts"".""domain"" IS NOT NULL OR ""users"".""approved"" = $1 AND ""users"".""confirmed_at"" IS NOT NULL) AND ""accounts"".""suspended_at"" IS NULL AND ""accounts"".""moved_to_account_id"" IS NULL AND ""accounts"".""silenced_at"" IS NULL AND ""accounts"".""discoverable"" = $2 ORDER BY last_status_at DESC NULLS LAST LIMIT $3  In the generated query, the `LEFT OUTER JOIN ""account_stats"" ON ""account_stats"".""account_id"" = ""accounts"".""id"" LEFT OUTER JOIN ""account_stats"" ""account_stats_accounts"" ON ""account_stats_accounts"".""account_id"" = ""accounts"".""id""` seems weird.  Mastodon instance https://mastodon.libre-entreprise.com  Mastodon version v4.1.11  Technical details Mastodon running with Docker, using official image",source-file
30103,mastodon,https://github.com/mastodon/mastodon/issues/30103,API to subscribe to push notification does not seem to delete previous subscription?,"Steps to reproduce the problem 1. [POST `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#create) many times. (Not sure if many times in a short time matters though, just stating based on what I (accidentally) did) 2. Send a post via another account, tagging the logged in user. 3. Wait for notification to arrive 4. Realised that tons of notifications came flooding in, only one decoded correctly (non unexpected, since my app only saved the latest keys)  Expected behaviour 1 notification with correct contents.  Actual behaviour hundreds? of notifications.  Detailed description Now, I am not entirely sure if the fault is on my end, but I am somewhat confident that it is the API's fault. Please advise if I'm doing something terribly wrong without noticing I am referring to the [POST `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#create) endpoint. So the story here is that, new (unreleased) app here, where a bug occurred, which resulted in an endless loop, causing the app to accidentally send out many requests. I realised this probably after like 2 seconds, shut the app down, fixed the issue, and relaunched the app. I sent a post out using another account, tagging my app's logged in account, the rest is explained in the steps to reproduce section. The documentation for that, states: > If you create a new subscription, the old subscription is deleted. In this case, it didn't seem to be true? Eventually, I also tried calling [DELETE `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#delete), but symptoms remains. My setup is for a watchOS app. Notifications are relayed using [metatext-apns](https://github.com/metabolist/metatext-apns), which by the looks of it is just a simple relay so that shouldn't be the cause, right? I am very new to this Mastodon/Web Push notifications stuff, so please let me know if you believe it's an issue from my end. Thank you!  Mastodon instance mastodon.social  Mastodon version v4.3.0-nightly.2024-04-18  Technical details - watchOS 10.2 - Both accounts are on mastodon.social",source-file
33742,mastodon,https://github.com/mastodon/mastodon/issues/33742,Streaming API and REST API language filtering is inconsistent,"Steps to reproduce the problem 1. select chosen languages in `/settings/preferences/other` 2. open the public timeline 3. observe new posts appearing 4. refresh page  Expected behaviour refreshing the page should result in the same posts  Actual behaviour streaming gets more posts than REST API  Detailed description At first glance, this seems to be due to the language filtering logic being different in the streaming server (`streamFrom` function) and the Ruby server (`PublicFeed#language_scope`): - the streaming code treats posts with an unknown language as acceptable (`payload.language !== null `) - when language filtering is enabled, the Ruby code does not return posts with `language: nil`  Mastodon instance mastodon.social  Mastodon version v4.3.0  Technical details _No response_",source-file
29071,mastodon,https://github.com/mastodon/mastodon/issues/29071,"Regression: Suggestion.source is documented as a string, currently returns list of strings","Steps to reproduce the problem 1. On `mastodon.social`, call [`/api/v2/suggestions`](https://docs.joinmastodon.org/methods/suggestions/#v2) 2. Attempt to decode output as documented, as an array of [`Suggestion`](https://docs.joinmastodon.org/entities/Suggestion/) objects 3. Decoding fails because object has changed from documented format  Expected behaviour `Suggestion.source` should be a string  Actual behaviour `Suggestion.source` is an array of strings  Detailed description I'm not sure when this changed, but it's not documented, or backwards compatible with existing clients. My suggestion for the fix would be to keep `source` as a string, populate it with the first or most important of the possible source strings, deprecate `source`, and return the full list of sources as a new `sources` property on `Suggestion`.  Mastodon instance mastodon.social  Mastodon version v4.3.0-nightly.2024-02-02  Technical details _No response_",source-file
28258,mastodon,https://github.com/mastodon/mastodon/issues/28258,Status edits are not sent to streaming clients if they do not appear in a subscribed feed,Steps to reproduce the problem 1. Send a status with direct visibility to a user who doesn't follow you 2. Edit the sent status 3. The recipient does not see the status edit unless they refresh  Expected behaviour The recipient should have received the edited status  Actual behaviour The recipient does not see the status edit unless they refresh  Detailed description _No response_  Mastodon instance _No response_  Mastodon version v4.2.3  Technical details - Ruby version: 3.2.2 - Node.js version: v20.6.1,source-file
30039,mastodon,https://github.com/mastodon/mastodon/issues/30039,Idempotency-Key ignored when scheduling a post,"Steps to reproduce the problem Make multiple requests to schedule a post to `POST /api/v1/statuses`, e.g. with this body `{""status"":""Test"",""spoiler_text"":"""",""visibility"":""private"",""sensitive"":false,""media_ids"":[],""media_attributes"":[],""scheduled_at"":""2024-04-24T14:59:42.868Z"",""language"":""en""}` and with the same `Idempotency-Key` header.  Expected behaviour There is one scheduled status created because the Idempotency-Key was the same.  Actual behaviour Multiple scheduled statuses were created  Detailed description _No response_  Mastodon instance mastodon.social  Mastodon version 4.3.0-nightly.2024-04-18  Technical details _No response_",source-file
28455,mastodon,https://github.com/mastodon/mastodon/issues/28455,The summary for converted ActivityPub objects must be treated as html according to the ActivityStreams specification,"Steps to reproduce the problem 1. Retrieve a non-note object like an `Event` from with a HTML summary. 2. The resulting post will not be rendered/converted as HTML but as plain text.  Expected behaviour The summary should be treated as HTML by default.  Actual behaviour The summary is treated as plain text. The following Screenshot shows what a event received from Gancio then looks like. ![Screenshot_from_2023-12-20_01-20-36](https://github.com/mastodon/mastodon/assets/99024746/d9472d8a-2e0c-4648-b1e5-574428110565)  Detailed description The feature introduced in https://github.com/mastodon/mastodon/pull/9823 is basically a great one, without Mastodon implementing custom renderings for ActivityPub objects like `Event` it has basic support for them. The actual convertion likely takes place here: https://github.com/mastodon/mastodon/blob/2463b53363a621c1e18223bda5c47a663707a22c/app/lib/activitypub/activity/create.rb#L371-L373. The [ActivityStreams vocabulary specification](https://www.w3.org/TR/activitystreams-vocabulary/#dfn-summary) states that > **Summary**: A natural language summarization of the object encoded as HTML. This will cause interoperability issues with future Gancio, Mobilizon and WordPress ActivityPub releases. Altough the ActivityPub spec does not mention it, one might also think of accepting custom `MediaType` for the summary, to handle both plain/text and HTML summaries. See https://framagit.org/les/gancio/-/issues/321#note_2038846  Mastodon instance All  Mastodon version Since https://github.com/mastodon/mastodon/pull/9823  Technical details _No response_",source-file
32540,mastodon,https://github.com/mastodon/mastodon/issues/32540,Streaming healthcheck doesn't send headers to prevent caching,"Steps to reproduce the problem Request to the streaming health check shouldn't be cached by intermediaries  Expected behaviour Responses have appropriate cache control headers  Actual behaviour They don't  Detailed description Ask @ThisIsMissEm  Mastodon instance _No response_  Mastodon version _No response_  Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: (from `ruby --version`, eg. v3.3.5) - Node.js version: (from `node --version`, eg. v20.18.0)",source-file
30783,mastodon,https://github.com/mastodon/mastodon/issues/30783,"""Delete & re-draft"" is only deleting","Steps to reproduce the problem 1. Write a post in the web interface. 2. Select the ""Delete & re-draft"" option from the  menu. 3. Post is deleted, but ""Oops an error occurred"" happens. 4. Post content is lost.  Expected behaviour Post is lost  Actual behaviour Post is ready to draft  Detailed description https://github.com/mastodon/mastodon/assets/3002053/c136f811-2a35-4cd7-85d1-2c3f828b5191  Mastodon instance vmst.io  Mastodon version v4.3.0-alpha.4  Browser name and version Multiple  Operating system Multiple  Technical details Reproduced on mastodon.online as well",source-file
27288,mastodon,https://github.com/mastodon/mastodon/issues/27288,https://mastodon.social/relationships?activity=dormant consistently results in an error page,"Steps to reproduce the problem 1. Navigate to https://mastodon.social/relationships?activity=dormant I usually do it via Preferences - Follows and followers - Dormant 2. See the ""We're sorry, but something went wrong on our end."" error page  Expected behaviour A list of dormant people that I'm following  Actual behaviour An error page  Detailed description _No response_  Mastodon instance mastodon.social  Mastodon version v4.2.1-rc1+pr-27261-37da69c  Browser name and version Google Chrome Version 117.0.5938.132 (Official Build) (64-bit)  Operating system Debian  Technical details _No response_",source-file
27305,mastodon,https://github.com/mastodon/mastodon/issues/27305,Mastodon 4.2.x randomly truncates posts coming in from at least Hubzilla,"Steps to reproduce the problem 1. Have a Hubzilla channel with PubCrawl on and connections on mastodon.social as an example of an instance that runs at least Mastodon 4.2.0. 2. Create a post on Hubzilla, preferably one that's significantly longer than 500 characters. Add at least one not-too-common hashtag so it can be found more easily. 3. Go to `https://mastodon.social/tags/<the hashtag used in the post>` in the Web browser of your choice (tested with the original Mozilla build of Firefox on Debian GNU/Linux). 4. Scroll down until you find your post. 5. Compare how mastodon.social renders your post with what your original Hubzilla post looks like.  Expected behaviour The full post text is always shown on Mastodon.  Actual behaviour Chances are the post is truncated and incomplete.  Detailed description Since Mastodon 4.2.0 was released, it seems to randomly truncate posts from at least Hubzilla. It does so both to posts that came in after the upgrade of an instance to 4.2.x and to posts that have been on an instance before the 4.2.x upgrade. It doesn't happen to each post. It happens both to Hubzilla posts (first posts in a thread) and to Hubzilla comments (replies to posts which are something different on Hubzilla), and it happens to comments on both Mastodon and Hubzilla posts. Also, even truncated posts can still be over 500 characters long on instances that only allow for 500 characters. And posts that are well under 500 characters are truncated, too. There seems to be no pattern. There is nothing that indicates when and why a post is truncated, other than all truncated posts I know about have hashtags in the text rather than all hashtags at the end or no hashtags at all. Also, Hubzilla posts with summaries that became/become Mastodon posts with content warnings seem to never be truncated. That said, posts are never truncated in the middle of a word. The issue clearly lies on Mastodon's side. It started happening with the release of Mastodon 4.2.0 while Hubzilla did not have a new release at that time. Also, Mastodon 4.1.9 shows posts perfectly fine which Mastodon 4.2.0 truncates. Here is a proof, although it's a minor example. Original Hubzilla comment: https://hub.netzgemeinde.eu/display/b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vMzU0NTJkMmQtNDI0OC00NjI5LTg3MjgtZWE0YTlhOWIyNDBk Mastodon 4.1.9 (noc.social) showing the whole post: https://noc.social/@MarvinTheMartian/111115829359100943 (scroll down to my post) Mastodon 4.2.0 (tooters.org), full stop at the end of the last sentence is missing: https://tooters.org/@victor/111115391740487664 (scroll down to my post) More examples can be found by [searching mastodon.social for the hashtag #ImageDescription](https://mastodon.social/tags/imagedescription) and finding at my posts. For example: Original Hubzilla comment, very short even: https://hub.netzgemeinde.eu/display/b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vYWFjOWE2YTUtZTc1Zi00Njc5LWFiNjgtNGYyYzI5ZDJmMjI5 Mastodon 4.2.0 (mastodon.hardcoredevs.com), truncated mid-paragraph after the hashtag `#ImageDescription`: https://mastodon.hardcoredevs.com/@Andres/110894302610589500 (my comment is right below) This is a special case because the whole thread was written before Mastodon 4.2.0. Original Hubzilla comment: https://hub.netzgemeinde.eu/display/b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vOGYxYTQwMTUtNTc0Zi00YzEzLThkZTMtNDdhN2ViNGVjYjc1 Mastodon 4.2.1-rc1+pr-27261-37da69c (mastodon.social), entire second paragraph is missing: https://mastodon.social/@hikingdude/111091316259559387 (my comment is right below) Original Hubzilla comment: https://hub.netzgemeinde.eu/display/b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vMDAyMDk4MjgtM2VjOC00MDUwLTlhN2QtMmIzM2M2Njk3OWVj Mastodon 4.2.1-rc1+pr-27261-37da69c (mastodon.social), truncated mid-paragraph after the hashtag `#Friendica`: https://mastodon.social/@urlyman/111028486166963680 (my comment is right below) Original Hubzilla comment: https://hub.netzgemeinde.eu/channel/jupiter_rowland?mid=b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vZDIzY2NkMjItMzUzNy00ODI4LWEzMDgtYjQ5YjY0MGU5MTQx Mastodon 4.2.0 (ieji.de), truncated mid-paragraph after the hashtag `#AltText`: https://ieji.de/@soonix/111008439620893974 (my comment is right below) It also happens to Hubzilla posts. I don't have an example of a Hubzilla post truncated on Mastodon that can be seen by scrolling up from a Mastodon reply, but here is an example with a raw Mastodon link (which will open Hubzilla in a Web browser, though): Original Hubzilla post: https://hub.netzgemeinde.eu/channel/jupiter_rowland?mid=b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vMTM2MmE1NmUtYzU0Ny00MDU4LTgxZGMtNTRiZmMzMzgxNDVh Mastodon 4.2.1-rc1+pr-27261-37da69c (mastodon.social), the last paragraph is missing: https://mastodon.social/@jupiter_rowland@hub.netzgemeinde.eu/111158674653031871 The same may happen to posts from other projects, especially Friendica and (streams). I don't have any evidence of this happening or not happening yet. Also, I can't test this on mobile apps, so I can't say if this is a Web interface or backend issue.  Mastodon instance mastodon.social, fosstodon.org, norden.social, tooters.org, ieji.de, mastodon.hardcoredevs.com  Mastodon version v4.2.0, v4.2.1-rc1+pr-27261-37da69c  Browser name and version Firefox 118.0.1, original Mozilla build  Operating system Debian 13 ""trixie"" (testing)  Technical details _No response_",source-file
30578,mastodon,https://github.com/mastodon/mastodon/issues/30578,"Without ImageMagick, uploading emoji files is not possible","Steps to reproduce the problem 1. Set an emoji name and select the emoji file 2. Clicking Upload immediately throws an error  Expected behaviour Successful upload and emoji added  Actual behaviour Imediate error, failed upload  Detailed description After #30090, when uploading an emoji file, an error is immediately thrown.  INFO -- : [747998e2-f015-4df6-9828-21284dd45a61] [paperclip] Trying to link /tmp/RackMultipart20240606-4122054-jvtb5n.gif to /tmp/727f3ea9cd9c5f222fec438bb341a8a020240606-4122054-79d0xi.gif INFO -- : [747998e2-f015-4df6-9828-21284dd45a61] Command :: identify -format '%wx%h,%[exif:orientation]' '/tmp/727f3ea9cd9c5f222fec438bb341a8a020240606-4122054-79d0xi.gif[0]' 2>/dev/null INFO -- : [747998e2-f015-4df6-9828-21284dd45a61] method=POST path=/admin/custom_emojis format=html controller=Admin::CustomEmojisController action=create status=500 allocations=3481 duration=45.68 view=0.00 db=11.68 FATAL -- : [747998e2-f015-4df6-9828-21284dd45a61] [747998e2-f015-4df6-9828-21284dd45a61] Paperclip::Errors::CommandNotFoundError (Could not run the `identify` command. Please install ImageMagick.): [747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:21:in `block in post_process_style' [747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `each' [747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `inject' [747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `post_process_style' [747998e2-f015-4df6-9828-21284dd45a61] app/controllers/admin/custom_emojis_controller.rb:21:in `create' [747998e2-f015-4df6-9828-21284dd45a61] app/controllers/concerns/localized.rb:11:in `set_locale' [747998e2-f015-4df6-9828-21284dd45a61] lib/mastodon/rack_middleware.rb:9:in `call'  I enabled `libvips` and uninstalled `ImageMagick`. If emojis are meant to be processed by IM instead, I'll reinstall it again.  Mastodon instance bolha.one  Mastodon version v4.3.0-alpha.4-4655be0  Technical details _No response_",source-file
31091,mastodon,https://github.com/mastodon/mastodon/issues/31091,"Duplicate key ""orderedItems"" in outbox.json when exporting a user's archive","Steps to reproduce the problem 1. Export a user's archive 2. Download & extract the archive 3. Look at outbox.json 4. There's two ""orderedItems"" keys! ![image](https://github.com/user-attachments/assets/eb69d63e-eb76-462e-a0f1-69b4600337ca) (originally [reported on glitch-soc](https://github.com/glitch-soc/mastodon/issues/2787) but was told that it's also happening upstream)  Expected behaviour There should only be one ""orderedItems"" key  Actual behaviour There were two ""orderedItems"" keys, one of which was a blank array  Detailed description _No response_  Mastodon instance _No response_  Mastodon version v4.3.0-alpha.5+glitch  Technical details _No response_",source-file
28539,mastodon,https://github.com/mastodon/mastodon/issues/28539,Streaming endpoint on Vagrant sends 301 redirect to localhost,"Steps to reproduce the problem I wanted to test an in-development Mastodon client's use of the streaming API endpoints such as `/api/v1/streaming/user`, so I set up a development instance using Vagrant as follows: 1. cloned the git repo on Ubuntu 22.04, obtaining the head commit 6374358357ee81b5f137f471f028a56974109155 2. ran `vagrant up` in the root of the checkout, and authorised it to add `mastodon.local` to my `/etc/hosts` 3. ran the suggested startup command `vagrant ssh -c ""cd /vagrant && foreman start""` 4. created a test user on the instance using the web UI, and authenticated my test client The client tried to access the streaming API, by sending an HTTP request as follows (observed via `strace`, since in this environment we're using cleartext HTTP):  GET /api/v1/streaming/user HTTP/1.1 authorization: Bearer LHfBPlUXWkgVSZl5DMSiBOTD1CeaidAWwWs8TiUKmUk accept: */* host: mastodon.local   Expected behaviour I expected that this GET request would return a 200 status and begin delivering chunked data, starting with a line such as "":)"" and continuing with "":thump"" heartbeats interleaved with update events.  Actual behaviour The web server on the Vagrant instance returned a 301 redirect to a URL on ""localhost"", so my client next tried to connect to the host machine, and got 404 because _that_ web server knows nothing about the test Mastodon instance.  Detailed description The full HTTP response from the Mastodon test server was:  HTTP/1.1 301 Moved Permanently X-Frame-Options: SAMEORIGIN X-XSS-Protection: 0 X-Content-Type-Options: nosniff X-Download-Options: noopen X-Permitted-Cross-Domain-Policies: none Referrer-Policy: strict-origin-when-cross-origin X-RateLimit-Limit: 300 X-RateLimit-Remaining: 299 X-RateLimit-Reset: 2023-12-31T14:55:00.170985Z Location: http://localhost/api/v1/streaming/user Content-Type: text/html; charset=utf-8 Cache-Control: private, no-store Content-Security-Policy: default-src 'none'; frame-ancestors 'none'; form-action 'none' X-Request-Id: 0b582768-c006-4a45-b808-49803c87e1d4 X-Runtime: 0.126129 Server-Timing: cache_read.active_support;dur=0.02, sql.active_record;dur=0.66, cache_generate.active_support;dur=1.31, cache_write.active_support;dur=0.11, instantiation.active_record;dur=0.23, start_processing.action_controller;dur=0.00, redirect_to.action_controller;dur=0.03, process_action.action_controller;dur=7.38 vary: Authorization, Origin Content-Length: 0   Mastodon instance mastodon.local (installed via Vagrant)  Mastodon version v4.3.0-alpha.0  Technical details Software versions that `vagrant up` installed for me:  vagrant@mastodon:~$ ruby --version ruby 3.2.2 (2023-03-30 revision e51014f9c0) [x86_64-linux] vagrant@mastodon:~$ node --version v20.10.0",config-file
30860,mastodon,https://github.com/mastodon/mastodon/issues/30860,Unable to link to URLs ending with a @,Steps to reproduce the problem 1. Look at this post: https://mastodon.gamedev.place/@CarePackage17/112688958098239356 2. Try clicking the link 3. Observe it leads to a 404 instead of https://gta.fandom.com/wiki/TW@  Expected behaviour The link should include the @ as part of its URL: https://gta.fandom.com/wiki/TW@  Actual behaviour the link gets broken  Detailed description _No response_  Mastodon instance mastodon.gamedev.place  Mastodon version 4.2.9  Browser name and version Firefox Nightly 129  Operating system Android  Technical details _No response_,source-file | config-file
33357,mastodon,https://github.com/mastodon/mastodon/issues/33357,Featured hashtag last used date is incorrect for remote users,"Steps to reproduce the problem 1. Load `/api/v1/accounts/[id]/featured_hashtags` with the ID of a remote user  Expected behaviour `last_status_at` should show the date of the most recent post from this user using that hashtag that is either public or viewable to the person making the query  Actual behaviour `last_status_at` shows a long ago date for a hashtag with recent public posts. I think `statuses_count` is also incorrect. I also found at least one example (possibly specific to the web UI) where a future date is displayed as the last usage date of a featured hashtag, even though the users posts are all dated correctly.  Detailed description Ive seen this frequently on multiple servers where it will either give a long ago date or even say no posts for a featured hashtag that someone uses very frequently. I can see the users posts just fine from the affected server so its not an issue of the posts not federating. When looking at my own featured hashtags on my own server, or looking at local users featured hashtags, the date appears to be correct, only remote accounts seem to be affected. For example, https://mastodon.social/api/v1/accounts/109281825849025262/featured_tags should be the featured tags of my own mastodon.online account, viewed from mastodon.social. The `last_status_at` for the swiftui hashtag is `2024-02-19`, almost a year ago, but Ive posted about it several times since then, including in the last few days. Possibly related to #22665 where someone saw the `last_status_at` date getting updated correctly but not the `statuses_count`. In my case, the `last_status_at` is also incorrect.  Mastodon instance mastodon.social, mastodon.online, mastodon.gamedev.place  Mastodon version v4.4.0-nightly.2024-12-18, v4.3.2  Technical details _No response_",source-file
27194,mastodon,https://github.com/mastodon/mastodon/issues/27194,Post language strings with country code are invalid according to BCP47,"Steps to reproduce the problem 1. Create a post with the language set to a locale with a country code (e.g. zh-HK) 2. Obtain the JSON-LD of the post (e.g. using `curl -H ""Accept: application/json""`) 3. Note the keys of the `contentMap` object  Expected behaviour The first key of the object should be a valid locale string in accordance with BCP47 (e.g. zh-HK)  Actual behaviour The first key is in camel-case without a hyphen (e.g. zhHk)  Detailed description Introduced by #27099. It seems like this is how languages are currently stored in the database, so some conversion is likely needed before sending a post to inboxes.  Mastodon instance _No response_  Mastodon version _No response_  Technical details - Ruby version: 3.2.2 - Node.js version: 18.17.1",source-file
28003,mastodon,https://github.com/mastodon/mastodon/issues/28003,Unable to mute users without web UI error,"Steps to reproduce the problem 1. Try to mute a user  Expected behaviour User is muted  Actual behaviour ""Oops, an expected error has occurred"" (It appears the user is also then muted.)  Detailed description _No response_  Mastodon instance vmst.io, mastodon.online  Mastodon version v4.3.0-alpha.0, v4.3.0-nightly.2023-11-19  Browser name and version Safari  Operating system macOS  Technical details _No response_",source-file
33109,mastodon,https://github.com/mastodon/mastodon/issues/33109,Edits appear to fail to process with unresolvable mentions,"Steps to reproduce the problem 1. Receive an `Update` with an unresolvable mention (ie domain is gone) 2. Job fails to process, so `Update` is never applied 3. See failed job in sidekick morgue Needs a fix akin to #29215  Expected behaviour Job will process successfully  Actual behaviour Job will fail to process  Detailed description Backtrace:  app/lib/request.rb:110:in `rescue in perform': failed to connect: No address for beta.mstdn.cf on https://beta.mstdn.cf/users/mariaressa (HTTP::ConnectionError) from app/lib/request.rb:107:in `perform' from app/helpers/jsonld_helper.rb:174:in `fetch_resource_without_id_validation' from app/helpers/jsonld_helper.rb:167:in `fetch_resource' from app/services/activitypub/fetch_remote_actor_service.rb:18:in `call' from app/services/activitypub/fetch_remote_account_service.rb:6:in `call' from app/services/activitypub/process_status_update_service.rb:198:in `block in update_mentions!' from app/services/activitypub/process_status_update_service.rb:194:in `each' from app/services/activitypub/process_status_update_service.rb:194:in `update_mentions!' from app/services/activitypub/process_status_update_service.rb:182:in `update_metadata!' from app/services/activitypub/process_status_update_service.rb:45:in `block (2 levels) in handle_explicit_update!' from app/services/activitypub/process_status_update_service.rb:40:in `block in handle_explicit_update!' from app/models/concerns/lockable.rb:12:in `block (2 levels) in with_redis_lock' from app/models/concerns/lockable.rb:10:in `block in with_redis_lock' from app/lib/redis_connection.rb:10:in `with' from app/models/concerns/redisable.rb:9:in `with_redis' from app/models/concerns/lockable.rb:9:in `with_redis_lock'  13 levels /home/mastodon/live/app/lib/request.rb:328:in `open': failed to connect: No address for beta.mstdn.cf (HTTP::ConnectionError) from /home/mastodon/live/app/lib/request.rb:24:in `connect' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/connection.rb:42:in `initialize' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:49:in `initialize' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:70:in `new' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:70:in `perform' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:12:in `block (2 levels) in <class:Client>' from /home/mastodon/.rbenv/versions/3.3.5/lib/ruby/3.3.0/benchmark.rb:313:in `realtime' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:11:in `block in <class:Client>' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:31:in `request' from /home/mastodon/live/app/lib/request.rb:108:in `perform' from /home/mastodon/live/app/helpers/jsonld_helper.rb:174:in `fetch_resource_without_id_validation' from /home/mastodon/live/app/helpers/jsonld_helper.rb:167:in `fetch_resource' from /home/mastodon/live/app/services/activitypub/fetch_remote_actor_service.rb:18:in `call' from /home/mastodon/live/app/services/activitypub/fetch_remote_account_service.rb:6:in `call' from /home/mastodon/live/app/services/activitypub/process_status_update_service.rb:198:in `block in update_mentions!' from /home/mastodon/live/app/services/activitypub/process_status_update_service.rb:194:in `each'  64 levels /home/mastodon/live/app/lib/request.rb:328:in `open': No address for beta.mstdn.cf (SocketError) from /home/mastodon/live/app/lib/request.rb:24:in `connect' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/connection.rb:42:in `initialize' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:49:in `initialize' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:70:in `new' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:70:in `perform' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:12:in `block (2 levels) in <class:Client>' from /home/mastodon/.rbenv/versions/3.3.5/lib/ruby/3.3.0/benchmark.rb:313:in `realtime' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/adapters/http.rb:11:in `block in <class:Client>' from /home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/http-5.2.0/lib/http/client.rb:31:in `request' from /home/mastodon/live/app/lib/request.rb:108:in `perform' from /home/mastodon/live/app/helpers/jsonld_helper.rb:174:in `fetch_resource_without_id_validation' from /home/mastodon/live/app/helpers/jsonld_helper.rb:167:in `fetch_resource' from /home/mastodon/live/app/services/activitypub/fetch_remote_actor_service.rb:18:in `call' from /home/mastodon/live/app/services/activitypub/fetch_remote_account_service.rb:6:in `call' from /home/mastodon/live/app/services/activitypub/process_status_update_service.rb:198:in `block in update_mentions!' from /home/mastodon/live/app/services/activitypub/process_status_update_service.rb:194:in `each'  64 levels   Mastodon instance raphus.social  Mastodon version v4.3.1  Technical details If this is happening on your own Mastodon server, please fill out those: - Ruby version: ruby 3.3.5 (2024-09-03 revision ef084cc8f4) [x86_64-linux] - Node.js version: v20.5.1",source-file
