issue_no,repo,issue_url,title,description,patched_file_types
9132,vercel,https://github.com/vercel/vercel/issues/9132,Python ASGI functions crashing on incoming headers,"## Issue When deploying a Python ASGI application (e.g. using FastAPI, Sanic) with Vercel Serverless, the function is built successfully but invoking the URL the function leads to a crash with a 500 error. Here is the backend log from Vercel:  [ERROR] AttributeError: 'list' object has no attribute 'encode' Traceback (most recent call last): File ""/var/task/vc__handler__python.py"", line 288, in vc_handler 'headers': [[k.lower().encode(), v.encode()] for k, v in headers.items()], File ""/var/task/vc__handler__python.py"", line 288, in <listcomp> 'headers': [[k.lower().encode(), v.encode()] for k, v in headers.items()],  ## Investigations It seems there is an issue with incoming complex headers parsing for ASGI functions: - Python WSGI applications (e.g. using Flask) do not show this error - Invocations of ASGI functions using `curl` or `httpie` works perfectly, no errors - Bisecting headers from the web browser (Firefox, Chrome), here is a faulty header causing the crash:  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8  - Invocations of ASGI functions using `curl` or `httpie` using the above header are triggering the error ## Reproduction A simple hello world app with FastAPI or Sanic in a module name `app.py`: python from fastapi import FastAPI app = FastAPI() @app.get(""/"") def index(): return {""message"": ""Hello World""}  python from sanic import Sanic from sanic.response import json app = Sanic(name=__name__) @app.route(""/"") async def index(request): return json({""message"": ""Hello World""})  `vercel.json`:  { ""builds"": [ { ""src"": ""app.py"", ""use"": ""@vercel/python"" } ], ""routes"": [ { ""src"": ""/(.*)"", ""dest"": ""app.py"" } ] }  ## Related issues - https://github.com/vercel/vercel/issues/2526",test-file | source-file
738,vercel,https://github.com/vercel/vercel/issues/738,now buy domains returning `undefined` price,"~ git:(master)  now buy domains domain-name.something > The domain ""domain-name.something"" is available to buy under bukinoshita! [3s] > Buy now for $undefined (undefinedyr)? [y|N]",other-file
2162,vercel,https://github.com/vercel/vercel/issues/2162,"`now projects ` works, but `now project` does not","When removing a project  $ now projects rm  The project: nodejs will be removed permanently. It will also delete everything under the project including deployments. > Are you sure? [y/N]  but  $ now project rm  > Error! The specified file or directory ""project"" does not exist.  By convention, both should wortk.",source-file
2760,vercel,https://github.com/vercel/vercel/issues/2760,404 error for removing deployment takes forever to exit,Try removing any deployment (might be related to having used an alias) and you will notice that the command (even thought it printed a 404) will take forever to exit: ![2019-08-14 00 43 07](https://user-images.githubusercontent.com/6170607/62982483-8c1c1580-be2c-11e9-8d61-9e03d6413790.gif),test-file | source-file
110,vercel,https://github.com/vercel/vercel/issues/110,Corrupt data stream due to HTTP/2 (suspected),After quite a few hours of investigation I suspect that multipart/form-data data streams become corrupt (garbled) due to HTTP/2. If I try to a upload a file when using HTTP/2 the first couple of bytes become garbled. If I disable HTTP/2 (chrome --disable-http2) then I am unable to reproduce the issue. I have only been able to reproduce the issue with one specific file on some computers. Not reproducable on all computers that I've tested with. See linked GitHub project for a minimal test project with detailed investigation observations. https://github.com/pqvst/form-test If the culprit is indeed the HTTP/2 stack in _now_ then I would say that this is a pretty critical issue since it means that file uploads aren't guaranteed to work. Perhaps there are other scenarios as well?,source-file
2901,vercel,https://github.com/vercel/vercel/issues/2901,Errors are not being rendered,"If you break a serverless Node.js API, the error will not be rendered if you send a request to that file. Instead, it will load forever: [bad error handling.mp4.zip](https://github.com/zeit/now/files/3550905/bad.error.handling.mp4.zip)",documentation-file | config-file
922,vercel,https://github.com/vercel/vercel/issues/922,"now alias ls gives ""Could not match path alias for""",`now --version` > 8.3.10 `now alias ls my-app-obfuscated.now.sh` **Gives:** > Error! Could not match path alias for: my-app-obfuscated.now.sh **Expected:** List rules for alias **Notes:** `now alias ls` lists my-app-obfuscated.now.sh as an alias for one of the deployments Any help would be appreciated,source-file
3091,vercel,https://github.com/vercel/vercel/issues/3091,UnicodeEncodeError in python builder,"Any payload that has non-ascii characters in it blows up if not encoded in latin-1. All payloads from browsers will be utf-8. To reproduce: Have a web app send (fetch) a json payload with strings with Greek (or other non-ascii characters) to a python endpoint deployed on now. Logs:  Duration: 1.84 ms Billed Duration: 100 ms Memory Size: 3008 MB Max Memory Used: 66 MB Unhandled exception in thread started by <bound method BaseServer.handle_request of <http.server.HTTPServer object at 0x7f83a3e29e48>> Traceback (most recent call last): File ""/var/lang/lib/python3.6/socketserver.py"", line 298, in handle_request ready = selector.select(timeout) File ""/var/lang/lib/python3.6/selectors.py"", line 376, in select fd_event_list = self._poll.poll(timeout) PermissionError: [Errno 1] Operation not permitted 'latin-1' codec can't encode characters in position 2370-2379: Body ('') is not valid Latin-1. Use body.encode('utf-8') if you want to send it encoded in UTF-8.: UnicodeEncodeError Traceback (most recent call last): File ""/var/task/now__handler__python.py"", line 42, in now_handler headers=headers, data=body, allow_redirects=False) File ""/var/task/requests/api.py"", line 60, in request return session.request(method=method, url=url, **kwargs) File ""/var/task/requests/sessions.py"", line 533, in request resp = self.send(prep, **send_kwargs) File ""/var/task/requests/sessions.py"", line 646, in send r = adapter.send(request, **kwargs) File ""/var/task/requests/adapters.py"", line 449, in send timeout=timeout File ""/var/task/urllib3/connectionpool.py"", line 672, in urlopen chunked=chunked, File ""/var/task/urllib3/connectionpool.py"", line 387, in _make_request conn.request(method, url, **httplib_request_kw) File ""/var/lang/lib/python3.6/http/client.py"", line 1254, in request self._send_request(method, url, body, headers, encode_chunked) File ""/var/lang/lib/python3.6/http/client.py"", line 1299, in _send_request body = _encode(body, 'body') File ""/var/lang/lib/python3.6/http/client.py"", line 171, in _encode (name.title(), data[err.start:err.end], name)) from None UnicodeEncodeError: 'latin-1' codec can't encode characters in position 2370-2379: Body ('') is not valid Latin-1. Use body.encode('utf-8') if you want to send it encoded in UTF-8.  Full reproduction here: https://github.com/offero/nowpyunicodefail",test-file | source-file
1337,vercel,https://github.com/vercel/vercel/issues/1337,`now alias ls <url> --json` outputting the json to stderr,"$ now alias ls my-path-alias.now.sh --json > rules.json { ""rules"": [ <snip> ] }",source-file
3539,vercel,https://github.com/vercel/vercel/issues/3539,"now.json ""rewrites"" routes with dynamic params 404 using `now dev`",Reduced test-case: https://github.com/wilsonpage/zeit-now-next-rewrites-bug  Steps: 1. Run `now dev` 2. Visit http://localhost:3000/hello 3. Observe `world` `200` response  4. Visit http://localhost:3000/hello-regex/john 5. Observe `404` response  6. Visit http://localhost:3000/hello-param/john 7. Observe `404` response,test-file | source-file
7283,vercel,https://github.com/vercel/vercel/issues/7283,"[CLI] When ""vercel dev"" proxies a request to a framework, its queries are not original ones and will result in errors for Vite.","When Vite plugins processing a Vue Single File Component(SFC) file, it will transform its style tag into a js file with a url like `/foo/bar/AComponent.vue?vue&type=style&index=0&lang.css`. Then it was used as a js module in the page. However when Vercel CLI dev server proxying it to frontend dev server, the cli doesn't use original url but generates a new one. Generated one is like: `/foo/bar/AComponent.vue?vue=&type=style&index=0&lang.css=`, which is not a valid css url that can be recognized by Vite. Its content is not processed by css plugins of Vite, but it's still used as a js module. Because of that, when running ""vercel dev"", if you write some css rules in the style tag of a Vue SFC file, the page will become blank and throw errors in browser console. It's very inconvenient for Vue developers if we can't use style tag in SFC. Cause is at: https://github.com/vercel/vercel/blob/bae26cc0178ff49c3050ceaf5db00969e510cc6b/packages/cli/src/util/dev/server.ts#L1703-L1707 Here it deletes original querystring (`origUrl.search`), and generates a new one together with pathname (`url.format(origUrl)`), which is the one with additional ""="". (`url.format()` internally uses `querystring.stringify()` that will add ""="" for empty fields in the object). In my local repo, I deleted L1704 & L1706 then it worked as expected. `url.format()` now uses original search string, so additional ""=""s are gone. But I don't know if it will impact other frameworks.",test-file | source-file
2375,vercel,https://github.com/vercel/vercel/issues/2375,PCRE passing undefined,"PCRE group is passing `undefined` as string to the query string rather than not passing it at all. Maybe this is a misconfiguration on my end.  { ""version"": 2, ""builds"": [ { ""src"": ""./api/functions/**/*.js"", ""use"": ""@now/node"" }, ], ""routes"": [ { ""src"": ""/api/hello(/(?<name>[^/]+))?"", ""methods"": [""GET""], ""dest"": ""/api/functions/hello/index.js?name=$name"" } ] }  If I just call `/api/hello`, it passes `""undefined""` as the `name`.",test-file | source-file
673,vercel,https://github.com/vercel/vercel/issues/673,now alias ls [alias] does not work on simple aliases,## Aliases  $ now alias ls > 4 aliases found [877ms] under sequoia source url age https://auth-pqcfahnogz.now.sh https://sequoia-auth.now.sh 2d https://webapp-bpgcubktqz.now.sh https://sequoia-webapp.now.sh 2d [3 custom rules] https://sequoia-monolith.now.sh 2d [4 custom rules] https://counter-demo.now.sh 16d  ## `now alias ls alias-with-rules`  $ now alias ls counter-demo.now.sh pathname method dest /login * writer-gkdldldejq.now.sh /increment * writer-gkdldldejq.now.sh /logout * writer-gkdldldejq.now.sh * reader-jdaugptkks.now.sh  ## `now alias ls alias-without-rules`  $ now alias ls sequoia-auth.now.sh > Error! Could not match path alias for: sequoia-auth.now.sh  # Expected `now alias ls <alias>` returns info about an alias # Actual `now alias ls <alias>` **fails** if it's a simple url source alias,test-file | source-file
5580,vercel,https://github.com/vercel/vercel/issues/5580,Python bug: error occurs when url including special charactors visited,"The server cannot deal with url with special charactors when the serverless function is written in python using handler that inherits from the BaseHTTPRequestHandler class. For example, https://test.nicelee.vercel.app/api/date goes right, while https://test.nicelee.vercel.app/api/date?test=%E5%93%88%E5%93%88 goes wrong, or https://test.nicelee.vercel.app/api/date?test= goes wrong The serverless function follows here.  from http.server import BaseHTTPRequestHandler, HTTPServer from datetime import datetime count = 0 class handler(BaseHTTPRequestHandler): def do_GET(self): global count count = count + 1 self.send_response(200) self.send_header('Content-type', 'text/plain') self.end_headers() self.wfile.write(str(datetime.now().strftime('%Y-%m-%d %H:%M:%S\n')).encode()) self.wfile.write(str(count).encode()) return",source-file
3772,vercel,https://github.com/vercel/vercel/issues/3772,now dev requires login and is missing --token from help,"`now dev` requires login now. If you don't log in it gives you a fun error like this:  Error! An unexpected error occurred! Error: The specified token is not valid at Object.getUser (/home/user/.config/yarn/global/node_modules/now/dist/index.js:2:2248948) at processTicksAndRejections (internal/process/task_queues.js:94:5) Error: The specified token is not valid at Object.getUser (/home/user/.config/yarn/global/node_modules/now/dist/index.js:2:2248948) at processTicksAndRejections (internal/process/task_queues.js:94:5)  In CI you can specify a token using `-t` or `--token`, but this is not listed in the description shown by specifying `--help`.",source-file
801,vercel,https://github.com/vercel/vercel/issues/801,`now dns add` should return error feedback in case of an error,Running:  $ now dns add <DOMAIN> TXT <VALUE>  on `v7.4.0` it returns me `> Error! Invalid number of arguments. See: now dns --help for usage.` but on `v8.0.1` it does not return anything. cc @sergiodxa,test-file | source-file
591,vercel,https://github.com/vercel/vercel/issues/591,now secret add results in an Error,"It looks like `now secret add` has a limit in terms of the variable name size. Using the command while setting a 30 characters long variable name results in an Error, but no message is provided.",test-file | source-file
631,vercel,https://github.com/vercel/vercel/issues/631,`now-cc add` country selection is Case Sensitive,"`United States` is ok, but it seems that `united states` is not",documentation-file | config-file
2759,vercel,https://github.com/vercel/vercel/issues/2759,Broken error when purchasing domains,"Currently, we're showing this if you try to purchase a domain: ![image](https://user-images.githubusercontent.com/6170607/62973981-7fd98d80-be17-11e9-85a9-b3f32686aff1.png) Instead, we want to STOP the spinner and print the error in a new fresh line. Furthermore, the error should not expose the entire stack trace. It should just print: > An unexpected error occurred while purchasing your domain. Please try again later.",source-file
3042,vercel,https://github.com/vercel/vercel/issues/3042,"""Authentication error"" on canary instead of ""You are not owner of the domain""","When adding an `alias` to now.json that the current token does not own, the stable channel shows:  > Deploying ~/Code/foo under username > Using project projectname > Error! You are not owner of the domain ""example.com""  However, the canary channel has regressed and shows the following:  > Deploying ~/Code/foo under username > Using project projectname > Error! Authentication error. Run `now login` to log-in again.",test-file | source-file
13,vercel,https://github.com/vercel/vercel/issues/13,`now domain` doesn't handle authentication errors,Instead it's showing a stack trace like:  Cannot read property `sort` of undefined,source-file
2092,vercel,https://github.com/vercel/vercel/issues/2092,[now-dev] Route parameters do not work in headers,"Route parameters do not work in ""headers"". In the following example, the correct $locale value is used for both _headers_ and _dest_ on Now server. In `now-dev`, `$locale` will resolves to the right value only for dest. When used in ""headers"" for redirect, $locale did not resolve to a value, a redirection to the literal path ""/$locale/how/"" occured.  routes: [ { ""src"": ""/(?<locale>[^/]*)/how/$"", ""dest"": ""/how?locale=$locale"" }, { ""src"": ""/(?<locale>[^/]*)/how$"", ""status"": 301, ""headers"": { ""Location"": ""/$locale/how/"" } } ]",source-file
1350,vercel,https://github.com/vercel/vercel/issues/1350,`now rm` prints misleading error message upon HTTP 500,https://github.com/zeit/now-cli/blob/7e98d0a22b5363f9d46274b4fcd4163ab0591275/src/providers/sh/util/index.js#L765 It should say `Failed to remove deployment` instead.,source-file
2606,vercel,https://github.com/vercel/vercel/issues/2606,We show a weird error when the auth token is expired,"This error is useless: ![image](https://user-images.githubusercontent.com/6170607/61789604-68f5db80-ae15-11e9-9124-fa6783740837.png) Instead, we want to tell the user: > You don't have access to this deployment. Please log in: (and then we auto-trigger the login)",test-file | source-file
552,vercel,https://github.com/vercel/vercel/issues/552,`now domain buy` doesn't handle pre-orders,"Hi! :) I wanted to buy a "".now"" domain, currently it's pre-order only and `now` doesn't seem to handle this. Instead it shows: `Buy now for $undefined (<my_email>)?`",test-file | source-file | other-file | config-file | documentation-file
2148,vercel,https://github.com/vercel/vercel/issues/2148,`now dev` is not respecting methods of routes,"## Issue When sending a `GET` request to `localhost:3000/api/users/14` it returns with the response from the `DELETE` method. It does not appear that `now dev` is respecting methods on the route. Similarly, if a `POST` request is made to `localhost:3000/api/status`, it is accepted, even though it is not a valid method.  { ""version"": 2, ""name"": ""now-dev-issue"", ""builds"": [ { ""src"": ""www/package.json"", ""use"": ""@now/static-build"" }, { ""src"": ""api/*/*.js"", ""use"": ""@now/node@canary"" } ], ""routes"": [ { ""src"": ""/api/status"", ""methods"": [""GET""], ""dest"": ""/api/status/list.js"" }, { ""src"": ""/api/users"", ""methods"": [""POST""], ""dest"": ""/api/users/create.js"" }, { ""src"": ""/api/users/(?<id>[^/]+)"", ""methods"": [""DELETE""], ""dest"": ""/api/users/delete.js?id=$id"" }, { ""src"": ""/api/users/(?<id>[^/]+)"", ""methods"": [""GET""], ""dest"": ""/api/users/get.js?id=$id"" }, { ""src"": ""/api/users/(?<id>[^/]+)"", ""methods"": [""PUT""], ""dest"": ""/api/users/update.js?id=$id"" }, { ""src"": ""/(.*)"", ""dest"": ""/www/$1"" } ] }  ## Sample Branch https://github.com/khrome83/now-dev-issue",test-file | source-file
